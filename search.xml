<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Arthasè¯Šæ–­å·¥å…·(ä¸€)Arthasï¼ˆé˜¿å°”è¨æ–¯ï¼‰å¿«é€Ÿå…¥é—¨</title>
    <url>/Arthas%E5%BA%94%E7%94%A8(Java)%E8%AF%8A%E6%96%AD%E5%88%A9%E5%99%A8/Arthas%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7(%E4%B8%80)Arthas%EF%BC%88%E9%98%BF%E5%B0%94%E8%90%A8%E6%96%AF%EF%BC%89%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[Arthasè¯Šæ–­å·¥å…·(ä¸€)Arthasï¼ˆé˜¿å°”è¨æ–¯ï¼‰å¿«é€Ÿå…¥é—¨1. Arthasï¼ˆé˜¿å°”è¨æ–¯ï¼‰ èƒ½ä¸ºä½ åšä»€ä¹ˆï¼ŸArthasÂ æ˜¯Alibabaå¼€æºçš„Javaè¯Šæ–­å·¥å…·ï¼Œæ·±å—å¼€å‘è€…å–œçˆ±ã€‚

å½“ä½ é‡åˆ°ä»¥ä¸‹ç±»ä¼¼é—®é¢˜è€ŒæŸæ‰‹æ— ç­–æ—¶ï¼ŒArthaså¯ä»¥å¸®åŠ©ä½ è§£å†³ï¼š

è¿™ä¸ªç±»ä»å“ªä¸ª jar åŒ…åŠ è½½çš„ï¼Ÿä¸ºä»€ä¹ˆä¼šæŠ¥å„ç§ç±»ç›¸å…³çš„ Exceptionï¼Ÿ
æˆ‘æ”¹çš„ä»£ç ä¸ºä»€ä¹ˆæ²¡æœ‰æ‰§è¡Œåˆ°ï¼Ÿéš¾é“æ˜¯æˆ‘æ²¡ commitï¼Ÿåˆ†æ”¯æé”™äº†ï¼Ÿ
é‡åˆ°é—®é¢˜æ— æ³•åœ¨çº¿ä¸Š debugï¼Œéš¾é“åªèƒ½é€šè¿‡åŠ æ—¥å¿—å†é‡æ–°å‘å¸ƒå—ï¼Ÿ
çº¿ä¸Šé‡åˆ°æŸä¸ªç”¨æˆ·çš„æ•°æ®å¤„ç†æœ‰é—®é¢˜ï¼Œä½†çº¿ä¸ŠåŒæ ·æ— æ³• debugï¼Œçº¿ä¸‹æ— æ³•é‡ç°ï¼
æ˜¯å¦æœ‰ä¸€ä¸ªå…¨å±€è§†è§’æ¥æŸ¥çœ‹ç³»ç»Ÿçš„è¿è¡ŒçŠ¶å†µï¼Ÿ
æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥ç›‘æ§åˆ°JVMçš„å®æ—¶è¿è¡ŒçŠ¶æ€ï¼Ÿ
æ€ä¹ˆå¿«é€Ÿå®šä½åº”ç”¨çš„çƒ­ç‚¹ï¼Œç”Ÿæˆç«ç„°å›¾ï¼Ÿ
æ€æ ·ç›´æ¥ä»JVMå†…æŸ¥æ‰¾æŸä¸ªç±»çš„å®ä¾‹ï¼Ÿ

Arthasæ”¯æŒJDK 6+ï¼Œæ”¯æŒLinux&#x2F;Mac&#x2F;Windowsï¼Œé‡‡ç”¨å‘½ä»¤è¡Œäº¤äº’æ¨¡å¼ï¼ŒåŒæ—¶æä¾›ä¸°å¯Œçš„Â TabÂ è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ï¼Œè¿›ä¸€æ­¥æ–¹ä¾¿è¿›è¡Œé—®é¢˜çš„å®šä½å’Œè¯Šæ–­ã€‚
2. å®‰è£…å’Œå¸è½½2.1 åœ¨çº¿å®‰è£…Arthas
å¦‚æœä¸‹è½½é€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œå¯ä»¥ä½¿ç”¨ aliyun çš„é•œåƒï¼šjava -jar arthas-boot.jar --repo-mirror aliyun --use-http

[root@localhost arthas]# curl -O https://arthas.aliyun.com/arthas-boot.jar  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current                                 Dload  Upload   Total   Spent    Left  Speed100  141k  100  141k    0     0   271k      0 --:--:-- --:--:-- --:--:--  271k

2.2ç¦»çº¿å®‰è£…[root@localhost software]# wget https://github.com/alibaba/arthas/releases/download/arthas-all-4.0.5/arthas-bin.zip--2025-06-07 04:46:25--  https://github.com/alibaba/arthas/releases/download/arthas-all-4.0.5/arthas-bin.zipResolving github.com (github.com)... 20.205.243.166Connecting to github.com (github.com)|20.205.243.166|:443... connected.HTTP request sent, awaiting response... 302 FoundLocation: https://objects.githubusercontent.com/github-production-release-asset-2e65be/146633589/8f7c17e7-21d1-4e42-92b8-4ecefa107242?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=releaseassetproduction%2F20250607%2Fus-east-1%2Fs3%2Faws4_request&amp;X-Amz-Date=20250607T084434Z&amp;X-Amz-Expires=300&amp;X-Amz-Signature=0b3b5544008f728b619ef27e1c0a18f18a65a0948840e4201cabf902ac108612&amp;X-Amz-SignedHeaders=host&amp;response-content-disposition=attachment%3B%20filename%3Darthas-bin.zip&amp;response-content-type=application%2Foctet-stream [following]--2025-06-07 04:46:26--  https://objects.githubusercontent.com/github-production-release-asset-2e65be/146633589/8f7c17e7-21d1-4e42-92b8-4ecefa107242?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=releaseassetproduction%2F20250607%2Fus-east-1%2Fs3%2Faws4_request&amp;X-Amz-Date=20250607T084434Z&amp;X-Amz-Expires=300&amp;X-Amz-Signature=0b3b5544008f728b619ef27e1c0a18f18a65a0948840e4201cabf902ac108612&amp;X-Amz-SignedHeaders=host&amp;response-content-disposition=attachment%3B%20filename%3Darthas-bin.zip&amp;response-content-type=application%2Foctet-streamResolving objects.githubusercontent.com (objects.githubusercontent.com)... 185.199.108.133, 185.199.111.133, 185.199.110.133, ...Connecting to objects.githubusercontent.com (objects.githubusercontent.com)|185.199.108.133|:443... connected.HTTP request sent, awaiting response... 200 OKLength: 14402310 (14M) [application/octet-stream]Saving to: â€˜arthas-bin.zipâ€™100%[====================================================================================================================================================================================================================================&gt;] 14,402,310  5.22MB/s   in 2.6s   2025-06-07 04:46:29 (5.22 MB/s) - â€˜arthas-bin.zipâ€™ saved [14402310/14402310]## è§£å‹ç¼©åˆ°æŒ‡å®šç›®å½•[root@localhost software]# unzip arthas-bin.zip -d /usr/local/software/arthas-binArchive:  arthas-bin.zip   creating: /usr/local/software/arthas-bin/async-profiler/   creating: /usr/local/software/arthas-bin/lib/  inflating: /usr/local/software/arthas-bin/arthas-spy.jar    inflating: /usr/local/software/arthas-bin/arthas-core.jar    inflating: /usr/local/software/arthas-bin/logback.xml    inflating: /usr/local/software/arthas-bin/arthas.properties    inflating: /usr/local/software/arthas-bin/arthas-agent.jar    inflating: /usr/local/software/arthas-bin/arthas-client.jar    inflating: /usr/local/software/arthas-bin/arthas-boot.jar    inflating: /usr/local/software/arthas-bin/math-game.jar    inflating: /usr/local/software/arthas-bin/install-local.sh    inflating: /usr/local/software/arthas-bin/as.sh    inflating: /usr/local/software/arthas-bin/as.bat    inflating: /usr/local/software/arthas-bin/as-service.bat    inflating: /usr/local/software/arthas-bin/async-profiler/libasyncProfiler-linux-arm64.so    inflating: /usr/local/software/arthas-bin/async-profiler/libasyncProfiler-linux-x64.so    inflating: /usr/local/software/arthas-bin/async-profiler/libasyncProfiler-mac.dylib    inflating: /usr/local/software/arthas-bin/lib/libArthasJniLibrary-aarch64.so    inflating: /usr/local/software/arthas-bin/lib/libArthasJniLibrary-x64.dll    inflating: /usr/local/software/arthas-bin/lib/libArthasJniLibrary-x64.so    inflating: /usr/local/software/arthas-bin/lib/libArthasJniLibrary.dyli

2.3 å¯åŠ¨Arthaså¦‚æœæ²¡æœ‰javaè¿›ç¨‹æ˜¯å¯åŠ¨ä¸äº†ã€‚ä¼šçœ‹æŠ¥é”™ä¿¡æ¯ï¼šCan not find java process. Try to run jps command lists the instrumented Java HotSpot VMs on the target system.Please select an available pid.

æ‰§è¡Œè¯¥ç¨‹åºçš„ç”¨æˆ·éœ€è¦å’Œç›®æ ‡è¿›ç¨‹å…·æœ‰ç›¸åŒçš„æƒé™ã€‚æ¯”å¦‚ä»¥adminç”¨æˆ·æ¥æ‰§è¡Œï¼šsudo su admin &amp;&amp; java -jar arthas-boot.jarÂ æˆ–Â sudo -u admin -EH java -jar arthas-boot.jarã€‚
å¦‚æœ attach ä¸ä¸Šç›®æ ‡è¿›ç¨‹ï¼Œå¯ä»¥æŸ¥çœ‹~/logs/arthas/Â ç›®å½•ä¸‹çš„æ—¥å¿—ã€‚
java -jar arthas-boot.jar -hÂ æ‰“å°æ›´å¤šå‚æ•°ä¿¡æ¯ã€‚

[root@localhost arthas]# java -jar arthas-boot.jar[INFO] JAVA_HOME: /usr/local/software/jdk-11.0.16.1[INFO] arthas-boot version: 4.0.5[INFO] Can not find java process. Try to run `jps` command lists the instrumented Java HotSpot VMs on the target system.Please select an available pid.[root@localhost arthas]# 


å¯åŠ¨ math-game

math-gameæ˜¯ä¸€ä¸ªç®€å•çš„ç¨‹åºï¼Œæ¯éš”ä¸€ç§’ç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼Œå†æ‰§è¡Œè´¨å› æ•°åˆ†è§£ï¼Œå¹¶æ‰“å°å‡ºåˆ†è§£ç»“æœã€‚
math-gameæºä»£ç ï¼šæŸ¥çœ‹
[root@localhost arthas]# curl -O https://arthas.aliyun.com/math-game.jar  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current                                 Dload  Upload   Total   Spent    Left  Speed100  4510  100  4510    0     0  16208      0 --:--:-- --:--:-- --:--:-- 16223[root@localhost arthas]# java -jar math-game.jar


é‡æ–°å¯åŠ¨ Arthas

å¯åŠ¨å‘½ä»¤ï¼šjava -jar arthas-boot.jarã€‚å¦‚æœä¸å­˜åœ¨arthasåˆ™ä¼šè‡ªåŠ¨ä¸‹è½½arthasç›¸å…³çš„åŒ…ã€‚
java -jar arthas-boot.jar* **[1]: 5167 math-game.jar**

é€‰æ‹©åº”ç”¨ java è¿›ç¨‹ï¼ŒæœåŠ¡å™¨ä¸Šåªæœ‰ä¸€ä¸ªè¿›ç¨‹ï¼Œmath-gameè¿›ç¨‹æ˜¯ç¬¬ 1 ä¸ªï¼Œåˆ™è¾“å…¥ 1ï¼Œå†è¾“å…¥å›è½¦/enterã€‚Arthas ä¼š attach åˆ°ç›®æ ‡è¿›ç¨‹ä¸Šï¼Œå¹¶è¾“å‡ºæ—¥å¿—ï¼š
[root@localhost arthas]# java -jar arthas-boot.jar[INFO] JAVA_HOME: /usr/local/software/jdk-11.0.16.1[INFO] arthas-boot version: 4.0.5[INFO] Found existing java process, please choose one and input the serial number of the process, eg : 1. Then hit ENTER.* **[1]: 5167 math-game.jar**1[INFO] Start download arthas from remote server: https://arthas.aliyun.com/download/4.0.5?mirror=center[INFO] File size: 13.75 MB, downloaded size: 424.56 KB, downloading ...[INFO] File size: 13.75 MB, downloaded size: 1.33 MB, downloading ...[INFO] File size: 13.75 MB, downloaded size: 2.12 MB, downloading ...[INFO] File size: 13.75 MB, downloaded size: 2.88 MB, downloading ...[INFO] File size: 13.75 MB, downloaded size: 3.72 MB, downloading ...[INFO] File size: 13.75 MB, downloaded size: 4.77 MB, downloading ...[INFO] File size: 13.75 MB, downloaded size: 5.71 MB, downloading ...[INFO] File size: 13.75 MB, downloaded size: 6.52 MB, downloading ...[INFO] File size: 13.75 MB, downloaded size: 7.56 MB, downloading ...[INFO] File size: 13.75 MB, downloaded size: 8.44 MB, downloading ...[INFO] File size: 13.75 MB, downloaded size: 9.51 MB, downloading ...[INFO] File size: 13.75 MB, downloaded size: 10.41 MB, downloading ...[INFO] File size: 13.75 MB, downloaded size: 11.43 MB, downloading ...[INFO] File size: 13.75 MB, downloaded size: 12.08 MB, downloading ...[INFO] File size: 13.75 MB, downloaded size: 12.90 MB, downloading ...[INFO] Download arthas success.[INFO] arthas home: /root/.arthas/lib/4.0.5/arthas[INFO] Try to attach process 5167Picked up JAVA_TOOL_OPTIONS: [INFO] Attach process 5167 success.[INFO] arthas-client connect 127.0.0.1 3658  ,---.  ,------. ,--------.,--.  ,--.  ,---.   ,---.                            /  O  \ |  .--. &#x27;&#x27;--.  .--&#x27;|  &#x27;--&#x27;  | /  O  \ &#x27;   .-&#x27;                          |  .-.  ||  &#x27;--&#x27;.&#x27;   |  |   |  .--.  ||  .-.  |`.  `-.                          |  | |  ||  |\  \    |  |   |  |  |  ||  | |  |.-&#x27;    |                         `--&#x27; `--&#x27;`--&#x27; &#x27;--&#x27;   `--&#x27;   `--&#x27;  `--&#x27;`--&#x27; `--&#x27;`-----&#x27;                          wiki        https://arthas.aliyun.com/doc                                       tutorials   https://arthas.aliyun.com/doc/arthas-tutorials.html                 version     4.0.5                                                               main_class  math-game.jar                                                       pid         5167                                                                start_time  2025-06-06 05:55:57.044                                             currnt_time 2025-06-06 05:56:41.167   

2.4 å¸è½½Arthasåœ¨çº¿å®‰è£… åˆ é™¤ç›®å½•
[root@localhost arthas]# rm -rf ~/.arthas/[root@localhost arthas]# rm -rf ~/logs/arthas*

ç¦»çº¿å®‰è£… åˆ é™¤&#x2F;usr&#x2F;local&#x2F;software&#x2F;arthas-binç›®å½•
[root@localhost arthas]# rm -rf /usr/local/software/arthas-bin]]></content>
      <categories>
        <category>Arthas</category>
      </categories>
      <tags>
        <tag>Arthas</tag>
        <tag>Arthasè¯Šæ–­å·¥å…·</tag>
      </tags>
  </entry>
  <entry>
    <title>Arthasè¯Šæ–­å·¥å…·(ä¸ƒ)Arthasï¼ˆé˜¿å°”è¨æ–¯ï¼‰profilerå‘½ä»¤ç”Ÿæˆç«ç„°å›¾</title>
    <url>/Arthas%E5%BA%94%E7%94%A8(Java)%E8%AF%8A%E6%96%AD%E5%88%A9%E5%99%A8/Arthas%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7(%E4%B8%83)Arthas%EF%BC%88%E9%98%BF%E5%B0%94%E8%90%A8%E6%96%AF%EF%BC%89profiler%E5%91%BD%E4%BB%A4%E7%94%9F%E6%88%90%E7%81%AB%E7%84%B0%E5%9B%BE/</url>
    <content><![CDATA[Arthasè¯Šæ–­å·¥å…·(ä¸ƒ)Arthasï¼ˆé˜¿å°”è¨æ–¯ï¼‰profilerå‘½ä»¤ç”Ÿæˆç«ç„°å›¾1. profilerå‘½ä»¤profilerÂ å‘½ä»¤æ”¯æŒç”Ÿæˆåº”ç”¨çƒ­ç‚¹çš„ç«ç„°å›¾ã€‚æœ¬è´¨ä¸Šæ˜¯é€šè¿‡ä¸æ–­çš„é‡‡æ ·ï¼Œç„¶åæŠŠæ”¶é›†åˆ°çš„é‡‡æ ·ç»“æœç”Ÿæˆç«ç„°å›¾ã€‚
profilerÂ å‘½ä»¤åŸºæœ¬è¿è¡Œç»“æ„æ˜¯Â profiler action [actionArg]
profilerÂ å‘½ä»¤çš„æ ¼å¼åŸºæœ¬ä¸ä¸Šæ¸¸é¡¹ç›®Â async-profileråœ¨æ–°çª—å£æ‰“å¼€Â ä¿æŒä¸€è‡´ï¼Œè¯¦ç»†çš„ä½¿ç”¨æ–¹å¼å¯å‚è€ƒä¸Šæ¸¸é¡¹ç›®çš„ READMEã€Github Disscussions ä»¥åŠå…¶ä»–æ–‡æ¡£èµ„æ–™

ğŸ’¡

ä½¿ç”¨async-profileråœ¨æ–°çª—å£æ‰“å¼€ç”Ÿæˆç«ç„°å›¾



å‚æ•°è¯´æ˜




å‚æ•°åç§°
å‚æ•°è¯´æ˜



action
è¦æ‰§è¡Œçš„æ“ä½œ


actionArg
å±æ€§åæ¨¡å¼


[i:]
é‡‡æ ·é—´éš”ï¼ˆå•ä½ï¼šnsï¼‰ï¼ˆé»˜è®¤å€¼ï¼š10â€™000â€™000ï¼Œå³ 10 msï¼‰


[f:]
å°†è¾“å‡ºè½¬å‚¨åˆ°æŒ‡å®šè·¯å¾„


[d:]
è¿è¡Œè¯„æµ‹æŒ‡å®šç§’


[e:]
è¦è·Ÿè¸ªå“ªä¸ªäº‹ä»¶ï¼ˆcpu, alloc, lock, cache-misses ç­‰ï¼‰ï¼Œé»˜è®¤æ˜¯ cpu


2. å¯åŠ¨ profiler å‘½ä»¤
ğŸ’¡

é»˜è®¤æƒ…å†µä¸‹ï¼Œç”Ÿæˆçš„æ˜¯ cpu çš„ç«ç„°å›¾ï¼Œå³ event ä¸ºcpuã€‚å¯ä»¥ç”¨--eventå‚æ•°æŒ‡å®šå…¶ä»–æ€§èƒ½åˆ†ææ¨¡å¼ï¼Œè§ä¸‹æ–‡


[arthas@8161]$ profiler startProfiling started

3. è·å–å·²é‡‡é›†çš„ sample çš„æ•°é‡[arthas@8161]$ profiler getSamples 34

4. æŸ¥çœ‹ profiling çŠ¶æ€[arthas@8161]$ profiler statusProfiling is running for 230 seconds

5. æŸ¥çœ‹ profiler è‡ªèº«çš„å†…å­˜å ç”¨[arthas@8161]$ profiler meminfo Call trace storage:   10244 KB  Flight recording:       0 KB      Dictionaries:      72 KB        Code cache:   12685 KB------------------------------             Total:   23001 KB

6. åœæ­¢ profiler
ç”Ÿæˆç«ç„°å›¾æ ¼å¼ç»“æœ

é»˜è®¤æƒ…å†µä¸‹ï¼Œç»“æœæ˜¯Â Flame Graphåœ¨æ–°çª—å£æ‰“å¼€Â æ ¼å¼çš„Â htmlÂ æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ç”¨Â -oÂ æˆ–Â --formatÂ å‚æ•°æŒ‡å®šå…¶ä»–å†…å®¹æ ¼å¼ï¼ŒåŒ…æ‹¬ flatã€tracesã€collapsedã€flamegraphã€treeã€jfrã€‚
## åœæ­¢é‡‡é›†æ•°æ®ï¼Œå¹¶ç”Ÿæˆç«ç„°å›¾[arthas@8161]$ profiler stop --format flamegraphOKprofiler output file: /usr/local/software/arthas/arthas-output/20250607-110904.html## é€€å‡ºarthas[arthas@8161]$ stopResetting all enhanced classes ...Affect(class count: 1 , method count: 0) cost in 74 ms, listenerId: 0Arthas Server is going to shutdown...[arthas@8161]$ session (95b458b7-9c4b-4201-a619-de2dae2e85a7) is closed because server is going to shutdown.## ä¸‹è½½ç«ç„°å›¾[root@localhost arthas]# sz /usr/local/software/arthas/arthas-output/20250607-110904.html




arthas ç«ç„°å›¾é¢œè‰²è¯´æ˜ï¼š
ç»¿è‰²ï¼š java ä»£ç 
é»„è‰²ï¼š jvm c++ ä»£ç 
çº¢è‰²ï¼š ç”¨æˆ·æ€ c ä»£ç 
æ©™è‰²ï¼š å†…æ ¸æ€ c ä»£ç 


arthas ç«ç„°å›¾x-yè½´
xè½´ä»£è¡¨çš„ä¸æ˜¯æ—¶é—´ï¼Œè€Œæ˜¯é‡‡æ ·æ€»é‡
yè½´ä»£è¡¨æ–¹æ³•çš„è°ƒç”¨æ ˆæ·±åº¦ï¼Œå€˜è‹¥æ–¹æ³•è°ƒç”¨å¾—è¶Šå¤šï¼Œç«ç„°è¶Šé«˜ï¼Œé¡¶éƒ¨çš„æ ˆå°±æ˜¯å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•


æ ˆå®½å«ä¹‰ï¼ˆCPUæ—¶é—´ï¼‰
å®½åº¦å¯ä»¥ç†è§£ä¸ºCPUé‡‡æ ·ç‡çš„å æ¯”ï¼Œè¶Šå®½ä»£è¡¨å½“å‰æ ˆåœ¨é‡‡æ ·æ•°ä¸­å æ¯”é«˜ï¼Œå…¶å¯èƒ½ä¸ºä¸‰ç§å«ä¹‰ è¯¥å‡½æ•°è¿è¡Œæ—¶é—´é•¿ è¯¥å‡½æ•°è¢«è°ƒç”¨æ¬¡æ•°å¤š


å¹³é¡¶ç°è±¡ï¼ˆä¸€å®šè¦æ ¼å¤–æ³¨æ„ï¼‰
å¹³é¡¶ç°è±¡æ˜¯ç”±äºå½“å‰ç¨‹åºçš„é‡‡æ ·æ•°åœ¨æ€»é‡‡æ ·æ•°ä¸­å ç”¨è¿‡é«˜å¯¼è‡´çš„ï¼Œå‡ºç°è¿™ç§ç°è±¡éœ€è¦ç‰¹æ„å…³æ³¨ä¸€ä¸‹ç¨‹åºå…·ä½“çš„è°ƒç”¨æ ˆï¼Œé‡‡æ ·æ¯”ä¾‹å ç”¨ç‡è¿‡é«˜ï¼Œå³ä»£è¡¨æ–¹æ³•åœ¨CPUä¸­çš„å ç”¨ç‡è¿‡é«˜



æ€»ç»“ï¼š
ç«ç„°å›¾åªæ˜¯ç”¨äºè¾…åŠ©ç¨‹åºåˆ†æå®šä½é—®é¢˜ï¼ŒæŸ¥çœ‹ç¨‹åºåœ¨é‡‡æ ·æœŸé—´çš„å¤§è‡´æƒ…å†µï¼Œå®é™…åœºæ™¯è¿˜éœ€ç»“åˆCPUå ç”¨ç‡ã€æŸ¥çœ‹JVMçš„DUMPå¿«ç…§ç­‰æ–¹å¼è¿›è¡Œå®šä½

ç«ç„°å›¾çš„é¡¶éƒ¨ä»£è¡¨CPUæ¶ˆè€—æœ€é«˜çš„æ–¹æ³•ï¼Œè¶Šå¾€ä¸‹æ–¹æ³•çš„æ¶ˆè€—è¶Šä½ã€‚å®½åº¦è¿‡å®½çš„æ–¹æ³•è¡¨ç¤ºå…¶è¢«è°ƒç”¨é¢‘ç¹æˆ–è‡ªèº«æ‰§è¡Œæ—¶é—´é•¿ï¼Œæ˜¯æ€§èƒ½ç“¶é¢ˆçš„å€™é€‰ç‚¹ã€‚
é€šè¿‡è§‚å¯Ÿç«ç„°å›¾ï¼Œä½ å¯ä»¥è¯†åˆ«å‡ºå“ªäº›æ–¹æ³•å ç”¨CPUæœ€å¤šï¼Œè¿›è€Œé’ˆå¯¹æ€§åœ°ä¼˜åŒ–è¿™äº›â€œçƒ­ç‚¹â€æ–¹æ³•ï¼Œæå‡ç¨‹åºæ€§èƒ½ã€‚

7. profiler æ”¯æŒçš„ eventsåœ¨ä¸åŒçš„å¹³å°ï¼Œä¸åŒçš„ OS ä¸‹é¢ï¼Œæ”¯æŒçš„ events å„æœ‰ä¸åŒã€‚æ¯”å¦‚åœ¨ centosä¸‹é¢ï¼š
[arthas@8161]$ profiler listBasic events:  cpu  alloc  nativemem  lock  wall  itimer  ctimerJava method calls:  ClassName.methodNamePerf events:  cpu-clock  page-faults  context-switches  cycles  instructions  cache-references  cache-misses  branch-instructions  branch-misses  bus-cycles  L1-dcache-load-misses  LLC-load-misses  dTLB-load-misses  rNNN  pmu/event-descriptor/  mem:breakpoint  trace:tracepoint  kprobe:func  uprobe:path]]></content>
      <categories>
        <category>Arthas</category>
      </categories>
      <tags>
        <tag>Arthas</tag>
        <tag>Arthasè¯Šæ–­å·¥å…·</tag>
      </tags>
  </entry>
  <entry>
    <title>Arthasè¯Šæ–­å·¥å…·(ä¸‰)Arthasï¼ˆé˜¿å°”è¨æ–¯ï¼‰JVMç›¸å…³å‘½ä»¤</title>
    <url>/Arthas%E5%BA%94%E7%94%A8(Java)%E8%AF%8A%E6%96%AD%E5%88%A9%E5%99%A8/Arthas%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7(%E4%B8%89)Arthas%EF%BC%88%E9%98%BF%E5%B0%94%E8%90%A8%E6%96%AF%EF%BC%89JVM%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[Arthasè¯Šæ–­å·¥å…·(ä¸‰)Arthasï¼ˆé˜¿å°”è¨æ–¯ï¼‰JVMç›¸å…³å‘½ä»¤1. jvmå‘½ä»¤æŸ¥çœ‹å½“å‰ JVM ä¿¡æ¯
[arthas@5167]$ jvm RUNTIME                                                                                                                                                                                                                                                                      ------------------------------------------------------------------------------------------------------------------------------------------------ MACHINE-NAME                                                                 5167@localhost.localdomain                                         JVM-START-TIME                                                               2025-06-06 05:55:57                                                MANAGEMENT-SPEC-VERSION                                                      2.0                                                                SPEC-NAME                                                                    Java Virtual Machine Specification                                 SPEC-VENDOR                                                                  Oracle Corporation                                                 SPEC-VERSION                                                                 11                                                                 VM-NAME                                                                      Java HotSpot(TM) 64-Bit Server VM                                  VM-VENDOR                                                                    Oracle Corporation                                                 VM-VERSION                                                                   11.0.16.1+1-LTS-1                                                  INPUT-ARGUMENTS                                                              []                                                                 CLASS-PATH                                                                   math-game.jar                                                      BOOT-CLASS-PATH                                                                                                                                 LIBRARY-PATH                                                                 /usr/java/packages/lib:/usr/lib64:/lib64:/lib:/usr/lib                                                                                                                                                            ------------------------------------------------------------------------------------------------------------------------------------------------ CLASS-LOADING                                                                                                                                  ------------------------------------------------------------------------------------------------------------------------------------------------ LOADED-CLASS-COUNT                                                           6215                                                               TOTAL-LOADED-CLASS-COUNT                                                     6272                                                               UNLOADED-CLASS-COUNT                                                         57                                                                 IS-VERBOSE                                                                   false                                                                                                                                                                                                             ------------------------------------------------------------------------------------------------------------------------------------------------ COMPILATION                                                                                                                                    ------------------------------------------------------------------------------------------------------------------------------------------------ NAME                                                                         HotSpot 64-Bit Tiered Compilers                                    TOTAL-COMPILE-TIME                                                           22523                                                              [time (ms)]                                                                                                                                                                                                                                                                                    ------------------------------------------------------------------------------------------------------------------------------------------------ GARBAGE-COLLECTORS                                                                                                                             ------------------------------------------------------------------------------------------------------------------------------------------------ G1 Young Generation                                                          name : G1 Young Generation                                         [count/time (ms)]                                                            collectionCount : 7                                                                                                                             collectionTime : 182                                               G1 Old Generation                                                            name : G1 Old Generation                                           [count/time (ms)]                                                            collectionCount : 0                                                                                                                             collectionTime : 0                                                                                                                                                                                                ------------------------------------------------------------------------------------------------------------------------------------------------ MEMORY-MANAGERS                                                                                                                                ------------------------------------------------------------------------------------------------------------------------------------------------ CodeCacheManager                                                             CodeHeap &#x27;non-nmethods&#x27;                                                                                                                         CodeHeap &#x27;profiled nmethods&#x27;                                                                                                                    CodeHeap &#x27;non-profiled nmethods&#x27;                                   Metaspace Manager                                                            Metaspace                                                                                                                                       Compressed Class Space                                             G1 Young Generation                                                          G1 Eden Space                                                                                                                                   G1 Survivor Space                                                                                                                               G1 Old Gen                                                         G1 Old Generation                                                            G1 Eden Space                                                                                                                                   G1 Survivor Space                                                                                                                               G1 Old Gen                                                                                                                                                                                                        ------------------------------------------------------------------------------------------------------------------------------------------------ MEMORY                                                                                                                                         ------------------------------------------------------------------------------------------------------------------------------------------------ HEAP-MEMORY-USAGE                                                            init : 130023424(124.0 MiB)                                        [memory in bytes]                                                            used : 40942912(39.0 MiB)                                                                                                                       committed : 130023424(124.0 MiB)                                                                                                                max : 2051014656(1.9 GiB)                                          NO-HEAP-MEMORY-USAGE                                                         init : 7667712(7.3 MiB)                                            [memory in bytes]                                                            used : 60157088(57.4 MiB)                                                                                                                       committed : 63004672(60.1 MiB)                                                                                                                  max : -1(-1 B)                                                     PENDING-FINALIZE-COUNT                                                       0                                                                                                                                                                                                                 ------------------------------------------------------------------------------------------------------------------------------------------------ OPERATING-SYSTEM                                                                                                                               ------------------------------------------------------------------------------------------------------------------------------------------------ OS                                                                           Linux                                                              ARCH                                                                         amd64                                                              PROCESSORS-COUNT                                                             4                                                                  LOAD-AVERAGE                                                                 0.0                                                                VERSION                                                                      3.10.0-957.el7.x86_64                                                                                                                                                                                             ------------------------------------------------------------------------------------------------------------------------------------------------ THREAD                                                                                                                                         ------------------------------------------------------------------------------------------------------------------------------------------------ COUNT                                                                        20                                                                 DAEMON-COUNT                                                                 19                                                                 PEAK-COUNT                                                                   20                                                                 STARTED-COUNT                                                                27                                                                 DEADLOCK-COUNT                                                               0                                                                                                                                                                                                                 ------------------------------------------------------------------------------------------------------------------------------------------------ FILE-DESCRIPTOR                                                                                                                                ------------------------------------------------------------------------------------------------------------------------------------------------ MAX-FILE-DESCRIPTOR-COUNT                                                    -1                                                                 OPEN-FILE-DESCRIPTOR-COUNT                                                   -1                                                                


THREAD ç›¸å…³
COUNT: JVM å½“å‰æ´»è·ƒçš„çº¿ç¨‹æ•°
DAEMON-COUNT: JVM å½“å‰æ´»è·ƒçš„å®ˆæŠ¤çº¿ç¨‹æ•°
PEAK-COUNT: ä» JVM å¯åŠ¨å¼€å§‹æ›¾ç»æ´»ç€çš„æœ€å¤§çº¿ç¨‹æ•°
STARTED-COUNT: ä» JVM å¯åŠ¨å¼€å§‹æ€»å…±å¯åŠ¨è¿‡çš„çº¿ç¨‹æ¬¡æ•°
DEADLOCK-COUNT: JVM å½“å‰æ­»é”çš„çº¿ç¨‹æ•°


æ–‡ä»¶æè¿°ç¬¦ç›¸å…³
MAX-FILE-DESCRIPTOR-COUNTï¼šJVM è¿›ç¨‹æœ€å¤§å¯ä»¥æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°
OPEN-FILE-DESCRIPTOR-COUNTï¼šJVM å½“å‰æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°



2. sysprop å‘½ä»¤æŸ¥çœ‹å½“å‰ JVM çš„ç³»ç»Ÿå±æ€§(System Property)
[arthas@5167]$ sysprop  KEY                                                   VALUE                                                                                                                                                                                                                  ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ awt.toolkit                                           sun.awt.X11.XToolkit                                                                                                                                                                                                    java.specification.version                            11                                                                                                                                                                                                                      sun.cpu.isalist                                                                                                                                                                                                                                                               sun.jnu.encoding                                      UTF-8                                                                                                                                                                                                                   java.class.path                                       math-game.jar                                                                                                                                                                                                           java.vm.vendor                                        Oracle Corporation                                                                                                                                                                                                      sun.arch.data.model                                   64                                                                                                                                                                                                                      java.vendor.url                                       https://openjdk.java.net/                                                                                                                                                                                               user.timezone                                         America/New_York                                                                                                                                                                                                        os.name                                               Linux                                                                                                                                                                                                                   java.vm.specification.version                         11                                                                                                                                                                                                                      sun.java.launcher                                     SUN_STANDARD                                                                                                                                                                                                            user.country                                          US                                                                                                                                                                                                                      sun.boot.library.path                                 /usr/local/software/jdk-11.0.16.1/lib                                                                                                                                                                                   sun.java.command                                      math-game.jar                                                                                                                                                                                                           jdk.debug                                             release                                                                                                                                                                                                                 sun.cpu.endian                                        little                                                                                                                                                                                                                  user.home                                             /root                                                                                                                                                                                                                   user.language                                         en                                                                                                                                                                                                                      java.specification.vendor                             Oracle Corporation                                                                                                                                                                                                      java.version.date                                     2022-08-18                                                                                                                                                                                                              java.home                                             /usr/local/software/jdk-11.0.16.1                                                                                                                                                                                       file.separator                                        /                                                                                                                                                                                                                       java.vm.compressedOopsMode                            32-bit                                                                                                                                                                                                                  line.separator                                                                                                                                                                                                                                                                java.specification.name                               Java Platform API Specification                                                                                                                                                                                         java.vm.specification.vendor                          Oracle Corporation                                                                                                                                                                                                      java.awt.graphicsenv                                  sun.awt.X11GraphicsEnvironment                                                                                                                                                                                          sun.management.compiler                               HotSpot 64-Bit Tiered Compilers                                                                                                                                                                                         java.runtime.version                                  11.0.16.1+1-LTS-1                                                                                                                                                                                                       user.name                                             root                                                                                                                                                                                                                    path.separator                                        :                                                                                                                                                                                                                       os.version                                            3.10.0-957.el7.x86_64                                                                                                                                                                                                   java.runtime.name                                     Java(TM) SE Runtime Environment                                                                                                                                                                                         file.encoding                                         UTF-8                                                                                                                                                                                                                   java.vm.name                                          Java HotSpot(TM) 64-Bit Server VM                                                                                                                                                                                       java.vendor.version                                   18.9                                                                                                                                                                                                                    java.vendor.url.bug                                   https://bugreport.java.com/bugreport/                                                                                                                                                                                   java.io.tmpdir                                        /tmp                                                                                                                                                                                                                    java.version                                          11.0.16.1                                                                                                                                                                                                               user.dir                                              /usr/local/software/arthas                                                                                                                                                                                              os.arch                                               amd64                                                                                                                                                                                                                   java.vm.specification.name                            Java Virtual Machine Specification                                                                                                                                                                                      java.awt.printerjob                                   sun.print.PSPrinterJob                                                                                                                                                                                                  sun.os.patch.level                                    unknown                                                                                                                                                                                                                 java.library.path                                     /usr/java/packages/lib:/usr/lib64:/lib64:/lib:/usr/lib                                                                                                                                                                  java.vendor                                           Oracle Corporation                                                                                                                                                                                                      java.vm.info                                          mixed mode                                                                                                                                                                                                              java.vm.version                                       11.0.16.1+1-LTS-1                                                                                                                                                                                                       sun.io.unicode.encoding                               UnicodeLittle                                                                                                                                                                                                           java.class.version                                    55.0  


æŸ¥çœ‹æŸä¸€ä¸ªç³»ç»Ÿå±æ€§

[arthas@5167]$ sysprop file.encoding KEY                                                   VALUE                                                                                                                                                                                                                  ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ file.encoding                                         UTF-8                                                                                                                                                                                                                  [arthas@5167]$ 


ä¿®æ”¹æŸä¸€ä¸ªå±æ€§

[arthas@5167]$ sysprop production.mode trueSuccessfully changed the system property. KEY                                                   VALUE                                                                                                                                                                                                                  ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ production.mode                                       true                                                                                                                                                                                                                   

3. sysprop å‘½ä»¤æŸ¥çœ‹å½“å‰ JVM çš„ç³»ç»Ÿå±æ€§(System Property)
[arthas@7339]$ sysenv  KEY                                                   VALUE                                                                                                                                                                                                                  ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ CLASSPATH                                             .:/usr/local/software/jdk-11.0.16.1/lib/dt.jar:/usr/local/software/jdk-11.0.16.1/lib/tools.jar                                                                                                                          HISTCONTROL                                           ignoredups                                                                                                                                                                                                              HISTSIZE                                              1000                                                                                                                                                                                                                    HOME                                                  /root                                                                                                                                                                                                                   HOSTNAME                                              localhost.localdomain                                                                                                                                                                                                   JAVA_HOME                                             /usr/local/software/jdk-11.0.16.1                                                                                                                                                                                       LANG                                                  en_US.UTF-8                                                                                                                                                                                                             LESSOPEN                                              ||/usr/bin/lesspipe.sh %s                                                                                                                                                                                               LOGNAME                                               root                                                                                                                                                                                                                    LS_COLORS                                             rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=01;05;37;41:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;31:*.arj=01                                                        ;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:*.lzo=01;31:*.xz=01;31:*                                                        .bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*                                                        .cab=01;31:*.jpg=01;35:*.jpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01                                                        ;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.fl                                                        c=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.axv=01;35:*.anx=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=01;36:*.au=01;36:*.flac=01;36:*.mi                                                        d=01;36:*.midi=01;36:*.mka=01;36:*.mp3=01;36:*.mpc=01;36:*.ogg=01;36:*.ra=01;36:*.wav=01;36:*.axa=01;36:*.oga=01;36:*.spx=01;36:*.xspf=01;36:                                                                           MAIL                                                  /var/spool/mail/root                                                                                                                                                                                                    OLDPWD                                                /usr/local/software                                                                                                                                                                                                     PATH                                                  /usr/local/software/jdk-11.0.16.1/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin                                                                                                                       PWD                                                   /usr/local/software/arthas                                                                                                                                                                                              SELINUX_LEVEL_REQUESTED                                                                                                                                                                                                                                                       SELINUX_ROLE_REQUESTED                                                                                                                                                                                                                                                        SELINUX_USE_CURRENT_RANGE                                                                                                                                                                                                                                                     SHELL                                                 /bin/bash                                                                                                                                                                                                               SHLVL                                                 1                                                                                                                                                                                                                       SSH_CLIENT                                            192.168.3.74 2421 22                                                                                                                                                                                                    SSH_CONNECTION                                        192.168.3.74 2421 192.168.3.125 22                                                                                                                                                                                      SSH_TTY                                               /dev/pts/2                                                                                                                                                                                                              TERM                                                  xterm                                                                                                                                                                                                                   USER                                                  root                                                                                                                                                                                                                    XDG_RUNTIME_DIR                                       /run/user/0                                                                                                                                                                                                             XDG_SESSION_ID                                        25                                                                                                                                                                                                                      _                                                     /usr/local/software/jdk-11.0.16.1/bin/java 


æŸ¥çœ‹å•ä¸ªç¯å¢ƒå˜é‡

sysenv JAVA_HOME
[arthas@7339]$ sysenv JAVA_HOME KEY                                                   VALUE                                                                                                                                                                                                                  ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ JAVA_HOME                                             /usr/local/software/jdk-11.0.16.1 

4. vmoptionå‘½ä»¤æŸ¥çœ‹ï¼Œæ›´æ–° VM è¯Šæ–­ç›¸å…³çš„å‚æ•°
[arthas@7339]$ vmoption  KEY                                                                 VALUE                                                              ORIGIN                                                              WRITEABLE                                                         ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ HeapDumpBeforeFullGC                                                false                                                              DEFAULT                                                             true                                                               HeapDumpAfterFullGC                                                 false                                                              DEFAULT                                                             true                                                               HeapDumpOnOutOfMemoryError                                          false                                                              DEFAULT                                                             true                                                               HeapDumpPath                                                                                                                           DEFAULT                                                             true                                                               PrintClassHistogram                                                 false                                                              DEFAULT                                                             true                                                               MinHeapFreeRatio                                                    40                                                                 DEFAULT                                                             true                                                               MaxHeapFreeRatio                                                    70                                                                 DEFAULT                                                             true                                                               PrintConcurrentLocks                                                false                                                              DEFAULT                                                             true                                                               CMSAbortablePrecleanWaitMillis                                      100                                                                DEFAULT                                                             true                                                               CMSWaitDuration                                                     2000                                                               DEFAULT                                                             true                                                               CMSTriggerInterval                                                  -1                                                                 DEFAULT                                                             true                                                              


æ›´æ–°æŒ‡å®šçš„ option

[arthas@7339]$ vmoption HeapDumpBeforeFullGC trueSuccessfully updated the vm option. NAME                  BEFORE-VALUE  AFTER-VALUE                                                                                                                                                                                                                              -------------------------------------------------                                                                                                                                                                                                                              HeapDumpBeforeFullGC  false         true   

5. getstatic å‘½ä»¤é€šè¿‡ getstatic å‘½ä»¤å¯ä»¥æ–¹ä¾¿çš„æŸ¥çœ‹ç±»çš„é™æ€å±æ€§ã€‚ä½¿ç”¨æ–¹æ³•ä¸ºgetstatic class_name field_name
[arthas@7339]$ getstatic demo.MathGame randomfield: random@Random[    serialVersionUID=@Long[3905348978240129619],    seed=@AtomicLong[279863952692122],    multiplier=@Long[25214903917],    addend=@Long[11],    mask=@Long[281474976710655],    DOUBLE_UNIT=@Double[1.1102230246251565E-16],    BadBound=@String[bound must be positive],    BadRange=@String[bound must be greater than origin],    BadSize=@String[size must be non-negative],    seedUniquifier=@AtomicLong[-2942033378085796212],    nextNextGaussian=@Double[0.0],    haveNextNextGaussian=@Boolean[false],    serialPersistentFields=@ObjectStreamField[][isEmpty=false;size=3],    unsafe=@Unsafe[jdk.internal.misc.Unsafe@1004ff20],    seedOffset=@Long[24],]Affect(row-cnt:1) cost in 29 ms.

6. ognlå‘½ä»¤æ‰§è¡Œ ognl è¡¨è¾¾å¼ï¼Œä» 3.0.5 ç‰ˆæœ¬å¢åŠ 

å‚æ•°è¯´æ˜




å‚æ•°åç§°
å‚æ•°è¯´æ˜



express
æ‰§è¡Œçš„è¡¨è¾¾å¼


[c:]
æ‰§è¡Œè¡¨è¾¾å¼çš„ ClassLoader çš„ hashcodeï¼Œé»˜è®¤å€¼æ˜¯ SystemClassLoader


[classLoaderClass:]
æŒ‡å®šæ‰§è¡Œè¡¨è¾¾å¼çš„ ClassLoader çš„ class name


[x]
ç»“æœå¯¹è±¡çš„å±•å¼€å±‚æ¬¡ï¼Œé»˜è®¤å€¼ 1



ä½¿ç”¨å‚è€ƒ
OGNL ç‰¹æ®Šç”¨æ³•è¯·å‚è€ƒï¼šhttps://github.com/alibaba/arthas/issues/71
OGNL è¡¨è¾¾å¼å®˜æ–¹æŒ‡å—ï¼šhttps://commons.apache.org/dormant/commons-ognl/language-guide.html

ä¸¾ä¾‹ï¼š
## java.lang.System.out.printlnn(&quot;hello&quot;) æ–¹æ³•æ²¡æœ‰è¿”å›å€¼[arthas@7339]$ ognl &#x27;@java.lang.System@out.println(&quot;hello&quot;)&#x27;null## java.lang.System.currentTimeMillis()è¿”å›å€¼ä¸ºLongç±»å‹[arthas@7339]$ ognl &#x27;@java.lang.System@currentTimeMillis()&#x27;@Long[1749270125080]## è·å–é™æ€å˜é‡å±æ€§[arthas@7339]$ ognl &#x27;@demo.MathGame@random&#x27;@Random[    serialVersionUID=@Long[3905348978240129619],    seed=@AtomicLong[66121191540312],    multiplier=@Long[25214903917],    addend=@Long[11],    mask=@Long[281474976710655],    DOUBLE_UNIT=@Double[1.1102230246251565E-16],    BadBound=@String[bound must be positive],    BadRange=@String[bound must be greater than origin],    BadSize=@String[size must be non-negative],    seedUniquifier=@AtomicLong[-2942033378085796212],    nextNextGaussian=@Double[0.0],    haveNextNextGaussian=@Boolean[false],    serialPersistentFields=@ObjectStreamField[][isEmpty=false;size=3],    unsafe=@Unsafe[jdk.internal.misc.Unsafe@1004ff20],    seedOffset=@Long[24],]## è·å–JVMç¯å¢ƒå˜é‡ä¸­çš„å±æ€§å€¼ï¼ŒæŠŠè·å–åˆ°çš„ç»“æœï¼Œåˆ†åˆ«èµ‹å€¼ç»™value1,value2ã€‚æœ€åå†å°†value1&amp;value2çš„å€¼æ”¾å…¥ArrayListé›†ä¸­ï¼Œæœ€åæ‰“å°ArrayListç»“æœã€‚[arthas@7339]$ ognl &#x27;#value1=@System@getProperty(&quot;java.home&quot;), #value2=@System@getProperty(&quot;java.runtime.name&quot;), &#123;#value1, #value2&#125;&#x27;@ArrayList[    @String[/usr/local/software/jdk-11.0.16.1],    @String[Java(TM) SE Runtime Environment],]]]></content>
      <categories>
        <category>Arthas</category>
      </categories>
      <tags>
        <tag>Arthas</tag>
        <tag>Arthasè¯Šæ–­å·¥å…·</tag>
      </tags>
  </entry>
  <entry>
    <title>Arthasè¯Šæ–­å·¥å…·(ä¸€)Arthasï¼ˆé˜¿å°”è¨æ–¯ï¼‰å¿«é€Ÿå…¥é—¨</title>
    <url>/Arthas%E5%BA%94%E7%94%A8(Java)%E8%AF%8A%E6%96%AD%E5%88%A9%E5%99%A8/Arthas%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7(%E4%BA%8C)Arthas%EF%BC%88%E9%98%BF%E5%B0%94%E8%90%A8%E6%96%AF%EF%BC%89%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[Arthasè¯Šæ–­å·¥å…·(äºŒ)Arthasï¼ˆé˜¿å°”è¨æ–¯ï¼‰å¸¸ç”¨å‘½ä»¤1. dashboardå‘½ä»¤1.1 æ•°æ®è¯´æ˜
ID: Java çº§åˆ«çš„çº¿ç¨‹ IDï¼Œæ³¨æ„è¿™ä¸ª ID ä¸èƒ½è·Ÿ jstack ä¸­çš„ nativeID ä¸€ä¸€å¯¹åº”ã€‚
NAME: çº¿ç¨‹å
GROUP: çº¿ç¨‹ç»„å
PRIORITY: çº¿ç¨‹ä¼˜å…ˆçº§, 1~10 ä¹‹é—´çš„æ•°å­—ï¼Œè¶Šå¤§è¡¨ç¤ºä¼˜å…ˆçº§è¶Šé«˜
STATE: çº¿ç¨‹çš„çŠ¶æ€
CPU%: çº¿ç¨‹çš„ cpu ä½¿ç”¨ç‡ã€‚æ¯”å¦‚é‡‡æ ·é—´éš” 1000msï¼ŒæŸä¸ªçº¿ç¨‹çš„å¢é‡ cpu æ—¶é—´ä¸º 100msï¼Œåˆ™ cpu ä½¿ç”¨ç‡&#x3D;100&#x2F;1000&#x3D;10%
DELTA_TIME: ä¸Šæ¬¡é‡‡æ ·ä¹‹åçº¿ç¨‹è¿è¡Œå¢é‡ CPU æ—¶é—´ï¼Œæ•°æ®æ ¼å¼ä¸ºç§’
TIME: çº¿ç¨‹è¿è¡Œæ€» CPU æ—¶é—´ï¼Œæ•°æ®æ ¼å¼ä¸ºåˆ†:ç§’
INTERRUPTED: çº¿ç¨‹å½“å‰çš„ä¸­æ–­ä½çŠ¶æ€
DAEMON: æ˜¯å¦æ˜¯ daemon çº¿ç¨‹

1.2 JVM å†…éƒ¨çº¿ç¨‹Java 8 ä¹‹åæ”¯æŒè·å– JVM å†…éƒ¨çº¿ç¨‹ CPU æ—¶é—´ï¼Œè¿™äº›çº¿ç¨‹åªæœ‰åç§°å’Œ CPU æ—¶é—´ï¼Œæ²¡æœ‰ ID åŠçŠ¶æ€ç­‰ä¿¡æ¯ï¼ˆæ˜¾ç¤º ID ä¸º-1ï¼‰ã€‚ é€šè¿‡å†…éƒ¨çº¿ç¨‹å¯ä»¥è§‚æµ‹åˆ° JVM æ´»åŠ¨ï¼Œå¦‚ GCã€JIT ç¼–è¯‘ç­‰å ç”¨ CPU æƒ…å†µï¼Œæ–¹ä¾¿äº†è§£ JVM æ•´ä½“è¿è¡ŒçŠ¶å†µã€‚

å½“ JVM å †(heap)&#x2F;å…ƒæ•°æ®(metaspace)ç©ºé—´ä¸è¶³æˆ– OOM æ—¶ï¼Œå¯ä»¥çœ‹åˆ° GC çº¿ç¨‹çš„ CPU å ç”¨ç‡æ˜æ˜¾é«˜äºå…¶ä»–çš„çº¿ç¨‹ã€‚
å½“æ‰§è¡Œtrace/watch/tt/redefineç­‰å‘½ä»¤åï¼Œå¯ä»¥çœ‹åˆ° JIT çº¿ç¨‹æ´»åŠ¨å˜å¾—æ›´é¢‘ç¹ã€‚å› ä¸º JVM çƒ­æ›´æ–° class å­—èŠ‚ç æ—¶æ¸…é™¤äº†æ­¤ class ç›¸å…³çš„ JIT ç¼–è¯‘ç»“æœï¼Œéœ€è¦é‡æ–°ç¼–è¯‘ã€‚

JVM å†…éƒ¨çº¿ç¨‹åŒ…æ‹¬ä¸‹é¢å‡ ç§ï¼š

JIT ç¼–è¯‘çº¿ç¨‹: å¦‚Â C1 CompilerThread0,Â C2 CompilerThread0
GC çº¿ç¨‹: å¦‚GC Thread0,Â G1 Young RemSet Sampling
å…¶å®ƒå†…éƒ¨çº¿ç¨‹: å¦‚VM Periodic Task Thread,Â VM Thread,Â Service Thread


2. thread å‘½ä»¤é€šè¿‡ thread å‘½ä»¤æ¥è·å–åˆ°math-gameè¿›ç¨‹çš„ Main Classã€‚thread 1ä¼šæ‰“å°çº¿ç¨‹ ID 1 çš„æ ˆï¼Œé€šå¸¸æ˜¯ main å‡½æ•°çš„çº¿ç¨‹ã€‚
[arthas@5167]$ **thread** Threads Total: 30, NEW: 0, RUNNABLE: 12, BLOCKED: 0, WAITING: 2, TIMED_WAITING: 4, TERMINATED: 0, Internal threads: 12                                                                                                                                                        ID         NAME                                                                GROUP                             PRIORITY              STATE                  %CPU                  DELTA_TIME             TIME                  INTERRUPTED            DAEMON                -1         C1 CompilerThread0                                                  -                                 -1                    -                      0.26                  0.000                  0:3.219               false                  true                  24         arthas-command-execute                                              system                            5                     RUNNABLE               0.15                  0.000                  0:0.016               false                  true                  -1         VM Periodic Task Thread                                             -                                 -1                    -                      0.05                  0.000                  0:3.005               false                  true                  -1         GC Thread#1                                                         -                                 -1                    -                      0.03                  0.000                  0:0.405               false                  true                  -1         VM Thread                                                           -                                 -1                    -                      0.03                  0.000                  0:0.487               false                  true                  -1         GC Thread#0                                                         -                                 -1                    -                      0.03                  0.000                  0:0.409               false                  true                  -1         G1 Young RemSet Sampling                                            -                                 -1                    -                      0.02                  0.000                  0:0.879               false                  true                  -1         C2 CompilerThread0                                                  -                                 -1                    -                      0.0                   0.000                  0:5.703               false                  true                  2          Reference Handler                                                   system                            10                    RUNNABLE               0.0                   0.000                  0:0.001               false                  true                  3          Finalizer                                                           system                            8                     WAITING                0.0                   0.000                  0:0.000               false                  true                  4          Signal Dispatcher                                                   system                            9                     RUNNABLE               0.0                   0.000                  0:0.003               false                  true                  11         Attach Listener                                                     system                            9                     RUNNABLE               0.0                   0.000                  0:0.119               false                  true                  13         arthas-timer                                                        system                            9                     WAITING                0.0                   0.000                  0:0.000               false                  true                  16         arthas-NettyHttpTelnetBootstrap-3-1                                 system                            5                     RUNNABLE               0.0                   0.000                  0:0.040               false                  true                  17         arthas-NettyWebsocketTtyBootstrap-4-1                               system                            5                     RUNNABLE               0.0                   0.000                  0:0.000               false                  true                  18         arthas-NettyWebsocketTtyBootstrap-4-2                               system                            5                     RUNNABLE               0.0                   0.000                  0:0.001               false                  true                  19         arthas-shell-server                                                 system                            9                     TIMED_WAITING          0.0                   0.000                  0:0.020               false                  true                  20         arthas-session-manager                                              system                            9                     TIMED_WAITING          0.0                   0.000                  0:0.009               false                  true                  22         arthas-NettyHttpTelnetBootstrap-3-2                                 system                            5                     RUNNABLE               0.0                   0.000                  0:0.337               false                  true                  23         arthas-NettyHttpTelnetBootstrap-3-3                                 system                            5                     RUNNABLE               0.0                   0.000                  0:0.029               false                  true                  25         arthas-NettyHttpTelnetBootstrap-3-4                                 system                            5                     RUNNABLE               0.0                   0.000                  0:0.025               false                  true                  26         arthas-NettyHttpTelnetBootstrap-3-5                                 system                            5                     RUNNABLE               0.0                   0.000                  0:0.027               false                  true                  27         arthas-NettyHttpTelnetBootstrap-3-6                                 system                            5                     RUNNABLE               0.0                   0.000                  0:0.500               false                  true                  1          main                                                                main                              5                     TIMED_WAITING          0.0                   0.000                  0:1.265               false                  false                 10         Common-Cleaner                                                      InnocuousThreadGroup              8                     TIMED_WAITING          0.0                   0.000                  0:0.005               false                  true                  -1         Sweeper thread                                                      -                                 -1                    -                      0.0                   0.000                  0:0.000               false                  true                  -1         G1 Conc#0                                                           -                                 -1                    -                      0.0                   0.000                  0:0.012               false                  true                  -1         G1 Refine#0                                                         -                                 -1                    -                      0.0                   0.000                  0:0.003               false                  true                  -1         G1 Main Marker                                                      -                                 -1                    -                      0.0                   0.000                  0:0.000               false                  true                  -1         Service Thread                                                      -                                 -1                    -                      0.0                   0.000                  0:0.000               false                  true                                                                                                                                                                                                                                                                                                [arthas@5167]$ **thread 1**&quot;main&quot; Id=1 TIMED_WAITING    at java.base@11.0.16.1/java.lang.Thread.sleep(Native Method)    at java.base@11.0.16.1/java.lang.Thread.sleep(Thread.java:339)    at java.base@11.0.16.1/java.util.concurrent.TimeUnit.sleep(TimeUnit.java:446)    at app//demo.MathGame.main(MathGame.java:17)


æ”¯æŒä¸€é”®å±•ç¤ºå½“å‰æœ€å¿™çš„å‰ N ä¸ªçº¿ç¨‹å¹¶æ‰“å°å †æ ˆï¼š

[arthas@5167]$ thread -n 3&quot;arthas-command-execute&quot; Id=24 cpuUsage=0.31% deltaTime=0ms time=1521ms RUNNABLE    at java.management@11.0.16.1/sun.management.ThreadImpl.dumpThreads0(Native Method)    at java.management@11.0.16.1/sun.management.ThreadImpl.getThreadInfo(ThreadImpl.java:485)    at com.taobao.arthas.core.command.monitor200.ThreadCommand.processTopBusyThreads(ThreadCommand.java:206)    at com.taobao.arthas.core.command.monitor200.ThreadCommand.process(ThreadCommand.java:122)    at com.taobao.arthas.core.shell.command.impl.AnnotatedCommandImpl.process(AnnotatedCommandImpl.java:82)    at com.taobao.arthas.core.shell.command.impl.AnnotatedCommandImpl.access$100(AnnotatedCommandImpl.java:18)    at com.taobao.arthas.core.shell.command.impl.AnnotatedCommandImpl$ProcessHandler.handle(AnnotatedCommandImpl.java:111)    at com.taobao.arthas.core.shell.command.impl.AnnotatedCommandImpl$ProcessHandler.handle(AnnotatedCommandImpl.java:108)    at com.taobao.arthas.core.shell.system.impl.ProcessImpl$CommandProcessTask.run(ProcessImpl.java:385)    at java.base@11.0.16.1/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)    at java.base@11.0.16.1/java.util.concurrent.FutureTask.run(FutureTask.java:264)    at java.base@11.0.16.1/java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:304)    at java.base@11.0.16.1/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)    at java.base@11.0.16.1/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)    at java.base@11.0.16.1/java.lang.Thread.run(Thread.java:834)


thread -b, æ‰¾å‡ºå½“å‰é˜»å¡å…¶ä»–çº¿ç¨‹çš„çº¿ç¨‹

æœ‰æ—¶å€™æˆ‘ä»¬å‘ç°åº”ç”¨å¡ä½äº†ï¼Œ é€šå¸¸æ˜¯ç”±äºæŸä¸ªçº¿ç¨‹æ‹¿ä½äº†æŸä¸ªé”ï¼Œ å¹¶ä¸”å…¶ä»–çº¿ç¨‹éƒ½åœ¨ç­‰å¾…è¿™æŠŠé”é€ æˆçš„ã€‚ ä¸ºäº†æ’æŸ¥è¿™ç±»é—®é¢˜ï¼Œ arthas æä¾›äº†thread -bï¼Œ ä¸€é”®æ‰¾å‡ºé‚£ä¸ªç½ªé­ç¥¸é¦–ã€‚
[arthas@5167]$ thread -bNo most blocking thread found!


thread -i, æŒ‡å®šé‡‡æ ·æ—¶é—´é—´éš”
thread -i 1000Â : ç»Ÿè®¡æœ€è¿‘ 1000ms å†…çš„çº¿ç¨‹ CPU æ—¶é—´ã€‚

[arthas@5167]$ thread -i 1000Threads Total: 32, NEW: 0, RUNNABLE: 14, BLOCKED: 0, WAITING: 2, TIMED_WAITING: 4, TERMINATED: 0, Internal threads: 12                                                                                                                                                        ID         NAME                                                                GROUP                             PRIORITY              STATE                  %CPU                  DELTA_TIME             TIME                  INTERRUPTED            DAEMON                -1         VM Periodic Task Thread                                             -                                 -1                    -                      0.08                  0.000                  0:29.457              false                  true                  -1         C1 CompilerThread0                                                  -                                 -1                    -                      0.04                  0.000                  0:6.510               false                  true                  24         arthas-command-execute                                              system                            5                     RUNNABLE               0.02                  0.000                  0:1.580               false                  true                  -1         G1 Young RemSet Sampling                                            -                                 -1                    -                      0.02                  0.000                  0:10.490              false                  true                  1          main                                                                main                              5                     TIMED_WAITING          0.01                  0.000                  0:9.671               false                  false                 -1         VM Thread                                                           -                                 -1                    -                      0.01                  0.000                  0:5.414               false                  true                  -1         GC Thread#1                                                         -                                 -1                    -                      0.01                  0.000                  0:3.250               false                  true                  -1         GC Thread#0                                                         -                                 -1                    -                      0.0                   0.000                  0:3.276               false                  true                  2          Reference Handler                                                   system                            10                    RUNNABLE               0.0                   0.000                  0:0.002               false                  true                  3          Finalizer                                                           system                            8                     WAITING                0.0                   0.000                  0:0.000               false                  true                  4          Signal Dispatcher                                                   system                            9                     RUNNABLE               0.0                   0.000                  0:0.003               false                  true                  11         Attach Listener                                                     system                            9                     RUNNABLE               0.0                   0.000                  0:0.119               false                  true                  13         arthas-timer                                                        system                            9                     WAITING                0.0                   0.000                  0:0.000               false                  true                  16         arthas-NettyHttpTelnetBootstrap-3-1                                 system                            5                     RUNNABLE               0.0                   0.000                  0:0.042               false                  true                  17         arthas-NettyWebsocketTtyBootstrap-4-1                               system                            5                     RUNNABLE               0.0                   0.000                  0:0.000               false                  true                  18         arthas-NettyWebsocketTtyBootstrap-4-2                               system                            5                     RUNNABLE               0.0                   0.000                  0:0.001               false                  true                  19         arthas-shell-server                                                 system                            9                     TIMED_WAITING          0.0                   0.000                  0:0.106               false                  true                  20         arthas-session-manager                                              system                            9                     TIMED_WAITING          0.0                   0.000                  0:0.072               false                  true                  22         arthas-NettyHttpTelnetBootstrap-3-2                                 system                            5                     RUNNABLE               0.0                   0.000                  0:0.337               false                  true                  23         arthas-NettyHttpTelnetBootstrap-3-3                                 system                            5                     RUNNABLE               0.0                   0.000                  0:0.029               false                  true                  25         arthas-NettyHttpTelnetBootstrap-3-4                                 system                            5                     RUNNABLE               0.0                   0.000                  0:0.025               false                  true                  26         arthas-NettyHttpTelnetBootstrap-3-5                                 system                            5                     RUNNABLE               0.0                   0.000                  0:0.027               false                  true                  27         arthas-NettyHttpTelnetBootstrap-3-6                                 system                            5                     RUNNABLE               0.0                   0.000                  0:0.572               false                  true                  33         arthas-NettyHttpTelnetBootstrap-3-7                                 system                            5                     RUNNABLE               0.0                   0.000                  0:0.022               false                  true                  34         arthas-NettyHttpTelnetBootstrap-3-8                                 system                            5                     RUNNABLE               0.0                   0.000                  0:0.674               false                  true                  10         Common-Cleaner                                                      InnocuousThreadGroup              8                     TIMED_WAITING          0.0                   0.000                  0:0.044               false                  true                  -1         Sweeper thread                                                      -                                 -1                    -                      0.0                   0.000                  0:0.008               false                  true                  -1         G1 Conc#0                                                           -                                 -1                    -                      0.0                   0.000                  0:0.066               false                  true                  -1         G1 Refine#0                                                         -                                 -1                    -                      0.0                   0.000                  0:0.005               false                  true                  -1         C2 CompilerThread0                                                  -                                 -1                    -                      0.0                   0.000                  0:15.009              false                  true                  -1         G1 Main Marker                                                      -                                 -1                    -                      0.0                   0.000                  0:0.001               false                  true                  -1         Service Thread                                                      -                                 -1                    -                      0.0                   0.000                  0:0.000               false                  true  


thread -n 3 -i 100Â : åˆ—å‡º 100ms å†…æœ€å¿™çš„ 3 ä¸ªçº¿ç¨‹æ ˆ

[arthas@5167]$ thread -n 3 -i 100&quot;arthas-command-execute&quot; Id=24 cpuUsage=0.26% deltaTime=0ms time=1585ms RUNNABLE    at java.management@11.0.16.1/sun.management.ThreadImpl.dumpThreads0(Native Method)    at java.management@11.0.16.1/sun.management.ThreadImpl.getThreadInfo(ThreadImpl.java:485)    at com.taobao.arthas.core.command.monitor200.ThreadCommand.processTopBusyThreads(ThreadCommand.java:206)    at com.taobao.arthas.core.command.monitor200.ThreadCommand.process(ThreadCommand.java:122)    at com.taobao.arthas.core.shell.command.impl.AnnotatedCommandImpl.process(AnnotatedCommandImpl.java:82)    at com.taobao.arthas.core.shell.command.impl.AnnotatedCommandImpl.access$100(AnnotatedCommandImpl.java:18)    at com.taobao.arthas.core.shell.command.impl.AnnotatedCommandImpl$ProcessHandler.handle(AnnotatedCommandImpl.java:111)    at com.taobao.arthas.core.shell.command.impl.AnnotatedCommandImpl$ProcessHandler.handle(AnnotatedCommandImpl.java:108)    at com.taobao.arthas.core.shell.system.impl.ProcessImpl$CommandProcessTask.run(ProcessImpl.java:385)    at java.base@11.0.16.1/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)    at java.base@11.0.16.1/java.util.concurrent.FutureTask.run(FutureTask.java:264)    at java.base@11.0.16.1/java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:304)    at java.base@11.0.16.1/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)    at java.base@11.0.16.1/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)    at java.base@11.0.16.1/java.lang.Thread.run(Thread.java:834)


thread â€“state ï¼ŒæŸ¥çœ‹æŒ‡å®šçŠ¶æ€çš„çº¿ç¨‹

[arthas@5167]$ thread --state WAITINGThreads Total: 20, NEW: 0, RUNNABLE: 14, BLOCKED: 0, WAITING: 2, TIMED_WAITING: 4, TERMINATED: 0                                                                                                                                                                              ID         NAME                                                                GROUP                             PRIORITY              STATE                  %CPU                  DELTA_TIME             TIME                  INTERRUPTED            DAEMON                3          Finalizer                                                           system                            8                     WAITING                0.0                   0.000                  0:0.000               false                  true                  13         arthas-timer                                                        system                            9                     WAITING                0.0                   0.000                  0:0.000               false                  true         

3. watch å‘½ä»¤é€šè¿‡watchå‘½ä»¤æ¥æŸ¥çœ‹demo.MathGame#primeFactorså‡½æ•°çš„è¿”å›å€¼ï¼š
 watch demo.MathGame primeFactors returnObj 

demo.MathGame å…¨ç±»å
primeFactors æ–¹æ³•å
è¿”å›å¯¹è±¡

[arthas@5167]$ watch demo.MathGame primeFactors returnObj Press Q or Ctrl+C to abort.Affect(class count: 1 , method count: 1) cost in 204 ms, listenerId: 1method=demo.MathGame.primeFactors location=AtExitts=2025-06-06 10:28:13.587; [cost=4.005634ms] result=@ArrayList[    @Integer[7],    @Integer[11],    @Integer[1301],]method=demo.MathGame.primeFactors location=AtExceptionExitts=2025-06-06 10:28:14.591; [cost=0.129017ms] result=nullmethod=demo.MathGame.primeFactors location=AtExitts=2025-06-06 10:28:15.602; [cost=8.688466ms] result=@ArrayList[    @Integer[2],    @Integer[3],    @Integer[12409],]method=demo.MathGame.primeFactors location=AtExitts=2025-06-06 10:28:16.606; [cost=0.057975ms] result=@ArrayList[    @Integer[2],    @Integer[2],    @Integer[5],    @Integer[23],    @Integer[173],

4.é€€å‡º arthaså¦‚æœåªæ˜¯é€€å‡ºå½“å‰çš„è¿æ¥ï¼Œå¯ä»¥ç”¨quitæˆ–è€…exitå‘½ä»¤ã€‚Attach åˆ°ç›®æ ‡è¿›ç¨‹ä¸Šçš„ arthas è¿˜ä¼šç»§ç»­è¿è¡Œï¼Œç«¯å£ä¼šä¿æŒå¼€æ”¾ï¼Œä¸‹æ¬¡è¿æ¥æ—¶å¯ä»¥ç›´æ¥è¿æ¥ä¸Šã€‚
å¦‚æœæƒ³å®Œå…¨é€€å‡º arthasï¼Œå¯ä»¥æ‰§è¡Œstopå‘½ä»¤ã€‚
5.å¸®åŠ©HelpæŸ¥çœ‹å‘½ä»¤å¸®åŠ©ä¿¡æ¯ï¼Œå¯ä»¥æŸ¥çœ‹å½“å‰ arthas ç‰ˆæœ¬æ”¯æŒçš„æŒ‡ä»¤ï¼Œæˆ–è€…æŸ¥çœ‹å…·ä½“æŒ‡ä»¤çš„ä½¿ç”¨è¯´æ˜ã€‚
[arthas@5167]$ help NAME         DESCRIPTION                                                                                                                                                                                                                                                      help         Display Arthas Help                                                                                                                                                                                                                                              auth         Authenticates the current session                                                                                                                                                                                                                                keymap       Display all the available keymap for the specified connection.                                                                                                                                                                                                   sc           Search all the classes loaded by JVM                                                                                                                                                                                                                             sm           Search the method of classes loaded by JVM                                                                                                                                                                                                                       classloader  Show classloader info                                                                                                                                                                                                                                            jad          Decompile class                                                                                                                                                                                                                                                  getstatic    Show the static field of a class                                                                                                                                                                                                                                 monitor      Monitor method execution statistics, e.g. total/success/failure count, average rt, fail rate, etc.                                                                                                                                                               stack        Display the stack trace for the specified class and method                                                                                                                                                                                                       thread       Display thread info, thread stack                                                                                                                                                                                                                                trace        Trace the execution time of specified method invocation.                                                                                                                                                                                                         watch        Display the input/output parameter, return object, and thrown exception of specified method invocation                                                                                                                                                           tt           Time Tunnel                                                                                                                                                                                                                                                      jvm          Display the target JVM information                                                                                                                                                                                                                               memory       Display jvm memory info.                                                                                                                                                                                                                                         perfcounter  Display the perf counter information.                                                                                                                                                                                                                            ognl         Execute ognl expression.                                                                                                                                                                                                                                         mc           Memory compiler, compiles java files into bytecode and class files in memory.                                                                                                                                                                                    redefine     Redefine classes. @see Instrumentation#redefineClasses(ClassDefinition...)                                                                                                                                                                                       retransform  Retransform classes. @see Instrumentation#retransformClasses(Class...)                                                                                                                                                                                           dashboard    Overview of target jvm&#x27;s thread, memory, gc, vm, tomcat info.                                                                                                                                                                                                    dump         Dump class byte array from JVM                                                                                                                                                                                                                                   heapdump     Heap dump                                                                                                                                                                                                                                                        options      View and change various Arthas options                                                                                                                                                                                                                           cls          Clear the screen                                                                                                                                                                                                                                                 reset        Reset all the enhanced classes                                                                                                                                                                                                                                   version      Display Arthas version                                                                                                                                                                                                                                           session      Display current session information                                                                                                                                                                                                                              sysprop      Display and change the system properties.                                                                                                                                                                                                                        sysenv       Display the system env.                                                                                                                                                                                                                                          vmoption     Display, and update the vm diagnostic options.                                                                                                                                                                                                                   logger       Print logger info, and update the logger level                                                                                                                                                                                                                   history      Display command history                                                                                                                                                                                                                                          cat          Concatenate and print files                                                                                                                                                                                                                                      base64       Encode and decode using Base64 representation                                                                                                                                                                                                                    echo         write arguments to the standard output                                                                                                                                                                                                                           pwd          Return working directory name                                                                                                                                                                                                                                    mbean        Display the mbean information                                                                                                                                                                                                                                    grep         grep command for pipes.                                                                                                                                                                                                                                          tee          tee command for pipes.                                                                                                                                                                                                                                           profiler     Async Profiler. https://github.com/jvm-profiling-tools/async-profiler                                                                                                                                                                                            vmtool       jvm tool                                                                                                                                                                                                                                                         stop         Stop/Shutdown Arthas server and exit the console.                                                                                                                                                                                                                jfr          Java Flight Recorder Command

6.groupåˆ†ç»„ç±»ä¼¼ä¼ ç»Ÿçš„grepå‘½ä»¤ã€‚

è¿‡æ»¤åŒ…å«javaå…³é”®çš„æ•°æ®

## è¿‡æ»¤åŒ…å«javaå…³é”®çš„æ•°æ®[arthas@5167]$ sysprop | grep java java.specification.version                            11 java.class.path                                       math-game.jar java.vm.vendor                                        Oracle Corporation java.vendor.url                                       https://openjdk.java.net/ java.vm.specification.version                         11 sun.java.launcher                                     SUN_STANDARD sun.java.command                                      math-game.jar java.specification.vendor                             Oracle Corporation java.version.date                                     2022-08-18 java.home                                             /usr/local/software/jdk-11.0.16.1 java.vm.compressedOopsMode                            32-bit java.specification.name                               Java Platform API Specification java.vm.specification.vendor                          Oracle Corporation java.awt.graphicsenv                                  sun.awt.X11GraphicsEnvironment java.runtime.version                                  11.0.16.1+1-LTS-1 java.runtime.name                                     Java(TM) SE Runtime Environment java.vm.name                                          Java HotSpot(TM) 64-Bit Server VM java.vendor.version                                   18.9 java.vendor.url.bug                                   https://bugreport.java.com/bugreport/ java.io.tmpdir                                        /tmp java.version                                          11.0.16.1 java.vm.specification.name                            Java Virtual Machine Specification java.awt.printerjob                                   sun.print.PSPrinterJob java.library.path                                     /usr/java/packages/lib:/usr/lib64:/lib64:/lib:/usr/lib java.vendor                                           Oracle Corporation java.vm.info                                          mixed mode java.vm.version                                       11.0.16.1+1-LTS-1 java.class.version                                    55.


è¿‡æ»¤åŒ…å«javaå…³é”®çš„æ•°æ®ï¼Œå¹¶æ˜¾ç¤ºå‡ºå¯¹åº”çš„è¡Œå·

[arthas@5167]$ sysprop | grep java -n4: java.specification.version                            117: java.class.path                                       math-game.jar8: java.vm.vendor                                        Oracle Corporation10: java.vendor.url                                       https://openjdk.java.net/13: java.vm.specification.version                         1114: sun.java.launcher                                     SUN_STANDARD17: sun.java.command                                      math-game.jar22: java.specification.vendor                             Oracle Corporation23: java.version.date                                     2022-08-1824: java.home                                             /usr/local/software/jdk-11.0.16.126: java.vm.compressedOopsMode                            32-bit28: java.specification.name                               Java Platform API Specification29: java.vm.specification.vendor                          Oracle Corporation30: java.awt.graphicsenv                                  sun.awt.X11GraphicsEnvironment32: java.runtime.version                                  11.0.16.1+1-LTS-136: java.runtime.name                                     Java(TM) SE Runtime Environment38: java.vm.name                                          Java HotSpot(TM) 64-Bit Server VM39: java.vendor.version                                   18.940: java.vendor.url.bug                                   https://bugreport.java.com/bugreport/41: java.io.tmpdir                                        /tmp42: java.version                                          11.0.16.145: java.vm.specification.name                            Java Virtual Machine Specification46: java.awt.printerjob                                   sun.print.PSPrinterJob48: java.library.path                                     /usr/java/packages/lib:/usr/lib64:/lib64:/lib:/usr/lib49: java.vendor                                           Oracle Corporation50: java.vm.info                                          mixed mode51: java.vm.version                                       11.0.16.1+1-LTS-153: java.class.version                                    55.0


è¿‡æ»¤ä¸åŒ…å«javaå…³é”®çš„æ•°æ®

[arthas@5167]$ sysenv | grep -v JAVA KEY                                                   VALUE                                                                                                                                                                                                                 ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ CLASSPATH                                             .:/usr/local/software/jdk-11.0.16.1/lib/dt.jar:/usr/local/software/jdk-11.0.16.1/lib/tools.jar HISTCONTROL                                           ignoredups HISTSIZE                                              1000 HOME                                                  /root HOSTNAME                                              localhost.localdomain LANG                                                  en_US.UTF-8 LESSOPEN                                              ||/usr/bin/lesspipe.sh %s LOGNAME                                               root LS_COLORS                                             rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=01;05;37;41:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;31:*.arj=01                                                       ;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:*.lzo=01;31:*.xz=01;31:*                                                       .bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*                                                       .cab=01;31:*.jpg=01;35:*.jpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01                                                       ;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.fl                                                       c=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.axv=01;35:*.anx=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=01;36:*.au=01;36:*.flac=01;36:*.mi                                                       d=01;36:*.midi=01;36:*.mka=01;36:*.mp3=01;36:*.mpc=01;36:*.ogg=01;36:*.ra=01;36:*.wav=01;36:*.axa=01;36:*.oga=01;36:*.spx=01;36:*.xspf=01;36: MAIL                                                  /var/spool/mail/root OLDPWD                                                /usr/local/software PATH                                                  /usr/local/software/jdk-11.0.16.1/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin PWD                                                   /usr/local/software/arthas SELINUX_LEVEL_REQUESTED SELINUX_ROLE_REQUESTED SELINUX_USE_CURRENT_RANGE SHELL                                                 /bin/bash SHLVL                                                 1 SSH_CLIENT                                            192.168.3.74 6122 22 SSH_CONNECTION                                        192.168.3.74 6122 192.168.3.125 22 SSH_TTY                                               /dev/pts/1 TERM                                                  xterm USER                                                  root XDG_RUNTIME_DIR                                       /run/user/0 XDG_SESSION_ID                                        5 _                                                     /usr/local/software/jdk-11.0.16.1/bin/java


ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤æ‰€éœ€è¦æ•°æ®

[arthas@5167]$ sysenv | grep -e &quot;(?i)(JAVA|sun)&quot; JAVA_HOME                                             /usr/local/software/jdk-11.0.16.1 _                                                     /usr/local/software/jdk-11.0.16.1/bin/java

7.å¿«æ·é”®æ˜ å°„è¡¨keymapkeymapå‘½ä»¤è¾“å‡ºå½“å‰çš„å¿«æ·é”®æ˜ å°„è¡¨ï¼š
[arthas@5167]$ keymap Shortcut                                                            Description                                                        Name                                                                                                                                  ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ &quot;\C-a&quot;                                                              Ctrl + a                                                            beginning-of-line                                                                                                                     &quot;\C-e&quot;                                                              Ctrl + e                                                            end-of-line                                                                                                                           &quot;\C-f&quot;                                                              Ctrl + f                                                            forward-word                                                                                                                          &quot;\C-b&quot;                                                              Ctrl + b                                                            backward-word                                                                                                                         &quot;\e[D&quot;                                                              Left arrow                                                          backward-char                                                                                                                         &quot;\e[C&quot;                                                              Right arrow                                                         forward-char                                                                                                                          &quot;\e[A&quot;                                                              Up arrow                                                            history-search-backward                                                                                                               &quot;\e[B&quot;                                                              Down arrow                                                          history-search-forward                                                                                                                &quot;\C-h&quot;                                                              Ctrl + h                                                            backward-delete-char                                                                                                                  &quot;\C-?&quot;                                                              Ctrl + ?                                                            backward-delete-char                                                                                                                  &quot;\C-u&quot;                                                              Ctrl + u                                                            undo                                                                                                                                  &quot;\C-d&quot;                                                              Ctrl + d                                                            delete-char                                                                                                                           &quot;\C-k&quot;                                                              Ctrl + k                                                            kill-line                                                                                                                             &quot;\C-i&quot;                                                              Ctrl + i                                                            complete                                                                                                                              &quot;\C-j&quot;                                                              Ctrl + j                                                            accept-line                                                                                                                           &quot;\C-m&quot;                                                              Ctrl + m                                                            accept-line                                                                                                                           &quot;\C-w&quot;                                                              Ctrl + w                                                            backward-delete-word                                                                                                                  &quot;\C-x\e[3~&quot;                                                         &quot;\C-x\e[3~&quot;                                                         backward-kill-line                                                                                                                    &quot;\e\C-?&quot;                                                            &quot;\e\C-?&quot;                                                            backward-kill-word                                                                                                                    &quot;\e[1~&quot;                                                             &quot;\e[1~&quot;                                                             beginning-of-line                                                                                                                     &quot;\e[4~&quot;                                                             &quot;\e[4~&quot;                                                             end-of-line                                                                                                                           &quot;\e[5~&quot;                                                             &quot;\e[5~&quot;                                                             beginning-of-history                                                                                                                  &quot;\e[6~&quot;                                                             &quot;\e[6~&quot;                                                             end-of-history                                                                                                                        &quot;\e[3~&quot;                                                             &quot;\e[3~&quot;                                                             delete-char                                                                                                                           &quot;\e[2~&quot;                                                             &quot;\e[2~&quot;                                                             quoted-insert                                                                                                                         &quot;\e[7~&quot;                                                             &quot;\e[7~&quot;                                                             beginning-of-line                                                                                                                     &quot;\e[8~&quot;                                                             &quot;\e[8~&quot;                                                             end-of-line                                                                                                                           &quot;\eOH&quot;                                                              &quot;\eOH&quot;                                                              beginning-of-line                                                                                                                     &quot;\eOF&quot;                                                              &quot;\eOF&quot;                                                              end-of-line                                                                                                                           &quot;\e[H&quot;                                                              &quot;\e[H&quot;                                                              beginning-of-line                                                                                                                     &quot;\e[F&quot;                                                              &quot;\e[F&quot;                                                              end-of-lin

é»˜è®¤çš„å¿«æ·é”®å¦‚ä¸‹ï¼š



å¿«æ·é”®
å¿«æ·é”®è¯´æ˜
å‘½ä»¤åç§°
å‘½ä»¤è¯´æ˜



&quot;\C-a&quot;
ctrl + a
beginning-of-line
è·³åˆ°è¡Œé¦–


&quot;\C-e&quot;
ctrl + e
end-of-line
è·³åˆ°è¡Œå°¾


&quot;\C-f&quot;
ctrl + f
forward-word
å‘å‰ç§»åŠ¨ä¸€ä¸ªå•è¯


&quot;\C-b&quot;
ctrl + b
backward-word
å‘åç§»åŠ¨ä¸€ä¸ªå•è¯


&quot;\e[D&quot;
é”®ç›˜å·¦æ–¹å‘é”®
backward-char
å…‰æ ‡å‘å‰ç§»åŠ¨ä¸€ä¸ªå­—ç¬¦


&quot;\e[C&quot;
é”®ç›˜å³æ–¹å‘é”®
forward-char
å…‰æ ‡å‘åç§»åŠ¨ä¸€ä¸ªå­—ç¬¦


&quot;\e[B&quot;
é”®ç›˜ä¸‹æ–¹å‘é”®
next-history
ä¸‹ç¿»æ˜¾ç¤ºä¸‹ä¸€ä¸ªå‘½ä»¤


&quot;\e[A&quot;
é”®ç›˜ä¸Šæ–¹å‘é”®
previous-history
ä¸Šç¿»æ˜¾ç¤ºä¸Šä¸€ä¸ªå‘½ä»¤


&quot;\C-h&quot;
ctrl + h
backward-delete-char
å‘ååˆ é™¤ä¸€ä¸ªå­—ç¬¦


&quot;\C-?&quot;
ctrl + shift + &#x2F;
backward-delete-char
å‘ååˆ é™¤ä¸€ä¸ªå­—ç¬¦


&quot;\C-u&quot;
ctrl + u
undo
æ’¤é”€ä¸Šä¸€ä¸ªå‘½ä»¤ï¼Œç›¸å½“äºæ¸…ç©ºå½“å‰è¡Œ


&quot;\C-d&quot;
ctrl + d
delete-char
åˆ é™¤å½“å‰å…‰æ ‡æ‰€åœ¨å­—ç¬¦


&quot;\C-k&quot;
ctrl + k
kill-line
åˆ é™¤å½“å‰å…‰æ ‡åˆ°è¡Œå°¾çš„æ‰€æœ‰å­—ç¬¦


&quot;\C-i&quot;
ctrl + i
complete
è‡ªåŠ¨è¡¥å…¨ï¼Œç›¸å½“äºæ•²TAB


&quot;\C-j&quot;
ctrl + j
accept-line
ç»“æŸå½“å‰è¡Œï¼Œç›¸å½“äºæ•²å›è½¦


&quot;\C-m&quot;
ctrl + m
accept-line
ç»“æŸå½“å‰è¡Œï¼Œç›¸å½“äºæ•²å›è½¦


&quot;\C-w&quot;

backward-delete-word



&quot;\C-x\e[3~&quot;

backward-kill-line



&quot;\e\C-?&quot;

backward-kill-word




ä»»ä½•æ—¶å€™Â tabÂ é”®ï¼Œä¼šæ ¹æ®å½“å‰çš„è¾“å…¥ç»™å‡ºæç¤º
å‘½ä»¤åæ•²Â Â æˆ–Â -Â ï¼Œç„¶åæŒ‰Â tabÂ é”®ï¼Œå¯ä»¥å±•ç¤ºå‡ºæ­¤å‘½ä»¤å…·ä½“çš„é€‰é¡¹

è‡ªå®šä¹‰å¿«æ·é”®
åœ¨å½“å‰ç”¨æˆ·ç›®å½•ä¸‹æ–°å»º$USER_HOME/.arthas/conf/inputrcæ–‡ä»¶ï¼ŒåŠ å…¥è‡ªå®šä¹‰é…ç½®ã€‚
å‡è®¾æˆ‘æ˜¯ vim çš„é‡åº¦ç”¨æˆ·ï¼Œæˆ‘è¦æŠŠctrl+hè®¾ç½®ä¸ºå…‰æ ‡å‘å‰ä¸€ä¸ªå­—ç¬¦ï¼Œåˆ™è®¾ç½®å¦‚ä¸‹ï¼Œé¦–å…ˆæ‹·è´é»˜è®¤é…ç½®
&quot;\C-a&quot;: beginning-of-line&quot;\C-e&quot;: end-of-line&quot;\C-f&quot;: forward-word&quot;\C-b&quot;: backward-word&quot;\e[D&quot;: backward-char&quot;\e[C&quot;: forward-char&quot;\e[B&quot;: next-history&quot;\e[A&quot;: previous-history&quot;\C-h&quot;: backward-delete-char&quot;\C-?&quot;: backward-delete-char&quot;\C-u&quot;: undo&quot;\C-d&quot;: delete-char&quot;\C-k&quot;: kill-line&quot;\C-i&quot;: complete&quot;\C-j&quot;: accept-line&quot;\C-m&quot;: accept-line&quot;\C-w&quot;: backward-delete-word&quot;\C-x\e[3~&quot;: backward-kill-line&quot;\e\C-?&quot;: backward-kill-word

ç„¶åæŠŠ&quot;\C-h&quot;: backward-delete-charæ¢æˆ&quot;\C-h&quot;: backward-charï¼Œç„¶åé‡æ–°è¿æ¥å³å¯ã€‚
åå°å¼‚æ­¥å‘½ä»¤ç›¸å…³å¿«æ·é”®

ctrl + c: ç»ˆæ­¢å½“å‰å‘½ä»¤
ctrl + z: æŒ‚èµ·å½“å‰å‘½ä»¤ï¼Œåç»­å¯ä»¥ bg&#x2F;fg é‡æ–°æ”¯æŒæ­¤å‘½ä»¤ï¼Œæˆ– kill æ‰
ctrl + a: å›åˆ°è¡Œé¦–
ctrl + e: å›åˆ°è¡Œå°¾

]]></content>
      <categories>
        <category>Arthas</category>
      </categories>
      <tags>
        <tag>Arthas</tag>
        <tag>Arthasè¯Šæ–­å·¥å…·</tag>
      </tags>
  </entry>
  <entry>
    <title>Arthasè¯Šæ–­å·¥å…·(äº”)Arthasï¼ˆé˜¿å°”è¨æ–¯ï¼‰monitor/watch/trace/stack/ttç›¸å…³å‘½ä»¤</title>
    <url>/Arthas%E5%BA%94%E7%94%A8(Java)%E8%AF%8A%E6%96%AD%E5%88%A9%E5%99%A8/Arthas%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7(%E4%BA%94)Arthas%EF%BC%88%E9%98%BF%E5%B0%94%E8%90%A8%E6%96%AF%EF%BC%89monitor%20watch%20trace%20stack/</url>
    <content><![CDATA[Arthasè¯Šæ–­å·¥å…·(äº”)Arthasï¼ˆé˜¿å°”è¨æ–¯ï¼‰monitor&#x2F;watch&#x2F;trace&#x2F;stack&#x2F;ttç›¸å…³å‘½ä»¤1. monitorå‘½ä»¤æ–¹æ³•æ‰§è¡Œç›‘æ§
å¯¹åŒ¹é…Â class-patternï¼method-patternï¼condition-expressçš„ç±»ã€æ–¹æ³•çš„è°ƒç”¨è¿›è¡Œç›‘æ§ã€‚
monitorÂ å‘½ä»¤æ˜¯ä¸€ä¸ªéå®æ—¶è¿”å›å‘½ä»¤.
å®æ—¶è¿”å›å‘½ä»¤æ˜¯è¾“å…¥ä¹‹åç«‹å³è¿”å›ï¼Œè€Œéå®æ—¶è¿”å›çš„å‘½ä»¤ï¼Œåˆ™æ˜¯ä¸æ–­çš„ç­‰å¾…ç›®æ ‡ Java è¿›ç¨‹è¿”å›ä¿¡æ¯ï¼Œç›´åˆ°ç”¨æˆ·è¾“å…¥Â Ctrl+CÂ ä¸ºæ­¢ã€‚
æœåŠ¡ç«¯æ˜¯ä»¥ä»»åŠ¡çš„å½¢å¼åœ¨åå°è·‘ä»»åŠ¡ï¼Œæ¤å…¥çš„ä»£ç éšç€ä»»åŠ¡çš„ä¸­æ­¢è€Œä¸ä¼šè¢«æ‰§è¡Œï¼Œæ‰€ä»¥ä»»åŠ¡å…³é—­åï¼Œä¸ä¼šå¯¹åŸæœ‰æ€§èƒ½äº§ç”Ÿå¤ªå¤§å½±å“ï¼Œè€Œä¸”åŸåˆ™ä¸Šï¼Œä»»ä½• Arthas å‘½ä»¤ä¸ä¼šå¼•èµ·åŸæœ‰ä¸šåŠ¡é€»è¾‘çš„æ”¹å˜ã€‚

å‚æ•°è¯´æ˜

æ–¹æ³•æ‹¥æœ‰ä¸€ä¸ªå‘½åå‚æ•°Â [c:]ï¼Œæ„æ€æ˜¯ç»Ÿè®¡å‘¨æœŸï¼ˆcycle of outputï¼‰ï¼Œæ‹¥æœ‰ä¸€ä¸ªæ•´å‹çš„å‚æ•°å€¼



å‚æ•°åç§°
å‚æ•°è¯´æ˜



class-pattern
ç±»åè¡¨è¾¾å¼åŒ¹é…


method-pattern
æ–¹æ³•åè¡¨è¾¾å¼åŒ¹é…


condition-express
æ¡ä»¶è¡¨è¾¾å¼


[E]
å¼€å¯æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œé»˜è®¤ä¸ºé€šé…ç¬¦åŒ¹é…


[c:]
ç»Ÿè®¡å‘¨æœŸï¼Œé»˜è®¤å€¼ä¸º 120 ç§’


[b]
åœ¨æ–¹æ³•è°ƒç”¨ä¹‹å‰è®¡ç®— condition-express


[m &lt;arg&gt;]
æŒ‡å®š Class æœ€å¤§åŒ¹é…æ•°é‡ï¼Œé»˜è®¤å€¼ä¸º 50ã€‚é•¿æ ¼å¼ä¸º[maxMatch &lt;arg&gt;]



ç›‘æ§çš„ç»´åº¦è¯´æ˜




ç›‘æ§é¡¹
è¯´æ˜



timestamp
æ—¶é—´æˆ³


class
Java ç±»


method
æ–¹æ³•ï¼ˆæ„é€ æ–¹æ³•ã€æ™®é€šæ–¹æ³•ï¼‰


total
è°ƒç”¨æ¬¡æ•°


success
æˆåŠŸæ¬¡æ•°


fail
å¤±è´¥æ¬¡æ•°


rt
å¹³å‡ RT


fail-rate
å¤±è´¥ç‡



ç›‘æ§demo.MathGame primeFactorsï¼Œæ¯5ç§’è¿”å›ä¸€ä¸ªç»“æœ

[arthas@8161]$ monitor demo.MathGame primeFactors -c 5Press Q or Ctrl+C to abort.Affect(class count: 1 , method count: 1) cost in 204 ms, listenerId: 1 timestamp                                 class                                                         method                                                        total                success              fail                avg-rt(ms)           fail-rate           ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ 2025-06-07 05:32:53.378                   demo.MathGame                                                 primeFactors                                                  5                    1                    4                   3.12                 80.00%               timestamp                                 class                                                         method                                                        total                success              fail                avg-rt(ms)           fail-rate           ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ 2025-06-07 05:32:58.441                   demo.MathGame                                                 primeFactors                                                  5                    0                    5                   0.17                 100.00%              timestamp                                 class                                                         method                                                        total                success              fail                avg-rt(ms)           fail-rate           ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ 2025-06-07 05:33:02.655                   demo.MathGame                                                 primeFactors                                                  4                    3                    1                   0.16                 25.00%               timestamp                                 class                                                         method                                                        total                success              fail                avg-rt(ms)           fail-rate           ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ 2025-06-07 05:33:07.664                   demo.MathGame                                                 primeFactors                                                  5                    2                    3                   0.96                 60.00%              

2. watchå‘½ä»¤å‡½æ•°æ‰§è¡Œæ•°æ®è§‚æµ‹
è®©ä½ èƒ½æ–¹ä¾¿çš„è§‚å¯Ÿåˆ°æŒ‡å®šå‡½æ•°çš„è°ƒç”¨æƒ…å†µã€‚èƒ½è§‚å¯Ÿåˆ°çš„èŒƒå›´ä¸ºï¼šè¿”å›å€¼ã€æŠ›å‡ºå¼‚å¸¸ã€å…¥å‚ï¼Œé€šè¿‡ç¼–å†™ OGNL è¡¨è¾¾å¼è¿›è¡Œå¯¹åº”å˜é‡çš„æŸ¥çœ‹ã€‚

å‚æ•°è¯´æ˜

watch çš„å‚æ•°æ¯”è¾ƒå¤šï¼Œä¸»è¦æ˜¯å› ä¸ºå®ƒèƒ½åœ¨ 4 ä¸ªä¸åŒçš„åœºæ™¯è§‚å¯Ÿå¯¹è±¡



å‚æ•°åç§°
å‚æ•°è¯´æ˜



class-pattern
ç±»åè¡¨è¾¾å¼åŒ¹é…


method-pattern
å‡½æ•°åè¡¨è¾¾å¼åŒ¹é…


express
è§‚å¯Ÿè¡¨è¾¾å¼ï¼Œé»˜è®¤å€¼ï¼š&#123;params, target, returnObj&#125;


condition-express
æ¡ä»¶è¡¨è¾¾å¼


[b]
åœ¨å‡½æ•°è°ƒç”¨ä¹‹å‰è§‚å¯Ÿ


[e]
åœ¨å‡½æ•°å¼‚å¸¸ä¹‹åè§‚å¯Ÿ


[s]
åœ¨å‡½æ•°è¿”å›ä¹‹åè§‚å¯Ÿ


[f]
åœ¨å‡½æ•°ç»“æŸä¹‹å(æ­£å¸¸è¿”å›å’Œå¼‚å¸¸è¿”å›)è§‚å¯Ÿ


[E]
å¼€å¯æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œé»˜è®¤ä¸ºé€šé…ç¬¦åŒ¹é…


[x:]
æŒ‡å®šè¾“å‡ºç»“æœçš„å±æ€§éå†æ·±åº¦ï¼Œé»˜è®¤ä¸º 1ï¼Œæœ€å¤§å€¼æ˜¯ 4


[m &lt;arg&gt;]
æŒ‡å®š Class æœ€å¤§åŒ¹é…æ•°é‡ï¼Œé»˜è®¤å€¼ä¸º 50ã€‚é•¿æ ¼å¼ä¸º[maxMatch &lt;arg&gt;]ã€‚


è¿™é‡Œé‡ç‚¹è¦è¯´æ˜çš„æ˜¯è§‚å¯Ÿè¡¨è¾¾å¼ï¼Œè§‚å¯Ÿè¡¨è¾¾å¼çš„æ„æˆä¸»è¦ç”± ognl è¡¨è¾¾å¼ç»„æˆï¼Œæ‰€ä»¥ä½ å¯ä»¥è¿™æ ·å†™&quot;&#123;params,returnObj&#125;&quot;ï¼Œåªè¦æ˜¯ä¸€ä¸ªåˆæ³•çš„ ognl è¡¨è¾¾å¼ï¼Œéƒ½èƒ½è¢«æ­£å¸¸æ”¯æŒã€‚
è§‚å¯Ÿçš„ç»´åº¦ä¹Ÿæ¯”è¾ƒå¤šï¼Œä¸»è¦ä½“ç°åœ¨å‚æ•°Â adviceÂ çš„æ•°æ®ç»“æ„ä¸Šã€‚AdviceÂ å‚æ•°æœ€ä¸»è¦æ˜¯å°è£…äº†é€šçŸ¥èŠ‚ç‚¹çš„æ‰€æœ‰ä¿¡æ¯ã€‚è¯·å‚è€ƒè¡¨è¾¾å¼æ ¸å¿ƒå˜é‡ä¸­å…³äºè¯¥èŠ‚ç‚¹çš„æè¿°ã€‚

ç‰¹æ®Šç”¨æ³•è¯·å‚è€ƒï¼šhttps://github.com/alibaba/arthas/issues/71
OGNL è¡¨è¾¾å¼å®˜ç½‘ï¼šhttps://commons.apache.org/dormant/commons-ognl/language-guide.html

ç‰¹åˆ«è¯´æ˜ï¼š

watch å‘½ä»¤å®šä¹‰äº† 4 ä¸ªè§‚å¯Ÿäº‹ä»¶ç‚¹ï¼Œå³Â bÂ å‡½æ•°è°ƒç”¨å‰ï¼ŒeÂ å‡½æ•°å¼‚å¸¸åï¼ŒsÂ å‡½æ•°è¿”å›åï¼ŒfÂ å‡½æ•°ç»“æŸå
4 ä¸ªè§‚å¯Ÿäº‹ä»¶ç‚¹Â bã€eã€sÂ é»˜è®¤å…³é—­ï¼ŒfÂ é»˜è®¤æ‰“å¼€ï¼Œå½“æŒ‡å®šè§‚å¯Ÿç‚¹è¢«æ‰“å¼€åï¼Œåœ¨ç›¸åº”äº‹ä»¶ç‚¹ä¼šå¯¹è§‚å¯Ÿè¡¨è¾¾å¼è¿›è¡Œæ±‚å€¼å¹¶è¾“å‡º
è¿™é‡Œè¦æ³¨æ„å‡½æ•°å…¥å‚å’Œå‡½æ•°å‡ºå‚çš„åŒºåˆ«ï¼Œæœ‰å¯èƒ½åœ¨ä¸­é—´è¢«ä¿®æ”¹å¯¼è‡´å‰åä¸ä¸€è‡´ï¼Œé™¤äº†Â bÂ äº‹ä»¶ç‚¹Â paramsÂ ä»£è¡¨å‡½æ•°å…¥å‚å¤–ï¼Œå…¶ä½™äº‹ä»¶éƒ½ä»£è¡¨å‡½æ•°å‡ºå‚
å½“ä½¿ç”¨Â bÂ æ—¶ï¼Œç”±äºè§‚å¯Ÿäº‹ä»¶ç‚¹æ˜¯åœ¨å‡½æ•°è°ƒç”¨å‰ï¼Œæ­¤æ—¶è¿”å›å€¼æˆ–å¼‚å¸¸å‡ä¸å­˜åœ¨
åœ¨ watch å‘½ä»¤çš„ç»“æœé‡Œï¼Œä¼šæ‰“å°å‡ºlocationä¿¡æ¯ã€‚locationæœ‰ä¸‰ç§å¯èƒ½å€¼ï¼šAtEnterï¼ŒAtExitï¼ŒAtExceptionExitã€‚å¯¹åº”å‡½æ•°å…¥å£ï¼Œå‡½æ•°æ­£å¸¸ returnï¼Œå‡½æ•°æŠ›å‡ºå¼‚å¸¸ã€‚

2.1 è§‚å¯Ÿå‡½æ•°è°ƒç”¨è¿”å›æ—¶çš„å‚æ•°ã€this å¯¹è±¡å’Œè¿”å›å€¼è§‚å¯Ÿè¡¨è¾¾å¼ï¼Œé»˜è®¤å€¼æ˜¯&#123;params, target, returnObj&#125;
[arthas@8161]$ watch demo.MathGame primeFactors -x 2Press Q or Ctrl+C to abort.Affect(class count: 1 , method count: 1) cost in 73 ms, listenerId: 2method=demo.MathGame.primeFactors location=AtExceptionExitts=2025-06-07 05:51:10.663; [cost=1.015159ms] result=@ArrayList[    @Object[][        @Integer[-93162],    ],    @MathGame[        random=@Random[java.util.Random@51efea79],        illegalArgumentCount=@Integer[2327],    ],    null,]method=demo.MathGame.primeFactors location=AtExitts=2025-06-07 05:48:55.377; [cost=0.064295ms] result=@ArrayList[    @Object[][        @Integer[1],    ],    @MathGame[        random=@Random[java.util.Random@51efea79],        illegalArgumentCount=@Integer[2256],    ],    @ArrayList[        @Integer[2],        @Integer[2],        @Integer[2],        @Integer[2],        @Integer[2],        @Integer[2],        @Integer[2],        @Integer[3],        @Integer[13],        @Integer[41],    ],


ä¸Šé¢çš„ç»“æœé‡Œï¼Œè¯´æ˜å‡½æ•°è¢«æ‰§è¡Œäº†ä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡ç»“æœæ˜¯location=AtExceptionExitï¼Œè¯´æ˜å‡½æ•°æŠ›å‡ºå¼‚å¸¸äº†ï¼Œå› æ­¤returnObjæ˜¯ null
åœ¨ç¬¬äºŒæ¬¡ç»“æœé‡Œæ˜¯location=AtExitï¼Œè¯´æ˜å‡½æ•°æ­£å¸¸è¿”å›ï¼Œå› æ­¤å¯ä»¥çœ‹åˆ°returnObjç»“æœæ˜¯ä¸€ä¸ª ArrayList

2.2 è°ƒæ•´-xçš„å€¼ï¼Œè§‚å¯Ÿå…·ä½“çš„å‡½æ•°å‚æ•°å€¼[arthas@8161]$ watch demo.MathGame primeFactors &quot;&#123;params,target&#125;&quot; -x 3Press Q or Ctrl+C to abort.Affect(class count: 1 , method count: 1) cost in 69 ms, listenerId: 4method=demo.MathGame.primeFactors location=AtExceptionExitts=2025-06-07 05:52:36.258; [cost=0.313869ms] result=@ArrayList[    @Object[][        @Integer[-162367],    ],    @MathGame[        random=@Random[            serialVersionUID=@Long[3905348978240129619],            seed=@AtomicLong[175065596875740],            multiplier=@Long[25214903917],            addend=@Long[11],            mask=@Long[281474976710655],            DOUBLE_UNIT=@Double[1.1102230246251565E-16],            BadBound=@String[bound must be positive],            BadRange=@String[bound must be greater than origin],            BadSize=@String[size must be non-negative],            seedUniquifier=@AtomicLong[-2942033378085796212],            nextNextGaussian=@Double[0.0],            haveNextNextGaussian=@Boolean[false],            serialPersistentFields=@ObjectStreamField[][isEmpty=false;size=3],            unsafe=@Unsafe[jdk.internal.misc.Unsafe@5419f379],            seedOffset=@Long[24],        ],        illegalArgumentCount=@Integer[2371],    ],]method=demo.MathGame.primeFactors location=AtExitts=2025-06-07 05:52:37.298; [cost=0.214619ms] result=@ArrayList[    @Object[][        @Integer[1],    ],    @MathGame[        random=@Random[            serialVersionUID=@Long[3905348978240129619],            seed=@AtomicLong[102106958650551],            multiplier=@Long[25214903917],            addend=@Long[11],            mask=@Long[281474976710655],            DOUBLE_UNIT=@Double[1.1102230246251565E-16],            BadBound=@String[bound must be positive],            BadRange=@String[bound must be greater than origin],            BadSize=@String[size must be non-negative],            seedUniquifier=@AtomicLong[-2942033378085796212],            nextNextGaussian=@Double[0.0],            haveNextNextGaussian=@Boolean[false],            serialPersistentFields=@ObjectStreamField[][isEmpty=false;size=3],            unsafe=@Unsafe[jdk.internal.misc.Unsafe@5419f379],            seedOffset=@Long[24],        ],        illegalArgumentCount=@Integer[2371],    ],]

2.3 æ¡ä»¶è¡¨è¾¾å¼çš„ä¾‹å­
åªæœ‰æ»¡è¶³æ¡ä»¶çš„è°ƒç”¨ï¼Œæ‰ä¼šæœ‰å“åº”ã€‚

[arthas@8161]$ watch demo.MathGame primeFactors &quot;&#123;params[0],target&#125;&quot; &quot;params[0]&lt;0&quot;Press Q or Ctrl+C to abort.Affect(class count: 1 , method count: 1) cost in 70 ms, listenerId: 5method=demo.MathGame.primeFactors location=AtExceptionExitts=2025-06-07 05:57:45.251; [cost=0.640813ms] result=@ArrayList[    @Integer[-152032],    @MathGame[demo.MathGame@589838eb],]method=demo.MathGame.primeFactors location=AtExceptionExitts=2025-06-07 05:57:49.265; [cost=0.09171ms] result=@ArrayList[    @Integer[-106952],    @MathGame[demo.MathGame@589838eb],]method=demo.MathGame.primeFactors location=AtExceptionExitts=2025-06-07 05:57:50.271; [cost=0.058582ms] result=@ArrayList[    @Integer[-181262],    @MathGame[demo.MathGame@589838eb],]

3. traceå‘½ä»¤æ–¹æ³•å†…éƒ¨è°ƒç”¨è·¯å¾„ï¼Œå¹¶è¾“å‡ºæ–¹æ³•è·¯å¾„ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šè€—æ—¶
traceÂ å‘½ä»¤èƒ½ä¸»åŠ¨æœç´¢Â class-patternï¼method-patternÂ å¯¹åº”çš„æ–¹æ³•è°ƒç”¨è·¯å¾„ï¼Œæ¸²æŸ“å’Œç»Ÿè®¡æ•´ä¸ªè°ƒç”¨é“¾è·¯ä¸Šçš„æ‰€æœ‰æ€§èƒ½å¼€é”€å’Œè¿½è¸ªè°ƒç”¨é“¾è·¯ã€‚

å‚æ•°è¯´æ˜




å‚æ•°åç§°
å‚æ•°è¯´æ˜



class-pattern
ç±»åè¡¨è¾¾å¼åŒ¹é…


method-pattern
æ–¹æ³•åè¡¨è¾¾å¼åŒ¹é…


condition-express
æ¡ä»¶è¡¨è¾¾å¼


[E]
å¼€å¯æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œé»˜è®¤ä¸ºé€šé…ç¬¦åŒ¹é…


[n:]
å‘½ä»¤æ‰§è¡Œæ¬¡æ•°ï¼Œé»˜è®¤å€¼ä¸º 100ã€‚


#cost
æ–¹æ³•æ‰§è¡Œè€—æ—¶ï¼Œå•ä½æ¯«ç§’


[m &lt;arg&gt;]
æŒ‡å®š Class æœ€å¤§åŒ¹é…æ•°é‡ï¼Œé»˜è®¤å€¼ä¸º 50ã€‚é•¿æ ¼å¼ä¸º[maxMatch &lt;arg&gt;]ã€‚


è¿™é‡Œé‡ç‚¹è¦è¯´æ˜çš„æ˜¯æ¡ä»¶è¡¨è¾¾å¼ï¼Œæ¡ä»¶è¡¨è¾¾å¼çš„æ„æˆä¸»è¦ç”± ognl è¡¨è¾¾å¼ç»„æˆï¼Œæ‰€ä»¥ä½ å¯ä»¥è¿™æ ·å†™&quot;params[0]&lt;0&quot;ï¼Œåªè¦æ˜¯ä¸€ä¸ªåˆæ³•çš„ ognl è¡¨è¾¾å¼ï¼Œéƒ½èƒ½è¢«æ­£å¸¸æ”¯æŒã€‚
è¯·å‚è€ƒè¡¨è¾¾å¼æ ¸å¿ƒå˜é‡ä¸­å…³äºè¯¥èŠ‚ç‚¹çš„æè¿°ã€‚

ç‰¹æ®Šç”¨æ³•è¯·å‚è€ƒï¼šhttps://github.com/alibaba/arthas/issues/71
OGNL è¡¨è¾¾å¼å®˜ç½‘ï¼šhttps://commons.apache.org/dormant/commons-ognl/language-guide.html

å¾ˆå¤šæ—¶å€™æˆ‘ä»¬åªæƒ³çœ‹åˆ°æŸä¸ªæ–¹æ³•çš„ rt å¤§äºæŸä¸ªæ—¶é—´ä¹‹åçš„ trace ç»“æœï¼Œç°åœ¨ Arthas å¯ä»¥æŒ‰ç…§æ–¹æ³•æ‰§è¡Œçš„è€—æ—¶æ¥è¿›è¡Œè¿‡æ»¤äº†ï¼Œä¾‹å¦‚trace *StringUtils isBlank &#39;#cost&gt;100&#39;è¡¨ç¤ºå½“æ‰§è¡Œæ—¶é—´è¶…è¿‡ 100ms çš„æ—¶å€™ï¼Œæ‰ä¼šè¾“å‡º trace çš„ç»“æœã€‚
watch&#x2F;stack&#x2F;trace è¿™ä¸ªä¸‰ä¸ªå‘½ä»¤éƒ½æ”¯æŒ#cost

ğŸ’¡


æ³¨æ„äº‹é¡¹
traceÂ èƒ½æ–¹ä¾¿çš„å¸®åŠ©ä½ å®šä½å’Œå‘ç°å›  RT é«˜è€Œå¯¼è‡´çš„æ€§èƒ½é—®é¢˜ç¼ºé™·ï¼Œä½†å…¶æ¯æ¬¡åªèƒ½è·Ÿè¸ªä¸€çº§æ–¹æ³•çš„è°ƒç”¨é“¾è·¯ã€‚
 å‚è€ƒï¼šTrace å‘½ä»¤çš„å®ç°åŸç†åœ¨æ–°çª—å£æ‰“å¼€

3.3.0 ç‰ˆæœ¬åï¼Œå¯ä»¥ä½¿ç”¨åŠ¨æ€ Trace åŠŸèƒ½ï¼Œä¸æ–­å¢åŠ æ–°çš„åŒ¹é…ç±»ï¼Œå‚è€ƒä¸‹é¢çš„ç¤ºä¾‹ã€‚

ç›®å‰ä¸æ”¯æŒÂ trace java.lang.Thread getNameï¼Œå‚è€ƒ issue:Â #1610åœ¨æ–°çª—å£æ‰“å¼€Â ï¼Œè€ƒè™‘åˆ°ä¸æ˜¯éå¸¸å¿…è¦åœºæ™¯ï¼Œä¸”ä¿®å¤æœ‰ä¸€å®šéš¾åº¦ï¼Œå› æ­¤å½“å‰æš‚ä¸ä¿®å¤






3.1 traceä¸å¸¦å‚æ•°å‘½ä»¤[arthas@8161]$ trace demo.MathGame runPress Q or Ctrl+C to abort.Affect(class count: 1 , method count: 1) cost in 100 ms, listenerId: 6`---ts=2025-06-07 06:02:53.872;thread_name=main;id=1;is_daemon=false;priority=5;TCCL=jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c    `---[1.431047ms] demo.MathGame:run()        +---[17.69% 0.25315ms ] demo.MathGame:primeFactors() #24        `---[38.56% 0.551755ms ] demo.MathGame:print() #25`---ts=2025-06-07 06:02:54.895;thread_name=main;id=1;is_daemon=false;priority=5;TCCL=jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c    `---[0.421141ms] demo.MathGame:run()        `---[42.03% 0.177003ms ] demo.MathGame:primeFactors() #24 [throws Exception]`---ts=2025-06-07 06:02:55.897;thread_name=main;id=1;is_daemon=false;priority=5;TCCL=jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c    `---[0.108631ms] demo.MathGame:run()        +---[21.72% 0.023592ms ] demo.MathGame:primeFactors() #24        `---[49.07% 0.053301ms ] demo.MathGame:print() #25

ç»“æœé‡Œçš„Â #24ï¼Œè¡¨ç¤ºåœ¨ run å‡½æ•°é‡Œï¼Œåœ¨æºæ–‡ä»¶çš„ç¬¬24è¡Œè°ƒç”¨äº†primeFactors()å‡½æ•°ã€‚
3.2 traceå¸¦å‚æ•°å‘½ä»¤
-skipJDKMethod &lt;value&gt;Â skip jdk method trace, default value true.

é»˜è®¤æƒ…å†µä¸‹ï¼Œtrace ä¸ä¼šåŒ…å« jdk é‡Œçš„å‡½æ•°è°ƒç”¨ï¼Œå¦‚æœå¸Œæœ› trace jdk é‡Œçš„å‡½æ•°ï¼Œéœ€è¦æ˜¾å¼è®¾ç½®--skipJDKMethod falseã€‚

å¦‚æœæ–¹æ³•è°ƒç”¨çš„æ¬¡æ•°å¾ˆå¤šï¼Œé‚£ä¹ˆå¯ä»¥ç”¨-nå‚æ•°æŒ‡å®šæ•æ‰ç»“æœçš„æ¬¡æ•°ã€‚æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­é‡Œï¼Œæ•æ‰åˆ°ä¸€æ¬¡è°ƒç”¨å°±é€€å‡ºå‘½ä»¤ã€‚

[arthas@8161]$ trace --skipJDKMethod false demo.MathGame run -n 3Press Q or Ctrl+C to abort.Affect(class count: 1 , method count: 1) cost in 108 ms, listenerId: 9`---ts=2025-06-07 09:33:22.964;thread_name=main;id=1;is_daemon=false;priority=5;TCCL=jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c    +---[0.040626ms] java.util.Random:nextInt() #23    +---[0.152629ms] demo.MathGame:primeFactors() #24    +---[0.032551ms] demo.MathGame:print() #25    `---[3.440639ms] demo.MathGame:run()        +---[9.98% 0.343288ms ] java.util.Random:nextInt() #23        +---[17.64% 0.607089ms ] demo.MathGame:primeFactors() #24 [throws Exception]        +---[0.64% 0.021935ms ] java.lang.StringBuilder:&lt;init&gt;() #28        +---[7.40% 0.254695ms ] java.lang.String:format() #28        +---[1.37% min=0.01411ms,max=0.03298ms,total=0.04709ms,count=2] java.lang.StringBuilder:append() #28        +---[1.20% 0.041169ms ] java.lang.Exception:getMessage() #28        +---[0.64% 0.022185ms ] java.lang.StringBuilder:toString() #28        `---[16.69% 0.574324ms ] java.io.PrintStream:println() #28`---ts=2025-06-07 09:33:25.119;thread_name=main;id=1;is_daemon=false;priority=5;TCCL=jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c    `---[1.504503ms] demo.MathGame:run()        +---[1.70% 0.025535ms ] java.util.Random:nextInt() #23        +---[5.34% 0.080385ms ] demo.MathGame:primeFactors() #24 [throws Exception]        +---[0.97% 0.01455ms ] java.lang.StringBuilder:&lt;init&gt;() #28        +---[3.14% 0.04719ms ] java.lang.String:format() #28        +---[1.90% min=0.014215ms,max=0.01436ms,total=0.028575ms,count=2] java.lang.StringBuilder:append() #28        +---[7.98% 0.12012ms ] java.lang.Exception:getMessage() #28        +---[0.88% 0.013255ms ] java.lang.StringBuilder:toString() #28        `---[25.35% 0.381384ms ] java.io.PrintStream:println() #28`---ts=2025-06-07 09:33:26.136;thread_name=main;id=1;is_daemon=false;priority=5;TCCL=jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c    `---[0.357443ms] demo.MathGame:run()        +---[2.92% 0.01043ms ] java.util.Random:nextInt() #23        +---[12.37% 0.044215ms ] demo.MathGame:primeFactors() #24 [throws Exception]        +---[1.46% 0.00521ms ] java.lang.StringBuilder:&lt;init&gt;() #28        +---[9.13% 0.032649ms ] java.lang.String:format() #28        +---[2.90% min=0.004825ms,max=0.00555ms,total=0.010375ms,count=2] java.lang.StringBuilder:append() #28        +---[1.49% 0.00532ms ] java.lang.Exception:getMessage() #28        +---[1.34% 0.004785ms ] java.lang.StringBuilder:toString() #28        `---[18.75% 0.067035ms ] java.io.PrintStream:println() #28Command execution times exceed limit: 3, so command will exit. You can set it with -n option.

3.3 æ ¹æ®è°ƒç”¨è€—æ—¶è¿‡æ»¤åªä¼šå±•ç¤ºè€—æ—¶å¤§äº 2ms çš„è°ƒç”¨è·¯å¾„ï¼Œæœ‰åŠ©äºåœ¨æ’æŸ¥é—®é¢˜çš„æ—¶å€™ï¼Œåªå…³æ³¨å¼‚å¸¸æƒ…å†µ

ğŸ’¡


æ˜¯ä¸æ˜¯å¾ˆçœ¼ç†Ÿï¼Œæ²¡é”™ï¼Œåœ¨ JProfiler ç­‰æ”¶è´¹è½¯ä»¶ä¸­ä½ æ›¾ç»è§è¯†ç±»ä¼¼çš„åŠŸèƒ½ï¼Œè¿™é‡Œä½ å°†å¯ä»¥é€šè¿‡å‘½ä»¤å°±èƒ½æ‰“å°å‡ºæŒ‡å®šè°ƒç”¨è·¯å¾„ã€‚ å‹æƒ…æé†’ä¸‹ï¼ŒtraceÂ åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­æœ¬èº«æ˜¯ä¼šæœ‰ä¸€å®šçš„æ€§èƒ½å¼€é”€ï¼Œåœ¨ç»Ÿè®¡çš„æŠ¥å‘Šä¸­å¹¶æœªåƒ JProfiler ä¸€æ ·é¢„å…ˆå‡å»å…¶è‡ªèº«çš„ç»Ÿè®¡å¼€é”€ã€‚æ‰€ä»¥è¿™ç»Ÿè®¡å‡ºæ¥æœ‰äº›è®¸çš„ä¸å‡†ï¼Œæ¸²æŸ“è·¯å¾„ä¸Šè°ƒç”¨çš„ç±»ã€æ–¹æ³•è¶Šå¤šï¼Œæ€§èƒ½åå·®è¶Šå¤§ã€‚ä½†è¿˜æ˜¯èƒ½è®©ä½ çœ‹æ¸…ä¸€äº›äº‹æƒ…çš„ã€‚
[12.033735ms] çš„å«ä¹‰ï¼Œ12.033735Â çš„å«ä¹‰æ˜¯ï¼šå½“å‰èŠ‚ç‚¹åœ¨å½“å‰æ­¥éª¤çš„è€—æ—¶ï¼Œå•ä½ä¸ºæ¯«ç§’
[0,0,0ms,11]xxx:yyy() [throws Exception]ï¼Œå¯¹è¯¥æ–¹æ³•ä¸­ç›¸åŒçš„æ–¹æ³•è°ƒç”¨è¿›è¡Œäº†åˆå¹¶ï¼Œ0,0,0ms,11Â è¡¨ç¤ºæ–¹æ³•è°ƒç”¨è€—æ—¶ï¼Œmin,max,total,countï¼›throws ExceptionÂ è¡¨æ˜è¯¥æ–¹æ³•è°ƒç”¨ä¸­å­˜åœ¨å¼‚å¸¸è¿”å›
è¿™é‡Œå­˜åœ¨ä¸€ä¸ªç»Ÿè®¡ä¸å‡†ç¡®çš„é—®é¢˜ï¼Œå°±æ˜¯æ‰€æœ‰æ–¹æ³•è€—æ—¶åŠ èµ·æ¥å¯èƒ½ä¼šå°äºè¯¥ç›‘æµ‹æ–¹æ³•çš„æ€»è€—æ—¶ï¼Œè¿™ä¸ªæ˜¯ç”±äº Arthas æœ¬èº«çš„é€»è¾‘ä¼šæœ‰ä¸€å®šçš„è€—æ—¶

[arthas@8161]$ trace demo.MathGame run &#x27;#cost &gt; 0.5&#x27; -n 3Press Q or Ctrl+C to abort.Affect(class count: 1 , method count: 1) cost in 87 ms, listenerId: 12`---ts=2025-06-07 09:36:31.428;thread_name=main;id=1;is_daemon=false;priority=5;TCCL=jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c    `---[0.575073ms] demo.MathGame:run()        `---[56.12% 0.322722ms ] demo.MathGame:primeFactors() #24 [throws Exception]`---ts=2025-06-07 09:36:33.467;thread_name=main;id=1;is_daemon=false;priority=5;TCCL=jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c    `---[2.125056ms] demo.MathGame:run()        +---[65.45% 1.390877ms ] demo.MathGame:primeFactors() #24        `---[23.98% 0.509524ms ] demo.MathGame:print() #25`---ts=2025-06-07 09:36:37.491;thread_name=main;id=1;is_daemon=false;priority=5;TCCL=jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c    `---[7.300126ms] demo.MathGame:run()        +---[99.21% 7.242667ms ] demo.MathGame:primeFactors() #24        `---[0.44% 0.031904ms ] demo.MathGame:print() #25

4. stackå‘½ä»¤è¾“å‡ºå½“å‰æ–¹æ³•è¢«è°ƒç”¨çš„è°ƒç”¨è·¯å¾„
å¾ˆå¤šæ—¶å€™æˆ‘ä»¬éƒ½çŸ¥é“ä¸€ä¸ªæ–¹æ³•è¢«æ‰§è¡Œï¼Œä½†è¿™ä¸ªæ–¹æ³•è¢«æ‰§è¡Œçš„è·¯å¾„éå¸¸å¤šï¼Œæˆ–è€…ä½ æ ¹æœ¬å°±ä¸çŸ¥é“è¿™ä¸ªæ–¹æ³•æ˜¯ä»é‚£é‡Œè¢«æ‰§è¡Œäº†ï¼Œæ­¤æ—¶ä½ éœ€è¦çš„æ˜¯ stack å‘½ä»¤ã€‚

å‚æ•°è¯´æ˜




å‚æ•°åç§°
å‚æ•°è¯´æ˜



class-pattern
ç±»åè¡¨è¾¾å¼åŒ¹é…


method-pattern
æ–¹æ³•åè¡¨è¾¾å¼åŒ¹é…


condition-express
æ¡ä»¶è¡¨è¾¾å¼


[E]
å¼€å¯æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œé»˜è®¤ä¸ºé€šé…ç¬¦åŒ¹é…


[n:]
æ‰§è¡Œæ¬¡æ•°é™åˆ¶


[m &lt;arg&gt;]
æŒ‡å®š Class æœ€å¤§åŒ¹é…æ•°é‡ï¼Œé»˜è®¤å€¼ä¸º 50ã€‚é•¿æ ¼å¼ä¸º[maxMatch &lt;arg&gt;]ã€‚



ğŸ’¡

è¿™é‡Œé‡ç‚¹è¦è¯´æ˜çš„æ˜¯è§‚å¯Ÿè¡¨è¾¾å¼ï¼Œè§‚å¯Ÿè¡¨è¾¾å¼çš„æ„æˆä¸»è¦ç”± ognl è¡¨è¾¾å¼ç»„æˆï¼Œæ‰€ä»¥ä½ å¯ä»¥è¿™æ ·å†™&quot;&#123;params,returnObj&#125;&quot;ï¼Œåªè¦æ˜¯ä¸€ä¸ªåˆæ³•çš„ ognl è¡¨è¾¾å¼ï¼Œéƒ½èƒ½è¢«æ­£å¸¸æ”¯æŒã€‚
è§‚å¯Ÿçš„ç»´åº¦ä¹Ÿæ¯”è¾ƒå¤šï¼Œä¸»è¦ä½“ç°åœ¨å‚æ•°Â adviceÂ çš„æ•°æ®ç»“æ„ä¸Šã€‚AdviceÂ å‚æ•°æœ€ä¸»è¦æ˜¯å°è£…äº†é€šçŸ¥èŠ‚ç‚¹çš„æ‰€æœ‰ä¿¡æ¯ã€‚
è¯·å‚è€ƒè¡¨è¾¾å¼æ ¸å¿ƒå˜é‡ä¸­å…³äºè¯¥èŠ‚ç‚¹çš„æè¿°ã€‚

ç‰¹æ®Šç”¨æ³•è¯·å‚è€ƒï¼šhttps://github.com/alibaba/arthas/issues/71

OGNL è¡¨è¾¾å¼å®˜ç½‘ï¼šhttps://commons.apache.org/dormant/commons-ognl/language-guide.html


ä½¿ç”¨æ¡ˆä¾‹


## ä½¿ç”¨stackå‘½ä»¤è·Ÿè¸ªprimeFactorsæ–¹æ³•[arthas@8161]$ stack demo.MathGame primeFactorsPress Q or Ctrl+C to abort.Affect(class count: 1 , method count: 1) cost in 88 ms, listenerId: 14ts=2025-06-07 09:53:24.073;thread_name=main;id=1;is_daemon=false;priority=5;TCCL=jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c    @demo.MathGame.primeFactors()        at demo.MathGame.run(MathGame.java:24)        at demo.MathGame.main(null:16)ts=2025-06-07 09:53:25.077;thread_name=main;id=1;is_daemon=false;priority=5;TCCL=jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c    @demo.MathGame.primeFactors()        at demo.MathGame.run(MathGame.java:24)        at demo.MathGame.main(null:16)## ä½¿ç”¨OGNLè¡¨è¾¾å¼ï¼Œè¿‡æ»¤ç¬¬ä¸€ä¸ªå‚æ•°å€¼å°äº0çš„æ–¹æ³•è°ƒç”¨æƒ…å†µï¼Œå¹¶ä¸”åªæ‰“å°ä¸¤ä¸ªä¿¡æ¯æ•°æ®[arthas@8161]$ stack demo.MathGame primeFactors &#x27;params[0]&lt;0&#x27; -n 2Press Q or Ctrl+C to abort.Affect(class count: 1 , method count: 1) cost in 85 ms, listenerId: 15ts=2025-06-07 09:53:57.220;thread_name=main;id=1;is_daemon=false;priority=5;TCCL=jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c    @demo.MathGame.primeFactors()        at demo.MathGame.run(MathGame.java:24)        at demo.MathGame.main(null:16)ts=2025-06-07 09:53:58.223;thread_name=main;id=1;is_daemon=false;priority=5;TCCL=jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c    @demo.MathGame.primeFactors()        at demo.MathGame.run(MathGame.java:24)        at demo.MathGame.main(null:16)Command execution times exceed limit: 2, so command will exit. You can set it with -n option.## ä½¿ç”¨OGNLè¡¨è¾¾å¼ï¼Œè¿‡æ»¤è€—æ—¶å¤§äº2æ¯«ç§’çš„ä¿¡æ¯[arthas@8161]$ stack demo.MathGame primeFactors &#x27;#cost&gt;2&#x27;Press Q or Ctrl+C to abort.Affect(class count: 1 , method count: 1) cost in 84 ms, listenerId: 17ts=2025-06-07 09:56:40.903;thread_name=main;id=1;is_daemon=false;priority=5;TCCL=jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c    @demo.MathGame.primeFactors()        at demo.MathGame.run(MathGame.java:24)        at demo.MathGame.main(null:16)ts=2025-06-07 09:56:44.919;thread_name=main;id=1;is_daemon=false;priority=5;TCCL=jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c    @demo.MathGame.primeFactors()        at demo.MathGame.run(MathGame.java:24)        at demo.MathGame.main(null:16)

5. ttå‘½ä»¤æ–¹æ³•æ‰§è¡Œæ•°æ®çš„æ—¶ç©ºéš§é“ï¼Œè®°å½•ä¸‹æŒ‡å®šæ–¹æ³•æ¯æ¬¡è°ƒç”¨çš„å…¥å‚å’Œè¿”å›ä¿¡æ¯ï¼Œå¹¶èƒ½å¯¹è¿™äº›ä¸åŒçš„æ—¶é—´ä¸‹è°ƒç”¨è¿›è¡Œè§‚æµ‹
watchÂ è™½ç„¶å¾ˆæ–¹ä¾¿å’Œçµæ´»ï¼Œä½†éœ€è¦æå‰æƒ³æ¸…æ¥šè§‚å¯Ÿè¡¨è¾¾å¼çš„æ‹¼å†™ï¼Œè¿™å¯¹æ’æŸ¥é—®é¢˜è€Œè¨€è¦æ±‚å¤ªé«˜ï¼Œå› ä¸ºå¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¹¶ä¸æ¸…æ¥šé—®é¢˜å‡ºè‡ªäºä½•æ–¹ï¼Œåªèƒ½é è››ä¸é©¬è¿¹è¿›è¡ŒçŒœæµ‹ã€‚
è¿™ä¸ªæ—¶å€™å¦‚æœèƒ½è®°å½•ä¸‹å½“æ—¶æ–¹æ³•è°ƒç”¨çš„æ‰€æœ‰å…¥å‚å’Œè¿”å›å€¼ã€æŠ›å‡ºçš„å¼‚å¸¸ä¼šå¯¹æ•´ä¸ªé—®é¢˜çš„æ€è€ƒä¸åˆ¤æ–­éå¸¸æœ‰å¸®åŠ©ã€‚
äºæ˜¯ä¹ï¼ŒTimeTunnel å‘½ä»¤å°±è¯ç”Ÿäº†ã€‚

ğŸ’¡


tt å‘½ä»¤çš„å®ç°æ˜¯ï¼šæŠŠå‡½æ•°çš„å…¥å‚&#x2F;è¿”å›å€¼ç­‰ï¼Œä¿å­˜åˆ°ä¸€ä¸ªMap&lt;Integer, TimeFragment&gt;é‡Œï¼Œé»˜è®¤çš„å¤§å°æ˜¯ 100ã€‚
tt ç›¸å…³åŠŸèƒ½åœ¨ä½¿ç”¨å®Œä¹‹åï¼Œéœ€è¦æ‰‹åŠ¨é‡Šæ”¾å†…å­˜ï¼Œå¦åˆ™é•¿æ—¶é—´å¯èƒ½å¯¼è‡´OOMã€‚é€€å‡º arthas ä¸ä¼šè‡ªåŠ¨æ¸…é™¤ tt çš„ç¼“å­˜ map


å‘½ä»¤å‚æ•°è§£æ
t
  tt å‘½ä»¤æœ‰å¾ˆå¤šä¸ªä¸»å‚æ•°ï¼Œ-tÂ å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚è¿™ä¸ªå‚æ•°çš„è¡¨æ˜å¸Œæœ›è®°å½•ä¸‹ç±»Â *TestÂ çš„Â printÂ æ–¹æ³•çš„æ¯æ¬¡æ‰§è¡Œæƒ…å†µã€‚

n 3
  å½“ä½ æ‰§è¡Œä¸€ä¸ªè°ƒç”¨é‡ä¸é«˜çš„æ–¹æ³•æ—¶å¯èƒ½ä½ è¿˜èƒ½æœ‰è¶³å¤Ÿçš„æ—¶é—´ç”¨Â CTRL+CÂ ä¸­æ–­ tt å‘½ä»¤è®°å½•çš„è¿‡ç¨‹ï¼Œä½†å¦‚æœé‡åˆ°è°ƒç”¨é‡éå¸¸å¤§çš„æ–¹æ³•ï¼Œç¬é—´å°±èƒ½å°†ä½ çš„ JVM å†…å­˜æ’‘çˆ†ã€‚
  æ­¤æ—¶ä½ å¯ä»¥é€šè¿‡Â -nÂ å‚æ•°æŒ‡å®šä½ éœ€è¦è®°å½•çš„æ¬¡æ•°ï¼Œå½“è¾¾åˆ°è®°å½•æ¬¡æ•°æ—¶ Arthas ä¼šä¸»åŠ¨ä¸­æ–­ tt å‘½ä»¤çš„è®°å½•è¿‡ç¨‹ï¼Œé¿å…äººå·¥æ“ä½œæ— æ³•åœæ­¢çš„æƒ…å†µã€‚

m 1
  é€šè¿‡Â -mÂ å‚æ•°æŒ‡å®š Class åŒ¹é…çš„æœ€å¤§æ•°é‡ï¼Œé˜²æ­¢åŒ¹é…åˆ°çš„ Class æ•°é‡å¤ªå¤šå¯¼è‡´ JVM æŒ‚èµ·ï¼Œé»˜è®¤å€¼æ˜¯ 50ã€‚




5.1 æ‰§è¡Œå‘½ä»¤ï¼štt -t demo.MathGame primeFactors[arthas@8161]$ tt -t demo.MathGame primeFactorsPress Q or Ctrl+C to abort.Affect(class count: 1 , method count: 1) cost in 85 ms, listenerId: 18 INDEX            TIMESTAMP                                 COST(ms)             IS-RET          IS-EXP           OBJECT                         CLASS                                                          METHOD                                                        ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ 1000             2025-06-07 10:07:44.617                   0.227622             false           true             0x589838eb                     MathGame                                                       primeFactors                                                   1001             2025-06-07 10:07:45.621                   0.07812              false           true             0x589838eb                     MathGame                                                       primeFactors                                                   1002             2025-06-07 10:07:46.623                   0.091644             false           true             0x589838eb                     MathGame                                                       primeFactors                                                   1003             2025-06-07 10:07:47.628                   3.676343             true            false            0x589838eb                     MathGame                                                       primeFactors                                                   1004             2025-06-07 10:07:48.631                   0.05122              false           true             0x589838eb                     MathGame                                                       primeFactors  


è¡¨æ ¼å­—æ®µè¯´æ˜




è¡¨æ ¼å­—æ®µ
å­—æ®µè§£é‡Š



INDEX
æ—¶é—´ç‰‡æ®µè®°å½•ç¼–å·ï¼Œæ¯ä¸€ä¸ªç¼–å·ä»£è¡¨ç€ä¸€æ¬¡è°ƒç”¨ï¼Œåç»­ tt è¿˜æœ‰å¾ˆå¤šå‘½ä»¤éƒ½æ˜¯åŸºäºæ­¤ç¼–å·æŒ‡å®šè®°å½•æ“ä½œï¼Œéå¸¸é‡è¦ã€‚


TIMESTAMP
æ–¹æ³•æ‰§è¡Œçš„æœ¬æœºæ—¶é—´ï¼Œè®°å½•äº†è¿™ä¸ªæ—¶é—´ç‰‡æ®µæ‰€å‘ç”Ÿçš„æœ¬æœºæ—¶é—´


COST(ms)
æ–¹æ³•æ‰§è¡Œçš„è€—æ—¶


IS-RET
æ–¹æ³•æ˜¯å¦ä»¥æ­£å¸¸è¿”å›çš„å½¢å¼ç»“æŸ


IS-EXP
æ–¹æ³•æ˜¯å¦ä»¥æŠ›å¼‚å¸¸çš„å½¢å¼ç»“æŸ


OBJECT
æ‰§è¡Œå¯¹è±¡çš„hashCode()ï¼Œæ³¨æ„ï¼Œæ›¾ç»æœ‰äººè¯¯è®¤ä¸ºæ˜¯å¯¹è±¡åœ¨ JVM ä¸­çš„å†…å­˜åœ°å€ï¼Œä½†å¾ˆé—æ†¾ä»–ä¸æ˜¯ã€‚ä½†ä»–èƒ½å¸®åŠ©ä½ ç®€å•çš„æ ‡è®°å½“å‰æ‰§è¡Œæ–¹æ³•çš„ç±»å®ä½“


CLASS
æ‰§è¡Œçš„ç±»å


METHOD
æ‰§è¡Œçš„æ–¹æ³•å



æ¡ä»¶è¡¨è¾¾å¼
  ä¸çŸ¥é“å¤§å®¶æ˜¯å¦æœ‰åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°ä»¥ä¸‹å›°æƒ‘

Arthas ä¼¼ä¹å¾ˆéš¾åŒºåˆ†å‡ºé‡è½½çš„æ–¹æ³•
æˆ‘åªéœ€è¦è§‚å¯Ÿç‰¹å®šå‚æ•°ï¼Œä½†æ˜¯ tt å´å…¨éƒ¨éƒ½ç»™æˆ‘è®°å½•äº†ä¸‹æ¥

  æ¡ä»¶è¡¨è¾¾å¼ä¹Ÿæ˜¯ç”¨Â OGNLÂ æ¥ç¼–å†™ï¼Œæ ¸å¿ƒçš„åˆ¤æ–­å¯¹è±¡ä¾ç„¶æ˜¯Â AdviceÂ å¯¹è±¡ã€‚é™¤äº†Â ttÂ å‘½ä»¤ä¹‹å¤–ï¼Œwatchã€traceã€stackÂ å‘½ä»¤ä¹Ÿéƒ½æ”¯æŒæ¡ä»¶è¡¨è¾¾å¼ã€‚
  

è§£å†³æ–¹æ³•é‡è½½
  tt -t *Test print params.length==1
  é€šè¿‡åˆ¶å®šå‚æ•°ä¸ªæ•°çš„å½¢å¼è§£å†³ä¸åŒçš„æ–¹æ³•ç­¾åï¼Œå¦‚æœå‚æ•°ä¸ªæ•°ä¸€æ ·ï¼Œä½ è¿˜å¯ä»¥è¿™æ ·å†™
  tt -t *Test print &#39;params[1] instanceof Integer&#39;

è§£å†³æŒ‡å®šå‚æ•°
  tt -t *Test print params[0].mobile==&quot;13989838402&quot;

æ„æˆæ¡ä»¶è¡¨è¾¾å¼çš„Â AdviceÂ å¯¹è±¡
  å‰è¾¹çœ‹åˆ°äº†å¾ˆå¤šæ¡ä»¶è¡¨è¾¾å¼ä¸­ï¼Œéƒ½ä½¿ç”¨äº†Â params[0]ï¼Œæœ‰å…³è¿™ä¸ªå˜é‡çš„ä»‹ç»ï¼Œè¯·å‚è€ƒè¡¨è¾¾å¼æ ¸å¿ƒå˜é‡


5.2 æŸ¥çœ‹è°ƒç”¨ä¿¡æ¯å¯¹äºå…·ä½“ä¸€ä¸ªæ—¶é—´ç‰‡çš„ä¿¡æ¯è€Œè¨€ï¼Œä½ å¯ä»¥é€šè¿‡Â -iÂ å‚æ•°åè¾¹è·Ÿç€å¯¹åº”çš„Â INDEXÂ ç¼–å·æŸ¥çœ‹åˆ°ä»–çš„è¯¦ç»†ä¿¡æ¯ã€‚
[arthas@8161]$ tt -i 1004 INDEX            1004                                                                                                                                                                                                                                                         GMT-CREATE       2025-06-07 10:07:48.631                                                                                                                                                                                                                                      COST(ms)         0.05122                                                                                                                                                                                                                                                      OBJECT           0x589838eb                                                                                                                                                                                                                                                   CLASS            demo.MathGame                                                                                                                                                                                                                                                METHOD           primeFactors                                                                                                                                                                                                                                                 IS-RETURN        false                                                                                                                                                                                                                                                        IS-EXCEPTION     true                                                                                                                                                                                                                                                         PARAMETERS[0]    @Integer[-67793]                                                                                                                                                                                                                                             THROW-EXCEPTION  java.lang.IllegalArgumentException: number is: -67793, need &gt;= 2                                                                                                                                                                                                              	at demo.MathGame.primeFactors(MathGame.java:46)                                                                                                                                                                                                                              	at demo.MathGame.run(MathGame.java:24)                                                                                                                                                                                                                                       	at demo.MathGame.main(Unknown Source)                                                                                                                                                                                                                      Affect(row-cnt:1) cost in 3 ms.

5.3 é‡åšä¸€æ¬¡è°ƒç”¨å½“ä½ ç¨ç¨åšäº†ä¸€äº›è°ƒæ•´ä¹‹åï¼Œä½ å¯èƒ½éœ€è¦å‰ç«¯ç³»ç»Ÿé‡æ–°è§¦å‘ä¸€æ¬¡ä½ çš„è°ƒç”¨ï¼Œæ­¤æ—¶å¾—æ±‚çˆ·çˆ·å‘Šå¥¶å¥¶çš„éœ€è¦å‰ç«¯é…åˆè”è°ƒçš„åŒå­¦å†æ¬¡å‘èµ·ä¸€æ¬¡è°ƒç”¨ã€‚è€Œæœ‰äº›åœºæ™¯ä¸‹ï¼Œè¿™ä¸ªè°ƒç”¨ä¸æ˜¯è¿™ä¹ˆå¥½è§¦å‘çš„ã€‚
ttÂ å‘½ä»¤ç”±äºä¿å­˜äº†å½“æ—¶è°ƒç”¨çš„æ‰€æœ‰ç°åœºä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è‡ªå·±ä¸»åŠ¨å¯¹ä¸€ä¸ªÂ INDEXÂ ç¼–å·çš„æ—¶é—´ç‰‡è‡ªä¸»å‘èµ·ä¸€æ¬¡è°ƒç”¨ï¼Œä»è€Œè§£æ”¾ä½ çš„æ²Ÿé€šæˆæœ¬ã€‚æ­¤æ—¶ä½ éœ€è¦Â -pÂ å‚æ•°ã€‚é€šè¿‡Â --replay-timesÂ æŒ‡å®š è°ƒç”¨æ¬¡æ•°ï¼Œé€šè¿‡Â --replay-intervalÂ æŒ‡å®šå¤šæ¬¡è°ƒç”¨é—´éš”(å•ä½ ms, é»˜è®¤ 1000ms)
[arthas@8161]$ tt -i 1004 -p RE-INDEX         1004                                                                                                                                                                                                                                                         GMT-REPLAY       2025-06-07 10:15:36.439                                                                                                                                                                                                                                      OBJECT           0x589838eb                                                                                                                                                                                                                                                   CLASS            demo.MathGame                                                                                                                                                                                                                                                METHOD           primeFactors                                                                                                                                                                                                                                                 PARAMETERS[0]    @Integer[-67793]                                                                                                                                                                                                                                             IS-RETURN        false                                                                                                                                                                                                                                                        IS-EXCEPTION     true                                                                                                                                                                                                                                                         THROW-EXCEPTION  java.lang.IllegalArgumentException: number is: -67793, need &gt;= 2                                                                                                                                                                                                              	at demo.MathGame.primeFactors(MathGame.java:46)                                                                                                                                                                                                                              	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)                                                                                                                                                                                            	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)                                                                                                                                                                          	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)                                                                                                                                                                  	at java.base/java.lang.reflect.Method.invoke(Method.java:566)                                                                                                                                                                                                                	at com.taobao.arthas.core.advisor.ArthasMethod.invoke(ArthasMethod.java:155)                                                                                                                                                                                                 	at com.taobao.arthas.core.command.monitor200.TimeTunnelCommand.processPlay(TimeTunnelCommand.java:517)                                                                                                                                                                       	at com.taobao.arthas.core.command.monitor200.TimeTunnelCommand.process(TimeTunnelCommand.java:278)                                                                                                                                                                           	at com.taobao.arthas.core.shell.command.impl.AnnotatedCommandImpl.process(AnnotatedCommandImpl.java:82)                                                                                                                                                                      	at com.taobao.arthas.core.shell.command.impl.AnnotatedCommandImpl.access$100(AnnotatedCommandImpl.java:18)                                                                                                                                                                   	at com.taobao.arthas.core.shell.command.impl.AnnotatedCommandImpl$ProcessHandler.handle(AnnotatedCommandImpl.java:111)                                                                                                                                                       	at com.taobao.arthas.core.shell.command.impl.AnnotatedCommandImpl$ProcessHandler.handle(AnnotatedCommandImpl.java:108)                                                                                                                                                       	at com.taobao.arthas.core.shell.system.impl.ProcessImpl$CommandProcessTask.run(ProcessImpl.java:385)                                                                                                                                                                         	at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)                                                                                                                                                                                         	at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)                                                                                                                                                                                                        	at java.base/java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:304)                                                                                                                                                  	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)                                                                                                                                                                                 	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)                                                                                                                                                                                 	at java.base/java.lang.Thread.run(Thread.java:834)                                                                                                                                                                                                         Time fragment[1004] successfully replayed 1 times.]]></content>
      <categories>
        <category>Arthas</category>
      </categories>
      <tags>
        <tag>Arthas</tag>
        <tag>Arthasè¯Šæ–­å·¥å…·</tag>
      </tags>
  </entry>
  <entry>
    <title>Arthasè¯Šæ–­å·¥å…·(å…­)Arthasï¼ˆé˜¿å°”è¨æ–¯ï¼‰optionså…¨å±€å¼€å…³</title>
    <url>/Arthas%E5%BA%94%E7%94%A8(Java)%E8%AF%8A%E6%96%AD%E5%88%A9%E5%99%A8/Arthas%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7(%E5%85%AD)Arthas%EF%BC%88%E9%98%BF%E5%B0%94%E8%90%A8%E6%96%AF%EF%BC%89options%E5%85%A8%E5%B1%80%E5%BC%80%E5%85%B3/</url>
    <content><![CDATA[Arthasè¯Šæ–­å·¥å…·(å…­)Arthasï¼ˆé˜¿å°”è¨æ–¯ï¼‰optionså…¨å±€å¼€å…³1. optionså‘½ä»¤å…¨å±€å¼€å…³



åç§°
é»˜è®¤å€¼
æè¿°



unsafe
false
æ˜¯å¦æ”¯æŒå¯¹ç³»ç»Ÿçº§åˆ«çš„ç±»è¿›è¡Œå¢å¼ºï¼Œæ‰“å¼€è¯¥å¼€å…³å¯èƒ½å¯¼è‡´æŠŠ JVM ææŒ‚ï¼Œè¯·æ…é‡é€‰æ‹©ï¼


dump
false
æ˜¯å¦æ”¯æŒè¢«å¢å¼ºäº†çš„ç±» dump åˆ°å¤–éƒ¨æ–‡ä»¶ä¸­ï¼Œå¦‚æœæ‰“å¼€å¼€å…³ï¼Œclass æ–‡ä»¶ä¼šè¢« dump åˆ°/$&#123;application working dir&#125;/arthas-class-dump/ç›®å½•ä¸‹ï¼Œå…·ä½“ä½ç½®è¯¦è§æ§åˆ¶å°è¾“å‡º


batch-re-transform
true
æ˜¯å¦æ”¯æŒæ‰¹é‡å¯¹åŒ¹é…åˆ°çš„ç±»æ‰§è¡Œ retransform æ“ä½œ


json-format
false
æ˜¯å¦æ”¯æŒ json åŒ–çš„è¾“å‡º


disable-sub-class
false
æ˜¯å¦ç¦ç”¨å­ç±»åŒ¹é…ï¼Œé»˜è®¤åœ¨åŒ¹é…ç›®æ ‡ç±»çš„æ—¶å€™ä¼šé»˜è®¤åŒ¹é…åˆ°å…¶å­ç±»ï¼Œå¦‚æœæƒ³ç²¾ç¡®åŒ¹é…ï¼Œå¯ä»¥å…³é—­æ­¤å¼€å…³


support-default-method
true
æ˜¯å¦æ”¯æŒåŒ¹é…åˆ° default methodï¼Œ é»˜è®¤ä¼šæŸ¥æ‰¾ interfaceï¼ŒåŒ¹é…é‡Œé¢çš„ default methodã€‚å‚è€ƒÂ #1105åœ¨æ–°çª—å£æ‰“å¼€


save-result
false
æ˜¯å¦æ‰“å¼€æ‰§è¡Œç»“æœå­˜æ—¥å¿—åŠŸèƒ½ï¼Œæ‰“å¼€ä¹‹åæ‰€æœ‰å‘½ä»¤çš„è¿è¡Œç»“æœéƒ½å°†ä¿å­˜åˆ°~/logs/arthas-cache/result.logä¸­


job-timeout
1d
å¼‚æ­¥åå°ä»»åŠ¡çš„é»˜è®¤è¶…æ—¶æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼Œä»»åŠ¡è‡ªåŠ¨åœæ­¢ï¼›æ¯”å¦‚è®¾ç½® 1d, 2h, 3m, 25sï¼Œåˆ†åˆ«ä»£è¡¨å¤©ã€å°æ—¶ã€åˆ†ã€ç§’


print-parent-fields
true
æ˜¯å¦æ‰“å°åœ¨ parent class é‡Œçš„ filed


verbose
false
æ˜¯å¦æ‰“å°æ›´å¤šè¯¦ç»†ä¿¡æ¯


strict
true
æ˜¯å¦å¯ç”¨ strict æ¨¡å¼



æŸ¥çœ‹æ‰€æœ‰çš„ options

[arthas@8161]$ options LEVEL              TYPE                NAME                                  VALUE              SUMMARY                                                   DESCRIPTION                                                                                                        ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ 0                  boolean             unsafe                                false              Option to support system-level class                      This option enables to proxy functionality of JVM classes. Due to serious security risk a JVM crash is possibly be                                                                                                                                                             introduced. Do not activate it unless you are able to manage.                                                      1                  boolean             dump                                  false              Option to dump the enhanced classes                       This option enables the enhanced classes to be dumped to external file for further de-compilation and analysis.     1                  boolean             batch-re-transform                    true               Option to support batch reTransform Class                 This options enables to reTransform classes with batch mode.                                                        2                  boolean             json-format                           false              Option to support JSON format of object output            This option enables to format object output with JSON when -x option selected.                                      1                  boolean             disable-sub-class                     false              Option to control include sub class when class matching   This option disable to include sub class when matching class.                                                       1                  boolean             support-default-method                true               Option to control include default method in interface wh  This option disable to include default method in interface when matching class.                                                                                                                                     en class matching                                                                                                                                                             1                  boolean             save-result                           false              Option to print command&#x27;s result to log file              This option enables to save each command&#x27;s result to log file, which path is $&#123;user.home&#125;/logs/arthas-cache/result                                                                                                                                                            .log.                                                                                                               2                  String              job-timeout                           1d                 Option to job timeout                                     This option setting job timeout,The unit can be d, h, m, s for day, hour, minute, second. 1d is one day in default  1                  boolean             print-parent-fields                   true               Option to print all fileds in parent class                This option enables print files in parent class, default value true.                                                1                  boolean             verbose                               false              Option to print verbose information                       This option enables print verbose information, default value false.                                                 1                  boolean             strict                                true               Option to strict mode                                     By default, strict mode is true, not allowed to set object properties. Want to set object properties, execute `opt                                                                                                                                                            ions strict false`  


è·å– option çš„å€¼

json-format job-timeout [arthas@8161]$ options json-format  LEVEL              TYPE                NAME                                  VALUE              SUMMARY                                                   DESCRIPTION                                                                                                        ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ 2                  boolean             json-format                           false              Option to support JSON format of object output            This option enables to format object output with JSON when -x option selected.                                     ]]></content>
      <categories>
        <category>Arthas</category>
      </categories>
      <tags>
        <tag>Arthas</tag>
        <tag>Arthasè¯Šæ–­å·¥å…·</tag>
      </tags>
  </entry>
  <entry>
    <title>Arthasè¯Šæ–­å·¥å…·(å››)Arthasï¼ˆé˜¿å°”è¨æ–¯ï¼‰class/classloaderç›¸å…³å‘½ä»¤</title>
    <url>/Arthas%E5%BA%94%E7%94%A8(Java)%E8%AF%8A%E6%96%AD%E5%88%A9%E5%99%A8/Arthas%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7(%E5%9B%9B)Arthas%EF%BC%88%E9%98%BF%E5%B0%94%E8%90%A8%E6%96%AF%EF%BC%89class%20classloader%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[Arthasè¯Šæ–­å·¥å…·(å››)Arthasï¼ˆé˜¿å°”è¨æ–¯ï¼‰class&#x2F;classloaderç›¸å…³å‘½ä»¤1. scå‘½ä»¤æŸ¥çœ‹ JVM å·²åŠ è½½çš„ç±»ä¿¡æ¯ï¼Œ
â€œSearch-Classâ€ çš„ç®€å†™ï¼Œè¿™ä¸ªå‘½ä»¤èƒ½æœç´¢å‡ºæ‰€æœ‰å·²ç»åŠ è½½åˆ° JVM ä¸­çš„ Class ä¿¡æ¯ï¼Œè¿™ä¸ªå‘½ä»¤æ”¯æŒçš„å‚æ•°æœ‰Â [d]ã€[E]ã€[f]Â å’ŒÂ [x:]ã€‚

å‚æ•°è¯´æ˜




å‚æ•°åç§°
å‚æ•°è¯´æ˜



class-pattern
ç±»åè¡¨è¾¾å¼åŒ¹é…


method-pattern
æ–¹æ³•åè¡¨è¾¾å¼åŒ¹é…


[d]
è¾“å‡ºå½“å‰ç±»çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¿™ä¸ªç±»æ‰€åŠ è½½çš„åŸå§‹æ–‡ä»¶æ¥æºã€ç±»çš„å£°æ˜ã€åŠ è½½çš„ ClassLoader ç­‰è¯¦ç»†ä¿¡æ¯ã€‚å¦‚æœä¸€ä¸ªç±»è¢«å¤šä¸ª ClassLoader æ‰€åŠ è½½ï¼Œåˆ™ä¼šå‡ºç°å¤šæ¬¡


[E]
å¼€å¯æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œé»˜è®¤ä¸ºé€šé…ç¬¦åŒ¹é…


[f]
è¾“å‡ºå½“å‰ç±»çš„æˆå‘˜å˜é‡ä¿¡æ¯ï¼ˆéœ€è¦é…åˆå‚æ•°-d ä¸€èµ·ä½¿ç”¨ï¼‰


[x:]
æŒ‡å®šè¾“å‡ºé™æ€å˜é‡æ—¶å±æ€§çš„éå†æ·±åº¦ï¼Œé»˜è®¤ä¸º 0ï¼Œå³ç›´æ¥ä½¿ç”¨Â toStringÂ è¾“å‡º


[c:]
æŒ‡å®š class çš„ ClassLoader çš„ hashcode


[classLoaderClass:]
æŒ‡å®šæ‰§è¡Œè¡¨è¾¾å¼çš„ ClassLoader çš„ class name


[n:]
å…·æœ‰è¯¦ç»†ä¿¡æ¯çš„åŒ¹é…ç±»çš„æœ€å¤§æ•°é‡ï¼ˆé»˜è®¤ä¸º 100ï¼‰


[cs &lt;arg&gt;]
æŒ‡å®š class çš„ ClassLoader#toString() è¿”å›å€¼ã€‚é•¿æ ¼å¼[classLoaderStr &lt;arg&gt;]



æç¤º

class-pattern æ”¯æŒå…¨é™å®šåï¼Œå¦‚ com.taobao.test.AAAï¼Œä¹Ÿæ”¯æŒ com&#x2F;taobao&#x2F;test&#x2F;AAA è¿™æ ·çš„æ ¼å¼ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬ä»å¼‚å¸¸å †æ ˆé‡Œé¢æŠŠç±»åæ‹·è´è¿‡æ¥çš„æ—¶å€™ï¼Œä¸éœ€è¦åœ¨æ‰‹åŠ¨æŠŠ/æ›¿æ¢ä¸º.å•¦ã€‚
sc é»˜è®¤å¼€å¯äº†å­ç±»åŒ¹é…åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰å½“å‰ç±»çš„å­ç±»ä¹Ÿä¼šè¢«æœç´¢å‡ºæ¥ï¼Œæƒ³è¦ç²¾ç¡®çš„åŒ¹é…ï¼Œè¯·æ‰“å¼€options disable-sub-class trueå¼€å…³


ä½¿ç”¨å‚è€ƒ

æ¨¡ç³Šæœç´¢

  [arthas@7339]$ sc demo.*demo.MathGameAffect(row-cnt:1) cost in 17 ms.

æ‰“å°ç±»çš„è¯¦ç»†ä¿¡æ¯

  [arthas@7339]$ sc -d demo.MathGame class-info        demo.MathGame                                                                                                                                                                                                                                               code-source       /usr/local/software/arthas/math-game.jar                                                                                                                                                                                                                    name              demo.MathGame                                                                                                                                                                                                                                               isInterface       false                                                                                                                                                                                                                                                       isAnnotation      false                                                                                                                                                                                                                                                       isEnum            false                                                                                                                                                                                                                                                       isAnonymousClass  false                                                                                                                                                                                                                                                       isArray           false                                                                                                                                                                                                                                                       isLocalClass      false                                                                                                                                                                                                                                                       isMemberClass     false                                                                                                                                                                                                                                                       isPrimitive       false                                                                                                                                                                                                                                                       isSynthetic       false                                                                                                                                                                                                                                                       simple-name       MathGame                                                                                                                                                                                                                                                    modifier          public                                                                                                                                                                                                                                                      annotation                                                                                                                                                                                                                                                                    interfaces                                                                                                                                                                                                                                                                    super-class       +-java.lang.Object                                                                                                                                                                                                                                          class-loader      +-jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c                                                                                                                                                                                                                      +-jdk.internal.loader.ClassLoaders$PlatformClassLoader@38755edd                                                                                                                                                                                           classLoaderHash   4b85612c                                                                                                                                                                                                                                                   Affect(row-cnt:1) cost in 21 ms.

æ‰“å°å‡ºç±»çš„ Field ä¿¡æ¯

  [arthas@7339]$ sc -d -f demo.MathGame class-info        demo.MathGame                                                                                                                                                                                                                                               code-source       /usr/local/software/arthas/math-game.jar                                                                                                                                                                                                                    name              demo.MathGame                                                                                                                                                                                                                                               isInterface       false                                                                                                                                                                                                                                                       isAnnotation      false                                                                                                                                                                                                                                                       isEnum            false                                                                                                                                                                                                                                                       isAnonymousClass  false                                                                                                                                                                                                                                                       isArray           false                                                                                                                                                                                                                                                       isLocalClass      false                                                                                                                                                                                                                                                       isMemberClass     false                                                                                                                                                                                                                                                       isPrimitive       false                                                                                                                                                                                                                                                       isSynthetic       false                                                                                                                                                                                                                                                       simple-name       MathGame                                                                                                                                                                                                                                                    modifier          public                                                                                                                                                                                                                                                      annotation                                                                                                                                                                                                                                                                    interfaces                                                                                                                                                                                                                                                                    super-class       +-java.lang.Object                                                                                                                                                                                                                                          class-loader      +-jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c                                                                                                                                                                                                                      +-jdk.internal.loader.ClassLoaders$PlatformClassLoader@38755edd                                                                                                                                                                                           classLoaderHash   4b85612c                                                                                                                                                                                                                                                    fields            name     random                                                                                                                                                                                                                                                               type     java.util.Random                                                                                                                                                                                                                                                     modifier private,static                                                                                                                                                                                                                                                       value    java.util.Random@464dde8d                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          name     illegalArgumentCount                                                                                                                                                                                                                                                 type     int                                                                                                                                                                                                                                                                  modifier private                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Affect(row-cnt:1) cost in 23 ms.

2. sm å‘½ä»¤æŸ¥çœ‹å·²åŠ è½½ç±»çš„æ–¹æ³•ä¿¡æ¯ï¼Œâ€œSearch-Methodâ€ çš„ç®€å†™ï¼Œè¿™ä¸ªå‘½ä»¤èƒ½æœç´¢å‡ºæ‰€æœ‰å·²ç»åŠ è½½äº† Class ä¿¡æ¯çš„æ–¹æ³•ä¿¡æ¯ã€‚
smÂ å‘½ä»¤åªèƒ½çœ‹åˆ°ç”±å½“å‰ç±»æ‰€å£°æ˜ (declaring) çš„æ–¹æ³•ï¼Œçˆ¶ç±»åˆ™æ— æ³•çœ‹åˆ°ã€‚

å‚æ•°è¯´æ˜




å‚æ•°åç§°
å‚æ•°è¯´æ˜



class-pattern
ç±»åè¡¨è¾¾å¼åŒ¹é…


method-pattern
æ–¹æ³•åè¡¨è¾¾å¼åŒ¹é…


[d]
å±•ç¤ºæ¯ä¸ªæ–¹æ³•çš„è¯¦ç»†ä¿¡æ¯


[E]
å¼€å¯æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œé»˜è®¤ä¸ºé€šé…ç¬¦åŒ¹é…


[c:]
æŒ‡å®š class çš„ ClassLoader çš„ hashcode


[classLoaderClass:]
æŒ‡å®šæ‰§è¡Œè¡¨è¾¾å¼çš„ ClassLoader çš„ class name


[n:]
å…·æœ‰è¯¦ç»†ä¿¡æ¯çš„åŒ¹é…ç±»çš„æœ€å¤§æ•°é‡ï¼ˆé»˜è®¤ä¸º 100ï¼‰


[arthas@7339]$ sm java.lang.Stringjava.lang.String &lt;init&gt;([B)Vjava.lang.String &lt;init&gt;([BII)Vjava.lang.String &lt;init&gt;([BLjava/nio/charset/Charset;)Vjava.lang.String &lt;init&gt;([BLjava/lang/String;)Vjava.lang.String &lt;init&gt;([BIILjava/nio/charset/Charset;)Vjava.lang.String &lt;init&gt;([CIILjava/lang/Void;)Vjava.lang.String &lt;init&gt;(Ljava/lang/AbstractStringBuilder;Ljava/lang/Void;)Vjava.lang.String &lt;init&gt;(Ljava/lang/StringBuilder;)Vjava.lang.String &lt;init&gt;(Ljava/lang/StringBuffer;)Vjava.lang.String &lt;init&gt;([BB)Vjava.lang.String &lt;init&gt;([CII)Vjava.lang.String &lt;init&gt;([C)Vjava.lang.String &lt;init&gt;(Ljava/lang/String;)Vjava.lang.String &lt;init&gt;()Vjava.lang.String &lt;init&gt;([BIILjava/lang/String;)Vjava.lang.String &lt;init&gt;([BI)Vjava.lang.String &lt;init&gt;([BIII)Vjava.lang.String &lt;init&gt;([III)Vjava.lang.String value()[Bjava.lang.String equals(Ljava/lang/Object;)Zjava.lang.String length()Ijava.lang.String toString()Ljava/lang/String;java.lang.String hashCode()Ijava.lang.String getChars(II[CI)Vjava.lang.String compareTo(Ljava/lang/String;)Ijava.lang.String compareTo(Ljava/lang/Object;)Ijava.lang.String indexOf(Ljava/lang/String;I)Ijava.lang.String indexOf(I)Ijava.lang.String indexOf([BBILjava/lang/String;I)Ijava.lang.String indexOf(II)Ijava.lang.String indexOf(Ljava/lang/String;)Ijava.lang.String checkIndex(II)Vjava.lang.String valueOf(I)Ljava/lang/String;java.lang.String valueOf(F)Ljava/lang/String;java.lang.String valueOf(Z)Ljava/lang/String;java.lang.String valueOf(J)Ljava/lang/String;java.lang.String valueOf(D)Ljava/lang/String;java.lang.String valueOf(Ljava/lang/Object;)Ljava/lang/String;java.lang.String valueOf(C)Ljava/lang/String;java.lang.String valueOf([C)Ljava/lang/String;java.lang.String valueOf([CII)Ljava/lang/String;java.lang.String coder()Bjava.lang.String rangeCheck([CII)Ljava/lang/Void;java.lang.String codePoints()Ljava/util/stream/IntStream;java.lang.String isEmpty()Zjava.lang.String charAt(I)Cjava.lang.String codePointAt(I)Ijava.lang.String codePointBefore(I)Ijava.lang.String codePointCount(II)Ijava.lang.String offsetByCodePoints(II)Ijava.lang.String getBytes(Ljava/nio/charset/Charset;)[Bjava.lang.String getBytes(II[BI)Vjava.lang.String getBytes(Ljava/lang/String;)[Bjava.lang.String getBytes()[Bjava.lang.String getBytes([BIB)Vjava.lang.String contentEquals(Ljava/lang/StringBuffer;)Zjava.lang.String contentEquals(Ljava/lang/CharSequence;)Zjava.lang.String nonSyncContentEquals(Ljava/lang/AbstractStringBuilder;)Zjava.lang.String equalsIgnoreCase(Ljava/lang/String;)Zjava.lang.String compareToIgnoreCase(Ljava/lang/String;)Ijava.lang.String regionMatches(ZILjava/lang/String;II)Zjava.lang.String regionMatches(ILjava/lang/String;II)Zjava.lang.String startsWith(Ljava/lang/String;)Zjava.lang.String startsWith(Ljava/lang/String;I)Zjava.lang.String endsWith(Ljava/lang/String;)Zjava.lang.String lastIndexOf(I)Ijava.lang.String lastIndexOf([BBILjava/lang/String;I)Ijava.lang.String lastIndexOf(Ljava/lang/String;I)Ijava.lang.String lastIndexOf(Ljava/lang/String;)Ijava.lang.String lastIndexOf(II)Ijava.lang.String substring(II)Ljava/lang/String;java.lang.String substring(I)Ljava/lang/String;java.lang.String subSequence(II)Ljava/lang/CharSequence;java.lang.String concat(Ljava/lang/String;)Ljava/lang/String;java.lang.String replace(Ljava/lang/CharSequence;Ljava/lang/CharSequence;)Ljava/lang/String;java.lang.String replace(CC)Ljava/lang/String;java.lang.String matches(Ljava/lang/String;)Zjava.lang.String contains(Ljava/lang/CharSequence;)Zjava.lang.String replaceFirst(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;java.lang.String replaceAll(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;java.lang.String split(Ljava/lang/String;)[Ljava/lang/String;java.lang.String split(Ljava/lang/String;I)[Ljava/lang/String;java.lang.String join(Ljava/lang/CharSequence;[Ljava/lang/CharSequence;)Ljava/lang/String;java.lang.String join(Ljava/lang/CharSequence;Ljava/lang/Iterable;)Ljava/lang/String;java.lang.String toLowerCase()Ljava/lang/String;java.lang.String toLowerCase(Ljava/util/Locale;)Ljava/lang/String;java.lang.String toUpperCase(Ljava/util/Locale;)Ljava/lang/String;java.lang.String toUpperCase()Ljava/lang/String;java.lang.String trim()Ljava/lang/String;java.lang.String strip()Ljava/lang/String;java.lang.String stripLeading()Ljava/lang/String;java.lang.String stripTrailing()Ljava/lang/String;java.lang.String isBlank()Zjava.lang.String indexOfNonWhitespace()Ijava.lang.String lines()Ljava/util/stream/Stream;java.lang.String chars()Ljava/util/stream/IntStream;java.lang.String toCharArray()[Cjava.lang.String format(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;java.lang.String format(Ljava/util/Locale;Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;java.lang.String copyValueOf([CII)Ljava/lang/String;java.lang.String copyValueOf([C)Ljava/lang/String;java.lang.String intern()Ljava/lang/String;java.lang.String repeat(I)Ljava/lang/String;java.lang.String isLatin1()Zjava.lang.String checkOffset(II)Vjava.lang.String checkBoundsOffCount(III)Vjava.lang.String checkBoundsBeginEnd(III)Vjava.lang.String valueOfCodePoint(I)Ljava/lang/String;Affect(row-cnt:108) cost in 29 ms.


å±•ç¤ºæ¯ä¸ªæ–¹æ³•çš„è¯¦ç»†ä¿¡æ¯

[arthas@7339]$ sm -d java.lang.String toString declaring-class  java.lang.String                                                                                                                                                                                                                                             method-name      toString                                                                                                                                                                                                                                                     modifier         public                                                                                                                                                                                                                                                       annotation                                                                                                                                                                                                                                                                    parameters                                                                                                                                                                                                                                                                    return           java.lang.String                                                                                                                                                                                                                                             exceptions                                                                                                                                                                                                                                                                    classLoaderHash  null                                                                                                                                                                                                                                                        Affect(row-cnt:1) cost in 14 ms.

3. jad å‘½ä»¤åç¼–è¯‘æŒ‡å®šå·²åŠ è½½ç±»çš„æºç 
jadÂ å‘½ä»¤å°† JVM ä¸­å®é™…è¿è¡Œçš„ class çš„ byte code åç¼–è¯‘æˆ java ä»£ç ï¼Œä¾¿äºä½ ç†è§£ä¸šåŠ¡é€»è¾‘ï¼›å¦‚éœ€æ‰¹é‡ä¸‹è½½æŒ‡å®šåŒ…çš„ç›®å½•çš„ class å­—èŠ‚ç å¯ä»¥å‚è€ƒÂ dumpã€‚

åœ¨ Arthas Console ä¸Šï¼Œåç¼–è¯‘å‡ºæ¥çš„æºç æ˜¯å¸¦è¯­æ³•é«˜äº®çš„ï¼Œé˜…è¯»æ›´æ–¹ä¾¿
å½“ç„¶ï¼Œåç¼–è¯‘å‡ºæ¥çš„ java ä»£ç å¯èƒ½ä¼šå­˜åœ¨è¯­æ³•é”™è¯¯ï¼Œä½†ä¸å½±å“ä½ è¿›è¡Œé˜…è¯»ç†è§£
å‚æ•°è¯´æ˜




å‚æ•°åç§°
å‚æ•°è¯´æ˜



class-pattern
ç±»åè¡¨è¾¾å¼åŒ¹é…


[c:]
ç±»æ‰€å± ClassLoader çš„ hashcode


[classLoaderClass:]
æŒ‡å®šæ‰§è¡Œè¡¨è¾¾å¼çš„ ClassLoader çš„ class name


[E]
å¼€å¯æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œé»˜è®¤ä¸ºé€šé…ç¬¦åŒ¹é…



ä½¿ç”¨å‚è€ƒ

[arthas@5167]$ jad demo.MathGame // ä½¿ç”¨çš„ç±»åŠ è½½å™¨ClassLoader:                                                                                                                                                                                                                                                                  +-jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c                                                                                                                                                                                                                      +-jdk.internal.loader.ClassLoaders$PlatformClassLoader@f98fa20                                                                                                                                                                                                              // Main Classçš„ä½ç½®åœ¨math-game.jaræ–‡ä»¶ä¸­Location:                                                                                                                                                                                                                                                                     /usr/local/software/arthas/math-game.jar                                                                                                                                                                                                                                             /*        * Decompiled with CFR.        */       package demo;              import java.util.ArrayList;       import java.util.List;       import java.util.Random;       import java.util.concurrent.TimeUnit;              public class MathGame &#123;           private static Random random = new Random();           private int illegalArgumentCount = 0;                  public List&lt;Integer&gt; primeFactors(int number) &#123;/*44*/         if (number &lt; 2) &#123;/*45*/             ++this.illegalArgumentCount;                   throw new IllegalArgumentException(&quot;number is: &quot; + number + &quot;, need &gt;= 2&quot;);               &#125;               ArrayList&lt;Integer&gt; result = new ArrayList&lt;Integer&gt;();/*50*/         int i = 2;/*51*/         while (i &lt;= number) &#123;/*52*/             if (number % i == 0) &#123;/*53*/                 result.add(i);/*54*/                 number /= i;/*55*/                 i = 2;                       continue;                   &#125;/*57*/             ++i;               &#125;/*61*/         return result;           &#125;                  public static void main(String[] args) throws InterruptedException &#123;               MathGame game = new MathGame();               while (true) &#123;/*16*/             game.run();/*17*/             TimeUnit.SECONDS.sleep(1L);               &#125;           &#125;                  public void run() throws InterruptedException &#123;               try &#123;/*23*/             int number = random.nextInt() / 10000;/*24*/             List&lt;Integer&gt; primeFactors = this.primeFactors(number);/*25*/             MathGame.print(number, primeFactors);               &#125;               catch (Exception e) &#123;/*28*/             System.out.println(String.format(&quot;illegalArgumentCount:%3d, &quot;, this.illegalArgumentCount) + e.getMessage());               &#125;           &#125;                  public static void print(int number, List&lt;Integer&gt; primeFactors) &#123;               StringBuffer sb = new StringBuffer(number + &quot;=&quot;);/*34*/         for (int factor : primeFactors) &#123;/*35*/             sb.append(factor).append(&#x27;*&#x27;);               &#125;/*37*/         if (sb.charAt(sb.length() - 1) == &#x27;*&#x27;) &#123;/*38*/             sb.deleteCharAt(sb.length() - 1);               &#125;/*40*/         System.out.println(sb);           &#125;       &#125;// è€—æ—¶1238 ms.Affect(row-cnt:1) cost in 1238 ms.

4. mcå‘½ä»¤Memory Compiler&#x2F;å†…å­˜ç¼–è¯‘å™¨ï¼Œç¼–è¯‘.javaæ–‡ä»¶ç”Ÿæˆ.classã€‚é»˜è®¤ä½ç½®åœ¨arthasä½ç½®
å¯ä»¥é€šè¿‡-då‘½ä»¤æŒ‡å®šè¾“å‡ºç›®å½•ï¼š
// æŸ¥çœ‹Hello.javaçš„å†…å®¹[arthas@7339]$ cat /usr/local/software/arthas/Hello.java public class Hello &#123;	public static void main(String[] args)&#123;		System.out.println(&quot;Hello&quot;);	&#125;&#125;// ä½¿ç”¨mcå‘½ä»¤ç¼–è¯‘æ–‡ä»¶[arthas@7339]$ mc -d /usr/local/software/arthas/output /usr/local/software/arthas/Hello.java Memory compiler output:/usr/local/software/arthas/output/Hello.classAffect(row-cnt:1) cost in 738 ms.

5.redefineå‘½ä»¤åŠ è½½å¤–éƒ¨çš„.classæ–‡ä»¶ï¼Œredefine jvm å·²åŠ è½½çš„ç±»ã€‚

redefine çš„ class ä¸èƒ½ä¿®æ”¹ã€æ·»åŠ ã€åˆ é™¤ç±»çš„ field å’Œ methodï¼ŒåŒ…æ‹¬æ–¹æ³•å‚æ•°ã€æ–¹æ³•åç§°åŠè¿”å›å€¼
å¦‚æœ mc å¤±è´¥ï¼Œå¯ä»¥åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒç¼–è¯‘å¥½ class æ–‡ä»¶ï¼Œä¸Šä¼ åˆ°ç›®æ ‡ç³»ç»Ÿï¼Œä½¿ç”¨ redefine çƒ­åŠ è½½ class
ç›®å‰ redefine å’Œ watch&#x2F;trace&#x2F;jad&#x2F;tt ç­‰å‘½ä»¤å†²çªï¼Œä»¥åé‡æ–°å®ç° redefine åŠŸèƒ½ä¼šè§£å†³æ­¤é—®é¢˜


ğŸ’¡

æ³¨æ„ï¼Œ redefine åçš„åŸæ¥çš„ç±»ä¸èƒ½æ¢å¤ï¼Œredefine æœ‰å¯èƒ½å¤±è´¥ï¼ˆæ¯”å¦‚å¢åŠ äº†æ–°çš„ fieldï¼‰ï¼Œå‚è€ƒ jdk æœ¬èº«çš„æ–‡æ¡£ã€‚
resetå‘½ä»¤å¯¹redefineçš„ç±»æ— æ•ˆã€‚å¦‚æœæƒ³é‡ç½®ï¼Œéœ€è¦redefineåŸå§‹çš„å­—èŠ‚ç ã€‚
redefineå‘½ä»¤å’Œjad&#x2F;watch&#x2F;trace&#x2F;monitor&#x2F;ttç­‰å‘½ä»¤ä¼šå†²çªã€‚æ‰§è¡Œå®Œredefineä¹‹åï¼Œå¦‚æœå†æ‰§è¡Œä¸Šé¢æåˆ°çš„å‘½ä»¤ï¼Œåˆ™ä¼šæŠŠredefineçš„å­—èŠ‚ç é‡ç½®ã€‚ åŸå› æ˜¯ jdk æœ¬èº« redefine å’Œ Retransform æ˜¯ä¸åŒçš„æœºåˆ¶ï¼ŒåŒæ—¶ä½¿ç”¨ä¸¤ç§æœºåˆ¶æ¥æ›´æ–°å­—èŠ‚ç ï¼Œåªæœ‰æœ€åä¿®æ”¹çš„ä¼šç”Ÿæ•ˆã€‚



å‚æ•°è¯´æ˜




å‚æ•°åç§°
å‚æ•°è¯´æ˜



[c:]
ClassLoader çš„ hashcode


[classLoaderClass:]
æŒ‡å®šæ‰§è¡Œè¡¨è¾¾å¼çš„ ClassLoader çš„ class name


æ¡ˆä¾‹ï¼š

ä½¿ç”¨jadåç¼–è¯‘demo.MathGameè¾“å‡ºåˆ°&#x2F;root&#x2F;MathGame.java

## jad å‘½ä»¤åç¼–è¯‘[arthas@7339]$ jad demo.MathGame --source-only &gt; /root/MathGame.javaredirect output file will be: /root/MathGame.java


æ‰“å¼€æ–°çš„çª—å£ï¼Œä½¿ç”¨vim æ¥ä¿®æ”¹æºç 

vim &#x2F;root&#x2F;MathGame.java
       /*        * Decompiled with CFR.        */       package demo;       import java.util.ArrayList;       import java.util.List;       import java.util.Random;       import java.util.concurrent.TimeUnit;       public class MathGame &#123;           private static Random random = new Random();           private int illegalArgumentCount = 0;           public List&lt;Integer&gt; primeFactors(int number) &#123;/*44*/         if (number &lt; 2) &#123;/*45*/             ++this.illegalArgumentCount;                   throw new IllegalArgumentException(&quot;number is: &quot; + number + &quot;, need &gt;= 2&quot;);               &#125;               ArrayList&lt;Integer&gt; result = new ArrayList&lt;Integer&gt;();/*50*/         int i = 2;/*51*/         while (i &lt;= number) &#123;/*52*/             if (number % i == 0) &#123;/*53*/                 result.add(i);/*54*/                 number /= i;/*55*/                 i = 2;                       continue;                   &#125;/*57*/             ++i;               &#125;/*61*/         return result;           &#125;           public static void main(String[] args) throws InterruptedException &#123;               MathGame game = new MathGame();               while (true) &#123;/*16*/             game.run();/*17*/             TimeUnit.SECONDS.sleep(1L);                   System.out.println(&quot;åœ¨mainæ–¹æ³•å¾ªç¯ä½“å†…æ‰§è¡Œ&quot;);               &#125;           &#125;           public void run() throws InterruptedException &#123;                System.out.println(&quot;åœ¨runæ–¹æ³•ä¸­æ‰§è¡Œ&quot;);               try &#123;/*23*/             int number = random.nextInt() / 10000;/*24*/             List&lt;Integer&gt; primeFactors = this.primeFactors(number);/*25*/             MathGame.print(number, primeFactors);               &#125;               catch (Exception e) &#123;/*28*/             System.out.println(String.format(&quot;illegalArgumentCount:%3d, &quot;, this.illegalArgumentCount) + e.getMessage());               &#125;           &#125;           public static void print(int number, List&lt;Integer&gt; primeFactors) &#123;               StringBuffer sb = new StringBuffer(number + &quot;=&quot;);/*34*/         for (int factor : primeFactors) &#123;/*35*/             sb.append(factor).append(&#x27;*&#x27;);               &#125;/*37*/         if (sb.charAt(sb.length() - 1) == &#x27;*&#x27;) &#123;/*38*/             sb.deleteCharAt(sb.length() - 1);               &#125;/*40*/         System.out.println(sb);           &#125;       &#125;


mc å‘½ä»¤æ¥å†…å­˜ç¼–è¯‘ä¿®æ”¹è¿‡çš„ä»£ç 

[arthas@7339]$ mc /root/MathGame.java -d /rootMemory compiler output:/root/demo/MathGame.classAffect(row-cnt:1) cost in 253 ms.


ä½¿ç”¨redefineå‘½ä»¤åŠ è½½æ–°å­—èŠ‚ç æ–‡ä»¶

[arthas@7339]$ redefine /root/demo/MathGame.class redefine success, size: 1, classes:demo.MathGame


æ‰§è¡Œç»“æœ

190754=2*127*751160050=2*3*5*5*11*97171397=101*169769692=2*2*7*19*131illegalArgumentCount:8140, number is: -77511, need &gt;= 2illegalArgumentCount:8141, number is: -126748, need &gt;= 275490=2*5*7549illegalArgumentCount:8142, number is: -125543, need &gt;= 2illegalArgumentCount:8143, number is: -125902, need &gt;= 287103=8710373353=3*7*7*499189859=189859åœ¨runæ–¹æ³•ä¸­æ‰§è¡Œ28098=2*3*3*7*223åœ¨runæ–¹æ³•ä¸­æ‰§è¡ŒillegalArgumentCount:8144, number is: -45234, need &gt;= 2åœ¨runæ–¹æ³•ä¸­æ‰§è¡Œ78004=2*2*19501


6. dumpå‘½ä»¤dump å·²åŠ è½½ç±»çš„ bytecode åˆ°ç‰¹å®šç›®å½•ï¼Œ
dump å‘½ä»¤å°† JVM ä¸­å®é™…è¿è¡Œçš„ class çš„ byte code dump åˆ°æŒ‡å®šç›®å½•ï¼Œé€‚ç”¨åœºæ™¯æ‰¹é‡ä¸‹è½½æŒ‡å®šåŒ…ç›®å½•çš„ class å­—èŠ‚ç ï¼›å¦‚éœ€åç¼–è¯‘å•ä¸€ç±»ã€å®æ—¶æŸ¥çœ‹ç±»ä¿¡æ¯ï¼Œå¯å‚è€ƒÂ jadã€‚

å‚æ•°è¯´æ˜




å‚æ•°åç§°
å‚æ•°è¯´æ˜



class-pattern
ç±»åè¡¨è¾¾å¼åŒ¹é…


[c:]
ç±»æ‰€å± ClassLoader çš„ hashcode


[classLoaderClass:]
æŒ‡å®šæ‰§è¡Œè¡¨è¾¾å¼çš„ ClassLoader çš„ class name


[d:]
è®¾ç½®ç±»æ–‡ä»¶çš„ç›®æ ‡ç›®å½•


[E]
å¼€å¯æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œé»˜è®¤ä¸ºé€šé…ç¬¦åŒ¹


dump java.lang.String
[arthas@8161]$ dump java.lang.String HASHCODE  CLASSLOADER  LOCATION                                                                                                                                                                                                                                               null                   /root/logs/arthas/classdump/java/lang/String.class                                                                                                                                                                                                    Affect(row-cnt:1) cost in 45 ms.[arthas@8161]$ dump demo.* HASHCODE  CLASSLOADER                                                       LOCATION                                                                                                                                                                                          4b85612c  +-jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c        /root/logs/arthas/classdump/jdk.internal.loader.ClassLoaders$AppClassLoader-4b85612c/demo/MathGame.class                                                                                                      +-jdk.internal.loader.ClassLoaders$PlatformClassLoader@17bb5c0                                                                                                                                                                                                   Affect(row-cnt:1) cost in 22 ms.

7. classloaderå‘½ä»¤æŸ¥çœ‹ classloader çš„ç»§æ‰¿æ ‘ï¼Œurlsï¼Œç±»åŠ è½½ä¿¡æ¯
classloaderÂ å‘½ä»¤å°† JVM ä¸­æ‰€æœ‰çš„ classloader çš„ä¿¡æ¯ç»Ÿè®¡å‡ºæ¥ï¼Œå¹¶å¯ä»¥å±•ç¤ºç»§æ‰¿æ ‘ï¼Œurls ç­‰ã€‚
å¯ä»¥è®©æŒ‡å®šçš„ classloader å» getResourcesï¼Œæ‰“å°å‡ºæ‰€æœ‰æŸ¥æ‰¾åˆ°çš„ resources çš„ urlã€‚å¯¹äºResourceNotFoundExceptionæ¯”è¾ƒæœ‰ç”¨ã€‚

å‚æ•°è¯´æ˜




å‚æ•°åç§°
å‚æ•°è¯´æ˜



[l]
æŒ‰ç±»åŠ è½½å®ä¾‹è¿›è¡Œç»Ÿè®¡


[t]
æ‰“å°æ‰€æœ‰ ClassLoader çš„ç»§æ‰¿æ ‘


[a]
åˆ—å‡ºæ‰€æœ‰ ClassLoader åŠ è½½çš„ç±»ï¼Œè¯·è°¨æ…ä½¿ç”¨


[c:]
ClassLoader çš„ hashcode


[classLoaderClass:]
æŒ‡å®šæ‰§è¡Œè¡¨è¾¾å¼çš„ ClassLoader çš„ class name


[c: r:]
ç”¨ ClassLoader å»æŸ¥æ‰¾ resource


[c: load:]
ç”¨ ClassLoader å»åŠ è½½æŒ‡å®šçš„ç±»



ä½¿ç”¨å‚è€ƒ

æŒ‰ç±»åŠ è½½ç±»å‹æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯

  [arthas@8161]$ classloader name                                                  numberOfInstances  loadedCountTotal                                                                                                                                                                                     com.taobao.arthas.agent.ArthasClassloader             2                  4420                                                                                                                                                                                                 BootstrapClassLoader                                  1                  3487                                                                                                                                                                                                 jdk.internal.loader.ClassLoaders$PlatformClassLoader  1                  60                                                                                                                                                                                                   jdk.internal.reflect.DelegatingClassLoader            21                 21                                                                                                                                                                                                   jdk.internal.loader.ClassLoaders$AppClassLoader       1                  4                                                                                                                                                                                                   Affect(row-cnt:5) cost in 10 ms.

æŒ‰ç±»åŠ è½½å®ä¾‹æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯

  [arthas@8161]$ classloader -l name                                                          loadedCount  hash      parent                                                                                                                                                                                   BootstrapClassLoader                                          3487         null      null                                                                                                                                                                                     com.taobao.arthas.agent.ArthasClassloader@369500c6            2696         369500c6  jdk.internal.loader.ClassLoaders$PlatformClassLoader@17bb5c0                                                                                                                             com.taobao.arthas.agent.ArthasClassloader@6489d91             1727         6489d91   jdk.internal.loader.ClassLoaders$PlatformClassLoader@17bb5c0                                                                                                                             jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c      4            4b85612c  jdk.internal.loader.ClassLoaders$PlatformClassLoader@17bb5c0                                                                                                                             jdk.internal.loader.ClassLoaders$PlatformClassLoader@17bb5c0  60           17bb5c0   null                                                                                                                                                                                    Affect(row-cnt:5) cost in 10 ms.

æŸ¥çœ‹ ClassLoader çš„ç»§æ‰¿æ ‘

  [arthas@8161]$ classloader -t+-BootstrapClassLoader                                                                                                                                                                                                                                                        +-jdk.internal.loader.ClassLoaders$PlatformClassLoader@17bb5c0                                                                                                                                                                                                                  +-com.taobao.arthas.agent.ArthasClassloader@369500c6                                                                                                                                                                                                                          +-com.taobao.arthas.agent.ArthasClassloader@6489d91                                                                                                                                                                                                                           +-jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c                                                                                                                                                                                                                  Affect(row-cnt:5) cost in 13 ms.

æŸ¥çœ‹ URLClassLoader å®é™…çš„ urls

  [arthas@8161]$ classloader -c 369500c6file:/root/.arthas/lib/4.0.5/arthas/arthas-core.jar                                                                                                                                                                                                                           Affect(row-cnt:2) cost in 1 ms.

ä½¿ç”¨ ClassLoader å»æŸ¥æ‰¾ resource

  [arthas@8161]$ classloader -c 369500c6  -r META-INF/MANIFEST.MF jar:file:/root/.arthas/lib/4.0.5/arthas/arthas-core.jar!/META-INF/MANIFEST.MF                                                                                                                                                                                                Affect(row-cnt:1) cost in 1 ms.

ä¹Ÿå¯ä»¥å°è¯•æŸ¥æ‰¾ç±»çš„ class æ–‡ä»¶

  [arthas@8161]$ classloader -c 369500c6   -r java/lang/String.class jrt:/java.base/java/lang/String.class                                                                                                                                                                                                                                        Affect(row-cnt:1) cost in 1 ms.

ä½¿ç”¨ ClassLoader å»åŠ è½½ç±»

  [arthas@8161]$ classloader -c 369500c6 --load java.lang.Stringload class success. class-info        java.lang.String                                                                                                                                                                                                                                            code-source                                                                                                                                                                                                                                                                   name              java.lang.String                                                                                                                                                                                                                                            isInterface       false                                                                                                                                                                                                                                                       isAnnotation      false                                                                                                                                                                                                                                                       isEnum            false                                                                                                                                                                                                                                                       isAnonymousClass  false                                                                                                                                                                                                                                                       isArray           false                                                                                                                                                                                                                                                       isLocalClass      false                                                                                                                                                                                                                                                       isMemberClass     false                                                                                                                                                                                                                                                       isPrimitive       false                                                                                                                                                                                                                                                       isSynthetic       false                                                                                                                                                                                                                                                       simple-name       String                                                                                                                                                                                                                                                      modifier          final,public                                                                                                                                                                                                                                                annotation                                                                                                                                                                                                                                                                    interfaces        java.io.Serializable,java.lang.Comparable,java.lang.CharSequence                                                                                                                                                                                            super-class       +-java.lang.Object                                                                                                                                                                                                                                          class-loader                                                                                                                                                                                                                                                                  classLoaderHash   null     [arthas@8161]$ classloader -c 4b85612c --load demo.MathGameload class success. class-info        demo.MathGame                                                                                                                                                                                                                                               code-source       /usr/local/software/arthas/math-game.jar                                                                                                                                                                                                                    name              demo.MathGame                                                                                                                                                                                                                                               isInterface       false                                                                                                                                                                                                                                                       isAnnotation      false                                                                                                                                                                                                                                                       isEnum            false                                                                                                                                                                                                                                                       isAnonymousClass  false                                                                                                                                                                                                                                                       isArray           false                                                                                                                                                                                                                                                       isLocalClass      false                                                                                                                                                                                                                                                       isMemberClass     false                                                                                                                                                                                                                                                       isPrimitive       false                                                                                                                                                                                                                                                       isSynthetic       false                                                                                                                                                                                                                                                       simple-name       MathGame                                                                                                                                                                                                                                                    modifier          public                                                                                                                                                                                                                                                      annotation                                                                                                                                                                                                                                                                    interfaces                                                                                                                                                                                                                                                                    super-class       +-java.lang.Object                                                                                                                                                                                                                                          class-loader      +-jdk.internal.loader.ClassLoaders$AppClassLoader@4b85612c                                                                                                                                                                                                                      +-jdk.internal.loader.ClassLoaders$PlatformClassLoader@17bb5c0                                                                                                                                                                                            classLoaderHash   4b85612c   

]]></content>
      <categories>
        <category>Arthas</category>
      </categories>
      <tags>
        <tag>Arthas</tag>
        <tag>Arthasè¯Šæ–­å·¥å…·</tag>
      </tags>
  </entry>
  <entry>
    <title>VMè™šæ‹Ÿæœºè¯¦è§£(ä¸ƒ)**è™šæ‹Ÿæœºæ ˆVirtual Machine Stacks</title>
    <url>/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3(%E4%B8%83)%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A0%88Virtual%20Machine%20Stacks/</url>
    <content><![CDATA[JVMè™šæ‹Ÿæœºè¯¦è§£(ä¸ƒ)è™šæ‹Ÿæœºæ ˆVirtual Machine Stacks1. æ¦‚è¿°æ¯ä¸ª Java è™šæ‹Ÿæœºçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªä¸“ç”¨çš„ Java è™šæ‹Ÿæœºå †æ ˆï¼Œä¸çº¿ç¨‹åŒæ—¶åˆ›å»ºã€‚Java è™šæ‹Ÿæœºå †æ ˆå­˜å‚¨å¸§(2.6)ã€‚Java è™šæ‹Ÿæœºå †æ ˆç±»ä¼¼äºä¼ ç»Ÿè¯­è¨€(å¦‚ c)çš„å †æ ˆ: å®ƒä¿å­˜å±€éƒ¨å˜é‡å’Œéƒ¨åˆ†ç»“æœï¼Œå¹¶åœ¨æ–¹æ³•è°ƒç”¨å’Œè¿”å›ä¸­å‘æŒ¥ä½œç”¨ã€‚å› ä¸º Java è™šæ‹Ÿæœºå †æ ˆä»æ¥ä¸ä¼šè¢«ç›´æ¥æ“ä½œï¼Œé™¤äº†æ¨é€å’Œå¼¹å‡ºæ¡†æ¶ï¼Œæ¡†æ¶å¯èƒ½ä¼šè¢«åˆ†é…åˆ°å †ä¸­ã€‚Java è™šæ‹Ÿæœºå †æ ˆçš„å†…å­˜ä¸éœ€è¦æ˜¯è¿ç»­çš„ã€‚
åœ¨ Java è™šæ‹Ÿæœºè§„èŒƒçš„ç¬¬ä¸€ç‰ˆä¸­ï¼ŒJava è™šæ‹Ÿæœºå †æ ˆè¢«ç§°ä¸º Java å †æ ˆã€‚
è¯¥è§„èŒƒå…è®¸ Java è™šæ‹Ÿæœºå †æ ˆå…·æœ‰å›ºå®šçš„å¤§å°ï¼Œæˆ–è€…æ ¹æ®è®¡ç®—çš„éœ€è¦åŠ¨æ€æ‰©å±•å’Œæ”¶ç¼©ã€‚å¦‚æœ Java è™šæ‹Ÿæœºå †æ ˆçš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œé‚£ä¹ˆåœ¨åˆ›å»ºè¯¥å †æ ˆæ—¶å¯ä»¥ç‹¬ç«‹åœ°é€‰æ‹©æ¯ä¸ª Java è™šæ‹Ÿæœºå †æ ˆçš„å¤§å°ã€‚
ä¸€ä¸ª Java è™šæ‹Ÿæœºå®ç°å¯ä»¥ä¸ºç¨‹åºå‘˜æˆ–ç”¨æˆ·æä¾›å¯¹ Java è™šæ‹Ÿæœºå †æ ˆåˆå§‹å¤§å°çš„æ§åˆ¶ï¼Œä»¥åŠï¼Œåœ¨åŠ¨æ€æ‰©å±•æˆ–æ”¶ç¼© Java è™šæ‹Ÿæœºå †æ ˆçš„æƒ…å†µä¸‹ï¼Œå¯¹æœ€å¤§å’Œæœ€å°å¤§å°çš„æ§åˆ¶ã€‚

ä¸‹åˆ—å¼‚å¸¸æƒ…å†µä¸ Java è™šæ‹Ÿæœºå †æ ˆç›¸å…³:
å¦‚æœçº¿ç¨‹ä¸­çš„è®¡ç®—éœ€è¦æ¯”å…è®¸çš„æ›´å¤§çš„ Java è™šæ‹Ÿæœºå †æ ˆï¼Œåˆ™ Java è™šæ‹ŸæœºæŠ›å‡º StackOverflowErrorã€‚
å¦‚æœ Java è™šæ‹Ÿæœºå †æ ˆå¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œå¹¶ä¸”å°è¯•æ‰©å±•ï¼Œä½†æ˜¯æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜æ¥å®ç°æ‰©å±•ï¼Œæˆ–è€…å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜æ¥ä¸ºæ–°çº¿ç¨‹åˆ›å»ºåˆå§‹çš„ Java è™šæ‹Ÿæœºå †æ ˆï¼ŒJava è™šæ‹ŸæœºæŠ›å‡º OutOfMemoryErrorã€‚


é»˜è®¤å †å¤§å°ï¼š
Xmsï¼šåˆå§‹å¤§å°å†…å­˜ï¼Œé»˜è®¤ä¸ºç‰©ç†å†…å­˜64&#x2F;1ï¼Œç­‰ä»·äº-XX:InitialHeapSize
Xmxï¼šæœ€å¤§åˆ†é…å†…å­˜ï¼Œé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„4&#x2F;1ï¼Œç­‰ä»·äºï¼š-XXMaxHeapSize


é»˜è®¤æ ˆå¤§å°ï¼š
XX:ThreadStackSizeè®¾ä¸º0ï¼Œå°±æ˜¯ä½¿ç”¨â€œç³»ç»Ÿé»˜è®¤å€¼â€ã€‚è€Œåœ¨Linux x64ä¸ŠHotSpot VMç»™Javaæ ˆå®šä¹‰çš„â€œç³»ç»Ÿé»˜è®¤â€å¤§å°ä¹Ÿæ˜¯1MBã€‚



å®˜ç½‘ï¼šChapterÂ 2.Â The Structure of the Java Virtual Machine (oracle.com)

é¦–å…ˆæ ˆæ˜¯è¿è¡Œæ—¶çš„å•ä½ï¼Œè€Œå †æ˜¯å­˜å‚¨çš„å•ä½
æ ˆè§£å†³ç¨‹åºçš„è¿è¡Œé—®é¢˜ï¼Œå³ç¨‹åºå¦‚ä½•æ‰§è¡Œï¼Œæˆ–è€…è¯´å¦‚ä½•å¤„ç†æ•°æ®ã€‚

å †è§£å†³çš„æ˜¯æ•°æ®å­˜å‚¨çš„é—®é¢˜ï¼Œå³æ•°æ®æ€ä¹ˆæ”¾ï¼Œæ”¾å“ªé‡Œ
  




Javaè™šæ‹Ÿæœºæ ˆï¼ˆJava Virtual Machine Stackï¼‰ï¼Œæ—©æœŸä¹Ÿå«Javaæ ˆã€‚æ¯ä¸ªçº¿ç¨‹åœ¨åˆ›å»ºæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºæ ˆï¼Œå…¶å†…éƒ¨ä¿å­˜ä¸€ä¸ªä¸ªçš„æ ˆå¸§ï¼ˆStack Frameï¼‰ï¼Œå¯¹åº”ç€ä¸€æ¬¡æ¬¡çš„Javaæ–¹æ³•è°ƒç”¨ã€‚


ç”Ÿå‘½å‘¨æœŸ
  ç”Ÿå‘½å‘¨æœŸå’Œçº¿ç¨‹ä¸€è‡´ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹ç»“æŸäº†ï¼Œè¯¥è™šæ‹Ÿæœºæ ˆä¹Ÿé”€æ¯äº†

ä½œç”¨  - ä¸»ç®¡Javaç¨‹åºçš„è¿è¡Œï¼Œå®ƒä¿å­˜æ–¹æ³•çš„å±€éƒ¨å˜é‡ã€éƒ¨åˆ†ç»“æœï¼Œå¹¶å‚ä¸æ–¹æ³•çš„è°ƒç”¨å’Œè¿”å›ã€‚  - å±€éƒ¨å˜é‡ï¼Œå®ƒæ˜¯ç›¸æ¯”äºæˆå‘˜å˜é‡æ¥è¯´çš„ï¼ˆæˆ–å±æ€§ï¼‰  - åŸºæœ¬æ•°æ®ç±»å‹å˜é‡ VS å¼•ç”¨ç±»å‹å˜é‡ï¼ˆç±»ã€æ•°ç»„ã€æ¥å£ï¼‰
è™šæ‹Ÿæœºæ ˆçš„ç‰¹ç‚¹

æ ˆæ˜¯ä¸€ç§å¿«é€Ÿæœ‰æ•ˆçš„åˆ†é…å­˜å‚¨æ–¹å¼ï¼Œè®¿é—®é€Ÿåº¦ä»…æ¬¡äºç¨‹åºè®¡æ•°å™¨ã€‚
JVMç›´æ¥å¯¹Javaæ ˆçš„æ“ä½œåªæœ‰ä¸¤ä¸ªï¼š
æ¯ä¸ªæ–¹æ³•æ‰§è¡Œï¼Œä¼´éšç€è¿›æ ˆï¼ˆå…¥æ ˆã€å‹æ ˆï¼‰
æ‰§è¡Œç»“æŸåçš„å‡ºæ ˆå·¥ä½œ




å¯¹äºæ ˆæ¥è¯´ä¸å­˜åœ¨åƒåœ¾å›æ”¶é—®é¢˜

æ ˆä¸éœ€è¦GCï¼Œä½†æ˜¯å¯èƒ½å­˜åœ¨OOM

  
  

è®¾ç½®æ ˆå†…å­˜å¤§å°

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‚æ•°Â -XssÂ é€‰é¡¹æ¥è®¾ç½®çº¿ç¨‹çš„æœ€å¤§æ ˆç©ºé—´ï¼Œæ ˆçš„å¤§å°ç›´æ¥å†³å®šäº†å‡½æ•°è°ƒç”¨çš„æœ€å¤§å¯è¾¾æ·±åº¦ã€‚


Sets the thread stack size (in bytes). Append the letterÂ kÂ orÂ KÂ to indicate KB,Â mÂ orÂ MÂ to indicate MB, andÂ gÂ orÂ GÂ to indicate GB. The default value depends on the platform:

Linux&#x2F;x64 (64-bit): 1024 KB
macOS (64-bit): 1024 KB
Oracle Solaris&#x2F;x64 (64-bit): 1024 KB
Windows: The default value depends on virtual memory


  The following examples set the thread stack size to 1024 KB in different units:
  -Xss1m-Xss1024k-Xss1048576

ä¸¾ä¾‹ï¼š
  package com.peppa.stack;/** * æ¼”ç¤ºæ ˆä¸­çš„å¼‚å¸¸ï¼šStackOverflowError * @author: peppa * @create: 2022-02-10 15:35:20 */public class StackErrorTest &#123;    private static int count = 1;    /**     * é»˜è®¤å‚æ•°ï¼šå½“æ ˆæ·±åº¦è¾¾åˆ°ï¼š9826ï¼Œå‡ºç°å†…å­˜ç©ºé—´ä¸è¶³ã€‚æŠ¥é”™ï¼šException in thread &quot;main&quot; java.lang.StackOverflowError     * æ·»åŠ å‚æ•°ï¼š-Xss128kï¼Œå½“æ ˆæ·±åº¦è¾¾åˆ°ï¼š982ã€‚æŠ¥é”™ï¼šException in thread &quot;main&quot; java.lang.StackOverflowError     * 	at java.io.PrintStream.write(PrintStream.java:526)     * 	at java.io.PrintStream.print(PrintStream.java:597)     * 	at java.io.PrintStream.println(PrintStream.java:736)     * @param args     */    public static void main(String[] args) &#123;        System.out.println(count++);        main(args);    &#125;&#125;

2.æ ˆçš„å­˜å‚¨å•ä½
æ ˆä¸­å­˜å‚¨ä»€ä¹ˆï¼Ÿ

æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æ ˆï¼Œæ ˆä¸­çš„æ•°æ®éƒ½æ˜¯ä»¥æ ˆå¸§ï¼ˆStack Frameï¼‰çš„æ ¼å¼å­˜åœ¨ã€‚
åœ¨è¿™ä¸ªçº¿ç¨‹ä¸Šæ­£åœ¨æ‰§è¡Œçš„æ¯ä¸ªæ–¹æ³•éƒ½å„è‡ªå¯¹åº”ä¸€ä¸ªæ ˆå¸§ï¼ˆStack Frameï¼‰ã€‚
æ ˆå¸§æ˜¯ä¸€ä¸ªå†…å­˜åŒºå—ï¼Œæ˜¯ä¸€ä¸ªæ•°æ®é›†ï¼Œç»´ç³»ç€æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å„ç§æ•°æ®ä¿¡æ¯ã€‚


æ ˆè¿è¡ŒåŸç†

JVMç›´æ¥å¯¹Javaæ ˆçš„æ“ä½œåªæœ‰ä¸¤ä¸ªï¼Œå°±æ˜¯å¯¹æ ˆå¸§çš„å‹æ ˆå’Œå‡ºæ ˆï¼Œéµå¾ªå…ˆè¿›åå‡ºï¼ˆåè¿›å…ˆå‡ºï¼‰åŸåˆ™
åœ¨ä¸€æ¡æ´»åŠ¨çº¿ç¨‹ä¸­ï¼Œä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œåªä¼šæœ‰ä¸€ä¸ªæ´»åŠ¨çš„æ ˆå¸§ã€‚å³åªæœ‰å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•çš„æ ˆå¸§ï¼ˆæ ˆé¡¶æ ˆå¸§ï¼‰æ˜¯æœ‰æ•ˆçš„ã€‚è¿™ä¸ªæ ˆå¸§è¢«ç§°ä¸ºå½“å‰æ ˆå¸§ï¼ˆCurrent Frameï¼‰ï¼Œä¸å½“å‰æ ˆå¸§ç›¸å¯¹åº”çš„æ–¹æ³•å°±æ˜¯å½“å‰æ–¹æ³•ï¼ˆCurrent Methodï¼‰ï¼Œå®šä¹‰è¿™ä¸ªæ–¹æ³•çš„ç±»å°±æ˜¯å½“å‰ç±»ï¼ˆCurrent Classï¼‰
æ‰§è¡Œå¼•æ“è¿è¡Œçš„æ‰€æœ‰å­—èŠ‚ç æŒ‡ä»¤åªé’ˆå¯¹å½“å‰æ ˆå¸§è¿›è¡Œæ“ä½œã€‚
å¦‚æœåœ¨è¯¥æ–¹æ³•ä¸­è°ƒç”¨äº†å…¶ä»–æ–¹æ³•ï¼Œå¯¹åº”çš„æ–°çš„æ ˆå¸§ä¼šè¢«åˆ›å»ºå‡ºæ¥ï¼Œæ”¾åœ¨æ ˆçš„é¡¶ç«¯ï¼Œæˆä¸ºæ–°çš„å½“å‰å¸§ã€‚
ä¸åŒçº¿ç¨‹ä¸­æ‰€åŒ…å«çš„æ ˆå¸§æ˜¯ä¸å…è®¸å­˜åœ¨ç›¸äº’å¼•ç”¨çš„ï¼Œå³ä¸å¯èƒ½åœ¨ä¸€ä¸ªæ ˆå¸§ä¹‹ä¸­å¼•ç”¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„æ ˆå¸§ã€‚
å¦‚æœå½“å‰æ–¹æ³•è°ƒç”¨äº†å…¶ä»–æ–¹æ³•ï¼Œæ–¹æ³•è¿”å›ä¹‹é™…ï¼Œå½“å‰æ ˆå¸§ä¼šä¼ å›æ­¤æ–¹æ³•çš„æ‰§è¡Œç»“æœç»™å‰ä¸€ä¸ªæ ˆå¸§ï¼Œæ¥ç€ï¼Œè™šæ‹Ÿæœºä¼šä¸¢å¼ƒå½“å‰æ ˆå¸§ï¼Œä½¿å¾—å‰ä¸€ä¸ªæ ˆå¸§é‡æ–°æˆä¸ºå½“å‰æ ˆå¸§ã€‚
Javaæ–¹æ³•æœ‰ä¸¤ç§è¿”å›å‡½æ•°çš„æ–¹å¼ã€‚
ä¸€ç§æ˜¯æ­£å¸¸çš„å‡½æ•°è¿”å›ï¼Œä½¿ç”¨returnæŒ‡ä»¤ã€‚
å¦ä¸€ç§æ˜¯æ–¹æ³•æ‰§è¡Œä¸­å‡ºç°æœªæ•è·å¤„ç†çš„å¼‚å¸¸ï¼Œä»¥æŠ›å‡ºå¼‚å¸¸çš„æ–¹å¼ç»“æŸã€‚
ä½†ä¸ç®¡ä½¿ç”¨å“ªç§æ–¹å¼ï¼Œéƒ½ä¼šå¯¼è‡´æ ˆå¸§è¢«å¼¹å‡ºã€‚



  
  

æ ˆå¸§çš„å†…éƒ¨ç»“æ„
  æ¯ä¸ªæ ˆå¸§ä¸­å­˜å‚¨ç€ï¼š

å±€éƒ¨å˜é‡è¡¨ï¼ˆLocal Variablesï¼‰

æ“ä½œæ•°æ ˆï¼ˆoperand Stackï¼‰ï¼ˆæˆ–è¡¨è¾¾å¼æ ˆï¼‰

åŠ¨æ€é“¾æ¥ï¼ˆDynamicLinkingï¼‰ï¼ˆæˆ–æŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„æ–¹æ³•å¼•ç”¨ï¼‰

æ–¹æ³•è¿”å›åœ°å€ï¼ˆReturn Addressï¼‰ï¼ˆæˆ–æ–¹æ³•æ­£å¸¸é€€å‡ºæˆ–è€…å¼‚å¸¸é€€å‡ºçš„å®šä¹‰ï¼‰

ä¸€äº›é™„åŠ ä¿¡æ¯
  
  å¹¶è¡Œæ¯ä¸ªçº¿ç¨‹ä¸‹çš„æ ˆéƒ½æ˜¯ç§æœ‰çš„ï¼Œå› æ­¤æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±å„è‡ªçš„æ ˆï¼Œå¹¶ä¸”æ¯ä¸ªæ ˆé‡Œé¢éƒ½æœ‰å¾ˆå¤šæ ˆå¸§ï¼Œæ ˆå¸§çš„å¤§å°ä¸»è¦ç”±å±€éƒ¨å˜é‡è¡¨ å’Œ æ“ä½œæ•°æ ˆå†³å®šçš„
  




3.å±€éƒ¨å˜é‡è¡¨
æ¦‚è¿°ï¼š

å±€éƒ¨å˜é‡è¡¨ä¹Ÿè¢«ç§°ä¹‹ä¸ºå±€éƒ¨å˜é‡æ•°ç»„æˆ–æœ¬åœ°å˜é‡è¡¨
å®šä¹‰ä¸ºä¸€ä¸ªæ•°å­—æ•°ç»„ï¼Œä¸»è¦ç”¨äºå­˜å‚¨æ–¹æ³•å‚æ•°å’Œå®šä¹‰åœ¨æ–¹æ³•ä½“å†…çš„å±€éƒ¨å˜é‡ï¼Œè¿™äº›æ•°æ®ç±»å‹åŒ…æ‹¬å„ç±»åŸºæœ¬æ•°æ®ç±»å‹ã€å¯¹è±¡å¼•ç”¨ï¼ˆreferenceï¼‰ï¼Œä»¥åŠreturnAddressè¿”å›å€¼ç±»å‹ã€‚
ç”±äºå±€éƒ¨å˜é‡è¡¨æ˜¯å»ºç«‹åœ¨çº¿ç¨‹çš„æ ˆä¸Šï¼Œæ˜¯çº¿ç¨‹çš„ç§æœ‰æ•°æ®ï¼Œå› æ­¤ä¸å­˜åœ¨æ•°æ®å®‰å…¨é—®é¢˜
å±€éƒ¨å˜é‡è¡¨æ‰€éœ€çš„å®¹é‡å¤§å°æ˜¯åœ¨ç¼–è¯‘æœŸç¡®å®šä¸‹æ¥çš„ï¼Œå¹¶ä¿å­˜åœ¨æ–¹æ³•çš„Codeå±æ€§çš„maximum local variablesæ•°æ®é¡¹ä¸­ã€‚åœ¨æ–¹æ³•è¿è¡ŒæœŸé—´æ˜¯ä¸ä¼šæ”¹å˜å±€éƒ¨å˜é‡è¡¨çš„å¤§å°çš„ã€‚
æ–¹æ³•åµŒå¥—è°ƒç”¨çš„æ¬¡æ•°ç”±æ ˆçš„å¤§å°å†³å®šã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ ˆè¶Šå¤§ï¼Œæ–¹æ³•åµŒå¥—è°ƒç”¨æ¬¡æ•°è¶Šå¤šã€‚
å¯¹ä¸€ä¸ªå‡½æ•°è€Œè¨€ï¼Œå®ƒçš„å‚æ•°å’Œå±€éƒ¨å˜é‡è¶Šå¤šï¼Œä½¿å¾—å±€éƒ¨å˜é‡è¡¨è†¨èƒ€ï¼Œå®ƒçš„æ ˆå¸§å°±è¶Šå¤§ï¼Œä»¥æ»¡è¶³æ–¹æ³•è°ƒç”¨æ‰€éœ€ä¼ é€’çš„ä¿¡æ¯å¢å¤§çš„éœ€æ±‚ã€‚
è¿›è€Œå‡½æ•°è°ƒç”¨å°±ä¼šå ç”¨æ›´å¤šçš„æ ˆç©ºé—´ï¼Œå¯¼è‡´å…¶åµŒå¥—è°ƒç”¨æ¬¡æ•°å°±ä¼šå‡å°‘ã€‚


å±€éƒ¨å˜é‡è¡¨ä¸­çš„å˜é‡åªåœ¨å½“å‰æ–¹æ³•è°ƒç”¨ä¸­æœ‰æ•ˆã€‚
åœ¨æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œè™šæ‹Ÿæœºé€šè¿‡ä½¿ç”¨å±€éƒ¨å˜é‡è¡¨å®Œæˆå‚æ•°å€¼åˆ°å‚æ•°å˜é‡åˆ—è¡¨çš„ä¼ é€’è¿‡ç¨‹ã€‚
å½“æ–¹æ³•è°ƒç”¨ç»“æŸåï¼Œéšç€æ–¹æ³•æ ˆå¸§çš„é”€æ¯ï¼Œå±€éƒ¨å˜é‡è¡¨ä¹Ÿä¼šéšä¹‹é”€æ¯ã€‚




å…³äºSlotçš„ç†è§£

å‚æ•°å€¼çš„å­˜æ”¾æ€»æ˜¯åœ¨å±€éƒ¨å˜é‡æ•°ç»„çš„index0å¼€å§‹ï¼Œåˆ°æ•°ç»„é•¿åº¦-1çš„ç´¢å¼•ç»“æŸã€‚

å±€éƒ¨å˜é‡è¡¨ï¼Œæœ€åŸºæœ¬çš„å­˜å‚¨å•å…ƒæ˜¯Slotï¼ˆå˜é‡æ§½ï¼‰å±€éƒ¨å˜é‡è¡¨ä¸­å­˜æ”¾ç¼–è¯‘æœŸå¯çŸ¥çš„å„ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆ8ç§ï¼‰ï¼Œå¼•ç”¨ç±»å‹ï¼ˆreferenceï¼‰ï¼ŒreturnAddressç±»å‹çš„å˜é‡ã€‚

åœ¨å±€éƒ¨å˜é‡è¡¨é‡Œï¼Œ32ä½ä»¥å†…çš„ç±»å‹åªå ç”¨ä¸€ä¸ªslotï¼ˆåŒ…æ‹¬returnAddressç±»å‹ï¼‰ï¼Œ64ä½çš„ç±»å‹ï¼ˆ1ongå’Œdoubleï¼‰å ç”¨ä¸¤ä¸ªslotã€‚

byteã€shortã€char åœ¨å­˜å‚¨å‰è¢«è½¬æ¢ä¸ºintï¼Œbooleanä¹Ÿè¢«è½¬æ¢ä¸ºintï¼Œ0è¡¨ç¤ºfalseï¼Œé0è¡¨ç¤ºtrueã€‚ 1ongå’Œdoubleåˆ™å æ®ä¸¤ä¸ªslotã€‚


JVMä¼šä¸ºå±€éƒ¨å˜é‡è¡¨ä¸­çš„æ¯ä¸€ä¸ªSlotéƒ½åˆ†é…ä¸€ä¸ªè®¿é—®ç´¢å¼•ï¼Œé€šè¿‡è¿™ä¸ªç´¢å¼•å³å¯æˆåŠŸè®¿é—®åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­æŒ‡å®šçš„å±€éƒ¨å˜é‡å€¼ï¼Œå½“ä¸€ä¸ªå®ä¾‹æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå®ƒçš„æ–¹æ³•å‚æ•°å’Œæ–¹æ³•ä½“å†…éƒ¨å®šä¹‰çš„å±€éƒ¨å˜é‡å°†ä¼šæŒ‰ç…§é¡ºåºè¢«å¤åˆ¶åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­çš„æ¯ä¸€ä¸ªslotä¸Šï¼Œå¦‚æœéœ€è¦è®¿é—®å±€éƒ¨å˜é‡è¡¨ä¸­ä¸€ä¸ª64bitçš„å±€éƒ¨å˜é‡å€¼æ—¶ï¼Œåªéœ€è¦ä½¿ç”¨å‰ä¸€ä¸ªç´¢å¼•å³å¯ã€‚ï¼ˆæ¯”å¦‚ï¼šè®¿é—®1ongæˆ–doub1eç±»å‹å˜é‡ï¼‰

å¦‚æœå½“å‰å¸§æ˜¯ç”±æ„é€ æ–¹æ³•æˆ–è€…å®ä¾‹æ–¹æ³•åˆ›å»ºçš„ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡å¼•ç”¨thiså°†ä¼šå­˜æ”¾åœ¨indexä¸º0çš„s1otå¤„ï¼Œå…¶ä½™çš„å‚æ•°æŒ‰ç…§å‚æ•°è¡¨é¡ºåºç»§ç»­æ’åˆ—ã€‚
  



Slotçš„é‡å¤åˆ©ç”¨
  æ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡è¡¨ä¸­çš„æ§½ä½æ˜¯å¯ä»¥é‡ç”¨çš„ï¼Œå¦‚æœä¸€ä¸ªå±€éƒ¨å˜é‡è¿‡äº†å…¶ä½œç”¨åŸŸï¼Œé‚£ä¹ˆåœ¨å…¶ä½œç”¨åŸŸä¹‹åç”³æ˜çš„æ–°çš„å±€éƒ¨å˜å°±å¾ˆæœ‰å¯èƒ½ä¼šå¤ç”¨è¿‡æœŸå±€éƒ¨å˜é‡çš„æ§½ä½ï¼Œä»è€Œè¾¾åˆ°èŠ‚çœèµ„æºçš„ç›®çš„ã€‚
  public void test4() &#123;        int a = 0;        &#123;            int b = 0;            b = a + 1;        &#125;        // å˜é‡cä½¿ç”¨ä¹‹å‰å·²ç»é”€æ¯çš„å˜é‡bå æ®çš„slotçš„ä½ç½®        int c = a + 1;    &#125;
  å±€éƒ¨å˜é‡ c é‡ç”¨äº†å±€éƒ¨å˜é‡ b çš„ slot ä½ç½®
  

é™æ€å˜é‡ä¸å±€éƒ¨å˜é‡çš„å¯¹æ¯”

æŒ‰æ•°æ®ç±»å‹åˆ†ï¼šåŸºæœ¬æ•°æ®ç±»å‹ã€å¼•ç”¨æ•°æ®ç±»å‹

æŒ‰ç±»ä¸­å£°æ˜çš„ä½ç½®åˆ†ï¼šæˆå‘˜å˜é‡ï¼ˆç±»å˜é‡ï¼Œå®ä¾‹å˜é‡ï¼‰ã€å±€éƒ¨å˜é‡

ç±»å˜é‡ï¼šlinkingçš„paperé˜¶æ®µï¼Œç»™ç±»å˜é‡é»˜è®¤èµ‹å€¼ï¼Œinité˜¶æ®µç»™ç±»å˜é‡æ˜¾ç¤ºèµ‹å€¼å³é™æ€ä»£ç å—
å®ä¾‹å˜é‡ï¼šéšç€å¯¹è±¡åˆ›å»ºï¼Œä¼šåœ¨å †ç©ºé—´ä¸­åˆ†é…å®ä¾‹å˜é‡ç©ºé—´ï¼Œå¹¶è¿›è¡Œé»˜è®¤èµ‹å€¼
å±€éƒ¨å˜é‡ï¼šåœ¨ä½¿ç”¨å‰å¿…é¡»è¿›è¡Œæ˜¾å¼èµ‹å€¼ï¼Œä¸ç„¶ç¼–è¯‘ä¸é€šè¿‡ã€‚


å‚æ•°è¡¨åˆ†é…å®Œæ¯•ä¹‹åï¼Œå†æ ¹æ®æ–¹æ³•ä½“å†…å®šä¹‰çš„å˜é‡çš„é¡ºåºå’Œä½œç”¨åŸŸåˆ†é…ã€‚
  æˆ‘ä»¬çŸ¥é“ç±»å˜é‡è¡¨æœ‰ä¸¤æ¬¡åˆå§‹åŒ–çš„æœºä¼šï¼Œç¬¬ä¸€æ¬¡æ˜¯åœ¨â€œå‡†å¤‡é˜¶æ®µâ€ï¼Œæ‰§è¡Œç³»ç»Ÿåˆå§‹åŒ–ï¼Œå¯¹ç±»å˜é‡è®¾ç½®é›¶å€¼ï¼Œå¦ä¸€æ¬¡åˆ™æ˜¯åœ¨â€œåˆå§‹åŒ–â€é˜¶æ®µï¼Œèµ‹äºˆç¨‹åºå‘˜åœ¨ä»£ç ä¸­å®šä¹‰çš„åˆå§‹å€¼ã€‚
  å’Œç±»å˜é‡åˆå§‹åŒ–ä¸åŒçš„æ˜¯ï¼Œå±€éƒ¨å˜é‡è¡¨ä¸å­˜åœ¨ç³»ç»Ÿåˆå§‹åŒ–çš„è¿‡ç¨‹ï¼Œè¿™æ„å‘³ç€ä¸€æ—¦å®šä¹‰äº†å±€éƒ¨å˜é‡åˆ™å¿…é¡»äººä¸ºçš„åˆå§‹åŒ–ï¼Œå¦åˆ™æ— æ³•ä½¿ç”¨ã€‚

è¡¥å……è¯´æ˜
  åœ¨æ ˆå¸§ä¸­ï¼Œä¸æ€§èƒ½è°ƒä¼˜å…³ç³»æœ€ä¸ºå¯†åˆ‡çš„éƒ¨åˆ†å°±æ˜¯å‰é¢æåˆ°çš„å±€éƒ¨å˜é‡è¡¨ã€‚åœ¨æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œè™šæ‹Ÿæœºä½¿ç”¨å±€éƒ¨å˜é‡è¡¨å®Œæˆæ–¹æ³•çš„ä¼ é€’ã€‚
  å±€éƒ¨å˜é‡è¡¨ä¸­çš„å˜é‡ä¹Ÿæ˜¯é‡è¦çš„åƒåœ¾å›æ”¶æ ¹èŠ‚ç‚¹ï¼Œåªè¦è¢«å±€éƒ¨å˜é‡è¡¨ä¸­ç›´æ¥æˆ–é—´æ¥å¼•ç”¨çš„å¯¹è±¡éƒ½ä¸ä¼šè¢«å›æ”¶ã€‚




4.æ“ä½œæ•°æ ˆæ“ä½œæ•°æ ˆï¼šOperand Stack

æ“ä½œæ•°æ ˆçš„ç‰¹ç‚¹

æ¯ä¸€ä¸ªç‹¬ç«‹çš„æ ˆå¸§é™¤äº†åŒ…å«å±€éƒ¨å˜é‡è¡¨ä»¥å¤–ï¼Œè¿˜åŒ…å«ä¸€ä¸ªåè¿›å…ˆå‡ºï¼ˆLast - In - First -Outï¼‰çš„ æ“ä½œæ•°æ ˆï¼Œä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºè¡¨è¾¾å¼æ ˆï¼ˆExpression Stackï¼‰

æ“ä½œæ•°æ ˆï¼Œåœ¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®å­—èŠ‚ç æŒ‡ä»¤ï¼Œå¾€æ ˆä¸­å†™å…¥æ•°æ®æˆ–æå–æ•°æ®ï¼Œå³å…¥æ ˆï¼ˆpushï¼‰å’Œ å‡ºæ ˆï¼ˆpopï¼‰

æŸäº›å­—èŠ‚ç æŒ‡ä»¤å°†å€¼å‹å…¥æ“ä½œæ•°æ ˆï¼Œå…¶ä½™çš„å­—èŠ‚ç æŒ‡ä»¤å°†æ“ä½œæ•°å–å‡ºæ ˆã€‚ä½¿ç”¨å®ƒä»¬åå†æŠŠç»“æœå‹å…¥æ ˆï¼Œ
æ¯”å¦‚ï¼šæ‰§è¡Œå¤åˆ¶ã€äº¤æ¢ã€æ±‚å’Œç­‰æ“ä½œ

 
 


  æ“ä½œæ•°æ ˆï¼Œä¸»è¦ç”¨äºä¿å­˜è®¡ç®—è¿‡ç¨‹çš„ä¸­é—´ç»“æœï¼ŒåŒæ—¶ä½œä¸ºè®¡ç®—è¿‡ç¨‹ä¸­å˜é‡ä¸´æ—¶çš„å­˜å‚¨ç©ºé—´ã€‚
  æ“ä½œæ•°æ ˆå°±æ˜¯JVMæ‰§è¡Œå¼•æ“çš„ä¸€ä¸ªå·¥ä½œåŒºï¼Œå½“ä¸€ä¸ªæ–¹æ³•åˆšå¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸€ä¸ªæ–°çš„æ ˆå¸§ä¹Ÿä¼šéšä¹‹è¢«åˆ›å»ºå‡ºæ¥ï¼Œè¿™ä¸ªæ–¹æ³•çš„æ“ä½œæ•°æ ˆæ˜¯ç©ºçš„ã€‚.

è¿™ä¸ªæ—¶å€™æ•°ç»„æ˜¯æœ‰é•¿åº¦çš„ï¼Œå› ä¸ºæ•°ç»„ä¸€æ—¦åˆ›å»ºï¼Œé‚£ä¹ˆå°±æ˜¯ä¸å¯å˜çš„

  æ¯ä¸€ä¸ªæ“ä½œæ•°æ ˆéƒ½ä¼šæ‹¥æœ‰ä¸€ä¸ªæ˜ç¡®çš„æ ˆæ·±åº¦ç”¨äºå­˜å‚¨æ•°å€¼ï¼Œå…¶æ‰€éœ€çš„æœ€å¤§æ·±åº¦åœ¨ç¼–è¯‘æœŸå°±å®šä¹‰å¥½äº†ï¼Œä¿å­˜åœ¨æ–¹æ³•çš„Codeå±æ€§ä¸­ï¼Œä¸ºmaxstackçš„å€¼ã€‚
  æ ˆä¸­çš„ä»»ä½•ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯å¯ä»¥ä»»æ„çš„Javaæ•°æ®ç±»å‹

32bitçš„ç±»å‹å ç”¨ä¸€ä¸ªæ ˆå•ä½æ·±åº¦
64bitçš„ç±»å‹å ç”¨ä¸¤ä¸ªæ ˆå•ä½æ·±åº¦

  æ“ä½œæ•°æ ˆå¹¶éé‡‡ç”¨è®¿é—®ç´¢å¼•çš„æ–¹å¼æ¥è¿›è¡Œæ•°æ®è®¿é—®çš„ï¼Œè€Œæ˜¯åªèƒ½é€šè¿‡æ ‡å‡†çš„å…¥æ ˆå’Œå‡ºæ ˆæ“ä½œæ¥å®Œæˆä¸€æ¬¡æ•°æ®è®¿é—®
  å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•å¸¦æœ‰è¿”å›å€¼çš„è¯ï¼Œå…¶è¿”å›å€¼å°†ä¼šè¢«å‹å…¥å½“å‰æ ˆå¸§çš„æ“ä½œæ•°æ ˆä¸­ï¼Œå¹¶æ›´æ–°PCå¯„å­˜å™¨ä¸­ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€‚
  æ“ä½œæ•°æ ˆä¸­å…ƒç´ çš„æ•°æ®ç±»å‹å¿…é¡»ä¸å­—èŠ‚ç æŒ‡ä»¤çš„åºåˆ—ä¸¥æ ¼åŒ¹é…ï¼Œè¿™ç”±ç¼–è¯‘å™¨åœ¨ç¼–è¯‘å™¨æœŸé—´è¿›è¡ŒéªŒè¯ï¼ŒåŒæ—¶åœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„ç±»æ£€éªŒé˜¶æ®µçš„æ•°æ®æµåˆ†æé˜¶æ®µè¦å†æ¬¡éªŒè¯ã€‚|
  å¦å¤–ï¼Œæˆ‘ä»¬è¯´Javaè™šæ‹Ÿæœºçš„è§£é‡Šå¼•æ“æ˜¯åŸºäºæ ˆçš„æ‰§è¡Œå¼•æ“ï¼Œå…¶ä¸­çš„æ ˆæŒ‡çš„å°±æ˜¯æ“ä½œæ•°æ ˆã€‚
  

ä»£ç è¿½è¸ª
  public void testAddOperation() &#123;    byte i = 15;    int j = 8;    int k = i + j;&#125;
  ä½¿ç”¨javap å‘½ä»¤åç¼–è¯‘classæ–‡ä»¶ï¼š javap -v ç±»å.class
  
  byteã€shortã€charã€boolean å†…éƒ¨éƒ½æ˜¯ä½¿ç”¨intå‹æ¥è¿›è¡Œä¿å­˜çš„
  ä»ä¸Šé¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œæˆ‘ä»¬éƒ½æ˜¯é€šè¿‡bipushå¯¹æ“ä½œæ•° 15 å’Œ 8è¿›è¡Œå…¥æ ˆæ“ä½œ
  åŒæ—¶ä½¿ç”¨çš„æ˜¯ iaddæ–¹æ³•è¿›è¡Œç›¸åŠ æ“ä½œï¼Œi -&gt; ä»£è¡¨çš„å°±æ˜¯ intï¼Œä¹Ÿå°±æ˜¯intç±»å‹çš„åŠ æ³•æ“ä½œ

ä¸€æ­¥ä¸€æ­¥çœ‹æµç¨‹

é¦–å…ˆæ‰§è¡Œç¬¬ä¸€æ¡è¯­å¥ï¼ŒPCå¯„å­˜å™¨æŒ‡å‘çš„æ˜¯0ï¼Œä¹Ÿå°±æ˜¯æŒ‡ä»¤åœ°å€ä¸º0ï¼Œç„¶åä½¿ç”¨bipushè®©æ“ä½œæ•°15å…¥æ“ä½œæ•°æ ˆã€‚

  
  æ‰§è¡Œå®Œåï¼Œè®©PC + 1ï¼ŒæŒ‡å‘ä¸‹ä¸€è¡Œä»£ç ï¼Œä¸‹ä¸€è¡Œä»£ç å°±æ˜¯å°†æ“ä½œæ•°æ ˆçš„å…ƒç´ å­˜å‚¨åˆ°å±€éƒ¨å˜é‡è¡¨1çš„ä½ç½®ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å±€éƒ¨å˜é‡è¡¨çš„å·²ç»å¢åŠ äº†ä¸€ä¸ªå…ƒç´ 
  
  ä¸ºä»€ä¹ˆå±€éƒ¨å˜é‡è¡¨ä¸æ˜¯ä»0å¼€å§‹çš„å‘¢ï¼Ÿ
  å…¶å®å±€éƒ¨å˜é‡è¡¨ä¹Ÿæ˜¯ä»0å¼€å§‹çš„ï¼Œä½†æ˜¯å› ä¸º0å·ä½ç½®å­˜å‚¨çš„æ˜¯thisæŒ‡é’ˆï¼Œæ‰€ä»¥è¯´å°±ç›´æ¥çœç•¥äº†~
  ç„¶åPC+1ï¼ŒæŒ‡å‘çš„æ˜¯ä¸‹ä¸€è¡Œã€‚è®©æ“ä½œæ•°8ä¹Ÿå…¥æ ˆï¼ŒåŒæ—¶æ‰§è¡Œstoreæ“ä½œï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨ä¸­
  
  
  ç„¶åä»å±€éƒ¨å˜é‡è¡¨ä¸­ï¼Œä¾æ¬¡å°†æ•°æ®æ”¾åœ¨æ“ä½œæ•°æ ˆä¸­
  
  
  ç„¶åå°†æ“ä½œæ•°æ ˆä¸­çš„ä¸¤ä¸ªå…ƒç´ æ‰§è¡Œç›¸åŠ æ“ä½œï¼Œå¹¶å­˜å‚¨åœ¨å±€éƒ¨å˜é‡è¡¨3çš„ä½ç½®
  
  
  æœ€åPCå¯„å­˜å™¨çš„ä½ç½®æŒ‡å‘10ï¼Œä¹Ÿå°±æ˜¯returnæ–¹æ³•ï¼Œåˆ™ç›´æ¥é€€å‡ºæ–¹æ³•
  

æ ˆé¡¶ç¼“å­˜æŠ€æœ¯
  æ ˆé¡¶ç¼“å­˜æŠ€æœ¯ï¼šTop Of Stack Cashing
  å‰é¢æè¿‡ï¼ŒåŸºäºæ ˆå¼æ¶æ„çš„è™šæ‹Ÿæœºæ‰€ä½¿ç”¨çš„é›¶åœ°å€æŒ‡ä»¤æ›´åŠ ç´§å‡‘ï¼Œä½†å®Œæˆä¸€é¡¹æ“ä½œçš„æ—¶å€™å¿…ç„¶éœ€è¦ä½¿ç”¨æ›´å¤šçš„å…¥æ ˆå’Œå‡ºæ ˆæŒ‡ä»¤ï¼Œè¿™åŒæ—¶ä¹Ÿå°±æ„å‘³ç€å°†éœ€è¦æ›´å¤šçš„æŒ‡ä»¤åˆ†æ´¾ï¼ˆinstruction dispatchï¼‰æ¬¡æ•°å’Œå†…å­˜è¯»&#x2F;å†™æ¬¡æ•°ã€‚
  ç”±äºæ“ä½œæ•°æ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œå› æ­¤é¢‘ç¹åœ°æ‰§è¡Œå†…å­˜è¯»&#x2F;å†™æ“ä½œå¿…ç„¶ä¼šå½±å“æ‰§è¡Œé€Ÿåº¦ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒHotSpot JVMçš„è®¾è®¡è€…ä»¬æå‡ºäº†æ ˆé¡¶ç¼“å­˜ï¼ˆTosï¼ŒTop-of-Stack Cashingï¼‰æŠ€æœ¯ï¼Œå°†æ ˆé¡¶å…ƒç´ å…¨éƒ¨ç¼“å­˜åœ¨ç‰©ç†CPUçš„å¯„å­˜å™¨ä¸­ï¼Œä»¥æ­¤é™ä½å¯¹å†…å­˜çš„è¯»&#x2F;å†™æ¬¡æ•°ï¼Œæå‡æ‰§è¡Œå¼•æ“çš„æ‰§è¡Œæ•ˆç‡ã€‚


5.åŠ¨æ€é“¾æ¥åŠ¨æ€é“¾æ¥ï¼šDynamic Linking

åŠ¨æ€é“¾æ¥ã€æ–¹æ³•è¿”å›åœ°å€ã€é™„åŠ ä¿¡æ¯ ï¼š æœ‰äº›åœ°æ–¹è¢«ç§°ä¸ºå¸§æ•°æ®åŒº

æ¯ä¸€ä¸ªæ ˆå¸§å†…éƒ¨éƒ½åŒ…å«ä¸€ä¸ªæŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± ä¸­è¯¥æ ˆå¸§æ‰€å±æ–¹æ³•çš„å¼•ç”¨åŒ…å«è¿™ä¸ªå¼•ç”¨çš„ç›®çš„å°±æ˜¯ä¸ºäº†æ”¯æŒå½“å‰æ–¹æ³•çš„ä»£ç èƒ½å¤Ÿå®ç°åŠ¨æ€é“¾æ¥ï¼ˆDynamic Linkingï¼‰ã€‚æ¯”å¦‚ï¼šinvokedynamicæŒ‡ä»¤
åœ¨Javaæºæ–‡ä»¶è¢«ç¼–è¯‘åˆ°å­—èŠ‚ç æ–‡ä»¶ä¸­æ—¶ï¼Œæ‰€æœ‰çš„å˜é‡å’Œæ–¹æ³•å¼•ç”¨éƒ½ä½œä¸ºç¬¦å·å¼•ç”¨ï¼ˆsymbolic Referenceï¼‰ä¿å­˜åœ¨classæ–‡ä»¶çš„å¸¸é‡æ± é‡Œã€‚

æ¯”å¦‚ï¼šæè¿°ä¸€ä¸ªæ–¹æ³•è°ƒç”¨äº†å¦å¤–çš„å…¶ä»–æ–¹æ³•æ—¶ï¼Œå°±æ˜¯é€šè¿‡å¸¸é‡æ± ä¸­æŒ‡å‘æ–¹æ³•çš„ç¬¦å·å¼•ç”¨æ¥è¡¨ç¤ºçš„ï¼Œé‚£ä¹ˆåŠ¨æ€é“¾æ¥çš„ä½œç”¨å°±æ˜¯ä¸ºäº†å°†è¿™äº›ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºè°ƒç”¨æ–¹æ³•çš„ç›´æ¥å¼•ç”¨ã€‚
æºç ï¼š
package com.peppa.linking;public class DynamicLinkingTest &#123;    int num = 10;    public void methodA()&#123;        System.out.println(&quot;methodA()....&quot;);    &#125;    public void methodB()&#123;        System.out.println(&quot;methodB()....&quot;);        methodA();        num++;    &#125;&#125;

å¯¹åº”å­—èŠ‚ç 
public class com.peppa.linking.DynamicLinkingTest  minor version: 0  major version: 52  flags: ACC_PUBLIC, ACC_SUPERConstant pool:   #1 = Methodref          #9.#23         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V   #2 = Fieldref           #8.#24         // com/peppa/linking/DynamicLinkingTest.num:I   #3 = Fieldref           #25.#26        // java/lang/System.out:Ljava/io/PrintStream;   #4 = String             #27            // methodA()....   #5 = Methodref          #28.#29        // java/io/PrintStream.println:(Ljava/lang/String;)V   #6 = String             #30            // methodB()....   #7 = Methodref          #8.#31         // com/peppa/linking/DynamicLinkingTest.methodA:()V   #8 = Class              #32            // com/peppa/linking/DynamicLinkingTest   #9 = Class              #33            // java/lang/Object  #10 = Utf8               num  #11 = Utf8               I  #12 = Utf8               &lt;init&gt;  #13 = Utf8               ()V  #14 = Utf8               Code  #15 = Utf8               LineNumberTable  #16 = Utf8               LocalVariableTable  #17 = Utf8               this  #18 = Utf8               Lcom/peppa/linking/DynamicLinkingTest;  #19 = Utf8               methodA  #20 = Utf8               methodB  #21 = Utf8               SourceFile  #22 = Utf8               DynamicLinkingTest.java  #23 = NameAndType        #12:#13        // &quot;&lt;init&gt;&quot;:()V  #24 = NameAndType        #10:#11        // num:I  #25 = Class              #34            // java/lang/System  #26 = NameAndType        #35:#36        // out:Ljava/io/PrintStream;  #27 = Utf8               methodA()....  #28 = Class              #37            // java/io/PrintStream  #29 = NameAndType        #38:#39        // println:(Ljava/lang/String;)V  #30 = Utf8               methodB()....  #31 = NameAndType        #19:#13        // methodA:()V  #32 = Utf8               com/peppa/linking/DynamicLinkingTest  #33 = Utf8               java/lang/Object  #34 = Utf8               java/lang/System  #35 = Utf8               out  #36 = Utf8               Ljava/io/PrintStream;  #37 = Utf8               java/io/PrintStream  #38 = Utf8               println  #39 = Utf8               (Ljava/lang/String;)V&#123;  int num;    descriptor: I    flags:  public com.peppa.linking.DynamicLinkingTest();    descriptor: ()V    flags: ACC_PUBLIC    Code:      stack=2, locals=1, args_size=1         0: aload_0         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V         4: aload_0         5: bipush        10         7: putfield      #2                  // Field num:I        10: return      LineNumberTable:        line 3: 0        line 4: 4      LocalVariableTable:        Start  Length  Slot  Name   Signature            0      11     0  this   Lcom/peppa/linking/DynamicLinkingTest;  public void methodA();    descriptor: ()V    flags: ACC_PUBLIC    Code:      stack=2, locals=1, args_size=1         0: getstatic     #3                  // Field java/lang/System.out:Ljava/io/PrintStream;         3: ldc           #4                  // String methodA()....         5: invokevirtual #5                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V         8: return      LineNumberTable:        line 7: 0        line 8: 8      LocalVariableTable:        Start  Length  Slot  Name   Signature            0       9     0  this   Lcom/peppa/linking/DynamicLinkingTest;  public void methodB();    descriptor: ()V    flags: ACC_PUBLIC    Code:      stack=3, locals=1, args_size=1         0: getstatic     #3                  // Field java/lang/System.out:Ljava/io/PrintStream;         3: ldc           #6                  // String methodB()....         5: invokevirtual #5                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V         8: aload_0         9: invokevirtual #7                  // Method methodA:()V        12: aload_0        13: dup        14: getfield      #2                  // Field num:I        17: iconst_1        18: iadd        19: putfield      #2                  // Field num:I        22: return      LineNumberTable:        line 11: 0        line 13: 8        line 15: 12        line 16: 22      LocalVariableTable:        Start  Length  Slot  Name   Signature            0      23     0  this   Lcom/peppa/linking/DynamicLinkingTest;&#125;

1ã€åœ¨å­—èŠ‚ç æŒ‡ä»¤ä¸­ï¼ŒmethodB() æ–¹æ³•ä¸­é€šè¿‡ invokevirtual #7 æŒ‡ä»¤è°ƒç”¨äº†æ–¹æ³• A ï¼Œé‚£ä¹ˆ #7 æ˜¯ä¸ªå•¥å‘¢ï¼Ÿ
2ã€å¾€ä¸Šé¢ç¿»ï¼Œæ‰¾åˆ°å¸¸é‡æ± çš„å®šä¹‰ï¼š#7 = Methodref #8.#31

å…ˆæ‰¾ #8 ï¼š
#8 = Class #32Â ï¼šå»æ‰¾ #32
#32 = Utf8 com/peppa/linking/DynamicLinkingTest
ç»“è®ºï¼šé€šè¿‡ #8 æˆ‘ä»¬æ‰¾åˆ°äº†Â DynamicLinkingTestÂ è¿™ä¸ªç±»


å†æ¥æ‰¾ #31ï¼š
#31 = NameAndType #19:#13Â ï¼šå»æ‰¾ #19 å’Œ #13
#19 = Utf8 methodAÂ ï¼šæ–¹æ³•åä¸º methodA
#13 = Utf8 ()VÂ ï¼šæ–¹æ³•æ²¡æœ‰å½¢å‚ï¼Œè¿”å›å€¼ä¸º void



3ã€ç»“è®ºï¼šé€šè¿‡ #7 æˆ‘ä»¬å°±èƒ½æ‰¾åˆ°éœ€è¦è°ƒç”¨çš„ methodA() æ–¹æ³•ï¼Œå¹¶è¿›è¡Œè°ƒç”¨
4ã€åœ¨ä¸Šé¢ï¼Œå…¶å®è¿˜æœ‰å¾ˆå¤šç¬¦å·å¼•ç”¨ï¼Œæ¯”å¦‚ Objectã€Systemã€PrintStream ç­‰ç­‰

ä¸ºä»€ä¹ˆéœ€è¦è¿è¡Œæ—¶å¸¸é‡æ± ï¼Ÿ
å› ä¸ºåœ¨ä¸åŒçš„æ–¹æ³•ï¼Œéƒ½å¯èƒ½è°ƒç”¨å¸¸é‡æˆ–è€…æ–¹æ³•ï¼Œæ‰€ä»¥åªéœ€è¦å­˜å‚¨ä¸€ä»½å³å¯ï¼ŒèŠ‚çœäº†ç©ºé—´
å¸¸é‡æ± çš„ä½œç”¨ï¼šå°±æ˜¯ä¸ºäº†æä¾›ä¸€äº›ç¬¦å·å’Œå¸¸é‡ï¼Œä¾¿äºæŒ‡ä»¤çš„è¯†åˆ«

æ–¹æ³•è°ƒç”¨ï¼šè§£æä¸åˆ†é…

é™æ€é“¾æ¥ä¸åŠ¨æ€é“¾æ¥
  åœ¨JVMä¸­ï¼Œå°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºè°ƒç”¨æ–¹æ³•çš„ç›´æ¥å¼•ç”¨ä¸æ–¹æ³•çš„ç»‘å®šæœºåˆ¶ç›¸å…³

**é™æ€é“¾æ¥ï¼š**å½“ä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶è¢«è£…è½½è¿›JVMå†…éƒ¨æ—¶ï¼Œå¦‚æœè¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•åœ¨ç¼–è¯‘æœŸç¡®å®šï¼Œä¸”è¿è¡ŒæœŸä¿æŒä¸å˜æ—¶ï¼Œè¿™ç§æƒ…å†µä¸‹å°†è°ƒç”¨æ–¹æ³•çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºé™æ€é“¾æ¥
åŠ¨æ€é“¾æ¥ï¼šå¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•åœ¨ç¼–è¯‘æœŸæ— æ³•è¢«ç¡®å®šä¸‹æ¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªèƒ½å¤Ÿåœ¨ç¨‹åºè¿è¡ŒæœŸå°†è°ƒç”¨çš„æ–¹æ³•çš„ç¬¦å·è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼Œç”±äºè¿™ç§å¼•ç”¨è½¬æ¢è¿‡ç¨‹å…·å¤‡åŠ¨æ€æ€§ï¼Œå› æ­¤ä¹Ÿè¢«ç§°ä¹‹ä¸ºåŠ¨æ€é“¾æ¥ã€‚


æ—©æœŸç»‘å®šä¸æ™šæœŸç»‘å®š
  é™æ€é“¾æ¥ä¸åŠ¨æ€é“¾æ¥é’ˆå¯¹çš„æ˜¯æ–¹æ³•ã€‚æ—©æœŸç»‘å®šå’Œæ™šæœŸç»‘å®šèŒƒå›´æ›´å¹¿ã€‚æ—©æœŸç»‘å®šæ¶µç›–äº†é™æ€é“¾æ¥ï¼Œæ™šæœŸç»‘å®šæ¶µç›–äº†åŠ¨æ€é“¾æ¥ã€‚é™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥å¯¹åº”çš„æ–¹æ³•çš„ç»‘å®šæœºåˆ¶ä¸ºï¼šæ—©æœŸç»‘å®šï¼ˆEarly Bindingï¼‰å’Œæ™šæœŸç»‘å®šï¼ˆLate Bindingï¼‰ã€‚ç»‘å®šæ˜¯ä¸€ä¸ªå­—æ®µã€æ–¹æ³•æˆ–è€…ç±»åœ¨ç¬¦å·å¼•ç”¨è¢«æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ï¼Œè¿™ä»…ä»…å‘ç”Ÿä¸€æ¬¡ã€‚

æ—©æœŸç»‘å®š
  æ—©æœŸç»‘å®šå°±æ˜¯æŒ‡è¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•å¦‚æœåœ¨ç¼–è¯‘æœŸå¯çŸ¥ï¼Œä¸”è¿è¡ŒæœŸä¿æŒä¸å˜æ—¶ï¼Œå³å¯å°†è¿™ä¸ªæ–¹æ³•ä¸æ‰€å±çš„ç±»å‹è¿›è¡Œç»‘å®šï¼Œè¿™æ ·ä¸€æ¥ï¼Œç”±äºæ˜ç¡®äº†è¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•ç©¶ç«Ÿæ˜¯å“ªä¸€ä¸ªï¼Œå› æ­¤ä¹Ÿå°±å¯ä»¥ä½¿ç”¨é™æ€é“¾æ¥çš„æ–¹å¼å°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚

æ™šæœŸç»‘å®š
  å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•åœ¨ç¼–è¯‘æœŸæ— æ³•è¢«ç¡®å®šä¸‹æ¥ï¼Œåªèƒ½å¤Ÿåœ¨ç¨‹åºè¿è¡ŒæœŸæ ¹æ®å®é™…çš„ç±»å‹ç»‘å®šç›¸å…³çš„æ–¹æ³•ï¼Œè¿™ç§ç»‘å®šæ–¹å¼ä¹Ÿå°±è¢«ç§°ä¹‹ä¸ºæ™šæœŸç»‘å®šã€‚



æ—©æ™šæœŸç»‘å®šçš„å‘å±•å†å²
  éšç€é«˜çº§è¯­è¨€çš„æ¨ªç©ºå‡ºä¸–ï¼Œç±»ä¼¼äºJavaä¸€æ ·çš„åŸºäºé¢å‘å¯¹è±¡çš„ç¼–ç¨‹è¯­è¨€å¦‚ä»Šè¶Šæ¥è¶Šå¤šï¼Œå°½ç®¡è¿™ç±»ç¼–ç¨‹è¯­è¨€åœ¨è¯­æ³•é£æ ¼ä¸Šå­˜åœ¨ä¸€å®šçš„å·®åˆ«ï¼Œä½†æ˜¯å®ƒä»¬å½¼æ­¤ä¹‹é—´å§‹ç»ˆä¿æŒç€ä¸€ä¸ªå…±æ€§ï¼Œé‚£å°±æ˜¯éƒ½æ”¯æŒå°è£…ã€ç»§æ‰¿å’Œå¤šæ€ç­‰é¢å‘å¯¹è±¡ç‰¹æ€§ï¼Œæ—¢ç„¶è¿™ä¸€ç±»çš„ç¼–ç¨‹è¯­è¨€å…·å¤‡å¤šæ€ç‰¹æ‚„ï¼Œé‚£ä¹ˆè‡ªç„¶ä¹Ÿå°±å…·å¤‡æ—©æœŸç»‘å®šå’Œæ™šæœŸç»‘å®šä¸¤ç§ç»‘å®šæ–¹å¼ã€‚
  Javaä¸­ä»»ä½•ä¸€ä¸ªæ™®é€šçš„æ–¹æ³•å…¶å®éƒ½å…·å¤‡è™šå‡½æ•°çš„ç‰¹å¾ï¼Œå®ƒä»¬ç›¸å½“äºC++è¯­è¨€ä¸­çš„è™šå‡½æ•°ï¼ˆC++ä¸­åˆ™éœ€è¦ä½¿ç”¨å…³é”®å­—virtualæ¥æ˜¾å¼å®šä¹‰ï¼‰ã€‚å¦‚æœåœ¨Javaç¨‹åºä¸­ä¸å¸Œæœ›æŸä¸ªæ–¹æ³•æ‹¥æœ‰è™šå‡½æ•°çš„ç‰¹å¾æ—¶ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å…³é”®å­—finalæ¥æ ‡è®°è¿™ä¸ªæ–¹æ³•ã€‚

è™šæ–¹æ³•å’Œéè™šæ–¹æ³•

å¦‚æœæ–¹æ³•åœ¨ç¼–è¯‘æœŸå°±ç¡®å®šäº†å…·ä½“çš„è°ƒç”¨ç‰ˆæœ¬ï¼Œè¿™ä¸ªç‰ˆæœ¬åœ¨è¿è¡Œæ—¶æ˜¯ä¸å¯å˜çš„ã€‚è¿™æ ·çš„æ–¹æ³•ç§°ä¸ºéè™šæ–¹æ³•ã€‚
é™æ€æ–¹æ³•ã€ç§æœ‰æ–¹æ³•ã€fina1æ–¹æ³•ã€å®ä¾‹æ„é€ å™¨ã€çˆ¶ç±»æ–¹æ³•éƒ½æ˜¯éè™šæ–¹æ³•ã€‚
å…¶ä»–æ–¹æ³•ç§°ä¸ºè™šæ–¹æ³•ã€‚


å­ç±»å¯¹è±¡çš„å¤šæ€çš„ä½¿ç”¨å‰æï¼š

ç±»çš„ç»§æ‰¿å…³ç³»
æ–¹æ³•çš„é‡å†™


è™šæ‹Ÿæœºä¸­æä¾›äº†ä»¥ä¸‹å‡ æ¡æ–¹æ³•è°ƒç”¨æŒ‡ä»¤ï¼š

æ™®é€šè°ƒç”¨æŒ‡ä»¤ï¼š

invokestaticï¼šè°ƒç”¨é™æ€æ–¹æ³•ï¼Œè§£æé˜¶æ®µç¡®å®šå”¯ä¸€æ–¹æ³•ç‰ˆæœ¬
invokespecialï¼šè°ƒç”¨æ–¹æ³•ã€ç§æœ‰åŠçˆ¶ç±»æ–¹æ³•ï¼Œè§£æé˜¶æ®µç¡®å®šå”¯ä¸€æ–¹æ³•ç‰ˆæœ¬
invokevirtualï¼šè°ƒç”¨æ‰€æœ‰è™šæ–¹æ³•
invokeinterfaceï¼šè°ƒç”¨æ¥å£æ–¹æ³•


åŠ¨æ€è°ƒç”¨æŒ‡ä»¤ï¼š

invokedynamicï¼šåŠ¨æ€è§£æå‡ºéœ€è¦è°ƒç”¨çš„æ–¹æ³•ï¼Œç„¶åæ‰§è¡Œ
  å‰å››æ¡æŒ‡ä»¤å›ºåŒ–åœ¨è™šæ‹Ÿæœºå†…éƒ¨ï¼Œæ–¹æ³•çš„è°ƒç”¨æ‰§è¡Œä¸å¯äººä¸ºå¹²é¢„ï¼Œè€ŒinvokedynamicæŒ‡ä»¤åˆ™æ”¯æŒç”±ç”¨æˆ·ç¡®å®šæ–¹æ³•ç‰ˆæœ¬ã€‚å…¶ä¸­invokestaticæŒ‡ä»¤å’ŒinvokespecialæŒ‡ä»¤è°ƒç”¨çš„æ–¹æ³•ç§°ä¸ºéè™šæ–¹æ³•ï¼Œå…¶ä½™çš„ï¼ˆfina1ä¿®é¥°çš„é™¤å¤–ï¼‰ç§°ä¸ºè™šæ–¹æ³•ã€‚





invokednamicæŒ‡ä»¤

JVMå­—èŠ‚ç æŒ‡ä»¤é›†ä¸€ç›´æ¯”è¾ƒç¨³å®šï¼Œä¸€ç›´åˆ°Java7ä¸­æ‰å¢åŠ äº†ä¸€ä¸ªinvokedynamicæŒ‡ä»¤ï¼Œè¿™æ˜¯Javaä¸ºäº†å®ç°ã€åŠ¨æ€ç±»å‹è¯­è¨€ã€‘æ”¯æŒè€Œåšçš„ä¸€ç§æ”¹è¿›ã€‚
ä½†æ˜¯åœ¨Java7ä¸­å¹¶æ²¡æœ‰æä¾›ç›´æ¥ç”ŸæˆinvokedynamicæŒ‡ä»¤çš„æ–¹æ³•ï¼Œéœ€è¦å€ŸåŠ©ASMè¿™ç§åº•å±‚å­—èŠ‚ç å·¥å…·æ¥äº§ç”ŸinvokedynamicæŒ‡ä»¤ã€‚ç›´åˆ°Java8çš„Lambdaè¡¨è¾¾å¼çš„å‡ºç°ï¼ŒinvokedynamicæŒ‡ä»¤çš„ç”Ÿæˆï¼Œåœ¨Javaä¸­æ‰æœ‰äº†ç›´æ¥çš„ç”Ÿæˆæ–¹å¼ã€‚
Java7ä¸­å¢åŠ çš„åŠ¨æ€è¯­è¨€ç±»å‹æ”¯æŒçš„æœ¬è´¨æ˜¯å¯¹Javaè™šæ‹Ÿæœºè§„èŒƒçš„ä¿®æ”¹ï¼Œè€Œä¸æ˜¯å¯¹Javaè¯­è¨€è§„åˆ™çš„ä¿®æ”¹ï¼Œè¿™ä¸€å—ç›¸å¯¹æ¥è®²æ¯”è¾ƒå¤æ‚ï¼Œå¢åŠ äº†è™šæ‹Ÿæœºä¸­çš„æ–¹æ³•è°ƒç”¨ï¼Œæœ€ç›´æ¥çš„å—ç›Šè€…å°±æ˜¯è¿è¡Œåœ¨Javaå¹³å°çš„åŠ¨æ€è¯­è¨€çš„ç¼–è¯‘å™¨ã€‚


åŠ¨æ€è¯­è¨€å’Œé™æ€è¯­è¨€

åŠ¨æ€ç±»å‹è¯­è¨€å’Œé™æ€ç±»å‹è¯­è¨€ä¸¤è€…çš„åŒºåˆ«å°±åœ¨äºå¯¹ç±»å‹çš„æ£€æŸ¥æ˜¯åœ¨ç¼–è¯‘æœŸè¿˜æ˜¯åœ¨è¿è¡ŒæœŸï¼Œæ»¡è¶³å‰è€…å°±æ˜¯é™æ€ç±»å‹è¯­è¨€ï¼Œåä¹‹æ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ã€‚
è¯´çš„å†ç›´ç™½ä¸€ç‚¹å°±æ˜¯ï¼Œé™æ€ç±»å‹è¯­è¨€æ˜¯åˆ¤æ–­å˜é‡è‡ªèº«çš„ç±»å‹ä¿¡æ¯ï¼›åŠ¨æ€ç±»å‹è¯­è¨€æ˜¯åˆ¤æ–­å˜é‡å€¼çš„ç±»å‹ä¿¡æ¯ï¼Œå˜é‡æ²¡æœ‰ç±»å‹ä¿¡æ¯ï¼Œå˜é‡å€¼æ‰æœ‰ç±»å‹ä¿¡æ¯ï¼Œè¿™æ˜¯åŠ¨æ€è¯­è¨€çš„ä¸€ä¸ªé‡è¦ç‰¹å¾ã€‚

  Javaï¼šString info = &quot;mogu blog&quot;; (Javaæ˜¯é™æ€ç±»å‹è¯­è¨€çš„ï¼Œä¼šå…ˆç¼–è¯‘å°±è¿›è¡Œç±»å‹æ£€æŸ¥) JSï¼švar name = &quot;shkstart&quot;; var name = 10; ï¼ˆè¿è¡Œæ—¶æ‰è¿›è¡Œæ£€æŸ¥ï¼‰Python: info = 130.5 (è¿è¡Œæ—¶æ‰æ£€æŸ¥)


Javaè¯­è¨€ä¸­æ–¹æ³•é‡å†™çš„æœ¬è´¨

ä»€ä¹ˆæ˜¯åŠ¨æ€åˆ†æ´¾ï¼Ÿ

æ‰¾åˆ°æ“ä½œæ•°æ ˆé¡¶çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ‰€æ‰§è¡Œçš„å¯¹è±¡çš„å®é™…ç±»å‹ï¼Œè®°ä½œCã€‚
å¦‚æœåœ¨ç±»å‹Cä¸­æ‰¾åˆ°ä¸å¸¸é‡ä¸­çš„æè¿°ç¬¦åˆç®€å•åç§°éƒ½ç›¸ç¬¦çš„æ–¹æ³•ï¼Œåˆ™è¿›è¡Œè®¿é—®æƒé™æ ¡éªŒã€‚
å¦‚æœé€šè¿‡åˆ™è¿”å›è¿™ä¸ªæ–¹æ³•çš„ç›´æ¥å¼•ç”¨ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹ç»“æŸ
å¦‚æœä¸é€šè¿‡ï¼Œåˆ™è¿”å›java.lang.IllegalAccessError å¼‚å¸¸


å¦åˆ™ï¼ŒæŒ‰ç…§ç»§æ‰¿å…³ç³»ä»ä¸‹å¾€ä¸Šä¾æ¬¡å¯¹Cçš„å„ä¸ªçˆ¶ç±»è¿›è¡Œç¬¬2æ­¥çš„æœç´¢å’ŒéªŒè¯è¿‡ç¨‹ã€‚
å¦‚æœå§‹ç»ˆæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ–¹æ³•ï¼Œåˆ™æŠ›å‡ºjava.lang.AbstractMethodErrorå¼‚å¸¸ã€‚


IllegalAccessErrorä»‹ç»
  ç¨‹åºè¯•å›¾è®¿é—®æˆ–ä¿®æ”¹ä¸€ä¸ªå±æ€§æˆ–è°ƒç”¨ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªå±æ€§æˆ–æ–¹æ³•ï¼Œä½ æ²¡æœ‰æƒé™è®¿é—®ã€‚ä¸€èˆ¬çš„ï¼Œè¿™ä¸ªä¼šå¼•èµ·ç¼–è¯‘å™¨å¼‚å¸¸ã€‚è¿™ä¸ªé”™è¯¯å¦‚æœå‘ç”Ÿåœ¨è¿è¡Œæ—¶ï¼Œå°±è¯´æ˜ä¸€ä¸ªç±»å‘ç”Ÿäº†ä¸å…¼å®¹çš„æ”¹å˜ã€‚

æ–¹æ³•çš„è°ƒç”¨ï¼šè™šæ–¹æ³•è¡¨

åœ¨é¢å‘å¯¹è±¡çš„ç¼–ç¨‹ä¸­ï¼Œä¼šå¾ˆé¢‘ç¹çš„ä½¿ç”¨åˆ°åŠ¨æ€åˆ†æ´¾ï¼Œå¦‚æœåœ¨æ¯æ¬¡åŠ¨æ€åˆ†æ´¾çš„è¿‡ç¨‹ä¸­éƒ½è¦é‡æ–°åœ¨ç±»çš„æ–¹æ³•å…ƒæ•°æ®ä¸­æœç´¢åˆé€‚çš„ç›®æ ‡çš„è¯å°±å¯èƒ½å½±å“åˆ°æ‰§è¡Œæ•ˆç‡ã€‚å› æ­¤ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼ŒJVMé‡‡ç”¨åœ¨ç±»çš„æ–¹æ³•åŒºå»ºç«‹ä¸€ä¸ªè™šæ–¹æ³•è¡¨ï¼ˆvirtual method tableï¼‰æ¥å®ç°ï¼Œéè™šæ–¹æ³•ä¸ä¼šå‡ºç°åœ¨è¡¨ä¸­ã€‚ä½¿ç”¨ç´¢å¼•è¡¨æ¥ä»£æ›¿æŸ¥æ‰¾ã€‚ã€ä¸Šé¢åŠ¨æ€åˆ†æ´¾çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚æœå­ç±»æ‰¾ä¸åˆ°ï¼Œè¿˜è¦ä»ä¸‹å¾€ä¸Šæ‰¾å…¶çˆ¶ç±»ï¼Œéå¸¸è€—æ—¶ã€‘
æ¯ä¸ªç±»ä¸­éƒ½æœ‰ä¸€ä¸ªè™šæ–¹æ³•è¡¨ï¼Œè¡¨ä¸­å­˜æ”¾ç€å„ä¸ªæ–¹æ³•çš„å®é™…å…¥å£ã€‚
è™šæ–¹æ³•è¡¨æ˜¯ä»€ä¹ˆæ—¶å€™è¢«åˆ›å»ºçš„å‘¢ï¼Ÿè™šæ–¹æ³•è¡¨ä¼šåœ¨ç±»åŠ è½½çš„é“¾æ¥é˜¶æ®µè¢«åˆ›å»ºå¹¶å¼€å§‹åˆå§‹åŒ–ï¼Œç±»çš„å˜é‡åˆå§‹å€¼å‡†å¤‡å®Œæˆä¹‹åï¼ŒJVMä¼šæŠŠè¯¥ç±»çš„è™šæ–¹æ³•è¡¨ä¹Ÿåˆå§‹åŒ–å®Œæ¯•ã€‚

  
  å¦‚ä¸Šå›¾æ‰€ç¤ºï¼šå¦‚æœç±»ä¸­é‡å†™äº†æ–¹æ³•ï¼Œé‚£ä¹ˆè°ƒç”¨çš„æ—¶å€™ï¼Œå°±ä¼šç›´æ¥åœ¨è™šæ–¹æ³•è¡¨ä¸­æŸ¥æ‰¾ï¼Œå¦åˆ™å°†ä¼šç›´æ¥è¿æ¥åˆ°Objectçš„æ–¹æ³•ä¸­ã€‚




6.æ–¹æ³•è¿”å›åœ°å€
æ–¹æ³•çš„ç»“æŸ

å­˜æ”¾è°ƒç”¨è¯¥æ–¹æ³•çš„pcå¯„å­˜å™¨çš„å€¼ã€‚ä¸€ä¸ªæ–¹æ³•çš„ç»“æŸï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š
æ­£å¸¸æ‰§è¡Œå®Œæˆ
å‡ºç°æœªå¤„ç†çš„å¼‚å¸¸ï¼Œéæ­£å¸¸é€€å‡º


æ— è®ºé€šè¿‡å“ªç§æ–¹å¼é€€å‡ºï¼Œåœ¨æ–¹æ³•é€€å‡ºåéƒ½è¿”å›åˆ°è¯¥æ–¹æ³•è¢«è°ƒç”¨çš„ä½ç½®ã€‚æ–¹æ³•æ­£å¸¸é€€å‡ºæ—¶ï¼Œè°ƒç”¨è€…çš„pcè®¡æ•°å™¨çš„å€¼ä½œä¸ºè¿”å›åœ°å€ï¼Œå³è°ƒç”¨è¯¥æ–¹æ³•çš„æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚è€Œé€šè¿‡å¼‚å¸¸é€€å‡ºçš„ï¼Œè¿”å›åœ°å€æ˜¯è¦é€šè¿‡å¼‚å¸¸è¡¨æ¥ç¡®å®šï¼Œæ ˆå¸§ä¸­ä¸€èˆ¬ä¸ä¼šä¿å­˜è¿™éƒ¨åˆ†ä¿¡æ¯ã€‚
æœ¬è´¨ä¸Šï¼Œæ–¹æ³•çš„é€€å‡ºå°±æ˜¯å½“å‰æ ˆå¸§å‡ºæ ˆçš„è¿‡ç¨‹ã€‚æ­¤æ—¶ï¼Œéœ€è¦æ¢å¤ä¸Šå±‚æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€å°†è¿”å›å€¼å‹å…¥è°ƒç”¨è€…æ ˆå¸§çš„æ“ä½œæ•°æ ˆã€è®¾ç½®PCå¯„å­˜å™¨å€¼ç­‰ï¼Œè®©è°ƒç”¨è€…æ–¹æ³•ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚
æ­£å¸¸å®Œæˆå‡ºå£å’Œå¼‚å¸¸å®Œæˆå‡ºå£çš„åŒºåˆ«åœ¨äºï¼šé€šè¿‡å¼‚å¸¸å®Œæˆå‡ºå£é€€å‡ºçš„ä¸ä¼šç»™ä»–çš„ä¸Šå±‚è°ƒç”¨è€…äº§ç”Ÿä»»ä½•çš„è¿”å›å€¼ã€‚


æ–¹æ³•é€€å‡ºçš„ä¸¤ç§æ–¹å¼
  å½“ä¸€ä¸ªæ–¹æ³•å¼€å§‹æ‰§è¡Œåï¼Œåªæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥é€€å‡ºè¿™ä¸ªæ–¹æ³•ï¼Œ

æ­£å¸¸é€€å‡ºï¼š

æ‰§è¡Œå¼•æ“é‡åˆ°ä»»æ„ä¸€ä¸ªæ–¹æ³•è¿”å›çš„å­—èŠ‚ç æŒ‡ä»¤ï¼ˆreturnï¼‰ï¼Œä¼šæœ‰è¿”å›å€¼ä¼ é€’ç»™ä¸Šå±‚çš„æ–¹æ³•è°ƒç”¨è€…ï¼Œç®€ç§°æ­£å¸¸å®Œæˆå‡ºå£ï¼›
ä¸€ä¸ªæ–¹æ³•åœ¨æ­£å¸¸è°ƒç”¨å®Œæˆä¹‹åï¼Œç©¶ç«Ÿéœ€è¦ä½¿ç”¨å“ªä¸€ä¸ªè¿”å›æŒ‡ä»¤ï¼Œè¿˜éœ€è¦æ ¹æ®æ–¹æ³•è¿”å›å€¼çš„å®é™…æ•°æ®ç±»å‹è€Œå®šã€‚
åœ¨å­—èŠ‚ç æŒ‡ä»¤ä¸­ï¼Œè¿”å›æŒ‡ä»¤åŒ…å«ï¼š
ireturnï¼šå½“è¿”å›å€¼æ˜¯booleanï¼Œbyteï¼Œcharï¼Œshortå’Œintç±»å‹æ—¶ä½¿ç”¨
lreturnï¼šLongç±»å‹
freturnï¼šFloatç±»å‹
dreturnï¼šDoubleç±»å‹
areturnï¼šå¼•ç”¨ç±»å‹
returnï¼šè¿”å›å€¼ç±»å‹ä¸ºvoidçš„æ–¹æ³•ã€å®ä¾‹åˆå§‹åŒ–æ–¹æ³•ã€ç±»å’Œæ¥å£çš„åˆå§‹åŒ–æ–¹æ³•




å¼‚å¸¸é€€å‡ºï¼š

åœ¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°å¼‚å¸¸ï¼ˆExceptionï¼‰ï¼Œå¹¶ä¸”è¿™ä¸ªå¼‚å¸¸æ²¡æœ‰åœ¨æ–¹æ³•å†…è¿›è¡Œå¤„ç†ï¼Œä¹Ÿå°±æ˜¯åªè¦åœ¨æœ¬æ–¹æ³•çš„å¼‚å¸¸è¡¨ä¸­æ²¡æœ‰æœç´¢åˆ°åŒ¹é…çš„å¼‚å¸¸å¤„ç†å™¨ï¼Œå°±ä¼šå¯¼è‡´æ–¹æ³•é€€å‡ºï¼Œç®€ç§°å¼‚å¸¸å®Œæˆå‡ºå£ã€‚
æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒæŠ›å‡ºå¼‚å¸¸æ—¶çš„å¼‚å¸¸å¤„ç†ï¼Œå­˜å‚¨åœ¨ä¸€ä¸ªå¼‚å¸¸å¤„ç†è¡¨ï¼Œæ–¹ä¾¿åœ¨å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™æ‰¾åˆ°å¤„ç†å¼‚å¸¸çš„ä»£ç 

  
  å¼‚å¸¸å¤„ç†è¡¨ï¼š

åç¼–è¯‘å­—èŠ‚ç æ–‡ä»¶ï¼Œå¯å¾—åˆ° Exception table
from ï¼šå­—èŠ‚ç æŒ‡ä»¤èµ·å§‹åœ°å€
to ï¼šå­—èŠ‚ç æŒ‡ä»¤ç»“æŸåœ°å€
target ï¼šå‡ºç°å¼‚å¸¸è·³è½¬è‡³åœ°å€ä¸º 11 çš„æŒ‡ä»¤æ‰§è¡Œ
type ï¼šæ•è·å¼‚å¸¸çš„ç±»å‹



  æœ¬è´¨ä¸Šï¼Œæ–¹æ³•çš„é€€å‡ºå°±æ˜¯å½“å‰æ ˆå¸§å‡ºæ ˆçš„è¿‡ç¨‹ã€‚æ­¤æ—¶ï¼Œéœ€è¦æ¢å¤ä¸Šå±‚æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€å°†è¿”å›å€¼å‹å…¥è°ƒç”¨è€…æ ˆå¸§çš„æ“ä½œæ•°æ ˆã€è®¾ç½®PCå¯„å­˜å™¨å€¼ç­‰ï¼Œè®©è°ƒç”¨è€…æ–¹æ³•ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚
  æ­£å¸¸å®Œæˆå‡ºå£å’Œå¼‚å¸¸å®Œæˆå‡ºå£çš„åŒºåˆ«åœ¨äºï¼šé€šè¿‡å¼‚å¸¸å®Œæˆå‡ºå£é€€å‡ºçš„ä¸ä¼šç»™ä»–çš„ä¸Šå±‚è°ƒç”¨è€…äº§ç”Ÿä»»ä½•çš„è¿”å›å€¼ã€‚


7.ä¸€äº›é™„åŠ ä¿¡æ¯è™šæ‹Ÿæœºè§„èŒƒå…è®¸å…·ä½“çš„è™šæ‹Ÿæœºå®ç°å¢åŠ ä¸€äº›è§„èŒƒé‡Œæ²¡æœ‰æè¿°çš„ä¿¡æ¯åˆ°æ ˆå¸§ä¸­ï¼Œä¾‹å¦‚ä¸è°ƒè¯•ç›¸å…³çš„ä¿¡æ¯ï¼Œè¿™éƒ¨åˆ†ä¿¡æ¯å®Œå…¨å–å†³äºå…·ä½“çš„è™šæ‹Ÿæœºå®ç°ã€‚å®é™…å¼€å‘ä¸­ï¼Œä¸€èˆ¬ä¼šæŠŠåŠ¨æ€è¿æ¥ã€æ–¹æ³•è¿”å›åœ°å€ä¸å…¶ä»–é™„åŠ ä¿¡æ¯å…¨éƒ¨å½’ä¸ºä¸€ç±»ï¼Œæˆä¸ºæ ˆå¸§ä¿¡æ¯ã€‚
]]></content>
      <categories>
        <category>JVMè™šæ‹Ÿæœºè¯¦è§£</category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>JVMè™šæ‹Ÿæœºè¯¦è§£</tag>
      </tags>
  </entry>
  <entry>
    <title>JVMè™šæ‹Ÿæœºè¯¦è§£(ä¸€)JVMä¸JAVAä½“ç³»ç»Ÿç»“æ„</title>
    <url>/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3(%E4%B8%80)JVM%E4%B8%8EJAVA%E4%BD%93%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84/</url>
    <content><![CDATA[1. Javaç”Ÿæ€åœˆJavaæ˜¯ç›®å‰åº”ç”¨æœ€ä¸ºå¹¿æ³›çš„è½¯ä»¶å¼€å‘å¹³å°ä¹‹ä¸€ã€‚éšç€Javaä»¥åŠJavaç¤¾åŒºçš„ä¸æ–­å£®å¤§Java ä¹Ÿæ—©å·²ä¸å†æ˜¯ç®€ç®€å•å•çš„ä¸€é—¨è®¡ç®—æœºè¯­è¨€äº†ï¼Œå®ƒæ›´æ˜¯ä¸€ä¸ªå¹³å°ã€ä¸€ç§æ–‡åŒ–ã€ä¸€ä¸ªç¤¾åŒºã€‚

ä½œä¸ºä¸€ä¸ªå¹³å°ï¼ŒJavaè™šæ‹Ÿæœºæ‰®æ¼”ç€ä¸¾è¶³è½»é‡çš„ä½œç”¨
Groovyã€Scalaã€JRubyã€Kotlinç­‰éƒ½æ˜¯Javaå¹³å°çš„ä¸€éƒ¨åˆ†


ä½œä¸ºç¯ç§æ–‡åŒ–ï¼ŒJavaå‡ ä¹æˆä¸ºäº†â€œå¼€æºâ€çš„ä»£åè¯ã€‚
ç¬¬ä¸‰æ–¹å¼€æºè½¯ä»¶å’Œæ¡†æ¶ã€‚å¦‚Tomcatã€Strutsï¼ŒMyBatisï¼ŒSpringç­‰ã€‚
å°±è¿JDKå’ŒJVMè‡ªèº«ä¹Ÿæœ‰ä¸å°‘å¼€æºçš„å®ç°ï¼Œå¦‚openJDKã€Harmonyã€‚


ä½œä¸ºä¸€ä¸ªç¤¾åŒºï¼ŒJavaæ‹¥æœ‰å…¨ä¸–ç•Œæœ€å¤šçš„æŠ€æœ¯æ‹¥æŠ¤è€…å’Œå¼€æºç¤¾åŒºæ”¯æŒï¼Œæœ‰æ•°ä¸æ¸…çš„è®ºå›å’Œèµ„æ–™ã€‚ä»æ¡Œé¢åº”ç”¨è½¯ä»¶ã€åµŒå…¥å¼å¼€å‘åˆ°ä¼ä¸šçº§åº”ç”¨ã€åå°æœåŠ¡å™¨ã€ä¸­é—´ä»¶ï¼Œéƒ½å¯ä»¥çœ‹åˆ°Javaçš„èº«å½±ã€‚å…¶åº”ç”¨å½¢å¼ä¹‹å¤æ‚ã€å‚ä¸äººæ•°ä¹‹ä¼—å¤šä¹Ÿä»¤äººå’‹èˆŒã€‚


éšç€Java7çš„æ­£å¼å‘å¸ƒï¼ŒJavaè™šæ‹Ÿæœºçš„è®¾è®¡è€…ä»¬é€šè¿‡JSR-292è§„èŒƒåŸºæœ¬å®ç°åœ¨Javaè™šæ‹Ÿæœºå¹³å°ä¸Šè¿è¡ŒéJavaè¯­è¨€ç¼–å†™çš„ç¨‹åºã€‚
Javaè™šæ‹Ÿæœºæ ¹æœ¬ä¸å…³å¿ƒè¿è¡Œåœ¨å…¶å†…éƒ¨çš„ç¨‹åºåˆ°åº•æ˜¯ä½¿ç”¨ä½•ç§ç¼–ç¨‹è¯­è¨€ç¼–å†™çš„ï¼Œå®ƒåªå…³å¿ƒâ€œå­—èŠ‚ç â€æ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´Javaè™šæ‹Ÿæœºæ‹¥æœ‰è¯­è¨€æ— å…³æ€§ï¼Œå¹¶ä¸ä¼šå•çº¯åœ°ä¸Javaè¯­è¨€â€œç»ˆèº«ç»‘å®šâ€ï¼Œåªè¦å…¶ä»–ç¼–ç¨‹è¯­è¨€çš„ç¼–è¯‘ç»“æœæ»¡è¶³å¹¶åŒ…å«Javaè™šæ‹Ÿæœºçš„å†…éƒ¨æŒ‡ä»¤é›†ã€ç¬¦å·è¡¨ä»¥åŠå…¶ä»–çš„è¾…åŠ©ä¿¡æ¯ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å­—èŠ‚ç æ–‡ä»¶ï¼Œå°±èƒ½å¤Ÿè¢«è™šæ‹Ÿæœºæ‰€è¯†åˆ«å¹¶è£…è½½è¿è¡Œã€‚
2. å­—èŠ‚ç æˆ‘ä»¬å¹³æ—¶è¯´çš„javaå­—èŠ‚ç ï¼ŒæŒ‡çš„æ˜¯ç”¨javaè¯­è¨€ç¼–è¯‘æˆçš„å­—èŠ‚ç ã€‚å‡†ç¡®çš„è¯´ä»»ä½•èƒ½åœ¨jvmå¹³å°ä¸Šæ‰§è¡Œçš„å­—èŠ‚ç æ ¼å¼éƒ½æ˜¯ä¸€æ ·çš„ã€‚æ‰€ä»¥åº”è¯¥ç»Ÿç§°ä¸ºï¼šjvmå­—èŠ‚ç ã€‚
ä¸åŒçš„ç¼–è¯‘å™¨ï¼Œå¯ä»¥ç¼–è¯‘å‡ºç›¸åŒçš„å­—èŠ‚ç æ–‡ä»¶ï¼Œå­—èŠ‚ç æ–‡ä»¶ä¹Ÿå¯ä»¥åœ¨ä¸åŒçš„JVMä¸Šè¿è¡Œã€‚
Javaè™šæ‹Ÿæœºä¸Javaè¯­è¨€å¹¶æ²¡æœ‰å¿…ç„¶çš„è”ç³»ï¼Œå®ƒåªä¸ç‰¹å®šçš„äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼â€”Classæ–‡ä»¶æ ¼å¼æ‰€å…³è”ï¼ŒClassæ–‡ä»¶ä¸­åŒ…å«äº†Javaè™šæ‹ŸæœºæŒ‡ä»¤é›†ï¼ˆæˆ–è€…ç§°ä¸ºå­—èŠ‚ç ã€Bytecodesï¼‰å’Œç¬¦å·è¡¨ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–è¾…åŠ©ä¿¡æ¯ã€‚
3. å¤šè¯­è¨€æ··åˆç¼–ç¨‹Javaå¹³å°ä¸Šçš„å¤šè¯­è¨€æ··åˆç¼–ç¨‹æ­£æˆä¸ºä¸»æµï¼Œé€šè¿‡ç‰¹å®šé¢†åŸŸçš„è¯­è¨€å»è§£å†³ç‰¹å®šé¢†åŸŸçš„é—®é¢˜æ˜¯å½“å‰è½¯ä»¶å¼€å‘åº”å¯¹æ—¥è¶‹å¤æ‚çš„é¡¹ç›®éœ€æ±‚çš„ä¸€ä¸ªæ–¹å‘ã€‚
è¯•æƒ³ä¸€ä¸‹ï¼Œåœ¨ä¸€ä¸ªé¡¹ç›®ä¹‹ä¸­ï¼Œå¹¶è¡Œå¤„ç†ç”¨clojureè¯­è¨€ç¼–å†™ï¼Œå±•ç¤ºå±‚ä½¿ç”¨JRuby&#x2F;Railsï¼Œä¸­é—´å±‚åˆ™æ˜¯Javaï¼Œæ¯ä¸ªåº”ç”¨å±‚éƒ½å°†ä½¿ç”¨ä¸åŒçš„ç¼–ç¨‹è¯­è¨€æ¥å®Œæˆï¼Œè€Œä¸”ï¼Œæ¥å£å¯¹æ¯ä¸€å±‚çš„å¼€å‘è€…éƒ½æ˜¯é€æ˜çš„ï¼Œå„ç§è¯­è¨€ä¹‹é—´çš„äº¤äº’ä¸å­˜åœ¨ä»»ä½•å›°éš¾ï¼Œå°±åƒä½¿ç”¨è‡ªå·±è¯­è¨€çš„åŸç”ŸAPIä¸€æ ·æ–¹ä¾¿ï¼Œå› ä¸ºå®ƒä»¬æœ€ç»ˆéƒ½è¿è¡Œåœ¨ä¸€ä¸ªè™šæ‹Ÿæœºä¹‹ä¸Šã€‚
å¯¹è¿™äº›è¿è¡ŒäºJavaè™šæ‹Ÿæœºä¹‹ä¸Šã€Javaä¹‹å¤–çš„è¯­è¨€ï¼Œæ¥è‡ªç³»ç»Ÿçº§çš„ã€åº•å±‚çš„æ”¯æŒæ­£åœ¨è¿…é€Ÿå¢å¼ºï¼Œä»¥JSR-292ä¸ºæ ¸å¿ƒçš„ä¸€ç³»åˆ—é¡¹ç›®å’ŒåŠŸèƒ½æ”¹è¿›ï¼ˆå¦‚Da Vinci Machineé¡¹ç›®ã€Nashornå¼•æ“ã€InvokeDynamicæŒ‡ä»¤ã€java.lang.invokeåŒ…ç­‰ï¼‰ï¼Œæ¨åŠ¨Javaè™šæ‹Ÿæœºä»â€œJavaè¯­è¨€çš„è™šæ‹Ÿæœºâ€å‘ â€œå¤šè¯­è¨€è™šæ‹Ÿæœºâ€çš„æ–¹å‘å‘å±•ã€‚
4. Javaå‘å±•çš„é‡å¤§äº‹ä»¶
1990å¹´ï¼Œåœ¨Sunè®¡ç®—æœºå…¬å¸ä¸­ï¼Œç”±Patrick Naughtonã€MikeSheridanåŠJames Goslingé¢†å¯¼çš„å°ç»„Green Teamï¼Œå¼€å‘å‡ºçš„æ–°çš„ç¨‹åºè¯­è¨€ï¼Œå‘½åä¸ºoakï¼ŒåæœŸå‘½åä¸ºJava
1995å¹´ï¼ŒSunæ­£å¼å‘å¸ƒJavaå’ŒHotJavaäº§å“ï¼ŒJavaé¦–æ¬¡å…¬å¼€äº®ç›¸ã€‚
1996å¹´1æœˆ23æ—¥sun Microsystemså‘å¸ƒäº†JDK 1.0ã€‚
1998å¹´ï¼ŒJDK1.2ç‰ˆæœ¬å‘å¸ƒã€‚åŒæ—¶ï¼Œsunå‘å¸ƒäº†JSP&#x2F;Servletã€EJBè§„èŒƒï¼Œä»¥åŠå°†Javaåˆ†æˆäº†J2EEã€J2SEå’ŒJ2MEã€‚è¿™è¡¨æ˜äº†Javaå¼€å§‹å‘ä¼ä¸šã€æ¡Œé¢åº”ç”¨å’Œç§»åŠ¨è®¾å¤‡åº”ç”¨3å¤§é¢†åŸŸæŒºè¿›ã€‚
2000å¹´ï¼ŒJDK1.3å‘å¸ƒï¼ŒJava HotSpot Virtual Machineæ­£å¼å‘å¸ƒï¼Œæˆä¸ºJavaçš„é»˜è®¤è™šæ‹Ÿæœºã€‚
2002å¹´ï¼ŒJDK1.4å‘å¸ƒï¼Œå¤è€çš„Classicè™šæ‹Ÿæœºé€€å‡ºå†å²èˆå°ã€‚
2003å¹´å¹´åº•ï¼ŒJavaå¹³å°çš„scalaæ­£å¼å‘å¸ƒï¼ŒåŒå¹´Groovyä¹ŸåŠ å…¥äº†Javaé˜µè¥ã€‚
2004å¹´ï¼ŒJDK1.5å‘å¸ƒã€‚åŒæ—¶JDK1.5æ”¹åä¸ºJavaSE5.0ã€‚
2006å¹´ï¼ŒJDK6å‘å¸ƒã€‚åŒå¹´ï¼ŒJavaå¼€æºå¹¶å»ºç«‹äº†openJDKã€‚é¡ºç†æˆç« ï¼ŒHotspotè™šæ‹Ÿæœºä¹Ÿæˆä¸ºäº†openJDKä¸­çš„é»˜è®¤è™šæ‹Ÿæœºã€‚
2007å¹´ï¼ŒJavaå¹³å°è¿æ¥äº†æ–°ä¼™ä¼´Clojureã€‚
2008å¹´ï¼Œoracleæ”¶è´­äº†BEAï¼Œå¾—åˆ°äº†JRockitè™šæ‹Ÿæœºã€‚
2009å¹´ï¼ŒTwitterå®£å¸ƒæŠŠåå°å¤§éƒ¨åˆ†ç¨‹åºä»Rubyè¿ç§»åˆ°scalaï¼Œè¿™æ˜¯Javaå¹³å°çš„åˆä¸€æ¬¡å¤§è§„æ¨¡åº”ç”¨ã€‚
2010å¹´ï¼Œoracleæ”¶è´­äº†sunï¼Œè·å¾—Javaå•†æ ‡å’Œæœ€çœŸä»·å€¼çš„HotSpotè™šæ‹Ÿæœºã€‚æ­¤æ—¶ï¼Œoracleæ‹¥æœ‰å¸‚åœºå ç”¨ç‡æœ€é«˜çš„ä¸¤æ¬¾è™šæ‹ŸæœºHotSpotå’ŒJRockitï¼Œå¹¶è®¡åˆ’åœ¨æœªæ¥å¯¹å®ƒä»¬è¿›è¡Œæ•´åˆï¼šHotRockit
2011å¹´ï¼ŒJDK7å‘å¸ƒã€‚åœ¨JDK1.7u4ä¸­ï¼Œæ­£å¼å¯ç”¨äº†æ–°çš„åƒåœ¾å›æ”¶å™¨G1ã€‚
2017å¹´ï¼ŒJDK9å‘å¸ƒã€‚å°†G1è®¾ç½®ä¸ºé»˜è®¤Gcï¼Œæ›¿ä»£CMS
åŒå¹´ï¼ŒIBMçš„J9å¼€æºï¼Œå½¢æˆäº†ç°åœ¨çš„open J9ç¤¾åŒº
2018å¹´ï¼ŒAndroidçš„Javaä¾µæƒæ¡ˆåˆ¤å†³ï¼ŒGoogleèµ”å¿oracleè®¡88äº¿ç¾å…ƒ
åŒå¹´ï¼Œoracleå®£å‘ŠJavagEæˆä¸ºå†å²åè¯JDBCã€JMSã€Servletèµ äºˆEclipseåŸºé‡‘ä¼š
åŒå¹´ï¼ŒJDK11å‘å¸ƒï¼ŒLTSç‰ˆæœ¬çš„JDKï¼Œå‘å¸ƒé©å‘½æ€§çš„zGcï¼Œè°ƒæ•´JDKæˆæƒè®¸å¯
2019å¹´ï¼ŒJDK12å‘å¸ƒï¼ŒåŠ å…¥RedHaté¢†å¯¼å¼€å‘çš„shenandoah GC


åœ¨JDK11ä¹‹å‰ï¼ŒoracleJDKä¸­è¿˜ä¼šå­˜åœ¨ä¸€äº›openJDKä¸­æ²¡æœ‰çš„ã€é—­æºçš„åŠŸèƒ½ã€‚ä½†åœ¨JDK11ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºopenJDKå’ŒoracleJDKä»£ç å®è´¨ä¸Šå·²ç»å®Œå…¨ä¸€è‡´çš„ç¨‹åº¦ã€‚
5. è™šæ‹Ÿæœºä¸Javaè™šæ‹Ÿæœºæ‰€è°“è™šæ‹Ÿæœºï¼ˆVirtual Machineï¼‰ï¼Œå°±æ˜¯ä¸€å°è™šæ‹Ÿçš„è®¡ç®—æœºã€‚å®ƒæ˜¯ä¸€æ¬¾è½¯ä»¶ï¼Œç”¨æ¥æ‰§è¡Œä¸€ç³»åˆ—è™šæ‹Ÿè®¡ç®—æœºæŒ‡ä»¤ã€‚å¤§ä½“ä¸Šï¼Œè™šæ‹Ÿæœºå¯ä»¥åˆ†ä¸ºç³»ç»Ÿè™šæ‹Ÿæœºå’Œç¨‹åºè™šæ‹Ÿæœºã€‚

å¤§åé¼é¼çš„Visual Boxï¼ŒMwareå°±å±äºç³»ç»Ÿè™šæ‹Ÿæœºï¼Œå®ƒä»¬å®Œå…¨æ˜¯å¯¹ç‰©ç†è®¡ç®—æœºçš„ä»¿çœŸï¼Œæä¾›äº†ä¸€ä¸ªå¯è¿è¡Œå®Œæ•´æ“ä½œç³»ç»Ÿçš„è½¯ä»¶å¹³å°ã€‚
ç¨‹åºè™šæ‹Ÿæœºçš„å…¸å‹ä»£è¡¨å°±æ˜¯Javaè™šæ‹Ÿæœºï¼Œå®ƒä¸“é—¨ä¸ºæ‰§è¡Œå•ä¸ªè®¡ç®—æœºç¨‹åºè€Œè®¾è®¡ï¼Œåœ¨Javaè™šæ‹Ÿæœºä¸­æ‰§è¡Œçš„æŒ‡ä»¤æˆ‘ä»¬ç§°ä¸ºJavaå­—èŠ‚ç æŒ‡ä»¤ã€‚

æ— è®ºæ˜¯ç³»ç»Ÿè™šæ‹Ÿæœºè¿˜æ˜¯ç¨‹åºè™šæ‹Ÿæœºï¼Œåœ¨ä¸Šé¢è¿è¡Œçš„è½¯ä»¶éƒ½è¢«é™åˆ¶äºè™šæ‹Ÿæœºæä¾›çš„èµ„æºä¸­ã€‚
6. Javaè™šæ‹ŸæœºJavaè™šæ‹Ÿæœºæ˜¯ä¸€å°æ‰§è¡ŒJavaå­—èŠ‚ç çš„è™šæ‹Ÿè®¡ç®—æœºï¼Œå®ƒæ‹¥æœ‰ç‹¬ç«‹çš„è¿è¡Œæœºåˆ¶ï¼Œå…¶è¿è¡Œçš„Javaå­—èŠ‚ç ä¹Ÿæœªå¿…ç”±Javaè¯­è¨€ç¼–è¯‘è€Œæˆã€‚
JVMå¹³å°çš„å„ç§è¯­è¨€å¯ä»¥å…±äº«Javaè™šæ‹Ÿæœºå¸¦æ¥çš„è·¨å¹³å°æ€§ã€ä¼˜ç§€çš„åƒåœ¾å›å™¨ï¼Œä»¥åŠå¯é çš„å³æ—¶ç¼–è¯‘å™¨ã€‚
JavaæŠ€æœ¯çš„æ ¸å¿ƒå°±æ˜¯Javaè™šæ‹Ÿæœºï¼ˆJVMï¼ŒJava Virtual Machineï¼‰ï¼Œå› ä¸ºæ‰€æœ‰çš„Javaç¨‹åºéƒ½è¿è¡Œåœ¨Javaè™šæ‹Ÿæœºå†…éƒ¨ã€‚
Javaè™šæ‹Ÿæœºå°±æ˜¯äºŒè¿›åˆ¶å­—èŠ‚ç çš„è¿è¡Œç¯å¢ƒï¼Œè´Ÿè´£è£…è½½å­—èŠ‚ç åˆ°å…¶å†…éƒ¨ï¼Œè§£é‡Š&#x2F;ç¼–è¯‘ä¸ºå¯¹åº”å¹³å°ä¸Šçš„æœºå™¨æŒ‡ä»¤æ‰§è¡Œã€‚æ¯ä¸€æ¡JavaæŒ‡ä»¤ï¼ŒJavaè™šæ‹Ÿæœºè§„èŒƒä¸­éƒ½æœ‰è¯¦ç»†å®šä¹‰ï¼Œå¦‚æ€ä¹ˆå–æ“ä½œæ•°ï¼Œæ€ä¹ˆå¤„ç†æ“ä½œæ•°ï¼Œå¤„ç†ç»“æœæ”¾åœ¨å“ªé‡Œã€‚
ç‰¹ç‚¹ï¼š

ä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œ
è‡ªåŠ¨å†…å­˜ç®¡ç†
è‡ªåŠ¨åƒåœ¾å›æ”¶åŠŸèƒ½

7. JVMçš„ä½ç½®JVMæ˜¯è¿è¡Œåœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šçš„ï¼Œå®ƒä¸ç¡¬ä»¶æ²¡æœ‰ç›´æ¥çš„äº¤äº’


Javaçš„ä½“ç³»ç»“æ„


8. JVMæ•´ä½“ç»“æ„
HotSpot VMæ˜¯ç›®å‰å¸‚é¢ä¸Šé«˜æ€§èƒ½è™šæ‹Ÿæœºçš„ä»£è¡¨ä½œä¹‹ä¸€ã€‚
å®ƒé‡‡ç”¨è§£é‡Šå™¨ä¸å³æ—¶ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„ã€‚
åœ¨ä»Šå¤©ï¼ŒJavaç¨‹åºçš„è¿è¡Œæ€§èƒ½æ—©å·²è„±èƒæ¢éª¨ï¼Œå·²ç»è¾¾åˆ°äº†å¯ä»¥å’ŒC&#x2F;C++ç¨‹åºä¸€è¾ƒé«˜ä¸‹çš„åœ°æ­¥ã€‚


æ‰§è¡Œå¼•æ“åŒ…å«ä¸‰éƒ¨åˆ†ï¼šè§£é‡Šå™¨ï¼ŒåŠæ—¶ç¼–è¯‘å™¨ï¼Œåƒåœ¾å›æ”¶å™¨
9. Javaä»£ç æ‰§è¡Œæµç¨‹åªæ˜¯èƒ½ç”Ÿæˆè¢«Javaè™šæ‹Ÿæœºæ‰€èƒ½è§£é‡Šçš„å­—èŠ‚ç æ–‡ä»¶ï¼Œé‚£ä¹ˆç†è®ºä¸Šå°±å¯ä»¥è‡ªå·±è®¾è®¡ä¸€å¥—ä»£ç äº†

10. JVMçš„æ¶æ„æ¨¡å‹
åœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°Javaç¼–è¯‘å™¨è¾“å…¥çš„æŒ‡ä»¤æµåŸºæœ¬ä¸Šæ˜¯ä¸€ç§åŸºäºæ ˆçš„æŒ‡ä»¤é›†æ¶æ„ï¼Œå¦å¤–ä¸€ç§æŒ‡ä»¤é›†æ¶æ„åˆ™æ˜¯åŸºäºå¯„å­˜å™¨çš„æŒ‡ä»¤é›†æ¶æ„ã€‚å…·ä½“æ¥è¯´ï¼šè¿™ä¸¤ç§æ¶æ„ä¹‹é—´çš„åŒºåˆ«ï¼š

åŸºäºæ ˆå¼æ¶æ„çš„ç‰¹ç‚¹
è®¾è®¡å’Œå®ç°æ›´ç®€å•ï¼Œé€‚ç”¨äºèµ„æºå—é™çš„ç³»ç»Ÿï¼›
é¿å¼€äº†å¯„å­˜å™¨çš„åˆ†é…éš¾é¢˜ï¼šä½¿ç”¨é›¶åœ°å€æŒ‡ä»¤æ–¹å¼åˆ†é…ã€‚
æŒ‡ä»¤æµä¸­çš„æŒ‡ä»¤å¤§éƒ¨åˆ†æ˜¯é›¶åœ°å€æŒ‡ä»¤ï¼Œå…¶æ‰§è¡Œè¿‡ç¨‹ä¾èµ–äºæ“ä½œæ ˆã€‚æŒ‡ä»¤é›†æ›´å°ï¼Œç¼–è¯‘å™¨å®¹æ˜“å®ç°ã€‚
ä¸éœ€è¦ç¡¬ä»¶æ”¯æŒï¼Œå¯ç§»æ¤æ€§æ›´å¥½ï¼Œæ›´å¥½å®ç°è·¨å¹³å°


åŸºäºå¯„å­˜å™¨æ¶æ„çš„ç‰¹ç‚¹
å…¸å‹çš„åº”ç”¨æ˜¯x86çš„äºŒè¿›åˆ¶æŒ‡ä»¤é›†ï¼šæ¯”å¦‚ä¼ ç»Ÿçš„PCä»¥åŠAndroidçš„Davlikè™šæ‹Ÿæœºã€‚
æŒ‡ä»¤é›†æ¶æ„åˆ™å®Œå…¨ä¾èµ–ç¡¬ä»¶ï¼Œå¯ç§»æ¤æ€§å·®
æ€§èƒ½ä¼˜ç§€å’Œæ‰§è¡Œæ›´é«˜æ•ˆ
èŠ±è´¹æ›´å°‘çš„æŒ‡ä»¤å»å®Œæˆä¸€é¡¹æ“ä½œã€‚
åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼ŒåŸºäºå¯„å­˜å™¨æ¶æ„çš„æŒ‡ä»¤é›†å¾€å¾€éƒ½ä»¥ä¸€åœ°å€æŒ‡ä»¤ã€äºŒåœ°å€æŒ‡ä»¤å’Œä¸‰åœ°å€æŒ‡ä»¤ä¸ºä¸»ï¼Œè€ŒåŸºäºæ ˆå¼æ¶æ„çš„æŒ‡ä»¤é›†å´æ˜¯ä»¥é›¶åœ°å€æŒ‡ä»¤ä¸ºä¸»




ä¸¤ç§æ¶æ„çš„ä¸¾ä¾‹
  åŒæ ·æ‰§è¡Œ2+3è¿™ç§é€»è¾‘æ“ä½œï¼Œå…¶æŒ‡ä»¤åˆ†åˆ«å¦‚ä¸‹ï¼š

åŸºäºæ ˆçš„è®¡ç®—æµç¨‹ï¼ˆä»¥Javaè™šæ‹Ÿæœºä¸ºä¾‹ï¼‰ï¼š8ä¸ªæŒ‡ä»¤

  iconst_2 //å¸¸é‡2å…¥æ ˆistore_1 // å°†å¸¸é‡2ä»æ“ä½œæ•°æ ˆå­˜ä»˜åˆ°å±€éƒ¨å˜é‡è¡¨ ç¬¬2ä¸ªä½ç½®iconst_3 // å¸¸é‡3å…¥æ ˆistore_2 // å°†å¸¸é‡3ä»æ“ä½œæ•°æ ˆå­˜ä»˜åˆ°å±€éƒ¨å˜é‡è¡¨ ç¬¬3ä¸ªä½ç½® iload_1 // åŠ è½½å±€éƒ¨å˜é‡ç¬¬1ä¸ªå˜é‡å‹å…¥æ“ä½œæ•°æ ˆiload_2 // åŠ è½½å±€éƒ¨å˜é‡ç¬¬2ä¸ªå˜é‡å‹å…¥æ“ä½œæ•°æ ˆiadd // å¸¸é‡2/3å‡ºæ ˆï¼Œæ‰§è¡Œç›¸åŠ istore_0 // ç»“æœ5å…¥æ ˆ

è€ŒåŸºäºå¯„å­˜å™¨çš„è®¡ç®—æµç¨‹

  mov eax,2 //å°†eaxå¯„å­˜å™¨çš„å€¼è®¾ä¸º1add eax,3 //ä½¿eaxå¯„å­˜å™¨çš„å€¼åŠ 3

11. å­—èŠ‚ç åç¼–è¯‘
æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªç®€å•çš„ä»£ç ï¼Œç„¶åæŸ¥çœ‹ä¸€ä¸‹å­—èŠ‚ç çš„åç¼–è¯‘åçš„ç»“æœ
  package com.peppa;/** * @author peppa * @create 2022-02-08 15:51:45 */public class StackStruTest &#123;    public static void main(String[] args) &#123;        int i = 2 + 3;    &#125;&#125;

ç„¶åæˆ‘ä»¬æ‰¾åˆ°ç¼–è¯‘åçš„ classæ–‡ä»¶ï¼Œä½¿ç”¨ä¸‹åˆ—å‘½ä»¤è¿›è¡Œåç¼–è¯‘
  javap -v StackStruTest.class
  åç¼–è¯‘ç»“æœï¼š
  public class com.peppa.StackStruTest  minor version: 0  major version: 52  flags: (0x0021) ACC_PUBLIC, ACC_SUPER  this_class: #5                          // com/peppa/StackStruTest  super_class: #6                         // java/lang/Object  interfaces: 0, fields: 0, methods: 2, attributes: 1Constant pool:   #1 = Methodref          #6.#23         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V   #2 = Fieldref           #24.#25        // java/lang/System.out:Ljava/io/PrintStream;   #3 = String             #26            // -----------------   #4 = Methodref          #27.#28        // java/io/PrintStream.println:(Ljava/lang/String;)V   #5 = Class              #29            // com/peppa/StackStruTest   #6 = Class              #30            // java/lang/Object   #7 = Utf8               &lt;init&gt;   #8 = Utf8               ()V   #9 = Utf8               Code  #10 = Utf8               LineNumberTable  #11 = Utf8               LocalVariableTable  #12 = Utf8               this  #13 = Utf8               Lcom/peppa/StackStruTest;  #14 = Utf8               main  #15 = Utf8               ([Ljava/lang/String;)V  #16 = Utf8               args  #17 = Utf8               [Ljava/lang/String;  #18 = Utf8               i  #19 = Utf8               I  #20 = Utf8               MethodParameters  #21 = Utf8               SourceFile  #22 = Utf8               StackStruTest.java  #23 = NameAndType        #7:#8          // &quot;&lt;init&gt;&quot;:()V  #24 = Class              #31            // java/lang/System  #25 = NameAndType        #32:#33        // out:Ljava/io/PrintStream;  #26 = Utf8               -----------------  #27 = Class              #34            // java/io/PrintStream  #28 = NameAndType        #35:#36        // println:(Ljava/lang/String;)V  #29 = Utf8               com/peppa/StackStruTest  #30 = Utf8               java/lang/Object  #31 = Utf8               java/lang/System  #32 = Utf8               out  #33 = Utf8               Ljava/io/PrintStream;  #34 = Utf8               java/io/PrintStream  #35 = Utf8               println  #36 = Utf8               (Ljava/lang/String;)V&#123;  public com.peppa.StackStruTest();    descriptor: ()V    flags: (0x0001) ACC_PUBLIC    Code:      stack=1, locals=1, args_size=1         0: aload_0         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V         4: return      LineNumberTable:        line 6: 0      LocalVariableTable:        Start  Length  Slot  Name   Signature            0       5     0  this   Lcom/peppa/StackStruTest;

12. JVMç”Ÿå‘½å‘¨æœŸ
è™šæ‹Ÿæœºçš„å¯åŠ¨
  Javaè™šæ‹Ÿæœºçš„å¯åŠ¨æ˜¯é€šè¿‡å¼•å¯¼ç±»åŠ è½½å™¨ï¼ˆbootstrap class loaderï¼‰åˆ›å»ºä¸€ä¸ªåˆå§‹ç±»ï¼ˆinitial classï¼‰æ¥å®Œæˆçš„ï¼Œè¿™ä¸ªç±»æ˜¯ç”±è™šæ‹Ÿæœºçš„å…·ä½“å®ç°æŒ‡å®šçš„ã€‚

è™šæ‹Ÿæœºçš„æ‰§è¡Œ

ä¸€ä¸ªè¿è¡Œä¸­çš„Javaè™šæ‹Ÿæœºæœ‰ç€ä¸€ä¸ªæ¸…æ™°çš„ä»»åŠ¡ï¼šæ‰§è¡ŒJavaç¨‹åºã€‚
ç¨‹åºå¼€å§‹æ‰§è¡Œæ—¶ä»–æ‰è¿è¡Œï¼Œç¨‹åºç»“æŸæ—¶ä»–å°±åœæ­¢ã€‚
æ‰§è¡Œä¸€ä¸ªæ‰€è°“çš„Javaç¨‹åºçš„æ—¶å€™ï¼ŒçœŸçœŸæ­£æ­£åœ¨æ‰§è¡Œçš„æ˜¯ä¸€ä¸ªå«åšJavaè™šæ‹Ÿæœºçš„è¿›ç¨‹ã€‚


è™šæ‹Ÿæœºçš„é€€å‡º

ç¨‹åºæ­£å¸¸æ‰§è¡Œç»“æŸ
ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°äº†å¼‚å¸¸æˆ–é”™è¯¯è€Œå¼‚å¸¸ç»ˆæ­¢
ç”±äºæ“ä½œç³»ç»Ÿç”¨ç°é”™è¯¯è€Œå¯¼è‡´Javaè™šæ‹Ÿæœºè¿›ç¨‹ç»ˆæ­¢
æŸçº¿ç¨‹è°ƒç”¨Runtimeç±»æˆ–Systemç±»çš„exitæ–¹æ³•ï¼Œæˆ–Runtimeç±»çš„haltæ–¹æ³•ï¼Œå¹¶ä¸”Javaå®‰å…¨ç®¡ç†å™¨ä¹Ÿå…è®¸è¿™æ¬¡exitæˆ–haltæ“ä½œã€‚
é™¤æ­¤ä¹‹å¤–ï¼ŒJNIï¼ˆJava Native Interfaceï¼‰è§„èŒƒæè¿°äº†ç”¨JNI Invocation APIæ¥åŠ è½½æˆ–å¸è½½ Javaè™šæ‹Ÿæœºæ—¶ï¼ŒJavaè™šæ‹Ÿæœºçš„é€€å‡ºæƒ…å†µã€‚



13. JVMå‘å±•å†ç¨‹
Sun Classic VM

æ—©åœ¨1996å¹´Java1.0ç‰ˆæœ¬çš„æ—¶å€™ï¼ŒSunå…¬å¸å‘å¸ƒäº†ä¸€æ¬¾åä¸ºsun classic VMçš„Javaè™šæ‹Ÿæœºï¼Œå®ƒåŒæ—¶ä¹Ÿæ˜¯ä¸–ç•Œä¸Šç¬¬ä¸€æ¬¾å•†ç”¨Javaè™šæ‹Ÿæœºï¼ŒJDK1.4æ—¶å®Œå…¨è¢«æ·˜æ±°ã€‚
è¿™æ¬¾è™šæ‹Ÿæœºå†…éƒ¨åªæä¾›è§£é‡Šå™¨ï¼Œæ²¡æœ‰å³æ—¶ç¼–è¯‘å™¨ï¼Œå› æ­¤æ•ˆç‡æ¯”è¾ƒä½ã€‚ã€å³æ—¶ç¼–è¯‘å™¨ä¼šæŠŠçƒ­ç‚¹ä»£ç çš„æœ¬åœ°æœºå™¨æŒ‡ä»¤ç¼“å­˜èµ·æ¥ï¼Œé‚£ä¹ˆä»¥åä½¿ç”¨çƒ­ç‚¹ä»£ç çš„æ—¶å€™ï¼Œæ•ˆç‡å°±æ¯”è¾ƒé«˜ã€‘
å¦‚æœä½¿ç”¨JITç¼–è¯‘å™¨ï¼Œå°±éœ€è¦è¿›è¡Œå¤–æŒ‚ã€‚ä½†æ˜¯ä¸€æ—¦ä½¿ç”¨äº†JITç¼–è¯‘å™¨ï¼ŒJITå°±ä¼šæ¥ç®¡è™šæ‹Ÿæœºçš„æ‰§è¡Œç³»ç»Ÿã€‚è§£é‡Šå™¨å°±ä¸å†å·¥ä½œï¼Œè§£é‡Šå™¨å’Œç¼–è¯‘å™¨ä¸èƒ½é…åˆå·¥ä½œã€‚
æˆ‘ä»¬å°†å­—èŠ‚ç æŒ‡ä»¤ç¿»è¯‘æˆæœºå™¨æŒ‡ä»¤ä¹Ÿæ˜¯éœ€è¦èŠ±æ—¶é—´çš„ï¼Œå¦‚æœåªä½¿ç”¨JITï¼Œå°±éœ€è¦æŠŠæ‰€æœ‰å­—èŠ‚ç æŒ‡ä»¤éƒ½ç¿»è¯‘æˆæœºå™¨æŒ‡ä»¤ï¼Œå°±ä¼šå¯¼è‡´ç¿»è¯‘æ—¶é—´è¿‡é•¿ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ç¨‹åºåˆšå¯åŠ¨çš„æ—¶å€™ï¼Œç­‰å¾…æ—¶é—´ä¼šå¾ˆé•¿ã€‚
è€Œè§£é‡Šå™¨å°±æ˜¯èµ°åˆ°å“ªï¼Œè§£é‡Šåˆ°å“ªã€‚


ç°åœ¨Hotspotå†…ç½®äº†æ­¤è™šæ‹Ÿæœºã€‚


Exact VM

ä¸ºäº†è§£å†³ä¸Šä¸€ä¸ªè™šæ‹Ÿæœºé—®é¢˜ï¼Œjdk1.2æ—¶ï¼ŒSunæä¾›äº†æ­¤è™šæ‹Ÿæœºã€‚
Exact Memory Managementï¼šå‡†ç¡®å¼å†…å­˜ç®¡ç†
ä¹Ÿå¯ä»¥å«Non-Conservative&#x2F;Accurate Memory Management
è™šæ‹Ÿæœºå¯ä»¥çŸ¥é“å†…å­˜ä¸­æŸä¸ªä½ç½®çš„æ•°æ®å…·ä½“æ˜¯ä»€ä¹ˆç±»å‹ã€‚


å…·å¤‡ç°ä»£é«˜æ€§èƒ½è™šæ‹Ÿæœºçš„ç»´å½¢
çƒ­ç‚¹æ¢æµ‹ï¼ˆå¯»æ‰¾å‡ºçƒ­ç‚¹ä»£ç è¿›è¡Œç¼“å­˜ï¼‰
ç¼–è¯‘å™¨ä¸è§£é‡Šå™¨æ··åˆå·¥ä½œæ¨¡å¼


åªåœ¨Solariså¹³å°çŸ­æš‚ä½¿ç”¨ï¼Œå…¶ä»–å¹³å°ä¸Šè¿˜æ˜¯classic vmï¼Œè‹±é›„æ°”çŸ­ï¼Œç»ˆè¢«Hotspotè™šæ‹Ÿæœºæ›¿æ¢


HotSpot VMï¼ˆé‡ç‚¹ï¼‰

HotSpotå†å²
æœ€åˆç”±ä¸€å®¶åä¸ºâ€œLongview Technologiesâ€çš„å°å…¬å¸è®¾è®¡
1997å¹´ï¼Œæ­¤å…¬å¸è¢«Sunæ”¶è´­ï¼›2009å¹´ï¼ŒSunå…¬å¸è¢«ç”²éª¨æ–‡æ”¶è´­ã€‚
JDK1.3æ—¶ï¼ŒHotSpot VMæˆä¸ºé»˜è®¤è™šæ‹Ÿæœº


ç›®å‰Hotspotå æœ‰ç»å¯¹çš„å¸‚åœºåœ°ä½ï¼Œç§°éœ¸æ­¦æ—ã€‚
ä¸ç®¡æ˜¯ç°åœ¨ä»åœ¨å¹¿æ³›ä½¿ç”¨çš„JDK6ï¼Œè¿˜æ˜¯ä½¿ç”¨æ¯”ä¾‹è¾ƒå¤šçš„JDK8ä¸­ï¼Œé»˜è®¤çš„è™šæ‹Ÿæœºéƒ½æ˜¯HotSpot
Sun&#x2F;oracle JDKå’ŒopenJDKçš„é»˜è®¤è™šæ‹Ÿæœº
å› æ­¤æœ¬è¯¾ç¨‹ä¸­é»˜è®¤ä»‹ç»çš„è™šæ‹Ÿæœºéƒ½æ˜¯HotSpotï¼Œç›¸å…³æœºåˆ¶ä¹Ÿä¸»è¦æ˜¯æŒ‡HotSpotçš„GCæœºåˆ¶ã€‚ï¼ˆæ¯”å¦‚å…¶ä»–ä¸¤ä¸ªå•†ç”¨è™šæœºéƒ½æ²¡æœ‰æ–¹æ³•åŒºçš„æ¦‚å¿µï¼‰


ä»æœåŠ¡å™¨ã€æ¡Œé¢åˆ°ç§»åŠ¨ç«¯ã€åµŒå…¥å¼éƒ½æœ‰åº”ç”¨ã€‚
åç§°ä¸­çš„HotSpotæŒ‡çš„å°±æ˜¯å®ƒçš„çƒ­ç‚¹ä»£ç æ¢æµ‹æŠ€æœ¯ã€‚
é€šè¿‡è®¡æ•°å™¨æ‰¾åˆ°æœ€å…·ç¼–è¯‘ä»·å€¼ä»£ç ï¼Œè§¦å‘å³æ—¶ç¼–è¯‘æˆ–æ ˆä¸Šæ›¿æ¢
é€šè¿‡ç¼–è¯‘å™¨ä¸è§£é‡Šå™¨ååŒå·¥ä½œï¼Œåœ¨æœ€ä¼˜åŒ–çš„ç¨‹åºå“åº”æ—¶é—´ä¸æœ€ä½³æ‰§è¡Œæ€§èƒ½ä¸­å–å¾—å¹³è¡¡




JRockitï¼ˆå•†ç”¨ä¸‰å¤§è™šæ‹Ÿæœºä¹‹ä¸€ï¼‰

ä¸“æ³¨äºæœåŠ¡å™¨ç«¯åº”ç”¨ï¼šå®ƒå¯ä»¥ä¸å¤ªå…³æ³¨ç¨‹åºå¯åŠ¨é€Ÿåº¦ï¼Œå› æ­¤JRockitå†…éƒ¨ä¸åŒ…å«è§£æå™¨å®ç°ï¼Œå…¨éƒ¨ä»£ç éƒ½é å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åæ‰§è¡Œã€‚
å¤§é‡çš„è¡Œä¸šåŸºå‡†æµ‹è¯•æ˜¾ç¤ºï¼ŒJRockit JVMæ˜¯ä¸–ç•Œä¸Šæœ€å¿«çš„JVMï¼šä½¿ç”¨JRockitäº§å“ï¼Œå®¢æˆ·å·²ç»ä½“éªŒåˆ°äº†æ˜¾è‘—çš„æ€§èƒ½æé«˜ï¼ˆä¸€äº›è¶…è¿‡äº†70%ï¼‰å’Œç¡¬ä»¶æˆæœ¬çš„å‡å°‘ï¼ˆè¾¾50%ï¼‰ã€‚
ä¼˜åŠ¿ï¼šå…¨é¢çš„Javaè¿è¡Œæ—¶è§£å†³æ–¹æ¡ˆç»„åˆ
JRockité¢å‘å»¶è¿Ÿæ•æ„Ÿå‹åº”ç”¨çš„è§£å†³æ–¹æ¡ˆJRockit Real Timeæä¾›ä»¥æ¯«ç§’æˆ–å¾®ç§’çº§çš„JVMå“åº”æ—¶é—´ï¼Œé€‚åˆè´¢åŠ¡ã€å†›äº‹æŒ‡æŒ¥ã€ç”µä¿¡ç½‘ç»œçš„éœ€è¦
Mission ControlæœåŠ¡å¥—ä»¶ï¼Œå®ƒæ˜¯ä¸€ç»„ä»¥æä½çš„å¼€é”€æ¥ç›‘æ§ã€ç®¡ç†å’Œåˆ†æç”Ÿäº§ç¯å¢ƒä¸­çš„åº”ç”¨ç¨‹åºçš„å·¥å…·ã€‚


2008å¹´ï¼ŒJRockitè¢«Oracleæ”¶è´­ã€‚
Oracleè¡¨è¾¾äº†æ•´åˆä¸¤å¤§ä¼˜ç§€è™šæ‹Ÿæœºçš„å·¥ä½œï¼Œå¤§è‡´åœ¨JDK8ä¸­å®Œæˆã€‚æ•´åˆçš„æ–¹å¼æ˜¯åœ¨HotSpotçš„åŸºç¡€ä¸Šï¼Œç§»æ¤JRockitçš„ä¼˜ç§€ç‰¹æ€§ã€‚
é«˜æ–¯æ—ï¼šç›®å‰å°±èŒäºè°·æ­Œï¼Œç ”ç©¶äººå·¥æ™ºèƒ½å’Œæ°´ä¸‹æœºå™¨äºº


IBMçš„J9ï¼ˆå•†ç”¨ä¸‰å¤§è™šæ‹Ÿæœºä¹‹ä¸€ï¼‰

å…¨ç§°ï¼šIBM Technology for Java Virtual Machineï¼Œç®€ç§°IT4Jï¼Œå†…éƒ¨ä»£å·ï¼šJ9
å¸‚åœºå®šä½ä¸HotSpotæ¥è¿‘ï¼ŒæœåŠ¡å™¨ç«¯ã€æ¡Œé¢åº”ç”¨ã€åµŒå…¥å¼ç­‰å¤šç”¨é€”VMå¹¿æ³›ç”¨äºIBMçš„å„ç§Javaäº§å“ã€‚
ç›®å‰ï¼Œæœ‰å½±å“åŠ›çš„ä¸‰å¤§å•†ç”¨è™šæ‹Ÿæœºä¹‹ä¸€ï¼Œä¹Ÿå·ç§°æ˜¯ä¸–ç•Œä¸Šæœ€å¿«çš„Javaè™šæ‹Ÿæœºã€‚
2017å¹´å·¦å³ï¼ŒIBMå‘å¸ƒäº†å¼€æºJ9VMï¼Œå‘½åä¸ºopenJ9ï¼Œäº¤ç»™EclipseåŸºé‡‘ä¼šç®¡ç†ï¼Œä¹Ÿç§°ä¸ºEclipse OpenJ9
OpenJDK -&gt; æ˜¯JDKå¼€æºäº†ï¼ŒåŒ…æ‹¬äº†è™šæ‹Ÿæœº


KVMå’ŒCDC&#x2F;CLDC Hotspot

Oracleåœ¨Java MEäº§å“çº¿ä¸Šçš„ä¸¤æ¬¾è™šæ‹Ÿæœºä¸ºï¼šCDC&#x2F;CLDC HotSpot Implementation VM
KVMï¼ˆKilobyteï¼‰æ˜¯CLDC-HIæ—©æœŸäº§å“
ç›®å‰ç§»åŠ¨é¢†åŸŸåœ°ä½å°´å°¬ï¼Œæ™ºèƒ½æœºè¢«Androidå’ŒiOSäºŒåˆ†å¤©ä¸‹ã€‚
KVMç®€å•ã€è½»é‡ã€é«˜åº¦å¯ç§»æ¤ï¼Œé¢å‘æ›´ä½ç«¯çš„è®¾å¤‡ä¸Šè¿˜ç»´æŒè‡ªå·±çš„ä¸€ç‰‡å¸‚åœº
æ™ºèƒ½æ§åˆ¶å™¨ã€ä¼ æ„Ÿå™¨
è€äººæ‰‹æœºã€ç»æµæ¬ å‘è¾¾åœ°åŒºçš„åŠŸèƒ½æ‰‹æœº


æ‰€æœ‰çš„è™šæ‹Ÿæœºçš„åŸåˆ™ï¼šä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œã€‚


Azul VM

å‰é¢ä¸‰å¤§â€œé«˜æ€§èƒ½Javaè™šæ‹Ÿæœºâ€ä½¿ç”¨åœ¨é€šç”¨ç¡¬ä»¶å¹³å°ä¸Š
è¿™é‡ŒAzul VWå’ŒBEA Liquid VMæ˜¯ä¸ç‰¹å®šç¡¬ä»¶å¹³å°ç»‘å®šã€è½¯ç¡¬ä»¶é…åˆçš„ä¸“æœ‰è™šæ‹Ÿæœºï¼šé«˜æ€§èƒ½Javaè™šæ‹Ÿæœºä¸­çš„æˆ˜æ–—æœºã€‚
Azul VMæ˜¯Azul Systemså…¬å¸åœ¨HotSpotåŸºç¡€ä¸Šè¿›è¡Œå¤§é‡æ”¹è¿›ï¼Œè¿è¡ŒäºAzul Systemså…¬å¸çš„ä¸“æœ‰ç¡¬ä»¶Vegaç³»ç»Ÿä¸Šçš„Javaè™šæ‹Ÿæœºã€‚
æ¯ä¸ªAzul VMå®ä¾‹éƒ½å¯ä»¥ç®¡ç†è‡³å°‘æ•°åä¸ªCPUå’Œæ•°ç™¾GBå†…å­˜çš„ç¡¬ä»¶èµ„æºï¼Œå¹¶æä¾›åœ¨å·¨å¤§å†…å­˜èŒƒå›´å†…å®ç°å¯æ§çš„GCæ—¶é—´çš„åƒåœ¾æ”¶é›†å™¨ã€ä¸“æœ‰ç¡¬ä»¶ä¼˜åŒ–çš„çº¿ç¨‹è°ƒåº¦ç­‰ä¼˜ç§€ç‰¹æ€§ã€‚
2010å¹´ï¼ŒAzul Systemså…¬å¸å¼€å§‹ä»ç¡¬ä»¶è½¬å‘è½¯ä»¶ï¼Œå‘å¸ƒäº†è‡ªå·±çš„Zing JVMï¼Œå¯ä»¥åœ¨é€šç”¨x86å¹³å°ä¸Šæä¾›æ¥è¿‘äºVegaç³»ç»Ÿçš„ç‰¹æ€§ã€‚


Liquid VM

é«˜æ€§èƒ½Javaè™šæ‹Ÿæœºä¸­çš„æˆ˜æ–—æœºã€‚
BEAå…¬å¸å¼€å‘çš„ï¼Œç›´æ¥è¿è¡Œåœ¨è‡ªå®¶Hypervisorç³»ç»Ÿä¸Š
Liquid VMå³æ˜¯ç°åœ¨çš„JRockit VEï¼ˆVirtual Editionï¼‰ã€‚Liquid VMä¸éœ€è¦æ“ä½œç³»ç»Ÿçš„æ”¯æŒï¼Œæˆ–è€…è¯´å®ƒè‡ªå·±æœ¬èº«å®ç°äº†ä¸€ä¸ªä¸“ç”¨æ“ä½œç³»ç»Ÿçš„å¿…è¦åŠŸèƒ½ï¼Œå¦‚çº¿ç¨‹è°ƒåº¦ã€æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œæ”¯æŒç­‰ã€‚
éšç€JRockitè™šæ‹Ÿæœºç»ˆæ­¢å¼€å‘ï¼ŒLiquid vMé¡¹ç›®ä¹Ÿåœæ­¢äº†ã€‚


Apache Marmony

Apacheä¹Ÿæ›¾ç»æ¨å‡ºè¿‡ä¸JDK1.5å’ŒJDK1.6å…¼å®¹çš„Javaè¿è¡Œå¹³å°Apache Harmonyã€‚
å®ƒæ˜¯IElfå’ŒIntelè”åˆå¼€å‘çš„å¼€æºJVMï¼Œå—åˆ°åŒæ ·å¼€æºçš„Open JDKçš„å‹åˆ¶ï¼ŒSunåšå†³ä¸è®©Harmonyè·å¾—JCPè®¤è¯ï¼Œæœ€ç»ˆäº2011å¹´é€€å½¹ï¼ŒIBMè½¬è€Œå‚ä¸OpenJDK
è™½ç„¶ç›®å‰å¹¶æ²¡æœ‰Apache Harmonyè¢«å¤§è§„æ¨¡å•†ç”¨çš„æ¡ˆä¾‹ï¼Œä½†æ˜¯å®ƒçš„Javaç±»åº“ä»£ç å¸çº³è¿›äº†Android SDKã€‚


Micorsoft JVM

å¾®è½¯ä¸ºäº†åœ¨IE3æµè§ˆå™¨ä¸­æ”¯æŒJava Appletsï¼Œå¼€å‘äº†Microsoft JVMã€‚
åªèƒ½åœ¨windowå¹³å°ä¸‹è¿è¡Œã€‚ä½†ç¡®æ˜¯å½“æ—¶Windowsä¸‹æ€§èƒ½æœ€å¥½çš„Java VMã€‚
1997å¹´ï¼ŒSunä»¥ä¾µçŠ¯å•†æ ‡ã€ä¸æ­£å½“ç«äº‰ç½ªåæŒ‡æ§å¾®è½¯æˆåŠŸï¼Œèµ”äº†Sunå¾ˆå¤šé’±ã€‚å¾®è½¯WindowsXP SP3ä¸­æŠ¹æ‰äº†å…¶VMã€‚ç°åœ¨Windowsä¸Šå®‰è£…çš„jdkéƒ½æ˜¯HotSpotã€‚


Taobao JVM

ç”±AliJVMå›¢é˜Ÿå‘å¸ƒã€‚é˜¿é‡Œï¼Œå›½å†…ä½¿ç”¨Javaæœ€å¼ºå¤§çš„å…¬å¸ï¼Œè¦†ç›–äº‘è®¡ç®—ã€é‡‘èã€ç‰©æµã€ç”µå•†ç­‰ä¼—å¤šé¢†åŸŸï¼Œéœ€è¦è§£å†³é«˜å¹¶å‘ã€é«˜å¯ç”¨ã€åˆ†å¸ƒå¼çš„å¤åˆé—®é¢˜ã€‚æœ‰å¤§é‡çš„å¼€æºäº§å“ã€‚
åŸºäºOpenJDKå¼€å‘äº†è‡ªå·±çš„å®šåˆ¶ç‰ˆæœ¬AlibabaJDKï¼Œç®€ç§°AJDKã€‚æ˜¯æ•´ä¸ªé˜¿é‡ŒJavaä½“ç³»çš„åŸºçŸ³ã€‚
åŸºäºOpenJDK Hotspot VMå‘å¸ƒçš„å›½å†…ç¬¬ä¸€ä¸ªä¼˜åŒ–ã€æ·±åº¦å®šåˆ¶ä¸”å¼€æºçš„é«˜æ€§èƒ½æœåŠ¡å™¨ç‰ˆJavaè™šæ‹Ÿæœºã€‚
åˆ›æ–°çš„GCIHï¼ˆGCinvisible heapï¼‰æŠ€æœ¯å®ç°äº†off-heapï¼Œå³å°†ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿çš„Javaå¯¹è±¡ä»heapä¸­ç§»åˆ°heapä¹‹å¤–ï¼Œå¹¶ä¸”GCä¸èƒ½ç®¡ç†GCIHå†…éƒ¨çš„Javaå¯¹è±¡ï¼Œä»¥æ­¤è¾¾åˆ°é™ä½GCçš„å›æ”¶é¢‘ç‡å’Œæå‡GCçš„å›æ”¶æ•ˆç‡çš„ç›®çš„ã€‚
GCIHä¸­çš„å¯¹è±¡è¿˜èƒ½å¤Ÿåœ¨å¤šä¸ªJavaè™šæ‹Ÿæœºè¿›ç¨‹ä¸­å®ç°å…±äº«
ä½¿ç”¨crc32æŒ‡ä»¤å®ç°JvM intrinsicé™ä½JNIçš„è°ƒç”¨å¼€é”€
PMU hardwareçš„Java profiling toolå’Œè¯Šæ–­ååŠ©åŠŸèƒ½
é’ˆå¯¹å¤§æ•°æ®åœºæ™¯çš„ZenGC


taobao vmåº”ç”¨åœ¨é˜¿é‡Œäº§å“ä¸Šæ€§èƒ½é«˜ï¼Œç¡¬ä»¶ä¸¥é‡ä¾èµ–inte1çš„cpuï¼ŒæŸå¤±äº†å…¼å®¹æ€§ï¼Œä½†æé«˜äº†æ€§èƒ½


ç›®å‰å·²ç»åœ¨æ·˜å®ã€å¤©çŒ«ä¸Šçº¿ï¼ŒæŠŠOracleå®˜æ–¹JvMç‰ˆæœ¬å…¨éƒ¨æ›¿æ¢äº†ã€‚


Dalvik VM

è°·æ­Œå¼€å‘çš„ï¼Œåº”ç”¨äºAndroidç³»ç»Ÿï¼Œå¹¶åœ¨Android2.2ä¸­æä¾›äº†JITï¼Œå‘å±•è¿…çŒ›ã€‚
Dalvik VMåªèƒ½ç§°ä½œè™šæ‹Ÿæœºï¼Œè€Œä¸èƒ½ç§°ä½œâ€œJavaè™šæ‹Ÿæœºâ€ï¼Œå®ƒæ²¡æœ‰éµå¾ª Javaè™šæ‹Ÿæœºè§„èŒƒ
ä¸èƒ½ç›´æ¥æ‰§è¡ŒJavaçš„Classæ–‡ä»¶
åŸºäºå¯„å­˜å™¨æ¶æ„ï¼Œä¸æ˜¯jvmçš„æ ˆæ¶æ„ã€‚
æ‰§è¡Œçš„æ˜¯ç¼–è¯‘ä»¥åçš„dexï¼ˆDalvik Executableï¼‰æ–‡ä»¶ã€‚æ‰§è¡Œæ•ˆç‡æ¯”è¾ƒé«˜ã€‚
å®ƒæ‰§è¡Œçš„dexï¼ˆDalvik Executableï¼‰æ–‡ä»¶å¯ä»¥é€šè¿‡classæ–‡ä»¶è½¬åŒ–è€Œæ¥ï¼Œä½¿ç”¨Javaè¯­æ³•ç¼–å†™åº”ç”¨ç¨‹åºï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å¤§éƒ¨åˆ†çš„Java APIç­‰ã€‚


Android 5.0ä½¿ç”¨æ”¯æŒæå‰ç¼–è¯‘ï¼ˆAhead of Time Compilationï¼ŒAoTï¼‰çš„ART VMæ›¿æ¢Dalvik VMã€‚


Graal VMï¼ˆæœªæ¥è™šæ‹Ÿæœºï¼‰

2018å¹´4æœˆï¼ŒOracle Labså…¬å¼€äº†GraalvMï¼Œå·ç§° â€œRun Programs Faster Anywhereâ€ï¼Œå‹ƒå‹ƒé‡å¿ƒã€‚ä¸1995å¹´javaçš„â€write onceï¼Œrun anywhereâ€é¥ç›¸å‘¼åº”ã€‚
GraalVMåœ¨HotSpot VMåŸºç¡€ä¸Šå¢å¼ºè€Œæˆçš„**è·¨è¯­è¨€å…¨æ ˆè™šæ‹Ÿæœºï¼Œå¯ä»¥ä½œä¸ºâ€œä»»ä½•è¯­è¨€â€**çš„è¿è¡Œå¹³å°ä½¿ç”¨ã€‚è¯­è¨€åŒ…æ‹¬ï¼šJavaã€Scalaã€Groovyã€Kotlinï¼›Cã€C++ã€Javascriptã€Rubyã€Pythonã€Rç­‰
æ”¯æŒä¸åŒè¯­è¨€ä¸­æ··ç”¨å¯¹æ–¹çš„æ¥å£å’Œå¯¹è±¡ï¼Œæ”¯æŒè¿™äº›è¯­è¨€ä½¿ç”¨å·²ç»ç¼–å†™å¥½çš„æœ¬åœ°åº“æ–‡ä»¶
å·¥ä½œåŸç†æ˜¯å°†è¿™äº›è¯­è¨€çš„æºä»£ç æˆ–æºä»£ç ç¼–è¯‘åçš„ä¸­é—´æ ¼å¼ï¼Œé€šè¿‡è§£é‡Šå™¨è½¬æ¢ä¸ºèƒ½è¢«Graal VMæ¥å—çš„ä¸­é—´è¡¨ç¤ºã€‚Graal VMæä¾›Truffleå·¥å…·é›†å¿«é€Ÿæ„å»ºé¢å‘ä¸€ç§æ–°è¯­è¨€çš„è§£é‡Šå™¨ã€‚åœ¨è¿è¡Œæ—¶è¿˜èƒ½è¿›è¡Œå³æ—¶ç¼–è¯‘ä¼˜åŒ–ï¼Œè·å¾—æ¯”åŸç”Ÿç¼–è¯‘å™¨æ›´ä¼˜ç§€çš„æ‰§è¡Œæ•ˆç‡ã€‚
å¦‚æœè¯´HotSpotæœ‰ä¸€å¤©çœŸçš„è¢«å–ä»£ï¼ŒGraalvmå¸Œæœ›æœ€å¤§ã€‚ä½†æ˜¯Javaçš„è½¯ä»¶ç”Ÿæ€æ²¡æœ‰ä¸æ¯«å˜åŒ–ã€‚



6. æ€»ç»“
å…·ä½“JVMçš„å†…å­˜ç»“æ„ï¼Œå…¶å®å–å†³äºå…¶å®ç°ï¼Œä¸åŒå‚å•†çš„JVMï¼Œæˆ–è€…åŒä¸€å‚å•†å‘å¸ƒçš„ä¸åŒç‰ˆæœ¬ï¼Œéƒ½æœ‰å¯èƒ½å­˜åœ¨ä¸€å®šå·®å¼‚ã€‚ä¸»è¦ä»¥Oracle HotSpot VMä¸ºé»˜è®¤è™šæ‹Ÿæœºã€‚

]]></content>
      <categories>
        <category>JVMè™šæ‹Ÿæœºè¯¦è§£</category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>JVMè™šæ‹Ÿæœºè¯¦è§£</tag>
      </tags>
  </entry>
  <entry>
    <title>JVMè™šæ‹Ÿæœºè¯¦è§£(ä¸‰)**ç±»åŠ è½½å™¨çš„åˆ†ç±»</title>
    <url>/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3(%E4%B8%89)%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E7%9A%84%E5%88%86%E7%B1%BB/</url>
    <content><![CDATA[JVMè™šæ‹Ÿæœºè¯¦è§£(ä¸‰)ç±»åŠ è½½å™¨çš„åˆ†ç±»1. ç±»åŠ è½½å™¨æ¦‚è¿°
JVMä¸¥æ ¼æ¥è®²æ”¯æŒä¸¤ç§ç±»å‹çš„ç±»åŠ è½½å™¨ ã€‚åˆ†åˆ«ä¸ºå¼•å¯¼ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰å’Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼ˆUser-Defined ClassLoaderï¼‰
ä»æ¦‚å¿µä¸Šæ¥è®²ï¼Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸€èˆ¬æŒ‡çš„æ˜¯ç¨‹åºä¸­ç”±å¼€å‘äººå‘˜è‡ªå®šä¹‰çš„ä¸€ç±»ç±»åŠ è½½å™¨ï¼Œä½†æ˜¯Javaè™šæ‹Ÿæœºè§„èŒƒå´æ²¡æœ‰è¿™ä¹ˆå®šä¹‰ï¼Œè€Œæ˜¯å°†æ‰€æœ‰æ´¾ç”ŸäºæŠ½è±¡ç±»ClassLoaderçš„ç±»åŠ è½½å™¨éƒ½åˆ’åˆ†ä¸ºè‡ªå®šä¹‰ç±»åŠ è½½å™¨
æ— è®ºç±»åŠ è½½å™¨çš„ç±»å‹å¦‚ä½•åˆ’åˆ†ï¼Œåœ¨ç¨‹åºä¸­æˆ‘ä»¬æœ€å¸¸è§çš„ç±»åŠ è½½å™¨å§‹ç»ˆåªæœ‰3ä¸ªï¼Œå¦‚ä¸‹æ‰€ç¤º


è¿™é‡Œçš„å››è€…ä¹‹é—´æ˜¯åŒ…å«å…³ç³»ï¼Œä¸æ˜¯ä¸Šå±‚å’Œä¸‹å±‚ï¼Œä¹Ÿä¸æ˜¯å­ç³»ç»Ÿçš„ç»§æ‰¿å…³ç³»ã€‚


æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç±»ï¼Œè·å–å®ƒä¸åŒçš„åŠ è½½å™¨
  package com.peppa.classloader;/** * @author peppa * @create 2022-02-10 11:25:46 */public class ClassLoaderTest &#123;    public static void main(String[] args) &#123;        // è·å–ç³»ç»Ÿç±»åŠ è½½å™¨        ClassLoader systemClassLoader = ClassLoader.getSystemClassLoader();        System.out.println(systemClassLoader);        // è·å–å…¶ä¸Šå±‚çš„ï¼šæ‰©å±•ç±»åŠ è½½å™¨        ClassLoader extClassLoader = systemClassLoader.getParent();        System.out.println(extClassLoader);        // è¯•å›¾è·å– æ ¹åŠ è½½å™¨        ClassLoader bootstrapClassLoader = extClassLoader.getParent();        System.out.println(bootstrapClassLoader);        // è·å–è‡ªå®šä¹‰åŠ è½½å™¨        ClassLoader classLoader = ClassLoaderTest.class.getClassLoader();        System.out.println(classLoader);        // è·å–Stringç±»å‹çš„åŠ è½½å™¨        ClassLoader classLoader1 = String.class.getClassLoader();        System.out.println(classLoader1);    &#125;&#125;// æ‰§è¡Œç»“æœï¼šsun.misc.Launcher$AppClassLoader@18b4aac2sun.misc.Launcher$ExtClassLoader@1b6d3586nullsun.misc.Launcher$AppClassLoader@18b4aac2null
  å¾—åˆ°çš„ç»“æœï¼Œä»ç»“æœå¯ä»¥çœ‹å‡º æ ¹åŠ è½½å™¨æ— æ³•ç›´æ¥é€šè¿‡ä»£ç è·å–ï¼ŒåŒæ—¶ç›®å‰ç”¨æˆ·ä»£ç æ‰€ä½¿ç”¨çš„åŠ è½½å™¨ä¸ºç³»ç»Ÿç±»åŠ è½½å™¨ã€‚åŒæ—¶æˆ‘ä»¬é€šè¿‡è·å–Stringç±»å‹çš„åŠ è½½å™¨ï¼Œå‘ç°æ˜¯nullï¼Œé‚£ä¹ˆè¯´æ˜Stringç±»å‹æ˜¯é€šè¿‡æ ¹åŠ è½½å™¨è¿›è¡ŒåŠ è½½çš„ï¼Œä¹Ÿå°±æ˜¯è¯´Javaçš„æ ¸å¿ƒç±»åº“éƒ½æ˜¯ä½¿ç”¨æ ¹åŠ è½½å™¨è¿›è¡ŒåŠ è½½çš„ã€‚
  æˆ‘ä»¬å°è¯•è·å–å¼•å¯¼ç±»åŠ è½½å™¨ï¼Œè·å–åˆ°çš„å€¼ä¸º null ï¼Œè¿™å¹¶ä¸ä»£è¡¨å¼•å¯¼ç±»åŠ è½½å™¨ä¸å­˜åœ¨ï¼Œå› ä¸ºå¼•å¯¼ç±»åŠ è½½å™¨å³ C&#x2F;C++ è¯­è¨€ï¼Œæˆ‘ä»¬è·å–ä¸åˆ°
  ä¸¤æ¬¡è·å–ç³»ç»Ÿç±»åŠ è½½å™¨çš„å€¼éƒ½ç›¸åŒï¼šsun.misc.Launcher$AppClassLoader@18b4aac2 ï¼Œè¿™è¯´æ˜ç³»ç»Ÿç±»åŠ è½½å™¨æ˜¯å…¨å±€å”¯ä¸€çš„


2.è™šæ‹Ÿæœºè‡ªå¸¦çš„åŠ è½½å™¨
å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆå¼•å¯¼ç±»åŠ è½½å™¨ï¼ŒBootstrap ClassLoaderï¼‰

è¿™ä¸ªç±»åŠ è½½ä½¿ç”¨C&#x2F;C++è¯­è¨€å®ç°çš„ï¼ŒåµŒå¥—åœ¨JVMå†…éƒ¨ã€‚
å®ƒç”¨æ¥åŠ è½½Javaçš„æ ¸å¿ƒåº“ï¼ˆJAVAHOME&#x2F;jre&#x2F;1ib&#x2F;rt.jarã€resources.jaræˆ–sun.boot.class.pathè·¯å¾„ä¸‹çš„å†…å®¹ï¼‰ï¼Œç”¨äºæä¾›JVMè‡ªèº«éœ€è¦çš„ç±»
å¹¶ä¸ç»§æ‰¿è‡ªava.lang.ClassLoaderï¼Œæ²¡æœ‰çˆ¶åŠ è½½å™¨ã€‚
åŠ è½½æ‰©å±•ç±»å’Œåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼Œå¹¶æŒ‡å®šä¸ºä»–ä»¬çš„çˆ¶ç±»åŠ è½½å™¨ã€‚
å‡ºäºå®‰å…¨è€ƒè™‘ï¼ŒBootstrapå¯åŠ¨ç±»åŠ è½½å™¨åªåŠ è½½åŒ…åä¸ºjavaã€javaxã€sunç­‰å¼€å¤´çš„ç±»


æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰

Javaè¯­è¨€ç¼–å†™ï¼Œç”±sun.misc.Launcher$ExtClassLoaderå®ç°ã€‚
æ´¾ç”ŸäºClassLoaderç±»
çˆ¶ç±»åŠ è½½å™¨ä¸ºå¯åŠ¨ç±»åŠ è½½å™¨
ä»java.ext.dirsç³»ç»Ÿå±æ€§æ‰€æŒ‡å®šçš„ç›®å½•ä¸­åŠ è½½ç±»åº“ï¼Œæˆ–ä»JDKçš„å®‰è£…ç›®å½•çš„jre&#x2F;1ib&#x2F;extå­ç›®å½•ï¼ˆæ‰©å±•ç›®å½•ï¼‰ä¸‹åŠ è½½ç±»åº“ã€‚å¦‚æœç”¨æˆ·åˆ›å»ºçš„JARæ”¾åœ¨æ­¤ç›®å½•ä¸‹ï¼Œä¹Ÿä¼šè‡ªåŠ¨ç”±æ‰©å±•ç±»åŠ è½½å™¨åŠ è½½ã€‚


åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼ˆç³»ç»Ÿç±»åŠ è½½å™¨ï¼ŒAppClassLoaderï¼‰

javIè¯­è¨€ç¼–å†™ï¼Œç”±sun.misc.LaunchersAppClassLoaderå®ç°
æ´¾ç”ŸäºClassLoaderç±»
çˆ¶ç±»åŠ è½½å™¨ä¸ºæ‰©å±•ç±»åŠ è½½å™¨
å®ƒè´Ÿè´£åŠ è½½ç¯å¢ƒå˜é‡classpathæˆ–ç³»ç»Ÿå±æ€§java.class.pathæŒ‡å®šè·¯å¾„ä¸‹çš„ç±»åº“
è¯¥ç±»åŠ è½½æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æ¥è¯´ï¼ŒJavaåº”ç”¨çš„ç±»éƒ½æ˜¯ç”±å®ƒæ¥å®ŒæˆåŠ è½½
é€šè¿‡classLoader#getSystemclassLoaderï¼ˆï¼‰æ–¹æ³•å¯ä»¥è·å–åˆ°è¯¥ç±»åŠ è½½å™¨


ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨
  åœ¨Javaçš„æ—¥å¸¸åº”ç”¨ç¨‹åºå¼€å‘ä¸­ï¼Œç±»çš„åŠ è½½å‡ ä¹æ˜¯ç”±ä¸Šè¿°3ç§ç±»åŠ è½½å™¨ç›¸äº’é…åˆæ‰§è¡Œçš„ï¼Œåœ¨å¿…è¦æ—¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œæ¥å®šåˆ¶ç±»çš„åŠ è½½æ–¹å¼ã€‚ ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Ÿ

éš”ç¦»åŠ è½½ç±»
ä¿®æ”¹ç±»åŠ è½½çš„æ–¹å¼
æ‰©å±•åŠ è½½æº
é˜²æ­¢æºç æ³„æ¼

  ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨å®ç°æ­¥éª¤ï¼š

å¼€å‘äººå‘˜å¯ä»¥é€šè¿‡ç»§æ‰¿æŠ½è±¡ç±»ava.1ang.ClassLoaderç±»çš„æ–¹å¼ï¼Œå®ç°è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œä»¥æ»¡è¶³ä¸€äº›ç‰¹æ®Šçš„éœ€æ±‚
åœ¨JDK1.2ä¹‹å‰ï¼Œåœ¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œæ€»ä¼šå»ç»§æ‰¿ClassLoaderç±»å¹¶é‡å†™1oadClassï¼ˆï¼‰æ–¹æ³•ï¼Œä»è€Œå®ç°è‡ªå®šä¹‰çš„ç±»åŠ è½½ç±»ï¼Œä½†æ˜¯åœ¨JDK1.2ä¹‹åå·²ä¸å†å»ºè®®ç”¨æˆ·å»è¦†ç›–1oadclassï¼ˆï¼‰æ–¹æ³•ï¼Œè€Œæ˜¯å»ºè®®æŠŠè‡ªå®šä¹‰çš„ç±»åŠ è½½é€»è¾‘å†™åœ¨findclassï¼ˆï¼‰æ–¹æ³•ä¸­
åœ¨ç¼–å†™è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œå¦‚æœæ²¡æœ‰å¤ªè¿‡äºå¤æ‚çš„éœ€æ±‚ï¼Œå¯ä»¥ç›´æ¥ç»§æ‰¿URIClassLoaderç±»ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…è‡ªå·±å»ç¼–å†™findclassï¼ˆï¼‰æ–¹æ³•åŠå…¶è·å–å­—èŠ‚ç æµçš„æ–¹å¼ï¼Œä½¿è‡ªå®šä¹‰ç±»åŠ è½½å™¨ç¼–å†™æ›´åŠ ç®€æ´ã€‚



3.æŸ¥çœ‹æ ¹åŠ è½½å™¨æ‰€èƒ½åŠ è½½çš„ç›®å½•åˆšåˆšæˆ‘ä»¬é€šè¿‡æ¦‚å¿µäº†è§£åˆ°äº†ï¼Œæ ¹åŠ è½½å™¨åªèƒ½å¤ŸåŠ è½½ java &#x2F;libç›®å½•ä¸‹çš„classï¼Œæˆ‘ä»¬é€šè¿‡ä¸‹é¢ä»£ç éªŒè¯ä¸€ä¸‹
package com.peppa.classloader;import java.net.URL;import java.security.Provider;/** * @author peppa * @create 2022-02-10 11:42:4 */public class ClassLoaderPathTest &#123;    public static void main(String[] args) &#123;        System.out.println(&quot;*********å¯åŠ¨ç±»åŠ è½½å™¨************&quot;);        // è·å–BootstrapClassLoader èƒ½å¤ŸåŠ è½½çš„APIçš„è·¯å¾„        URL[] urls = sun.misc.Launcher.getBootstrapClassPath().getURLs();        for (URL url : urls) &#123;            System.out.println(url.toExternalForm());        &#125;        // ä»ä¸Šé¢è·¯å¾„ä¸­ï¼Œéšæ„é€‰æ‹©ä¸€ä¸ªç±»ï¼Œæ¥çœ‹çœ‹ä»–çš„ç±»åŠ è½½å™¨æ˜¯ä»€ä¹ˆï¼šå¾—åˆ°çš„æ˜¯nullï¼Œè¯´æ˜æ˜¯  æ ¹åŠ è½½å™¨        ClassLoader classLoader = Provider.class.getClassLoader();        System.out.println(&quot;classLoader ==&gt;&quot;+classLoader);    &#125;&#125;// å¾—åˆ°çš„ç»“æœ*********å¯åŠ¨ç±»åŠ è½½å™¨************file:/D:/software/Java/jdk1.8/jdk1.8.0_241/jre/lib/resources.jarfile:/D:/software/Java/jdk1.8/jdk1.8.0_241/jre/lib/rt.jarfile:/D:/software/Java/jdk1.8/jdk1.8.0_241/jre/lib/sunrsasign.jarfile:/D:/software/Java/jdk1.8/jdk1.8.0_241/jre/lib/jsse.jarfile:/D:/software/Java/jdk1.8/jdk1.8.0_241/jre/lib/jce.jarfile:/D:/software/Java/jdk1.8/jdk1.8.0_241/jre/lib/charsets.jarfile:/D:/software/Java/jdk1.8/jdk1.8.0_241/jre/lib/jfr.jarfile:/D:/software/Java/jdk1.8/jdk1.8.0_241/jre/classesclassLoader ==&gt;null

4. å…³äºClassLoader
ClassLoader ç±»ä»‹ç»
  ClassLoaderç±»ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…¶åæ‰€æœ‰çš„ç±»åŠ è½½å™¨éƒ½ç»§æ‰¿è‡ªClassLoaderï¼ˆä¸åŒ…æ‹¬å¯åŠ¨ç±»åŠ è½½å™¨ï¼‰
  

sun.misc.Launcher å®ƒæ˜¯ä¸€ä¸ªjavaè™šæ‹Ÿæœºçš„å…¥å£åº”ç”¨




è·å–ClassLoaderçš„é€”å¾„
è·å–å½“å‰ClassLoaderï¼šclazz.getClassLoader()
è·å–å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡çš„ClassLoaderï¼šThread.currentThread().getContextClassLoader()
è·å–ç³»ç»Ÿçš„ClassLoaderï¼šClassLoader.getSystemClassLoader()
è·å–è°ƒç”¨è€…çš„ClassLoaderï¼šDriverManager.getCallerClassLoader()



5.åŒäº²å§”æ´¾æœºåˆ¶Javaè™šæ‹Ÿæœºå¯¹classæ–‡ä»¶é‡‡ç”¨çš„æ˜¯æŒ‰éœ€åŠ è½½çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´å½“éœ€è¦ä½¿ç”¨è¯¥ç±»æ—¶æ‰ä¼šå°†å®ƒçš„classæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ç”Ÿæˆclasså¯¹è±¡ã€‚è€Œä¸”åŠ è½½æŸä¸ªç±»çš„classæ–‡ä»¶æ—¶ï¼ŒJavaè™šæ‹Ÿæœºé‡‡ç”¨çš„æ˜¯åŒäº²å§”æ´¾æ¨¡å¼ï¼Œå³æŠŠè¯·æ±‚äº¤ç”±çˆ¶ç±»å¤„ç†ï¼Œå®ƒæ˜¯ä¸€ç§ä»»åŠ¡å§”æ´¾æ¨¡å¼ã€‚

å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½è¯·æ±‚ï¼Œå®ƒå¹¶ä¸ä¼šè‡ªå·±å…ˆå»åŠ è½½ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ‰˜ç»™çˆ¶ç±»çš„åŠ è½½å™¨å»æ‰§è¡Œï¼›
å¦‚æœçˆ¶ç±»åŠ è½½å™¨è¿˜å­˜åœ¨å…¶çˆ¶ç±»åŠ è½½å™¨ï¼Œåˆ™è¿›ä¸€æ­¥å‘ä¸Šå§”æ‰˜ï¼Œä¾æ¬¡é€’å½’ï¼Œè¯·æ±‚æœ€ç»ˆå°†åˆ°è¾¾é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ï¼›
å¦‚æœçˆ¶ç±»åŠ è½½å™¨å¯ä»¥å®Œæˆç±»åŠ è½½ä»»åŠ¡ï¼Œå°±æˆåŠŸè¿”å›ï¼Œå€˜è‹¥çˆ¶ç±»åŠ è½½å™¨æ— æ³•å®Œæˆæ­¤åŠ è½½ä»»åŠ¡ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ï¼Œè¿™å°±æ˜¯åŒäº²å§”æ´¾æ¨¡å¼ã€‚
çˆ¶ç±»åŠ è½½å™¨ä¸€å±‚ä¸€å±‚å¾€ä¸‹åˆ†é…ä»»åŠ¡ï¼Œå¦‚æœå­ç±»åŠ è½½å™¨èƒ½åŠ è½½ï¼Œåˆ™åŠ è½½æ­¤ç±»ï¼Œå¦‚æœå°†åŠ è½½ä»»åŠ¡åˆ†é…è‡³ç³»ç»Ÿç±»åŠ è½½å™¨ä¹Ÿæ— æ³•åŠ è½½æ­¤ç±»ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸



åŒäº²å§”æ´¾æœºåˆ¶ä¸¾ä¾‹
  å½“æˆ‘ä»¬åŠ è½½jdbc.jar ç”¨äºå®ç°æ•°æ®åº“è¿æ¥çš„æ—¶å€™ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯ jdbc.jaræ˜¯åŸºäºSPIæ¥å£è¿›è¡Œå®ç°çš„ï¼Œæ‰€ä»¥åœ¨åŠ è½½çš„æ—¶å€™ï¼Œä¼šè¿›è¡ŒåŒäº²å§”æ´¾ï¼Œæœ€ç»ˆä»æ ¹åŠ è½½å™¨ä¸­åŠ è½½ SPIæ ¸å¿ƒç±»ï¼Œç„¶ååœ¨åŠ è½½SPIæ¥å£ç±»ï¼Œæ¥ç€åœ¨è¿›è¡Œåå‘å§”æ´¾ï¼Œé€šè¿‡çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨è¿›è¡Œå®ç°ç±» jdbc.jarçš„åŠ è½½ã€‚
  

æ²™ç®±å®‰å…¨æœºåˆ¶
  è‡ªå®šä¹‰stringç±»ï¼Œä½†æ˜¯åœ¨åŠ è½½è‡ªå®šä¹‰Stringç±»çš„æ—¶å€™ä¼šç‡å…ˆä½¿ç”¨å¼•å¯¼ç±»åŠ è½½å™¨åŠ è½½ï¼Œè€Œå¼•å¯¼ç±»åŠ è½½å™¨åœ¨åŠ è½½çš„è¿‡ç¨‹ä¸­ä¼šå…ˆåŠ è½½jdkè‡ªå¸¦çš„æ–‡ä»¶ï¼ˆrt.jaråŒ…ä¸­java\lang\String.classï¼‰ï¼ŒæŠ¥é”™ä¿¡æ¯è¯´æ²¡æœ‰mainæ–¹æ³•ï¼Œå°±æ˜¯å› ä¸ºåŠ è½½çš„æ˜¯rt.jaråŒ…ä¸­çš„stringç±»ã€‚è¿™æ ·å¯ä»¥ä¿è¯å¯¹javaæ ¸å¿ƒæºä»£ç çš„ä¿æŠ¤ï¼Œè¿™å°±æ˜¯æ²™ç®±å®‰å…¨æœºåˆ¶ã€‚

åŒäº²å§”æ´¾æœºåˆ¶çš„ä¼˜åŠ¿
  é€šè¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒåŒäº²æœºåˆ¶å¯ä»¥

é¿å…ç±»çš„é‡å¤åŠ è½½
ä¿æŠ¤ç¨‹åºå®‰å…¨ï¼Œé˜²æ­¢æ ¸å¿ƒAPIè¢«éšæ„ç¯¡æ”¹
è‡ªå®šä¹‰ç±»ï¼šjava.lang.String
è‡ªå®šä¹‰ç±»ï¼šjava.lang.ShkStartï¼ˆæŠ¥é”™ï¼šé˜»æ­¢åˆ›å»º java.langå¼€å¤´çš„ç±»ï¼‰




å…¶ä»–

å¦‚ä½•åˆ¤æ–­ä¸¤ä¸ªclasså¯¹è±¡æ˜¯å¦ç›¸åŒï¼Ÿ
  åœ¨JVMä¸­è¡¨ç¤ºä¸¤ä¸ªclasså¯¹è±¡æ˜¯å¦ä¸ºåŒä¸€ä¸ªç±»å­˜åœ¨ä¸¤ä¸ªå¿…è¦æ¡ä»¶ï¼š

ç±»çš„å®Œæ•´ç±»åå¿…é¡»ä¸€è‡´ï¼ŒåŒ…æ‹¬åŒ…å
åŠ è½½è¿™ä¸ªç±»çš„ClassLoaderï¼ˆæŒ‡ClassLoaderå®ä¾‹å¯¹è±¡ï¼‰å¿…é¡»ç›¸åŒ
æ¢å¥è¯è¯´ï¼Œåœ¨JVMä¸­ï¼Œå³ä½¿è¿™ä¸¤ä¸ªç±»å¯¹è±¡ï¼ˆclasså¯¹è±¡ï¼‰æ¥æºåŒä¸€ä¸ªClassæ–‡ä»¶ï¼Œè¢«åŒä¸€ä¸ªè™šæ‹Ÿæœºæ‰€åŠ è½½ï¼Œä½†åªè¦åŠ è½½å®ƒä»¬çš„ClassLoaderå®ä¾‹å¯¹è±¡ä¸åŒï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªç±»å¯¹è±¡ä¹Ÿæ˜¯ä¸ç›¸ç­‰çš„


å¯¹ç±»åŠ è½½å™¨çš„å¼•ç”¨

JVMå¿…é¡»çŸ¥é“ä¸€ä¸ªç±»å‹æ˜¯ç”±å¯åŠ¨åŠ è½½å™¨åŠ è½½çš„è¿˜æ˜¯ç”±ç”¨æˆ·ç±»åŠ è½½å™¨åŠ è½½çš„
å¦‚æœä¸€ä¸ªç±»å‹æ˜¯ç”±ç”¨æˆ·ç±»åŠ è½½å™¨åŠ è½½çš„ï¼Œé‚£ä¹ˆJVMä¼šå°†è¿™ä¸ªç±»åŠ è½½å™¨çš„ä¸€ä¸ªå¼•ç”¨ä½œä¸ºç±»å‹ä¿¡æ¯çš„ä¸€éƒ¨åˆ†ä¿å­˜åœ¨æ–¹æ³•åŒºä¸­





]]></content>
      <categories>
        <category>JVMè™šæ‹Ÿæœºè¯¦è§£</category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>JVMè™šæ‹Ÿæœºè¯¦è§£</tag>
      </tags>
  </entry>
  <entry>
    <title>JVMè™šæ‹Ÿæœºè¯¦è§£(ä¹)æ–¹æ³•åŒº**Method Area</title>
    <url>/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3(%E4%B9%9D)%E6%96%B9%E6%B3%95%E5%8C%BAMethod%20Area/</url>
    <content><![CDATA[JVMè™šæ‹Ÿæœºè¯¦è§£(ä¹)æ–¹æ³•åŒºMethod Area1. æ ˆã€å †ã€æ–¹æ³•åŒºçš„äº¤äº’å…³ç³»
ä»çº¿ç¨‹å…±äº«ä¸å¦çš„è§’åº¦æ¥çœ‹

ThreadLocalï¼šå¦‚ä½•ä¿è¯å¤šä¸ªçº¿ç¨‹åœ¨å¹¶å‘ç¯å¢ƒä¸‹çš„å®‰å…¨æ€§ï¼Ÿå…¸å‹åœºæ™¯å°±æ˜¯æ•°æ®åº“è¿æ¥ç®¡ç†ï¼Œä»¥åŠä¼šè¯ç®¡ç†ã€‚

  

ä»çº¿ç¨‹å…±äº«ä¸å¦çš„è§’åº¦æ¥çœ‹
  ThreadLocalï¼šå¦‚ä½•ä¿è¯å¤šä¸ªçº¿ç¨‹åœ¨å¹¶å‘ç¯å¢ƒä¸‹çš„å®‰å…¨æ€§ï¼Ÿå…¸å‹åº”ç”¨å°±æ˜¯æ•°æ®åº“è¿æ¥ç®¡ç†ï¼Œä»¥åŠä¼šè¯ç®¡ç†


  
  

æ ˆã€å †ã€æ–¹æ³•åŒºçš„äº¤äº’å…³ç³»

ä¸‹é¢å°±æ¶‰åŠäº†å¯¹è±¡çš„è®¿é—®å®šä½

  

Personï¼šå­˜æ”¾åœ¨å…ƒç©ºé—´ï¼Œä¹Ÿå¯ä»¥è¯´æ–¹æ³•åŒº
personï¼šå­˜æ”¾åœ¨Javaæ ˆçš„å±€éƒ¨å˜é‡è¡¨ä¸­
new Person()ï¼šå­˜æ”¾åœ¨Javaå †ä¸­


æ–¹æ³•åŒºçš„ç†è§£

ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­æ˜ç¡®è¯´æ˜ï¼šâ€œå°½ç®¡æ‰€æœ‰çš„æ–¹æ³•åŒºåœ¨é€»è¾‘ä¸Šæ˜¯å±äºå †çš„ä¸€éƒ¨åˆ†ï¼Œä½†ä¸€äº›ç®€å•çš„å®ç°å¯èƒ½ä¸ä¼šé€‰æ‹©å»è¿›è¡Œåƒåœ¾æ”¶é›†æˆ–è€…è¿›è¡Œå‹ç¼©ã€‚â€ä½†å¯¹äºHotSpotJVMè€Œè¨€ï¼Œæ–¹æ³•åŒºè¿˜æœ‰ä¸€ä¸ªåˆ«åå«åšNon-Heapï¼ˆéå †ï¼‰ï¼Œç›®çš„å°±æ˜¯è¦å’Œå †åˆ†å¼€ã€‚æ‰€ä»¥ï¼Œæ–¹æ³•åŒºçœ‹ä½œæ˜¯ä¸€å—ç‹¬ç«‹äºJavaå †çš„å†…å­˜ç©ºé—´ã€‚

  
  æ–¹æ³•åŒºä¸»è¦å­˜æ”¾çš„æ˜¯ Classï¼Œè€Œå †ä¸­ä¸»è¦å­˜æ”¾çš„æ˜¯ å®ä¾‹åŒ–çš„å¯¹è±¡

æ–¹æ³•åŒºï¼ˆMethod Areaï¼‰ä¸Javaå †ä¸€æ ·ï¼Œæ˜¯å„ä¸ªçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸã€‚
æ–¹æ³•åŒºåœ¨JVMå¯åŠ¨çš„æ—¶å€™è¢«åˆ›å»ºï¼Œå¹¶ä¸”å®ƒçš„å®é™…çš„ç‰©ç†å†…å­˜ç©ºé—´ä¸­å’ŒJavaå †åŒºä¸€æ ·éƒ½å¯ä»¥æ˜¯ä¸è¿ç»­çš„ã€‚
æ–¹æ³•åŒºçš„å¤§å°ï¼Œè·Ÿå †ç©ºé—´ä¸€æ ·ï¼Œå¯ä»¥é€‰æ‹©å›ºå®šå¤§å°æˆ–è€…å¯æ‰©å±•ã€‚
æ–¹æ³•åŒºçš„å¤§å°å†³å®šäº†ç³»ç»Ÿå¯ä»¥ä¿å­˜å¤šå°‘ä¸ªç±»ï¼Œå¦‚æœç³»ç»Ÿå®šä¹‰äº†å¤ªå¤šçš„ç±»ï¼Œå¯¼è‡´æ–¹æ³•åŒºæº¢å‡ºï¼Œè™šæ‹ŸæœºåŒæ ·ä¼šæŠ›å‡ºå†…å­˜æº¢å‡ºé”™è¯¯ï¼šava.lang.OutofMemoryErrorï¼šPermGen space æˆ–è€…java.lang.OutOfMemoryError:Metaspace
åŠ è½½å¤§é‡çš„ç¬¬ä¸‰æ–¹çš„jaråŒ…
Tomcatéƒ¨ç½²çš„å·¥ç¨‹è¿‡å¤šï¼ˆ30~50ä¸ªï¼‰
å¤§é‡åŠ¨æ€çš„ç”Ÿæˆåå°„ç±»


å…³é—­JVMå°±ä¼šé‡Šæ”¾è¿™ä¸ªåŒºåŸŸçš„å†…å­˜ã€‚


HotSpotä¸­æ–¹æ³•åŒºçš„æ¼”è¿›
  åœ¨jdk7åŠä»¥å‰ï¼Œä¹ æƒ¯ä¸ŠæŠŠæ–¹æ³•åŒºï¼Œç§°ä¸ºæ°¸ä¹…ä»£ã€‚jdk8å¼€å§‹ï¼Œä½¿ç”¨å…ƒç©ºé—´å–ä»£äº†æ°¸ä¹…ä»£ã€‚

JDK 1.8åï¼Œå…ƒç©ºé—´å­˜æ”¾åœ¨å †å¤–å†…å­˜ä¸­

  æœ¬è´¨ä¸Šï¼Œæ–¹æ³•åŒºå’Œæ°¸ä¹…ä»£å¹¶ä¸ç­‰ä»·ã€‚ä»…æ˜¯å¯¹hotspotè€Œè¨€çš„ã€‚ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹å¯¹å¦‚ä½•å®ç°æ–¹æ³•åŒºï¼Œä¸åšç»Ÿä¸€è¦æ±‚ã€‚ä¾‹å¦‚ï¼šBEAJRockit &#x2F; IBM J9 ä¸­ä¸å­˜åœ¨æ°¸ä¹…ä»£çš„æ¦‚å¿µã€‚
  ç°åœ¨æ¥çœ‹ï¼Œå½“å¹´ä½¿ç”¨æ°¸ä¹…ä»£ï¼Œä¸æ˜¯å¥½çš„ideaã€‚å¯¼è‡´Javaç¨‹åºæ›´å®¹æ˜“oomï¼ˆè¶…è¿‡-XX:MaxPermsizeä¸Šé™ï¼‰
  
  è€Œåˆ°äº†JDK8ï¼Œç»ˆäºå®Œå…¨åºŸå¼ƒäº†æ°¸ä¹…ä»£çš„æ¦‚å¿µï¼Œæ”¹ç”¨ä¸JRockitã€J9ä¸€æ ·åœ¨æœ¬åœ°å†…å­˜ä¸­å®ç°çš„å…ƒç©ºé—´ï¼ˆMetaspaceï¼‰æ¥ä»£æ›¿
  
  å…ƒç©ºé—´çš„æœ¬è´¨å’Œæ°¸ä¹…ä»£ç±»ä¼¼ï¼Œéƒ½æ˜¯å¯¹JVMè§„èŒƒä¸­æ–¹æ³•åŒºçš„å®ç°ã€‚ä¸è¿‡å…ƒç©ºé—´ä¸æ°¸ä¹…ä»£æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå…ƒç©ºé—´ä¸åœ¨è™šæ‹Ÿæœºè®¾ç½®çš„å†…å­˜ä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜
  æ°¸ä¹…ä»£ã€å…ƒç©ºé—´äºŒè€…å¹¶ä¸åªæ˜¯åå­—å˜äº†ï¼Œå†…éƒ¨ç»“æ„ä¹Ÿè°ƒæ•´äº†
  æ ¹æ®ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹çš„è§„å®šï¼Œå¦‚æœæ–¹æ³•åŒºæ— æ³•æ»¡è¶³æ–°çš„å†…å­˜åˆ†é…éœ€æ±‚æ—¶ï¼Œå°†æŠ›å‡ºOOMå¼‚å¸¸
  

è®¾ç½®æ–¹æ³•åŒºå¤§å°ä¸OOM

æ–¹æ³•åŒºçš„å¤§å°ä¸å¿…æ˜¯å›ºå®šçš„ï¼ŒJVMå¯ä»¥æ ¹æ®åº”ç”¨çš„éœ€è¦åŠ¨æ€è°ƒæ•´ã€‚


jdk7åŠä»¥å‰

é€šè¿‡-xx:Permsizeæ¥è®¾ç½®æ°¸ä¹…ä»£åˆå§‹åˆ†é…ç©ºé—´ã€‚é»˜è®¤å€¼æ˜¯20.75M

XX:MaxPermsizeæ¥è®¾å®šæ°¸ä¹…ä»£æœ€å¤§å¯åˆ†é…ç©ºé—´ã€‚32ä½æœºå™¨é»˜è®¤æ˜¯64Mï¼Œ64ä½æœºå™¨æ¨¡å¼æ˜¯82M

å½“JVMåŠ è½½çš„ç±»ä¿¡æ¯å®¹é‡è¶…è¿‡äº†è¿™ä¸ªå€¼ï¼Œä¼šæŠ¥å¼‚å¸¸OutofMemoryError:PermGen spaceã€‚
  

JDK8ä»¥å
  å…ƒæ•°æ®åŒºå¤§å°å¯ä»¥ä½¿ç”¨å‚æ•° -XX:MetaspaceSize å’Œ -XX:MaxMetaspaceSizeæŒ‡å®š
  é»˜è®¤å€¼ä¾èµ–äºå¹³å°ã€‚windowsä¸‹ï¼Œ-XX:MetaspaceSizeæ˜¯21Mï¼Œ-XX:MaxMetaspaceSizeçš„å€¼æ˜¯-1ï¼Œå³æ²¡æœ‰é™åˆ¶ã€‚
  ä¸æ°¸ä¹…ä»£ä¸åŒï¼Œå¦‚æœä¸æŒ‡å®šå¤§å°ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè™šæ‹Ÿæœºä¼šè€—å°½æ‰€æœ‰çš„å¯ç”¨ç³»ç»Ÿå†…å­˜ã€‚å¦‚æœå…ƒæ•°æ®åŒºå‘ç”Ÿæº¢å‡ºï¼Œè™šæ‹Ÿæœºä¸€æ ·ä¼šæŠ›å‡ºå¼‚å¸¸OutOfMemoryError:Metaspace

XX:MetaspaceSizeï¼šè®¾ç½®åˆå§‹çš„å…ƒç©ºé—´å¤§å°ã€‚å¯¹äºä¸€ä¸ª64ä½çš„æœåŠ¡å™¨ç«¯JVMæ¥è¯´ï¼Œå…¶é»˜è®¤çš„-xx:MetaspaceSizeå€¼ä¸º21MBã€‚è¿™å°±æ˜¯åˆå§‹çš„é«˜æ°´ä½çº¿ï¼Œä¸€æ—¦è§¦åŠè¿™ä¸ªæ°´ä½çº¿ï¼ŒFul1GCå°†ä¼šè¢«è§¦å‘å¹¶å¸è½½æ²¡ç”¨çš„ç±»ï¼ˆå³è¿™äº›ç±»å¯¹åº”çš„ç±»åŠ è½½å™¨ä¸å†å­˜æ´»ï¼‰ç„¶åè¿™ä¸ªé«˜æ°´ä½çº¿å°†ä¼šé‡ç½®ã€‚æ–°çš„é«˜æ°´ä½çº¿çš„å€¼å–å†³äºGCåé‡Šæ”¾äº†å¤šå°‘å…ƒç©ºé—´ã€‚å¦‚æœé‡Šæ”¾çš„ç©ºé—´ä¸è¶³ï¼Œé‚£ä¹ˆåœ¨ä¸è¶…è¿‡MaxMetaspaceSizeæ—¶ï¼Œé€‚å½“æé«˜è¯¥å€¼ã€‚å¦‚æœé‡Šæ”¾ç©ºé—´è¿‡å¤šï¼Œåˆ™é€‚å½“é™ä½è¯¥å€¼ã€‚

  å¦‚æœåˆå§‹åŒ–çš„é«˜æ°´ä½çº¿è®¾ç½®è¿‡ä½ï¼Œä¸Šè¿°é«˜æ°´ä½çº¿è°ƒæ•´æƒ…å†µä¼šå‘ç”Ÿå¾ˆå¤šæ¬¡ã€‚é€šè¿‡åƒåœ¾å›æ”¶å™¨çš„æ—¥å¿—å¯ä»¥è§‚å¯Ÿåˆ°Ful1GCå¤šæ¬¡è°ƒç”¨ã€‚ä¸ºäº†é¿å…é¢‘ç¹åœ°GCï¼Œå»ºè®®å°†-XX:MetaspaceSizeè®¾ç½®ä¸ºä¸€ä¸ªç›¸å¯¹è¾ƒé«˜çš„å€¼ã€‚



å¦‚ä½•è§£å†³è¿™äº›OOM

è¦è§£å†³ooMå¼‚å¸¸æˆ–heap spaceçš„å¼‚å¸¸ï¼Œä¸€èˆ¬çš„æ‰‹æ®µæ˜¯é¦–å…ˆé€šè¿‡å†…å­˜æ˜ åƒåˆ†æå·¥å…·ï¼ˆå¦‚Ec1ipse Memory Analyzerï¼‰å¯¹dumpå‡ºæ¥çš„å †è½¬å‚¨å¿«ç…§è¿›è¡Œåˆ†æï¼Œé‡ç‚¹æ˜¯ç¡®è®¤å†…å­˜ä¸­çš„å¯¹è±¡æ˜¯å¦æ˜¯å¿…è¦çš„ï¼Œä¹Ÿå°±æ˜¯è¦å…ˆåˆ†æ¸…æ¥šåˆ°åº•æ˜¯å‡ºç°äº†å†…å­˜æ³„æ¼ï¼ˆMemory Leakï¼‰è¿˜æ˜¯å†…å­˜æº¢å‡ºï¼ˆMemory Overflowï¼‰
å†…å­˜æ³„æ¼å°±æ˜¯ æœ‰å¤§é‡çš„å¼•ç”¨æŒ‡å‘æŸäº›å¯¹è±¡ï¼Œä½†æ˜¯è¿™äº›å¯¹è±¡ä»¥åä¸ä¼šä½¿ç”¨äº†ï¼Œä½†æ˜¯å› ä¸ºå®ƒä»¬è¿˜å’ŒGC ROOTæœ‰å…³è”ï¼Œæ‰€ä»¥å¯¼è‡´ä»¥åè¿™äº›å¯¹è±¡ä¹Ÿä¸ä¼šè¢«å›æ”¶ï¼Œè¿™å°±æ˜¯å†…å­˜æ³„æ¼çš„é—®é¢˜


å¦‚æœæ˜¯å†…å­˜æ³„æ¼ï¼Œå¯è¿›ä¸€æ­¥é€šè¿‡å·¥å…·æŸ¥çœ‹æ³„æ¼å¯¹è±¡åˆ°GC Rootsçš„å¼•ç”¨é“¾ã€‚äºæ˜¯å°±èƒ½æ‰¾åˆ°æ³„æ¼å¯¹è±¡æ˜¯é€šè¿‡æ€æ ·çš„è·¯å¾„ä¸GCRootsç›¸å…³è”å¹¶å¯¼è‡´åƒåœ¾æ”¶é›†å™¨æ— æ³•è‡ªåŠ¨å›æ”¶å®ƒä»¬çš„ã€‚æŒæ¡äº†æ³„æ¼å¯¹è±¡çš„ç±»å‹ä¿¡æ¯ï¼Œä»¥åŠGCRootså¼•ç”¨é“¾çš„ä¿¡æ¯ï¼Œå°±å¯ä»¥æ¯”è¾ƒå‡†ç¡®åœ°å®šä½å‡ºæ³„æ¼ä»£ç çš„ä½ç½®ã€‚
å¦‚æœä¸å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œæ¢å¥è¯è¯´å°±æ˜¯å†…å­˜ä¸­çš„å¯¹è±¡ç¡®å®éƒ½è¿˜å¿…é¡»å­˜æ´»ç€ï¼Œé‚£å°±åº”å½“æ£€æŸ¥è™šæ‹Ÿæœºçš„å †å‚æ•°ï¼ˆ-Xmxä¸-Xmsï¼‰ï¼Œä¸æœºå™¨ç‰©ç†å†…å­˜å¯¹æ¯”çœ‹æ˜¯å¦è¿˜å¯ä»¥è°ƒå¤§ï¼Œä»ä»£ç ä¸Šæ£€æŸ¥æ˜¯å¦å­˜åœ¨æŸäº›å¯¹è±¡ç”Ÿå‘½å‘¨æœŸè¿‡é•¿ã€æŒæœ‰çŠ¶æ€æ—¶é—´è¿‡é•¿çš„æƒ…å†µï¼Œå°è¯•å‡å°‘ç¨‹åºè¿è¡ŒæœŸçš„å†…å­˜æ¶ˆè€—ã€‚



2.æ–¹æ³•åŒºçš„å†…éƒ¨ç»“æ„
å…³ç³»å›¾
  ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ä¹¦ä¸­å¯¹æ–¹æ³•åŒºï¼ˆMethod Areaï¼‰å­˜å‚¨å†…å®¹æè¿°å¦‚ä¸‹ï¼šå®ƒç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»å‹ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç¼“å­˜ç­‰ã€‚





ç±»å‹ä¿¡æ¯
  å¯¹æ¯ä¸ªåŠ è½½çš„ç±»å‹ï¼ˆç±»classã€æ¥å£interfaceã€æšä¸¾enumã€æ³¨è§£annotationï¼‰ï¼ŒJVmå¿…é¡»åœ¨æ–¹æ³•åŒºä¸­å­˜å‚¨ä»¥ä¸‹ç±»å‹ä¿¡æ¯ï¼š

è¿™ä¸ªç±»å‹çš„å®Œæ•´æœ‰æ•ˆåç§°ï¼ˆå…¨å&#x3D;åŒ…å.ç±»åï¼‰
è¿™ä¸ªç±»å‹ç›´æ¥çˆ¶ç±»çš„å®Œæ•´æœ‰æ•ˆåï¼ˆå¯¹äºinterfaceæˆ–æ˜¯java.lang.objectï¼Œéƒ½æ²¡æœ‰çˆ¶ç±»ï¼‰
è¿™ä¸ªç±»å‹çš„ä¿®é¥°ç¬¦ï¼ˆpublicï¼Œabstractï¼Œfinalçš„æŸä¸ªå­é›†ï¼‰
è¿™ä¸ªç±»å‹ç›´æ¥æ¥å£çš„ä¸€ä¸ªæœ‰åºåˆ—è¡¨


åŸŸä¿¡æ¯
  JVMå¿…é¡»åœ¨æ–¹æ³•åŒºä¸­ä¿å­˜ç±»å‹çš„æ‰€æœ‰åŸŸçš„ç›¸å…³ä¿¡æ¯ä»¥åŠåŸŸçš„å£°æ˜é¡ºåºã€‚
  åŸŸçš„ç›¸å…³ä¿¡æ¯åŒ…æ‹¬ï¼šåŸŸåç§°ã€åŸŸç±»å‹ã€åŸŸä¿®é¥°ç¬¦ï¼ˆpublicï¼Œprivateï¼Œprotectedï¼Œstaticï¼Œfinalï¼Œvolatileï¼Œtransientçš„æŸä¸ªå­é›†ï¼‰

æ–¹æ³•ï¼ˆMethodï¼‰ä¿¡æ¯
  JVMå¿…é¡»ä¿å­˜æ‰€æœ‰æ–¹æ³•çš„ä»¥ä¸‹ä¿¡æ¯ï¼ŒåŒåŸŸä¿¡æ¯ä¸€æ ·åŒ…æ‹¬å£°æ˜é¡ºåºï¼š

æ–¹æ³•åç§°
æ–¹æ³•çš„è¿”å›ç±»å‹ï¼ˆæˆ–voidï¼‰
æ–¹æ³•å‚æ•°çš„æ•°é‡å’Œç±»å‹ï¼ˆæŒ‰é¡ºåºï¼‰
æ–¹æ³•çš„ä¿®é¥°ç¬¦ï¼ˆpublicï¼Œprivateï¼Œprotectedï¼Œstaticï¼Œfinalï¼Œsynchronizedï¼Œnativeï¼Œabstractçš„ä¸€ä¸ªå­é›†ï¼‰
æ–¹æ³•çš„å­—èŠ‚ç ï¼ˆbytecodesï¼‰ã€æ“ä½œæ•°æ ˆã€å±€éƒ¨å˜é‡è¡¨åŠå¤§å°ï¼ˆabstractå’Œnativeæ–¹æ³•é™¤å¤–ï¼‰
å¼‚å¸¸è¡¨ï¼ˆabstractå’Œnativeæ–¹æ³•é™¤å¤–ï¼‰


æ¯ä¸ªå¼‚å¸¸å¤„ç†çš„å¼€å§‹ä½ç½®ã€ç»“æŸä½ç½®ã€ä»£ç å¤„ç†åœ¨ç¨‹åºè®¡æ•°å™¨ä¸­çš„åç§»åœ°å€ã€è¢«æ•è·çš„å¼‚å¸¸ç±»çš„å¸¸é‡æ± ç´¢å¼•


non-finalçš„ç±»å˜é‡
  é™æ€å˜é‡å’Œç±»å…³è”åœ¨ä¸€èµ·ï¼Œéšç€ç±»çš„åŠ è½½è€ŒåŠ è½½ï¼Œä»–ä»¬æˆä¸ºç±»æ•°æ®åœ¨é€»è¾‘ä¸Šçš„ä¸€éƒ¨åˆ†
  ç±»å˜é‡è¢«ç±»çš„æ‰€æœ‰å®ä¾‹å…±äº«ï¼Œå³ä½¿æ²¡æœ‰ç±»å®ä¾‹æ—¶ï¼Œä½ ä¹Ÿå¯ä»¥è®¿é—®å®ƒ
  package com.peppa.area;/** * non-finalçš„ç±»å˜é‡ * * @author: peppa * @create: 2022-02-12 18:42:45 */public class MethodAreaTest &#123;    public static void main(String[] args) &#123;        Order order = new Order();        order.hello();        System.out.println(order.count);    &#125;&#125;class Order &#123;    public static int count = 1;    public static final int number = 2;    public static void hello() &#123;        System.out.println(&quot;hello!&quot;);    &#125;&#125;// æ‰§è¡Œç»“æœï¼š// hello!// 1
  å¦‚ä¸Šä»£ç æ‰€ç¤ºï¼Œå³ä½¿æˆ‘ä»¬æŠŠorderè®¾ç½®ä¸ºnullï¼Œä¹Ÿä¸ä¼šå‡ºç°ç©ºæŒ‡é’ˆå¼‚å¸¸

å…¨å±€å¸¸é‡ï¼šstatic final

å…¨å±€å¸¸é‡å°±æ˜¯ä½¿ç”¨ static final è¿›è¡Œä¿®é¥°
è¢«å£°æ˜ä¸ºfinalçš„ç±»å˜é‡çš„å¤„ç†æ–¹æ³•åˆ™ä¸åŒï¼Œæ¯ä¸ªå…¨å±€å¸¸é‡åœ¨ç¼–è¯‘çš„æ—¶å€™å°±ä¼šè¢«åˆ†é…äº†ã€‚

  æŸ¥çœ‹ä¸Šé¢ä»£ç ï¼Œè¿™éƒ¨åˆ†çš„å­—èŠ‚ç æŒ‡ä»¤
  class Order &#123;    public static int count = 1;    public static final int number = 2;    ...&#125;
  public static int count;    descriptor: I    flags: ACC_PUBLIC, ACC_STATIC  public static final int number;    descriptor: I    flags: ACC_PUBLIC, ACC_STATIC, ACC_FINAL    ConstantValue: int 2
  å¯ä»¥å‘ç° staitcå’ŒfinalåŒæ—¶ä¿®é¥°çš„number çš„å€¼åœ¨ç¼–è¯‘ä¸Šçš„æ—¶å€™å·²ç»å†™æ­»åœ¨å­—èŠ‚ç æ–‡ä»¶ä¸­äº†ã€‚****


3.å¸¸é‡æ± 
å¸¸é‡æ± æ¦‚è¿°

å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html
  

æ–¹æ³•åŒºï¼Œå†…éƒ¨åŒ…å«äº†è¿è¡Œæ—¶å¸¸é‡æ± 
å­—èŠ‚ç æ–‡ä»¶ï¼Œå†…éƒ¨åŒ…å«äº†å¸¸é‡æ± 
è¦å¼„æ¸…æ¥šæ–¹æ³•åŒºï¼Œéœ€è¦ç†è§£æ¸…æ¥šC1assFileï¼Œå› ä¸ºåŠ è½½ç±»çš„ä¿¡æ¯éƒ½åœ¨æ–¹æ³•åŒºã€‚
è¦å¼„æ¸…æ¥šæ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œéœ€è¦ç†è§£æ¸…æ¥šclassFileä¸­çš„å¸¸é‡æ± ã€‚




å¸¸é‡æ± 
  ä¸€ä¸ªæœ‰æ•ˆçš„å­—èŠ‚ç æ–‡ä»¶ä¸­é™¤äº†åŒ…å«ç±»çš„ç‰ˆæœ¬ä¿¡æ¯ã€å­—æ®µã€æ–¹æ³•ä»¥åŠæ¥å£ç­‰æè¿°ç¬¦ä¿¡æ¯å¤–ï¼Œè¿˜åŒ…å«ä¸€é¡¹ä¿¡æ¯å°±æ˜¯å¸¸é‡æ± è¡¨ï¼ˆConstant Pool Tableï¼‰ï¼ŒåŒ…æ‹¬å„ç§å­—é¢é‡å’Œå¯¹ç±»å‹ã€åŸŸå’Œæ–¹æ³•çš„ç¬¦å·å¼•ç”¨
  

ä¸ºä»€ä¹ˆéœ€è¦å¸¸é‡æ± 
  ä¸€ä¸ªjavaæºæ–‡ä»¶ä¸­çš„ç±»ã€æ¥å£ï¼Œç¼–è¯‘åäº§ç”Ÿä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶ã€‚è€ŒJavaä¸­çš„å­—èŠ‚ç éœ€è¦æ•°æ®æ”¯æŒï¼Œé€šå¸¸è¿™ç§æ•°æ®ä¼šå¾ˆå¤§ä»¥è‡³äºä¸èƒ½ç›´æ¥å­˜åˆ°å­—èŠ‚ç é‡Œï¼Œæ¢å¦ä¸€ç§æ–¹å¼ï¼Œå¯ä»¥å­˜åˆ°å¸¸é‡æ± ï¼Œè¿™ä¸ªå­—èŠ‚ç åŒ…å«äº†æŒ‡å‘å¸¸é‡æ± çš„å¼•ç”¨ã€‚råœ¨åŠ¨æ€é“¾æ¥çš„æ—¶å€™ä¼šç”¨åˆ°è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œä¹‹å‰æœ‰ä»‹ç»ã€‚
  æ¯”å¦‚ï¼šå¦‚ä¸‹çš„ä»£ç ï¼š
  public class SimpleClass &#123;    public void sayHello() &#123;        System.out.println(&quot;hello&quot;);    &#125;&#125;

è™½ç„¶ä¸Šè¿°ä»£ç åªæœ‰194å­—èŠ‚ï¼Œä½†æ˜¯é‡Œé¢å´ä½¿ç”¨äº†Stringã€Systemã€PrintStreamåŠObjectç­‰ç»“æ„ã€‚
æ¯”å¦‚è¯´æˆ‘ä»¬è¿™ä¸ªæ–‡ä»¶ä¸­æœ‰6ä¸ªåœ°æ–¹ç”¨åˆ°äº†â€helloâ€è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œå¦‚æœä¸ç”¨å¸¸é‡æ± ï¼Œå°±éœ€è¦åœ¨6ä¸ªåœ°æ–¹å…¨å†™ä¸€éï¼Œé€ æˆè‡ƒè‚¿ã€‚æˆ‘ä»¬å¯ä»¥å°†â€helloâ€ç­‰æ‰€éœ€ç”¨åˆ°çš„ç»“æ„ä¿¡æ¯è®°å½•åœ¨å¸¸é‡æ± ä¸­ï¼Œå¹¶é€šè¿‡å¼•ç”¨çš„æ–¹å¼ï¼Œæ¥åŠ è½½ã€è°ƒç”¨æ‰€éœ€çš„ç»“æ„
è¿™é‡Œçš„ä»£ç é‡å…¶å®å¾ˆå°‘äº†ï¼Œå¦‚æœä»£ç å¤šçš„è¯ï¼Œå¼•ç”¨çš„ç»“æ„å°†ä¼šæ›´å¤šï¼Œè¿™é‡Œå°±éœ€è¦ç”¨åˆ°å¸¸é‡æ± äº†ã€‚


å¸¸é‡æ± ä¸­æœ‰å•¥ï¼Ÿ

æ•°é‡å€¼
å­—ç¬¦ä¸²å€¼
ç±»å¼•ç”¨
å­—æ®µå¼•ç”¨
æ–¹æ³•å¼•ç”¨

  ä¾‹å¦‚ä¸‹é¢è¿™æ®µä»£ç 
  package com.peppa.area;public class MethodAreaTest2 &#123;    public static void main(String args[]) &#123;        Object obj = new Object();    &#125;&#125;
  å°†ä¼šè¢«ç¿»è¯‘æˆå¦‚ä¸‹å­—èŠ‚ç 
  0: new           #2                  // class java/lang/Object3: dup4: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V7: astore_18: return

å¸¸é‡æ± æ€»ç»“
  å¸¸é‡æ± ã€å¯ä»¥çœ‹åšæ˜¯ä¸€å¼ è¡¨ï¼Œè™šæ‹ŸæœºæŒ‡ä»¤æ ¹æ®è¿™å¼ å¸¸é‡è¡¨æ‰¾åˆ°è¦æ‰§è¡Œçš„ç±»åã€æ–¹æ³•åã€å‚æ•°ç±»å‹ã€å­—é¢é‡ç­‰ç±»å‹ã€‚


4.è¿è¡Œæ—¶å¸¸é‡æ± 
è¿è¡Œæ—¶å¸¸é‡æ± 

è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRuntime Constant Poolï¼‰æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ã€‚
å¸¸é‡æ± è¡¨ï¼ˆConstant Pool Tableï¼‰æ˜¯Classå­—èŠ‚ç æ–‡ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡ä¸ç¬¦å·å¼•ç”¨ï¼Œè¿™éƒ¨åˆ†å†…å®¹å°†åœ¨ç±»åŠ è½½åå­˜æ”¾åˆ°æ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ã€‚ï¼ˆè¿è¡Œæ—¶å¸¸é‡æ± å°±æ˜¯å¸¸é‡æ± åœ¨ç¨‹åºè¿è¡Œæ—¶çš„ç§°å‘¼ï¼‰
è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œåœ¨åŠ è½½ç±»å’Œæ¥å£åˆ°è™šæ‹Ÿæœºåï¼Œå°±ä¼šåˆ›å»ºå¯¹åº”çš„è¿è¡Œæ—¶å¸¸é‡æ± ã€‚
JVMä¸ºæ¯ä¸ªå·²åŠ è½½çš„ç±»å‹ï¼ˆç±»æˆ–æ¥å£ï¼‰éƒ½ç»´æŠ¤ä¸€ä¸ªå¸¸é‡æ± ã€‚æ± ä¸­çš„æ•°æ®é¡¹åƒæ•°ç»„é¡¹ä¸€æ ·ï¼Œæ˜¯é€šè¿‡ç´¢å¼•è®¿é—®çš„ã€‚
è¿è¡Œæ—¶å¸¸é‡æ± ä¸­åŒ…å«å¤šç§ä¸åŒçš„å¸¸é‡ï¼ŒåŒ…æ‹¬ç¼–è¯‘æœŸå°±å·²ç»æ˜ç¡®çš„æ•°å€¼å­—é¢é‡ï¼Œä¹ŸåŒ…æ‹¬åˆ°è¿è¡ŒæœŸè§£æåæ‰èƒ½å¤Ÿè·å¾—çš„æ–¹æ³•æˆ–è€…å­—æ®µå¼•ç”¨ã€‚æ­¤æ—¶ä¸å†æ˜¯å¸¸é‡æ± ä¸­çš„ç¬¦å·åœ°å€äº†ï¼Œè¿™é‡Œæ¢ä¸ºçœŸå®åœ°å€ã€‚
è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œç›¸å¯¹äºClassæ–‡ä»¶å¸¸é‡æ± çš„å¦ä¸€é‡è¦ç‰¹å¾æ˜¯ï¼šå…·å¤‡åŠ¨æ€æ€§ã€‚


è¿è¡Œæ—¶å¸¸é‡æ± ç±»ä¼¼äºä¼ ç»Ÿç¼–ç¨‹è¯­è¨€ä¸­çš„ç¬¦å·è¡¨ï¼ˆsymbol tableï¼‰ï¼Œä½†æ˜¯å®ƒæ‰€åŒ…å«çš„æ•°æ®å´æ¯”ç¬¦å·è¡¨è¦æ›´åŠ ä¸°å¯Œä¸€äº›ã€‚
å½“åˆ›å»ºç±»æˆ–æ¥å£çš„è¿è¡Œæ—¶å¸¸é‡æ± æ—¶ï¼Œå¦‚æœæ„é€ è¿è¡Œæ—¶å¸¸é‡æ± æ‰€éœ€çš„å†…å­˜ç©ºé—´è¶…è¿‡äº†æ–¹æ³•åŒºæ‰€èƒ½æä¾›çš„æœ€å¤§å€¼ï¼Œåˆ™JVMä¼šæŠ›OutofMemoryErrorå¼‚å¸¸ã€‚


æ–¹æ³•åŒºçš„ä½¿ç”¨ä¸¾ä¾‹

ä»£ç 
  package com.peppa.area;public class MethodAreaDemo &#123;    public static void main(String[] args) &#123;        int x = 500;        int y = 100;        int a = x / y;        int b = 50;        System.out.println(a + b);    &#125;&#125;

å­—èŠ‚ç 
  public class com.peppa.area.MethodAreaDemo  minor version: 0  major version: 52  flags: ACC_PUBLIC, ACC_SUPERConstant pool:   #1 = Methodref          #5.#25         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V   #2 = Fieldref           #26.#27        // java/lang/System.out:Ljava/io/PrintStream;   #3 = Methodref          #28.#29        // java/io/PrintStream.println:(I)V   #4 = Class              #30            // com/peppa/area/MethodAreaDemo   #5 = Class              #31            // java/lang/Object   #6 = Utf8               &lt;init&gt;   #7 = Utf8               ()V   #8 = Utf8               Code   #9 = Utf8               LineNumberTable  #10 = Utf8               LocalVariableTable  #11 = Utf8               this  #12 = Utf8               Lcom/peppa/area/MethodAreaDemo;  #13 = Utf8               main  #14 = Utf8               ([Ljava/lang/String;)V  #15 = Utf8               args  #16 = Utf8               [Ljava/lang/String;  #17 = Utf8               x  #18 = Utf8               I  #19 = Utf8               y  #20 = Utf8               a  #21 = Utf8               b  #22 = Utf8               MethodParameters  #23 = Utf8               SourceFile  #24 = Utf8               MethodAreaDemo.java  #25 = NameAndType        #6:#7          // &quot;&lt;init&gt;&quot;:()V  #26 = Class              #32            // java/lang/System  #27 = NameAndType        #33:#34        // out:Ljava/io/PrintStream;  #28 = Class              #35            // java/io/PrintStream  #29 = NameAndType        #36:#37        // println:(I)V  #30 = Utf8               com/peppa/area/MethodAreaDemo  #31 = Utf8               java/lang/Object  #32 = Utf8               java/lang/System  #33 = Utf8               out  #34 = Utf8               Ljava/io/PrintStream;  #35 = Utf8               java/io/PrintStream  #36 = Utf8               println  #37 = Utf8               (I)V&#123;  public com.peppa.area.MethodAreaDemo();    descriptor: ()V    flags: ACC_PUBLIC    Code:      stack=1, locals=1, args_size=1         0: aload_0         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V         4: return      LineNumberTable:        line 3: 0      LocalVariableTable:        Start  Length  Slot  Name   Signature            0       5     0  this   Lcom/peppa/area/MethodAreaDemo;  public static void main(java.lang.String[]);    descriptor: ([Ljava/lang/String;)V    flags: ACC_PUBLIC, ACC_STATIC    Code:      stack=3, locals=5, args_size=1         0: sipush        500         3: istore_1         4: bipush        100         6: istore_2         7: iload_1         8: iload_2         9: idiv        10: istore_3        11: bipush        50        13: istore        4        15: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;        18: iload_3        19: iload         4        21: iadd        22: invokevirtual #3                  // Method java/io/PrintStream.println:(I)V        25: return      LineNumberTable:        line 5: 0        line 6: 4        line 7: 7        line 8: 11        line 9: 15        line 10: 25      LocalVariableTable:        Start  Length  Slot  Name   Signature            0      26     0  args   [Ljava/lang/String;            4      22     1     x   I            7      19     2     y   I           11      15     3     a   I           15      11     4     b   I    MethodParameters:      Name                           Flags      args&#125;


å›¾è§£å­—èŠ‚ç æŒ‡ä»¤æ‰§è¡Œæµç¨‹
  
  é¦–å…ˆç°å°†æ“ä½œæ•°500æ”¾å…¥åˆ°æ“ä½œæ•°æ ˆä¸­
  
  ç„¶åå­˜å‚¨åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­
  
  ç„¶åé‡å¤ä¸€æ¬¡ï¼ŒæŠŠ100æ”¾å…¥å±€éƒ¨å˜é‡è¡¨ä¸­ï¼Œæœ€åå†å°†å˜é‡è¡¨ä¸­çš„500 å’Œ 100 å–å‡ºï¼Œè¿›è¡Œæ“ä½œ
  
  å°†500 å’Œ 100 è¿›è¡Œä¸€ä¸ªé™¤æ³•è¿ç®—ï¼Œåœ¨æŠŠç»“æœå…¥æ ˆ
  
  åœ¨æœ€åå°±æ˜¯è¾“å‡ºæµï¼Œéœ€è¦è°ƒç”¨è¿è¡Œæ—¶å¸¸é‡æ± çš„å¸¸é‡
  
  æœ€åè°ƒç”¨invokevirtualï¼ˆè™šæ–¹æ³•è°ƒç”¨ï¼‰ï¼Œç„¶åè¿”å›
  
  è¿”å›æ—¶
  
  ç¨‹åºè®¡æ•°å™¨å§‹ç»ˆè®¡ç®—çš„éƒ½æ˜¯å½“å‰ä»£ç è¿è¡Œçš„ä½ç½®ï¼Œç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿è®°å½• æ–¹æ³•è°ƒç”¨åèƒ½å¤Ÿæ­£å¸¸è¿”å›ï¼Œæˆ–è€…æ˜¯è¿›è¡Œäº†CPUåˆ‡æ¢åï¼Œä¹Ÿèƒ½å›æ¥åˆ°åŸæ¥çš„ä»£ç è¿›è¡Œæ‰§è¡Œã€‚
  ç¬¦å·å¼•ç”¨ â€“&gt; ç›´æ¥å¼•ç”¨ï¼š

ä¸Šé¢ä»£ç è°ƒç”¨ System.out.println() æ–¹æ³•æ—¶ï¼Œé¦–å…ˆéœ€è¦çœ‹çœ‹ System ç±»æœ‰æ²¡æœ‰åŠ è½½ï¼Œå†çœ‹çœ‹ PrintStream ç±»æœ‰æ²¡æœ‰åŠ è½½
å¦‚æœæ²¡æœ‰åŠ è½½ï¼Œåˆ™æ‰§è¡ŒåŠ è½½ï¼Œæ‰§è¡Œæ—¶ï¼Œå°†å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨ï¼ˆå­—é¢é‡ï¼‰è½¬æ¢ä¸ºè¿è¡Œæ—¶å¸¸é‡æ± çš„ç›´æ¥å¼•ç”¨ï¼ˆçœŸæ­£çš„åœ°å€å€¼ï¼‰



5.æ–¹æ³•åŒºçš„æ¼”è¿›ç»†èŠ‚
æ°¸ä¹…ä»£æ¼”è¿›è¿‡ç¨‹

é¦–å…ˆæ˜ç¡®ï¼šåªæœ‰Hotspotæ‰æœ‰æ°¸ä¹…ä»£ã€‚BEA JRockitã€IBMJ9ç­‰æ¥è¯´ï¼Œæ˜¯ä¸å­˜åœ¨æ°¸ä¹…ä»£çš„æ¦‚å¿µçš„ã€‚åŸåˆ™ä¸Šå¦‚ä½•å®ç°æ–¹æ³•åŒºå±äºè™šæ‹Ÿæœºå®ç°ç»†èŠ‚ï¼Œä¸å—ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ç®¡æŸï¼Œå¹¶ä¸è¦æ±‚ç»Ÿä¸€ã€‚


Hotspotä¸­æ–¹æ³•åŒºçš„å˜åŒ–ï¼š
  JDK1.6åŠä»¥å‰	  æœ‰æ°¸ä¹…ä»£ï¼ˆpermanent generationï¼‰ï¼Œé™æ€å˜é‡å­˜å‚¨åœ¨æ°¸ä¹…ä»£ä¸ŠJDK1.7	       æœ‰æ°¸ä¹…ä»£ï¼Œä½†å·²ç»é€æ­¥ â€œå»æ°¸ä¹…ä»£â€ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œé™æ€å˜é‡ç§»é™¤ï¼Œä¿å­˜åœ¨å †ä¸­JDK1.8	       æ— æ°¸ä¹…ä»£ï¼Œç±»å‹ä¿¡æ¯ï¼Œå­—æ®µï¼Œæ–¹æ³•ï¼Œå¸¸é‡ä¿å­˜åœ¨æœ¬åœ°å†…å­˜çš„å…ƒç©ºé—´ï¼Œä½†å­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡ä»ç„¶åœ¨å †ä¸­ã€‚

JDK6
  æ–¹æ³•åŒºç”±æ°¸ä¹…ä»£å®ç°ï¼Œä½¿ç”¨ JVM è™šæ‹Ÿæœºå†…å­˜ï¼ˆè™šæ‹Ÿçš„å†…å­˜ï¼‰
  

JDK7
  æ–¹æ³•åŒºç”±æ°¸ä¹…ä»£å®ç°ï¼Œä½¿ç”¨ JVM è™šæ‹Ÿæœºå†…å­˜
  

JDK8
  å…ƒç©ºé—´å¤§å°åªå—ç‰©ç†å†…å­˜å½±å“
  

æ°¸ä¹…ä»£ä¸ºä»€ä¹ˆè¦è¢«å…ƒç©ºé—´æ›¿ä»£ï¼Ÿ

å®˜æ–¹æ–‡æ¡£ï¼šJEP 122: Remove the Permanent Generation (java.net)


éšç€Java8çš„åˆ°æ¥ï¼ŒHotSpot VMä¸­å†ä¹Ÿè§ä¸åˆ°æ°¸ä¹…ä»£äº†ã€‚ä½†æ˜¯è¿™å¹¶ä¸æ„å‘³ç€ç±»çš„å…ƒæ•°æ®ä¿¡æ¯ä¹Ÿæ¶ˆå¤±äº†ã€‚è¿™äº›æ•°æ®è¢«ç§»åˆ°äº†ä¸€ä¸ªä¸å †ä¸ç›¸è¿çš„æœ¬åœ°å†…å­˜åŒºåŸŸï¼Œè¿™ä¸ªåŒºåŸŸå«åšå…ƒç©ºé—´ï¼ˆMetaspaceï¼‰ã€‚
ç”±äºç±»çš„å…ƒæ•°æ®åˆ†é…åœ¨æœ¬åœ°å†…å­˜ä¸­ï¼Œå…ƒç©ºé—´çš„æœ€å¤§å¯åˆ†é…ç©ºé—´å°±æ˜¯ç³»ç»Ÿå¯ç”¨å†…å­˜ç©ºé—´ã€‚
è¿™é¡¹æ”¹åŠ¨æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼ŒåŸå› æœ‰ï¼š
ä¸ºæ°¸ä¹…ä»£è®¾ç½®ç©ºé—´å¤§å°æ˜¯å¾ˆéš¾ç¡®å®šçš„ã€‚åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œå¦‚æœåŠ¨æ€åŠ è½½ç±»è¿‡å¤šï¼Œå®¹æ˜“äº§ç”ŸPermåŒºçš„OOMã€‚æ¯”å¦‚æŸä¸ªå®é™…Webå·¥ç¨‹ä¸­ï¼Œå› ä¸ºåŠŸèƒ½ç‚¹æ¯”è¾ƒå¤šï¼Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œè¦ä¸æ–­åŠ¨æ€åŠ è½½å¾ˆå¤šç±»ï¼Œç»å¸¸å‡ºç°è‡´å‘½é”™è¯¯ã€‚Exception in thread &#39;dubbo client x.x connector&#39; java.lang.OutOfMemoryError:PermGen spaceè€Œå…ƒç©ºé—´å’Œæ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ã€‚ å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç©ºé—´çš„å¤§å°ä»…å—æœ¬åœ°å†…å­˜é™åˆ¶ã€‚
å¯¹æ°¸ä¹…ä»£è¿›è¡Œè°ƒä¼˜æ˜¯å¾ˆå›°éš¾çš„ã€‚æ–¹æ³•åŒºçš„åƒåœ¾æ”¶é›†ä¸»è¦å›æ”¶ä¸¤éƒ¨åˆ†å†…å®¹ï¼šå¸¸é‡æ± ä¸­åºŸå¼ƒçš„å¸¸é‡å’Œä¸å†ç”¨çš„ç±»å‹ï¼Œæ–¹æ³•åŒºçš„è°ƒä¼˜ä¸»è¦æ˜¯ä¸ºäº†é™ä½Full GC
æœ‰äº›äººè®¤ä¸ºæ–¹æ³•åŒºï¼ˆå¦‚HotSpotè™šæ‹Ÿæœºä¸­çš„å…ƒç©ºé—´æˆ–è€…æ°¸ä¹…ä»£ï¼‰æ˜¯æ²¡æœ‰åƒåœ¾æ”¶é›†è¡Œä¸ºçš„ï¼Œå…¶å®ä¸ç„¶ã€‚ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹å¯¹æ–¹æ³•åŒºçš„çº¦æŸæ˜¯éå¸¸å®½æ¾çš„ï¼Œæåˆ°è¿‡å¯ä»¥ä¸è¦æ±‚è™šæ‹Ÿæœºåœ¨æ–¹æ³•åŒºä¸­å®ç°åƒåœ¾æ”¶é›†ã€‚äº‹å®ä¸Šä¹Ÿç¡®å®æœ‰æœªå®ç°æˆ–æœªèƒ½å®Œæ•´å®ç°æ–¹æ³•åŒºç±»å‹å¸è½½çš„æ”¶é›†å™¨å­˜åœ¨ï¼ˆå¦‚JDK11æ—¶æœŸçš„ZGCæ”¶é›†å™¨å°±ä¸æ”¯æŒç±»å¸è½½ï¼‰ã€‚
ä¸€èˆ¬æ¥è¯´è¿™ä¸ªåŒºåŸŸçš„å›æ”¶æ•ˆæœæ¯”è¾ƒéš¾ä»¤äººæ»¡æ„ï¼Œå°¤å…¶æ˜¯ç±»å‹çš„å¸è½½ï¼Œæ¡ä»¶ç›¸å½“è‹›åˆ»**ã€‚ä½†æ˜¯è¿™éƒ¨åˆ†åŒºåŸŸçš„å›æ”¶æœ‰æ—¶åˆç¡®å®æ˜¯å¿…è¦çš„ã€‚ä»¥å‰Sunå…¬å¸çš„Bugåˆ—è¡¨ä¸­ï¼Œæ›¾å‡ºç°è¿‡çš„è‹¥å¹²ä¸ªä¸¥é‡çš„Bugå°±æ˜¯ç”±äºä½ç‰ˆæœ¬çš„HotSpotè™šæ‹Ÿæœºå¯¹æ­¤åŒºåŸŸæœªå®Œå…¨å›æ”¶è€Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚






å­—ç¬¦ä¸²å¸¸é‡æ±  StringTable ä¸ºä»€ä¹ˆè¦è°ƒæ•´ä½ç½®ï¼Ÿ

JDK7ä¸­å°†StringTableæ”¾åˆ°äº†å †ç©ºé—´ä¸­ã€‚å› ä¸ºæ°¸ä¹…ä»£çš„å›æ”¶æ•ˆç‡å¾ˆä½ï¼Œåœ¨Full GCçš„æ—¶å€™æ‰ä¼šæ‰§è¡Œæ°¸ä¹…ä»£çš„åƒåœ¾å›æ”¶ï¼Œè€ŒFull GCæ˜¯è€å¹´ä»£çš„ç©ºé—´ä¸è¶³ã€æ°¸ä¹…ä»£ä¸è¶³æ—¶æ‰ä¼šè§¦å‘ã€‚
è¿™å°±å¯¼è‡´StringTableå›æ”¶æ•ˆç‡ä¸é«˜ï¼Œè€Œæˆ‘ä»¬å¼€å‘ä¸­ä¼šæœ‰å¤§é‡çš„å­—ç¬¦ä¸²è¢«åˆ›å»ºï¼Œå›æ”¶æ•ˆç‡ä½ï¼Œå¯¼è‡´æ°¸ä¹…ä»£å†…å­˜ä¸è¶³ã€‚æ”¾åˆ°å †é‡Œï¼Œèƒ½åŠæ—¶å›æ”¶å†…å­˜ã€‚


æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶

æœ‰äº›äººè®¤ä¸ºæ–¹æ³•åŒºï¼ˆå¦‚Hotspotè™šæ‹Ÿæœºä¸­çš„å…ƒç©ºé—´æˆ–è€…æ°¸ä¹…ä»£ï¼‰æ˜¯æ²¡æœ‰åƒåœ¾æ”¶é›†è¡Œä¸ºçš„ï¼Œå…¶å®ä¸ç„¶ã€‚ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹å¯¹æ–¹æ³•åŒºçš„çº¦æŸæ˜¯éå¸¸å®½æ¾çš„ï¼Œæåˆ°è¿‡å¯ä»¥ä¸è¦æ±‚è™šæ‹Ÿæœºåœ¨æ–¹æ³•åŒºä¸­å®ç°åƒåœ¾æ”¶é›†ã€‚äº‹å®ä¸Šä¹Ÿç¡®å®æœ‰æœªå®ç°æˆ–æœªèƒ½å®Œæ•´å®ç°æ–¹æ³•åŒºç±»å‹å¸è½½çš„æ”¶é›†å™¨å­˜åœ¨ï¼ˆå¦‚JDK11æ—¶æœŸçš„zGCæ”¶é›†å™¨å°±ä¸æ”¯æŒç±»å¸è½½ï¼‰ã€‚

ä¸€èˆ¬æ¥è¯´è¿™ä¸ªåŒºåŸŸçš„å›æ”¶æ•ˆæœæ¯”è¾ƒéš¾ä»¤äººæ»¡æ„ï¼Œå°¤å…¶æ˜¯ç±»å‹çš„å¸è½½ï¼Œæ¡ä»¶ç›¸å½“è‹›åˆ»ã€‚ä½†æ˜¯è¿™éƒ¨åˆ†åŒºåŸŸçš„å›æ”¶æœ‰æ—¶åˆç¡®å®æ˜¯å¿…è¦çš„ã€‚ä»¥å‰sunå…¬å¸çš„Bugåˆ—è¡¨ä¸­ï¼Œæ›¾å‡ºç°è¿‡çš„è‹¥å¹²ä¸ªä¸¥é‡çš„Bugå°±æ˜¯ç”±äºä½ç‰ˆæœ¬çš„HotSpotè™šæ‹Ÿæœºå¯¹æ­¤åŒºåŸŸæœªå®Œå…¨å›æ”¶è€Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚

æ–¹æ³•åŒºçš„åƒåœ¾æ”¶é›†ä¸»è¦å›æ”¶ä¸¤éƒ¨åˆ†å†…å®¹ï¼šå¸¸é‡æ± ä¸­åºŸå¼ƒçš„å¸¸é‡å’Œä¸å†ä½¿ç”¨çš„ç±»å‹ã€‚

å…ˆæ¥è¯´è¯´æ–¹æ³•åŒºå†…å¸¸é‡æ± ä¹‹ä¸­ä¸»è¦å­˜æ”¾çš„ä¸¤å¤§ç±»å¸¸é‡ï¼šå­—é¢é‡å’Œç¬¦å·å¼•ç”¨ã€‚å­—é¢é‡æ¯”è¾ƒæ¥è¿‘Javaè¯­è¨€å±‚æ¬¡çš„å¸¸é‡æ¦‚å¿µï¼Œå¦‚æ–‡æœ¬å­—ç¬¦ä¸²ã€è¢«å£°æ˜ä¸ºfinalçš„å¸¸é‡å€¼ç­‰ã€‚è€Œç¬¦å·å¼•ç”¨åˆ™å±äºç¼–è¯‘åŸç†æ–¹é¢çš„æ¦‚å¿µï¼ŒåŒ…æ‹¬ä¸‹é¢ä¸‰ç±»å¸¸é‡ï¼š

ç±»å’Œæ¥å£çš„å…¨é™å®šå
å­—æ®µçš„åç§°å’Œæè¿°ç¬¦
æ–¹æ³•çš„åç§°å’Œæè¿°ç¬¦


HotSpotè™šæ‹Ÿæœºå¯¹å¸¸é‡æ± çš„å›æ”¶ç­–ç•¥æ˜¯å¾ˆæ˜ç¡®çš„ï¼Œåªè¦å¸¸é‡æ± ä¸­çš„å¸¸é‡æ²¡æœ‰è¢«ä»»ä½•åœ°æ–¹å¼•ç”¨ï¼Œå°±å¯ä»¥è¢«å›æ”¶ã€‚

å›æ”¶åºŸå¼ƒå¸¸é‡ä¸å›æ”¶Javaå †ä¸­çš„å¯¹è±¡éå¸¸ç±»ä¼¼ã€‚ï¼ˆå…³äºå¸¸é‡çš„å›æ”¶æ¯”è¾ƒç®€å•ï¼Œé‡ç‚¹æ˜¯ç±»çš„å›æ”¶ï¼‰



ç±»å¸è½½

åˆ¤å®šä¸€ä¸ªå¸¸é‡æ˜¯å¦â€œåºŸå¼ƒâ€è¿˜æ˜¯ç›¸å¯¹ç®€å•ï¼Œè€Œè¦åˆ¤å®šä¸€ä¸ªç±»å‹æ˜¯å¦å±äºâ€œä¸å†è¢«ä½¿ç”¨çš„ç±»â€çš„æ¡ä»¶å°±æ¯”è¾ƒè‹›åˆ»äº†ã€‚éœ€è¦åŒæ—¶æ»¡è¶³ä¸‹é¢ä¸‰ä¸ªæ¡ä»¶ï¼š
è¯¥ç±»æ‰€æœ‰çš„å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯Javaå †ä¸­ä¸å­˜åœ¨è¯¥ç±»åŠå…¶ä»»ä½•æ´¾ç”Ÿå­ç±»çš„å®ä¾‹ã€‚
åŠ è½½è¯¥ç±»çš„ç±»åŠ è½½å™¨å·²ç»è¢«å›æ”¶ï¼Œè¿™ä¸ªæ¡ä»¶é™¤éæ˜¯ç»è¿‡ç²¾å¿ƒè®¾è®¡çš„å¯æ›¿æ¢ç±»åŠ è½½å™¨çš„åœºæ™¯ï¼Œå¦‚OSGiã€JSPçš„é‡åŠ è½½ç­‰ï¼Œå¦åˆ™é€šå¸¸æ˜¯å¾ˆéš¾è¾¾æˆçš„ã€‚
è¯¥ç±»å¯¹åº”çš„java.lang.C1asså¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•ã€‚


Javaè™šæ‹Ÿæœºè¢«å…è®¸å¯¹æ»¡è¶³ä¸Šè¿°ä¸‰ä¸ªæ¡ä»¶çš„æ— ç”¨ç±»è¿›è¡Œå›æ”¶ï¼Œè¿™é‡Œè¯´çš„ä»…ä»…æ˜¯â€œè¢«å…è®¸â€ï¼Œè€Œå¹¶ä¸æ˜¯å’Œå¯¹è±¡ä¸€æ ·ï¼Œæ²¡æœ‰å¼•ç”¨äº†å°±å¿…ç„¶ä¼šå›æ”¶ã€‚å…³äºæ˜¯å¦è¦å¯¹ç±»å‹è¿›è¡Œå›æ”¶ï¼ŒHotSpotè™šæ‹Ÿæœºæä¾›äº†-Xnoclassgcå‚æ•°è¿›è¡Œæ§åˆ¶ï¼Œè¿˜å¯ä»¥ä½¿ç”¨**-verbose:class ä»¥åŠ -XXï¼š+TraceClass-Loadingã€-XXï¼š+TraceClassUnLoading**æŸ¥çœ‹ç±»åŠ è½½å’Œå¸è½½ä¿¡æ¯
åœ¨å¤§é‡ä½¿ç”¨åå°„ã€åŠ¨æ€ä»£ç†ã€CGLibç­‰å­—èŠ‚ç æ¡†æ¶ï¼ŒåŠ¨æ€ç”ŸæˆJSPä»¥åŠoSGiè¿™ç±»é¢‘ç¹è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„åœºæ™¯ä¸­ï¼Œé€šå¸¸éƒ½éœ€è¦Javaè™šæ‹Ÿæœºå…·å¤‡ç±»å‹å¸è½½çš„èƒ½åŠ›ï¼Œä»¥ä¿è¯ä¸ä¼šå¯¹æ–¹æ³•åŒºé€ æˆè¿‡å¤§çš„å†…å­˜å‹åŠ›ã€‚

  


6.ç›´æ¥å†…å­˜ Direct Memory
ç›´æ¥å†…å­˜æ¦‚è¿°

ä¸æ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸æ˜¯ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­å®šä¹‰çš„å†…å­˜åŒºåŸŸã€‚
ç›´æ¥å†…å­˜æ˜¯åœ¨Javaå †å¤–çš„ã€ç›´æ¥å‘ç³»ç»Ÿç”³è¯·çš„å†…å­˜åŒºé—´ã€‚
æ¥æºäºNIOï¼Œé€šè¿‡å­˜åœ¨å †ä¸­çš„DirectByteBufferæ“ä½œNativeå†…å­˜
é€šå¸¸ï¼Œè®¿é—®ç›´æ¥å†…å­˜çš„é€Ÿåº¦ä¼šä¼˜äºJavaå †ã€‚å³è¯»å†™æ€§èƒ½é«˜ã€‚
å› æ­¤å‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œè¯»å†™é¢‘ç¹çš„åœºåˆå¯èƒ½ä¼šè€ƒè™‘ä½¿ç”¨ç›´æ¥å†…å­˜ã€‚
Javaçš„NIOåº“å…è®¸Javaç¨‹åºä½¿ç”¨ç›´æ¥å†…å­˜ï¼Œç”¨äºæ•°æ®ç¼“å†²åŒº


ä½¿ç”¨ä¸‹åˆ—ä»£ç ï¼Œç›´æ¥åˆ†é…æœ¬åœ°å†…å­˜ç©ºé—´


int BUFFER = 1024*1024*1024; // 1GBByteBuffer byteBuffer = ByteBuffer.allocateDirect(BUFFER);


éç›´æ¥ç¼“å­˜åŒºå’Œç¼“å­˜åŒº

NIOçš„æ–¹å¼ä½¿ç”¨äº†ç¼“å­˜åŒºçš„æ¦‚å¿µ


å­˜åœ¨çš„é—®é¢˜
  ä¹Ÿå¯èƒ½å¯¼è‡´outofMemoryErrorå¼‚å¸¸
  ç”±äºç›´æ¥å†…å­˜åœ¨Javaå †å¤–ï¼Œå› æ­¤å®ƒçš„å¤§å°ä¸ä¼šç›´æ¥å—é™äº-xmxæŒ‡å®šçš„æœ€å¤§å †å¤§å°ï¼Œä½†æ˜¯ç³»ç»Ÿå†…å­˜æ˜¯æœ‰é™çš„ï¼ŒJavaå †å’Œç›´æ¥å†…å­˜çš„æ€»å’Œä¾ç„¶å—é™äºæ“ä½œç³»ç»Ÿèƒ½ç»™å‡ºçš„æœ€å¤§å†…å­˜ã€‚ ç¼ºç‚¹

åˆ†é…å›æ”¶æˆæœ¬è¾ƒé«˜
ä¸å—JVMå†…å­˜å›æ”¶ç®¡ç†

  ç›´æ¥å†…å­˜å¤§å°å¯ä»¥é€šè¿‡MaxDirectMemorySizeè®¾ç½®
  å¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤ä¸å †çš„æœ€å¤§å€¼-xmxå‚æ•°å€¼ä¸€è‡´
  


]]></content>
      <categories>
        <category>JVMè™šæ‹Ÿæœºè¯¦è§£</category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>JVMè™šæ‹Ÿæœºè¯¦è§£</tag>
      </tags>
  </entry>
  <entry>
    <title>JVMè™šæ‹Ÿæœºè¯¦è§£(äºŒ)**ç±»åŠ è½½å­ç³»ç»Ÿ</title>
    <url>/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3(%E4%BA%8C)%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%AD%90%E7%B3%BB%E7%BB%9F/</url>
    <content><![CDATA[JVMè™šæ‹Ÿæœºè¯¦è§£(äºŒ)ç±»åŠ è½½å­ç³»ç»Ÿ1. å†…å­˜ç»“æ„æ¦‚è¿°

ğŸ’¡ æ³¨æ„ï¼šæ–¹æ³•åŒºåªæœ‰HotSpotè™šæ‹Ÿæœºæœ‰ï¼ŒJ9ï¼ŒJRockitéƒ½æ²¡æœ‰




2.ç±»åŠ è½½å™¨å­ç³»ç»Ÿ
ç±»åŠ è½½å™¨å­ç³»ç»Ÿä½œç”¨ï¼š

ç±»åŠ è½½å™¨å­ç³»ç»Ÿè´Ÿè´£ä»æ–‡ä»¶ç³»ç»Ÿæˆ–è€…ç½‘ç»œä¸­åŠ è½½Classæ–‡ä»¶ï¼Œclassæ–‡ä»¶åœ¨æ–‡ä»¶å¼€å¤´æœ‰ç‰¹å®šçš„æ–‡ä»¶æ ‡è¯†ã€‚
ClassLoaderåªè´Ÿè´£classæ–‡ä»¶çš„åŠ è½½ï¼Œè‡³äºå®ƒæ˜¯å¦å¯ä»¥è¿è¡Œï¼Œåˆ™ç”±Execution Engineå†³å®šã€‚
åŠ è½½çš„ç±»ä¿¡æ¯å­˜æ”¾äºä¸€å—ç§°ä¸ºæ–¹æ³•åŒºçš„å†…å­˜ç©ºé—´ã€‚é™¤äº†ç±»çš„ä¿¡æ¯å¤–ï¼Œæ–¹æ³•åŒºä¸­è¿˜ä¼šå­˜æ”¾è¿è¡Œæ—¶å¸¸é‡æ± ä¿¡æ¯ï¼Œå¯èƒ½è¿˜åŒ…æ‹¬å­—ç¬¦ä¸²å­—é¢é‡å’Œæ•°å­—å¸¸é‡ï¼ˆè¿™éƒ¨åˆ†å¸¸é‡ä¿¡æ¯æ˜¯Classæ–‡ä»¶ä¸­å¸¸é‡æ± éƒ¨åˆ†çš„å†…å­˜æ˜ å°„ï¼‰

  


3. ç±»åŠ è½½å™¨ClassLoaderè§’è‰²
class fileï¼ˆåœ¨ä¸‹å›¾ä¸­å°±æ˜¯Car.classæ–‡ä»¶ï¼‰å­˜åœ¨äºæœ¬åœ°ç¡¬ç›˜ä¸Šï¼Œå¯ä»¥ç†è§£ä¸ºè®¾è®¡å¸ˆç”»åœ¨çº¸ä¸Šçš„æ¨¡æ¿ï¼Œè€Œæœ€ç»ˆè¿™ä¸ªæ¨¡æ¿åœ¨æ‰§è¡Œçš„æ—¶å€™æ˜¯è¦åŠ è½½åˆ°JVMå½“ä¸­æ¥æ ¹æ®è¿™ä¸ªæ–‡ä»¶å®ä¾‹åŒ–å‡ºnä¸ªä¸€æ¨¡ä¸€æ ·çš„å®ä¾‹ã€‚
class fileåŠ è½½åˆ°JVMä¸­ï¼Œè¢«ç§°ä¸ºDNAå…ƒæ•°æ®æ¨¡æ¿ï¼ˆåœ¨ä¸‹å›¾ä¸­å°±æ˜¯å†…å­˜ä¸­çš„Car Classï¼‰ï¼Œæ”¾åœ¨æ–¹æ³•åŒºã€‚
åœ¨.classæ–‡ä»¶â€“&gt;JVMâ€“&gt;æœ€ç»ˆæˆä¸ºå…ƒæ•°æ®æ¨¡æ¿ï¼Œæ­¤è¿‡ç¨‹å°±è¦ä¸€ä¸ªè¿è¾“å·¥å…·ï¼ˆç±»è£…è½½å™¨Class Loaderï¼‰ï¼Œæ‰®æ¼”ä¸€ä¸ªå¿«é€’å‘˜çš„è§’è‰²ã€‚


4.ç±»åŠ è½½è¿‡ç¨‹ä¾‹å¦‚ä¸‹é¢çš„ä¸€æ®µç®€å•çš„ä»£ç 
/** * ç±»åŠ è½½å­ç³»ç»Ÿ * @author peppa * @create 2022-02-08 16:51:45 */public class HelloLoader &#123;    public static void main(String[] args) &#123;        System.out.println(&quot;æˆ‘å·²ç»è¢«åŠ è½½å•¦...&quot;);    &#125;&#125;


å®ƒçš„åŠ è½½è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„å‘¢?

æ‰§è¡Œ main() æ–¹æ³•ï¼ˆé™æ€æ–¹æ³•ï¼‰å°±éœ€è¦å…ˆåŠ è½½mainæ–¹æ³•æ‰€åœ¨ç±» HelloLoader
åŠ è½½æˆåŠŸï¼Œåˆ™è¿›è¡Œé“¾æ¥ã€åˆå§‹åŒ–ç­‰æ“ä½œã€‚å®Œæˆåè°ƒç”¨ HelloLoader ç±»ä¸­çš„é™æ€æ–¹æ³• main
åŠ è½½å¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸

  
  å®Œæ•´çš„æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤º
  


5. åŠ è½½é˜¶æ®µ
åŠ è½½ï¼š

é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåè·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ
å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„
åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„java.lang.Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£


åŠ è½½classæ–‡ä»¶çš„æ–¹å¼

ä»æœ¬åœ°ç³»ç»Ÿä¸­ç›´æ¥åŠ è½½
é€šè¿‡ç½‘ç»œè·å–ï¼Œå…¸å‹åœºæ™¯ï¼šWeb Applet
ä»zipå‹ç¼©åŒ…ä¸­è¯»å–ï¼Œæˆä¸ºæ—¥åjarã€waræ ¼å¼çš„åŸºç¡€
è¿è¡Œæ—¶è®¡ç®—ç”Ÿæˆï¼Œä½¿ç”¨æœ€å¤šçš„æ˜¯ï¼šåŠ¨æ€ä»£ç†æŠ€æœ¯
ç”±å…¶ä»–æ–‡ä»¶ç”Ÿæˆï¼Œå…¸å‹åœºæ™¯ï¼šJSPåº”ç”¨ä»ä¸“æœ‰æ•°æ®åº“ä¸­æå–.classæ–‡ä»¶ï¼Œæ¯”è¾ƒå°‘è§
ä»åŠ å¯†æ–‡ä»¶ä¸­è·å–ï¼Œå…¸å‹çš„é˜²Classæ–‡ä»¶è¢«åç¼–è¯‘çš„ä¿æŠ¤æªæ–½



6. é“¾æ¥é˜¶æ®µé“¾æ¥åˆ†ä¸ºä¸‰ä¸ªå­é˜¶æ®µï¼šéªŒè¯ -&gt; å‡†å¤‡ -&gt; è§£æ

éªŒè¯(Verify)

ç›®çš„åœ¨äºç¡®ä¿Classæ–‡ä»¶çš„å­—èŠ‚æµä¸­åŒ…å«ä¿¡æ¯ç¬¦åˆå½“å‰è™šæ‹Ÿæœºè¦æ±‚ï¼Œä¿è¯è¢«åŠ è½½ç±»çš„æ­£ç¡®æ€§ï¼Œä¸ä¼šå±å®³è™šæ‹Ÿæœºè‡ªèº«å®‰å…¨
ä¸»è¦åŒ…æ‹¬å››ç§éªŒè¯ï¼Œæ–‡ä»¶æ ¼å¼éªŒè¯ï¼Œå…ƒæ•°æ®éªŒè¯ï¼Œå­—èŠ‚ç éªŒè¯ï¼Œç¬¦å·å¼•ç”¨éªŒè¯ã€‚


ä¸¾ä¾‹
  ä½¿ç”¨ BinaryViewerè½¯ä»¶æŸ¥çœ‹å­—èŠ‚ç æ–‡ä»¶ï¼Œå…¶å¼€å¤´å‡ä¸º CAFE BABE ï¼Œå¦‚æœå‡ºç°ä¸åˆæ³•çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œé‚£ä¹ˆå°†ä¼šéªŒè¯ä¸é€šè¿‡ã€‚
  å·¥å…·ï¼šBinary VieweræŸ¥çœ‹ï¼Œå·¥å…·ä¸‹è½½åœ°å€ï¼šBinary Viewer Page (proxoft.com)
  
  å¦‚æœå‡ºç°ä¸åˆæ³•çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œé‚£ä¹ˆå°†ä¼šéªŒè¯ä¸é€šè¿‡ï¼ŒåŒæ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡å®‰è£…IDEAçš„æ’ä»¶ï¼Œæ¥æŸ¥çœ‹æˆ‘ä»¬çš„Classæ–‡ä»¶

å®‰è£…Binary Viewer
  åŒæ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡å®‰è£…IDEAçš„æ’ä»¶ï¼Œæ¥æŸ¥çœ‹æˆ‘ä»¬çš„Classæ–‡ä»¶
  

é…ç½®æ’ä»¶å‚æ•°
  ç‚¹å‡»Helpï¼Œç‚¹å‡»Edit Custom Vm Optionsâ€¦ï¼Œå¢åŠ ä»¥ä¸‹é…ç½®åé‡å¯IDEAã€‚
  -Duser.language=en-Duser.region=CN
  å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬ç¼–è¯‘å®Œä¸€ä¸ªclassæ–‡ä»¶åï¼Œç‚¹å‡»viewå³å¯æ˜¾ç¤ºæˆ‘ä»¬å®‰è£…çš„æ’ä»¶æ¥æŸ¥çœ‹å­—èŠ‚ç æ–¹æ³•äº†
  



å‡†å¤‡(Prepare)

ä¸ºç±»å˜é‡ï¼ˆstaticå˜é‡ï¼‰åˆ†é…å†…å­˜å¹¶ä¸”è®¾ç½®è¯¥ç±»å˜é‡çš„é»˜è®¤åˆå§‹å€¼ï¼Œå³é›¶å€¼
è¿™é‡Œä¸åŒ…å«ç”¨finalä¿®é¥°çš„staticï¼Œå› ä¸ºfinalåœ¨ç¼–è¯‘çš„æ—¶å€™å°±ä¼šåˆ†é…å¥½äº†é»˜è®¤å€¼ï¼Œå‡†å¤‡é˜¶æ®µä¼šæ˜¾å¼åˆå§‹åŒ–
æ³¨æ„ï¼šè¿™é‡Œä¸ä¼šä¸ºå®ä¾‹å˜é‡åˆ†é…åˆå§‹åŒ–ï¼Œç±»å˜é‡ä¼šåˆ†é…åœ¨æ–¹æ³•åŒºä¸­ï¼Œè€Œå®ä¾‹å˜é‡æ˜¯ä¼šéšç€å¯¹è±¡ä¸€èµ·åˆ†é…åˆ°Javaå †ä¸­


ä¸¾ä¾‹

  ä»£ç ï¼šå˜é‡aåœ¨å‡†å¤‡é˜¶æ®µä¼šèµ‹åˆå§‹å€¼ï¼Œä½†ä¸æ˜¯1ï¼Œè€Œæ˜¯0ï¼Œåœ¨åˆå§‹åŒ–é˜¶æ®µä¼šè¢«èµ‹å€¼ä¸º 1
  /** * @author peppa * @create 2022-02-08 17:36:28 */public class HelloApp &#123;    private static int a = 1;  // å‡†å¤‡é˜¶æ®µä¸º0ï¼Œåœ¨ä¸‹ä¸ªé˜¶æ®µï¼Œä¹Ÿå°±æ˜¯åˆå§‹åŒ–çš„æ—¶å€™æ‰æ˜¯1    public static void main(String[] args) &#123;        System.out.println(a);    &#125;&#125;

è§£æ(Resolve)

å°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹
äº‹å®ä¸Šï¼Œè§£ææ“ä½œå¾€å¾€ä¼šä¼´éšç€JVMåœ¨æ‰§è¡Œå®Œåˆå§‹åŒ–ä¹‹åå†æ‰§è¡Œ
ç¬¦å·å¼•ç”¨å°±æ˜¯ä¸€ç»„ç¬¦å·æ¥æè¿°æ‰€å¼•ç”¨çš„ç›®æ ‡ã€‚ç¬¦å·å¼•ç”¨çš„å­—é¢é‡å½¢å¼æ˜ç¡®å®šä¹‰åœ¨ã€Šjavaè™šæ‹Ÿæœºè§„èŒƒã€‹çš„classæ–‡ä»¶æ ¼å¼ä¸­ã€‚ç›´æ¥å¼•ç”¨å°±æ˜¯ç›´æ¥æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡æˆ–ä¸€ä¸ªé—´æ¥å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„
è§£æåŠ¨ä½œä¸»è¦é’ˆå¯¹ç±»æˆ–æ¥å£ã€å­—æ®µã€ç±»æ–¹æ³•ã€æ¥å£æ–¹æ³•ã€æ–¹æ³•ç±»å‹ç­‰ã€‚å¯¹åº”å¸¸é‡æ± ä¸­çš„CONSTANT Class infoã€CONSTANT Fieldref infoã€CONSTANT Methodref infoç­‰


ç¬¦å·å¼•ç”¨

åç¼–è¯‘ class æ–‡ä»¶åå¯ä»¥æŸ¥çœ‹ç¬¦å·å¼•ç”¨ï¼Œä¸‹é¢å¸¦# çš„å°±æ˜¯ç¬¦å·å¼•ç”¨

  




7.åˆå§‹åŒ–é˜¶æ®µ
ç±»çš„åˆå§‹åŒ–æ—¶æœº

åˆ›å»ºç±»çš„å®ä¾‹
è®¿é—®æŸä¸ªç±»æˆ–æ¥å£çš„é™æ€å˜é‡ï¼Œæˆ–è€…å¯¹è¯¥é™æ€å˜é‡èµ‹å€¼
è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•
åå°„ï¼ˆæ¯”å¦‚ï¼šClass.forName(â€œcom.atguigu.Testâ€)ï¼‰
åˆå§‹åŒ–ä¸€ä¸ªç±»çš„å­ç±»
Javaè™šæ‹Ÿæœºå¯åŠ¨æ—¶è¢«æ ‡æ˜ä¸ºå¯åŠ¨ç±»çš„ç±»
JDK7å¼€å§‹æä¾›çš„åŠ¨æ€è¯­è¨€æ”¯æŒï¼šjava.lang.invoke.MethodHandleå®ä¾‹çš„è§£æç»“æœREF_getStaticã€REF putStaticã€REF_invokeStaticå¥æŸ„å¯¹åº”çš„ç±»æ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™åˆå§‹åŒ–

  é™¤äº†ä»¥ä¸Šä¸ƒç§æƒ…å†µï¼Œå…¶ä»–ä½¿ç”¨Javaç±»çš„æ–¹å¼éƒ½è¢«çœ‹ä½œæ˜¯å¯¹ç±»çš„è¢«åŠ¨ä½¿ç”¨ï¼Œéƒ½ä¸ä¼šå¯¼è‡´ç±»çš„åˆå§‹åŒ–ï¼Œå³ä¸ä¼šæ‰§è¡Œåˆå§‹åŒ–é˜¶æ®µï¼ˆä¸ä¼šè°ƒç”¨ clinit() æ–¹æ³•å’Œ init() æ–¹æ³•ï¼‰
  

æ„é€ å™¨æ–¹æ³•&lt;clinit&gt;()æ–¹æ³•

åˆå§‹åŒ–é˜¶æ®µå°±æ˜¯æ‰§è¡Œç±»æ„é€ å™¨æ–¹æ³•&lt;clinit&gt;()çš„è¿‡ç¨‹
æ­¤æ–¹æ³•ä¸éœ€å®šä¹‰ï¼Œæ˜¯javacç¼–è¯‘å™¨è‡ªåŠ¨æ”¶é›†ç±»ä¸­çš„æ‰€æœ‰ç±»å˜é‡çš„èµ‹å€¼åŠ¨ä½œå’Œé™æ€ä»£ç å—ä¸­çš„è¯­å¥åˆå¹¶è€Œæ¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬ä»£ç ä¸­åŒ…å«staticå˜é‡çš„æ—¶å€™ï¼Œå°±ä¼šæœ‰clinitæ–¹æ³•
&lt;clinit&gt;()æ–¹æ³•ä¸­çš„æŒ‡ä»¤æŒ‰è¯­å¥åœ¨æºæ–‡ä»¶ä¸­å‡ºç°çš„é¡ºåºæ‰§è¡Œ
&lt;clinit&gt;()ä¸åŒäºç±»çš„æ„é€ å™¨ã€‚ï¼ˆå…³è”ï¼šæ„é€ å™¨æ˜¯è™šæ‹Ÿæœºè§†è§’ä¸‹çš„&lt;init&gt;()ï¼‰
è‹¥è¯¥ç±»å…·æœ‰çˆ¶ç±»ï¼ŒJVMä¼šä¿è¯å­ç±»çš„&lt;clinit&gt;()æ‰§è¡Œå‰ï¼Œçˆ¶ç±»çš„&lt;clinit&gt;()å·²ç»æ‰§è¡Œå®Œæ¯•
è™šæ‹Ÿæœºå¿…é¡»ä¿è¯ä¸€ä¸ªç±»çš„&lt;clinit&gt;()æ–¹æ³•åœ¨å¤šçº¿ç¨‹ä¸‹è¢«åŒæ­¥åŠ é”


æ¡ˆä¾‹1ï¼šæœ‰staticå˜é‡
  æŸ¥çœ‹ä¸‹é¢è¿™ä¸ªä»£ç çš„å­—èŠ‚ç ï¼Œå¯ä»¥å‘ç°æœ‰ä¸€ä¸ª&lt;clinit&gt;()æ–¹æ³•ã€‚
  package com.peppa;/** * @author peppa * @create 2022-02-09 20:38:46 */public class ClassInitTest &#123;    private static int age = 1;    static &#123;        age = 2;        number = 20;        System.out.println(age);        // System.out.println(number);  //æŠ¥é”™ï¼šIllegal forward reference éæ³•çš„å‰å‘å¼•ç”¨    &#125;    /**     * 1ã€linkingä¹‹prepare: number = 0 --&gt; initial: 20 --&gt; 10     * 2ã€è¿™é‡Œå› ä¸ºé™æ€ä»£ç å—å‡ºç°åœ¨å£°æ˜å˜é‡è¯­å¥å‰é¢ï¼Œæ‰€ä»¥ä¹‹å‰è¢«å‡†å¤‡é˜¶æ®µä¸º0çš„numberå˜é‡ä¼š     * é¦–å…ˆè¢«åˆå§‹åŒ–ä¸º20ï¼Œå†æ¥ç€è¢«åˆå§‹åŒ–æˆ10ï¼ˆè¿™ä¹Ÿæ˜¯é¢è¯•æ—¶å¸¸è€ƒçš„é—®é¢˜å“¦ï¼‰     */    private static int number = 10;    public static void main(String[] args) &#123;        System.out.println(ClassInitTest.age); // 2        System.out.println(ClassInitTest.number); // 10    &#125;&#125;
  

&lt;clintå­—èŠ‚ç &gt;ï¼šå½“æˆ‘ä»¬ä»£ç ä¸­åŒ…å«staticå˜é‡çš„æ—¶å€™ï¼Œå°±ä¼šæœ‰clinitæ–¹æ³•

  0: iconst_11: putstatic     #3                   // Field age:I4: iconst_25: putstatic     #3                   // Field age:I8: bipush        20                   // å…ˆèµ‹20                    10: putstatic     #5                  // Field number:I13: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;16: getstatic     #3                  // Field age:I19: invokevirtual #4                  // Method java/io/PrintStream.println:(I)V22: bipush        10                  // å†èµ‹10       24: putstatic     #5                  // Field number:I27: return

æ¡ˆä¾‹2ï¼šæ— staticå˜é‡


package com.peppa;/** * @author peppa * @create 2022-02-09 20:38:46 */public class NonStaticClassInitTest &#123;    private int age = 1;    private int number = 10;    public static void main(String[] args) &#123;        System.out.println(&quot;this is NonStaticClassInitTest.class&quot;);    &#125;&#125;



æ¡ˆä¾‹3ï¼šå…³äºæ¶‰åŠåˆ°çˆ¶ç±»æ—¶å€™çš„å˜é‡èµ‹å€¼è¿‡ç¨‹

è‹¥è¯¥ç±»å…·æœ‰çˆ¶ç±»ï¼ŒJVMä¼šä¿è¯å­ç±»çš„&lt;clinit&gt;()æ‰§è¡Œå‰ï¼Œçˆ¶ç±»çš„&lt;clinit&gt;()å·²ç»æ‰§è¡Œå®Œæ¯•

  package com.peppa;/** * @author peppa * @create 2022-02-09 22:32:26 */public class SubClassInitTest &#123;    static class Animal &#123;        public static int A = 1;        static &#123;            A = 2;        &#125;    &#125;    static class Dog extends Animal &#123;        public static int B = A;    &#125;    public static void main(String[] args) &#123;        System.out.println(Dog.B);  // 2    &#125;&#125;
  å¦‚ä¸Šä»£ç ï¼ŒåŠ è½½æµç¨‹å¦‚ä¸‹ï¼š

é¦–å…ˆï¼Œæ‰§è¡Œ main() æ–¹æ³•éœ€è¦åŠ è½½ SubClassInitTest ç±»
è·å– Dog .B é™æ€å˜é‡ï¼Œéœ€è¦åŠ è½½ Dog ç±»
Dog ç±»çš„çˆ¶ç±»æ˜¯ Animal ç±»ï¼Œæ‰€ä»¥éœ€è¦å…ˆæ‰§è¡Œ Animal ç±»çš„åŠ è½½ï¼Œå†æ‰§è¡Œ Dog ç±»çš„åŠ è½½


æ¡ˆä¾‹4ï¼šè™šæ‹Ÿæœºå¿…é¡»ä¿è¯ä¸€ä¸ªç±»çš„&lt;clinit&gt;()æ–¹æ³•åœ¨å¤šçº¿ç¨‹ä¸‹è¢«åŒæ­¥åŠ é”
  package com.peppa;public class DeadThreadTest &#123;    public static void main(String[] args) &#123;        Runnable r = () -&gt; &#123;            System.out.println(Thread.currentThread().getName() + &quot;å¼€å§‹&quot;);            DeadThread dead = new DeadThread();            System.out.println(Thread.currentThread().getName() + &quot;ç»“æŸ&quot;);        &#125;;        Thread t1 = new Thread(r,&quot;çº¿ç¨‹1&quot;);        Thread t2 = new Thread(r,&quot;çº¿ç¨‹2&quot;);        t1.start();        t2.start();    &#125;&#125;class DeadThread&#123;    static&#123;        if(true)&#123;            System.out.println(Thread.currentThread().getName() + &quot;åˆå§‹åŒ–å½“å‰ç±»&quot;);            while(true)&#123;            &#125;        &#125;    &#125;&#125;// æ‰§è¡Œç»“æœ:	çº¿ç¨‹2å¼€å§‹	çº¿ç¨‹1å¼€å§‹	çº¿ç¨‹2åˆå§‹åŒ–å½“å‰ç±»	/**ç„¶åç¨‹åºå¡æ­»äº†**/
  ç¨‹åºå¡æ­»ï¼Œåˆ†æåŸå› ï¼š

ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å»åŠ è½½ DeadThread ç±»ï¼Œè€Œ DeadThread ç±»ä¸­é™æ€ä»£ç å—ä¸­æœ‰ä¸€å¤„æ­»å¾ªç¯
å…ˆåŠ è½½ DeadThread ç±»çš„çº¿ç¨‹æŠ¢åˆ°äº†åŒæ­¥é”ï¼Œç„¶ååœ¨ç±»çš„é™æ€ä»£ç å—ä¸­æ‰§è¡Œæ­»å¾ªç¯ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…åŒæ­¥é”çš„é‡Šæ”¾
æ‰€ä»¥æ— è®ºå“ªä¸ªçº¿ç¨‹å…ˆæ‰§è¡Œ DeadThread ç±»çš„åŠ è½½ï¼Œå¦å¤–ä¸€ä¸ªç±»ä¹Ÿä¸ä¼šç»§ç»­æ‰§è¡Œã€‚ï¼ˆä¸€ä¸ªç±»åªä¼šè¢«åŠ è½½ä¸€æ¬¡ï¼‰



]]></content>
      <categories>
        <category>JVMè™šæ‹Ÿæœºè¯¦è§£</category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>JVMè™šæ‹Ÿæœºè¯¦è§£</tag>
      </tags>
  </entry>
  <entry>
    <title>JVMè™šæ‹Ÿæœºè¯¦è§£(äº”)**ç¨‹åºè®¡æ•°å™¨(PCå¯„å­˜å™¨)PCÂ Register</title>
    <url>/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3(%E4%BA%94)%E7%A8%8B%E5%BA%8F%E8%AE%A1%E6%95%B0%E5%99%A8(PC%E5%AF%84%E5%AD%98%E5%99%A8)PC%20Register/</url>
    <content><![CDATA[JVMè™šæ‹Ÿæœºè¯¦è§£(äº”)ç¨‹åºè®¡æ•°å™¨(PCå¯„å­˜å™¨)PCÂ Register1. æ¦‚è¿°Java è™šæ‹Ÿæœºå¯ä»¥åŒæ—¶æ”¯æŒå¤šä¸ªçº¿ç¨‹çš„æ‰§è¡Œ(jls17)ã€‚æ¯ä¸ª Java è™šæ‹Ÿæœºçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ pc (ç¨‹åºè®¡æ•°å™¨)å¯„å­˜å™¨ã€‚åœ¨ä»»ä½•æ—¶å€™ï¼Œæ¯ä¸ª Java è™šæ‹Ÿæœºçº¿ç¨‹éƒ½åœ¨æ‰§è¡Œå•ä¸ªæ–¹æ³•çš„ä»£ç ï¼Œå³è¯¥çº¿ç¨‹çš„å½“å‰æ–¹æ³•(2.6)ã€‚å¦‚æœè¿™ä¸ªæ–¹æ³•ä¸æ˜¯æœ¬æœºçš„ï¼Œé‚£ä¹ˆ pc å¯„å­˜å™¨å°±ä¼šåŒ…å«å½“å‰æ­£åœ¨æ‰§è¡Œçš„ Java è™šæ‹ŸæŒ‡ä»¤çš„åœ°å€ã€‚å¦‚æœå½“å‰ç”±çº¿ç¨‹æ‰§è¡Œçš„æ–¹æ³•æ˜¯æœ¬æœºçš„ï¼Œé‚£ä¹ˆ Java è™šæ‹Ÿæœºçš„ pc å¯„å­˜å™¨çš„å€¼æ˜¯æœªå®šä¹‰çš„ã€‚Java è™šæ‹Ÿæœºçš„ pc å¯„å­˜å™¨è¶³å¤Ÿå®½ï¼Œå¯ä»¥åœ¨ç‰¹å®šå¹³å°ä¸Šä¿å­˜ returnAddress æˆ–æœ¬æœºæŒ‡é’ˆã€‚
å®˜ç½‘ï¼šThe JavaÂ® Virtual Machine Specification (oracle.com)


JVMä¸­çš„ç¨‹åºè®¡æ•°å¯„å­˜å™¨ï¼ˆProgram Counter Registerï¼‰ä¸­ï¼ŒRegisterçš„å‘½åæºäºCPUçš„å¯„å­˜å™¨ï¼Œå¯„å­˜å™¨å­˜å‚¨æŒ‡ä»¤ç›¸å…³çš„ç°åœºä¿¡æ¯ã€‚CPUåªæœ‰æŠŠæ•°æ®è£…è½½åˆ°å¯„å­˜å™¨æ‰èƒ½å¤Ÿè¿è¡Œã€‚
è¿™é‡Œï¼Œå¹¶éæ˜¯å¹¿ä¹‰ä¸Šæ‰€æŒ‡çš„ç‰©ç†å¯„å­˜å™¨ï¼Œæˆ–è®¸å°†å…¶ç¿»è¯‘ä¸ºPCè®¡æ•°å™¨ï¼ˆæˆ–æŒ‡ä»¤è®¡æ•°å™¨ï¼‰ä¼šæ›´åŠ è´´åˆ‡ï¼ˆä¹Ÿç§°ä¸ºç¨‹åºé’©å­ï¼‰ï¼Œå¹¶ä¸”ä¹Ÿä¸å®¹æ˜“å¼•èµ·ä¸€äº›ä¸å¿…è¦çš„è¯¯ä¼šã€‚JVMä¸­çš„PCå¯„å­˜å™¨æ˜¯å¯¹ç‰©ç†PCå¯„å­˜å™¨çš„ä¸€ç§æŠ½è±¡æ¨¡æ‹Ÿã€‚
å®ƒæ˜¯ä¸€å—å¾ˆå°çš„å†…å­˜ç©ºé—´ï¼Œå‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®°ã€‚ä¹Ÿæ˜¯è¿è¡Œé€Ÿåº¦æœ€å¿«çš„å­˜å‚¨åŒºåŸŸã€‚
åœ¨JVMè§„èŒƒä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å®ƒè‡ªå·±çš„ç¨‹åºè®¡æ•°å™¨ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´ã€‚
ä»»ä½•æ—¶é—´ä¸€ä¸ªçº¿ç¨‹éƒ½åªæœ‰ä¸€ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„å½“å‰æ–¹æ³•ã€‚ç¨‹åºè®¡æ•°å™¨ä¼šå­˜å‚¨å½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„Javaæ–¹æ³•çš„JVMæŒ‡ä»¤åœ°å€ï¼›æˆ–è€…ï¼Œå¦‚æœæ˜¯åœ¨æ‰§è¡Œnativeæ–¹æ³•ï¼Œåˆ™æ˜¯æœªæŒ‡å®šå€¼ï¼ˆundefnedï¼‰ã€‚
å®ƒæ˜¯ç¨‹åºæ§åˆ¶æµçš„æŒ‡ç¤ºå™¨ï¼Œåˆ†æ”¯ã€å¾ªç¯ã€è·³è½¬ã€å¼‚å¸¸å¤„ç†ã€çº¿ç¨‹æ¢å¤ç­‰åŸºç¡€åŠŸèƒ½éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªè®¡æ•°å™¨æ¥å®Œæˆã€‚
å­—èŠ‚ç è§£é‡Šå™¨å·¥ä½œæ—¶å°±æ˜¯é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥é€‰å–ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€‚
å®ƒæ˜¯å”¯ä¸€ä¸€ä¸ªåœ¨Javaè™šæ‹Ÿæœºè§„èŒƒä¸­æ²¡æœ‰è§„å®šä»»ä½•OutofMemoryErroræƒ…å†µçš„åŒºåŸŸã€‚


ä½œç”¨
  PCå¯„å­˜å™¨ç”¨æ¥å­˜å‚¨æŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œä¹Ÿå³å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤ä»£ç ã€‚ç”±æ‰§è¡Œå¼•æ“è¯»å–ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚
  
  å†…å­˜æ˜¯éå¸¸é‡è¦çš„ç³»ç»Ÿèµ„æºï¼Œæ˜¯ç¡¬ç›˜å’ŒCPUçš„ä¸­é—´ä»“åº“åŠæ¡¥æ¢ï¼Œæ‰¿è½½ç€æ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºçš„å®æ—¶è¿è¡ŒJVMå†…å­˜å¸ƒå±€è§„å®šäº†Javaåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å†…å­˜ç”³è¯·ã€åˆ†é…ã€ç®¡ç†çš„ç­–ç•¥ï¼Œä¿è¯äº†JVMçš„é«˜æ•ˆç¨³å®šè¿è¡Œã€‚ä¸åŒçš„JVMå¯¹äºå†…å­˜çš„åˆ’åˆ†æ–¹å¼å’Œç®¡ç†æœºåˆ¶å­˜åœ¨ç€éƒ¨åˆ†å·®å¼‚ã€‚ç»“åˆJVMè™šæ‹Ÿæœºè§„èŒƒï¼Œæ¥æ¢è®¨ä¸€ä¸‹ç»å…¸çš„JVMå†…å­˜å¸ƒå±€ã€‚

ä»£ç å®ç°
  package com.peppa.register;/**ç¨‹åºè®¡æ•°å™¨ * @author: peppa * @create: 2022-02-10 13:25:3 */public class PCRegisterTest &#123;    public static void main(String[] args) &#123;        int i = 10;        int j = 20;        int k = i + j;    &#125;&#125;
  ç„¶åå°†ä»£ç è¿›è¡Œç¼–è¯‘æˆå­—èŠ‚ç æ–‡ä»¶ï¼Œæˆ‘ä»¬å†æ¬¡æŸ¥çœ‹ ï¼Œå‘ç°åœ¨å­—èŠ‚ç çš„å·¦è¾¹æœ‰ä¸€ä¸ªè¡Œå·æ ‡è¯†ï¼Œå®ƒå…¶å®å°±æ˜¯æŒ‡ä»¤åœ°å€ï¼Œç”¨äºæŒ‡å‘å½“å‰æ‰§è¡Œåˆ°å“ªé‡Œã€‚
  0: bipush        102: istore_13: bipush        205: istore_26: iload_17: iload_28: iadd9: istore_310: return
  é€šè¿‡PCå¯„å­˜å™¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“å½“å‰ç¨‹åºæ‰§è¡Œåˆ°å“ªä¸€æ­¥äº†
  
  

ä½¿ç”¨PCå¯„å­˜å™¨å­˜å‚¨å­—èŠ‚ç æŒ‡ä»¤åœ°å€æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ
  å› ä¸ºCPUéœ€è¦ä¸åœçš„åˆ‡æ¢å„ä¸ªçº¿ç¨‹ï¼Œè¿™æ—¶å€™åˆ‡æ¢å›æ¥ä»¥åï¼Œå°±å¾—çŸ¥é“æ¥ç€ä»å“ªå¼€å§‹ç»§ç»­æ‰§è¡Œã€‚
  JVMçš„å­—èŠ‚ç è§£é‡Šå™¨å°±éœ€è¦é€šè¿‡æ”¹å˜PCå¯„å­˜å™¨çš„å€¼æ¥æ˜ç¡®ä¸‹ä¸€æ¡åº”è¯¥æ‰§è¡Œä»€ä¹ˆæ ·çš„å­—èŠ‚ç æŒ‡ä»¤ã€‚
  

PCå¯„å­˜å™¨ä¸ºä»€ä¹ˆè¢«è®¾å®šä¸ºç§æœ‰çš„ï¼Ÿ

æˆ‘ä»¬éƒ½çŸ¥é“æ‰€è°“çš„å¤šçº¿ç¨‹åœ¨ä¸€ä¸ªç‰¹å®šçš„æ—¶é—´æ®µå†…åªä¼šæ‰§è¡Œå…¶ä¸­æŸä¸€ä¸ªçº¿ç¨‹çš„æ–¹æ³•ï¼ŒCPUä¼šä¸åœåœ°åšä»»åŠ¡åˆ‡æ¢ï¼Œè¿™æ ·å¿…ç„¶å¯¼è‡´ç»å¸¸ä¸­æ–­æˆ–æ¢å¤ï¼Œå¦‚ä½•ä¿è¯åˆ†æ¯«æ— å·®å‘¢ï¼Ÿä¸ºäº†èƒ½å¤Ÿå‡†ç¡®åœ°è®°å½•å„ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„å½“å‰å­—èŠ‚ç æŒ‡ä»¤åœ°å€ï¼Œæœ€å¥½çš„åŠæ³•è‡ªç„¶æ˜¯ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½åˆ†é…ä¸€ä¸ªPCå¯„å­˜å™¨ï¼Œè¿™æ ·ä¸€æ¥å„ä¸ªçº¿ç¨‹ä¹‹é—´ä¾¿å¯ä»¥è¿›è¡Œç‹¬ç«‹è®¡ç®—ï¼Œä»è€Œä¸ä¼šå‡ºç°ç›¸äº’å¹²æ‰°çš„æƒ…å†µã€‚
ç”±äºCPUæ—¶é—´ç‰‡è½®é™åˆ¶ï¼Œä¼—å¤šçº¿ç¨‹åœ¨å¹¶å‘æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä»»ä½•ä¸€ä¸ªç¡®å®šçš„æ—¶åˆ»ï¼Œä¸€ä¸ªå¤„ç†å™¨æˆ–è€…å¤šæ ¸å¤„ç†å™¨ä¸­çš„ä¸€ä¸ªå†…æ ¸ï¼Œåªä¼šæ‰§è¡ŒæŸä¸ªçº¿ç¨‹ä¸­çš„ä¸€æ¡æŒ‡ä»¤ã€‚
è¿™æ ·å¿…ç„¶å¯¼è‡´ç»å¸¸ä¸­æ–­æˆ–æ¢å¤ï¼Œå¦‚ä½•ä¿è¯åˆ†æ¯«æ— å·®å‘¢ï¼Ÿæ¯ä¸ªçº¿ç¨‹åœ¨åˆ›å»ºåï¼Œéƒ½ä¼šäº§ç”Ÿè‡ªå·±çš„ç¨‹åºè®¡æ•°å™¨å’Œæ ˆå¸§ï¼Œç¨‹åºè®¡æ•°å™¨åœ¨å„ä¸ªçº¿ç¨‹ä¹‹é—´äº’ä¸å½±å“ã€‚



2.CPU æ—¶é—´ç‰‡
CPUæ—¶é—´ç‰‡å³CPUåˆ†é…ç»™å„ä¸ªç¨‹åºçš„æ—¶é—´ï¼Œæ¯ä¸ªçº¿ç¨‹è¢«åˆ†é…ä¸€ä¸ªæ—¶é—´æ®µï¼Œç§°ä½œå®ƒçš„æ—¶é—´ç‰‡ã€‚
åœ¨å®è§‚ä¸Šï¼šæˆ‘ä»¬å¯ä»¥åŒæ—¶æ‰“å¼€å¤šä¸ªåº”ç”¨ç¨‹åºï¼Œæ¯ä¸ªç¨‹åºå¹¶è¡Œä¸æ‚–ï¼ŒåŒæ—¶è¿è¡Œã€‚
ä½†åœ¨å¾®è§‚ä¸Šï¼šç”±äºåªæœ‰ä¸€ä¸ªCPUï¼Œä¸€æ¬¡åªèƒ½å¤„ç†ç¨‹åºè¦æ±‚çš„ä¸€éƒ¨åˆ†ï¼Œå¦‚ä½•å¤„ç†å…¬å¹³ï¼Œä¸€ç§æ–¹æ³•å°±æ˜¯å¼•å…¥æ—¶é—´ç‰‡ï¼Œæ¯ä¸ªç¨‹åºè½®æµæ‰§è¡Œã€‚


]]></content>
      <categories>
        <category>JVMè™šæ‹Ÿæœºè¯¦è§£</category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>JVMè™šæ‹Ÿæœºè¯¦è§£</tag>
      </tags>
  </entry>
  <entry>
    <title>JVMè™šæ‹Ÿæœºè¯¦è§£(å…«)å †Heap</title>
    <url>/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3(%E5%85%AB)%E5%A0%86Heap/</url>
    <content><![CDATA[JVMè™šæ‹Ÿæœºè¯¦è§£(å…«)å †Heap1. æ¦‚è¿°
æ¦‚è¿°
Java è™šæ‹Ÿæœºæœ‰ä¸€ä¸ªå †ï¼Œå®ƒåœ¨æ‰€æœ‰ Java è™šæ‹Ÿæœºçº¿ç¨‹ä¹‹é—´å…±äº«ã€‚å †æ˜¯è¿è¡Œæ—¶æ•°æ®åŒºåŸŸï¼Œä»ä¸­åˆ†é…æ‰€æœ‰ç±»å®ä¾‹å’Œæ•°ç»„çš„å†…å­˜ã€‚
åœ¨è™šæ‹Ÿæœºå¯åŠ¨æ—¶åˆ›å»ºå †ã€‚å¯¹è±¡çš„å †å­˜å‚¨ç”±è‡ªåŠ¨å­˜å‚¨ç®¡ç†ç³»ç»Ÿ(ç§°ä¸ºåƒåœ¾æ”¶é›†å™¨)å›æ”¶; å¯¹è±¡æ°¸è¿œä¸ä¼šæ˜¾å¼é‡Šæ”¾ã€‚Java è™šæ‹Ÿæœºæ²¡æœ‰ç‰¹å®šç±»å‹çš„è‡ªåŠ¨å­˜å‚¨ç®¡ç†ç³»ç»Ÿï¼Œå¯ä»¥æ ¹æ®å®ç°è€…çš„ç³»ç»Ÿéœ€æ±‚é€‰æ‹©å­˜å‚¨ç®¡ç†æŠ€æœ¯ã€‚å †çš„å¤§å°å¯ä»¥æ˜¯å›ºå®šçš„ï¼Œä¹Ÿå¯ä»¥æ ¹æ®è®¡ç®—çš„éœ€è¦è¿›è¡Œæ‰©å±•ï¼Œå¦‚æœä¸éœ€è¦æ›´å¤§çš„å †ï¼Œè¿˜å¯ä»¥è¿›è¡Œæ”¶ç¼©ã€‚å †çš„å†…å­˜ä¸éœ€è¦æ˜¯è¿ç»­çš„ã€‚
ä¸€ä¸ª Java è™šæ‹Ÿæœºå®ç°å¯ä»¥æä¾›ç¨‹åºå‘˜æˆ–ç”¨æˆ·å¯¹å †çš„åˆå§‹å¤§å°çš„æ§åˆ¶ï¼Œä»¥åŠï¼Œå¦‚æœå †å¯ä»¥åŠ¨æ€æ‰©å±•æˆ–æ”¶ç¼©ï¼Œå¯¹å †çš„æœ€å¤§å’Œæœ€å°å¤§å°çš„æ§åˆ¶ã€‚
æ‰€æœ‰çš„çº¿ç¨‹å…±äº«Javaå †ï¼Œåœ¨è¿™é‡Œè¿˜å¯ä»¥åˆ’åˆ†çº¿ç¨‹ç§æœ‰çš„ç¼“å†²åŒºï¼ˆThread Local Allocation Bufferï¼ŒTLABï¼‰ã€‚
ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­å¯¹Javaå †çš„æè¿°æ˜¯ï¼šæ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ä»¥åŠæ•°ç»„éƒ½åº”å½“åœ¨è¿è¡Œæ—¶åˆ†é…åœ¨å †ä¸Šã€‚ï¼ˆThe heap is the run-time data area from which memory for all class instances and arrays is allocatedï¼‰â€¢ ä»å®é™…ä½¿ç”¨è§’åº¦çœ‹ï¼šâ€œå‡ ä¹â€æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½åœ¨å †åˆ†é…å†…å­˜ï¼Œä½†å¹¶éå…¨éƒ¨ã€‚å› ä¸ºè¿˜æœ‰ä¸€äº›å¯¹è±¡æ˜¯åœ¨æ ˆä¸Šåˆ†é…çš„ï¼ˆé€ƒé€¸åˆ†æï¼Œæ ‡é‡æ›¿æ¢ï¼‰
æ•°ç»„å’Œå¯¹è±¡å¯èƒ½æ°¸è¿œä¸ä¼šå­˜å‚¨åœ¨æ ˆä¸Šï¼ˆä¸ä¸€å®šï¼‰ï¼Œå› ä¸ºæ ˆå¸§ä¸­ä¿å­˜å¼•ç”¨ï¼Œè¿™ä¸ªå¼•ç”¨æŒ‡å‘å¯¹è±¡æˆ–è€…æ•°ç»„åœ¨å †ä¸­çš„ä½ç½®ã€‚
åœ¨æ–¹æ³•ç»“æŸåï¼Œå †ä¸­çš„å¯¹è±¡ä¸ä¼šé©¬ä¸Šè¢«ç§»é™¤ï¼Œä»…ä»…åœ¨åƒåœ¾æ”¶é›†çš„æ—¶å€™æ‰ä¼šè¢«ç§»é™¤ã€‚
ä¹Ÿå°±æ˜¯è§¦å‘äº†GCçš„æ—¶å€™ï¼Œæ‰ä¼šè¿›è¡Œå›æ”¶
å¦‚æœå †ä¸­å¯¹è±¡é©¬ä¸Šè¢«å›æ”¶ï¼Œé‚£ä¹ˆç”¨æˆ·çº¿ç¨‹å°±ä¼šæ”¶åˆ°å½±å“ï¼Œå› ä¸ºæœ‰stop the word


å †ï¼Œæ˜¯GCï¼ˆGarbage Collectionï¼Œåƒåœ¾æ”¶é›†å™¨ï¼‰æ‰§è¡Œåƒåœ¾å›æ”¶çš„é‡ç‚¹åŒºåŸŸã€‚


ä¸‹åˆ—å¼‚å¸¸æƒ…å†µä¸å †ç›¸å…³è”:
å¦‚æœè®¡ç®—éœ€è¦æ¯”è‡ªåŠ¨å­˜å‚¨ç®¡ç†ç³»ç»Ÿæ‰€èƒ½æä¾›çš„æ›´å¤šçš„å †ï¼Œé‚£ä¹ˆ Java è™šæ‹Ÿæœºå°†æŠ›å‡º OutOfMemoryError é”™è¯¯ã€‚


é»˜è®¤å †å¤§å°ï¼š
Xmsï¼šåˆå§‹å¤§å°å†…å­˜ï¼Œé»˜è®¤ä¸ºç‰©ç†å†…å­˜64&#x2F;1ï¼Œç­‰ä»·äº-XX:InitialHeapSize
Xmxï¼šæœ€å¤§åˆ†é…å†…å­˜ï¼Œé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„4&#x2F;1ï¼Œç­‰ä»·äºï¼š-XXMaxHeapSize



å®˜ç½‘ï¼šChapterÂ 2.Â The Structure of the Java Virtual Machine (oracle.com)



å †å†…å­˜ç»†åˆ†
  ç°ä»£åƒåœ¾æ”¶é›†å™¨å¤§éƒ¨åˆ†éƒ½åŸºäºåˆ†ä»£æ”¶é›†ç†è®ºè®¾è®¡ï¼Œå †ç©ºé—´ç»†åˆ†ä¸ºï¼š

Java7 åŠä¹‹å‰å †å†…å­˜é€»è¾‘ä¸Šåˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šæ–°ç”Ÿä»£+è€å¹´ä»£+æ°¸ä¹…åŒº
Young Generation Space æ–°ç”Ÿä»£ Young&#x2F;New
åˆè¢«åˆ’åˆ†ä¸ºEdenåŒºå’ŒSurvivoråŒº


Old generation space è€å¹´ä»£ Old&#x2F;Tenure
Permanent Space æ°¸ä¹…åŒº Perm


Java 8åŠä¹‹åå †å†…å­˜é€»è¾‘ä¸Šåˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šæ–°ç”Ÿä»£+è€å¹´ä»£+å…ƒç©ºé—´


Young Generation Space æ–°ç”Ÿä»£ï¼Œåˆè¢«åˆ’åˆ†ä¸ºEdenåŒºå’ŒSurvivoråŒº
Old generation space è€å¹´ä»£
Meta Space å…ƒç©ºé—´ Meta

  


å †ç©ºé—´å†…éƒ¨ç»“æ„ï¼ŒJDK1.8ä¹‹å‰ä»æ°¸ä¹…ä»£ æ›¿æ¢æˆ å…ƒç©ºé—´

2.JVisualVMå¯è§†åŒ–æŸ¥çœ‹å †å†…å­˜è¿è¡Œä»£ç 
package com.peppa.heap;import java.util.concurrent.TimeUnit;public class HeapDemo &#123;    public static void main(String[] args) throws InterruptedException &#123;        System.out.println(&quot;start...&quot;);        TimeUnit.MINUTES.sleep(30);        System.out.println(&quot;end...&quot;);    &#125;&#125;

1ã€åŒå‡»jdkç›®å½•ä¸‹çš„è¿™ä¸ªæ–‡ä»¶

2ã€å·¥å…· -&gt; æ’ä»¶ -&gt; å®‰è£…Visual GCæ’ä»¶

3ã€è¿è¡Œä¸Šé¢çš„ä»£ç 
3.è®¾ç½®å †å†…å­˜å¤§å°ä¸OOM
è®¾ç½®å †å†…å­˜

Javaå †åŒºç”¨äºå­˜å‚¨Javaå¯¹è±¡å®ä¾‹ï¼Œé‚£ä¹ˆå †çš„å¤§å°åœ¨JVMå¯åŠ¨æ—¶å°±å·²ç»è®¾å®šå¥½äº†ï¼Œå¤§å®¶å¯ä»¥é€šè¿‡é€‰é¡¹â€-Xmsâ€å’Œâ€-Xmxâ€æ¥è¿›è¡Œè®¾ç½®ã€‚

Xmsç”¨äºè¡¨ç¤ºå †åŒºçš„èµ·å§‹å†…å­˜ï¼Œç­‰ä»·äº**-XX:InitialHeapSize**
Xmxåˆ™ç”¨äºè¡¨ç¤ºå †åŒºçš„æœ€å¤§å†…å­˜ï¼Œç­‰ä»·äº**-XX:MaxHeapSize**


ä¸€æ—¦å †åŒºä¸­çš„å†…å­˜å¤§å°è¶…è¿‡â€œ-Xmxâ€æ‰€æŒ‡å®šçš„æœ€å¤§å†…å­˜æ—¶ï¼Œå°†ä¼šæŠ›å‡ºOutofMemoryErrorå¼‚å¸¸ã€‚

é€šå¸¸ä¼šå°†-Xmså’Œ-Xmxä¸¤ä¸ªå‚æ•°é…ç½®ç›¸åŒçš„å€¼ï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨avaåƒåœ¾å›æ”¶æœºåˆ¶æ¸…ç†å®Œå †åŒºåä¸éœ€è¦é‡æ–°åˆ†éš”è®¡ç®—å †åŒºçš„å¤§å°ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚

åŸå› ï¼šå‡è®¾ä¸¤ä¸ªä¸ä¸€æ ·ï¼Œåˆå§‹å†…å­˜å°ï¼Œæœ€å¤§å†…å­˜å¤§ã€‚åœ¨è¿è¡ŒæœŸé—´å¦‚æœå †å†…å­˜ä¸å¤Ÿç”¨äº†ï¼Œä¼šä¸€ç›´æ‰©å®¹ç›´åˆ°æœ€å¤§å†…å­˜ã€‚å¦‚æœå†…å­˜å¤Ÿç”¨ä¸”å¤šäº†ï¼Œä¹Ÿä¼šä¸æ–­çš„ç¼©å®¹é‡Šæ”¾ã€‚é¢‘ç¹çš„æ‰©å®¹å’Œé‡Šæ”¾é€ æˆä¸å¿…è¦çš„å‹åŠ›ï¼Œé¿å…åœ¨GCä¹‹åè°ƒæ•´å †å†…å­˜ç»™æœåŠ¡å™¨å¸¦æ¥å‹åŠ›ã€‚
å¦‚æœä¸¤ä¸ªè®¾ç½®ä¸€æ ·çš„å°±å°‘äº†é¢‘ç¹æ‰©å®¹å’Œç¼©å®¹çš„æ­¥éª¤ã€‚å†…å­˜ä¸å¤Ÿäº†å°±ç›´æ¥æŠ¥OOM


é»˜è®¤æƒ…å†µä¸‹:

åˆå§‹å†…å­˜å¤§å°ï¼šç‰©ç†ç”µè„‘å†…å­˜å¤§å°&#x2F;64
æœ€å¤§å†…å­˜å¤§å°ï¼šç‰©ç†ç”µè„‘å†…å­˜å¤§å°&#x2F;4

 package com.peppa.heap;/** * -Xms ç”¨æ¥è®¾ç½®å †ç©ºé—´ï¼ˆå¹´è½»ä»£+è€å¹´ä»£ï¼‰çš„åˆå§‹å†…å­˜å¤§å° *  -Xï¼šæ˜¯jvmè¿è¡Œå‚æ•° *  msï¼šmemory start * -Xmxï¼šç”¨æ¥è®¾ç½®å †ç©ºé—´ï¼ˆå¹´è½»ä»£+è€å¹´ä»£ï¼‰çš„æœ€å¤§å†…å­˜å¤§å° * @author peppa * @create 2022-02-11 14:33:20 */public class HeapSpaceInitial &#123;    public static void main(String[] args) &#123;        // è¿”å›Javaè™šæ‹Ÿæœºä¸­çš„å †å†…å­˜æ€»é‡        long initialMemory = Runtime.getRuntime().totalMemory() / 1024 / 1024;        // è¿”å›Javaè™šæ‹Ÿæœºè¯•å›¾ä½¿ç”¨çš„æœ€å¤§å †å†…å­˜        long maxMemory = Runtime.getRuntime().maxMemory() / 1024 / 1024;        System.out.println(&quot;-Xms:&quot; + initialMemory + &quot;M&quot;);        System.out.println(&quot;-Xmx:&quot; + maxMemory + &quot;M&quot;);    &#125;&#125;// è¾“å‡ºç»“æœ-Xms:303M-Xmx:4482M


å¦‚ä½•æŸ¥çœ‹å †å†…å­˜çš„å†…å­˜åˆ†é…æƒ…å†µ

jps  -&gt;  staat -gc  è¿›ç¨‹id
  å‚æ•°è¯´æ˜ï¼š

SOC: S0åŒºæ€»å…±å®¹é‡
S1C: S1åŒºæ€»å…±å®¹é‡
S0U: S0åŒºä½¿ç”¨çš„é‡
S1U: S1åŒºä½¿ç”¨çš„é‡
EC: ä¼Šç”¸å›­åŒºæ€»å…±å®¹é‡
EU: ä¼Šç”¸å›­åŒºä½¿ç”¨çš„é‡
OC: è€å¹´ä»£æ€»å…±å®¹é‡
OU: è€å¹´ä»£ä½¿ç”¨çš„é‡

  
  -XX:+PrintGCDetails
  



OutOfMemoryæµ‹è¯•


æ·»åŠ å‚æ•°ï¼šXms600m -Xmx600m -XX:+PrintGCDetails
package com.peppa.heap;import java.util.ArrayList;import java.util.List;public class OutOfMemoryTest &#123;    public static void main(String[] args) &#123;        List&lt;byte[]&gt; list = new ArrayList&lt;&gt;();        while (true)&#123;            list.add(new byte[1024*1024]);        &#125;    &#125;&#125;

 æ‰§è¡Œç»“æœï¼š
D:\software\Java\jdk1.8\jdk1.8.0_241\bin\java.exe -Xms600m -Xmx600m -XX:+PrintGCDetails &quot;-javaagent:D:\Program Files\JetBrains\IntelliJ IDEA 2021.3.1\lib\idea_rt.jar=4979:D:\Program Files\JetBrains\IntelliJ IDEA 2021.3.1\bin&quot; -Dfile.encoding=UTF-8 -classpath D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\charsets.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\deploy.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\ext\access-bridge-64.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\ext\cldrdata.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\ext\dnsns.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\ext\jaccess.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\ext\jfxrt.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\ext\localedata.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\ext\nashorn.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\ext\sunec.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\ext\sunjce_provider.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\ext\sunmscapi.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\ext\sunpkcs11.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\ext\zipfs.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\javaws.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\jce.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\jfr.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\jfxswt.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\jsse.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\management-agent.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\plugin.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\resources.jar;D:\software\Java\jdk1.8\jdk1.8.0_241\jre\lib\rt.jar;E:\workspace\IdeaWork\other\peppa-platform\peppa-jvm\target\classes com.peppa.heap.OutOfMemoryTest[GC (Allocation Failure) [PSYoungGen: 152578K-&gt;25384K(179200K)] 152578K-&gt;145202K(588800K), 0.0190912 secs] [Times: user=0.05 sys=0.08, real=0.02 secs] [GC (Allocation Failure) [PSYoungGen: 178893K-&gt;25336K(179200K)] 298711K-&gt;297740K(588800K), 0.0233429 secs] [Times: user=0.05 sys=0.06, real=0.02 secs] [Full GC (Ergonomics) [PSYoungGen: 25336K-&gt;0K(179200K)] [ParOldGen: 272404K-&gt;297589K(409600K)] 297740K-&gt;297589K(588800K), [Metaspace: 3229K-&gt;3229K(1056768K)], 0.0556161 secs] [Times: user=0.28 sys=0.00, real=0.05 secs] [Full GC (Ergonomics) [PSYoungGen: 153530K-&gt;37888K(179200K)] [ParOldGen: 297589K-&gt;409208K(409600K)] 451120K-&gt;447096K(588800K), [Metaspace: 3229K-&gt;3229K(1056768K)], 0.0254560 secs] [Times: user=0.06 sys=0.05, real=0.03 secs] [Full GC (Ergonomics) [PSYoungGen: 153506K-&gt;152578K(179200K)] [ParOldGen: 409208K-&gt;409208K(409600K)] 562714K-&gt;561786K(588800K), [Metaspace: 3229K-&gt;3229K(1056768K)], 0.0175328 secs] [Times: user=0.11 sys=0.00, real=0.02 secs] [Full GC (Allocation Failure) [PSYoungGen: 152578K-&gt;152578K(179200K)] [ParOldGen: 409208K-&gt;409190K(409600K)] 561786K-&gt;561768K(588800K), [Metaspace: 3229K-&gt;3229K(1056768K)], 0.0235650 secs] [Times: user=0.11 sys=0.00, real=0.02 secs] Heap PSYoungGen      total 179200K, used 153600K [0x00000000f3800000, 0x0000000100000000, 0x0000000100000000)  eden space 153600K, 100% used [0x00000000f3800000,0x00000000fce00000,0x00000000fce00000)  from space 25600K, 0% used [0x00000000fe700000,0x00000000fe700000,0x0000000100000000)  to   space 25600K, 0% used [0x00000000fce00000,0x00000000fce00000,0x00000000fe700000) ParOldGen       total 409600K, used 409194K [0x00000000da800000, 0x00000000f3800000, 0x00000000f3800000)  object space 409600K, 99% used [0x00000000da800000,0x00000000f379abf0,0x00000000f3800000) Metaspace       used 3260K, capacity 4496K, committed 4864K, reserved 1056768K  class space    used 353K, capacity 388K, committed 512K, reserved 1048576KException in thread &quot;main&quot; java.lang.OutOfMemoryError: **Java heap space**	at com.peppa.heap.OutOfMemoryTest.main(OutOfMemoryTest.java:10)

4.å¹´è½»ä»£ä¸è€å¹´ä»£
å­˜å‚¨å¯¹è±¡åˆ’åˆ†ï¼š

å­˜å‚¨åœ¨JVMä¸­çš„Javaå¯¹è±¡å¯ä»¥è¢«åˆ’åˆ†ä¸ºä¸¤ç±»ï¼š
ä¸€ç±»æ˜¯ç”Ÿå‘½å‘¨æœŸè¾ƒçŸ­çš„ç¬æ—¶å¯¹è±¡ï¼Œè¿™ç±»å¯¹è±¡çš„åˆ›å»ºå’Œæ¶ˆäº¡éƒ½éå¸¸è¿…é€Ÿï¼Œç”Ÿå‘½å‘¨æœŸçŸ­çš„ï¼ŒåŠæ—¶å›æ”¶å³å¯ã€‚
å¦å¤–ä¸€ç±»å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå´éå¸¸é•¿ï¼Œåœ¨æŸäº›æç«¯çš„æƒ…å†µä¸‹è¿˜èƒ½å¤Ÿä¸JVMçš„ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´


Javaå †åŒºè¿›ä¸€æ­¥ç»†åˆ†çš„è¯ï¼Œå¯ä»¥åˆ’åˆ†ä¸ºå¹´è½»ä»£ï¼ˆYoungGenï¼‰å’Œè€å¹´ä»£ï¼ˆoldGenï¼‰
å…¶ä¸­å¹´è½»ä»£åˆå¯ä»¥åˆ’åˆ†ä¸ºEdenç©ºé—´ã€Survivor0ç©ºé—´å’ŒSurvivor1ç©ºé—´ï¼ˆæœ‰æ—¶ä¹Ÿå«åšfromåŒºã€toåŒºï¼‰

  
  ä¸‹é¢è¿™å‚æ•°å¼€å‘ä¸­ä¸€èˆ¬ä¸ä¼šè°ƒï¼š
  

é…ç½®æ–°ç”Ÿä»£ä¸è€å¹´ä»£åœ¨å †ç»“æ„çš„å æ¯”
é»˜è®¤**-XX:NewRatio**&#x3D;2ï¼Œè¡¨ç¤ºæ–°ç”Ÿä»£å 1ï¼Œè€å¹´ä»£å 2ï¼Œæ–°ç”Ÿä»£å æ•´ä¸ªå †çš„1&#x2F;3
å¯ä»¥ä¿®æ”¹**-XX:NewRatio**&#x3D;4ï¼Œè¡¨ç¤ºæ–°ç”Ÿä»£å 1ï¼Œè€å¹´ä»£å 4ï¼Œæ–°ç”Ÿä»£å æ•´ä¸ªå †çš„1&#x2F;5




åœ¨HotSpotä¸­ï¼ŒEdenç©ºé—´å’Œå¦å¤–ä¸¤ä¸ªsurvivorç©ºé—´ç¼ºçœæ‰€å çš„æ¯”ä¾‹æ˜¯8 : 1 : 1ï¼Œ
å½“ç„¶å¼€å‘äººå‘˜å¯ä»¥é€šè¿‡é€‰é¡¹**-XX:SurvivorRatio**è°ƒæ•´è¿™ä¸ªç©ºé—´æ¯”ä¾‹ã€‚æ¯”å¦‚-XX:SurvivorRatio&#x3D;8
å‡ ä¹æ‰€æœ‰çš„Javaå¯¹è±¡éƒ½æ˜¯åœ¨EdenåŒºè¢«newå‡ºæ¥çš„ã€‚
ç»å¤§éƒ¨åˆ†çš„Javaå¯¹è±¡çš„é”€æ¯éƒ½åœ¨æ–°ç”Ÿä»£è¿›è¡Œäº†ï¼ˆæœ‰äº›å¤§çš„å¯¹è±¡åœ¨EdenåŒºæ— æ³•å­˜å‚¨æ—¶å€™ï¼Œå°†ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼‰ï¼ŒIBMå…¬å¸çš„ä¸“é—¨ç ”ç©¶è¡¨æ˜ï¼Œæ–°ç”Ÿä»£ä¸­80%çš„å¯¹è±¡éƒ½æ˜¯â€œæœç”Ÿå¤•æ­»â€çš„ã€‚
å¯ä»¥ä½¿ç”¨é€‰é¡¹â€-Xmnâ€è®¾ç½®æ–°ç”Ÿä»£æœ€å¤§å†…å­˜å¤§å°ï¼Œä½†è¿™ä¸ªå‚æ•°ä¸€èˆ¬ä½¿ç”¨é»˜è®¤å€¼å°±å¯ä»¥äº†ã€‚

  


5.å›¾è§£å¯¹è±¡åˆ†é…è¿‡ç¨‹
æ¦‚å¿µ
  ä¸ºæ–°å¯¹è±¡åˆ†é…å†…å­˜æ˜¯ä¸€ä»¶éå¸¸ä¸¥è°¨å’Œå¤æ‚çš„ä»»åŠ¡ï¼ŒJMçš„è®¾è®¡è€…ä»¬ä¸ä»…éœ€è¦è€ƒè™‘å†…å­˜å¦‚ä½•åˆ†é…ã€åœ¨å“ªé‡Œåˆ†é…ç­‰é—®é¢˜ï¼Œå¹¶ä¸”ç”±äºå†…å­˜åˆ†é…ç®—æ³•ä¸å†…å­˜å›æ”¶ç®—æ³•å¯†åˆ‡ç›¸å…³ï¼Œæ‰€ä»¥è¿˜éœ€è¦è€ƒè™‘GCæ‰§è¡Œå®Œå†…å­˜å›æ”¶åæ˜¯å¦ä¼šåœ¨å†…å­˜ç©ºé—´ä¸­äº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚

newçš„å¯¹è±¡å…ˆæ”¾ä¼Šç”¸å›­åŒºã€‚æ­¤åŒºæœ‰å¤§å°é™åˆ¶ã€‚
å½“ä¼Šç”¸å›­çš„ç©ºé—´å¡«æ»¡æ—¶ï¼Œç¨‹åºåˆéœ€è¦åˆ›å»ºå¯¹è±¡ï¼ŒJVMçš„åƒåœ¾å›æ”¶å™¨å°†å¯¹ä¼Šç”¸å›­åŒºè¿›è¡Œåƒåœ¾å›æ”¶ï¼ˆMinorGCï¼‰ï¼Œå°†ä¼Šç”¸å›­åŒºä¸­çš„ä¸å†è¢«å…¶ä»–å¯¹è±¡æ‰€å¼•ç”¨çš„å¯¹è±¡è¿›è¡Œé”€æ¯ã€‚å†åŠ è½½æ–°çš„å¯¹è±¡æ”¾åˆ°ä¼Šç”¸å›­åŒº
ç„¶åå°†ä¼Šç”¸å›­ä¸­çš„å‰©ä½™å¯¹è±¡ç§»åŠ¨åˆ°å¹¸å­˜è€…0åŒºã€‚
å¦‚æœå†æ¬¡è§¦å‘åƒåœ¾å›æ”¶ï¼Œæ­¤æ—¶ä¸Šæ¬¡å¹¸å­˜ä¸‹æ¥çš„æ”¾åˆ°å¹¸å­˜è€…0åŒºçš„ï¼Œå¦‚æœæ²¡æœ‰å›æ”¶ï¼Œå°±ä¼šæ”¾åˆ°å¹¸å­˜è€…1åŒºã€‚
å¦‚æœå†æ¬¡ç»å†åƒåœ¾å›æ”¶ï¼Œæ­¤æ—¶ä¼šé‡æ–°æ”¾å›å¹¸å­˜è€…0åŒºï¼Œæ¥ç€å†å»å¹¸å­˜è€…1åŒºã€‚
å•¥æ—¶å€™èƒ½å»å…»è€åŒºå‘¢ï¼Ÿå¯ä»¥è®¾ç½®æ¬¡æ•°ã€‚é»˜è®¤æ˜¯15æ¬¡ã€‚
åœ¨å…»è€åŒºï¼Œç›¸å¯¹æ‚ é—²ã€‚å½“å…»è€åŒºå†…å­˜ä¸è¶³æ—¶ï¼Œå†æ¬¡è§¦å‘GCï¼šMajor GCï¼Œè¿›è¡Œå…»è€åŒºçš„å†…å­˜æ¸…ç†
è‹¥å…»è€åŒºæ‰§è¡Œäº†Major GCä¹‹åï¼Œå‘ç°ä¾ç„¶æ— æ³•è¿›è¡Œå¯¹è±¡çš„ä¿å­˜ï¼Œå°±ä¼šäº§ç”ŸOOMå¼‚å¸¸ã€‚

  å¯ä»¥è®¾ç½®å‚æ•°ï¼š-Xx:MaxTenuringThreshold&#x3D; Nè¿›è¡Œè®¾ç½®
  

å›¾è§£è¿‡ç¨‹
  æˆ‘ä»¬åˆ›å»ºçš„å¯¹è±¡ï¼Œä¸€èˆ¬éƒ½æ˜¯å­˜æ”¾åœ¨EdenåŒºçš„ï¼Œå½“æˆ‘ä»¬EdenåŒºæ»¡äº†åï¼Œå°±ä¼šè§¦å‘GCæ“ä½œï¼Œä¸€èˆ¬è¢«ç§°ä¸º YGC &#x2F; Minor GCæ“ä½œ
  
  å½“æˆ‘ä»¬è¿›è¡Œä¸€æ¬¡åƒåœ¾æ”¶é›†åï¼Œçº¢è‰²çš„å°†ä¼šè¢«å›æ”¶ï¼Œè€Œç»¿è‰²çš„è¿˜ä¼šè¢«å ç”¨ç€ï¼Œå­˜æ”¾åœ¨S0(Survivor From)åŒºã€‚åŒæ—¶æˆ‘ä»¬ç»™æ¯ä¸ªå¯¹è±¡è®¾ç½®äº†ä¸€ä¸ªå¹´é¾„è®¡æ•°å™¨ï¼Œä¸€æ¬¡å›æ”¶åå°±æ˜¯1ã€‚
  åŒæ—¶EdenåŒºç»§ç»­å­˜æ”¾å¯¹è±¡ï¼Œå½“EdenåŒºå†æ¬¡å­˜æ»¡çš„æ—¶å€™ï¼Œåˆä¼šè§¦å‘ä¸€ä¸ªMinorGCæ“ä½œï¼Œæ­¤æ—¶GCå°†ä¼šæŠŠ Edenå’ŒSurvivor Fromä¸­çš„å¯¹è±¡ è¿›è¡Œä¸€æ¬¡æ”¶é›†ï¼ŒæŠŠå­˜æ´»çš„å¯¹è±¡æ”¾åˆ° Survivor ToåŒºï¼ŒåŒæ—¶è®©å¹´é¾„ + 1
  
  æˆ‘ä»¬ç»§ç»­ä¸æ–­çš„è¿›è¡Œå¯¹è±¡ç”Ÿæˆ å’Œ åƒåœ¾å›æ”¶ï¼Œå½“Survivorä¸­çš„å¯¹è±¡çš„å¹´é¾„è¾¾åˆ°15çš„æ—¶å€™ï¼Œå°†ä¼šè§¦å‘ä¸€æ¬¡ Promotionæ™‹å‡çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯å°†å¹´è½»ä»£ä¸­çš„å¯¹è±¡ æ™‹å‡åˆ° è€å¹´ä»£ä¸­
  

å¹¸å­˜åŒºåŒºæ»¡äº†åï¼Ÿ
  ç‰¹åˆ«æ³¨æ„ï¼Œåœ¨EdenåŒºæ»¡äº†çš„æ—¶å€™ï¼Œæ‰ä¼šè§¦å‘MinorGCï¼Œè€Œå¹¸å­˜è€…åŒºæ»¡äº†åï¼Œä¸ä¼šè§¦å‘MinorGCæ“ä½œ
  å¦‚æœSurvivoråŒºæ»¡äº†åï¼Œå°†ä¼šè§¦å‘ä¸€äº›ç‰¹æ®Šçš„è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯å¯èƒ½ç›´æ¥æ™‹å‡è€å¹´ä»£

å¯¹è±¡åˆ†é…çš„ç‰¹æ®Šæƒ…å†µ

å¦‚æœæ¥äº†ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œå…ˆçœ‹çœ‹ Eden æ˜¯å¦æ”¾çš„ä¸‹ï¼Ÿ
å¦‚æœ Eden æ”¾å¾—ä¸‹ï¼Œåˆ™ç›´æ¥æ”¾åˆ° Eden åŒº
å¦‚æœ Eden æ”¾ä¸ä¸‹ï¼Œåˆ™è§¦å‘ YGC ï¼Œæ‰§è¡Œåƒåœ¾å›æ”¶ï¼Œçœ‹çœ‹è¿˜èƒ½ä¸èƒ½æ”¾ä¸‹ï¼Ÿ


å°†å¯¹è±¡æ”¾åˆ°è€å¹´åŒºåˆæœ‰ä¸¤ç§æƒ…å†µï¼š
å¦‚æœ Eden æ‰§è¡Œäº† YGC è¿˜æ˜¯æ— æ³•æ”¾ä¸ä¸‹è¯¥å¯¹è±¡ï¼Œé‚£æ²¡å¾—åŠæ³•ï¼Œåªèƒ½è¯´æ˜æ˜¯è¶…å¤§å¯¹è±¡ï¼Œåªèƒ½ç›´æ¥æ”¾åˆ°è€å¹´ä»£
é‚£ä¸‡ä¸€è€å¹´ä»£éƒ½æ”¾ä¸ä¸‹ï¼Œåˆ™å…ˆè§¦å‘FullGC ï¼Œå†çœ‹çœ‹èƒ½ä¸èƒ½æ”¾ä¸‹ï¼Œæ”¾å¾—ä¸‹æœ€å¥½ï¼Œä½†å¦‚æœè¿˜æ˜¯æ”¾ä¸ä¸‹ï¼Œé‚£åªèƒ½æŠ¥ OOM


å¦‚æœ Eden åŒºæ»¡äº†ï¼Œå°†å¯¹è±¡å¾€å¹¸å­˜åŒºæ‹·è´æ—¶ï¼Œå‘ç°å¹¸å­˜åŒºæ”¾ä¸ä¸‹å•¦ï¼Œé‚£åªèƒ½ä¾¿å®œäº†æŸäº›æ–°å¯¹è±¡ï¼Œè®©ä»–ä»¬ç›´æ¥æ™‹å‡è‡³è€å¹´åŒº

  
  

ä»£ç æ¼”ç¤ºå¯¹è±¡åˆ†é…è¿‡ç¨‹


æˆ‘ä»¬ä¸æ–­çš„åˆ›å»ºå¤§å¯¹è±¡
package com.peppa.heap;import java.util.ArrayList;import java.util.Random;/** * ä»£ç æ¼”ç¤ºå¯¹è±¡åˆ›å»ºè¿‡ç¨‹ * * @author: peppa * @create: 2022-02-11 17:27:58 */public class HeapInstanceTest &#123;    byte [] buffer = new byte[new Random().nextInt(1024 * 200)];    public static void main(String[] args) throws InterruptedException &#123;        ArrayList&lt;HeapInstanceTest&gt; list = new ArrayList&lt;&gt;();        while (true) &#123;            list.add(new HeapInstanceTest());            Thread.sleep(10);        &#125;    &#125;&#125;

ç„¶åè®¾ç½®JVMå‚æ•°ï¼š-Xms600m -Xmx600m
æ‰“å¼€VisualVMå›¾å½¢åŒ–ç•Œé¢

æœ€ç»ˆï¼Œåœ¨è€å¹´ä»£å’Œæ–°ç”Ÿä»£éƒ½æ»¡äº†ï¼Œå°±å‡ºç°OOM
D:\software\Java\jdk1.8\jdk1.8.0_241\bin\java.exe -Xms600m -Xmx600mException in thread &quot;main&quot; java.lang.OutOfMemoryError: Java heap space	at com.peppa.heap.HeapInstanceTest.&lt;init&gt;(HeapInstanceTest.java:12)	at com.peppa.heap.HeapInstanceTest.main(HeapInstanceTest.java:16)Process finished with exit code 1


å¸¸ç”¨è°ƒä¼˜å·¥å…·

JDKå‘½ä»¤è¡Œ
Eclipseï¼šMemory Analyzer Tool
Jconsole
Visual VMï¼ˆå®æ—¶ç›‘æ§ï¼Œæ¨èï¼‰
Jprofilerï¼ˆIDEAæ’ä»¶ï¼‰
Java Flight Recorderï¼ˆå®æ—¶ç›‘æ§ï¼‰
GCViewer
GCEasy


GCåˆ†ç±»

Minor GCï¼ŒMajorGCã€Full GC

Minor GCï¼šæ–°ç”Ÿä»£çš„GC
Major GCï¼šè€å¹´ä»£çš„GC
Full GCï¼šæ•´å †æ”¶é›†ï¼Œæ”¶é›†æ•´ä¸ªJavaå †å’Œæ–¹æ³•åŒºçš„åƒåœ¾æ”¶é›†


æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒJVMçš„è°ƒä¼˜çš„ä¸€ä¸ªç¯èŠ‚ï¼Œä¹Ÿå°±æ˜¯åƒåœ¾æ”¶é›†ï¼Œæˆ‘ä»¬éœ€è¦å°½é‡çš„é¿å…åƒåœ¾å›æ”¶ï¼Œå› ä¸ºåœ¨åƒåœ¾å›æ”¶çš„è¿‡ç¨‹ä¸­ï¼Œå®¹æ˜“å‡ºç°STWçš„é—®é¢˜ï¼Œè€Œ Major GC å’Œ Full GCå‡ºç°STWçš„æ—¶é—´ï¼Œæ˜¯Minor GCçš„10å€ä»¥ä¸Š


éƒ¨åˆ†æ”¶é›†ï¼ˆPartial GCï¼‰&amp;&amp; æ•´å †æ”¶é›†ï¼ˆFullGCï¼‰

æ–°ç”Ÿä»£æ”¶é›†ï¼ˆMinorGC&#x2F;YoungGCï¼‰ï¼šåªæ˜¯æ–°ç”Ÿä»£çš„åƒåœ¾æ”¶é›†
è€å¹´ä»£æ”¶é›†ï¼ˆMajorGC&#x2F;o1dGCï¼‰ï¼šåªæ˜¯è€å¹´ä»£çš„åœ¾æ”¶é›†ã€‚
ç›®å‰ï¼Œåªæœ‰CMSGCä¼šæœ‰å•ç‹¬æ”¶é›†è€å¹´ä»£çš„è¡Œä¸ºã€‚
æ³¨æ„ï¼Œå¾ˆå¤šæ—¶å€™Major GCä¼šå’ŒFu11GCæ··æ·†ä½¿ç”¨ï¼Œéœ€è¦å…·ä½“åˆ†è¾¨æ˜¯è€å¹´ä»£å›æ”¶è¿˜æ˜¯æ•´å †å›æ”¶ã€‚




æ•´å †æ”¶é›†ï¼ˆFullGCï¼‰ï¼šæ”¶é›†æ•´ä¸ªjavaå †å’Œæ–¹æ³•åŒºçš„åƒåœ¾æ”¶é›†ã€‚

Young GC
  å½“å¹´è½»ä»£ç©ºé—´ä¸è¶³æ—¶ï¼Œå°±ä¼šè§¦å‘MinorGCï¼Œè¿™é‡Œçš„å¹´è½»ä»£æ»¡æŒ‡çš„æ˜¯Edenä»£æ»¡ï¼ŒSurvivoræ»¡ä¸ä¼šå¼•å‘GCã€‚ï¼ˆæ¯æ¬¡Minor GCä¼šæ¸…ç†å¹´è½»ä»£çš„å†…å­˜ã€‚ï¼‰
  å› ä¸ºJavaå¯¹è±¡å¤§å¤šéƒ½å…·å¤‡Â æœç”Ÿå¤•ç­Â çš„ç‰¹æ€§ï¼Œæ‰€ä»¥Minor GCéå¸¸é¢‘ç¹ï¼Œä¸€èˆ¬å›æ”¶é€Ÿåº¦ä¹Ÿæ¯”è¾ƒå¿«ã€‚è¿™ä¸€å®šä¹‰æ—¢æ¸…æ™°åˆæ˜“äºç†è§£ã€‚
  Minor GCä¼šå¼•å‘STWï¼Œæš‚åœå…¶å®ƒç”¨æˆ·çš„çº¿ç¨‹ï¼Œç­‰åƒåœ¾å›æ”¶ç»“æŸï¼Œç”¨æˆ·çº¿ç¨‹æ‰æ¢å¤è¿è¡Œ
  

è€å¹´ä»£GCï¼ˆMajorGCï¼‰è§¦å‘æœºåˆ¶

æŒ‡å‘ç”Ÿåœ¨è€å¹´ä»£çš„GCï¼Œå¯¹è±¡ä»è€å¹´ä»£æ¶ˆå¤±æ—¶ï¼Œæˆ‘ä»¬è¯´ â€œMajor Gcâ€ æˆ– â€œFull GCâ€ å‘ç”Ÿäº†
å‡ºç°äº†MajorGcï¼Œç»å¸¸ä¼šä¼´éšè‡³å°‘ä¸€æ¬¡çš„Minor GCã€‚ï¼ˆä½†éç»å¯¹çš„ï¼Œåœ¨Parallel Scavengeæ”¶é›†å™¨çš„æ”¶é›†ç­–ç•¥é‡Œå°±æœ‰ç›´æ¥è¿›è¡ŒMajorGCçš„ç­–ç•¥é€‰æ‹©è¿‡ç¨‹ï¼‰
ä¹Ÿå°±æ˜¯åœ¨è€å¹´ä»£ç©ºé—´ä¸è¶³æ—¶ï¼Œä¼šå…ˆå°è¯•è§¦å‘Minor GCï¼ˆå“ˆï¼Ÿæˆ‘æœ‰ç‚¹è¿·ï¼Ÿï¼‰ï¼Œå¦‚æœä¹‹åç©ºé—´è¿˜ä¸è¶³ï¼Œåˆ™è§¦å‘Major GC


Major GCçš„é€Ÿåº¦ä¸€èˆ¬ä¼šæ¯”Minor GCæ…¢10å€ä»¥ä¸Šï¼ŒSTWçš„æ—¶é—´æ›´é•¿ã€‚
å¦‚æœMajor GCåï¼Œå†…å­˜è¿˜ä¸è¶³ï¼Œå°±æŠ¥OOMäº†


è§¦å‘Full GCæ‰§è¡Œçš„æƒ…å†µæœ‰å¦‚ä¸‹äº”ç§ï¼š

è°ƒç”¨System.gc()æ—¶ï¼Œç³»ç»Ÿå»ºè®®æ‰§è¡ŒFullGCï¼Œä½†æ˜¯ä¸å¿…ç„¶æ‰§è¡Œ
è€å¹´ä»£ç©ºé—´ä¸è¶³
æ–¹æ³•åŒºç©ºé—´ä¸è¶³
é€šè¿‡Minor GCåè¿›å…¥è€å¹´ä»£çš„å¹³å‡å¤§å°å¤§äºè€å¹´ä»£çš„å¯ç”¨å†…å­˜
ç”±EdenåŒºã€survivor space0ï¼ˆFrom Spaceï¼‰åŒºå‘survivor space1ï¼ˆTo Spaceï¼‰åŒºå¤åˆ¶æ—¶ï¼Œå¯¹è±¡å¤§å°å¤§äºTo Spaceå¯ç”¨å†…å­˜ï¼Œåˆ™æŠŠè¯¥å¯¹è±¡è½¬å­˜åˆ°è€å¹´ä»£ï¼Œä¸”è€å¹´ä»£çš„å¯ç”¨å†…å­˜å°äºè¯¥å¯¹è±¡å¤§å°




GCæ—¥å¿—åˆ†æ
  package com.peppa.gc;import java.util.ArrayList;import java.util.List;/** * æµ‹è¯•MinorGC ã€ MajorGCã€FullGC * -Xms9m -Xmx9m -XX:+PrintGCDetails * @author shkstart  shkstart@126.com * @create 2020  14:19 */public class GCTest &#123;    public static void main(String[] args) &#123;        int i = 0;        try &#123;            List&lt;String&gt; list = new ArrayList&lt;&gt;();            String a = &quot;this is peppa&quot;;            while (true) &#123;                list.add(a);                a = a + a;                i++;            &#125;        &#125; catch (Throwable t) &#123;            t.printStackTrace();            System.out.println(&quot;éå†æ¬¡æ•°ä¸ºï¼š&quot; + i);        &#125;    &#125;&#125;
  è¾“å‡ºï¼š
  [GC (Allocation Failure) [PSYoungGen: 1964K-&gt;510K(2560K)] 1964K-&gt;826K(9728K), 0.0008721 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] [GC (Allocation Failure) [PSYoungGen: 2361K-&gt;496K(2560K)] 2677K-&gt;1489K(9728K), 0.0007112 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] [GC (Allocation Failure) [PSYoungGen: 1796K-&gt;384K(2560K)] 2790K-&gt;2417K(9728K), 0.0009442 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] [Full GC (Ergonomics) [PSYoungGen: 2151K-&gt;0K(2560K)] [ParOldGen: 7025K-&gt;5682K(7168K)] 9177K-&gt;5682K(9728K), [Metaspace: 3227K-&gt;3227K(1056768K)], 0.0029911 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] [GC (Allocation Failure) [PSYoungGen: 0K-&gt;0K(2560K)] 5682K-&gt;5682K(9728K), 0.0004552 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] [Full GC (Allocation Failure) [PSYoungGen: 0K-&gt;0K(2560K)] [ParOldGen: 5682K-&gt;5599K(7168K)] 5682K-&gt;5599K(9728K), [Metaspace: 3227K-&gt;3227K(1056768K)], 0.0058927 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] éå†æ¬¡æ•°ä¸ºï¼š16Heap PSYoungGen      total 2560K, used 101K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)  eden space 2048K, 4% used [0x00000000ffd00000,0x00000000ffd19568,0x00000000fff00000)  from space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)  to   space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000) ParOldGen       total 7168K, used 5599K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)  object space 7168K, 78% used [0x00000000ff600000,0x00000000ffb77d90,0x00000000ffd00000) Metaspace       used 3259K, capacity 4496K, committed 4864K, reserved 1056768K  class space    used 353K, capacity 388K, committed 512K, reserved 1048576Kjava.lang.OutOfMemoryError: Java heap space	at java.util.Arrays.copyOf(Arrays.java:3332)	at java.lang.AbstractStringBuilder.ensureCapacityInternal(AbstractStringBuilder.java:124)	at java.lang.AbstractStringBuilder.append(AbstractStringBuilder.java:448)	at java.lang.StringBuilder.append(StringBuilder.java:136)	at com.peppa.gc.GCTest.main(GCTest.java:20)Process finished with exit code 0
  [GC (Allocation Failure) [PSYoungGen: 1964K-&gt;510K(2560K)] 1964K-&gt;826K(9728K), 0.0008721 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 

[PSYoungGen: 1964K-&gt;510K(2560K)]ï¼šå¹´è½»ä»£æ€»ç©ºé—´ä¸º 2560K ï¼Œå½“å‰å ç”¨ 1964K ï¼Œç»è¿‡åƒåœ¾å›æ”¶åå‰©ä½™510K****
1964K-&gt;826K(9728K)ï¼šå †å†…å­˜æ€»ç©ºé—´ä¸º 9728K ï¼Œå½“å‰å ç”¨1964Kï¼Œç»è¿‡åƒåœ¾å›æ”¶åå‰©ä½™826K

  
  
  

å †ç©ºé—´åˆ†ä»£æ€æƒ³
  ä¸ºä»€ä¹ˆè¦æŠŠJavaå †åˆ†ä»£ï¼Ÿä¸åˆ†ä»£å°±ä¸èƒ½æ­£å¸¸å·¥ä½œäº†å—ï¼Ÿç»ç ”ç©¶ï¼Œä¸åŒå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸä¸åŒã€‚70%-99%çš„å¯¹è±¡æ˜¯ä¸´æ—¶å¯¹è±¡ã€‚

æ–°ç”Ÿä»£ï¼šæœ‰Edenã€ä¸¤å—å¤§å°ç›¸åŒçš„survivorï¼ˆåˆç§°ä¸ºfrom&#x2F;toæˆ–s0&#x2F;s1ï¼‰æ„æˆï¼Œtoæ€»ä¸ºç©ºã€‚
è€å¹´ä»£ï¼šå­˜æ”¾æ–°ç”Ÿä»£ä¸­ç»å†å¤šæ¬¡GCä»ç„¶å­˜æ´»çš„å¯¹è±¡ã€‚

  
  å…¶å®ä¸åˆ†ä»£å®Œå…¨å¯ä»¥ï¼Œåˆ†ä»£çš„å”¯ä¸€ç†ç”±å°±æ˜¯ä¼˜åŒ–GCæ€§èƒ½ã€‚å¦‚æœæ²¡æœ‰åˆ†ä»£ï¼Œé‚£æ‰€æœ‰çš„å¯¹è±¡éƒ½åœ¨ä¸€å—ï¼Œå°±å¦‚åŒæŠŠä¸€ä¸ªå­¦æ ¡çš„äººéƒ½å…³åœ¨ä¸€ä¸ªæ•™å®¤ã€‚GCçš„æ—¶å€™è¦æ‰¾åˆ°å“ªäº›å¯¹è±¡æ²¡ç”¨ï¼Œè¿™æ ·å°±ä¼šå¯¹å †çš„æ‰€æœ‰åŒºåŸŸè¿›è¡Œæ‰«æã€‚è€Œå¾ˆå¤šå¯¹è±¡éƒ½æ˜¯æœç”Ÿå¤•æ­»çš„ï¼Œå¦‚æœåˆ†ä»£çš„è¯ï¼ŒæŠŠæ–°åˆ›å»ºçš„å¯¹è±¡æ”¾åˆ°æŸä¸€åœ°æ–¹ï¼Œå½“GCçš„æ—¶å€™å…ˆæŠŠè¿™å—å­˜å‚¨â€œæœç”Ÿå¤•æ­»â€å¯¹è±¡çš„åŒºåŸŸè¿›è¡Œå›æ”¶ï¼Œè¿™æ ·å°±ä¼šè…¾å‡ºå¾ˆå¤§çš„ç©ºé—´å‡ºæ¥ã€‚
  
  

å†…å­˜åˆ†é…ç­–ç•¥
  å¦‚æœå¯¹è±¡åœ¨Edenå‡ºç”Ÿå¹¶ç»è¿‡ç¬¬ä¸€æ¬¡Minor GCåä»ç„¶å­˜æ´»ï¼Œå¹¶ä¸”èƒ½è¢«Survivorå®¹çº³çš„è¯ï¼Œå°†è¢«ç§»åŠ¨åˆ°survivorç©ºé—´ä¸­ï¼Œå¹¶å°†å¯¹è±¡å¹´é¾„è®¾ä¸º1ã€‚å¯¹è±¡åœ¨survivoråŒºä¸­æ¯ç†¬è¿‡ä¸€æ¬¡MinorGCï¼Œå¹´é¾„å°±å¢åŠ 1å²ï¼Œå½“å®ƒçš„å¹´é¾„å¢åŠ åˆ°ä¸€å®šç¨‹åº¦ï¼ˆé»˜è®¤ä¸º15å²ï¼Œå…¶å®æ¯ä¸ªJVMã€æ¯ä¸ªGCéƒ½æœ‰æ‰€ä¸åŒï¼‰æ—¶ï¼Œå°±ä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£
  å¯¹è±¡æ™‹å‡è€å¹´ä»£çš„å¹´é¾„é˜€å€¼ï¼Œå¯ä»¥é€šè¿‡é€‰é¡¹-xx:MaxTenuringThresholdæ¥è®¾ç½®
  é’ˆå¯¹ä¸åŒå¹´é¾„æ®µçš„å¯¹è±¡åˆ†é…åŸåˆ™å¦‚ä¸‹æ‰€ç¤ºï¼š

ä¼˜å…ˆåˆ†é…åˆ°Eden
å¼€å‘ä¸­æ¯”è¾ƒé•¿çš„å­—ç¬¦ä¸²æˆ–è€…æ•°ç»„ï¼Œä¼šç›´æ¥å­˜åœ¨è€å¹´ä»£ï¼Œä½†æ˜¯å› ä¸ºæ–°åˆ›å»ºçš„å¯¹è±¡ éƒ½æ˜¯ æœç”Ÿå¤•æ­»çš„ï¼Œæ‰€ä»¥è¿™ä¸ªå¤§å¯¹è±¡å¯èƒ½ä¹Ÿå¾ˆå¿«è¢«å›æ”¶ï¼Œä½†æ˜¯å› ä¸ºè€å¹´ä»£è§¦å‘Major GCçš„æ¬¡æ•°æ¯” Minor GCè¦æ›´å°‘ï¼Œå› æ­¤å¯èƒ½å›æ”¶èµ·æ¥å°±ä¼šæ¯”è¾ƒæ…¢


å¤§å¯¹è±¡ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£
å°½é‡é¿å…ç¨‹åºä¸­å‡ºç°è¿‡å¤šçš„å¤§å¯¹è±¡


é•¿æœŸå­˜æ´»çš„å¯¹è±¡åˆ†é…åˆ°è€å¹´ä»£
åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤æ–­
å¦‚æœsurvivoråŒºä¸­ç›¸åŒå¹´é¾„çš„æ‰€æœ‰å¯¹è±¡å¤§å°çš„æ€»å’Œå¤§äºSurvivorç©ºé—´çš„ä¸€åŠï¼Œå¹´é¾„å¤§äºæˆ–ç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡å¯ä»¥ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼Œæ— é¡»ç­‰åˆ°MaxTenuringThreshold ä¸­è¦æ±‚çš„å¹´é¾„ã€‚



  ç©ºé—´åˆ†é…æ‹…ä¿ï¼š -Xx:HandlePromotionFailure

ä¹Ÿå°±æ˜¯ç»è¿‡Minor GCåï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½å­˜æ´»ï¼Œå› ä¸ºSurvivoræ¯”è¾ƒå°ï¼Œæ‰€ä»¥å°±éœ€è¦å°†Survivoræ— æ³•å®¹çº³çš„å¯¹è±¡ï¼Œå­˜æ”¾åˆ°è€å¹´ä»£ä¸­ã€‚


ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ï¼šTLAB

é—®é¢˜ï¼šå †ç©ºé—´éƒ½æ˜¯å…±äº«çš„ä¹ˆï¼Ÿ
  ä¸ä¸€å®šï¼Œå› ä¸ºè¿˜æœ‰TLABè¿™ä¸ªæ¦‚å¿µï¼Œåœ¨å †ä¸­åˆ’åˆ†å‡ºä¸€å—åŒºåŸŸï¼Œä¸ºæ¯ä¸ªçº¿ç¨‹æ‰€ç‹¬å 

ä¸ºä»€ä¹ˆæœ‰TLABï¼Ÿ
  ä»å†…å­˜æ¨¡å‹è€Œä¸æ˜¯åƒåœ¾æ”¶é›†çš„è§’åº¦ï¼Œå¯¹EdenåŒºåŸŸç»§ç»­è¿›è¡Œåˆ’åˆ†ï¼ŒJVMä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…äº†ä¸€ä¸ªç§æœ‰ç¼“å­˜åŒºåŸŸï¼Œå®ƒåŒ…å«åœ¨Edenç©ºé—´å†…ã€‚
  å¤šçº¿ç¨‹åŒæ—¶åˆ†é…å†…å­˜æ—¶ï¼Œä½¿ç”¨TLABå¯ä»¥é¿å…ä¸€ç³»åˆ—çš„éçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ŒåŒæ—¶è¿˜èƒ½å¤Ÿæå‡å†…å­˜åˆ†é…çš„ååé‡ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†è¿™ç§å†…å­˜åˆ†é…æ–¹å¼ç§°ä¹‹ä¸ºå¿«é€Ÿåˆ†é…ç­–ç•¥ã€‚
  æ®æˆ‘æ‰€çŸ¥æ‰€æœ‰OpenJDKè¡ç”Ÿå‡ºæ¥çš„JVMéƒ½æä¾›äº†TLABçš„è®¾è®¡ã€‚
  
  å°½ç®¡ä¸æ˜¯æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½èƒ½å¤Ÿåœ¨TLABä¸­æˆåŠŸåˆ†é…å†…å­˜ï¼Œä½†JVMç¡®å®æ˜¯å°†TLABä½œä¸ºå†…å­˜åˆ†é…çš„é¦–é€‰ã€‚
  åœ¨ç¨‹åºä¸­ï¼Œå¼€å‘äººå‘˜å¯ä»¥é€šè¿‡é€‰é¡¹â€œ-Xx:UseTLABâ€è®¾ç½®æ˜¯å¦å¼€å¯TLABç©ºé—´ã€‚
  é»˜è®¤æƒ…å†µä¸‹ï¼ŒTLABç©ºé—´çš„å†…å­˜éå¸¸å°ï¼Œä»…å æœ‰æ•´ä¸ªEdenç©ºé—´çš„1ï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡é€‰é¡¹â€œ-Xx:TLABWasteTargetPercentâ€è®¾ç½®TLABç©ºé—´æ‰€å ç”¨Edenç©ºé—´çš„ç™¾åˆ†æ¯”å¤§å°ã€‚
  ä¸€æ—¦å¯¹è±¡åœ¨TLABç©ºé—´åˆ†é…å†…å­˜å¤±è´¥æ—¶ï¼ŒJVMå°±ä¼šå°è¯•ç€é€šè¿‡ä½¿ç”¨åŠ é”æœºåˆ¶ç¡®ä¿æ•°æ®æ“ä½œçš„åŸå­æ€§ï¼Œä»è€Œç›´æ¥åœ¨Edenç©ºé—´ä¸­åˆ†é…å†…å­˜ã€‚

TLABåˆ†é…è¿‡ç¨‹
  å¯¹è±¡é¦–å…ˆæ˜¯é€šè¿‡TLABå¼€è¾Ÿç©ºé—´ï¼Œå¦‚æœä¸èƒ½æ”¾å…¥ï¼Œé‚£ä¹ˆéœ€è¦é€šè¿‡Edenæ¥è¿›è¡Œåˆ†é…
  



å°ç»“ï¼šå †ç©ºé—´çš„å‚æ•°è®¾ç½®

XXï¼š+PrintFlagsInitialï¼šæŸ¥çœ‹æ‰€æœ‰çš„å‚æ•°çš„é»˜è®¤åˆå§‹å€¼
XXï¼š+PrintFlagsFinalï¼šæŸ¥çœ‹æ‰€æœ‰çš„å‚æ•°çš„æœ€ç»ˆå€¼ï¼ˆå¯èƒ½ä¼šå­˜åœ¨ä¿®æ”¹ï¼Œä¸å†æ˜¯åˆå§‹å€¼ï¼‰
Xmsï¼šåˆå§‹å †ç©ºé—´å†…å­˜ï¼ˆé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„1&#x2F;64ï¼‰
Xmxï¼šæœ€å¤§å †ç©ºé—´å†…å­˜ï¼ˆé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„1&#x2F;4ï¼‰
Xmnï¼šè®¾ç½®æ–°ç”Ÿä»£çš„å¤§å°ã€‚ï¼ˆåˆå§‹å€¼åŠæœ€å¤§å€¼ï¼‰
XX:NewRatioï¼šé…ç½®æ–°ç”Ÿä»£ä¸è€å¹´ä»£åœ¨å †ç»“æ„çš„å æ¯”
XX:SurvivorRatioï¼šè®¾ç½®æ–°ç”Ÿä»£ä¸­Edenå’ŒS0&#x2F;S1ç©ºé—´çš„æ¯”ä¾‹
XX:MaxTenuringThresholdï¼šè®¾ç½®æ–°ç”Ÿä»£åƒåœ¾çš„æœ€å¤§å¹´é¾„
XXï¼š+PrintGCDetailsï¼šè¾“å‡ºè¯¦ç»†çš„GCå¤„ç†æ—¥å¿—
æ‰“å°gcç®€è¦ä¿¡æ¯ï¼šâ‘ -Xxï¼š+PrintGC â‘¡ - verbose:gc


XX:HandlePromotionFalilureï¼šæ˜¯å¦è®¾ç½®ç©ºé—´åˆ†é…æ‹…ä¿

  åœ¨å‘ç”ŸMinor GCä¹‹å‰ï¼Œè™šæ‹Ÿæœºä¼šæ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨çš„è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºæ–°ç”Ÿä»£æ‰€æœ‰å¯¹è±¡çš„æ€»ç©ºé—´ã€‚

å¦‚æœå¤§äºï¼Œåˆ™æ­¤æ¬¡Minor GCæ˜¯å®‰å…¨çš„
å¦‚æœå°äºï¼Œåˆ™è™šæ‹Ÿæœºä¼šæŸ¥çœ‹-xx:HandlePromotionFailureè®¾ç½®å€¼æ˜¯å¦å…æ‹…ä¿å¤±è´¥ã€‚
å¦‚æœHandlePromotionFailure&#x3D;trueï¼Œé‚£ä¹ˆä¼šç»§ç»­æ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºå†æ¬¡æ™‹å‡åˆ°è€å¹´ä»£çš„å¯¹è±¡çš„å¹³å‡å¤§å°ã€‚
å¦‚æœå¤§äºï¼Œåˆ™å°è¯•è¿›è¡Œä¸€æ¬¡Minor GCï¼Œä½†è¿™æ¬¡Minor GCä¾ç„¶æ˜¯æœ‰é£é™©çš„ï¼›
å¦‚æœå°äºï¼Œåˆ™æ”¹ä¸ºè¿›è¡Œä¸€æ¬¡FullGCã€‚
å¦‚æœHandlePromotionFailure&#x3D;falseï¼Œåˆ™æ”¹ä¸ºè¿›è¡Œä¸€æ¬¡Full GC



  åœ¨JDK6 Update24ä¹‹åï¼ŒHandlePromotionFailureå‚æ•°ä¸ä¼šå†å½±å“åˆ°è™šæ‹Ÿæœºçš„ç©ºé—´åˆ†é…æ‹…ä¿ç­–ç•¥ï¼Œè§‚å¯ŸopenJDKä¸­çš„æºç å˜åŒ–ï¼Œè™½ç„¶æºç ä¸­è¿˜å®šä¹‰äº†HandlePromotionFailureå‚æ•°ï¼Œä½†æ˜¯åœ¨ä»£ç ä¸­å·²ç»ä¸ä¼šå†ä½¿ç”¨å®ƒã€‚JDK6 Update 24ä¹‹åçš„è§„åˆ™å˜ä¸ºåªè¦è€å¹´ä»£çš„è¿ç»­ç©ºé—´å¤§äºæ–°ç”Ÿä»£å¯¹è±¡æ€»å¤§å°æˆ–è€…å†æ¬¡æ™‹å‡çš„å¹³å‡å¤§å°å°±ä¼šè¿›è¡ŒMinor GCï¼Œå¦åˆ™å°†è¿›è¡ŒFullGCã€‚

å †æ˜¯åˆ†é…å¯¹è±¡çš„å”¯ä¸€é€‰æ‹©ä¹ˆï¼Ÿ
  åœ¨ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ä¸­å…³äºJavaå †å†…å­˜æœ‰è¿™æ ·ä¸€æ®µæè¿°ï¼š

éšç€JITç¼–è¯‘æœŸçš„å‘å±•ä¸é€ƒé€¸åˆ†ææŠ€æœ¯é€æ¸æˆç†Ÿï¼Œæ ˆä¸Šåˆ†é…ã€æ ‡é‡æ›¿æ¢ä¼˜åŒ–æŠ€æœ¯å°†ä¼šå¯¼è‡´ä¸€äº›å¾®å¦™çš„å˜åŒ–ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½åˆ†é…åˆ°å †ä¸Šä¹Ÿæ¸æ¸å˜å¾—ä¸é‚£ä¹ˆâ€œç»å¯¹â€äº†ã€‚
åœ¨Javaè™šæ‹Ÿæœºä¸­ï¼Œå¯¹è±¡æ˜¯åœ¨Javaå †ä¸­åˆ†é…å†…å­˜çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªæ™®éçš„å¸¸è¯†ã€‚ä½†æ˜¯ï¼Œæœ‰ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œé‚£å°±æ˜¯å¦‚æœç»è¿‡é€ƒé€¸åˆ†æï¼ˆEscape Analysisï¼‰åå‘ç°ï¼Œä¸€ä¸ªå¯¹è±¡å¹¶æ²¡æœ‰é€ƒé€¸å‡ºæ–¹æ³•çš„è¯ï¼Œé‚£ä¹ˆå°±å¯èƒ½è¢«ä¼˜åŒ–æˆæ ˆä¸Šåˆ†é…ã€‚è¿™æ ·å°±æ— éœ€åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œä¹Ÿæ— é¡»è¿›è¡Œåƒåœ¾å›æ”¶äº†ã€‚è¿™ä¹Ÿæ˜¯æœ€å¸¸è§çš„å †å¤–å­˜å‚¨æŠ€æœ¯ã€‚
æ­¤å¤–ï¼Œå‰é¢æåˆ°çš„åŸºäºOpenJDKæ·±åº¦å®šåˆ¶çš„TaoBao VMï¼Œå…¶ä¸­åˆ›æ–°çš„GCIHï¼ˆGC invisible heapï¼‰æŠ€æœ¯å®ç°off-heapï¼Œå°†ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿çš„Javaå¯¹è±¡ä»heapä¸­ç§»è‡³heapå¤–ï¼Œå¹¶ä¸”GCä¸èƒ½ç®¡ç†GCIHå†…éƒ¨çš„Javaå¯¹è±¡ï¼Œä»¥æ­¤è¾¾åˆ°é™ä½GCçš„å›æ”¶é¢‘ç‡å’Œæå‡GCçš„å›æ”¶æ•ˆç‡çš„ç›®çš„ã€‚



6.é€ƒé€¸åˆ†æ
é€ƒé€¸åˆ†æ

å¦‚ä½•å°†å †ä¸Šçš„å¯¹è±¡åˆ†é…åˆ°æ ˆï¼Œéœ€è¦ä½¿ç”¨é€ƒé€¸åˆ†ææ‰‹æ®µã€‚
è¿™æ˜¯ä¸€ç§å¯ä»¥æœ‰æ•ˆå‡å°‘Javaç¨‹åºä¸­åŒæ­¥è´Ÿè½½å’Œå†…å­˜å †åˆ†é…å‹åŠ›çš„è·¨å‡½æ•°å…¨å±€æ•°æ®æµåˆ†æç®—æ³•ã€‚
é€šè¿‡é€ƒé€¸åˆ†æï¼ŒJava Hotspotç¼–è¯‘å™¨èƒ½å¤Ÿåˆ†æå‡ºä¸€ä¸ªæ–°çš„å¯¹è±¡çš„å¼•ç”¨çš„ä½¿ç”¨èŒƒå›´ä»è€Œå†³å®šæ˜¯å¦è¦å°†è¿™ä¸ªå¯¹è±¡åˆ†é…åˆ°å †ä¸Šã€‚
é€ƒé€¸åˆ†æçš„åŸºæœ¬è¡Œä¸ºå°±æ˜¯åˆ†æå¯¹è±¡åŠ¨æ€ä½œç”¨åŸŸï¼š
å½“ä¸€ä¸ªå¯¹è±¡åœ¨æ–¹æ³•ä¸­è¢«å®šä¹‰åï¼Œå¯¹è±¡åªåœ¨æ–¹æ³•å†…éƒ¨ä½¿ç”¨ï¼Œåˆ™è®¤ä¸ºæ²¡æœ‰å‘ç”Ÿé€ƒé€¸ã€‚
å½“ä¸€ä¸ªå¯¹è±¡åœ¨æ–¹æ³•ä¸­è¢«å®šä¹‰åï¼Œå®ƒè¢«å¤–éƒ¨æ–¹æ³•æ‰€å¼•ç”¨ï¼Œåˆ™è®¤ä¸ºå‘ç”Ÿé€ƒé€¸ã€‚ä¾‹å¦‚ä½œä¸ºè°ƒç”¨å‚æ•°ä¼ é€’åˆ°å…¶ä»–åœ°æ–¹ä¸­ã€‚




é€ƒé€¸åˆ†æä¸¾ä¾‹

æ²¡æœ‰å‘ç”Ÿé€ƒé€¸çš„å¯¹è±¡ï¼Œåˆ™å¯ä»¥åˆ†é…åˆ°æ ˆï¼ˆæ— çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼‰ä¸Šï¼Œéšç€æ–¹æ³•æ‰§è¡Œçš„ç»“æŸï¼Œæ ˆç©ºé—´å°±è¢«ç§»é™¤ï¼ˆä¹Ÿå°±æ— éœ€GCï¼‰

  public void my_method() &#123;    V v = new V();    // use v    // ....    v = null;&#125;

ä¸‹é¢ä»£ç ä¸­çš„ StringBuffer sb å‘ç”Ÿäº†é€ƒé€¸ï¼Œä¸èƒ½åœ¨æ ˆä¸Šåˆ†é…

  public static StringBuffer createStringBuffer(String s1, String s2) &#123;    StringBuffer sb = new StringBuffer();    sb.append(s1);    sb.append(s2);    return sb;&#125;

å¦‚æœæƒ³è¦StringBuffer sbä¸å‘ç”Ÿé€ƒé€¸ï¼Œå¯ä»¥è¿™æ ·å†™

  public static String createStringBuffer(String s1, String s2) &#123;    StringBuffer sb = new StringBuffer();    sb.append(s1);    sb.append(s2);    return sb.toString();&#125;
  /** * é€ƒé€¸åˆ†æ * *  å¦‚ä½•å¿«é€Ÿçš„åˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº†é€ƒé€¸åˆ†æï¼Œå¤§å®¶å°±çœ‹newçš„å¯¹è±¡å®ä½“æ˜¯å¦æœ‰å¯èƒ½åœ¨æ–¹æ³•å¤–è¢«è°ƒç”¨ã€‚ */public class EscapeAnalysis &#123;    public EscapeAnalysis obj;    /*    æ–¹æ³•è¿”å›EscapeAnalysiså¯¹è±¡ï¼Œå‘ç”Ÿé€ƒé€¸     */    public EscapeAnalysis getInstance()&#123;        return obj == null? new EscapeAnalysis() : obj;    &#125;    /*    ä¸ºæˆå‘˜å±æ€§èµ‹å€¼ï¼Œå‘ç”Ÿé€ƒé€¸     */    public void setObj()&#123;        this.obj = new EscapeAnalysis();    &#125;    //æ€è€ƒï¼šå¦‚æœå½“å‰çš„objå¼•ç”¨å£°æ˜ä¸ºstaticçš„ï¼Ÿä»ç„¶ä¼šå‘ç”Ÿé€ƒé€¸ã€‚    /*    å¯¹è±¡çš„ä½œç”¨åŸŸä»…åœ¨å½“å‰æ–¹æ³•ä¸­æœ‰æ•ˆï¼Œæ²¡æœ‰å‘ç”Ÿé€ƒé€¸     */    public void useEscapeAnalysis()&#123;        EscapeAnalysis e = new EscapeAnalysis();    &#125;    /*    å¼•ç”¨æˆå‘˜å˜é‡çš„å€¼ï¼Œå‘ç”Ÿé€ƒé€¸     */    public void useEscapeAnalysis1()&#123;        EscapeAnalysis e = getInstance();        //getInstance().xxx()åŒæ ·ä¼šå‘ç”Ÿé€ƒé€¸    &#125;&#125;

é€ƒé€¸åˆ†æå‚æ•°è®¾ç½®

åœ¨JDK 1.7 ç‰ˆæœ¬ä¹‹åï¼ŒHotSpotä¸­é»˜è®¤å°±å·²ç»å¼€å¯äº†é€ƒé€¸åˆ†æ
å¦‚æœä½¿ç”¨çš„æ˜¯è¾ƒæ—©çš„ç‰ˆæœ¬ï¼Œå¼€å‘äººå‘˜åˆ™å¯ä»¥é€šè¿‡ï¼š
é€‰é¡¹â€œ-XX:+DoEscapeAnalysisâ€æ˜¾å¼å¼€å¯é€ƒé€¸åˆ†æ
é€šè¿‡é€‰é¡¹â€œ-XX:+PrintEscapeAnalysisâ€æŸ¥çœ‹é€ƒé€¸åˆ†æçš„ç­›é€‰ç»“æœ




ç»“è®º
  å¼€å‘ä¸­èƒ½ä½¿ç”¨å±€éƒ¨å˜é‡çš„ï¼Œå°±ä¸è¦ä½¿ç”¨åœ¨æ–¹æ³•å¤–å®šä¹‰ã€‚
  ä½¿ç”¨é€ƒé€¸åˆ†æï¼Œç¼–è¯‘å™¨å¯ä»¥å¯¹ä»£ç åšå¦‚ä¸‹ä¼˜åŒ–ï¼š

æ ˆä¸Šåˆ†é…ï¼šå°†å †åˆ†é…è½¬åŒ–ä¸ºæ ˆåˆ†é…ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡åœ¨å­ç¨‹åºä¸­è¢«åˆ†é…ï¼Œè¦ä½¿æŒ‡å‘è¯¥å¯¹è±¡çš„æŒ‡é’ˆæ°¸è¿œä¸ä¼šå‘ç”Ÿé€ƒé€¸ï¼Œå¯¹è±¡å¯èƒ½æ˜¯æ ˆä¸Šåˆ†é…çš„å€™é€‰ï¼Œè€Œä¸æ˜¯å †ä¸Šåˆ†é…
åŒæ­¥çœç•¥ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡è¢«å‘ç°åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¢«è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå¯¹äºè¿™ä¸ªå¯¹è±¡çš„æ“ä½œå¯ä»¥ä¸è€ƒè™‘åŒæ­¥ã€‚
åˆ†ç¦»å¯¹è±¡æˆ–æ ‡é‡æ›¿æ¢ï¼šæœ‰çš„å¯¹è±¡å¯èƒ½ä¸éœ€è¦ä½œä¸ºä¸€ä¸ªè¿ç»­çš„å†…å­˜ç»“æ„å­˜åœ¨ä¹Ÿå¯ä»¥è¢«è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå¯¹è±¡çš„éƒ¨åˆ†ï¼ˆæˆ–å…¨éƒ¨ï¼‰å¯ä»¥ä¸å­˜å‚¨åœ¨å†…å­˜ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨CPUå¯„å­˜å™¨ä¸­ã€‚



7.æ ˆä¸Šåˆ†é…
æ ˆä¸Šåˆ†é…ä¸¾ä¾‹

JITç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´æ ¹æ®é€ƒé€¸åˆ†æçš„ç»“æœï¼Œå‘ç°å¦‚æœä¸€ä¸ªå¯¹è±¡å¹¶æ²¡æœ‰é€ƒé€¸å‡ºæ–¹æ³•çš„è¯ï¼Œå°±å¯èƒ½è¢«ä¼˜åŒ–æˆæ ˆä¸Šåˆ†é…ã€‚åˆ†é…å®Œæˆåï¼Œç»§ç»­åœ¨è°ƒç”¨æ ˆå†…æ‰§è¡Œï¼Œæœ€åçº¿ç¨‹ç»“æŸï¼Œæ ˆç©ºé—´è¢«å›æ”¶ï¼Œå±€éƒ¨å˜é‡å¯¹è±¡ä¹Ÿè¢«å›æ”¶ã€‚è¿™æ ·å°±æ— é¡»è¿›è¡Œåƒåœ¾å›æ”¶äº†ã€‚
å¸¸è§çš„æ ˆä¸Šåˆ†é…çš„åœºæ™¯ï¼šåœ¨é€ƒé€¸åˆ†æä¸­ï¼Œå·²ç»è¯´æ˜äº†ï¼Œåˆ†åˆ«æ˜¯ç»™æˆå‘˜å˜é‡èµ‹å€¼ã€æ–¹æ³•è¿”å›å€¼ã€å®ä¾‹å¼•ç”¨ä¼ é€’ã€‚


ä¸¾ä¾‹

è®¾ç½®JVMå‚æ•°ï¼Œè¡¨ç¤ºæœªå¼€å¯é€ƒé€¸åˆ†æ
  package com.peppa.heap;import java.util.concurrent.TimeUnit;/** * æ ˆä¸Šåˆ†é…ï¼š * -Xmx1G -Xms1G -XX:-DoEscapeAnalysis -XX:+PrintGCDetails * å¼€å¯é€ƒé€¸åˆ†æï¼š * -Xmx1G -Xms1G -XX:+DoEscapeAnalysis -XX:+PrintGCDetails */public class StackAllocation &#123;    public static void main(String[] args) throws InterruptedException &#123;        long start = System.currentTimeMillis();        for (int i = 0; i &lt; 10000000; i++) &#123;            alloc();        &#125;        // æŸ¥çœ‹æ‰§è¡Œæ—¶é—´        long end = System.currentTimeMillis();        System.out.println(&quot;èŠ±è´¹çš„æ—¶é—´ä¸ºï¼š &quot; + (end - start) + &quot; ms&quot;);        // ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹å †å†…å­˜ä¸­å¯¹è±¡ä¸ªæ•°ï¼Œçº¿ç¨‹sleep        TimeUnit.MINUTES.sleep(1);    &#125;    private static void alloc() &#123;        User user = new User();//æœªå‘ç”Ÿé€ƒé€¸    &#125;    static class User &#123;        private String name;        private String age;        private String gender;        private String phone;    &#125;&#125;

å‚æ•°ï¼š-Xmx1G -Xms1G -XX:-DoEscapeAnalysis -XX:+PrintGCDetails

è¿è¡Œç»“æœï¼ŒåŒæ—¶è¿˜è§¦å‘äº†GCæ“ä½œ
  [GC (Allocation Failure) [PSYoungGen: 262144K-&gt;728K(305664K)] 262144K-&gt;736K(1005056K), 0.0007353 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] èŠ±è´¹çš„æ—¶é—´ä¸ºï¼š 120 ms


æˆ‘ä»¬å¼€å¯é€ƒé€¸åˆ†æ

å‚æ•°ï¼š-Xmx1G -Xms1G -XX:+DoEscapeAnalysis -XX:+PrintGCDetails

è¿è¡Œç»“æœï¼šæ—¥å¿—æ‰“å°ï¼šå¹¶æ²¡æœ‰å‘ç”Ÿ GC ï¼Œè€—æ—¶5ms ã€‚
  èŠ±è´¹çš„æ—¶é—´ä¸ºï¼š 5 ms



8.åŒæ­¥çœç•¥
æ¦‚è¿°ï¼šçº¿ç¨‹åŒæ­¥çš„ä»£ä»·æ˜¯ç›¸å½“é«˜çš„ï¼ŒåŒæ­¥çš„åæœæ˜¯é™ä½å¹¶å‘æ€§å’Œæ€§èƒ½ã€‚
  åœ¨åŠ¨æ€ç¼–è¯‘åŒæ­¥å—çš„æ—¶å€™ï¼ŒJITç¼–è¯‘å™¨å¯ä»¥å€ŸåŠ©é€ƒé€¸åˆ†ææ¥åˆ¤æ–­åŒæ­¥å—æ‰€ä½¿ç”¨çš„é”å¯¹è±¡æ˜¯å¦åªèƒ½å¤Ÿè¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®è€Œæ²¡æœ‰è¢«å‘å¸ƒåˆ°å…¶ä»–çº¿ç¨‹ã€‚å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆJITç¼–è¯‘å™¨åœ¨ç¼–è¯‘è¿™ä¸ªåŒæ­¥å—çš„æ—¶å€™å°±ä¼šå–æ¶ˆå¯¹è¿™éƒ¨åˆ†ä»£ç çš„åŒæ­¥ã€‚è¿™æ ·å°±èƒ½å¤§å¤§æé«˜å¹¶å‘æ€§å’Œæ€§èƒ½ã€‚è¿™ä¸ªå–æ¶ˆåŒæ­¥çš„è¿‡ç¨‹å°±å«åŒæ­¥çœç•¥ï¼Œä¹Ÿå«é”æ¶ˆé™¤ã€‚
  ä¾‹å¦‚ä¸‹é¢çš„ä»£ç ï¼š
  public void f() &#123;    Object hellis = new Object();    synchronized(hellis) &#123;        System.out.println(hellis);    &#125;&#125;
  ä»£ç ä¸­å¯¹hellisè¿™ä¸ªå¯¹è±¡åŠ é”ï¼Œä½†æ˜¯helliså¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸåªåœ¨f()æ–¹æ³•ä¸­ï¼Œå¹¶ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æ‰€è®¿é—®åˆ°ï¼Œæ‰€ä»¥åœ¨JITç¼–è¯‘é˜¶æ®µå°±ä¼šè¢«ä¼˜åŒ–æ‰ï¼Œä¼˜åŒ–æˆï¼š
  public void f() &#123;    Object hellis = new Object();	System.out.println(hellis);&#125;
  0 new #2 &lt;java/lang/Object&gt;3 dup4 invokespecial #1 &lt;java/lang/Object.&lt;init&gt;&gt;7 astore_18 aload_19 dup10 astore_211 monitorenter12 getstatic #3 &lt;java/lang/System.out&gt;15 aload_116 invokevirtual #4 &lt;java/io/PrintStream.println&gt;19 aload_220 monitorexit21 goto 29 (+8)24 astore_325 aload_226 monitorexit27 aload_328 athrow29 return
  æ³¨æ„ï¼šå­—èŠ‚ç æ–‡ä»¶ä¸­å¹¶æ²¡æœ‰è¿›è¡Œä¼˜åŒ–ï¼Œå¯ä»¥çœ‹åˆ°åŠ é”å’Œé‡Šæ”¾é”çš„æ“ä½œä¾ç„¶å­˜åœ¨ï¼ŒåŒæ­¥çœç•¥æ“ä½œæ˜¯åœ¨è§£é‡Šè¿è¡Œæ—¶å‘ç”Ÿçš„


9.åˆ†ç¦»å¯¹è±¡æˆ–æ ‡é‡æ›¿æ¢
æ ‡é‡ï¼ˆscalarï¼‰æ˜¯æŒ‡ä¸€ä¸ªæ— æ³•å†åˆ†è§£æˆæ›´å°çš„æ•°æ®çš„æ•°æ®ã€‚Javaä¸­çš„åŸå§‹æ•°æ®ç±»å‹å°±æ˜¯æ ‡é‡ã€‚
ç›¸å¯¹çš„ï¼Œé‚£äº›è¿˜å¯ä»¥åˆ†è§£çš„æ•°æ®å«åšèšåˆé‡ï¼ˆAggregateï¼‰ï¼ŒJavaä¸­çš„å¯¹è±¡å°±æ˜¯èšåˆé‡ï¼Œå› ä¸ºä»–å¯ä»¥åˆ†è§£æˆå…¶ä»–èšåˆé‡å’Œæ ‡é‡ã€‚
åœ¨JITé˜¶æ®µï¼Œå¦‚æœç»è¿‡é€ƒé€¸åˆ†æï¼Œå‘ç°ä¸€ä¸ªå¯¹è±¡ä¸ä¼šè¢«å¤–ç•Œè®¿é—®çš„è¯ï¼Œé‚£ä¹ˆç»è¿‡JITä¼˜åŒ–ï¼Œå°±ä¼šæŠŠè¿™ä¸ªå¯¹è±¡æ‹†è§£æˆè‹¥å¹²ä¸ªå…¶ä¸­åŒ…å«çš„è‹¥å¹²ä¸ªæˆå‘˜å˜é‡æ¥ä»£æ›¿ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æ ‡é‡æ›¿æ¢ã€‚


æ ‡é‡æ›¿æ¢ä¸¾ä¾‹

ä»£ç 

  public static void main(String args[]) &#123;    alloc();&#125;class Point &#123;    private int x;    private int y;&#125;private static void alloc() &#123;    Point point = new Point(1,2);    System.out.println(&quot;point.x&quot; + point.x + &quot;;point.y&quot; + point.y);&#125;

ä»¥ä¸Šä»£ç ï¼Œç»è¿‡æ ‡é‡æ›¿æ¢åï¼Œå°±ä¼šå˜æˆ

  private static void alloc() &#123;    int x = 1;    int y = 2;    System.out.println(&quot;point.x = &quot; + x + &quot;; point.y=&quot; + y);&#125;
  å¯ä»¥çœ‹åˆ°ï¼ŒPointè¿™ä¸ªèšåˆé‡ç»è¿‡é€ƒé€¸åˆ†æåï¼Œå‘ç°ä»–å¹¶æ²¡æœ‰é€ƒé€¸ï¼Œå°±è¢«æ›¿æ¢æˆä¸¤ä¸ªèšåˆé‡äº†ã€‚é‚£ä¹ˆæ ‡é‡æ›¿æ¢æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿå°±æ˜¯å¯ä»¥å¤§å¤§å‡å°‘å †å†…å­˜çš„å ç”¨ã€‚å› ä¸ºä¸€æ—¦ä¸éœ€è¦åˆ›å»ºå¯¹è±¡äº†ï¼Œé‚£ä¹ˆå°±ä¸å†éœ€è¦åˆ†é…å †å†…å­˜äº†ã€‚ æ ‡é‡æ›¿æ¢ä¸ºæ ˆä¸Šåˆ†é…æä¾›äº†å¾ˆå¥½çš„åŸºç¡€ã€‚
  

æ ‡é‡æ›¿æ¢å‚æ•°è®¾ç½®
  package com.peppa.heap;/** * ä¸å¼€å¯æ ‡é‡æ›¿æ¢ï¼š *  -Xmx100m -Xms100m -XX:+DoEscapeAnalysis -XX:+PrintGC -XX:-EliminateAllocations * * [GC (Allocation Failure)  25600K-&gt;816K(98304K), 0.0007805 secs] * [GC (Allocation Failure)  26416K-&gt;832K(98304K), 0.0005552 secs] * [GC (Allocation Failure)  26432K-&gt;704K(98304K), 0.0010244 secs] * [GC (Allocation Failure)  26304K-&gt;752K(98304K), 0.0006991 secs] * [GC (Allocation Failure)  26352K-&gt;704K(98304K), 0.0006366 secs] * [GC (Allocation Failure)  26304K-&gt;720K(101376K), 0.0008407 secs] * [GC (Allocation Failure)  32464K-&gt;652K(101376K), 0.0010512 secs] * [GC (Allocation Failure)  32396K-&gt;652K(100352K), 0.0003788 secs] * èŠ±è´¹çš„æ—¶é—´ä¸ºï¼š 64 ms * * å¼€å¯æ ‡é‡æ›¿æ¢ï¼š *  -Xmx100m -Xms100m -XX:+DoEscapeAnalysis -XX:+PrintGC -XX:+EliminateAllocations *  èŠ±è´¹çš„æ—¶é—´ä¸ºï¼š 4 ms */public class ScalarReplace &#123;    public static class User &#123;        public int id;        public String name;    &#125;    public static void alloc() &#123;        User u = new User();//æœªå‘ç”Ÿé€ƒé€¸        u.id = 5;        u.name = &quot;peppa&quot;;    &#125;    public static void main(String[] args) &#123;        long start = System.currentTimeMillis();        for (int i = 0; i &lt; 10000000; i++) &#123;            alloc();        &#125;        long end = System.currentTimeMillis();        System.out.println(&quot;èŠ±è´¹çš„æ—¶é—´ä¸ºï¼š &quot; + (end - start) + &quot; ms&quot;);    &#125;&#125;

é€ƒé€¸åˆ†æçš„ä¸è¶³

å…³äºé€ƒé€¸åˆ†æçš„è®ºæ–‡åœ¨1999å¹´å°±å·²ç»å‘è¡¨äº†ï¼Œä½†ç›´åˆ°JDK1.6æ‰æœ‰å®ç°ï¼Œè€Œä¸”è¿™é¡¹æŠ€æœ¯åˆ°å¦‚ä»Šä¹Ÿå¹¶ä¸æ˜¯ååˆ†æˆç†Ÿçš„ã€‚
å…¶æ ¹æœ¬åŸå› å°±æ˜¯æ— æ³•ä¿è¯é€ƒé€¸åˆ†æçš„æ€§èƒ½æ¶ˆè€—ä¸€å®šèƒ½é«˜äºä»–çš„æ¶ˆè€—ã€‚è™½ç„¶ç»è¿‡é€ƒé€¸åˆ†æå¯ä»¥åšæ ‡é‡æ›¿æ¢ã€æ ˆä¸Šåˆ†é…ã€å’Œé”æ¶ˆé™¤ã€‚ä½†æ˜¯é€ƒé€¸åˆ†æè‡ªèº«ä¹Ÿæ˜¯éœ€è¦è¿›è¡Œä¸€ç³»åˆ—å¤æ‚çš„åˆ†æçš„ï¼Œè¿™å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªç›¸å¯¹è€—æ—¶çš„è¿‡ç¨‹ã€‚
ä¸€ä¸ªæç«¯çš„ä¾‹å­ï¼Œå°±æ˜¯ç»è¿‡é€ƒé€¸åˆ†æä¹‹åï¼Œå‘ç°æ²¡æœ‰ä¸€ä¸ªå¯¹è±¡æ˜¯ä¸é€ƒé€¸çš„ã€‚é‚£è¿™ä¸ªé€ƒé€¸åˆ†æçš„è¿‡ç¨‹å°±ç™½ç™½æµªè´¹æ‰äº†ã€‚
è™½ç„¶è¿™é¡¹æŠ€æœ¯å¹¶ä¸ååˆ†æˆç†Ÿï¼Œä½†æ˜¯å®ƒä¹Ÿæ˜¯å³æ—¶ç¼–è¯‘å™¨ä¼˜åŒ–æŠ€æœ¯ä¸­ä¸€ä¸ªååˆ†é‡è¦çš„æ‰‹æ®µã€‚
æ³¨æ„åˆ°æœ‰ä¸€äº›è§‚ç‚¹ï¼Œè®¤ä¸ºé€šè¿‡é€ƒé€¸åˆ†æï¼ŒJVMä¼šåœ¨æ ˆä¸Šåˆ†é…é‚£äº›ä¸ä¼šé€ƒé€¸çš„å¯¹è±¡ï¼Œè¿™åœ¨ç†è®ºä¸Šæ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯å–å†³äºJVMè®¾è®¡è€…çš„é€‰æ‹©ã€‚æ®æˆ‘æ‰€çŸ¥ï¼ŒOracle Hotspot JVMä¸­å¹¶æœªè¿™ä¹ˆåšï¼ˆåˆšåˆšæ¼”ç¤ºçš„æ•ˆæœï¼Œæ˜¯å› ä¸ºHotSpotå®ç°äº†æ ‡é‡æ›¿æ¢ï¼‰ï¼Œè¿™ä¸€ç‚¹åœ¨é€ƒé€¸åˆ†æç›¸å…³çš„æ–‡æ¡£é‡Œå·²ç»è¯´æ˜ï¼Œæ‰€ä»¥å¯ä»¥æ˜ç¡®åœ¨HotSpotè™šæ‹Ÿæœºä¸Šï¼Œæ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½æ˜¯åˆ›å»ºåœ¨å †ä¸Šã€‚
ç›®å‰å¾ˆå¤šä¹¦ç±è¿˜æ˜¯åŸºäºJDK7ä»¥å‰çš„ç‰ˆæœ¬ï¼ŒJDKå·²ç»å‘ç”Ÿäº†å¾ˆå¤§å˜åŒ–ï¼Œinternå­—ç¬¦ä¸²çš„ç¼“å­˜å’Œé™æ€å˜é‡æ›¾ç»éƒ½è¢«åˆ†é…åœ¨æ°¸ä¹…ä»£ä¸Šï¼Œè€Œæ°¸ä¹…ä»£å·²ç»è¢«å…ƒæ•°æ®åŒºå–ä»£ã€‚ä½†æ˜¯internå­—ç¬¦ä¸²ç¼“å­˜å’Œé™æ€å˜é‡å¹¶ä¸æ˜¯è¢«è½¬ç§»åˆ°å…ƒæ•°æ®åŒºï¼Œè€Œæ˜¯ç›´æ¥åœ¨å †ä¸Šåˆ†é…ï¼Œæ‰€ä»¥è¿™ä¸€ç‚¹åŒæ ·ç¬¦åˆå‰é¢ä¸€ç‚¹çš„ç»“è®ºï¼šå¯¹è±¡å®ä¾‹éƒ½æ˜¯åˆ†é…åœ¨å †ä¸Šã€‚


å°ç»“

å¹´è½»ä»£æ˜¯å¯¹è±¡çš„è¯ç”Ÿã€æˆé•¿ã€æ¶ˆäº¡çš„åŒºåŸŸï¼Œä¸€ä¸ªå¯¹è±¡åœ¨è¿™é‡Œäº§ç”Ÿã€åº”ç”¨ï¼Œæœ€åè¢«åƒåœ¾å›æ”¶å™¨æ”¶é›†ã€ç»“æŸç”Ÿå‘½ã€‚
è€å¹´ä»£æ”¾ç½®é•¿ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡ï¼Œé€šå¸¸éƒ½æ˜¯ä»SurvivoråŒºåŸŸç­›é€‰æ‹·è´è¿‡æ¥çš„Javaå¯¹è±¡ã€‚
å½“ç„¶ï¼Œä¹Ÿæœ‰ç‰¹æ®Šæƒ…å†µï¼Œæˆ‘ä»¬çŸ¥é“æ™®é€šçš„å¯¹è±¡å¯èƒ½ä¼šè¢«åˆ†é…åœ¨TLABä¸Šï¼›
å¦‚æœå¯¹è±¡è¾ƒå¤§ï¼Œæ— æ³•åˆ†é…åœ¨ TLAB ä¸Šï¼Œåˆ™JVMä¼šè¯•å›¾ç›´æ¥åˆ†é…åœ¨Edenå…¶ä»–ä½ç½®ä¸Šï¼›
å¦‚æœå¯¹è±¡å¤ªå¤§ï¼Œå®Œå…¨æ— æ³•åœ¨æ–°ç”Ÿä»£æ‰¾åˆ°è¶³å¤Ÿé•¿çš„è¿ç»­ç©ºé—²ç©ºé—´ï¼ŒJVMå°±ä¼šç›´æ¥åˆ†é…åˆ°è€å¹´ä»£ã€‚
å½“GCåªå‘ç”Ÿåœ¨å¹´è½»ä»£ä¸­ï¼Œå›æ”¶å¹´è½»ä»£å¯¹è±¡çš„è¡Œä¸ºè¢«ç§°ä¸ºMinor GCã€‚
å½“GCå‘ç”Ÿåœ¨è€å¹´ä»£æ—¶åˆ™è¢«ç§°ä¸ºMajor GCæˆ–è€…Full GCã€‚
ä¸€èˆ¬çš„ï¼ŒMinor GCçš„å‘ç”Ÿé¢‘ç‡è¦æ¯”Major GCé«˜å¾ˆå¤šï¼Œå³è€å¹´ä»£ä¸­åƒåœ¾å›æ”¶å‘ç”Ÿçš„é¢‘ç‡å°†å¤§å¤§ä½äºå¹´è½»ä»£ã€‚



]]></content>
      <categories>
        <category>JVMè™šæ‹Ÿæœºè¯¦è§£</category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>JVMè™šæ‹Ÿæœºè¯¦è§£</tag>
      </tags>
  </entry>
  <entry>
    <title>JVMè™šæ‹Ÿæœºè¯¦è§£(å…­)**æœ¬åœ°æ–¹æ³•æ ˆNative Method Stacks</title>
    <url>/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3(%E5%85%AD)%E6%9C%AC%E5%9C%B0%E6%96%B9%E6%B3%95%E6%A0%88Native%20Method%20Stacks/</url>
    <content><![CDATA[JVMè™šæ‹Ÿæœºè¯¦è§£(å…­)æœ¬åœ°æ–¹æ³•æ ˆNative Method Stacks1. æ¦‚è¿°Java è™šæ‹Ÿæœºçš„å®ç°å¯ä»¥ä½¿ç”¨ä¼ ç»Ÿçš„æ ˆ(é€šå¸¸ç§°ä¸ºâ€œ c æ ˆâ€)æ¥æ”¯æŒæœ¬æœºæ–¹æ³•(ç”¨ Java ç¼–ç¨‹è¯­è¨€ä»¥å¤–çš„è¯­è¨€ç¼–å†™çš„æ–¹æ³•)ã€‚æœ¬æœºæ–¹æ³•å †æ ˆä¹Ÿå¯ä»¥ç”¨äº Java è™šæ‹ŸæœºæŒ‡ä»¤é›†çš„è§£é‡Šå™¨çš„å®ç°ï¼Œå¦‚ c è¯­è¨€çš„ Java è™šæ‹Ÿæœºå®ç°ï¼Œä¸èƒ½åŠ è½½æœ¬æœºæ–¹æ³•ï¼Œä¹Ÿä¸ä¾èµ–äºä¼ ç»Ÿçš„å †æ ˆï¼Œä¸éœ€è¦æä¾›æœ¬æœºæ–¹æ³•å †æ ˆã€‚å¦‚æœæä¾›ï¼Œé€šå¸¸åœ¨åˆ›å»ºæ¯ä¸ªçº¿ç¨‹æ—¶ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…æœ¬æœºæ–¹æ³•å †æ ˆã€‚
è¯¥è§„èŒƒå…è®¸æœ¬æœºæ–¹æ³•å †æ ˆå…·æœ‰å›ºå®šçš„å¤§å°ï¼Œæˆ–è€…æ ¹æ®è®¡ç®—çš„éœ€è¦åŠ¨æ€æ‰©å±•å’Œæ”¶ç¼©ã€‚å¦‚æœæœ¬æœºæ–¹æ³•å †æ ˆçš„å¤§å°å›ºå®šï¼Œåˆ™åœ¨åˆ›å»ºè¯¥å †æ ˆæ—¶å¯ä»¥ç‹¬ç«‹é€‰æ‹©æ¯ä¸ªæœ¬æœºæ–¹æ³•å †æ ˆçš„å¤§å°ã€‚
Java è™šæ‹Ÿæœºå®ç°å¯ä»¥ä¸ºç¨‹åºå‘˜æˆ–ç”¨æˆ·æä¾›å¯¹æœ¬æœºæ–¹æ³•å †æ ˆåˆå§‹å¤§å°çš„æ§åˆ¶ï¼Œä»¥åŠå¯¹äºä¸åŒå¤§å°çš„æœ¬æœºæ–¹æ³•å †æ ˆï¼Œå¯¹æœ€å¤§å’Œæœ€å°æ–¹æ³•å †æ ˆå¤§å°çš„æ§åˆ¶ã€‚

ä¸‹é¢çš„å¼‚å¸¸æƒ…å†µä¸æœ¬æœºæ–¹æ³•å †æ ˆç›¸å…³è”:
å¦‚æœçº¿ç¨‹ä¸­çš„è®¡ç®—éœ€è¦æ¯”å…è®¸çš„æ›´å¤§çš„æœ¬æœºæ–¹æ³•å †æ ˆï¼Œé‚£ä¹ˆ Java è™šæ‹ŸæœºæŠ›å‡ºä¸€ä¸ª StackOverflowErrorã€‚
å¦‚æœæœ¬æœºæ–¹æ³•å †æ ˆå¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œæœ¬æœºæ–¹æ³•å †æ ˆæ‰©å±•å¯ä»¥å°è¯•ï¼Œä½†æ˜¯æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å¯ç”¨ï¼Œæˆ–è€…å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å¯ç”¨æ¥ä¸ºæ–°çº¿ç¨‹åˆ›å»ºåˆå§‹çš„æœ¬æœºæ–¹æ³•å †æ ˆï¼ŒJava è™šæ‹Ÿæœºå°†æŠ›å‡º OutOfMemoryErrorã€‚



å®˜ç½‘ï¼šChapterÂ 2.Â The Structure of the Java Virtual Machine (oracle.com)

ç®€å•åœ°è®²ï¼Œä¸€ä¸ªNative Methodtæ˜¯ä¸€ä¸ªJavaè°ƒç”¨éJavaä»£ç çš„æ¥å›—ã€‚ä¸€ä¸ªNative Methodæ˜¯è¿™æ ·ä¸€ä¸ªJavaæ–¹æ³•ï¼šè¯¥æ–¹æ³•çš„å®ç°ç”±éJavaè¯­è¨€å®ç°ï¼Œæ¯”å¦‚Cã€‚è¿™ä¸ªç‰¹å¾å¹¶éJavaæ‰€ç‰¹æœ‰ï¼Œå¾ˆå¤šå…¶å®ƒçš„ç¼–ç¨‹è¯­è¨€éƒ½æœ‰è¿™ä¸€æœºåˆ¶ï¼Œæ¯”å¦‚åœ¨C++ä¸­ï¼Œä½ å¯ä»¥ç”¨extern â€œcâ€ å‘ŠçŸ¥c++ç¼–è¯‘å™¨å»è°ƒç”¨ä¸€ä¸ªcçš„å‡½æ•°ã€‚
â€œA native method is a Java method whose implementation is provided by non-java code.â€ï¼ˆæœ¬åœ°æ–¹æ³•æ˜¯ä¸€ä¸ªéJavaçš„æ–¹æ³•ï¼Œå®ƒçš„å…·ä½“å®ç°æ˜¯éJavaä»£ç çš„å®ç°ï¼‰
åœ¨å®šä¹‰ä¸€ä¸ªnative methodæ—¶ï¼Œå¹¶ä¸æä¾›å®ç°ä½“ï¼ˆæœ‰äº›åƒå®šä¹‰ä¸€ä¸ªJava interfaceï¼‰ï¼Œå› ä¸ºå…¶å®ç°ä½“æ˜¯ç”±éjavaè¯­è¨€åœ¨å¤–é¢å®ç°çš„ã€‚
æœ¬åœ°æ¥å£çš„ä½œç”¨æ˜¯èåˆä¸åŒçš„ç¼–ç¨‹è¯­è¨€ä¸ºJavaæ‰€ç”¨ï¼Œå®ƒçš„åˆè¡·æ˜¯èåˆC&#x2F;C++ç¨‹åºã€‚

ä»£ç ä¸¾ä¾‹è¯´æ˜Nativeæ–¹æ³•æ˜¯å¦‚ä½•ç¼–å†™çš„
  éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæ ‡è¯†ç¬¦nativeå¯ä»¥ä¸å…¶å®ƒjavaæ ‡è¯†ç¬¦è¿ç”¨ï¼Œä½†æ˜¯abstracté™¤å¤–
  public class IHaveNatives &#123;    public native void Native1(int x);    public native static long Native2();    private native synchronized float Native3(Object o);    native void Native4(int[] ary) throws Exception;    &#125;

ä¸ºä»€ä¹ˆä½¿ç”¨Native Methodï¼Ÿ

Javaä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ï¼Œç„¶è€Œæœ‰äº›å±‚æ¬¡çš„ä»»åŠ¡ç”¨Javaå®ç°èµ·æ¥ä¸å®¹æ˜“ï¼Œæˆ–è€…æˆ‘ä»¬å¯¹ç¨‹åºçš„æ•ˆç‡å¾ˆåœ¨æ„æ—¶ï¼Œé—®é¢˜å°±æ¥äº†ã€‚


ä¸Javaç¯å¢ƒçš„äº¤äº’

æœ‰æ—¶Javaåº”ç”¨éœ€è¦ä¸Javaå¤–é¢çš„ç¯å¢ƒäº¤äº’ï¼Œè¿™æ˜¯æœ¬åœ°æ–¹æ³•å­˜åœ¨çš„ä¸»è¦åŸå› ã€‚ä½ å¯ä»¥æƒ³æƒ³Javaéœ€è¦ä¸ä¸€äº›åº•å±‚ç³»ç»Ÿï¼Œå¦‚æ“ä½œç³»ç»Ÿæˆ–æŸäº›ç¡¬ä»¶äº¤æ¢ä¿¡æ¯æ—¶çš„æƒ…å†µã€‚æœ¬åœ°æ–¹æ³•æ­£æ˜¯è¿™æ ·ä¸€ç§äº¤æµæœºåˆ¶ï¼šå®ƒä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªéå¸¸ç®€æ´çš„æ¥å£ï¼Œè€Œä¸”æˆ‘ä»¬æ— éœ€å»äº†è§£Javaåº”ç”¨ä¹‹å¤–çš„ç¹ççš„ç»†èŠ‚ã€‚


ä¸æ“ä½œç³»ç»Ÿçš„äº¤äº’

JVMæ”¯æŒç€Javaè¯­è¨€æœ¬èº«å’Œè¿è¡Œæ—¶åº“ï¼Œå®ƒæ˜¯Javaç¨‹åºèµ–ä»¥ç”Ÿå­˜çš„å¹³å°ï¼Œå®ƒç”±ä¸€ä¸ªè§£é‡Šå™¨ï¼ˆè§£é‡Šå­—èŠ‚ç ï¼‰å’Œä¸€äº›è¿æ¥åˆ°æœ¬åœ°ä»£ç çš„åº“ç»„æˆã€‚ç„¶è€Œä¸ç®¡æ€æ ·ï¼Œå®ƒæ¯•ç«Ÿä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç³»ç»Ÿï¼Œå®ƒç»å¸¸ä¾èµ–äºä¸€åº•å±‚ç³»ç»Ÿçš„æ”¯æŒã€‚è¿™äº›åº•å±‚ç³»ç»Ÿå¸¸å¸¸æ˜¯å¼ºå¤§çš„æ“ä½œç³»ç»Ÿã€‚é€šè¿‡ä½¿ç”¨æœ¬åœ°æ–¹æ³•ï¼Œæˆ‘ä»¬å¾—ä»¥ç”¨Javaå®ç°äº†jreçš„ä¸åº•å±‚ç³»ç»Ÿçš„äº¤äº’ï¼Œç”šè‡³JVMçš„ä¸€äº›éƒ¨åˆ†å°±æ˜¯ç”¨cå†™çš„ã€‚è¿˜æœ‰ï¼Œå¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨ä¸€äº›Javaè¯­è¨€æœ¬èº«æ²¡æœ‰æä¾›å°è£…çš„æ“ä½œç³»ç»Ÿçš„ç‰¹æ€§æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ä½¿ç”¨æœ¬åœ°æ–¹æ³•ã€‚


Sunâ€™s Java

Sunçš„è§£é‡Šå™¨æ˜¯ç”¨Cå®ç°çš„ï¼Œè¿™ä½¿å¾—å®ƒèƒ½åƒä¸€äº›æ™®é€šçš„Cä¸€æ ·ä¸å¤–éƒ¨äº¤äº’ã€‚jreå¤§éƒ¨åˆ†æ˜¯ç”¨Javaå®ç°çš„ï¼Œå®ƒä¹Ÿé€šè¿‡ä¸€äº›æœ¬åœ°æ–¹æ³•ä¸å¤–ç•Œäº¤äº’ã€‚
ä¾‹å¦‚ï¼šç±»java.lang.Threadçš„setPriority()æ–¹æ³•æ˜¯ç”¨Javaå®ç°çš„ï¼Œä½†æ˜¯å®ƒå®ç°è°ƒç”¨çš„æ˜¯è¯¥ç±»é‡Œçš„æœ¬åœ°æ–¹æ³•setPriority0()ã€‚è¿™ä¸ªæœ¬åœ°æ–¹æ³•æ˜¯ç”¨Cå®ç°çš„ï¼Œå¹¶è¢«æ¤å…¥JVMå†…éƒ¨åœ¨Windows 95çš„å¹³å°ä¸Šï¼Œè¿™ä¸ªæœ¬åœ°æ–¹æ³•æœ€ç»ˆå°†è°ƒç”¨Win32 setpriority() APIã€‚è¿™æ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•çš„å…·ä½“å®ç°ç”±JVMç›´æ¥æä¾›ï¼Œæ›´å¤šçš„æƒ…å†µæ˜¯æœ¬åœ°æ–¹æ³•ç”±å¤–éƒ¨çš„åŠ¨æ€é“¾æ¥åº“ï¼ˆexternal dynamic link libraryï¼‰æä¾›ï¼Œç„¶åè¢«JVMè°ƒç”¨ã€‚



]]></content>
      <categories>
        <category>JVMè™šæ‹Ÿæœºè¯¦è§£</category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>JVMè™šæ‹Ÿæœºè¯¦è§£</tag>
      </tags>
  </entry>
  <entry>
    <title>JVMè™šæ‹Ÿæœºè¯¦è§£(å)å¯¹è±¡çš„å®ä¾‹åŒ–å†…å­˜å¸ƒå±€ä¸è®¿é—®å®šä½</title>
    <url>/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3(%E5%8D%81)%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%AE%9E%E4%BE%8B%E5%8C%96%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80%E4%B8%8E%E8%AE%BF%E9%97%AE%E5%AE%9A%E4%BD%8D/</url>
    <content><![CDATA[JVMè™šæ‹Ÿæœºè¯¦è§£(å)å¯¹è±¡çš„å®ä¾‹åŒ–å†…å­˜å¸ƒå±€ä¸è®¿é—®å®šä½1. åˆ›å»ºå¯¹è±¡

å¯¹è±¡åˆ›å»ºæ–¹å¼

newï¼šæœ€å¸¸è§çš„æ–¹å¼ã€å•ä¾‹ç±»ä¸­è°ƒç”¨getInstanceçš„é™æ€ç±»æ–¹æ³•ï¼ŒXXXFactoryçš„é™æ€æ–¹æ³•
Classçš„newInstanceæ–¹æ³•ï¼šåœ¨JDK9é‡Œé¢è¢«æ ‡è®°ä¸ºè¿‡æ—¶çš„æ–¹æ³•ï¼Œå› ä¸ºåªèƒ½è°ƒç”¨ç©ºå‚æ„é€ å™¨
Constructorçš„newInstance(XXX)ï¼šåå°„çš„æ–¹å¼ï¼Œå¯ä»¥è°ƒç”¨ç©ºå‚çš„ï¼Œæˆ–è€…å¸¦å‚çš„æ„é€ å™¨
ä½¿ç”¨clone()ï¼šä¸è°ƒç”¨ä»»ä½•çš„æ„é€ å™¨ï¼Œè¦æ±‚å½“å‰çš„ç±»éœ€è¦å®ç°Cloneableæ¥å£ä¸­çš„cloneæ¥å£
ä½¿ç”¨åºåˆ—åŒ–ï¼šåºåˆ—åŒ–ä¸€èˆ¬ç”¨äºSocketçš„ç½‘ç»œä¼ è¾“
ç¬¬ä¸‰æ–¹åº“ Objenesis


åˆ›å»ºå¯¹è±¡çš„æ­¥éª¤

åˆ¤æ–­å¯¹è±¡å¯¹åº”çš„ç±»æ˜¯å¦åŠ è½½ã€é“¾æ¥ã€åˆå§‹åŒ–
 public static void main(java.lang.String[]);    descriptor: ([Ljava/lang/String;)V    flags: ACC_PUBLIC, ACC_STATIC    Code:      stack=2, locals=2, args_size=1         0: new           #2                  // class java/lang/Object         3: dup         4: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V         7: astore_1         8: return      LineNumberTable:        line 5: 0        line 6: 8      LocalVariableTable:        Start  Length  Slot  Name   Signature            0       9     0  args   [Ljava/lang/String;            8       1     1   obj   Ljava/lang/Object;    MethodParameters:      Name                           Flags      args
 è™šæ‹Ÿæœºé‡åˆ°ä¸€æ¡newæŒ‡ä»¤ï¼Œé¦–å…ˆå»æ£€æŸ¥è¿™ä¸ªæŒ‡ä»¤çš„å‚æ•°èƒ½å¦åœ¨Metaspaceçš„å¸¸é‡æ± ä¸­å®šä½åˆ°ä¸€ä¸ªç±»çš„ç¬¦å·å¼•ç”¨ï¼Œå¹¶ä¸”æ£€æŸ¥è¿™ä¸ªç¬¦å·å¼•ç”¨ä»£è¡¨çš„ç±»æ˜¯å¦å·²ç»è¢«åŠ è½½ï¼Œè§£æå’Œåˆå§‹åŒ–ã€‚ï¼ˆå³åˆ¤æ–­ç±»å…ƒä¿¡æ¯æ˜¯å¦å­˜åœ¨ï¼‰ã€‚å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆåœ¨åŒäº²å§”æ´¾æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨å½“å‰ç±»åŠ è½½å™¨ä»¥ClassLoader + åŒ…å + ç±»åä¸ºkeyè¿›è¡ŒæŸ¥æ‰¾å¯¹åº”çš„ .classæ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ï¼Œåˆ™æŠ›å‡ºClassNotFoundExceptionå¼‚å¸¸ï¼Œå¦‚æœæ‰¾åˆ°ï¼Œåˆ™è¿›è¡Œç±»åŠ è½½ï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„Classå¯¹è±¡ã€‚

ä¸ºå¯¹è±¡åˆ†é…å†…å­˜

é¦–å…ˆè®¡ç®—å¯¹è±¡å ç”¨ç©ºé—´çš„å¤§å°ï¼Œæ¥ç€åœ¨å †ä¸­åˆ’åˆ†ä¸€å—å†…å­˜ç»™æ–°å¯¹è±¡ã€‚å¦‚æœå®ä¾‹æˆå‘˜å˜é‡æ˜¯å¼•ç”¨å˜é‡ï¼Œä»…åˆ†é…å¼•ç”¨å˜é‡ç©ºé—´å³å¯ï¼Œå³4ä¸ªå­—èŠ‚å¤§å°
å¦‚æœå†…å­˜è§„æ•´ï¼šé‡‡ç”¨æŒ‡é’ˆç¢°æ’åˆ†é…å†…å­˜
å¦‚æœå†…å­˜æ˜¯è§„æ•´çš„ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºå°†é‡‡ç”¨çš„æ˜¯æŒ‡é’ˆç¢°æ’æ³•ï¼ˆBump The Pointï¼‰æ¥ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ã€‚
æ„æ€æ˜¯æ‰€æœ‰ç”¨è¿‡çš„å†…å­˜åœ¨ä¸€è¾¹ï¼Œç©ºé—²çš„å†…å­˜æ”¾å¦å¤–ä¸€è¾¹ï¼Œä¸­é—´æ”¾ç€ä¸€ä¸ªæŒ‡é’ˆä½œä¸ºåˆ†ç•Œç‚¹çš„æŒ‡ç¤ºå™¨ï¼Œåˆ†é…å†…å­˜å°±ä»…ä»…æ˜¯æŠŠæŒ‡é’ˆå¾€ç©ºé—²å†…å­˜é‚£è¾¹æŒªåŠ¨ä¸€æ®µä¸å¯¹è±¡å¤§å°ç›¸ç­‰çš„è·ç¦»ç½¢äº†ã€‚
å¦‚æœåƒåœ¾æ”¶é›†å™¨é€‰æ‹©çš„æ˜¯Serial ï¼ŒParNewè¿™ç§åŸºäºå‹ç¼©ç®—æ³•çš„ï¼Œè™šæ‹Ÿæœºé‡‡ç”¨è¿™ç§åˆ†é…æ–¹å¼ã€‚ä¸€èˆ¬ä½¿ç”¨å¸¦Compactï¼ˆæ•´ç†ï¼‰è¿‡ç¨‹çš„æ”¶é›†å™¨æ—¶ï¼Œä½¿ç”¨æŒ‡é’ˆç¢°æ’ã€‚
æ ‡è®°å‹ç¼©ï¼ˆæ•´ç†ï¼‰ç®—æ³•ä¼šæ•´ç†å†…å­˜ç¢ç‰‡ï¼Œå †å†…å­˜ä¸€å­˜å¯¹è±¡ï¼Œå¦ä¸€è¾¹ä¸ºç©ºé—²åŒºåŸŸ


å¦‚æœå†…å­˜ä¸è§„æ•´
å¦‚æœå†…å­˜ä¸æ˜¯è§„æ•´çš„ï¼Œå·²ä½¿ç”¨çš„å†…å­˜å’Œæœªä½¿ç”¨çš„å†…å­˜ç›¸äº’äº¤é”™ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºå°†é‡‡ç”¨çš„æ˜¯ç©ºé—²åˆ—è¡¨æ¥ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ã€‚
æ„æ€æ˜¯è™šæ‹Ÿæœºç»´æŠ¤äº†ä¸€ä¸ªåˆ—è¡¨ï¼Œè®°å½•ä¸Šå“ªäº›å†…å­˜å—æ˜¯å¯ç”¨çš„ï¼Œå†åˆ†é…çš„æ—¶å€™ä»åˆ—è¡¨ä¸­æ‰¾åˆ°ä¸€å—è¶³å¤Ÿå¤§çš„ç©ºé—´åˆ’åˆ†ç»™å¯¹è±¡å®ä¾‹ï¼Œå¹¶æ›´æ–°åˆ—è¡¨ä¸Šçš„å†…å®¹ã€‚è¿™ç§åˆ†é…æ–¹å¼æˆä¸ºäº† â€œç©ºé—²åˆ—è¡¨ï¼ˆFree Listï¼‰â€
é€‰æ‹©å“ªç§åˆ†é…æ–¹å¼ç”±Javaå †æ˜¯å¦è§„æ•´æ‰€å†³å®šï¼Œè€ŒJavaå †æ˜¯å¦è§„æ•´åˆç”±æ‰€é‡‡ç”¨çš„åƒåœ¾æ”¶é›†å™¨æ˜¯å¦å¸¦æœ‰å‹ç¼©æ•´ç†åŠŸèƒ½å†³å®š
æ ‡è®°æ¸…é™¤ç®—æ³•æ¸…ç†è¿‡åçš„å †å†…å­˜ï¼Œå°±ä¼šå­˜åœ¨å¾ˆå¤šå†…å­˜ç¢ç‰‡ã€‚




å¤„ç†å¹¶å‘é—®é¢˜

é‡‡ç”¨CAS+å¤±è´¥é‡è¯•ä¿è¯æ›´æ–°çš„åŸå­æ€§
æ¯ä¸ªçº¿ç¨‹é¢„å…ˆåˆ†é…TLAB - é€šè¿‡è®¾ç½® -XX:+UseTLABå‚æ•°æ¥è®¾ç½®ï¼ˆåŒºåŸŸåŠ é”æœºåˆ¶ï¼‰
åœ¨EdenåŒºç»™æ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€å—åŒºåŸŸ


åˆå§‹åŒ–åˆ†é…åˆ°çš„ç©ºé—´

æ‰€æœ‰å±æ€§è®¾ç½®é»˜è®¤å€¼ï¼Œä¿è¯å¯¹è±¡å®ä¾‹å­—æ®µåœ¨ä¸èµ‹å€¼å¯ä»¥ç›´æ¥ä½¿ç”¨
ç»™å¯¹è±¡å±æ€§èµ‹å€¼çš„é¡ºåºï¼š
å±æ€§çš„é»˜è®¤å€¼åˆå§‹åŒ–
æ˜¾ç¤ºåˆå§‹åŒ–&#x2F;ä»£ç å—åˆå§‹åŒ–ï¼ˆå¹¶åˆ—å…³ç³»ï¼Œè°å…ˆè°åçœ‹ä»£ç ç¼–å†™çš„é¡ºåºï¼‰
æ„é€ å™¨åˆå§‹åŒ–




ç½®å¯¹è±¡çš„å¯¹è±¡å¤´
 å°†å¯¹è±¡çš„æ‰€å±ç±»ï¼ˆå³ç±»çš„å…ƒæ•°æ®ä¿¡æ¯ï¼‰ã€å¯¹è±¡çš„HashCodeå’Œå¯¹è±¡çš„GCä¿¡æ¯ã€é”ä¿¡æ¯ç­‰æ•°æ®å­˜å‚¨åœ¨å¯¹è±¡çš„å¯¹è±¡å¤´ä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹çš„å…·ä½“è®¾ç½®æ–¹å¼å–å†³äºJVMå®ç°ã€‚


  6.æ‰§è¡Œinitæ–¹æ³•è¿›è¡Œåˆå§‹åŒ–

åœ¨Javaç¨‹åºçš„è§†è§’çœ‹æ¥ï¼Œåˆå§‹åŒ–æ‰æ­£å¼å¼€å§‹ã€‚åˆå§‹åŒ–æˆå‘˜å˜é‡ï¼Œæ‰§è¡Œå®ä¾‹åŒ–ä»£ç å—ï¼Œè°ƒç”¨ç±»çš„æ„é€ æ–¹æ³•ï¼Œå¹¶æŠŠå †å†…å¯¹è±¡çš„é¦–åœ°å€èµ‹å€¼ç»™å¼•ç”¨å˜é‡
å› æ­¤ä¸€èˆ¬æ¥è¯´ï¼ˆç”±å­—èŠ‚ç ä¸­è·ŸéšinvokespecialæŒ‡ä»¤æ‰€å†³å®šï¼‰ï¼ŒnewæŒ‡ä»¤ä¹‹åä¼šæ¥ç€å°±æ˜¯æ‰§è¡Œinitæ–¹æ³•ï¼ŒæŠŠå¯¹è±¡æŒ‰ç…§ç¨‹åºå‘˜çš„æ„æ„¿è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™æ ·ä¸€ä¸ªçœŸæ­£å¯ç”¨çš„å¯¹è±¡æ‰ç®—å®Œæˆåˆ›å»ºå‡ºæ¥ã€‚

  ä»å­—èŠ‚ç è§’åº¦çœ‹ init æ–¹æ³•
  æºä»£ç 
  package com.peppa.area;public class Customer &#123;    int id = 1001;    String name;    Account acct;    &#123;        name = &quot;åŒ¿åå®¢æˆ·&quot;;    &#125;    public Customer()&#123;        acct = new Account();    &#125;&#125;class Account&#123;&#125;
  å­—èŠ‚ç 
  0: aload_01: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V4: aload_05: sipush        10018: putfield      #2                  // Field id:I11: aload_012: ldc           #3                  // String åŒ¿åå®¢æˆ·14: putfield      #4                  // Field name:Ljava/lang/String;17: aload_018: new           #5                  // class com/peppa/area/Account21: dup22: invokespecial #6                  // Method com/peppa/area/Account.&quot;&lt;init&gt;&quot;:()V25: putfield      #7                  // Field acct:Lcom/peppa/area/Account;28: return

init() æ–¹æ³•çš„å­—èŠ‚ç æŒ‡ä»¤ï¼š
å±æ€§çš„é»˜è®¤å€¼åˆå§‹åŒ–ï¼šid = 1001;
æ˜¾ç¤ºåˆå§‹åŒ–&#x2F;ä»£ç å—åˆå§‹åŒ–ï¼šname = &quot;åŒ¿åå®¢æˆ·&quot;;
æ„é€ å™¨åˆå§‹åŒ–ï¼šacct = new Account();



2. å¯¹è±¡çš„å†…å­˜å¸ƒå±€
å¯¹è±¡çš„å†…å­˜å¸ƒå±€æ€ç»´å¯¼å›¾
  

å¯¹è±¡å¤´

å¯¹è±¡å¤´åŒ…å«äº†ä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯ è¿è¡Œæ—¶å…ƒæ•°æ®ï¼ˆMark Wordï¼‰å’Œ ç±»å‹æŒ‡é’ˆ
å¦‚æœæ˜¯æ•°ç»„ï¼Œè¿˜éœ€è¦è®°å½•æ•°ç»„çš„é•¿åº¦


è¿è¡Œæ—¶å…ƒæ•°æ®
å“ˆå¸Œå€¼ï¼ˆHashCodeï¼‰
GCåˆ†ä»£å¹´é¾„
é”çŠ¶æ€æ ‡å¿—
çº¿ç¨‹æŒæœ‰çš„é”
åå‘çº¿ç¨‹ID
ç¿©å‘æ—¶é—´æˆ³


ç±»å‹æŒ‡é’ˆ
æŒ‡å‘ç±»å…ƒæ•°æ®InstanceKlassï¼Œç¡®å®šè¯¥å¯¹è±¡æ‰€å±çš„ç±»å‹ã€‚æŒ‡å‘çš„å…¶å®æ˜¯æ–¹æ³•åŒºä¸­å­˜æ”¾çš„ç±»å…ƒä¿¡æ¯




å›¾è§£å†…å­˜å¸ƒå±€


  

å¯¹è±¡çš„è®¿é—®å®šä½
JVMæ˜¯å¦‚ä½•é€šè¿‡æ ˆå¸§ä¸­çš„å¯¹è±¡å¼•ç”¨è®¿é—®åˆ°å…¶å†…éƒ¨çš„å¯¹è±¡å®ä¾‹å‘¢ï¼Ÿ
  å®šä½ï¼Œé€šè¿‡æ ˆä¸Šreferenceè®¿é—®
  

å¯¹è±¡çš„ä¸¤ç§è®¿é—®æ–¹å¼ï¼šå¥æŸ„è®¿é—®å’Œç›´æ¥æŒ‡é’ˆ

å¥æŸ„è®¿é—®

ç¼ºç‚¹ï¼šåœ¨å †ç©ºé—´ä¸­å¼€è¾Ÿäº†ä¸€å—ç©ºé—´ä½œä¸ºå¥æŸ„æ± ï¼Œå¥æŸ„æ± æœ¬èº«ä¹Ÿä¼šå ç”¨ç©ºé—´ï¼›é€šè¿‡ä¸¤æ¬¡æŒ‡é’ˆè®¿é—®æ‰èƒ½è®¿é—®åˆ°å †ä¸­çš„å¯¹è±¡ï¼Œæ•ˆç‡ä½
ä¼˜ç‚¹ï¼šreferenceä¸­å­˜å‚¨ç¨³å®šå¥æŸ„åœ°å€ï¼Œå¯¹è±¡è¢«ç§»åŠ¨ï¼ˆåƒåœ¾æ”¶é›†æ—¶ç§»åŠ¨å¯¹è±¡å¾ˆæ™®éï¼‰æ—¶åªä¼šæ”¹å˜å¥æŸ„ä¸­å®ä¾‹æ•°æ®æŒ‡é’ˆå³å¯ï¼Œreferenceæœ¬èº«ä¸éœ€è¦è¢«ä¿®æ”¹

  



ç›´æ¥æŒ‡é’ˆï¼ˆHotSpoté‡‡ç”¨ï¼‰

ä¼˜ç‚¹ï¼šç›´æ¥æŒ‡é’ˆæ˜¯å±€éƒ¨å˜é‡è¡¨ä¸­çš„å¼•ç”¨ï¼Œç›´æ¥æŒ‡å‘å †ä¸­çš„å®ä¾‹ï¼Œåœ¨å¯¹è±¡å®ä¾‹ä¸­æœ‰ç±»å‹æŒ‡é’ˆï¼ŒæŒ‡å‘çš„æ˜¯æ–¹æ³•åŒºä¸­çš„å¯¹è±¡ç±»å‹æ•°æ®

ç¼ºç‚¹ï¼šå¯¹è±¡è¢«ç§»åŠ¨ï¼ˆåƒåœ¾æ”¶é›†æ—¶ç§»åŠ¨å¯¹è±¡å¾ˆæ™®éï¼‰æ—¶éœ€è¦ä¿®æ”¹ reference çš„å€¼
 








]]></content>
      <categories>
        <category>JVMè™šæ‹Ÿæœºè¯¦è§£</category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>JVMè™šæ‹Ÿæœºè¯¦è§£</tag>
      </tags>
  </entry>
  <entry>
    <title>JVMè™šæ‹Ÿæœºè¯¦è§£(å)å¯¹è±¡çš„å®ä¾‹åŒ–å†…å­˜å¸ƒå±€ä¸è®¿é—®å®šä½</title>
    <url>/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3(%E5%8D%81%E4%B8%80)%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8EExecution%20Engine/</url>
    <content><![CDATA[JVMè™šæ‹Ÿæœºè¯¦è§£(åä¸€)æ‰§è¡Œå¼•æ“Execution Engine1. æ‰§è¡Œå¼•æ“æ¦‚è¿°
æ¦‚è¿°

æ‰§è¡Œå¼•æ“å±äºJVMçš„ä¸‹å±‚ï¼Œé‡Œé¢åŒ…æ‹¬ è§£é‡Šå™¨ã€åŠæ—¶ç¼–è¯‘å™¨ã€åƒåœ¾å›æ”¶å™¨
æ‰§è¡Œå¼•æ“æ˜¯Javaè™šæ‹Ÿæœºæ ¸å¿ƒçš„ç»„æˆéƒ¨åˆ†ä¹‹ä¸€ã€‚â€œè™šæ‹Ÿæœºâ€æ˜¯ä¸€ä¸ªç›¸å¯¹äºâ€œç‰©ç†æœºâ€çš„æ¦‚å¿µï¼Œè¿™ä¸¤ç§æœºå™¨éƒ½æœ‰ä»£ç æ‰§è¡Œèƒ½åŠ›ï¼Œå…¶åŒºåˆ«æ˜¯ç‰©ç†æœºçš„æ‰§è¡Œå¼•æ“æ˜¯ç›´æ¥å»ºç«‹åœ¨å¤„ç†å™¨ã€ç¼“å­˜ã€æŒ‡ä»¤é›†å’Œæ“ä½œç³»ç»Ÿå±‚é¢ä¸Šçš„ï¼Œè€Œè™šæ‹Ÿæœºçš„æ‰§è¡Œå¼•æ“åˆ™æ˜¯ç”±è½¯ä»¶è‡ªè¡Œå®ç°çš„ï¼Œå› æ­¤å¯ä»¥ä¸å—ç‰©ç†æ¡ä»¶åˆ¶çº¦åœ°å®šåˆ¶æŒ‡ä»¤é›†ä¸æ‰§è¡Œå¼•æ“çš„ç»“æ„ä½“ç³»ï¼Œèƒ½å¤Ÿæ‰§è¡Œé‚£äº›ä¸è¢«ç¡¬ä»¶ç›´æ¥æ”¯æŒçš„æŒ‡ä»¤é›†æ ¼å¼ã€‚

  
  JVMçš„ä¸»è¦ä»»åŠ¡æ˜¯è´Ÿè´£è£…è½½å­—èŠ‚ç åˆ°å…¶å†…éƒ¨ï¼Œä½†å­—èŠ‚ç å¹¶ä¸èƒ½å¤Ÿç›´æ¥è¿è¡Œåœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šï¼Œå› ä¸ºå­—èŠ‚ç æŒ‡ä»¤å¹¶éç­‰ä»·äºæœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼Œå®ƒå†…éƒ¨åŒ…å«çš„ä»…ä»…åªæ˜¯ä¸€äº›èƒ½å¤Ÿè¢«JVMæ‰€è¯†åˆ«çš„å­—èŠ‚ç æŒ‡ä»¤ã€ç¬¦å·è¡¨ï¼Œä»¥åŠå…¶ä»–è¾…åŠ©ä¿¡æ¯ã€‚
  
  é‚£ä¹ˆï¼Œå¦‚æœæƒ³è¦è®©ä¸€ä¸ªJavaç¨‹åºè¿è¡Œèµ·æ¥ï¼Œæ‰§è¡Œå¼•æ“ï¼ˆExecution Engineï¼‰çš„ä»»åŠ¡å°±æ˜¯å°†å­—èŠ‚ç æŒ‡ä»¤è§£é‡Š&#x2F;ç¼–è¯‘ä¸ºå¯¹åº”å¹³å°ä¸Šçš„æœ¬åœ°æœºå™¨æŒ‡ä»¤æ‰å¯ä»¥ã€‚ç®€å•æ¥è¯´ï¼ŒJVMä¸­çš„æ‰§è¡Œå¼•æ“å……å½“äº†å°†é«˜çº§è¯­è¨€ç¿»è¯‘ä¸ºæœºå™¨è¯­è¨€çš„è¯‘è€…ã€‚
  

æ‰§è¡Œå¼•æ“çš„å·¥ä½œæµç¨‹

æ‰§è¡Œå¼•æ“åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ç©¶ç«Ÿéœ€è¦æ‰§è¡Œä»€ä¹ˆæ ·çš„å­—èŠ‚ç æŒ‡ä»¤å®Œå…¨ä¾èµ–äºPCå¯„å­˜å™¨ã€‚
æ¯å½“æ‰§è¡Œå®Œä¸€é¡¹æŒ‡ä»¤æ“ä½œåï¼ŒPCå¯„å­˜å™¨å°±ä¼šæ›´æ–°ä¸‹ä¸€æ¡éœ€è¦è¢«æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ã€‚
å½“ç„¶æ–¹æ³•åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæ‰§è¡Œå¼•æ“æœ‰å¯èƒ½ä¼šé€šè¿‡å­˜å‚¨åœ¨å±€éƒ¨å˜é‡è¡¨ä¸­çš„å¯¹è±¡å¼•ç”¨å‡†ç¡®å®šä½åˆ°å­˜å‚¨åœ¨Javaå †åŒºä¸­çš„å¯¹è±¡å®ä¾‹ä¿¡æ¯ï¼Œä»¥åŠé€šè¿‡å¯¹è±¡å¤´ä¸­çš„å…ƒæ•°æ®æŒ‡é’ˆå®šä½åˆ°ç›®æ ‡å¯¹è±¡çš„ç±»å‹ä¿¡æ¯ã€‚

  
  ä»å¤–è§‚ä¸Šæ¥çœ‹ï¼Œæ‰€æœ‰çš„Javaè™šæ‹Ÿæœºçš„æ‰§è¡Œå¼•æ“è¾“å…¥ï¼Œè¾“å‡ºéƒ½æ˜¯ä¸€è‡´çš„ï¼šè¾“å…¥çš„æ˜¯å­—èŠ‚ç äºŒè¿›åˆ¶æµï¼Œå¤„ç†è¿‡ç¨‹æ˜¯å­—èŠ‚ç è§£ææ‰§è¡Œçš„ç­‰æ•ˆè¿‡ç¨‹ï¼Œè¾“å‡ºçš„æ˜¯æ‰§è¡Œè¿‡ç¨‹ã€‚


2.Javaä»£ç ç¼–è¯‘å’Œæ‰§è¡Œè¿‡ç¨‹
ç¼–è¯‘å’Œæ‰§è¡Œè¿‡ç¨‹

å¤§éƒ¨åˆ†çš„ç¨‹åºä»£ç è½¬æ¢æˆç‰©ç†æœºçš„ç›®æ ‡ä»£ç æˆ–è™šæ‹Ÿæœºèƒ½æ‰§è¡Œçš„æŒ‡ä»¤é›†ä¹‹å‰ï¼Œéƒ½éœ€è¦ç»è¿‡ä¸Šå›¾ä¸­çš„å„ä¸ªæ­¥éª¤

å‰é¢æ©™è‰²éƒ¨åˆ†æ˜¯ç”Ÿæˆå­—èŠ‚ç æ–‡ä»¶çš„è¿‡ç¨‹ï¼Œå’ŒJVMæ— å…³

åé¢è“è‰²å’Œç»¿è‰²æ‰æ˜¯JVMéœ€è¦è€ƒè™‘çš„è¿‡ç¨‹
  



Javaä»£ç ç¼–è¯‘æ˜¯ç”±Javaæºç ç¼–è¯‘å™¨æ¥å®Œæˆï¼Œæµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š


  

Javaå­—èŠ‚ç çš„æ‰§è¡Œæ˜¯ç”±JVMæ‰§è¡Œå¼•æ“æ¥å®Œæˆï¼Œæµç¨‹å›¾ å¦‚ä¸‹æ‰€ç¤º

  

æˆ‘ä»¬ç”¨ä¸€ä¸ªæ€»çš„å›¾ï¼Œæ¥è¯´è¯´ è§£é‡Šå™¨å’Œç¼–è¯‘å™¨





ä»€ä¹ˆæ˜¯è§£é‡Šå™¨ï¼ˆInterpreterï¼‰
  å½“Javaè™šæ‹Ÿæœºå¯åŠ¨æ—¶ä¼šæ ¹æ®é¢„å®šä¹‰çš„è§„èŒƒå¯¹å­—èŠ‚ç é‡‡ç”¨é€è¡Œè§£é‡Šçš„æ–¹å¼æ‰§è¡Œï¼Œå°†æ¯æ¡å­—èŠ‚ç æ–‡ä»¶ä¸­çš„å†…å®¹â€œç¿»è¯‘â€ä¸ºå¯¹åº”å¹³å°çš„æœ¬åœ°æœºå™¨æŒ‡ä»¤æ‰§è¡Œã€‚

ä»€ä¹ˆæ˜¯JITç¼–è¯‘å™¨

JITï¼ˆJust In Time Compilerï¼‰ç¼–è¯‘å™¨ï¼šå°±æ˜¯è™šæ‹Ÿæœºå°†æºä»£ç ç›´æ¥ç¼–è¯‘æˆå’Œæœ¬åœ°æœºå™¨å¹³å°ç›¸å…³çš„æœºå™¨è¯­è¨€ã€‚


ä¸ºä»€ä¹ˆJavaæ˜¯åŠç¼–è¯‘åŠè§£é‡Šå‹è¯­è¨€
  JDK1.eæ—¶ä»£ï¼Œå°†Javaè¯­è¨€å®šä½ä¸ºâ€œè§£é‡Šæ‰§è¡Œâ€è¿˜æ˜¯æ¯”è¾ƒå‡†ç¡®çš„ã€‚å†åæ¥ï¼ŒJavaä¹Ÿå‘å±•å‡ºå¯ä»¥ç›´æ¥ç”Ÿæˆæœ¬åœ°ä»£ç çš„ç¼–è¯‘å™¨ã€‚ç°åœ¨JVMåœ¨æ‰§è¡ŒJavaä»£ç çš„æ—¶å€™ï¼Œé€šå¸¸éƒ½ä¼šå°†è§£é‡Šæ‰§è¡Œä¸ç¼–è¯‘æ‰§è¡ŒäºŒè€…ç»“åˆèµ·æ¥è¿›è¡Œã€‚
  ç¿»è¯‘æˆæœ¬åœ°ä»£ç åï¼Œå°±å¯ä»¥åšä¸€ä¸ªç¼“å­˜æ“ä½œï¼Œå­˜å‚¨åœ¨æ–¹æ³•åŒºä¸­

æœºå™¨ç ã€æŒ‡ä»¤ã€æ±‡ç¼–è¯­è¨€

æœºå™¨ç 
  å„ç§ç”¨äºŒè¿›åˆ¶ç¼–ç æ–¹å¼è¡¨ç¤ºçš„æŒ‡ä»¤ï¼Œå«åšæœºå™¨æŒ‡ä»¤ç ã€‚å¼€å§‹ï¼Œäººä»¬å°±ç”¨å®ƒé‡‡ç¼–å†™ç¨‹åºï¼Œè¿™å°±æ˜¯æœºå™¨è¯­è¨€ã€‚
  æœºå™¨è¯­è¨€è™½ç„¶èƒ½å¤Ÿè¢«è®¡ç®—æœºç†è§£å’Œæ¥å—ï¼Œä½†å’Œäººä»¬çš„è¯­è¨€å·®åˆ«å¤ªå¤§ï¼Œä¸æ˜“è¢«äººä»¬ç†è§£å’Œè®°å¿†ï¼Œå¹¶ä¸”ç”¨å®ƒç¼–ç¨‹å®¹æ˜“å‡ºå·®é”™ã€‚
  ç”¨å®ƒç¼–å†™çš„ç¨‹åºä¸€ç»è¾“å…¥è®¡ç®—æœºï¼ŒCPUç›´æ¥è¯»å–è¿è¡Œï¼Œå› æ­¤å’Œå…¶ä»–è¯­è¨€ç¼–çš„ç¨‹åºç›¸æ¯”ï¼Œæ‰§è¡Œé€Ÿåº¦æœ€å¿«ã€‚
  æœºå™¨æŒ‡ä»¤ä¸CPUç´§å¯†ç›¸å…³ï¼Œæ‰€ä»¥ä¸åŒç§ç±»çš„CPUæ‰€å¯¹åº”çš„æœºå™¨æŒ‡ä»¤ä¹Ÿå°±ä¸åŒã€‚

æŒ‡ä»¤
  ç”±äºæœºå™¨ç æ˜¯æœ‰0å’Œ1ç»„æˆçš„äºŒè¿›åˆ¶åºåˆ—ï¼Œå¯è¯»æ€§å®åœ¨å¤ªå·®ï¼Œäºæ˜¯äººä»¬å‘æ˜äº†æŒ‡ä»¤ã€‚
  æŒ‡ä»¤å°±æ˜¯æŠŠæœºå™¨ç ä¸­ç‰¹å®šçš„0å’Œ1åºåˆ—ï¼Œç®€åŒ–æˆå¯¹åº”çš„æŒ‡ä»¤ï¼ˆä¸€èˆ¬ä¸ºè‹±æ–‡ç®€å†™ï¼Œå¦‚movï¼Œincç­‰ï¼‰ï¼Œå¯è¯»æ€§ç¨å¥½
  ç”±äºä¸åŒçš„ç¡¬ä»¶å¹³å°ï¼Œæ‰§è¡ŒåŒä¸€ä¸ªæ“ä½œï¼Œå¯¹åº”çš„æœºå™¨ç å¯èƒ½ä¸åŒï¼Œæ‰€ä»¥ä¸åŒçš„ç¡¬ä»¶å¹³å°çš„åŒä¸€ç§æŒ‡ä»¤ï¼ˆæ¯”å¦‚movï¼‰ï¼Œå¯¹åº”çš„æœºå™¨ç ä¹Ÿå¯èƒ½ä¸åŒã€‚

æŒ‡ä»¤é›†
  ä¸åŒçš„ç¡¬ä»¶å¹³å°ï¼Œå„è‡ªæ”¯æŒçš„æŒ‡ä»¤ï¼Œæ˜¯æœ‰å·®åˆ«çš„ã€‚å› æ­¤æ¯ä¸ªå¹³å°æ‰€æ”¯æŒçš„æŒ‡ä»¤ï¼Œç§°ä¹‹ä¸ºå¯¹åº”å¹³å°çš„æŒ‡ä»¤é›†ã€‚ å¦‚å¸¸è§çš„

x86æŒ‡ä»¤é›†ï¼Œå¯¹åº”çš„æ˜¯x86æ¶æ„çš„å¹³å°
ARMæŒ‡ä»¤é›†ï¼Œå¯¹åº”çš„æ˜¯ARMæ¶æ„çš„å¹³å°


æ±‡ç¼–è¯­è¨€
  ç”±äºæŒ‡ä»¤çš„å¯è¯»æ€§è¿˜æ˜¯å¤ªå·®ï¼Œäºæ˜¯äººä»¬åˆå‘æ˜äº†æ±‡ç¼–è¯­è¨€ã€‚
  åœ¨æ±‡ç¼–è¯­è¨€ä¸­ï¼Œç”¨åŠ©è®°ç¬¦ï¼ˆMnemonicsï¼‰ä»£æ›¿æœºå™¨æŒ‡ä»¤çš„æ“ä½œç ï¼Œç”¨åœ°å€ç¬¦å·ï¼ˆSymbo1ï¼‰æˆ–æ ‡å·ï¼ˆLabe1ï¼‰ä»£æ›¿æŒ‡ä»¤æˆ–æ“ä½œæ•°çš„åœ°å€ã€‚åœ¨ä¸åŒçš„ç¡¬ä»¶å¹³å°ï¼Œæ±‡ç¼–è¯­è¨€å¯¹åº”ç€ä¸åŒçš„æœºå™¨è¯­è¨€æŒ‡ä»¤é›†ï¼Œé€šè¿‡æ±‡ç¼–è¿‡ç¨‹è½¬æ¢æˆæœºå™¨æŒ‡ä»¤ã€‚

ç”±äºè®¡ç®—æœºåªè®¤è¯†æŒ‡ä»¤ç ï¼Œæ‰€ä»¥ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™çš„ç¨‹åºè¿˜å¿…é¡»ç¿»è¯‘æˆæœºå™¨æŒ‡ä»¤ç ï¼Œè®¡ç®—æœºæ‰èƒ½è¯†åˆ«å’Œæ‰§è¡Œã€‚





3.é«˜çº§è¯­è¨€
é«˜çº§è®¡ç®—æœºè¯­è¨€
  ä¸ºäº†ä½¿è®¡ç®—æœºç”¨æˆ·ç¼–ç¨‹åºæ›´å®¹æ˜“äº›ï¼Œåæ¥å°±å‡ºç°äº†å„ç§é«˜çº§è®¡ç®—æœºè¯­è¨€ã€‚
  é«˜çº§è¯­è¨€æ¯”æœºå™¨è¯­è¨€ã€æ±‡ç¼–è¯­è¨€æ›´æ¥è¿‘äººçš„è¯­è¨€å½“è®¡ç®—æœºæ‰§è¡Œé«˜çº§è¯­è¨€ç¼–å†™çš„ç¨‹åºæ—¶ï¼Œä»ç„¶éœ€è¦æŠŠç¨‹åºè§£é‡Šå’Œç¼–è¯‘æˆæœºå™¨çš„æŒ‡ä»¤ç ã€‚å®Œæˆè¿™ä¸ªè¿‡ç¨‹çš„ç¨‹åºå°±å«åšè§£é‡Šç¨‹åºæˆ–ç¼–è¯‘ç¨‹åºã€‚



é«˜çº§è¯­è¨€ä¹Ÿä¸æ˜¯ç›´æ¥ç¿»è¯‘æˆ æœºå™¨æŒ‡ä»¤ï¼Œè€Œæ˜¯ç¿»è¯‘æˆæ±‡ç¼–è¯­è¨€å—ï¼Œå¦‚ä¸‹é¢è¯´çš„Cå’ŒC++

Cã€C++æºç¨‹åºæ‰§è¡Œè¿‡ç¨‹
  ç¼–è¯‘è¿‡ç¨‹åˆå¯ä»¥åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼šç¼–è¯‘å’Œæ±‡ç¼–ã€‚
  ç¼–è¯‘è¿‡ç¨‹ï¼šæ˜¯è¯»å–æºç¨‹åºï¼ˆå­—ç¬¦æµï¼‰ï¼Œå¯¹ä¹‹è¿›è¡Œè¯æ³•å’Œè¯­æ³•çš„åˆ†æï¼Œå°†é«˜çº§è¯­è¨€æŒ‡ä»¤è½¬æ¢ä¸ºåŠŸèƒ½ç­‰æ•ˆçš„æ±‡ç¼–ä»£ç 
  æ±‡ç¼–è¿‡ç¨‹ï¼šå®é™…ä¸ŠæŒ‡æŠŠæ±‡ç¼–è¯­è¨€ä»£ç ç¿»è¯‘æˆç›®æ ‡æœºå™¨æŒ‡ä»¤çš„è¿‡ç¨‹ã€‚
  

å­—èŠ‚ç 
  å­—èŠ‚ç æ˜¯ä¸€ç§ä¸­é—´çŠ¶æ€ï¼ˆä¸­é—´ç ï¼‰çš„äºŒè¿›åˆ¶ä»£ç ï¼ˆæ–‡ä»¶ï¼‰ï¼Œå®ƒæ¯”æœºå™¨ç æ›´æŠ½è±¡ï¼Œéœ€è¦ç›´è¯‘å™¨è½¬è¯‘åæ‰èƒ½æˆä¸ºæœºå™¨ç 
  å­—èŠ‚ç ä¸»è¦ä¸ºäº†å®ç°ç‰¹å®šè½¯ä»¶è¿è¡Œå’Œè½¯ä»¶ç¯å¢ƒã€ä¸ç¡¬ä»¶ç¯å¢ƒæ— å…³ã€‚
  å­—èŠ‚ç çš„å®ç°æ–¹å¼æ˜¯é€šè¿‡ç¼–è¯‘å™¨å’Œè™šæ‹Ÿæœºå™¨ã€‚ç¼–è¯‘å™¨å°†æºç ç¼–è¯‘æˆå­—èŠ‚ç ï¼Œç‰¹å®šå¹³å°ä¸Šçš„è™šæ‹Ÿæœºå™¨å°†å­—èŠ‚ç è½¬è¯‘ä¸ºå¯ä»¥ç›´æ¥æ‰§è¡Œçš„æŒ‡ä»¤ã€‚

å­—èŠ‚ç å…¸å‹çš„åº”ç”¨ä¸ºï¼šJava bytecode


è§£é‡Šå™¨
  JVMè®¾è®¡è€…ä»¬çš„åˆè¡·ä»…ä»…åªæ˜¯å•çº¯åœ°ä¸ºäº†æ»¡è¶³Javaç¨‹åºå®ç°è·¨å¹³å°ç‰¹æ€§ï¼Œå› æ­¤é¿å…é‡‡ç”¨é™æ€ç¼–è¯‘çš„æ–¹å¼ç›´æ¥ç”Ÿæˆæœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼Œä»è€Œè¯ç”Ÿäº†å®ç°è§£é‡Šå™¨åœ¨è¿è¡Œæ—¶é‡‡ç”¨é€è¡Œè§£é‡Šå­—èŠ‚ç æ‰§è¡Œç¨‹åºçš„æƒ³æ³•ã€‚
  
  ä¸ºä»€ä¹ˆJavaæºæ–‡ä»¶ä¸ç›´æ¥ç¿»è¯‘æˆJMVï¼Œè€Œæ˜¯ç¿»è¯‘æˆå­—èŠ‚ç æ–‡ä»¶ï¼Ÿå¯èƒ½æ˜¯å› ä¸ºç›´æ¥ç¿»è¯‘çš„ä»£ç æ˜¯æ¯”è¾ƒå¤§çš„
  è§£é‡Šå™¨çœŸæ­£æ„ä¹‰ä¸Šæ‰€æ‰¿æ‹…çš„è§’è‰²å°±æ˜¯ä¸€ä¸ªè¿è¡Œæ—¶â€œç¿»è¯‘è€…â€ï¼Œå°†å­—èŠ‚ç æ–‡ä»¶ä¸­çš„å†…å®¹â€œç¿»è¯‘â€ä¸ºå¯¹åº”å¹³å°çš„æœ¬åœ°æœºå™¨æŒ‡ä»¤æ‰§è¡Œã€‚
  å½“ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤è¢«è§£é‡Šæ‰§è¡Œå®Œæˆåï¼Œæ¥ç€å†æ ¹æ®PCå¯„å­˜å™¨ä¸­è®°å½•çš„ä¸‹ä¸€æ¡éœ€è¦è¢«æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤æ‰§è¡Œè§£é‡Šæ“ä½œã€‚

è§£é‡Šå™¨åˆ†ç±»
  åœ¨Javaçš„å‘å±•å†å²é‡Œï¼Œä¸€å…±æœ‰ä¸¤å¥—è§£é‡Šæ‰§è¡Œå™¨ï¼Œå³å¤è€çš„å­—èŠ‚ç è§£é‡Šå™¨ã€ç°åœ¨æ™®éä½¿ç”¨çš„æ¨¡æ¿è§£é‡Šå™¨ã€‚
  å­—èŠ‚ç è§£é‡Šå™¨åœ¨æ‰§è¡Œæ—¶é€šè¿‡çº¯è½¯ä»¶ä»£ç æ¨¡æ‹Ÿå­—èŠ‚ç çš„æ‰§è¡Œï¼Œæ•ˆç‡éå¸¸ä½ä¸‹ã€‚
  è€Œæ¨¡æ¿è§£é‡Šå™¨å°†æ¯ä¸€æ¡å­—èŠ‚ç å’Œä¸€ä¸ªæ¨¡æ¿å‡½æ•°ç›¸å…³è”ï¼Œæ¨¡æ¿å‡½æ•°ä¸­ç›´æ¥äº§ç”Ÿè¿™æ¡å­—èŠ‚ç æ‰§è¡Œæ—¶çš„æœºå™¨ç ï¼Œä»è€Œå¾ˆå¤§ç¨‹åº¦ä¸Šæé«˜äº†è§£é‡Šå™¨çš„æ€§èƒ½ã€‚
  åœ¨HotSpot VMä¸­ï¼Œè§£é‡Šå™¨ä¸»è¦ç”±Interpreteræ¨¡å—å’ŒCodeæ¨¡å—æ„æˆã€‚

Interpreteræ¨¡å—ï¼šå®ç°äº†è§£é‡Šå™¨çš„æ ¸å¿ƒåŠŸèƒ½
Codeæ¨¡å—ï¼šç”¨äºç®¡ç†HotSpot VMåœ¨è¿è¡Œæ—¶ç”Ÿæˆçš„æœ¬åœ°æœºå™¨æŒ‡ä»¤


ç°çŠ¶
  ç”±äºè§£é‡Šå™¨åœ¨è®¾è®¡å’Œå®ç°ä¸Šéå¸¸ç®€å•ï¼Œå› æ­¤é™¤äº†Javaè¯­è¨€ä¹‹å¤–ï¼Œè¿˜æœ‰è®¸å¤šé«˜çº§è¯­è¨€åŒæ ·ä¹Ÿæ˜¯åŸºäºè§£é‡Šå™¨æ‰§è¡Œçš„ï¼Œæ¯”å¦‚Pythonã€Per1ã€Rubyç­‰ã€‚ä½†æ˜¯åœ¨ä»Šå¤©ï¼ŒåŸºäºè§£é‡Šå™¨æ‰§è¡Œå·²ç»æ²¦è½ä¸ºä½æ•ˆçš„ä»£åè¯ï¼Œå¹¶ä¸”æ—¶å¸¸è¢«ä¸€äº›C&#x2F;C++ç¨‹åºå‘˜æ‰€è°ƒä¾ƒã€‚
  ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJVMå¹³å°æ”¯æŒä¸€ç§å«ä½œå³æ—¶ç¼–è¯‘çš„æŠ€æœ¯ã€‚å³æ—¶ç¼–è¯‘çš„ç›®çš„æ˜¯é¿å…å‡½æ•°è¢«è§£é‡Šæ‰§è¡Œï¼Œè€Œæ˜¯å°†æ•´ä¸ªå‡½æ•°ä½“ç¼–è¯‘æˆä¸ºæœºå™¨ç ï¼Œæ¯æ¬¡å‡½æ•°æ‰§è¡Œæ—¶ï¼Œåªæ‰§è¡Œç¼–è¯‘åçš„æœºå™¨ç å³å¯ï¼Œè¿™ç§æ–¹å¼å¯ä»¥ä½¿æ‰§è¡Œæ•ˆç‡å¤§å¹…åº¦æå‡ã€‚
  ä¸è¿‡æ— è®ºå¦‚ä½•ï¼ŒåŸºäºè§£é‡Šå™¨çš„æ‰§è¡Œæ¨¡å¼ä»ç„¶ä¸ºä¸­é—´è¯­è¨€çš„å‘å±•åšå‡ºäº†ä¸å¯ç£¨ç­çš„è´¡çŒ®ã€‚


4.JITç¼–è¯‘å™¨
Javaä»£ç çš„æ‰§è¡Œåˆ†ç±»

ç¬¬ä¸€ç§æ˜¯å°†æºä»£ç ç¼–è¯‘æˆå­—èŠ‚ç æ–‡ä»¶ï¼Œç„¶ååœ¨è¿è¡Œæ—¶é€šè¿‡è§£é‡Šå™¨å°†å­—èŠ‚ç æ–‡ä»¶è½¬ä¸ºæœºå™¨ç æ‰§è¡Œ
ç¬¬äºŒç§æ˜¯ç¼–è¯‘æ‰§è¡Œï¼ˆç›´æ¥ç¼–è¯‘æˆæœºå™¨ç ï¼‰ã€‚ç°ä»£è™šæ‹Ÿæœºä¸ºäº†æé«˜æ‰§è¡Œæ•ˆç‡ï¼Œä¼šä½¿ç”¨å³æ—¶ç¼–è¯‘æŠ€æœ¯ï¼ˆJITï¼ŒJust In Timeï¼‰å°†æ–¹æ³•ç¼–è¯‘æˆæœºå™¨ç åå†æ‰§è¡Œ
HotSpot VMæ˜¯ç›®å‰å¸‚é¢ä¸Šé«˜æ€§èƒ½è™šæ‹Ÿæœºçš„ä»£è¡¨ä½œä¹‹ä¸€ã€‚å®ƒé‡‡ç”¨è§£é‡Šå™¨ä¸å³æ—¶ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„ã€‚åœ¨Javaè™šæ‹Ÿæœºè¿è¡Œæ—¶ï¼Œè§£é‡Šå™¨å’Œå³æ—¶ç¼–è¯‘å™¨èƒ½å¤Ÿç›¸äº’åä½œï¼Œå„è‡ªå–é•¿è¡¥çŸ­ï¼Œå°½åŠ›å»é€‰æ‹©æœ€åˆé€‚çš„æ–¹å¼æ¥æƒè¡¡ç¼–è¯‘æœ¬åœ°ä»£ç çš„æ—¶é—´å’Œç›´æ¥è§£é‡Šæ‰§è¡Œä»£ç çš„æ—¶é—´ã€‚
åœ¨ä»Šå¤©ï¼ŒJavaç¨‹åºçš„è¿è¡Œæ€§èƒ½æ—©å·²è„±èƒæ¢éª¨ï¼Œå·²ç»è¾¾åˆ°äº†å¯ä»¥å’ŒC&#x2F;C++ ç¨‹åºä¸€è¾ƒé«˜ä¸‹çš„åœ°æ­¥ã€‚


ä¸ºå•¥æˆ‘ä»¬è¿˜éœ€è¦è§£é‡Šå™¨å‘¢ï¼Ÿ

æœ‰äº›å¼€å‘äººå‘˜ä¼šæ„Ÿè§‰åˆ°è¯§å¼‚ï¼Œæ—¢ç„¶HotSpot VMä¸­å·²ç»å†…ç½®JITç¼–è¯‘å™¨äº†ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¿˜éœ€è¦å†ä½¿ç”¨è§£é‡Šå™¨æ¥â€œæ‹–ç´¯â€ç¨‹åºçš„æ‰§è¡Œæ€§èƒ½å‘¢ï¼Ÿæ¯”å¦‚JRockit VMå†…éƒ¨å°±ä¸åŒ…å«è§£é‡Šå™¨ï¼Œå­—èŠ‚ç å…¨éƒ¨éƒ½ä¾é å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åæ‰§è¡Œã€‚
JRockitè™šæ‹Ÿæœºæ˜¯ç æ‰äº†è§£é‡Šå™¨ï¼Œä¹Ÿå°±æ˜¯åªé‡‡åŠæ—¶ç¼–è¯‘å™¨ã€‚é‚£æ˜¯å› ä¸ºå‘¢JRockitåªéƒ¨ç½²åœ¨æœåŠ¡å™¨ä¸Šï¼Œä¸€èˆ¬å·²ç»æœ‰æ—¶é—´è®©ä»–è¿›è¡ŒæŒ‡ä»¤ç¼–è¯‘çš„è¿‡ç¨‹äº†ï¼Œå¯¹äºå“åº”æ¥è¯´è¦æ±‚ä¸é«˜ï¼Œç­‰åŠæ—¶ç¼–è¯‘å™¨çš„ç¼–è¯‘å®Œæˆåï¼Œå°±ä¼šæä¾›æ›´å¥½çš„æ€§èƒ½


é¦–å…ˆæ˜ç¡®ä¸¤ç‚¹ï¼š

å½“ç¨‹åºå¯åŠ¨åï¼Œè§£é‡Šå™¨å¯ä»¥é©¬ä¸Šå‘æŒ¥ä½œç”¨ï¼Œå“åº”é€Ÿåº¦å¿«ï¼Œçœå»ç¼–è¯‘çš„æ—¶é—´ï¼Œç«‹å³æ‰§è¡Œã€‚
ç¼–è¯‘å™¨è¦æƒ³å‘æŒ¥ä½œç”¨ï¼ŒæŠŠä»£ç ç¼–è¯‘æˆæœ¬åœ°ä»£ç ï¼Œéœ€è¦ä¸€å®šçš„æ‰§è¡Œæ—¶é—´ï¼Œä½†ç¼–è¯‘ä¸ºæœ¬åœ°ä»£ç åï¼Œæ‰§è¡Œæ•ˆç‡é«˜ã€‚

  æ‰€ä»¥ï¼š

å°½ç®¡JRockit VMä¸­ç¨‹åºçš„æ‰§è¡Œæ€§èƒ½ä¼šéå¸¸é«˜æ•ˆï¼Œä½†ç¨‹åºåœ¨å¯åŠ¨æ—¶å¿…ç„¶éœ€è¦èŠ±è´¹æ›´é•¿çš„æ—¶é—´æ¥è¿›è¡Œç¼–è¯‘ã€‚å¯¹äºæœåŠ¡ç«¯åº”ç”¨æ¥è¯´ï¼Œå¯åŠ¨æ—¶é—´å¹¶éæ˜¯å…³æ³¨é‡ç‚¹ï¼Œä½†å¯¹äºé‚£äº›çœ‹ä¸­å¯åŠ¨æ—¶é—´çš„åº”ç”¨åœºæ™¯è€Œè¨€ï¼Œæˆ–è®¸å°±éœ€è¦é‡‡ç”¨è§£é‡Šå™¨ä¸å³æ—¶ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„æ¥æ¢å–ä¸€ä¸ªå¹³è¡¡ç‚¹ã€‚
åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œåœ¨Javaè™šæ‹Ÿå™¨å¯åŠ¨æ—¶ï¼Œè§£é‡Šå™¨å¯ä»¥é¦–å…ˆå‘æŒ¥ä½œç”¨ï¼Œè€Œä¸å¿…ç­‰å¾…å³æ—¶ç¼–è¯‘å™¨å…¨éƒ¨ç¼–è¯‘å®Œæˆåå†æ‰§è¡Œï¼Œè¿™æ ·å¯ä»¥çœå»è®¸å¤šä¸å¿…è¦çš„ç¼–è¯‘æ—¶é—´ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œç¼–è¯‘å™¨å‘æŒ¥ä½œç”¨ï¼ŒæŠŠè¶Šæ¥è¶Šå¤šçš„ä»£ç ç¼–è¯‘æˆæœ¬åœ°ä»£ç ï¼Œè·å¾—æ›´é«˜çš„æ‰§è¡Œæ•ˆç‡ã€‚
åŒæ—¶ï¼Œè§£é‡Šæ‰§è¡Œåœ¨ç¼–è¯‘å™¨è¿›è¡Œæ¿€è¿›ä¼˜åŒ–ä¸æˆç«‹çš„æ—¶å€™ï¼Œä½œä¸ºç¼–è¯‘å™¨çš„â€œé€ƒç”Ÿé—¨â€ï¼ˆåå¤‡æ–¹æ¡ˆï¼‰ã€‚

  æ¡ˆä¾‹
  æ³¨æ„è§£é‡Šæ‰§è¡Œä¸ç¼–è¯‘æ‰§è¡Œåœ¨çº¿ä¸Šç¯å¢ƒå¾®å¦™çš„è¾©è¯å…³ç³»ã€‚æœºå™¨åœ¨çƒ­æœºçŠ¶æ€å¯ä»¥æ‰¿å—çš„è´Ÿè½½è¦å¤§äºå†·æœºçŠ¶æ€ã€‚å¦‚æœä»¥çƒ­æœºçŠ¶æ€æ—¶çš„æµé‡è¿›è¡Œåˆ‡æµï¼Œå¯èƒ½ä½¿å¤„äºå†·æœºçŠ¶æ€çš„æœåŠ¡å™¨å› æ— æ³•æ‰¿è½½æµé‡è€Œå‡æ­»ã€‚
  åœ¨ç”Ÿäº§ç¯å¢ƒå‘å¸ƒè¿‡ç¨‹ä¸­ï¼Œä»¥åˆ†æ‰¹çš„æ–¹å¼è¿›è¡Œå‘å¸ƒï¼Œæ ¹æ®æœºå™¨æ•°é‡åˆ’åˆ†æˆå¤šä¸ªæ‰¹æ¬¡ï¼Œæ¯ä¸ªæ‰¹æ¬¡çš„æœºå™¨æ•°è‡³å¤šå åˆ°æ•´ä¸ªé›†ç¾¤çš„1&#x2F;8ã€‚æ›¾ç»æœ‰è¿™æ ·çš„æ•…éšœæ¡ˆä¾‹ï¼šæŸç¨‹åºå‘˜åœ¨å‘å¸ƒå¹³å°è¿›è¡Œåˆ†æ‰¹å‘å¸ƒï¼Œåœ¨è¾“å…¥å‘å¸ƒæ€»æ‰¹æ•°æ—¶ï¼Œè¯¯å¡«å†™æˆåˆ†ä¸ºä¸¤æ‰¹å‘å¸ƒã€‚å¦‚æœæ˜¯çƒ­æœºçŠ¶æ€ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹ä¸€åŠçš„æœºå™¨å¯ä»¥å‹‰å¼ºæ‰¿è½½æµé‡ï¼Œä½†ç”±äºåˆšå¯åŠ¨çš„JVMå‡æ˜¯è§£é‡Šæ‰§è¡Œï¼Œè¿˜æ²¡æœ‰è¿›è¡Œçƒ­ç‚¹ä»£ç ç»Ÿè®¡å’ŒJITåŠ¨æ€ç¼–è¯‘ï¼Œå¯¼è‡´æœºå™¨å¯åŠ¨ä¹‹åï¼Œå½“å‰1&#x2F;2å‘å¸ƒæˆåŠŸçš„æœåŠ¡å™¨é©¬ä¸Šå…¨éƒ¨å®•æœºï¼Œæ­¤æ•…éšœè¯´æ˜äº†JITçš„å­˜åœ¨ã€‚â€”é˜¿é‡Œå›¢é˜Ÿ
  
  

JITç¼–è¯‘å™¨ç›¸å…³æ¦‚å¿µ

Java è¯­è¨€çš„â€œç¼–è¯‘æœŸâ€å…¶å®æ˜¯ä¸€æ®µâ€œä¸ç¡®å®šâ€çš„æ“ä½œè¿‡ç¨‹ï¼Œå› ä¸ºå®ƒå¯èƒ½æ˜¯æŒ‡ä¸€ä¸ªå‰ç«¯ç¼–è¯‘å™¨ï¼ˆå…¶å®å«â€œç¼–è¯‘å™¨çš„å‰ç«¯â€æ›´å‡†ç¡®ä¸€äº›ï¼‰æŠŠ.javaæ–‡ä»¶è½¬å˜æˆ.classæ–‡ä»¶çš„è¿‡ç¨‹ã€‚
ä¹Ÿå¯èƒ½æ˜¯æŒ‡è™šæ‹Ÿæœºçš„åç«¯è¿è¡ŒæœŸç¼–è¯‘å™¨ï¼ˆJITç¼–è¯‘å™¨ï¼ŒJust In Time Compilerï¼‰æŠŠå­—èŠ‚ç è½¬å˜æˆæœºå™¨ç çš„è¿‡ç¨‹ã€‚
è¿˜å¯èƒ½æ˜¯æŒ‡ä½¿ç”¨é™æ€æå‰ç¼–è¯‘å™¨ï¼ˆAOTç¼–è¯‘å™¨ï¼ŒAhead of Time Compilerï¼‰ç›´æ¥æŠŠ.javaæ–‡ä»¶ç¼–è¯‘æˆæœ¬åœ°æœºå™¨ä»£ç çš„è¿‡ç¨‹ã€‚ï¼ˆå¯èƒ½æ˜¯åç»­å‘å±•çš„è¶‹åŠ¿ï¼‰

  å…¸å‹çš„ç¼–è¯‘å™¨ï¼š

å‰ç«¯ç¼–è¯‘å™¨ï¼šSunçš„javacã€Eclipse JDTä¸­çš„å¢é‡å¼ç¼–è¯‘å™¨ï¼ˆECJï¼‰ã€‚
JITç¼–è¯‘å™¨ï¼šHotSpot VMçš„C1ã€C2ç¼–è¯‘å™¨ã€‚
AOT ç¼–è¯‘å™¨ï¼šGNU Compiler for the Javaï¼ˆGCJï¼‰ã€Excelsior JETã€‚


çƒ­ç‚¹ä»£ç åŠæ¢æµ‹æ–¹å¼

å½“ç„¶æ˜¯å¦éœ€è¦å¯åŠ¨JITç¼–è¯‘å™¨å°†å­—èŠ‚ç ç›´æ¥ç¼–è¯‘ä¸ºå¯¹åº”å¹³å°çš„æœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼Œåˆ™éœ€è¦æ ¹æ®ä»£ç è¢«è°ƒç”¨æ‰§è¡Œçš„é¢‘ç‡è€Œå®šã€‚
å…³äºé‚£äº›éœ€è¦è¢«ç¼–è¯‘ä¸ºæœ¬åœ°ä»£ç çš„å­—èŠ‚ç ï¼Œä¹Ÿè¢«ç§°ä¹‹ä¸º**â€œçƒ­ç‚¹ä»£ç â€ï¼ŒJITç¼–è¯‘å™¨åœ¨è¿è¡Œæ—¶ä¼šé’ˆå¯¹é‚£äº›é¢‘ç¹è¢«è°ƒç”¨çš„â€œçƒ­ç‚¹ä»£ç â€åšå‡ºæ·±åº¦ä¼˜åŒ–**ï¼Œå°†å…¶ç›´æ¥ç¼–è¯‘ä¸ºå¯¹åº”å¹³å°çš„æœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼Œä»¥æ­¤æå‡Javaç¨‹åºçš„æ‰§è¡Œæ€§èƒ½ã€‚
ä¸€ä¸ªè¢«å¤šæ¬¡è°ƒç”¨çš„æ–¹æ³•ï¼Œæˆ–è€…æ˜¯ä¸€-ä¸ªæ–¹æ³•ä½“å†…éƒ¨å¾ªç¯æ¬¡æ•°è¾ƒå¤šçš„å¾ªç¯ä½“éƒ½å¯ä»¥è¢«ç§°ä¹‹ä¸ºâ€œçƒ­ç‚¹ä»£ç â€ï¼Œå› æ­¤éƒ½å¯ä»¥é€šè¿‡JITç¼–è¯‘å™¨ç¼–è¯‘ä¸ºæœ¬åœ°æœºå™¨æŒ‡ä»¤ã€‚ç”±äºè¿™ç§ç¼–è¯‘æ–¹å¼å‘ç”Ÿåœ¨æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› æ­¤ä¹Ÿè¢«ç§°ä¹‹ä¸ºæ ˆä¸Šæ›¿æ¢ï¼Œæˆ–ç®€ç§°ä¸ºOSR (On StackReplacement)ç¼–è¯‘ã€‚
ä¸€ä¸ªæ–¹æ³•ç©¶ç«Ÿè¦è¢«è°ƒç”¨å¤šå°‘æ¬¡ï¼Œæˆ–è€…ä¸€ä¸ªå¾ªç¯ä½“ç©¶ç«Ÿéœ€è¦æ‰§è¡Œå¤šå°‘æ¬¡å¾ªç¯æ‰å¯ä»¥è¾¾åˆ°è¿™ä¸ªæ ‡å‡†ï¼Ÿå¿…ç„¶éœ€è¦ä¸€ä¸ªæ˜ç¡®çš„é˜ˆå€¼ï¼ŒJITç¼–è¯‘å™¨æ‰ä¼šå°†è¿™äº›â€œçƒ­ç‚¹ä»£ç â€ç¼–è¯‘ä¸ºæœ¬åœ°æœºå™¨æŒ‡ä»¤æ‰§è¡Œã€‚è¿™é‡Œä¸»è¦ä¾é çƒ­ç‚¹æ¢æµ‹åŠŸèƒ½ã€‚
ç›®å‰HotSpot VMæ‰€é‡‡ç”¨çš„çƒ­ç‚¹æ¢æµ‹æ–¹å¼æ˜¯åŸºäºè®¡æ•°å™¨çš„çƒ­ç‚¹æ¢æµ‹ã€‚
é‡‡ç”¨åŸºäºè®¡æ•°å™¨çš„çƒ­ç‚¹æ¢æµ‹ï¼ŒHotSpot VMå°†ä¼šä¸ºæ¯ä¸€ä¸ªæ–¹æ³•éƒ½å»ºç«‹2ä¸ªä¸åŒç±»å‹çš„è®¡æ•°å™¨ï¼Œåˆ†åˆ«ä¸ºæ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ï¼ˆInvocation Counterï¼‰å’Œå›è¾¹è®¡æ•°å™¨ï¼ˆBack Edge Counterï¼‰ã€‚
æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ç”¨äºç»Ÿè®¡æ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°
å›è¾¹è®¡æ•°å™¨åˆ™ç”¨äºç»Ÿè®¡å¾ªç¯ä½“æ‰§è¡Œçš„å¾ªç¯æ¬¡æ•°




æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨

è¿™ä¸ªè®¡æ•°å™¨å°±ç”¨äºç»Ÿè®¡æ–¹æ³•è¢«è°ƒç”¨çš„æ¬¡æ•°ï¼Œå®ƒçš„é»˜è®¤é˜€å€¼åœ¨Clientæ¨¡å¼ä¸‹æ˜¯1500æ¬¡ï¼Œåœ¨Serveræ¨¡å¼ä¸‹æ˜¯10000æ¬¡ã€‚è¶…è¿‡è¿™ä¸ªé˜ˆå€¼ï¼Œå°±ä¼šè§¦å‘JITç¼–è¯‘ã€‚

è¿™ä¸ªé˜€å€¼å¯ä»¥é€šè¿‡è™šæ‹Ÿæœºå‚æ•° -XX:CompileThreshold æ¥äººä¸ºè®¾å®šã€‚

å½“ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œä¼šå…ˆæ£€æŸ¥è¯¥æ–¹æ³•æ˜¯å¦å­˜åœ¨è¢«JITç¼–è¯‘è¿‡çš„ç‰ˆæœ¬

å¦‚æœå­˜åœ¨ï¼Œåˆ™ä¼˜å…ˆä½¿ç”¨ç¼–è¯‘åçš„æœ¬åœ°ä»£ç æ¥æ‰§è¡Œ
å¦‚æœä¸å­˜åœ¨å·²è¢«ç¼–è¯‘è¿‡çš„ç‰ˆæœ¬ï¼Œåˆ™å°†æ­¤æ–¹æ³•çš„è°ƒç”¨è®¡æ•°å™¨å€¼åŠ 1ï¼Œç„¶ååˆ¤æ–­æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ä¸å›è¾¹è®¡æ•°å™¨å€¼ä¹‹å’Œæ˜¯å¦è¶…è¿‡æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨çš„é˜€å€¼ã€‚
å¦‚æœå·²è¶…è¿‡é˜ˆå€¼ï¼Œé‚£ä¹ˆå°†ä¼šå‘å³æ—¶ç¼–è¯‘å™¨æäº¤ä¸€ä¸ªè¯¥æ–¹æ³•çš„ä»£ç ç¼–è¯‘è¯·æ±‚ã€‚
å¦‚æœæœªè¶…è¿‡é˜ˆå€¼ï¼Œåˆ™ä½¿ç”¨è§£é‡Šå™¨å¯¹å­—èŠ‚ç æ–‡ä»¶è§£é‡Šæ‰§è¡Œ



 



çƒ­åº¦è¡°å‡

å¦‚æœä¸åšä»»ä½•è®¾ç½®ï¼Œæ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ç»Ÿè®¡çš„å¹¶ä¸æ˜¯æ–¹æ³•è¢«è°ƒç”¨çš„ç»å¯¹æ¬¡æ•°ï¼Œè€Œæ˜¯ä¸€ä¸ªç›¸å¯¹çš„æ‰§è¡Œé¢‘ç‡ï¼Œå³ä¸€æ®µæ—¶é—´ä¹‹å†…æ–¹æ³•è¢«è°ƒç”¨çš„æ¬¡æ•°ã€‚å½“è¶…è¿‡ä¸€å®šçš„æ—¶é—´é™åº¦ï¼Œå¦‚æœæ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°ä»ç„¶ä¸è¶³ä»¥è®©å®ƒæäº¤ç»™å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘ï¼Œé‚£è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨è®¡æ•°å™¨å°±ä¼šè¢«å‡å°‘ä¸€åŠï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºæ–¹æ³•è°ƒç”¨è®¡æ•°å™¨çƒ­åº¦çš„è¡°å‡ï¼ˆCounter Decayï¼‰ï¼Œè€Œè¿™æ®µæ—¶é—´å°±ç§°ä¸ºæ­¤æ–¹æ³•ç»Ÿè®¡çš„åŠè¡°å‘¨æœŸï¼ˆCounter Half Life Timeï¼‰ï¼ˆåŠè¡°å‘¨æœŸæ˜¯åŒ–å­¦ä¸­çš„æ¦‚å¿µï¼Œæ¯”å¦‚å‡ºåœŸçš„æ–‡ç‰©é€šè¿‡æŸ¥çœ‹C60æ¥è·å¾—æ–‡ç‰©çš„å¹´é¾„ï¼‰
è¿›è¡Œçƒ­åº¦è¡°å‡çš„åŠ¨ä½œæ˜¯åœ¨è™šæ‹Ÿæœºè¿›è¡Œåƒåœ¾æ”¶é›†æ—¶é¡ºä¾¿è¿›è¡Œçš„ï¼Œå¯ä»¥ä½¿ç”¨è™šæ‹Ÿæœºå‚æ•° -XX:-UseCounterDecay æ¥å…³é—­çƒ­åº¦è¡°å‡ï¼Œè®©æ–¹æ³•è®¡æ•°å™¨ç»Ÿè®¡æ–¹æ³•è°ƒç”¨çš„ç»å¯¹æ¬¡æ•°ï¼Œè¿™æ ·çš„è¯ï¼Œåªè¦ç³»ç»Ÿè¿è¡Œæ—¶é—´è¶³å¤Ÿé•¿ï¼Œç»å¤§éƒ¨åˆ†æ–¹æ³•éƒ½ä¼šè¢«ç¼–è¯‘æˆæœ¬åœ°ä»£ç ã€‚
å¦å¤–ï¼Œå¯ä»¥ä½¿ç”¨-XX:CounterHalfLifeTimeå‚æ•°è®¾ç½®åŠè¡°å‘¨æœŸçš„æ—¶é—´ï¼Œå•ä½æ˜¯ç§’ã€‚


å›è¾¹è®¡æ•°å™¨
  å®ƒçš„ä½œç”¨æ˜¯ç»Ÿè®¡ä¸€ä¸ªæ–¹æ³•ä¸­å¾ªç¯ä½“ä»£ç æ‰§è¡Œçš„æ¬¡æ•°ï¼Œåœ¨å­—èŠ‚ç ä¸­é‡åˆ°æ§åˆ¶æµå‘åè·³è½¬çš„æŒ‡ä»¤ç§°ä¸ºâ€œå›è¾¹â€ï¼ˆBack Edgeï¼‰ã€‚æ˜¾ç„¶ï¼Œå»ºç«‹å›è¾¹è®¡æ•°å™¨ç»Ÿè®¡çš„ç›®çš„å°±æ˜¯ä¸ºäº†è§¦å‘OSRç¼–è¯‘ã€‚
  

HotSpotVM å¯ä»¥è®¾ç½®ç¨‹åºæ‰§è¡Œæ–¹æ³•
  ç¼ºçœæƒ…å†µä¸‹HotSpot VMæ˜¯é‡‡ç”¨è§£é‡Šå™¨ä¸å³æ—¶ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„ï¼Œå½“ç„¶å¼€å‘äººå‘˜å¯ä»¥æ ¹æ®å…·ä½“çš„åº”ç”¨åœºæ™¯ï¼Œé€šè¿‡å‘½ä»¤æ˜¾å¼åœ°ä¸ºJavaè™šæ‹ŸæœºæŒ‡å®šåœ¨è¿è¡Œæ—¶åˆ°åº•æ˜¯å®Œå…¨é‡‡ç”¨è§£é‡Šå™¨æ‰§è¡Œï¼Œè¿˜æ˜¯å®Œå…¨é‡‡ç”¨å³æ—¶ç¼–è¯‘å™¨æ‰§è¡Œã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

Xintï¼šå®Œå…¨é‡‡ç”¨è§£é‡Šå™¨æ¨¡å¼æ‰§è¡Œç¨‹åºï¼›
Xcompï¼šå®Œå…¨é‡‡ç”¨å³æ—¶ç¼–è¯‘å™¨æ¨¡å¼æ‰§è¡Œç¨‹åºã€‚å¦‚æœå³æ—¶ç¼–è¯‘å‡ºç°é—®é¢˜ï¼Œè§£é‡Šå™¨ä¼šä»‹å…¥æ‰§è¡Œ
Xmixedï¼šé‡‡ç”¨è§£é‡Šå™¨+å³æ—¶ç¼–è¯‘å™¨çš„æ··åˆæ¨¡å¼å…±åŒæ‰§è¡Œç¨‹åºã€‚

  
  

HotSpotVM JIT åˆ†ç±»
  åœ¨HotSpot VMä¸­å†…åµŒæœ‰ä¸¤ä¸ªJITç¼–è¯‘å™¨ï¼Œåˆ†åˆ«ä¸ºClient Compilerå’ŒServer Compilerï¼Œä½†å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬ç®€ç§°ä¸ºC1ç¼–è¯‘å™¨ å’Œ C2ç¼–è¯‘å™¨ã€‚å¼€å‘äººå‘˜å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ˜¾å¼æŒ‡å®šJavaè™šæ‹Ÿæœºåœ¨è¿è¡Œæ—¶åˆ°åº•ä½¿ç”¨å“ªä¸€ç§å³æ—¶ç¼–è¯‘å™¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

clientï¼šæŒ‡å®šJavaè™šæ‹Ÿæœºè¿è¡Œåœ¨Clientæ¨¡å¼ä¸‹ï¼Œå¹¶ä½¿ç”¨C1ç¼–è¯‘å™¨ï¼›
C1ç¼–è¯‘å™¨ä¼šå¯¹å­—èŠ‚ç è¿›è¡Œç®€å•å’Œå¯é çš„ä¼˜åŒ–ï¼Œè€—æ—¶çŸ­ï¼Œä»¥è¾¾åˆ°æ›´å¿«çš„ç¼–è¯‘é€Ÿåº¦ã€‚


serverï¼šæŒ‡å®šJavaè™šæ‹Ÿæœºè¿è¡Œåœ¨serveræ¨¡å¼ä¸‹ï¼Œå¹¶ä½¿ç”¨C2ç¼–è¯‘å™¨ã€‚
C2è¿›è¡Œè€—æ—¶è¾ƒé•¿çš„ä¼˜åŒ–ï¼Œä»¥åŠæ¿€è¿›ä¼˜åŒ–ï¼Œä½†ä¼˜åŒ–çš„ä»£ç æ‰§è¡Œæ•ˆç‡æ›´é«˜ã€‚ï¼ˆä½¿ç”¨C++ï¼‰




C1å’ŒC2ç¼–è¯‘å™¨ä¸åŒçš„ä¼˜åŒ–ç­–ç•¥

åœ¨ä¸åŒçš„ç¼–è¯‘å™¨ä¸Šæœ‰ä¸åŒçš„ä¼˜åŒ–ç­–ç•¥ï¼ŒC1ç¼–è¯‘å™¨ä¸Šä¸»è¦æœ‰æ–¹æ³•å†…è”ï¼Œå»è™šæ‹ŸåŒ–ã€å…ƒä½™æ¶ˆé™¤ã€‚
æ–¹æ³•å†…è”ï¼šå°†å¼•ç”¨çš„å‡½æ•°ä»£ç ç¼–è¯‘åˆ°å¼•ç”¨ç‚¹å¤„ï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ ˆå¸§çš„ç”Ÿæˆï¼Œå‡å°‘å‚æ•°ä¼ é€’ä»¥åŠè·³è½¬è¿‡ç¨‹
å»è™šæ‹ŸåŒ–ï¼šå¯¹å”¯ä¸€çš„å®ç°æ¨Šè¿›è¡Œå†…è”
å†—ä½™æ¶ˆé™¤ï¼šåœ¨è¿è¡ŒæœŸé—´æŠŠä¸€äº›ä¸ä¼šæ‰§è¡Œçš„ä»£ç æŠ˜å æ‰


C2çš„ä¼˜åŒ–ä¸»è¦æ˜¯åœ¨å…¨å±€å±‚é¢ï¼Œé€ƒé€¸åˆ†ææ˜¯ä¼˜åŒ–çš„åŸºç¡€ã€‚åŸºäºé€ƒé€¸åˆ†æåœ¨C2ä¸Šæœ‰å¦‚ä¸‹å‡ ç§ä¼˜åŒ–ï¼š
æ ‡é‡æ›¿æ¢ï¼šç”¨æ ‡é‡å€¼ä»£æ›¿èšåˆå¯¹è±¡çš„å±æ€§å€¼
æ ˆä¸Šåˆ†é…ï¼šå¯¹äºæœªé€ƒé€¸çš„å¯¹è±¡åˆ†é…å¯¹è±¡åœ¨æ ˆè€Œä¸æ˜¯å †
åŒæ­¥æ¶ˆé™¤ï¼šæ¸…é™¤åŒæ­¥æ“ä½œï¼Œé€šå¸¸æŒ‡synchronized




åˆ†å±‚ç¼–è¯‘ç­–ç•¥

åˆ†å±‚ç¼–è¯‘ï¼ˆTiered Compilationï¼‰ç­–ç•¥ï¼šç¨‹åºè§£é‡Šæ‰§è¡Œï¼ˆä¸å¼€å¯æ€§èƒ½ç›‘æ§ï¼‰å¯ä»¥è§¦å‘C1ç¼–è¯‘ï¼Œå°†å­—èŠ‚ç ç¼–è¯‘æˆæœºå™¨ç ï¼Œå¯ä»¥è¿›è¡Œç®€å•ä¼˜åŒ–ï¼Œä¹Ÿå¯ä»¥åŠ ä¸Šæ€§èƒ½ç›‘æ§ï¼ŒC2ç¼–è¯‘ä¼šæ ¹æ®æ€§èƒ½ç›‘æ§ä¿¡æ¯è¿›è¡Œæ¿€è¿›ä¼˜åŒ–ã€‚
ä¸è¿‡åœ¨Java7ç‰ˆæœ¬ä¹‹åï¼Œä¸€æ—¦å¼€å‘äººå‘˜åœ¨ç¨‹åºä¸­æ˜¾å¼æŒ‡å®šå‘½ä»¤â€œ-serverâ€æ—¶ï¼Œé»˜è®¤å°†ä¼šå¼€å¯åˆ†å±‚ç¼–è¯‘ç­–ç•¥ï¼Œç”±C1ç¼–è¯‘å™¨å’ŒC2ç¼–è¯‘å™¨ç›¸äº’åä½œå…±åŒæ¥æ‰§è¡Œç¼–è¯‘ä»»åŠ¡ã€‚
ä¸€èˆ¬æ¥è®²ï¼ŒJITç¼–è¯‘å‡ºæ¥çš„æœºå™¨ç æ€§èƒ½æ¯”è§£é‡Šå™¨è§£é‡Šæ‰§è¡Œçš„æ€§èƒ½é«˜
C2ç¼–è¯‘å™¨å¯åŠ¨æ—¶é•¿æ¯”C1æ…¢ï¼Œç³»ç»Ÿç¨³å®šæ‰§è¡Œä»¥åï¼ŒC2ç¼–è¯‘å™¨æ‰§è¡Œé€Ÿåº¦è¿œå¿«äºC1ç¼–è¯‘å™¨


Graal ç¼–è¯‘å™¨

è‡ªJDK10èµ·ï¼ŒHotSpotåˆåŠ å…¥äº†ä¸€ä¸ªå…¨æ–°çš„å³æ—¶ç¼–è¯‘å™¨ï¼šGraalç¼–è¯‘å™¨
ç¼–è¯‘æ•ˆæœçŸ­çŸ­å‡ å¹´æ—¶é—´å°±è¿½å¹³äº†G2ç¼–è¯‘å™¨ï¼Œæœªæ¥å¯æœŸï¼ˆå¯¹åº”è¿˜å‡ºç°äº†Graalè™šæ‹Ÿæœºï¼Œæ˜¯æœ‰å¯èƒ½æ›¿ä»£Hotspotçš„è™šæ‹Ÿæœºçš„ï¼‰
ç›®å‰ï¼Œå¸¦ç€å®éªŒçŠ¶æ€æ ‡ç­¾ï¼Œéœ€è¦ä½¿ç”¨å¼€å…³å‚æ•°å»æ¿€æ´»æ‰èƒ½ä½¿ç”¨
XX:+UnlockExperimentalvMOptions -XX:+UseJVMCICompiler




AOTç¼–è¯‘å™¨

jdk9å¼•å…¥äº†AoTç¼–è¯‘å™¨ï¼ˆé™æ€æå‰ç¼–è¯‘å™¨ï¼ŒAhead of Time Compilerï¼‰

Java 9å¼•å…¥äº†å®éªŒæ€§AOTç¼–è¯‘å·¥å…·jaotcã€‚å®ƒå€ŸåŠ©äº†Graalç¼–è¯‘å™¨ï¼Œå°†æ‰€è¾“å…¥çš„Javaç±»æ–‡ä»¶è½¬æ¢ä¸ºæœºå™¨ç ï¼Œå¹¶å­˜æ”¾è‡³ç”Ÿæˆçš„åŠ¨æ€å…±äº«åº“ä¹‹ä¸­ã€‚

æ‰€è°“AOTç¼–è¯‘ï¼Œæ˜¯ä¸å³æ—¶ç¼–è¯‘ç›¸å¯¹ç«‹çš„ä¸€ä¸ªæ¦‚å¿µã€‚æˆ‘ä»¬çŸ¥é“ï¼Œå³æ—¶ç¼–è¯‘æŒ‡çš„æ˜¯åœ¨ç¨‹åºçš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå°†å­—èŠ‚ç è½¬æ¢ä¸ºå¯åœ¨ç¡¬ä»¶ä¸Šç›´æ¥è¿è¡Œçš„æœºå™¨ç ï¼Œå¹¶éƒ¨ç½²è‡³æ‰˜ç®¡ç¯å¢ƒä¸­çš„è¿‡ç¨‹ã€‚è€ŒAOTç¼–è¯‘æŒ‡çš„åˆ™æ˜¯ï¼Œåœ¨ç¨‹åºè¿è¡Œä¹‹å‰ï¼Œä¾¿å°†å­—èŠ‚ç è½¬æ¢ä¸ºæœºå™¨ç çš„è¿‡ç¨‹ã€‚
 .java -&gt; .class -&gt; (ä½¿ç”¨jaotc) -&gt; .so



AOTç¼–è¯‘å™¨ç¼–è¯‘å™¨çš„ä¼˜ç¼ºç‚¹
  æœ€å¤§çš„å¥½å¤„ï¼š

Javaè™šæ‹ŸæœºåŠ è½½å·²ç»é¢„ç¼–è¯‘æˆäºŒè¿›åˆ¶åº“ï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œã€‚
ä¸å¿…ç­‰å¾…å³æ—¶ç¼–è¯‘å™¨çš„é¢„çƒ­ï¼Œå‡å°‘Javaåº”ç”¨ç»™äººå¸¦æ¥â€œç¬¬ä¸€æ¬¡è¿è¡Œæ…¢â€ çš„ä¸è‰¯ä½“éªŒ

  ç¼ºç‚¹ï¼š

ç ´åäº† java â€œ ä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œâ€ï¼Œå¿…é¡»ä¸ºæ¯ä¸ªä¸åŒçš„ç¡¬ä»¶ï¼ŒOSç¼–è¯‘å¯¹åº”çš„å‘è¡ŒåŒ…
é™ä½äº†Javaé“¾æ¥è¿‡ç¨‹çš„åŠ¨æ€æ€§ï¼ŒåŠ è½½çš„ä»£ç åœ¨ç¼–è¯‘å™¨å°±å¿…é¡»å…¨éƒ¨å·²çŸ¥ã€‚
è¿˜éœ€è¦ç»§ç»­ä¼˜åŒ–ä¸­ï¼Œæœ€åˆåªæ”¯æŒLinux X64 java base


æœ€å

è‡ªJDK10èµ·ï¼ŒHotSpotåˆåŠ å…¥äº†ä¸€ä¸ªå…¨æ–°çš„åŠæ—¶ç¼–è¯‘å™¨ï¼šGraalç¼–è¯‘å™¨
ç¼–è¯‘æ•ˆæœçŸ­çŸ­å‡ å¹´æ—¶é—´å°±è¿½è¯„äº†G2ç¼–è¯‘å™¨ï¼Œæœªæ¥å¯æœŸ
ç›®å‰ï¼Œå¸¦ç€å®éªŒçŠ¶æ€æ ‡ç­¾ï¼Œéœ€è¦ä½¿ç”¨å¼€å…³å‚æ•°å»æ¿€æ´»æ‰èƒ½ä½¿ç”¨



]]></content>
      <categories>
        <category>JVMè™šæ‹Ÿæœºè¯¦è§£</category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>JVMè™šæ‹Ÿæœºè¯¦è§£</tag>
      </tags>
  </entry>
  <entry>
    <title>JVMè™šæ‹Ÿæœºè¯¦è§£(åä¸‰)åƒåœ¾å›æ”¶ç®—æ³•</title>
    <url>/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3(%E5%8D%81%E4%B8%89)%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%97%E6%B3%95/</url>
    <content><![CDATA[JVMè™šæ‹Ÿæœºè¯¦è§£(åä¸‰)åƒåœ¾å›æ”¶ç®—æ³•1. ä»€ä¹ˆæ˜¯åƒåœ¾
ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥å¾ˆæ˜ç¡®çš„çŸ¥é“ï¼ŒJava å’Œ C++è¯­è¨€çš„åŒºåˆ«ï¼Œå°±åœ¨äºåƒåœ¾æ”¶é›†æŠ€æœ¯å’Œå†…å­˜åŠ¨æ€åˆ†é…ä¸Šï¼ŒCè¯­è¨€æ²¡æœ‰åƒåœ¾æ”¶é›†æŠ€æœ¯ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨çš„æ”¶é›†ã€‚
åƒåœ¾æ”¶é›†ï¼Œä¸æ˜¯Javaè¯­è¨€çš„ä¼´ç”Ÿäº§ç‰©ã€‚æ—©åœ¨1960å¹´ï¼Œç¬¬ä¸€é—¨å¼€å§‹ä½¿ç”¨å†…å­˜åŠ¨æ€åˆ†é…å’Œåƒåœ¾æ”¶é›†æŠ€æœ¯çš„Lispè¯­è¨€è¯ç”Ÿã€‚ å…³äºåƒåœ¾æ”¶é›†æœ‰ä¸‰ä¸ªç»å…¸é—®é¢˜ï¼š

å“ªäº›å†…å­˜éœ€è¦å›æ”¶ï¼Ÿ
ä»€ä¹ˆæ—¶å€™å›æ”¶ï¼Ÿ
å¦‚ä½•å›æ”¶ï¼Ÿ

åƒåœ¾æ”¶é›†æœºåˆ¶æ˜¯Javaçš„æ‹›ç‰Œèƒ½åŠ›ï¼Œæå¤§åœ°æé«˜äº†å¼€å‘æ•ˆç‡ã€‚å¦‚ä»Šï¼Œåƒåœ¾æ”¶é›†å‡ ä¹æˆä¸ºç°ä»£è¯­è¨€çš„æ ‡é…ï¼Œå³ä½¿ç»è¿‡å¦‚æ­¤é•¿æ—¶é—´çš„å‘å±•ï¼ŒJavaçš„åƒåœ¾æ”¶é›†æœºåˆ¶ä»ç„¶åœ¨ä¸æ–­çš„æ¼”è¿›ä¸­ï¼Œä¸åŒå¤§å°çš„è®¾å¤‡ã€ä¸åŒç‰¹å¾çš„åº”ç”¨åœºæ™¯ï¼Œå¯¹åƒåœ¾æ”¶é›†æå‡ºäº†æ–°çš„æŒ‘æˆ˜ï¼Œè¿™å½“ç„¶ä¹Ÿæ˜¯é¢è¯•çš„çƒ­ç‚¹ã€‚

ä»€ä¹ˆæ˜¯åƒåœ¾ï¼Ÿ

åƒåœ¾æ˜¯æŒ‡åœ¨è¿è¡Œç¨‹åºä¸­æ²¡æœ‰ä»»ä½•æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯éœ€è¦è¢«å›æ”¶çš„åƒåœ¾ã€‚
å¤–æ–‡ï¼šAn object is considered garbage when it can no longer be reached from any pointer in the running program.
å¦‚æœä¸åŠæ—¶å¯¹å†…å­˜ä¸­çš„åƒåœ¾è¿›è¡Œæ¸…ç†ï¼Œé‚£ä¹ˆï¼Œè¿™äº›åƒåœ¾å¯¹è±¡æ‰€å çš„å†…å­˜ç©ºé—´ä¼šä¸€ç›´ä¿ç•™åˆ°åº”ç”¨ç¨‹åºç»“æŸï¼Œè¢«ä¿ç•™çš„ç©ºé—´æ— æ³•è¢«å…¶ä»–å¯¹è±¡ä½¿ç”¨ã€‚ç”šè‡³å¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡ºã€‚


ä¸ºä»€ä¹ˆéœ€è¦GCï¼Ÿ

æƒ³è¦å­¦ä¹ GCï¼Œé¦–å…ˆéœ€è¦ç†è§£ä¸ºä»€ä¹ˆéœ€è¦GCï¼Ÿ
å¯¹äºé«˜çº§è¯­è¨€æ¥è¯´ï¼Œä¸€ä¸ªåŸºæœ¬è®¤çŸ¥æ˜¯å¦‚æœä¸è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå†…å­˜è¿Ÿæ—©éƒ½ä¼šè¢«æ¶ˆè€—å®Œï¼Œå› ä¸ºä¸æ–­åœ°åˆ†é…å†…å­˜ç©ºé—´è€Œä¸è¿›è¡Œå›æ”¶ï¼Œå°±å¥½åƒä¸åœåœ°ç”Ÿäº§ç”Ÿæ´»åƒåœ¾è€Œä»æ¥ä¸æ‰“æ‰«ä¸€æ ·ã€‚
é™¤äº†é‡Šæ”¾æ²¡ç”¨çš„å¯¹è±¡ï¼Œåƒåœ¾å›æ”¶ä¹Ÿå¯ä»¥æ¸…é™¤å†…å­˜é‡Œçš„è®°å½•ç¢ç‰‡ã€‚ç¢ç‰‡æ•´ç†å°†æ‰€å ç”¨çš„å †å†…å­˜ç§»åˆ°å †çš„ä¸€ç«¯ï¼Œä»¥ä¾¿JVMå°†æ•´ç†å‡ºçš„å†…å­˜åˆ†é…ç»™æ–°çš„å¯¹è±¡ã€‚
éšç€åº”ç”¨ç¨‹åºæ‰€åº”ä»˜çš„ä¸šåŠ¡è¶Šæ¥è¶Šåºå¤§ã€å¤æ‚ï¼Œç”¨æˆ·è¶Šæ¥è¶Šå¤šï¼Œæ²¡æœ‰GCå°±ä¸èƒ½ä¿è¯åº”ç”¨ç¨‹åºçš„æ­£å¸¸è¿›è¡Œã€‚è€Œç»å¸¸é€ æˆSTWçš„GCåˆè·Ÿä¸ä¸Šå®é™…çš„éœ€æ±‚ï¼Œæ‰€ä»¥æ‰ä¼šä¸æ–­åœ°å°è¯•å¯¹GCè¿›è¡Œä¼˜åŒ–ã€‚




æ—©æœŸåƒåœ¾å›æ”¶

åœ¨æ—©æœŸçš„C&#x2F;C++æ—¶ä»£ï¼Œåƒåœ¾å›æ”¶åŸºæœ¬ä¸Šæ˜¯æ‰‹å·¥è¿›è¡Œçš„ã€‚å¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨newå…³é”®å­—è¿›è¡Œå†…å­˜ç”³è¯·ï¼Œå¹¶ä½¿ç”¨deleteå…³é”®å­—è¿›è¡Œå†…å­˜é‡Šæ”¾ã€‚æ¯”å¦‚ä»¥ä¸‹ä»£ç ï¼š
 MibBridge *pBridge= new cmBaseGroupBridgeï¼ˆï¼‰ï¼›  //å¦‚æœæ³¨å†Œå¤±è´¥ï¼Œä½¿ç”¨Deleteé‡Šæ”¾è¯¥å¯¹è±¡æ‰€å å†…å­˜åŒºåŸŸ  ifï¼ˆpBridge-&gt;Registerï¼ˆkDestroyï¼‰ï¼=NO ERRORï¼‰  	delete pBridgeï¼›

è¿™ç§æ–¹å¼å¯ä»¥çµæ´»æ§åˆ¶å†…å­˜é‡Šæ”¾çš„æ—¶é—´ï¼Œä½†æ˜¯ä¼šç»™å¼€å‘äººå‘˜å¸¦æ¥é¢‘ç¹ç”³è¯·å’Œé‡Šæ”¾å†…å­˜çš„ç®¡ç†è´Ÿæ‹…ã€‚å€˜è‹¥æœ‰ä¸€å¤„å†…å­˜åŒºé—´ç”±äºç¨‹åºå‘˜ç¼–ç çš„é—®é¢˜å¿˜è®°è¢«å›æ”¶ï¼Œé‚£ä¹ˆå°±ä¼šäº§ç”Ÿå†…å­˜æ³„æ¼ï¼Œåƒåœ¾å¯¹è±¡æ°¸è¿œæ— æ³•è¢«æ¸…é™¤ï¼Œéšç€ç³»ç»Ÿè¿è¡Œæ—¶é—´çš„ä¸æ–­å¢é•¿ï¼Œåƒåœ¾å¯¹è±¡æ‰€è€—å†…å­˜å¯èƒ½æŒç»­ä¸Šå‡ï¼Œç›´åˆ°å‡ºç°å†…å­˜æº¢å‡ºå¹¶é€ æˆåº”ç”¨ç¨‹åºå´©æºƒã€‚

æœ‰äº†åƒåœ¾å›æ”¶æœºåˆ¶åï¼Œä¸Šè¿°ä»£ç ææœ‰å¯èƒ½å˜æˆè¿™æ ·
 MibBridge *pBridge=new cmBaseGroupBridge();   pBridge-&gt;Register(kDestroy);




ç°åœ¨ï¼Œé™¤äº†Javaä»¥å¤–ï¼ŒC#ã€Pythonã€Rubyç­‰è¯­è¨€éƒ½ä½¿ç”¨äº†è‡ªåŠ¨åƒåœ¾å›æ”¶çš„æ€æƒ³ï¼Œä¹Ÿæ˜¯æœªæ¥å‘å±•è¶‹åŠ¿ï¼Œå¯ä»¥è¯´è¿™ç§è‡ªåŠ¨åŒ–çš„å†…å­˜åˆ†é…å’Œæ¥åŠå›æ”¶æ–¹å¼å·²ç»æˆä¸ºäº†ç°ä»£å¼€å‘è¯­è¨€å¿…å¤‡çš„æ ‡å‡†ã€‚

2.Java åƒåœ¾å›æ”¶æœºåˆ¶
è‡ªåŠ¨å†…å­˜ç®¡ç†

å®˜ç½‘ä»‹ç»ï¼šJava Platform, Standard Edition HotSpot Virtual Machine Garbage Collection Tuning Guide, Release 8 (oracle.com)


è‡ªåŠ¨å†…å­˜ç®¡ç†çš„ä¼˜ç‚¹

è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼Œæ— éœ€å¼€å‘äººå‘˜æ‰‹åŠ¨å‚ä¸å†…å­˜çš„åˆ†é…ä¸å›æ”¶ï¼Œè¿™æ ·é™ä½å†…å­˜æ³„æ¼å’Œå†…å­˜æº¢å‡ºçš„é£é™©
æ²¡æœ‰åƒåœ¾å›æ”¶å™¨ï¼Œjavaä¹Ÿä¼šå’Œcppä¸€æ ·ï¼Œå„ç§æ‚¬å‚æŒ‡é’ˆï¼Œé‡æŒ‡é’ˆï¼Œæ³„éœ²é—®é¢˜è®©ä½ å¤´ç–¼ä¸å·²ã€‚
è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œå°†ç¨‹åºå‘˜ä»ç¹é‡çš„å†…å­˜ç®¡ç†ä¸­é‡Šæ”¾å‡ºæ¥ï¼Œå¯ä»¥æ›´ä¸“å¿ƒåœ°ä¸“æ³¨äºä¸šåŠ¡å¼€å‘


å…³äºè‡ªåŠ¨å†…å­˜ç®¡ç†çš„æ‹…å¿§

å¯¹äºJavaå¼€å‘äººå‘˜è€Œè¨€ï¼Œè‡ªåŠ¨å†…å­˜ç®¡ç†å°±åƒæ˜¯ä¸€ä¸ªé»‘åŒ£å­ï¼Œå¦‚æœè¿‡åº¦ä¾èµ–äºâ€œè‡ªåŠ¨â€ï¼Œé‚£ä¹ˆè¿™å°†ä¼šæ˜¯ä¸€åœºç¾éš¾ï¼Œæœ€ä¸¥é‡çš„å°±ä¼šå¼±åŒ–Javaå¼€å‘äººå‘˜åœ¨ç¨‹åºå‡ºç°å†…å­˜æº¢å‡ºæ—¶å®šä½é—®é¢˜å’Œè§£å†³é—®é¢˜çš„èƒ½åŠ›ã€‚
æ­¤æ—¶ï¼Œäº†è§£JVMçš„è‡ªåŠ¨å†…å­˜åˆ†é…å’Œå†…å­˜å›æ”¶åŸç†å°±æ˜¾å¾—éå¸¸é‡è¦ï¼Œåªæœ‰åœ¨çœŸæ­£äº†è§£JVMæ˜¯å¦‚ä½•ç®¡ç†å†…å­˜åï¼Œæˆ‘ä»¬æ‰èƒ½å¤Ÿåœ¨é‡è§OutofMemoryErroræ—¶ï¼Œå¿«é€Ÿåœ°æ ¹æ®é”™è¯¯å¼‚å¸¸æ—¥å¿—å®šä½é—®é¢˜å’Œè§£å†³é—®é¢˜ã€‚
å½“éœ€è¦æ’æŸ¥å„ç§å†…å­˜æº¢å‡ºã€å†…å­˜æ³„æ¼é—®é¢˜æ—¶ï¼Œå½“åƒåœ¾æ”¶é›†æˆä¸ºç³»ç»Ÿè¾¾åˆ°æ›´é«˜å¹¶å‘é‡çš„ç“¶é¢ˆæ—¶ï¼Œæˆ‘ä»¬å°±å¿…é¡»å¯¹è¿™äº›â€œè‡ªåŠ¨åŒ–â€çš„æŠ€æœ¯å®æ–½å¿…è¦çš„ç›‘æ§å’Œè°ƒèŠ‚ã€‚


GCä¸»è¦å…³æ³¨çš„åŒºåŸŸ
  GCä¸»è¦å…³æ³¨äº æ–¹æ³•åŒº å’Œå †ä¸­çš„åƒåœ¾æ”¶é›†
  
  åƒåœ¾æ”¶é›†å™¨å¯ä»¥å¯¹å¹´è½»ä»£å›æ”¶ï¼Œä¹Ÿå¯ä»¥å¯¹è€å¹´ä»£å›æ”¶ï¼Œç”šè‡³æ˜¯å…¨æ ˆå’Œæ–¹æ³•åŒºçš„å›æ”¶

å…¶ä¸­ï¼ŒJavaå †æ˜¯åƒåœ¾æ”¶é›†å™¨çš„å·¥ä½œé‡ç‚¹

  ä»æ¬¡æ•°ä¸Šè®²ï¼š

é¢‘ç¹æ”¶é›†YoungåŒº
è¾ƒå°‘æ”¶é›†OldåŒº
åŸºæœ¬ä¸æ”¶é›†PermåŒºï¼ˆå…ƒç©ºé—´ï¼‰



3.åƒåœ¾å›æ”¶ç›¸å…³ç®—æ³•
å¼•ç”¨è®¡æ•°ç®—æ³•

åœ¨å †é‡Œå­˜æ”¾ç€å‡ ä¹æ‰€æœ‰çš„Javaå¯¹è±¡å®ä¾‹ï¼Œåœ¨GCæ‰§è¡Œåƒåœ¾å›æ”¶ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦åŒºåˆ†å‡ºå†…å­˜ä¸­å“ªäº›æ˜¯å­˜æ´»å¯¹è±¡ï¼Œå“ªäº›æ˜¯å·²ç»æ­»äº¡çš„å¯¹è±¡ã€‚åªæœ‰è¢«æ ‡è®°ä¸ºå·±ç»æ­»äº¡çš„å¯¹è±¡ï¼ŒGCæ‰ä¼šåœ¨æ‰§è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œé‡Šæ”¾æ‰å…¶æ‰€å ç”¨çš„å†…å­˜ç©ºé—´ï¼Œå› æ­¤è¿™ä¸ªè¿‡ç¨‹æˆ‘ä»¬å¯ä»¥ç§°ä¸ºåƒåœ¾æ ‡è®°é˜¶æ®µã€‚
é‚£ä¹ˆåœ¨JVMä¸­ç©¶ç«Ÿæ˜¯å¦‚ä½•æ ‡è®°ä¸€ä¸ªæ­»äº¡å¯¹è±¡å‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œå½“ä¸€ä¸ªå¯¹è±¡å·²ç»ä¸å†è¢«ä»»ä½•çš„å­˜æ´»å¯¹è±¡ç»§ç»­å¼•ç”¨æ—¶ï¼Œå°±å¯ä»¥å®£åˆ¤ä¸ºå·²ç»æ­»äº¡ã€‚
åˆ¤æ–­å¯¹è±¡å­˜æ´»ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼ï¼šå¼•ç”¨è®¡æ•°ç®—æ³•å’Œå¯è¾¾æ€§åˆ†æç®—æ³•ã€‚


å¼•ç”¨è®¡æ•°ç®—æ³•-åŸç†
å¼•ç”¨è®¡æ•°ç®—æ³•ï¼ˆReference Countingï¼‰æ¯”è¾ƒç®€å•ï¼Œå¯¹æ¯ä¸ªå¯¹è±¡ä¿å­˜ä¸€ä¸ªæ•´å‹çš„å¼•ç”¨è®¡æ•°å™¨å±æ€§ã€‚ç”¨äºè®°å½•å¯¹è±¡è¢«å¼•ç”¨çš„æƒ…å†µã€‚
å¯¹äºä¸€ä¸ªå¯¹è±¡Aï¼Œåªè¦æœ‰ä»»ä½•ä¸€ä¸ªå¯¹è±¡å¼•ç”¨äº†Aï¼Œåˆ™Açš„å¼•ç”¨è®¡æ•°å™¨å°±åŠ 1ï¼›å½“å¼•ç”¨å¤±æ•ˆæ—¶ï¼Œå¼•ç”¨è®¡æ•°å™¨å°±å‡1ã€‚åªè¦å¯¹è±¡Açš„å¼•ç”¨è®¡æ•°å™¨çš„å€¼ä¸º0ï¼Œå³è¡¨ç¤ºå¯¹è±¡Aä¸å¯èƒ½å†è¢«ä½¿ç”¨ï¼Œå¯è¿›è¡Œå›æ”¶ã€‚
ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œåƒåœ¾å¯¹è±¡ä¾¿äºè¾¨è¯†ï¼›åˆ¤å®šæ•ˆç‡é«˜ï¼Œå›æ”¶æ²¡æœ‰å»¶è¿Ÿæ€§ã€‚
ç¼ºç‚¹ï¼š
å®ƒéœ€è¦å•ç‹¬çš„å­—æ®µå­˜å‚¨è®¡æ•°å™¨ï¼Œè¿™æ ·çš„åšæ³•å¢åŠ äº†å­˜å‚¨ç©ºé—´çš„å¼€é”€ã€‚
æ¯æ¬¡èµ‹å€¼éƒ½éœ€è¦æ›´æ–°è®¡æ•°å™¨ï¼Œä¼´éšç€åŠ æ³•å’Œå‡æ³•æ“ä½œï¼Œè¿™å¢åŠ äº†æ—¶é—´å¼€é”€ã€‚
å¼•ç”¨è®¡æ•°å™¨æœ‰ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œå³æ— æ³•å¤„ç†å¾ªç¯å¼•ç”¨çš„æƒ…å†µã€‚è¿™æ˜¯ä¸€æ¡è‡´å‘½ç¼ºé™·ï¼Œå¯¼è‡´åœ¨Javaçš„åƒåœ¾å›æ”¶å™¨ä¸­æ²¡æœ‰ä½¿ç”¨è¿™ç±»ç®—æ³•ã€‚




å¾ªç¯å¼•ç”¨
å½“pçš„æŒ‡é’ˆæ–­å¼€çš„æ—¶å€™ï¼Œå†…éƒ¨çš„å¼•ç”¨å½¢æˆä¸€ä¸ªå¾ªç¯ï¼Œè®¡æ•°å™¨éƒ½è¿˜ç®—1ï¼Œæ— æ³•è¢«å›æ”¶ï¼Œè¿™å°±æ˜¯å¾ªç¯å¼•ç”¨ï¼Œä»è€Œé€ æˆå†…å­˜æ³„æ¼****



  

éªŒè¯Javaæ˜¯å¦é‡‡ç”¨çš„æ˜¯å¼•ç”¨è®¡æ•°ç®—æ³•

  package com.peppa.gc;/** * -XX:+PrintGCDetails * å¼•ç”¨è®¡æ•°ç®—æ³•æµ‹è¯• * * @author: peppa * @create: 2022-03-05 16:44:15 */public class RefCountGC &#123;    // è¿™ä¸ªæˆå‘˜å±æ€§çš„å”¯ä¸€ä½œç”¨å°±æ˜¯å ç”¨ä¸€ç‚¹å†…å­˜    private byte[] bigSize = new byte[5*1024*1024];    // å¼•ç”¨    Object reference = null;    public static void main(String[] args) &#123;        RefCountGC obj1 = new RefCountGC();        RefCountGC obj2 = new RefCountGC();        obj1.reference = obj2;        obj2.reference = obj1;        obj1 = null;        obj2 = null;        // æ˜¾ç¤ºçš„æ‰§è¡Œåƒåœ¾æ”¶é›†è¡Œä¸ºï¼Œåˆ¤æ–­obj1 å’Œ obj2æ˜¯å¦è¢«å›æ”¶ï¼Ÿ        System.gc();    &#125;&#125;
  [GC (System.gc()) [PSYoungGen: 15093K-&gt;808K(94208K)] 15093K-&gt;816K(310272K), 0.0010090 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] [Full GC (System.gc()) [PSYoungGen: 808K-&gt;0K(94208K)] [ParOldGen: 8K-&gt;627K(216064K)] 816K-&gt;627K(310272K), [Metaspace: 3226K-&gt;3226K(1056768K)], 0.0038155 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] Heap PSYoungGen      total 94208K, used 809K [0x0000000756f80000, 0x000000075d880000, 0x00000007c0000000)  eden space 80896K, 1% used [0x0000000756f80000,0x000000075704a548,0x000000075be80000)  from space 13312K, 0% used [0x000000075be80000,0x000000075be80000,0x000000075cb80000)  to   space 13312K, 0% used [0x000000075cb80000,0x000000075cb80000,0x000000075d880000) ParOldGen       total 216064K, used 627K [0x0000000684e00000, 0x0000000692100000, 0x0000000756f80000)  object space 216064K, 0% used [0x0000000684e00000,0x0000000684e9cc80,0x0000000692100000) Metaspace       used 3233K, capacity 4496K, committed 4864K, reserved 1056768K  class space    used 350K, capacity 388K, committed 512K, reserved 1048576K
  æˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°ï¼Œä¸Šè¿°è¿›è¡Œäº†GCæ”¶é›†çš„è¡Œä¸ºï¼Œå°†ä¸Šè¿°çš„æ–°ç”Ÿä»£ä¸­çš„ä¸¤ä¸ªå¯¹è±¡éƒ½è¿›è¡Œå›æ”¶äº†
  [GC (System.gc()) [PSYoungGen: 15093K-&gt;808K(94208K)] 15093K-&gt;816K(310272K), 0.0010090 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
   å¦‚æœä½¿ç”¨å¼•ç”¨è®¡æ•°ç®—æ³•ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå¯¹è±¡ä¼šæ— æ³•å›æ”¶ã€‚è€Œç°åœ¨ä¸¤ä¸ªå¯¹è±¡è¢«å›æ”¶äº†ï¼Œè¯´æ˜Javaä½¿ç”¨çš„ä¸æ˜¯å¼•ç”¨è®¡æ•°ç®—æ³•æ¥è¿›è¡Œæ ‡è®°çš„ã€‚
  

å¯è¾¾æ€§åˆ†æç®—æ³•

æ¦‚å¿µï¼š
å¯è¾¾æ€§åˆ†æç®—æ³•ï¼šä¹Ÿå¯ä»¥ç§°ä¸ºæ ¹æœç´¢ç®—æ³•ã€è¿½è¸ªæ€§åƒåœ¾æ”¶é›†
ç›¸å¯¹äºå¼•ç”¨è®¡æ•°ç®—æ³•è€Œè¨€ï¼Œå¯è¾¾æ€§åˆ†æç®—æ³•ä¸ä»…åŒæ ·å…·å¤‡å®ç°ç®€å•å’Œæ‰§è¡Œé«˜æ•ˆç­‰ç‰¹ç‚¹ï¼Œæ›´é‡è¦çš„æ˜¯è¯¥ç®—æ³•å¯ä»¥æœ‰æ•ˆåœ°è§£å†³åœ¨å¼•ç”¨è®¡æ•°ç®—æ³•ä¸­å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼çš„å‘ç”Ÿã€‚
ç›¸è¾ƒäºå¼•ç”¨è®¡æ•°ç®—æ³•ï¼Œè¿™é‡Œçš„å¯è¾¾æ€§åˆ†æå°±æ˜¯Javaã€C#é€‰æ‹©çš„ã€‚è¿™ç§ç±»å‹çš„åƒåœ¾æ”¶é›†é€šå¸¸ä¹Ÿå«ä½œè¿½è¸ªæ€§åƒåœ¾æ”¶é›†ï¼ˆTracing Garbage Collectionï¼‰




å¯è¾¾æ€§åˆ†æå®ç°æ€è·¯
æ‰€è°“â€GCRootsâ€æ ¹é›†åˆå°±æ˜¯ä¸€ç»„å¿…é¡»æ´»è·ƒçš„å¼•ç”¨

å…¶åŸºæœ¬æ€è·¯å¦‚ä¸‹ï¼š

å¯è¾¾æ€§åˆ†æç®—æ³•æ˜¯ä»¥æ ¹å¯¹è±¡é›†åˆï¼ˆGCRootsï¼‰ä¸ºèµ·å§‹ç‚¹ï¼ŒæŒ‰ç…§ä»ä¸Šè‡³ä¸‹çš„æ–¹å¼æœç´¢è¢«æ ¹å¯¹è±¡é›†åˆæ‰€è¿æ¥çš„ç›®æ ‡å¯¹è±¡æ˜¯å¦å¯è¾¾ã€‚
ä½¿ç”¨å¯è¾¾æ€§åˆ†æç®—æ³•åï¼Œå†…å­˜ä¸­çš„å­˜æ´»å¯¹è±¡éƒ½ä¼šè¢«æ ¹å¯¹è±¡é›†åˆç›´æ¥æˆ–é—´æ¥è¿æ¥ç€ï¼Œæœç´¢æ‰€èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºå¼•ç”¨é“¾ï¼ˆReference Chainï¼‰
å¦‚æœç›®æ ‡å¯¹è±¡æ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿ï¼Œåˆ™æ˜¯ä¸å¯è¾¾çš„ï¼Œå°±æ„å‘³ç€è¯¥å¯¹è±¡å·±ç»æ­»äº¡ï¼Œå¯ä»¥æ ‡è®°åƒåœ¾å¯¹è±¡ã€‚
åœ¨å¯è¾¾æ€§åˆ†æç®—æ³•ä¸­ï¼Œåªæœ‰èƒ½å¤Ÿè¢«æ ¹å¯¹è±¡é›†åˆç›´æ¥æˆ–è€…é—´æ¥è¿æ¥çš„å¯¹è±¡æ‰æ˜¯å­˜æ´»å¯¹è±¡ã€‚

  





æ ‡è®°-æ¸…é™¤ç®—æ³•

åƒåœ¾æ¸…é™¤é˜¶æ®µ

å½“æˆåŠŸåŒºåˆ†å‡ºå†…å­˜ä¸­å­˜æ´»å¯¹è±¡å’Œæ­»äº¡å¯¹è±¡åï¼ŒGCæ¥ä¸‹æ¥çš„ä»»åŠ¡å°±æ˜¯æ‰§è¡Œåƒåœ¾å›æ”¶ï¼Œé‡Šæ”¾æ‰æ— ç”¨å¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ç©ºé—´ï¼Œä»¥ä¾¿æœ‰è¶³å¤Ÿçš„å¯ç”¨å†…å­˜ç©ºé—´ä¸ºæ–°å¯¹è±¡åˆ†é…å†…å­˜ã€‚ç›®å‰åœ¨JVMä¸­æ¯”è¾ƒå¸¸è§çš„ä¸‰ç§åƒåœ¾æ”¶é›†ç®—æ³•æ˜¯
æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼ˆMark-Sweepï¼‰
å¤åˆ¶ç®—æ³•ï¼ˆCopyingï¼‰
æ ‡è®°-å‹ç¼©ç®—æ³•ï¼ˆMark-Compactï¼‰


æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼ˆMark-Sweepï¼‰æ˜¯ä¸€ç§éå¸¸åŸºç¡€å’Œå¸¸è§çš„åƒåœ¾æ”¶é›†ç®—æ³•ï¼Œè¯¥ç®—æ³•è¢«J.McCarthyç­‰äººåœ¨1960å¹´æå‡ºå¹¶å¹¶åº”ç”¨äºLispè¯­è¨€ã€‚


æ‰§è¡Œè¿‡ç¨‹

å½“å †ä¸­çš„æœ‰æ•ˆå†…å­˜ç©ºé—´ï¼ˆavailable memoryï¼‰è¢«è€—å°½çš„æ—¶å€™ï¼Œå°±ä¼šåœæ­¢æ•´ä¸ªç¨‹åºï¼ˆä¹Ÿè¢«ç§°ä¸ºstop the worldï¼‰ï¼Œç„¶åè¿›è¡Œä¸¤é¡¹å·¥ä½œï¼Œç¬¬ä¸€é¡¹åˆ™æ˜¯æ ‡è®°ï¼Œç¬¬äºŒé¡¹åˆ™æ˜¯æ¸…é™¤
æ ‡è®°ï¼šCollectorä»å¼•ç”¨æ ¹èŠ‚ç‚¹å¼€å§‹éå†ï¼Œæ ‡è®°æ‰€æœ‰è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚ä¸€èˆ¬æ˜¯åœ¨å¯¹è±¡çš„Headerä¸­è®°å½•ä¸ºå¯è¾¾å¯¹è±¡ã€‚
æ ‡è®°çš„æ˜¯å¼•ç”¨çš„å¯¹è±¡ï¼Œä¸æ˜¯åƒåœ¾ï¼ï¼


æ¸…é™¤ï¼šCollectorå¯¹å †å†…å­˜ä»å¤´åˆ°å°¾è¿›è¡Œçº¿æ€§çš„éå†ï¼Œå¦‚æœå‘ç°æŸä¸ªå¯¹è±¡åœ¨å…¶Headerä¸­æ²¡æœ‰æ ‡è®°ä¸ºå¯è¾¾å¯¹è±¡ï¼Œåˆ™å°†å…¶å›æ”¶

  
  

æ ‡è®°-æ¸…é™¤ç®—æ³•çš„ç¼ºç‚¹

æ ‡è®°æ¸…é™¤ç®—æ³•çš„æ•ˆç‡ä¸ç®—é«˜
åœ¨è¿›è¡ŒGCçš„æ—¶å€™ï¼Œéœ€è¦åœæ­¢æ•´ä¸ªåº”ç”¨ç¨‹åºï¼Œç”¨æˆ·ä½“éªŒè¾ƒå·®
è¿™ç§æ–¹å¼æ¸…ç†å‡ºæ¥çš„ç©ºé—²å†…å­˜æ˜¯ä¸è¿ç»­çš„ï¼Œäº§ç”Ÿå†…ç¢ç‰‡ï¼Œéœ€è¦ç»´æŠ¤ä¸€ä¸ªç©ºé—²åˆ—è¡¨


æ³¨æ„ï¼šä½•ä¸ºæ¸…é™¤ï¼Ÿ

è¿™é‡Œæ‰€è°“çš„æ¸…é™¤å¹¶ä¸æ˜¯çœŸçš„ç½®ç©ºï¼Œè€Œæ˜¯æŠŠéœ€è¦æ¸…é™¤çš„å¯¹è±¡åœ°å€ä¿å­˜åœ¨ç©ºé—²çš„åœ°å€åˆ—è¡¨é‡Œã€‚ä¸‹æ¬¡æœ‰æ–°å¯¹è±¡éœ€è¦åŠ è½½æ—¶ï¼Œåˆ¤æ–­åƒåœ¾çš„ä½ç½®ç©ºé—´æ˜¯å¦å¤Ÿï¼Œå¦‚æœå¤Ÿï¼Œå°±å­˜æ”¾ï¼ˆä¹Ÿå°±æ˜¯è¦†ç›–åŸæœ‰çš„åœ°å€ï¼‰ã€‚
å…³äºç©ºé—²åˆ—è¡¨æ˜¯åœ¨ä¸ºå¯¹è±¡åˆ†é…å†…å­˜çš„æ—¶å€™æè¿‡ï¼š
å¦‚æœå†…å­˜è§„æ•´
é‡‡ç”¨æŒ‡é’ˆç¢°æ’çš„æ–¹å¼è¿›è¡Œå†…å­˜åˆ†é…


å¦‚æœå†…å­˜ä¸è§„æ•´
è™šæ‹Ÿæœºéœ€è¦ç»´æŠ¤ä¸€ä¸ªç©ºé—²åˆ—è¡¨
é‡‡ç”¨ç©ºé—²åˆ—è¡¨åˆ†é…å†…å­˜






GC Rootså¯ä»¥æ˜¯å“ªäº›ï¼Ÿ

è™šæ‹Ÿæœºæ ˆä¸­å¼•ç”¨çš„å¯¹è±¡
æ¯”å¦‚ï¼šå„ä¸ªçº¿ç¨‹è¢«è°ƒç”¨çš„æ–¹æ³•ä¸­ä½¿ç”¨åˆ°çš„å‚æ•°ã€å±€éƒ¨å˜é‡ç­‰ã€‚


æœ¬åœ°æ–¹æ³•æ ˆå†…JNIï¼ˆé€šå¸¸è¯´çš„æœ¬åœ°æ–¹æ³•ï¼‰å¼•ç”¨çš„å¯¹è±¡
æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡
æ¯”å¦‚ï¼šJavaç±»çš„å¼•ç”¨ç±»å‹é™æ€å˜é‡


æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡
æ¯”å¦‚ï¼šå­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆStringTableï¼‰é‡Œçš„å¼•ç”¨


æ‰€æœ‰è¢«åŒæ­¥é”synchronizedæŒæœ‰çš„å¯¹è±¡
Javaè™šæ‹Ÿæœºå†…éƒ¨çš„å¼•ç”¨ã€‚
åŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„Classå¯¹è±¡ï¼Œä¸€äº›å¸¸é©»çš„å¼‚å¸¸å¯¹è±¡ï¼ˆå¦‚ï¼šNullPointerExceptionã€OutofMemoryErrorï¼‰ï¼Œç³»ç»Ÿç±»åŠ è½½å™¨ã€‚


åæ˜ javaè™šæ‹Ÿæœºå†…éƒ¨æƒ…å†µçš„JMXBeanã€JVMTIä¸­æ³¨å†Œçš„å›è°ƒã€æœ¬åœ°ä»£ç ç¼“å­˜ç­‰ã€‚

  

æ³¨æ„
å¦‚æœè¦ä½¿ç”¨å¯è¾¾æ€§åˆ†æç®—æ³•æ¥åˆ¤æ–­å†…å­˜æ˜¯å¦å¯å›æ”¶ï¼Œé‚£ä¹ˆåˆ†æå·¥ä½œå¿…é¡»åœ¨ä¸€ä¸ªèƒ½ä¿éšœä¸€è‡´æ€§çš„å¿«ç…§ä¸­è¿›è¡Œã€‚è¿™ç‚¹ä¸æ»¡è¶³çš„è¯åˆ†æç»“æœçš„å‡†ç¡®æ€§å°±æ— æ³•ä¿è¯ã€‚
è¿™ç‚¹ä¹Ÿæ˜¯å¯¼è‡´GCè¿›è¡Œæ—¶å¿…é¡»â€œStop The Worldâ€çš„ä¸€ä¸ªé‡è¦åŸå› ã€‚å³ä½¿æ˜¯å·ç§°ï¼ˆå‡ ä¹ï¼‰ä¸ä¼šå‘ç”Ÿåœé¡¿çš„CMSæ”¶é›†å™¨ä¸­ï¼Œæšä¸¾æ ¹èŠ‚ç‚¹æ—¶ä¹Ÿæ˜¯å¿…é¡»è¦åœé¡¿çš„ã€‚






æ¸…é™¤é˜¶æ®µï¼šå¤åˆ¶ç®—æ³•

èƒŒæ™¯

ä¸ºäº†è§£å†³æ ‡è®°-æ¸…é™¤ç®—æ³•åœ¨åƒåœ¾æ”¶é›†æ•ˆç‡æ–¹é¢çš„ç¼ºé™·ï¼ŒM.L.Minskyäº1963å¹´å‘è¡¨äº†è‘—åçš„è®ºæ–‡ï¼Œâ€œä½¿ç”¨åŒå­˜å‚¨åŒºçš„Lispè¯­è¨€åƒåœ¾æ”¶é›†å™¨CA LISP Garbage Collector Algorithm Using Serial Secondary Storageï¼‰â€ã€‚M.L.Minskyåœ¨è¯¥è®ºæ–‡ä¸­æè¿°çš„ç®—æ³•è¢«äººä»¬ç§°ä¸ºå¤åˆ¶ï¼ˆCopyingï¼‰ç®—æ³•ï¼Œå®ƒä¹Ÿè¢«M.L.Minskyæœ¬äººæˆåŠŸåœ°å¼•å…¥åˆ°äº†Lispè¯­è¨€çš„ä¸€ä¸ªå®ç°ç‰ˆæœ¬ä¸­ã€‚


æ ¸å¿ƒæ€æƒ³

å°†æ´»ç€çš„å†…å­˜ç©ºé—´åˆ†ä¸ºä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­ä¸€å—ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶å°†æ­£åœ¨ä½¿ç”¨çš„å†…å­˜ä¸­çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°æœªè¢«ä½¿ç”¨çš„å†…å­˜å—ä¸­ï¼Œä¹‹åæ¸…é™¤æ­£åœ¨ä½¿ç”¨çš„å†…å­˜å—ä¸­çš„æ‰€æœ‰å¯¹è±¡ï¼Œäº¤æ¢ä¸¤ä¸ªå†…å­˜çš„è§’è‰²ï¼Œæœ€åå®Œæˆåƒåœ¾å›æ”¶ã€‚

  

æŠŠå¯è¾¾çš„å¯¹è±¡ï¼Œç›´æ¥å¤åˆ¶åˆ°å¦å¤–ä¸€ä¸ªåŒºåŸŸä¸­å¤åˆ¶å®Œæˆåï¼ŒAåŒºå°±æ²¡æœ‰ç”¨äº†ï¼Œé‡Œé¢çš„å¯¹è±¡å¯ä»¥ç›´æ¥æ¸…é™¤æ‰ï¼Œå…¶å®é‡Œé¢çš„æ–°ç”Ÿä»£é‡Œé¢å°±ç”¨åˆ°äº†å¤åˆ¶ç®—æ³•

  
  

ä¼˜ç‚¹

æ²¡æœ‰æ ‡è®°å’Œæ¸…é™¤è¿‡ç¨‹ï¼Œå®ç°ç®€å•ï¼Œè¿è¡Œé«˜æ•ˆ
å¤åˆ¶è¿‡å»ä»¥åä¿è¯ç©ºé—´çš„è¿ç»­æ€§ï¼Œä¸ä¼šå‡ºç°â€œç¢ç‰‡â€é—®é¢˜ã€‚


ç¼ºç‚¹

æ­¤ç®—æ³•çš„ç¼ºç‚¹ä¹Ÿæ˜¯å¾ˆæ˜æ˜¾çš„ï¼Œå°±æ˜¯éœ€è¦ä¸¤å€çš„å†…å­˜ç©ºé—´ã€‚
å¯¹äºG1è¿™ç§åˆ†æ‹†æˆä¸ºå¤§é‡regionçš„GCï¼Œå¤åˆ¶è€Œä¸æ˜¯ç§»åŠ¨ï¼Œæ„å‘³ç€GCéœ€è¦ç»´æŠ¤regionä¹‹é—´å¯¹è±¡å¼•ç”¨å…³ç³»ï¼Œä¸ç®¡æ˜¯å†…å­˜å ç”¨æˆ–è€…æ—¶é—´å¼€é”€ä¹Ÿä¸å°


æ³¨æ„

å¦‚æœç³»ç»Ÿä¸­çš„åƒåœ¾å¯¹è±¡å¾ˆå¤šï¼Œå¤åˆ¶ç®—æ³•éœ€è¦å¤åˆ¶çš„å­˜æ´»å¯¹è±¡æ•°é‡å¹¶ä¸ä¼šå¤ªå¤§ï¼Œæˆ–è€…è¯´éå¸¸ä½æ‰è¡Œï¼ˆè€å¹´ä»£å¤§é‡çš„å¯¹è±¡å­˜æ´»ï¼Œé‚£ä¹ˆå¤åˆ¶çš„å¯¹è±¡å°†ä¼šæœ‰å¾ˆå¤šï¼Œæ•ˆç‡ä¼šå¾ˆä½ï¼‰
åœ¨æ–°ç”Ÿä»£ï¼Œå¯¹å¸¸è§„åº”ç”¨çš„åƒåœ¾å›æ”¶ï¼Œä¸€æ¬¡é€šå¸¸å¯ä»¥å›æ”¶70% - 99% çš„å†…å­˜ç©ºé—´ã€‚å›æ”¶æ€§ä»·æ¯”å¾ˆé«˜ã€‚æ‰€ä»¥ç°åœ¨çš„å•†ä¸šè™šæ‹Ÿæœºéƒ½æ˜¯ç”¨è¿™ç§æ”¶é›†ç®—æ³•å›æ”¶æ–°ç”Ÿä»£ã€‚

  




4.å¯¹è±¡çš„ finalization æœºåˆ¶
æ¦‚è¿°

Javaè¯­è¨€æä¾›äº†å¯¹è±¡ç»ˆæ­¢ï¼ˆfinalizationï¼‰æœºåˆ¶æ¥å…è®¸å¼€å‘äººå‘˜æä¾›å¯¹è±¡è¢«é”€æ¯ä¹‹å‰çš„è‡ªå®šä¹‰å¤„ç†é€»è¾‘ã€‚
å½“åƒåœ¾å›æ”¶å™¨å‘ç°æ²¡æœ‰å¼•ç”¨æŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œå³ï¼šåƒåœ¾å›æ”¶æ­¤å¯¹è±¡ä¹‹å‰ï¼Œæ€»ä¼šå…ˆè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„finalize()æ–¹æ³•ã€‚
finalize() æ–¹æ³•å…è®¸åœ¨å­ç±»ä¸­è¢«é‡å†™ï¼Œç”¨äºåœ¨å¯¹è±¡è¢«å›æ”¶æ—¶è¿›è¡Œèµ„æºé‡Šæ”¾ã€‚é€šå¸¸åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¿›è¡Œä¸€äº›èµ„æºé‡Šæ”¾å’Œæ¸…ç†çš„å·¥ä½œï¼Œæ¯”å¦‚å…³é—­æ–‡ä»¶ã€å¥—æ¥å­—å’Œæ•°æ®åº“è¿æ¥ç­‰ã€‚


å¯¹è±¡é”€æ¯å‰çš„å›è°ƒå‡½æ•°ï¼šfinalize()

Javaè¯­è¨€æä¾›äº†å¯¹è±¡ç»ˆæ­¢ï¼ˆfinalizationï¼‰æœºåˆ¶æ¥å…è®¸å¼€å‘äººå‘˜æä¾›å¯¹è±¡è¢«é”€æ¯ä¹‹å‰çš„è‡ªå®šä¹‰å¤„ç†é€»è¾‘ã€‚
å½“åƒåœ¾å›æ”¶å™¨å‘ç°æ²¡æœ‰å¼•ç”¨æŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œå³ï¼šåƒåœ¾å›æ”¶æ­¤å¯¹è±¡ä¹‹å‰ï¼Œæ€»ä¼šå…ˆè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„finalize()æ–¹æ³•ã€‚
finalize() æ–¹æ³•å…è®¸åœ¨å­ç±»ä¸­è¢«é‡å†™ï¼Œç”¨äºåœ¨å¯¹è±¡è¢«å›æ”¶æ—¶è¿›è¡Œèµ„æºé‡Šæ”¾ã€‚é€šå¸¸åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¿›è¡Œä¸€äº›èµ„æºé‡Šæ”¾å’Œæ¸…ç†çš„å·¥ä½œï¼Œæ¯”å¦‚å…³é—­æ–‡ä»¶ã€å¥—æ¥å­—å’Œæ•°æ®åº“è¿æ¥ç­‰ã€‚


æ³¨æ„äº‹é¡¹ï¼š
  æ°¸è¿œä¸è¦ä¸»åŠ¨è°ƒç”¨æŸä¸ªå¯¹è±¡çš„finalizeï¼ˆï¼‰æ–¹æ³•Iåº”è¯¥äº¤ç»™åƒåœ¾å›æ”¶æœºåˆ¶è°ƒç”¨ã€‚ç†ç”±åŒ…æ‹¬ä¸‹é¢ä¸‰ç‚¹ï¼š

åœ¨finalizeï¼ˆï¼‰æ—¶å¯èƒ½ä¼šå¯¼è‡´å¯¹è±¡å¤æ´»ã€‚
finalizeï¼ˆï¼‰æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´æ˜¯æ²¡æœ‰ä¿éšœçš„ï¼Œå®ƒå®Œå…¨ç”±Gcçº¿ç¨‹å†³å®šï¼Œæç«¯æƒ…å†µä¸‹ï¼Œè‹¥ä¸å‘ç”ŸGCï¼Œåˆ™finalizeï¼ˆï¼‰æ–¹æ³•å°†æ²¡æœ‰æ‰§è¡Œæœºä¼šã€‚
å› ä¸ºä¼˜å…ˆçº§æ¯”è¾ƒä½ï¼Œå³ä½¿ä¸»åŠ¨è°ƒç”¨è¯¥æ–¹æ³•ï¼Œä¹Ÿä¸ä¼šå› æ­¤å°±ç›´æ¥è¿›è¡Œå›æ”¶


ä¸€ä¸ªç³Ÿç³•çš„finalizeï¼ˆï¼‰ä¼šä¸¥é‡å½±å“Gcçš„æ€§èƒ½ã€‚


ç”Ÿå­˜è¿˜æ˜¯æ­»äº¡ï¼Ÿ

ç”±äºfinalize()æ–¹æ³•çš„å­˜åœ¨ï¼Œè™šæ‹Ÿæœºä¸­çš„å¯¹è±¡ä¸€èˆ¬å¤„äºä¸‰ç§å¯èƒ½çš„çŠ¶æ€ã€‚

å¦‚æœä»æ‰€æœ‰çš„æ ¹èŠ‚ç‚¹éƒ½æ— æ³•è®¿é—®åˆ°æŸä¸ªå¯¹è±¡ï¼Œè¯´æ˜å¯¹è±¡å·±ç»ä¸å†ä½¿ç”¨äº†ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ­¤å¯¹è±¡éœ€è¦è¢«å›æ”¶ã€‚ä½†äº‹å®ä¸Šï¼Œä¹Ÿå¹¶éæ˜¯â€œéæ­»ä¸å¯â€çš„ï¼Œè¿™æ—¶å€™å®ƒä»¬æš‚æ—¶å¤„äºâ€œç¼“åˆ‘â€é˜¶æ®µã€‚ä¸€ä¸ªæ— æ³•è§¦åŠçš„å¯¹è±¡æœ‰å¯èƒ½åœ¨æŸä¸€ä¸ªæ¡ä»¶ä¸‹â€œå¤æ´»â€è‡ªå·±ï¼Œå¦‚æœè¿™æ ·ï¼Œé‚£ä¹ˆå¯¹å®ƒç«‹å³è¿›è¡Œå›æ”¶å°±æ˜¯ä¸åˆç†çš„ã€‚ä¸ºæ­¤ï¼Œå®šä¹‰è™šæ‹Ÿæœºä¸­çš„å¯¹è±¡å¯èƒ½çš„ä¸‰ç§çŠ¶æ€ã€‚å¦‚ä¸‹ï¼š
å¯è§¦åŠçš„ï¼šä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œå¯ä»¥åˆ°è¾¾è¿™ä¸ªå¯¹è±¡ã€‚
å¯å¤æ´»çš„ï¼šå¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨éƒ½è¢«é‡Šæ”¾ï¼Œä½†æ˜¯å¯¹è±¡æœ‰å¯èƒ½åœ¨finalize()ä¸­å¤æ´»ã€‚
ä¸å¯è§¦åŠçš„ï¼šå¯¹è±¡çš„finalize()è¢«è°ƒç”¨ï¼Œå¹¶ä¸”æ²¡æœ‰å¤æ´»ï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥ä¸å¯è§¦åŠçŠ¶æ€ã€‚ä¸å¯è§¦åŠçš„å¯¹è±¡ä¸å¯èƒ½è¢«å¤æ´»ï¼Œå› ä¸ºfinalize()åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚


ä»¥ä¸Š3ç§çŠ¶æ€ä¸­ï¼Œæ˜¯ç”±äºfinalize()æ–¹æ³•çš„å­˜åœ¨ï¼Œè¿›è¡Œçš„åŒºåˆ†ã€‚åªæœ‰åœ¨å¯¹è±¡ä¸å¯è§¦åŠæ—¶æ‰å¯ä»¥è¢«å›æ”¶ã€‚


å…·ä½“è¿‡ç¨‹
  åˆ¤å®šä¸€ä¸ªå¯¹è±¡objAæ˜¯å¦å¯å›æ”¶ï¼Œè‡³å°‘è¦ç»å†ä¸¤æ¬¡æ ‡è®°è¿‡ç¨‹ï¼š

å¦‚æœå¯¹è±¡objAåˆ°GC Rootsæ²¡æœ‰å¼•ç”¨é“¾ï¼Œåˆ™è¿›è¡Œç¬¬ä¸€æ¬¡æ ‡è®°ã€‚

è¿›è¡Œç­›é€‰ï¼Œåˆ¤æ–­æ­¤å¯¹è±¡æ˜¯å¦æœ‰å¿…è¦æ‰§è¡Œfinalizeï¼ˆï¼‰æ–¹æ³•

å¦‚æœå¯¹è±¡objAæ²¡æœ‰é‡å†™finalizeï¼ˆï¼‰æ–¹æ³•ï¼Œæˆ–è€…finalizeï¼ˆï¼‰æ–¹æ³•å·²ç»è¢«è™šæ‹Ÿæœºè°ƒç”¨è¿‡ï¼Œåˆ™è™šæ‹Ÿæœºè§†ä¸ºâ€œæ²¡æœ‰å¿…è¦æ‰§è¡Œâ€ï¼ŒobjAè¢«åˆ¤å®šä¸ºä¸å¯è§¦åŠçš„ã€‚
å¦‚æœå¯¹è±¡objAé‡å†™äº†finalizeï¼ˆï¼‰æ–¹æ³•ï¼Œä¸”è¿˜æœªæ‰§è¡Œè¿‡ï¼Œé‚£ä¹ˆobjAä¼šè¢«æ’å…¥åˆ°F-Queueé˜Ÿåˆ—ä¸­ï¼Œç”±ä¸€ä¸ªè™šæ‹Ÿæœºè‡ªåŠ¨åˆ›å»ºçš„ã€ä½ä¼˜å…ˆçº§çš„Finalizerçº¿ç¨‹è§¦å‘å…¶finalizeï¼ˆï¼‰æ–¹æ³•æ‰§è¡Œã€‚
finalizeï¼ˆï¼‰æ–¹æ³•æ˜¯å¯¹è±¡é€ƒè„±æ­»äº¡çš„æœ€åæœºä¼šï¼Œç¨åGCä¼šå¯¹F-Queueé˜Ÿåˆ—ä¸­çš„å¯¹è±¡è¿›è¡Œç¬¬äºŒæ¬¡æ ‡è®°ã€‚å¦‚æœobjAåœ¨finalizeï¼ˆï¼‰æ–¹æ³•ä¸­ä¸å¼•ç”¨é“¾ä¸Šçš„ä»»ä½•ä¸€ä¸ªå¯¹è±¡å»ºç«‹äº†è”ç³»ï¼Œé‚£ä¹ˆåœ¨ç¬¬äºŒæ¬¡æ ‡è®°æ—¶ï¼ŒobjAä¼šè¢«ç§»å‡ºâ€œå³å°†å›æ”¶â€é›†åˆã€‚ä¹‹åï¼Œå¯¹è±¡ä¼šå†æ¬¡å‡ºç°æ²¡æœ‰å¼•ç”¨å­˜åœ¨çš„æƒ…å†µã€‚åœ¨è¿™ä¸ªæƒ…å†µä¸‹ï¼Œfinalizeæ–¹æ³•ä¸ä¼šè¢«å†æ¬¡è°ƒç”¨ï¼Œå¯¹è±¡ä¼šç›´æ¥å˜æˆä¸å¯è§¦åŠçš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªå¯¹è±¡çš„finalizeæ–¹æ³•åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚

  



ä»£ç æ¼”ç¤º finalize() æ–¹æ³•å¯å¤æ´»å¯¹è±¡

æˆ‘ä»¬é‡å†™ CanReliveObj ç±»çš„ finalize()æ–¹æ³•ï¼Œåœ¨è°ƒç”¨å…¶ finalize()æ–¹æ³•æ—¶ï¼Œå°† obj æŒ‡å‘å½“å‰ç±»å¯¹è±¡ this
åœ¨è¿›è¡Œç¬¬ä¸€æ¬¡æ¸…é™¤çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šæ‰§è¡Œfinalizeæ–¹æ³•ï¼Œç„¶å å¯¹è±¡ è¿›è¡Œäº†ä¸€æ¬¡è‡ªæ•‘æ“ä½œï¼Œä½†æ˜¯å› ä¸ºfinalize()æ–¹æ³•åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œå› æ­¤ç¬¬äºŒæ¬¡è¯¥å¯¹è±¡å°†ä¼šè¢«åƒåœ¾æ¸…é™¤ã€‚

  package com.peppa.gc;/** * æµ‹è¯•Objectç±»ä¸­finalize()æ–¹æ³•ï¼Œå³å¯¹è±¡çš„finalizationæœºåˆ¶ã€‚ * @author: peppa * @create: 2022-03-05 17:54:15 */public class CanReliveObj &#123;    //ç±»å˜é‡ï¼Œå±äº GC Root    public static CanReliveObj obj;    /**     * æ­¤æ–¹æ³•åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡     * @throws Throwable     */    @Override    protected void finalize() throws Throwable &#123;        super.finalize();        System.out.println(&quot;è°ƒç”¨å½“å‰ç±»é‡å†™çš„finalize()æ–¹æ³•&quot;);        //å½“å‰å¾…å›æ”¶çš„å¯¹è±¡åœ¨finalize()æ–¹æ³•ä¸­ä¸å¼•ç”¨é“¾ä¸Šçš„ä¸€ä¸ªå¯¹è±¡objå»ºç«‹äº†è”ç³»        obj = this;    &#125;    public static void main(String[] args) &#123;        try &#123;            obj = new CanReliveObj();            obj = null;            System.gc();//è°ƒç”¨åƒåœ¾å›æ”¶å™¨            System.out.println(&quot;-----------------ç¬¬ä¸€æ¬¡gcæ“ä½œ------------&quot;);            // å› ä¸ºFinalizerçº¿ç¨‹ä¼˜å…ˆçº§å¾ˆä½ï¼Œæš‚åœ2ç§’ï¼Œä»¥ç­‰å¾…å®ƒ            Thread.sleep(2000);            if (obj == null) &#123;                System.out.println(&quot;obj is dead&quot;);            &#125; else &#123;                System.out.println(&quot;obj is still alive&quot;);            &#125;            System.out.println(&quot;-----------------ç¬¬äºŒæ¬¡gcæ“ä½œ------------&quot;);            obj = null;            System.gc();            // ä¸‹é¢ä»£ç å’Œä¸Šé¢ä»£ç æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯ canReliveObjå´è‡ªæ•‘å¤±è´¥äº†            // å› ä¸ºFinalizerçº¿ç¨‹ä¼˜å…ˆçº§å¾ˆä½ï¼Œæš‚åœ2ç§’ï¼Œä»¥ç­‰å¾…å®ƒ            Thread.sleep(2000);            if (obj == null) &#123;                System.out.println(&quot;obj is dead&quot;);            &#125; else &#123;                System.out.println(&quot;obj is still alive&quot;);            &#125;        &#125; catch (InterruptedException e) &#123;            e.printStackTrace();        &#125;    &#125;&#125;

æœ€åè¿è¡Œç»“æœ

  è°ƒç”¨å½“å‰ç±»é‡å†™çš„finalize()æ–¹æ³•-----------------ç¬¬ä¸€æ¬¡gcæ“ä½œ------------obj is still alive-----------------ç¬¬äºŒæ¬¡gcæ“ä½œ------------obj is dead



5.MATä¸JProfilerçš„GC Rootsæº¯æº
MAT

ä»‹ç»

MATæ˜¯Memory Analyzerçš„ç®€ç§°ï¼Œå®ƒæ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„Javaå †å†…å­˜åˆ†æå™¨ã€‚ç”¨äºæŸ¥æ‰¾å†…å­˜æ³„æ¼ä»¥åŠæŸ¥çœ‹å†…å­˜æ¶ˆè€—æƒ…å†µã€‚
MATæ˜¯åŸºäºEclipseå¼€å‘çš„ï¼Œæ˜¯ä¸€æ¬¾å…è´¹çš„æ€§èƒ½åˆ†æå·¥å…·ã€‚
ä¸‹è½½åœ°å€ï¼šEclipse Memory Analyzer Open Source Project | The Eclipse Foundation


è·å–dumpæ–‡ä»¶

å‘½ä»¤è¡Œä½¿ç”¨ jmap

  C:\Users\yuanxw&gt;jps13376 Jps16176 RefCountGC585616824 Launcher16700 MainC:\Users\yuanxw&gt;jmap -dump:format=b,live,file=refcountgc.bin 16176Dumping heap to C:\Users\yuanxw\refcountgc.bin ...Heap dump file created

æ‰“å¼€åï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°æœ‰å“ªäº›å¯ä»¥ä½œä¸ºGC Rootsçš„å¯¹è±¡

  



JProfiler

JProfilerçš„GC Rootsæº¯æº

åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¾ˆå°‘ä¼šæŸ¥çœ‹æ‰€æœ‰çš„GC Rootsã€‚ä¸€èˆ¬éƒ½æ˜¯æŸ¥çœ‹æŸä¸€ä¸ªæˆ–å‡ ä¸ªå¯¹è±¡çš„GC Rootæ˜¯å“ªä¸ªï¼Œè¿™ä¸ªè¿‡ç¨‹å«GC Roots æº¯æº
ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ä½¿ç”¨ JProfiler è¿›è¡Œ GC Roots æº¯æºæ¼”ç¤º

  
  - 

å¦‚ä½•åˆ¤æ–­ä»€ä¹ˆåŸå› é€ æˆOOM

å½“æˆ‘ä»¬ç¨‹åºå‡ºç°OOMçš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦è¿›è¡Œæ’æŸ¥ï¼Œæˆ‘ä»¬é¦–å…ˆä½¿ç”¨ä¸‹é¢çš„ä¾‹å­è¿›è¡Œè¯´æ˜

  package com.peppa.gc;import java.util.ArrayList;/** * å†…å­˜æº¢å‡ºæ’æŸ¥ * -Xms8m -Xmx8m -XX:+HeapDumpOnOutOfMemoryError * è¿™ä¸ªå‚æ•°çš„æ„æ€æ˜¯å½“ç¨‹åºå‡ºç°OOMçš„æ—¶å€™å°±ä¼šåœ¨å½“å‰å·¥ç¨‹ç›®å½•ç”Ÿæˆä¸€ä¸ªdumpæ–‡ä»¶ */public class HeapOOM &#123;    byte[] buffer = new byte[1 * 1024 * 1024];//1MB    public static void main(String[] args) &#123;        ArrayList&lt;HeapOOM&gt; list = new ArrayList&lt;&gt;();        int count = 0;        try&#123;            while(true)&#123;                list.add(new HeapOOM());                count++;            &#125;        &#125;catch (Throwable e)&#123;            System.out.println(&quot;count = &quot; + count);            e.printStackTrace();        &#125;    &#125;&#125;
  ä¸Šè¿°ä»£ç å°±æ˜¯ä¸æ–­çš„åˆ›å»ºä¸€ä¸ª1Må°å­—èŠ‚æ•°ç»„ï¼Œç„¶åè®©å†…å­˜æº¢å‡ºï¼Œæˆ‘ä»¬éœ€è¦é™åˆ¶ä¸€ä¸‹å†…å­˜å¤§å°ï¼ŒåŒæ—¶ä½¿ç”¨HeapDumpOnOutOfMemoryErrorå°†å‡ºé”™æ—¶å€™çš„dumpæ–‡ä»¶è¾“å‡º
  java.lang.OutOfMemoryError: Java heap spaceDumping heap to java_pid7196.hprof ...Heap dump file created [7705267 bytes in 0.009 secs]count = 6java.lang.OutOfMemoryError: Java heap space	at com.peppa.gc.HeapOOM.&lt;init&gt;(HeapOOM.java:10)	at com.peppa.gc.HeapOOM.main(HeapOOM.java:18)
  æˆ‘ä»¬å°†ç”Ÿæˆçš„dumpæ–‡ä»¶æ‰“å¼€ï¼Œç„¶åç‚¹å‡»Biggest Objectså°±èƒ½å¤Ÿçœ‹åˆ°è¶…å¤§å¯¹è±¡
  
  ç„¶åæˆ‘ä»¬é€šè¿‡çº¿ç¨‹ï¼Œè¿˜èƒ½å¤Ÿå®šä½åˆ°å“ªé‡Œå‡ºç°OOM
  



æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-æ•´ç†ç®—æ³•

èƒŒæ™¯

å¤åˆ¶ç®—æ³•çš„é«˜æ•ˆæ€§æ˜¯å»ºç«‹åœ¨å­˜æ´»å¯¹è±¡å°‘ã€åƒåœ¾å¯¹è±¡å¤šçš„å‰æä¸‹çš„ã€‚è¿™ç§æƒ…å†µåœ¨æ–°ç”Ÿä»£ç»å¸¸å‘ç”Ÿï¼Œä½†æ˜¯åœ¨è€å¹´ä»£ï¼Œæ›´å¸¸è§çš„æƒ…å†µæ˜¯å¤§éƒ¨åˆ†å¯¹è±¡éƒ½æ˜¯å­˜æ´»å¯¹è±¡ã€‚å¦‚æœä¾ç„¶ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œç”±äºå­˜æ´»å¯¹è±¡è¾ƒå¤šï¼Œå¤åˆ¶çš„æˆæœ¬ä¹Ÿå°†å¾ˆé«˜ã€‚å› æ­¤ï¼ŒåŸºäºè€å¹´ä»£åƒåœ¾å›æ”¶çš„ç‰¹æ€§ï¼Œéœ€è¦ä½¿ç”¨å…¶ä»–çš„ç®—æ³•ã€‚
æ ‡è®°ä¸€æ¸…é™¤ç®—æ³•çš„ç¡®å¯ä»¥åº”ç”¨åœ¨è€å¹´ä»£ä¸­ï¼Œä½†æ˜¯è¯¥ç®—æ³•ä¸ä»…æ‰§è¡Œæ•ˆç‡ä½ä¸‹ï¼Œè€Œä¸”åœ¨æ‰§è¡Œå®Œå†…å­˜å›æ”¶åè¿˜ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼Œæ‰€ä»¥JvMçš„è®¾è®¡è€…éœ€è¦åœ¨æ­¤åŸºç¡€ä¹‹ä¸Šè¿›è¡Œæ”¹è¿›ã€‚æ ‡è®°-å‹ç¼©ï¼ˆMark-Compactï¼‰ç®—æ³•ç”±æ­¤è¯ç”Ÿã€‚1970å¹´å‰åï¼ŒG.L.Steeleã€C.J.Cheneå’ŒD.s.Wiseç­‰ç ”ç©¶è€…å‘å¸ƒæ ‡è®°-å‹ç¼©ç®—æ³•ã€‚åœ¨è®¸å¤šç°ä»£çš„åƒåœ¾æ”¶é›†å™¨ä¸­ï¼Œäººä»¬éƒ½ä½¿ç”¨äº†æ ‡è®°-å‹ç¼©ç®—æ³•æˆ–å…¶æ”¹è¿›ç‰ˆæœ¬ã€‚


æ‰§è¡Œè¿‡ç¨‹

ç¬¬ä¸€é˜¶æ®µå’Œæ ‡è®°æ¸…é™¤ç®—æ³•ä¸€æ ·ï¼Œä»æ ¹èŠ‚ç‚¹å¼€å§‹æ ‡è®°æ‰€æœ‰è¢«å¼•ç”¨å¯¹è±¡

ç¬¬äºŒé˜¶æ®µå°†æ‰€æœ‰çš„å­˜æ´»å¯¹è±¡å‹ç¼©åˆ°å†…å­˜çš„ä¸€ç«¯ï¼ŒæŒ‰é¡ºåºæ’æ”¾ã€‚ä¹‹åï¼Œæ¸…ç†è¾¹ç•Œå¤–æ‰€æœ‰çš„ç©ºé—´ã€‚
  



æ ‡æ¸…å’Œæ ‡æ•´çš„åŒºåˆ«

æ ‡è®°-å‹ç¼©ç®—æ³•çš„æœ€ç»ˆæ•ˆæœç­‰åŒäºæ ‡è®°-æ¸…é™¤ç®—æ³•æ‰§è¡Œå®Œæˆåï¼Œå†è¿›è¡Œä¸€æ¬¡å†…å­˜ç¢ç‰‡æ•´ç†ï¼Œå› æ­¤ï¼Œä¹Ÿå¯ä»¥æŠŠå®ƒç§°ä¸ºæ ‡è®°-æ¸…é™¤-å‹ç¼©ï¼ˆMark-Sweep-Compactï¼‰ç®—æ³•ã€‚
äºŒè€…çš„æœ¬è´¨å·®å¼‚åœ¨äºæ ‡è®°-æ¸…é™¤ç®—æ³•æ˜¯ä¸€ç§éç§»åŠ¨å¼çš„å›æ”¶ç®—æ³•ï¼Œæ ‡è®°-å‹ç¼©æ˜¯ç§»åŠ¨å¼çš„ã€‚æ˜¯å¦ç§»åŠ¨å›æ”¶åçš„å­˜æ´»å¯¹è±¡æ˜¯ä¸€é¡¹ä¼˜ç¼ºç‚¹å¹¶å­˜çš„é£é™©å†³ç­–ã€‚
æ ‡è®°çš„å­˜æ´»å¯¹è±¡å°†ä¼šè¢«æ•´ç†ï¼ŒæŒ‰ç…§å†…å­˜åœ°å€ä¾æ¬¡æ’åˆ—ï¼Œè€Œæœªè¢«æ ‡è®°çš„å†…å­˜ä¼šè¢«æ¸…ç†æ‰ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œå½“æˆ‘ä»¬éœ€è¦ç»™æ–°å¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼ŒJVMåªéœ€è¦æŒæœ‰ä¸€ä¸ªå†…å­˜çš„èµ·å§‹åœ°å€å³å¯ï¼Œè¿™æ¯”ç»´æŠ¤ä¸€ä¸ªç©ºé—²åˆ—è¡¨æ˜¾ç„¶å°‘äº†è®¸å¤šå¼€é”€ã€‚


æ ‡æ•´çš„ä¼˜ç¼ºç‚¹

ä¼˜ç‚¹
æ¶ˆé™¤äº†æ ‡è®°-æ¸…é™¤ç®—æ³•å½“ä¸­ï¼Œå†…å­˜åŒºåŸŸåˆ†æ•£çš„ç¼ºç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ç»™æ–°å¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼ŒJVMåªéœ€è¦æŒæœ‰ä¸€ä¸ªå†…å­˜çš„èµ·å§‹åœ°å€å³å¯ã€‚
æ¶ˆé™¤äº†å¤åˆ¶ç®—æ³•å½“ä¸­ï¼Œå†…å­˜å‡åŠçš„é«˜é¢ä»£ä»·ã€‚


ç¼ºç‚¹
ä»æ•ˆç‡ä¸Šæ¥è¯´ï¼Œæ ‡è®°-æ•´ç†ç®—æ³•è¦ä½äºå¤åˆ¶ç®—æ³•ã€‚
ç§»åŠ¨å¯¹è±¡çš„åŒæ—¶ï¼Œå¦‚æœå¯¹è±¡è¢«å…¶ä»–å¯¹è±¡å¼•ç”¨ï¼Œåˆ™è¿˜éœ€è¦è°ƒæ•´å¼•ç”¨çš„åœ°å€ï¼ˆå› ä¸ºHotSpotè™šæ‹Ÿæœºé‡‡ç”¨çš„ä¸æ˜¯å¥æŸ„æ± çš„æ–¹å¼ï¼Œè€Œæ˜¯ç›´æ¥æŒ‡é’ˆï¼‰
ç§»åŠ¨è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å…¨ç¨‹æš‚åœç”¨æˆ·åº”ç”¨ç¨‹åºã€‚å³ï¼šSTW






åƒåœ¾å›æ”¶ç®—æ³•å°ç»“

å¯¹æ¯”ä¸‰ç§æ¸…é™¤é˜¶æ®µçš„ç®—æ³•

æ•ˆç‡ä¸Šæ¥è¯´ï¼Œå¤åˆ¶ç®—æ³•æ˜¯å½“ä¹‹æ— æ„§çš„è€å¤§ï¼Œä½†æ˜¯å´æµªè´¹äº†å¤ªå¤šå†…å­˜ã€‚
è€Œä¸ºäº†å°½é‡å…¼é¡¾ä¸Šé¢æåˆ°çš„ä¸‰ä¸ªæŒ‡æ ‡ï¼Œæ ‡è®°-æ•´ç†ç®—æ³•ç›¸å¯¹æ¥è¯´æ›´å¹³æ»‘ä¸€äº›ï¼Œä½†æ˜¯æ•ˆç‡ä¸Šä¸å°½å¦‚äººæ„ï¼Œå®ƒæ¯”å¤åˆ¶ç®—æ³•å¤šäº†ä¸€ä¸ªæ ‡è®°çš„é˜¶æ®µï¼Œæ¯”æ ‡è®°-æ¸…é™¤å¤šäº†ä¸€ä¸ªæ•´ç†å†…å­˜çš„é˜¶æ®µã€‚





æ ‡è®°æ¸…é™¤
æ ‡è®°æ•´ç†
å¤åˆ¶



é€Ÿç‡
ä¸­ç­‰
æœ€æ…¢
æœ€å¿«


ç©ºé—´å¼€é”€
å°‘ï¼ˆä½†ä¼šå †ç§¯ç¢ç‰‡ï¼‰
å°‘ï¼ˆä¸å †ç§¯ç¢ç‰‡ï¼‰
é€šå¸¸éœ€è¦æ´»å¯¹è±¡çš„2å€ç©ºé—´ï¼ˆä¸å †ç§¯ç¢ç‰‡ï¼‰


ç§»åŠ¨å¯¹è±¡
å¦
æ˜¯
æ˜¯



åˆ†ä»£æ”¶é›†ç®—æ³•

å‰é¢æ‰€æœ‰è¿™äº›ç®—æ³•ä¸­ï¼Œå¹¶æ²¡æœ‰ä¸€ç§ç®—æ³•å¯ä»¥å®Œå…¨æ›¿ä»£å…¶ä»–ç®—æ³•ï¼Œå®ƒä»¬éƒ½å…·æœ‰è‡ªå·±ç‹¬ç‰¹çš„ä¼˜åŠ¿å’Œç‰¹ç‚¹ã€‚åˆ†ä»£æ”¶é›†ç®—æ³•åº”è¿è€Œç”Ÿã€‚
åˆ†ä»£æ”¶é›†ç®—æ³•ï¼Œæ˜¯åŸºäºè¿™æ ·ä¸€ä¸ªäº‹å®ï¼šä¸åŒçš„å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸ä¸€æ ·çš„ã€‚å› æ­¤ï¼Œä¸åŒç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡å¯ä»¥é‡‡å–ä¸åŒçš„æ”¶é›†æ–¹å¼ï¼Œä»¥ä¾¿æé«˜å›æ”¶æ•ˆç‡ã€‚ä¸€èˆ¬æ˜¯æŠŠJavaå †åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œè¿™æ ·å°±å¯ä»¥æ ¹æ®å„ä¸ªå¹´ä»£çš„ç‰¹ç‚¹ä½¿ç”¨ä¸åŒçš„å›æ”¶ç®—æ³•ï¼Œä»¥æé«˜åƒåœ¾å›æ”¶çš„æ•ˆç‡ã€‚
åœ¨Javaç¨‹åºè¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šäº§ç”Ÿå¤§é‡çš„å¯¹è±¡ï¼Œå…¶ä¸­æœ‰äº›å¯¹è±¡æ˜¯ä¸ä¸šåŠ¡ä¿¡æ¯ç›¸å…³ï¼Œæ¯”å¦‚Httpè¯·æ±‚ä¸­çš„Sessionå¯¹è±¡ã€çº¿ç¨‹ã€Socketè¿æ¥ï¼Œè¿™ç±»å¯¹è±¡è·Ÿä¸šåŠ¡ç›´æ¥æŒ‚é’©ï¼Œå› æ­¤ç”Ÿå‘½å‘¨æœŸæ¯”è¾ƒé•¿ã€‚ä½†æ˜¯è¿˜æœ‰ä¸€äº›å¯¹è±¡ï¼Œä¸»è¦æ˜¯ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ç”Ÿæˆçš„ä¸´æ—¶å˜é‡ï¼Œè¿™äº›å¯¹è±¡ç”Ÿå‘½å‘¨æœŸä¼šæ¯”è¾ƒçŸ­ï¼Œæ¯”å¦‚ï¼šstringå¯¹è±¡ï¼Œç”±äºå…¶ä¸å˜ç±»çš„ç‰¹æ€§ï¼Œç³»ç»Ÿä¼šäº§ç”Ÿå¤§é‡çš„è¿™äº›å¯¹è±¡ï¼Œæœ‰äº›å¯¹è±¡ç”šè‡³åªç”¨ä¸€æ¬¡å³å¯å›æ”¶ã€‚


ç›®å‰å‡ ä¹æ‰€æœ‰çš„GCéƒ½é‡‡ç”¨åˆ†ä»£æ‰‹æœºç®—æ³•æ‰§è¡Œåƒåœ¾å›æ”¶çš„
  åœ¨HotSpotä¸­ï¼ŒåŸºäºåˆ†ä»£çš„æ¦‚å¿µï¼ŒGCæ‰€ä½¿ç”¨çš„å†…å­˜å›æ”¶ç®—æ³•å¿…é¡»ç»“åˆå¹´è½»ä»£å’Œè€å¹´ä»£å„è‡ªçš„ç‰¹ç‚¹ã€‚

å¹´è½»ä»£ï¼ˆYoung Genï¼‰
  å¹´è½»ä»£ç‰¹ç‚¹ï¼šåŒºåŸŸç›¸å¯¹è€å¹´ä»£è¾ƒå°ï¼Œå¯¹è±¡ç”Ÿå‘½å‘¨æœŸçŸ­ã€å­˜æ´»ç‡ä½ï¼Œå›æ”¶é¢‘ç¹ã€‚
  è¿™ç§æƒ…å†µå¤åˆ¶ç®—æ³•çš„å›æ”¶æ•´ç†ï¼Œé€Ÿåº¦æ˜¯æœ€å¿«çš„ã€‚å¤åˆ¶ç®—æ³•çš„æ•ˆç‡åªå’Œå½“å‰å­˜æ´»å¯¹è±¡å¤§å°æœ‰å…³ï¼Œå› æ­¤å¾ˆé€‚ç”¨äºå¹´è½»ä»£çš„å›æ”¶ã€‚è€Œå¤åˆ¶ç®—æ³•å†…å­˜åˆ©ç”¨ç‡ä¸é«˜çš„é—®é¢˜ï¼Œé€šè¿‡hotspotä¸­çš„ä¸¤ä¸ªsurvivorçš„è®¾è®¡å¾—åˆ°ç¼“è§£ã€‚

è€å¹´ä»£ï¼ˆTenured Genï¼‰
  è€å¹´ä»£ç‰¹ç‚¹ï¼šåŒºåŸŸè¾ƒå¤§ï¼Œå¯¹è±¡ç”Ÿå‘½å‘¨æœŸé•¿ã€å­˜æ´»ç‡é«˜ï¼Œå›æ”¶ä¸åŠå¹´è½»ä»£é¢‘ç¹ã€‚
  è¿™ç§æƒ…å†µå­˜åœ¨å¤§é‡å­˜æ´»ç‡é«˜çš„å¯¹è±¡ï¼Œå¤åˆ¶ç®—æ³•æ˜æ˜¾å˜å¾—ä¸åˆé€‚ã€‚ä¸€èˆ¬æ˜¯ç”±æ ‡è®°-æ¸…é™¤æˆ–è€…æ˜¯æ ‡è®°-æ¸…é™¤ä¸æ ‡è®°-æ•´ç†çš„æ··åˆå®ç°ã€‚

Marké˜¶æ®µçš„å¼€é”€ä¸å­˜æ´»å¯¹è±¡çš„æ•°é‡æˆæ­£æ¯”ã€‚
Sweepé˜¶æ®µçš„å¼€é”€ä¸æ‰€ç®¡ç†åŒºåŸŸçš„å¤§å°æˆæ­£ç›¸å…³ã€‚
compacté˜¶æ®µçš„å¼€é”€ä¸å­˜æ´»å¯¹è±¡çš„æ•°æ®æˆæ­£æ¯”ã€‚



  ä»¥HotSpotä¸­çš„CMSå›æ”¶å™¨ä¸ºä¾‹ï¼ŒCMSæ˜¯åŸºäºMark-Sweepå®ç°çš„ï¼Œå¯¹äºå¯¹è±¡çš„å›æ”¶æ•ˆç‡å¾ˆé«˜ã€‚è€Œå¯¹äºç¢ç‰‡é—®é¢˜ï¼ŒCMSé‡‡ç”¨åŸºäºMark-Compactç®—æ³•çš„Serial oldå›æ”¶å™¨ä½œä¸ºè¡¥å¿æªæ–½ï¼šå½“å†…å­˜å›æ”¶ä¸ä½³ï¼ˆç¢ç‰‡å¯¼è‡´çš„Concurrent Mode Failureæ—¶ï¼‰ï¼Œå°†é‡‡ç”¨serial oldæ‰§è¡ŒFullGCä»¥è¾¾åˆ°å¯¹è€å¹´ä»£å†…å­˜çš„æ•´ç†ã€‚
  åˆ†ä»£çš„æ€æƒ³è¢«ç°æœ‰çš„è™šæ‹Ÿæœºå¹¿æ³›ä½¿ç”¨ã€‚å‡ ä¹æ‰€æœ‰çš„åƒåœ¾å›æ”¶å™¨éƒ½åŒºåˆ†æ–°ç”Ÿä»£å’Œè€å¹´ä»£



å¢é‡æ”¶é›†ç®—æ³•

æ¦‚è¿°

ä¸Šè¿°ç°æœ‰çš„ç®—æ³•ï¼Œåœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨è½¯ä»¶å°†å¤„äºä¸€ç§stop the Worldçš„çŠ¶æ€ã€‚åœ¨stop the WorldçŠ¶æ€ä¸‹ï¼Œåº”ç”¨ç¨‹åºæ‰€æœ‰çš„çº¿ç¨‹éƒ½ä¼šæŒ‚èµ·ï¼Œæš‚åœä¸€åˆ‡æ­£å¸¸çš„å·¥ä½œï¼Œç­‰å¾…åƒåœ¾å›æ”¶çš„å®Œæˆã€‚å¦‚æœåƒåœ¾å›æ”¶æ—¶é—´è¿‡é•¿ï¼Œåº”ç”¨ç¨‹åºä¼šè¢«æŒ‚èµ·å¾ˆä¹…ï¼Œå°†ä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒæˆ–è€…ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå³å¯¹å®æ—¶åƒåœ¾æ”¶é›†ç®—æ³•çš„ç ”ç©¶ç›´æ¥å¯¼è‡´äº†å¢é‡æ”¶é›†ï¼ˆIncremental Collectingï¼‰ç®—æ³•çš„è¯ç”Ÿã€‚


å¢é‡æ”¶é›†ç®—æ³•åŸºæœ¬æ€æƒ³

å¦‚æœä¸€æ¬¡æ€§å°†æ‰€æœ‰çš„åƒåœ¾è¿›è¡Œå¤„ç†ï¼Œéœ€è¦é€ æˆç³»ç»Ÿé•¿æ—¶é—´çš„åœé¡¿ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®©åƒåœ¾æ”¶é›†çº¿ç¨‹å’Œåº”ç”¨ç¨‹åºçº¿ç¨‹äº¤æ›¿æ‰§è¡Œã€‚æ¯æ¬¡ï¼Œåƒåœ¾æ”¶é›†çº¿ç¨‹åªæ”¶é›†ä¸€å°ç‰‡åŒºåŸŸçš„å†…å­˜ç©ºé—´ï¼Œæ¥ç€åˆ‡æ¢åˆ°åº”ç”¨ç¨‹åºçº¿ç¨‹ã€‚ä¾æ¬¡åå¤ï¼Œç›´åˆ°åƒåœ¾æ”¶é›†å®Œæˆã€‚
æ€»çš„æ¥è¯´ï¼Œå¢é‡æ”¶é›†ç®—æ³•çš„åŸºç¡€ä»æ˜¯ä¼ ç»Ÿçš„æ ‡è®°-æ¸…é™¤å’Œå¤åˆ¶ç®—æ³•ã€‚å¢é‡æ”¶é›†ç®—æ³•é€šè¿‡å¯¹çº¿ç¨‹é—´å†²çªçš„å¦¥å–„å¤„ç†ï¼Œå…è®¸åƒåœ¾æ”¶é›†çº¿ç¨‹ä»¥åˆ†é˜¶æ®µçš„æ–¹å¼å®Œæˆæ ‡è®°ã€æ¸…ç†æˆ–å¤åˆ¶å·¥ä½œ


å¢é‡æ”¶é›†ç®—æ³•çš„ç¼ºç‚¹

ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œç”±äºåœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œé—´æ–­æ€§åœ°è¿˜æ‰§è¡Œäº†åº”ç”¨ç¨‹åºä»£ç ï¼Œæ‰€ä»¥èƒ½å‡å°‘ç³»ç»Ÿçš„åœé¡¿æ—¶é—´ã€‚ä½†æ˜¯ï¼Œå› ä¸ºçº¿ç¨‹åˆ‡æ¢å’Œä¸Šä¸‹æ–‡è½¬æ¢çš„æ¶ˆè€—ï¼Œä¼šä½¿å¾—åƒåœ¾å›æ”¶çš„æ€»ä½“æˆæœ¬ä¸Šå‡ï¼Œé€ æˆç³»ç»Ÿååé‡çš„ä¸‹é™ã€‚


åˆ†åŒºç®—æ³•

æ¦‚è¿°

ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨ç›¸åŒæ¡ä»¶ä¸‹ï¼Œå †ç©ºé—´è¶Šå¤§ï¼Œä¸€æ¬¡Gcæ—¶æ‰€éœ€è¦çš„æ—¶é—´å°±è¶Šé•¿ï¼Œæœ‰å…³GCäº§ç”Ÿçš„åœé¡¿ä¹Ÿè¶Šé•¿ã€‚ä¸ºäº†æ›´å¥½åœ°æ§åˆ¶GCäº§ç”Ÿçš„åœé¡¿æ—¶é—´ï¼Œå°†ä¸€å—å¤§çš„å†…å­˜åŒºåŸŸåˆ†å‰²æˆå¤šä¸ªå°å—ï¼Œæ ¹æ®ç›®æ ‡çš„åœé¡¿æ—¶é—´ï¼Œæ¯æ¬¡åˆç†åœ°å›æ”¶è‹¥å¹²ä¸ªå°åŒºé—´ï¼Œè€Œä¸æ˜¯æ•´ä¸ªå †ç©ºé—´ï¼Œä»è€Œå‡å°‘ä¸€æ¬¡GCæ‰€äº§ç”Ÿçš„åœé¡¿ã€‚
åˆ†ä»£ç®—æ³•å°†æŒ‰ç…§å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸé•¿çŸ­åˆ’åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œåˆ†åŒºç®—æ³•å°†æ•´ä¸ªå †ç©ºé—´åˆ’åˆ†æˆè¿ç»­çš„ä¸åŒå°åŒºé—´ã€‚ æ¯ä¸€ä¸ªå°åŒºé—´éƒ½ç‹¬ç«‹ä½¿ç”¨ï¼Œç‹¬ç«‹å›æ”¶ã€‚è¿™ç§ç®—æ³•çš„å¥½å¤„æ˜¯å¯ä»¥æ§åˆ¶ä¸€æ¬¡å›æ”¶å¤šå°‘ä¸ªå°åŒºé—´ã€‚

  






]]></content>
      <categories>
        <category>JVMè™šæ‹Ÿæœºè¯¦è§£</category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>JVMè™šæ‹Ÿæœºè¯¦è§£</tag>
      </tags>
  </entry>
  <entry>
    <title>JVMè™šæ‹Ÿæœºè¯¦è§£(åå››)**åƒåœ¾å›æ”¶ç›¸å…³æ¦‚å¿µ</title>
    <url>/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3(%E5%8D%81%E5%9B%9B)%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5/</url>
    <content><![CDATA[JVMè™šæ‹Ÿæœºè¯¦è§£(åå››)åƒåœ¾å›æ”¶ç›¸å…³æ¦‚å¿µ1. System.gc()
ç†è§£

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œé€šè¿‡system.gcï¼ˆï¼‰è€…Runtime.getRuntime().gc() çš„è°ƒç”¨ï¼Œä¼šæ˜¾å¼è§¦å‘FullGCï¼ŒåŒæ—¶å¯¹è€å¹´ä»£å’Œæ–°ç”Ÿä»£è¿›è¡Œå›æ”¶ï¼Œå°è¯•é‡Šæ”¾è¢«ä¸¢å¼ƒå¯¹è±¡å ç”¨çš„å†…å­˜ã€‚ç„¶è€Œsystem.gc() )è°ƒç”¨é™„å¸¦ä¸€ä¸ªå…è´£å£°æ˜ï¼Œæ— æ³•ä¿è¯å¯¹åƒåœ¾æ”¶é›†å™¨çš„è°ƒç”¨ã€‚(ä¸èƒ½ç¡®ä¿ç«‹å³ç”Ÿæ•ˆ)

JVMå®ç°è€…å¯ä»¥é€šè¿‡system.gc() è°ƒç”¨æ¥å†³å®šJVMçš„GCè¡Œä¸ºã€‚è€Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåƒåœ¾å›æ”¶åº”è¯¥æ˜¯è‡ªåŠ¨è¿›è¡Œçš„ï¼Œæ— é¡»æ‰‹åŠ¨è§¦å‘ï¼Œå¦åˆ™å°±å¤ªè¿‡äºéº»çƒ¦äº†ã€‚åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå¦‚æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªæ€§èƒ½åŸºå‡†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿è¡Œä¹‹é—´è°ƒç”¨System.gc()ä»£ç æ¼”ç¤ºæ˜¯å¦å‡ºå‘GCæ“ä½œ

ä»£ç æ¼”ç¤ºæ˜¯å¦å‡ºå‘GCæ“ä½œ
  package com.peppa.gc;/** * System.gc() * * @author: peppa * @create: 2022-03-07 10:41:57 */public class SystemGC &#123;    public static void main(String[] args) &#123;        new SystemGC();        // æé†’JVMè¿›è¡Œåƒåœ¾å›æ”¶        System.gc();        // å¼ºåˆ¶è°ƒç”¨ å¤±å»å¼•ç”¨å¯¹è±¡çš„finalize()        //System.runFinalization();    &#125;    @Override    protected void finalize() throws Throwable &#123;        super.finalize();        System.out.println(&quot;...SystemGC.finalize()æ–¹æ³•è¢«æ‰§è¡Œ!!!&quot;);    &#125;&#125;

  è¾“å‡ºç»“æœä¸ç¡®å®šï¼šæœ‰æ—¶å€™ä¼šè°ƒç”¨ finalize() æ–¹æ³•ï¼Œæœ‰æ—¶å€™å¹¶ä¸ä¼šè°ƒç”¨
  ...SystemGC.finalize()æ–¹æ³•è¢«æ‰§è¡Œ!!!

æ‰‹åŠ¨GCæ¥ç†è§£ä¸å¯è¾¾å¯¹è±¡çš„å›æ”¶
  package com.peppa.gc;/** * åŠ ä¸Šå‚æ•°ï¼š  -XX:+PrintGCDetails -Xms256m -Xmx256m -XX:+PrintGCDetails -XX:PretenureSizeThreshold=15m * @author peppa * @create 2022-03-07 10:53:44 */public class LocalVariablesGC &#123;    /**     * è§¦å‘Minor GCæ²¡æœ‰å›æ”¶å¯¹è±¡ï¼Œç„¶ååœ¨è§¦å‘Full GCå°†è¯¥å¯¹è±¡å­˜å…¥oldåŒº     */    public void localvarGC1() &#123;        //10MB        byte[] buffer = new byte[10 * 1024 * 1024];        System.gc();    &#125;    /**     *  è§¦å‘YoungGCçš„æ—¶å€™ï¼Œå·²ç»è¢«å›æ”¶äº†     */    public void localvarGC2() &#123;        byte[] buffer = new byte[10 * 1024 * 1024];        buffer = null;        System.gc();    &#125;    /**     * ä¸ä¼šè¢«å›æ”¶ï¼Œå› ä¸ºå®ƒè¿˜å­˜æ”¾åœ¨å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„æ§½ä¸­     */    public void localvarGC3() &#123;        &#123;            byte[] buffer = new byte[10 * 1024 * 1024];        &#125;        System.gc();    &#125;    /**     * ä¼šè¢«å›æ”¶ï¼Œå› ä¸ºå®ƒè¿˜å­˜æ”¾åœ¨å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„æ§½ä¸­ï¼Œä½†æ˜¯åé¢å®šä¹‰çš„valueæŠŠè¿™ä¸ªæ§½ç»™æ›¿æ¢äº†     */    public void localvarGC4() &#123;        &#123;            byte[] buffer = new byte[10 * 1024 * 1024];        &#125;        int value = 10;        System.gc();    &#125;    /**     * localvarGC5ä¸­çš„æ•°ç»„å·²ç»è¢«å›æ”¶     */    public void localvarGC5() &#123;        localvarGC1();        System.gc();    &#125;    public static void main(String[] args) &#123;        LocalVariablesGC local = new LocalVariablesGC();        // é€šè¿‡åœ¨mainæ–¹æ³•è°ƒç”¨è¿™å‡ ä¸ªæ–¹æ³•è¿›è¡Œæµ‹è¯•        System.out.println(&quot;...LocalVariablesGC.localvarGC-1()&quot;);        local.localvarGC1();//        System.out.println(&quot;...LocalVariablesGC.localvarGC-2()&quot;);//        local.localvarGC2();////        System.out.println(&quot;...LocalVariablesGC.localvarGC-3()&quot;);//        local.localvarGC3();////        System.out.println(&quot;...LocalVariablesGC.localvarGC-4()&quot;);//        local.localvarGC4();////        System.out.println(&quot;...LocalVariablesGC.localvarGC-5()&quot;);//        local.localvarGC5();    &#125;&#125;

æ‰§è¡Œç»“æœï¼š

æ‰§è¡Œ System.gc() ä»…ä»…æ˜¯å°†å¹´è½»ä»£çš„ buffer æ•°ç»„å¯¹è±¡æ”¾åˆ°äº†è€å¹´ä»£ï¼Œbufferå¯¹è±¡ä»ç„¶æ²¡æœ‰å›æ”¶

  ...LocalVariablesGC.localvarGC-1()**[GC (System.gc()) [PSYoungGen: 15483K-&gt;10728K(76288K)] 15483K-&gt;10976K(251392K), 0.0052388 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] [Full GC (System.gc()) [PSYoungGen: 10728K-&gt;0K(76288K)] [ParOldGen: 248K-&gt;10868K(175104K)] 10976K-&gt;10868K(251392K), [Metaspace: 3228K-&gt;3228K(1056768K)], 0.0040694 secs] [Times: user=0.02 sys=0.00, real=0.00 secs]** Heap PSYoungGen      total 76288K, used 655K [0x00000000fab00000, 0x0000000100000000, 0x0000000100000000)  eden space 65536K, 1% used [0x00000000fab00000,0x00000000faba3ee8,0x00000000feb00000)  from space 10752K, 0% used [0x00000000feb00000,0x00000000feb00000,0x00000000ff580000)  to   space 10752K, 0% used [0x00000000ff580000,0x00000000ff580000,0x0000000100000000) ParOldGen       total 175104K, used 10868K [0x00000000f0000000, 0x00000000fab00000, 0x00000000fab00000)  object space 175104K, 6% used [0x00000000f0000000,0x00000000f0a9d270,0x00000000fab00000) Metaspace       used 3235K, capacity 4500K, committed 4864K, reserved 1056768K  class space    used 350K, capacity 388K, committed 512K, reserved 1048576K

ç”±äº buffer æ•°ç»„å¯¹è±¡æ²¡æœ‰å¼•ç”¨æŒ‡å‘å®ƒï¼Œæ‰§è¡Œ System.gc() å°†è¢«å›æ”¶

  ...LocalVariablesGC.localvarGC-2()**[GC (System.gc()) [PSYoungGen: 15483K-&gt;840K(76288K)] 15483K-&gt;848K(251392K), 0.0007219 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] [Full GC (System.gc()) [PSYoungGen: 840K-&gt;0K(76288K)] [ParOldGen: 8K-&gt;628K(175104K)] 848K-&gt;628K(251392K), [Metaspace: 3229K-&gt;3229K(1056768K)], 0.0034734 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]** Heap PSYoungGen      total 76288K, used 655K [0x00000000fab00000, 0x0000000100000000, 0x0000000100000000)  eden space 65536K, 1% used [0x00000000fab00000,0x00000000faba3ee8,0x00000000feb00000)  from space 10752K, 0% used [0x00000000feb00000,0x00000000feb00000,0x00000000ff580000)  to   space 10752K, 0% used [0x00000000ff580000,0x00000000ff580000,0x0000000100000000) ParOldGen       total 175104K, used 628K [0x00000000f0000000, 0x00000000fab00000, 0x00000000fab00000)  object space 175104K, 0% used [0x00000000f0000000,0x00000000f009d260,0x00000000fab00000) Metaspace       used 3235K, capacity 4500K, committed 4864K, reserved 1056768K  class space    used 350K, capacity 388K, committed 512K, reserved 1048576K

è™½ç„¶å‡ºäº†ä»£ç å—çš„ä½œç”¨åŸŸï¼Œä½†æ˜¯ buffer æ•°ç»„å¯¹è±¡å¹¶æ²¡æœ‰è¢«å›æ”¶

  ...LocalVariablesGC.localvarGC-3()**[GC (System.gc()) [PSYoungGen: 15483K-&gt;10736K(76288K)] 15483K-&gt;10976K(251392K), 0.0051980 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] [Full GC (System.gc()) [PSYoungGen: 10736K-&gt;0K(76288K)] [ParOldGen: 240K-&gt;10868K(175104K)] 10976K-&gt;10868K(251392K), [Metaspace: 3229K-&gt;3229K(1056768K)], 0.0039932 secs] [Times: user=0.05 sys=0.06, real=0.00 secs]** Heap PSYoungGen      total 76288K, used 655K [0x00000000fab00000, 0x0000000100000000, 0x0000000100000000)  eden space 65536K, 1% used [0x00000000fab00000,0x00000000faba3ee8,0x00000000feb00000)  from space 10752K, 0% used [0x00000000feb00000,0x00000000feb00000,0x00000000ff580000)  to   space 10752K, 0% used [0x00000000ff580000,0x00000000ff580000,0x0000000100000000) ParOldGen       total 175104K, used 10868K [0x00000000f0000000, 0x00000000fab00000, 0x00000000fab00000)  object space 175104K, 6% used [0x00000000f0000000,0x00000000f0a9d270,0x00000000fab00000) Metaspace       used 3235K, capacity 4500K, committed 4864K, reserved 1056768K  class space    used 350K, capacity 388K, committed 512K, reserved 1048576K

1ã€æ¥çœ‹çœ‹å­—èŠ‚ç ï¼šå®ä¾‹æ–¹æ³•å±€éƒ¨å˜é‡è¡¨ç¬¬ä¸€ä¸ªå˜é‡è‚¯å®šæ˜¯ this
  Qï¼šå°±å¤šå®šä¹‰äº†ä¸€ä¸ªå±€éƒ¨å˜é‡ value ï¼Œå°±å¯ä»¥æŠŠå­—èŠ‚æ•°ç»„å›æ”¶äº†å‘¢ï¼Ÿ
  Aï¼šå±€éƒ¨å˜é‡è¡¨é•¿åº¦ä¸º 2 ï¼Œè¿™è¯´æ˜äº†å‡ºäº†ä»£ç å—æ—¶ï¼Œbuffer å°±å‡ºäº†å…¶ä½œç”¨åŸŸèŒƒå›´ï¼Œæ­¤æ—¶æ²¡æœ‰ä¸º value å¼€å¯æ–°çš„æ§½ï¼Œvalue å˜é‡ç›´æ¥å æ®äº† buffer å˜é‡çš„æ§½ï¼ˆSlotï¼‰ï¼Œå¯¼è‡´å †ä¸­çš„å­—èŠ‚æ•°ç»„æ²¡æœ‰å¼•ç”¨å†æŒ‡å‘å®ƒï¼Œæ‰§è¡Œ System.gc() æ—¶è¢«å›æ”¶ã€‚çœ‹ï¼Œvalue ä½äºå±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º 1 çš„ä½ç½®ã€‚valueè¿™ä¸ªå±€éƒ¨å˜é‡æŠŠåŸæœ¬å±äºbufferçš„slotç»™å ç”¨äº†ï¼Œè¿™æ ·æ ˆä¸Šå°±æ²¡æœ‰bufferå˜é‡æŒ‡å‘new byte[10 * 1024 * 1024]å®ä¾‹äº†ã€‚

å±€éƒ¨å˜é‡é™¤äº†æ–¹æ³•èŒƒå›´å°±æ˜¯å¤±æ•ˆäº†ï¼Œå †ä¸­çš„å­—èŠ‚æ•°ç»„é“å®šè¢«å›æ”¶


  ...LocalVariablesGC.localvarGC-5()[GC (System.gc()) [PSYoungGen: 15483K-&gt;10728K(76288K)] 15483K-&gt;10944K(251392K), 0.0050946 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] [Full GC (System.gc()) [PSYoungGen: 10728K-&gt;0K(76288K)] [ParOldGen: 216K-&gt;10868K(175104K)] 10944K-&gt;10868K(251392K), [Metaspace: 3229K-&gt;3229K(1056768K)], 0.0043706 secs] [Times: user=0.13 sys=0.00, real=0.00 secs] [GC (System.gc()) [PSYoungGen: 0K-&gt;0K(76288K)] 10868K-&gt;10868K(251392K), 0.0002125 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] [Full GC (System.gc()) [PSYoungGen: 0K-&gt;0K(76288K)] [ParOldGen: 10868K-&gt;628K(175104K)] 10868K-&gt;628K(251392K), [Metaspace: 3229K-&gt;3229K(1056768K)], 0.0042302 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] Heap PSYoungGen      total 76288K, used 655K [0x00000000fab00000, 0x0000000100000000, 0x0000000100000000)  eden space 65536K, 1% used [0x00000000fab00000,0x00000000faba3ee8,0x00000000feb00000)  from space 10752K, 0% used [0x00000000ff580000,0x00000000ff580000,0x0000000100000000)  to   space 10752K, 0% used [0x00000000feb00000,0x00000000feb00000,0x00000000ff580000) ParOldGen       total 175104K, used 628K [0x00000000f0000000, 0x00000000fab00000, 0x00000000fab00000)  object space 175104K, 0% used [0x00000000f0000000,0x00000000f009d260,0x00000000fab00000) Metaspace       used 3235K, capacity 4500K, committed 4864K, reserved 1056768K  class space    used 350K, capacity 388K, committed 512K, reserved 1048576K
  ...LocalVariablesGC.localvarGC-4()[GC (System.gc()) [PSYoungGen: 15483K-&gt;840K(76288K)] 15483K-&gt;848K(251392K), 0.0007100 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] [Full GC (System.gc()) [PSYoungGen: 840K-&gt;0K(76288K)] [ParOldGen: 8K-&gt;628K(175104K)] 848K-&gt;628K(251392K), [Metaspace: 3229K-&gt;3229K(1056768K)], 0.0041518 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] Heap PSYoungGen      total 76288K, used 655K [0x00000000fab00000, 0x0000000100000000, 0x0000000100000000)  eden space 65536K, 1% used [0x00000000fab00000,0x00000000faba3ee8,0x00000000feb00000)  from space 10752K, 0% used [0x00000000feb00000,0x00000000feb00000,0x00000000ff580000)  to   space 10752K, 0% used [0x00000000ff580000,0x00000000ff580000,0x0000000100000000) ParOldGen       total 175104K, used 628K [0x00000000f0000000, 0x00000000fab00000, 0x00000000fab00000)  object space 175104K, 0% used [0x00000000f0000000,0x00000000f009d260,0x00000000fab00000) Metaspace       used 3235K, capacity 4500K, committed 4864K, reserved 1056768K  class space    used 350K, capacity 388K, committed 512K, reserved 1048576K



2.å†…å­˜æº¢å‡ºå’Œå†…å­˜æ³„æ¼
ä»€ä¹ˆæ˜¯å†…å­˜æº¢å‡ºï¼Ÿ

å†…å­˜æº¢å‡ºç›¸å¯¹äºå†…å­˜æ³„æ¼æ¥è¯´ï¼Œå°½ç®¡æ›´å®¹æ˜“è¢«ç†è§£ï¼Œä½†æ˜¯åŒæ ·çš„ï¼Œå†…å­˜æº¢å‡ºä¹Ÿæ˜¯å¼•å‘ç¨‹åºå´©æºƒçš„ç½ªé­ç¥¸é¦–ä¹‹ä¸€ã€‚
ç”±äºGCä¸€ç›´åœ¨å‘å±•ï¼Œæ‰€æœ‰ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé™¤éåº”ç”¨ç¨‹åºå ç”¨çš„å†…å­˜å¢é•¿é€Ÿåº¦éå¸¸å¿«ï¼Œé€ æˆåƒåœ¾å›æ”¶å·²ç»è·Ÿä¸ä¸Šå†…å­˜æ¶ˆè€—çš„é€Ÿåº¦ï¼Œå¦åˆ™ä¸å¤ªå®¹æ˜“å‡ºç°OOMçš„æƒ…å†µã€‚
å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒGCä¼šè¿›è¡Œå„ç§å¹´é¾„æ®µçš„åƒåœ¾å›æ”¶ï¼Œå®åœ¨ä¸è¡Œäº†å°±æ”¾å¤§æ‹›ï¼Œæ¥ä¸€æ¬¡ç‹¬å å¼çš„Full GCæ“ä½œï¼Œè¿™æ—¶å€™ä¼šå›æ”¶å¤§é‡çš„å†…å­˜ï¼Œä¾›åº”ç”¨ç¨‹åºç»§ç»­ä½¿ç”¨ã€‚
Javadocä¸­å¯¹OutofMemoryErrorçš„è§£é‡Šæ˜¯ï¼Œæ²¡æœ‰ç©ºé—²å†…å­˜ï¼Œå¹¶ä¸”åƒåœ¾æ”¶é›†å™¨ä¹Ÿæ— æ³•æä¾›æ›´å¤šå†…å­˜ã€‚


å†…å­˜æº¢å‡ºï¼ˆOOMï¼‰åŸå› åˆ†æ

é¦–å…ˆè¯´æ²¡æœ‰ç©ºé—²å†…å­˜çš„æƒ…å†µï¼šè¯´æ˜Javaè™šæ‹Ÿæœºçš„å †å†…å­˜ä¸å¤Ÿã€‚åŸå› æœ‰äºŒï¼š

Javaè™šæ‹Ÿæœºçš„å †å†…å­˜è®¾ç½®ä¸å¤Ÿã€‚
æ¯”å¦‚ï¼šå¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼é—®é¢˜ï¼›ä¹Ÿå¾ˆæœ‰å¯èƒ½å°±æ˜¯å †çš„å¤§å°ä¸åˆç†ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦å¤„ç†æ¯”è¾ƒå¯è§‚çš„æ•°æ®é‡ï¼Œä½†æ˜¯æ²¡æœ‰æ˜¾å¼æŒ‡å®šJVMå †å¤§å°æˆ–è€…æŒ‡å®šæ•°å€¼åå°ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å‚æ•°-Xms ã€-Xmxæ¥è°ƒæ•´ã€‚


ä»£ç ä¸­åˆ›å»ºäº†å¤§é‡å¤§å¯¹è±¡ï¼Œå¹¶ä¸”é•¿æ—¶é—´ä¸èƒ½è¢«åƒåœ¾æ”¶é›†å™¨æ”¶é›†ï¼ˆå­˜åœ¨è¢«å¼•ç”¨ï¼‰
å¯¹äºè€ç‰ˆæœ¬çš„Oracle JDKï¼Œå› ä¸ºæ°¸ä¹…ä»£çš„å¤§å°æ˜¯æœ‰é™çš„ï¼Œå¹¶ä¸”JVMå¯¹æ°¸ä¹…ä»£åƒåœ¾å›æ”¶ï¼ˆå¦‚ï¼Œå¸¸é‡æ± å›æ”¶ã€å¸è½½ä¸å†éœ€è¦çš„ç±»å‹ï¼‰éå¸¸ä¸ç§¯æï¼Œæ‰€ä»¥å½“æˆ‘ä»¬ä¸æ–­æ·»åŠ æ–°ç±»å‹çš„æ—¶å€™ï¼Œæ°¸ä¹…ä»£å‡ºç°OutOfMemoryErrorä¹Ÿéå¸¸å¤šè§ã€‚å°¤å…¶æ˜¯åœ¨è¿è¡Œæ—¶å­˜åœ¨å¤§é‡åŠ¨æ€ç±»å‹ç”Ÿæˆçš„åœºåˆï¼›ç±»ä¼¼internå­—ç¬¦ä¸²ç¼“å­˜å ç”¨å¤ªå¤šç©ºé—´ï¼Œä¹Ÿä¼šå¯¼è‡´OOMé—®é¢˜ã€‚å¯¹åº”çš„å¼‚å¸¸ä¿¡æ¯ï¼Œä¼šæ ‡è®°å‡ºæ¥å’Œæ°¸ä¹…ä»£ç›¸å…³ï¼šâ€œjava.lang.OutOfMemoryError:PermGen spaceâ€œã€‚
éšç€å…ƒæ•°æ®åŒºçš„å¼•å…¥ï¼Œæ–¹æ³•åŒºå†…å­˜å·²ç»ä¸å†é‚£ä¹ˆçª˜è¿«ï¼Œæ‰€ä»¥ç›¸åº”çš„OOMæœ‰æ‰€æ”¹è§‚ï¼Œå‡ºç°OOMï¼Œå¼‚å¸¸ä¿¡æ¯åˆ™å˜æˆäº†ï¼šâ€œjava.lang.OutofMemoryError:Metaspaceâ€œã€‚ç›´æ¥å†…å­˜ä¸è¶³ï¼Œä¹Ÿä¼šå¯¼è‡´OOMã€‚




æŠ›å‡ºOutofMemoryErrorä¹‹å‰ï¼Œé€šå¸¸åƒåœ¾æ”¶é›†å™¨ä¼šè¢«è§¦å‘ï¼Œå°½å…¶æ‰€èƒ½å»æ¸…ç†å‡ºç©ºé—´ã€‚

ä¾‹å¦‚ï¼šåœ¨å¼•ç”¨æœºåˆ¶åˆ†æä¸­ï¼Œæ¶‰åŠåˆ°JVMä¼šå»å°è¯•å›æ”¶è½¯å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡ç­‰ã€‚
åœ¨**java.nio.Bits.reserveMemory()**æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬èƒ½æ¸…æ¥šçš„çœ‹åˆ°ï¼ŒSystem.gc()ä¼šè¢«è°ƒç”¨ï¼Œä»¥æ¸…ç†ç©ºé—´ã€‚


å½“ç„¶ï¼Œä¹Ÿä¸æ˜¯åœ¨ä»»ä½•æƒ…å†µä¸‹åƒåœ¾æ”¶é›†å™¨éƒ½ä¼šè¢«è§¦å‘çš„

æ¯”å¦‚ï¼Œæˆ‘ä»¬å»åˆ†é…ä¸€ä¸ªè¶…å¤§å¯¹è±¡ï¼Œç±»ä¼¼ä¸€ä¸ªè¶…å¤§æ•°ç»„è¶…è¿‡å †çš„æœ€å¤§å€¼ï¼ŒJVMå¯ä»¥åˆ¤æ–­å‡ºåƒåœ¾æ”¶é›†å¹¶ä¸èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥ç›´æ¥æŠ›å‡ºOutofMemoryErrorã€‚




ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼ï¼Ÿ

ä¹Ÿç§°ä½œâ€œå­˜å‚¨æ¸—æ¼â€ã€‚ä¸¥æ ¼æ¥è¯´ï¼Œåªæœ‰å¯¹è±¡ä¸ä¼šå†è¢«ç¨‹åºç”¨åˆ°äº†ï¼Œä½†æ˜¯GCåˆä¸èƒ½å›æ”¶ä»–ä»¬çš„æƒ…å†µï¼Œæ‰å«å†…å­˜æ³„æ¼ã€‚
ä½†å®é™…æƒ…å†µå¾ˆå¤šæ—¶å€™ä¸€äº›ä¸å¤ªå¥½çš„å®è·µï¼ˆæˆ–ç–å¿½ï¼‰ä¼šå¯¼è‡´å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå˜å¾—å¾ˆé•¿ç”šè‡³å¯¼è‡´OOMï¼Œä¹Ÿå¯ä»¥å«åšå®½æ³›æ„ä¹‰ä¸Šçš„â€œå†…å­˜æ³„æ¼â€ã€‚
å°½ç®¡å†…å­˜æ³„æ¼å¹¶ä¸ä¼šç«‹åˆ»å¼•èµ·ç¨‹åºå´©æºƒï¼Œä½†æ˜¯ä¸€æ—¦å‘ç”Ÿå†…å­˜æ³„æ¼ï¼Œç¨‹åºä¸­çš„å¯ç”¨å†…å­˜å°±ä¼šè¢«é€æ­¥èš•é£Ÿï¼Œç›´è‡³è€—å°½æ‰€æœ‰å†…å­˜ï¼Œæœ€ç»ˆå‡ºç°OutofMemoryå¼‚å¸¸ï¼Œå¯¼è‡´ç¨‹åºå´©æºƒã€‚
æ³¨æ„ï¼Œè¿™é‡Œçš„å­˜å‚¨ç©ºé—´å¹¶ä¸æ˜¯æŒ‡ç‰©ç†å†…å­˜ï¼Œè€Œæ˜¯æŒ‡è™šæ‹Ÿå†…å­˜å¤§å°ï¼Œè¿™ä¸ªè™šæ‹Ÿå†…å­˜å¤§å°å–å†³äºç£ç›˜äº¤æ¢åŒºè®¾å®šçš„å¤§å°ã€‚

  
  Javaä½¿ç”¨å¯è¾¾æ€§åˆ†æç®—æ³•ï¼Œæœ€ä¸Šé¢çš„æ•°æ®ä¸å¯è¾¾ï¼Œå°±æ˜¯éœ€è¦è¢«å›æ”¶çš„ã€‚åæœŸæœ‰ä¸€äº›å¯¹è±¡ä¸ç”¨äº†ï¼ŒæŒ‰é“ç†åº”è¯¥æ–­å¼€å¼•ç”¨ï¼Œä½†æ˜¯å­˜åœ¨ä¸€äº›é“¾æ²¡æœ‰æ–­å¼€ï¼Œä»è€Œå¯¼è‡´æ²¡æœ‰åŠæ³•è¢«å›æ”¶ã€‚

ä¸¾ä¾‹

å•ä¾‹æ¨¡å¼

  å•ä¾‹çš„ç”Ÿå‘½å‘¨æœŸå’Œåº”ç”¨ç¨‹åºæ˜¯ä¸€æ ·é•¿çš„ï¼Œæ‰€ä»¥å•ä¾‹ç¨‹åºä¸­ï¼Œå¦‚æœæŒæœ‰å¯¹å¤–éƒ¨å¯¹è±¡çš„å¼•ç”¨çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå¤–éƒ¨å¯¹è±¡æ˜¯ä¸èƒ½è¢«å›æ”¶çš„ï¼Œåˆ™ä¼šå¯¼è‡´å†…å­˜æ³„æ¼çš„äº§ç”Ÿã€‚

ä¸€äº›æä¾›closeçš„èµ„æºæœªå…³é—­å¯¼è‡´å†…å­˜æ³„æ¼

  æ•°æ®åº“è¿æ¥ï¼ˆdataSourse.getConnection() ï¼‰ï¼Œç½‘ç»œè¿æ¥ï¼ˆsocketï¼‰å’Œioè¿æ¥å¿…é¡»æ‰‹åŠ¨closeï¼Œå¦åˆ™æ˜¯ä¸èƒ½è¢«å›æ”¶çš„ã€‚




3.Stop The World]]></content>
      <categories>
        <category>JVMè™šæ‹Ÿæœºè¯¦è§£</category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>JVMè™šæ‹Ÿæœºè¯¦è§£</tag>
      </tags>
  </entry>
  <entry>
    <title>JVMè™šæ‹Ÿæœºè¯¦è§£(åäºŒ)StringTable(å­—ç¬¦ä¸²å¸¸é‡æ± )</title>
    <url>/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3(%E5%8D%81%E4%BA%8C)StringTable(%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%B8%B8%E9%87%8F%E6%B1%A0)/</url>
    <content><![CDATA[JVMè™šæ‹Ÿæœºè¯¦è§£(åäºŒ)StringTable(å­—ç¬¦ä¸²å¸¸é‡æ± )1. StringTable(å­—ç¬¦ä¸²å¸¸é‡æ± )
Stringçš„åŸºæœ¬ç‰¹æ€§

Stringï¼šå­—ç¬¦ä¸²ï¼Œä½¿ç”¨ä¸€å¯¹ â€â€ å¼•èµ·æ¥è¡¨ç¤º

  String s1 = &quot;peppa&quot; ;   			// å­—é¢é‡çš„å®šä¹‰æ–¹å¼String s2 =  new String(&quot;hello world&quot;);     // new å¯¹è±¡çš„æ–¹å¼

stringå£°æ˜ä¸ºfinalçš„ï¼Œä¸å¯è¢«ç»§æ‰¿
Stringå®ç°äº†Serializableæ¥å£ï¼šè¡¨ç¤ºå­—ç¬¦ä¸²æ˜¯æ”¯æŒåºåˆ—åŒ–çš„ã€‚å®ç°äº†Comparableæ¥å£ï¼šè¡¨ç¤ºstringå¯ä»¥æ¯”è¾ƒå¤§å°
Stringåœ¨jdk8åŠä»¥å‰å†…éƒ¨å®šä¹‰äº†final char[] valueç”¨äºå­˜å‚¨å­—ç¬¦ä¸²æ•°æ®ã€‚JDK9æ—¶æ”¹ä¸ºbyte[]


ä¸ºä»€ä¹ˆJDK9æ”¹å˜äº†ç»“æ„
  Stringç±»çš„å½“å‰å®ç°å°†å­—ç¬¦å­˜å‚¨åœ¨charæ•°ç»„ä¸­ï¼Œæ¯ä¸ªå­—ç¬¦ä½¿ç”¨ä¸¤ä¸ªå­—èŠ‚(16ä½)ã€‚ä»è®¸å¤šä¸åŒçš„åº”ç”¨ç¨‹åºæ”¶é›†çš„æ•°æ®è¡¨æ˜ï¼Œå­—ç¬¦ä¸²æ˜¯å †ä½¿ç”¨çš„ä¸»è¦ç»„æˆéƒ¨åˆ†ï¼Œè€Œä¸”ï¼Œå¤§å¤šæ•°å­—ç¬¦ä¸²å¯¹è±¡åªåŒ…å«æ‹‰ä¸å­—ç¬¦ã€‚è¿™äº›å­—ç¬¦åªéœ€è¦ä¸€ä¸ªå­—èŠ‚çš„å­˜å‚¨ç©ºé—´ï¼Œå› æ­¤è¿™äº›å­—ç¬¦ä¸²å¯¹è±¡çš„å†…éƒ¨charæ•°ç»„ä¸­æœ‰ä¸€åŠçš„ç©ºé—´å°†ä¸ä¼šä½¿ç”¨ã€‚
  æˆ‘ä»¬å»ºè®®æ”¹å˜å­—ç¬¦ä¸²çš„å†…éƒ¨è¡¨ç¤ºclasÅ¡ä»utf - 16å­—ç¬¦æ•°ç»„åˆ°å­—èŠ‚æ•°ç»„+ä¸€ä¸ªencoding-flagå­—æ®µã€‚æ–°çš„Stringç±»å°†æ ¹æ®å­—ç¬¦ä¸²çš„å†…å®¹å­˜å‚¨ç¼–ç ä¸ºISO-8859-1&#x2F;Latin-1(æ¯ä¸ªå­—ç¬¦ä¸€ä¸ªå­—èŠ‚)æˆ–UTF-16(æ¯ä¸ªå­—ç¬¦ä¸¤ä¸ªå­—èŠ‚)çš„å­—ç¬¦ã€‚ç¼–ç æ ‡å¿—å°†æŒ‡ç¤ºä½¿ç”¨å“ªç§ç¼–ç ã€‚
  ç»“è®ºï¼šStringå†ä¹Ÿä¸ç”¨char[] æ¥å­˜å‚¨äº†ï¼Œæ”¹æˆäº†byte [] åŠ ä¸Šç¼–ç æ ‡è®°ï¼ŒèŠ‚çº¦äº†ä¸€äº›ç©ºé—´
  // ä¹‹å‰private final char value[];// ä¹‹åprivate final byte[] value
  åŒæ—¶åŸºäºStringçš„æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚StringBufferå’ŒStringBuilderä¹ŸåŒæ ·åšäº†ä¿®æ”¹

Stringçš„ä¸å¯å˜æ€§

Stringï¼šä»£è¡¨ä¸å¯å˜çš„å­—ç¬¦åºåˆ—ã€‚ç®€ç§°ï¼šä¸å¯å˜æ€§ã€‚
å½“å¯¹å­—ç¬¦ä¸²é‡æ–°èµ‹å€¼æ—¶ï¼Œéœ€è¦é‡å†™æŒ‡å®šå†…å­˜åŒºåŸŸèµ‹å€¼ï¼Œä¸èƒ½ä½¿ç”¨åŸæœ‰çš„valueè¿›è¡Œèµ‹å€¼ã€‚
å½“å¯¹ç°æœ‰çš„å­—ç¬¦ä¸²è¿›è¡Œè¿æ¥æ“ä½œæ—¶ï¼Œä¹Ÿéœ€è¦é‡æ–°æŒ‡å®šå†…å­˜åŒºåŸŸèµ‹å€¼ï¼Œä¸èƒ½ä½¿ç”¨åŸæœ‰çš„valueè¿›è¡Œèµ‹å€¼ã€‚
å½“è°ƒç”¨Stringçš„replace()æ–¹æ³•ä¿®æ”¹æŒ‡å®šå­—ç¬¦æˆ–å­—ç¬¦ä¸²æ—¶ï¼Œä¹Ÿéœ€è¦é‡æ–°æŒ‡å®šå†…å­˜åŒºåŸŸèµ‹å€¼ï¼Œä¸èƒ½ä½¿ç”¨åŸæœ‰çš„valueè¿›è¡Œèµ‹å€¼ã€‚


é€šè¿‡å­—é¢é‡çš„æ–¹å¼ï¼ˆåŒºåˆ«äºnewï¼‰ç»™ä¸€ä¸ªå­—ç¬¦ä¸²èµ‹å€¼ï¼Œæ­¤æ—¶çš„å­—ç¬¦ä¸²å€¼å£°æ˜åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ã€‚


å½“å¯¹å­—ç¬¦ä¸²é‡æ–°èµ‹å€¼æ—¶ï¼Œéœ€è¦é‡å†™æŒ‡å®šå†…å­˜åŒºåŸŸèµ‹å€¼ï¼Œä¸èƒ½ä½¿ç”¨åŸæœ‰çš„valueè¿›è¡Œèµ‹å€¼
  @Testpublic void test1() &#123;    String s1 = &quot;abc&quot;;//å­—é¢é‡å®šä¹‰çš„æ–¹å¼ï¼Œ&quot;abc&quot;å­˜å‚¨åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­    String s2 = &quot;abc&quot;;    s1 = &quot;hello&quot;;    System.out.println(s1 == s2);//åˆ¤æ–­åœ°å€ï¼štrue  --&gt; false    System.out.println(s1);//    System.out.println(s2);//abc&#125;
  å­—èŠ‚ç æŒ‡ä»¤

å–å­—ç¬¦ä¸² â€œabcâ€ æ—¶ï¼Œä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªç¬¦å·å¼•ç”¨ï¼š#2
å–å­—ç¬¦ä¸² â€œhelloâ€ æ—¶ï¼Œä½¿ç”¨çš„æ˜¯å¦ä¸€ä¸ªç¬¦å·å¼•ç”¨ï¼š#3


å½“å¯¹ç°æœ‰çš„å­—ç¬¦ä¸²è¿›è¡Œè¿æ¥æ“ä½œæ—¶ï¼Œä¹Ÿéœ€è¦é‡æ–°æŒ‡å®šå†…å­˜åŒºåŸŸèµ‹å€¼ï¼Œä¸èƒ½ä½¿ç”¨åŸæœ‰çš„valueè¿›è¡Œèµ‹å€¼
  @Testpublic void test2() &#123;    String s1 = &quot;abc&quot;;    String s2 = &quot;abc&quot;;    s2 += &quot;def&quot;;    System.out.println(s2);//abcdef    System.out.println(s1);//abc&#125;

å½“è°ƒç”¨stringçš„replace()æ–¹æ³•ä¿®æ”¹æŒ‡å®šå­—ç¬¦æˆ–å­—ç¬¦ä¸²æ—¶ï¼Œä¹Ÿéœ€è¦é‡æ–°æŒ‡å®šå†…å­˜åŒºåŸŸèµ‹å€¼ï¼Œä¸èƒ½ä½¿ç”¨åŸæœ‰çš„valueè¿›è¡Œèµ‹å€¼
  @Testpublic void test3() &#123;    String s1 = &quot;abc&quot;;    String s2 = s1.replace(&#x27;a&#x27;, &#x27;m&#x27;);    System.out.println(s1);//abc    System.out.println(s2);//mbc&#125;

ä¸€é“ç¬”è¯•é¢˜
  public class StringExer &#123;    String str = new String(&quot;good&quot;);    char[] ch = &#123;&#x27;t&#x27;, &#x27;e&#x27;, &#x27;s&#x27;, &#x27;t&#x27;&#125;;    public void change(String str, char ch[]) &#123;        str = &quot;test ok&quot;;        ch[0] = &#x27;b&#x27;;    &#125;    public static void main(String[] args) &#123;        StringExer ex = new StringExer();        ex.change(ex.str, ex.ch);        System.out.println(ex.str);//good        System.out.println(ex.ch);//best    &#125;&#125;
  str çš„å†…å®¹å¹¶æ²¡æœ‰å˜ï¼šâ€œtest okâ€ ä½äºå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„å¦ä¸€ä¸ªåŒºåŸŸï¼ˆåœ°å€ï¼‰ï¼Œè¿›è¡Œèµ‹å€¼æ“ä½œå¹¶æ²¡æœ‰ä¿®æ”¹åŸæ¥ str æŒ‡å‘çš„å¼•ç”¨çš„å†…å®¹****


2.String çš„åº•å±‚ç»“æ„
å­—ç¬¦ä¸²å¸¸é‡æ± æ˜¯ä¸ä¼šå­˜å‚¨ç›¸åŒå†…å®¹çš„å­—ç¬¦ä¸²çš„

Stringçš„String Poolï¼ˆå­—ç¬¦ä¸²å¸¸é‡æ± ï¼‰æ˜¯ä¸€ä¸ªå›ºå®šå¤§å°çš„Hashtableï¼Œé»˜è®¤å€¼å¤§å°é•¿åº¦æ˜¯1009ã€‚å¦‚æœæ”¾è¿›String Poolçš„Stringéå¸¸å¤šï¼Œå°±ä¼šé€ æˆHashå†²çªä¸¥é‡ï¼Œä»è€Œå¯¼è‡´é“¾è¡¨ä¼šå¾ˆé•¿ï¼Œè€Œé“¾è¡¨é•¿äº†åç›´æ¥ä¼šé€ æˆçš„å½±å“å°±æ˜¯å½“è°ƒç”¨String.intern()æ–¹æ³•æ—¶æ€§èƒ½ä¼šå¤§å¹…ä¸‹é™ã€‚
ä½¿ç”¨-XX:StringTablesizeå¯è®¾ç½®StringTableçš„é•¿åº¦
åœ¨JDK6ä¸­StringTableæ˜¯å›ºå®šçš„ï¼Œå°±æ˜¯1009çš„é•¿åº¦ï¼Œæ‰€ä»¥å¦‚æœå¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²è¿‡å¤šå°±ä¼šå¯¼è‡´æ•ˆç‡ä¸‹é™å¾ˆå¿«ï¼ŒStringTablesizeè®¾ç½®æ²¡æœ‰è¦æ±‚
åœ¨JDK7ä¸­ï¼ŒStringTableçš„é•¿åº¦é»˜è®¤å€¼æ˜¯60013ï¼ŒStringTablesizeè®¾ç½®æ²¡æœ‰è¦æ±‚
åœ¨JDK8ä¸­ï¼ŒStringTableçš„é•¿åº¦é»˜è®¤å€¼æ˜¯60013ï¼ŒStringTableå¯ä»¥è®¾ç½®çš„æœ€å°å€¼ä¸º1009


String çš„å†…å­˜åˆ†é…

åœ¨Javaè¯­è¨€ä¸­æœ‰8ç§åŸºæœ¬æ•°æ®ç±»å‹å’Œä¸€ç§æ¯”è¾ƒç‰¹æ®Šçš„ç±»å‹Stringã€‚è¿™äº›ç±»å‹ä¸ºäº†ä½¿å®ƒä»¬åœ¨è¿è¡Œè¿‡ç¨‹ä¸­é€Ÿåº¦æ›´å¿«ã€æ›´èŠ‚çœå†…å­˜ï¼Œéƒ½æä¾›äº†ä¸€ç§å¸¸é‡æ± çš„æ¦‚å¿µã€‚
å¸¸é‡æ± å°±ç±»ä¼¼ä¸€ä¸ªJavaç³»ç»Ÿçº§åˆ«æä¾›çš„ç¼“å­˜ã€‚8ç§åŸºæœ¬æ•°æ®ç±»å‹çš„å¸¸é‡æ± éƒ½æ˜¯ç³»ç»Ÿåè°ƒçš„ï¼ŒStringç±»å‹çš„å¸¸é‡æ± æ¯”è¾ƒç‰¹æ®Šã€‚å®ƒçš„ä¸»è¦ä½¿ç”¨æ–¹æ³•æœ‰ä¸¤ç§ã€‚
ç›´æ¥ä½¿ç”¨åŒå¼•å·å£°æ˜å‡ºæ¥çš„Stringå¯¹è±¡ä¼šç›´æ¥å­˜å‚¨åœ¨å¸¸é‡æ± ä¸­ã€‚æ¯”å¦‚ï¼šString info=&quot;atguigu.com&quot;;
å¦‚æœä¸æ˜¯ç”¨åŒå¼•å·å£°æ˜çš„Stringå¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨Stringæä¾›çš„intern()æ–¹æ³•ã€‚è¿™ä¸ªåé¢é‡ç‚¹è°ˆ


Java 6åŠä»¥å‰ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± å­˜æ”¾åœ¨æ°¸ä¹…ä»£
Java 7ä¸­ Oracleçš„å·¥ç¨‹å¸ˆå¯¹å­—ç¬¦ä¸²æ± çš„é€»è¾‘åšäº†å¾ˆå¤§çš„æ”¹å˜ï¼Œå³å°†å­—ç¬¦ä¸²å¸¸é‡æ± çš„ä½ç½®è°ƒæ•´åˆ°Javaå †å†…
æ‰€æœ‰çš„å­—ç¬¦ä¸²éƒ½ä¿å­˜åœ¨å †ï¼ˆHeapï¼‰ä¸­ï¼Œå’Œå…¶ä»–æ™®é€šå¯¹è±¡ä¸€æ ·ï¼Œè¿™æ ·å¯ä»¥è®©ä½ åœ¨è¿›è¡Œè°ƒä¼˜åº”ç”¨æ—¶ä»…éœ€è¦è°ƒæ•´å †å¤§å°å°±å¯ä»¥äº†ã€‚
å­—ç¬¦ä¸²å¸¸é‡æ± æ¦‚å¿µåŸæœ¬ä½¿ç”¨å¾—æ¯”è¾ƒå¤šï¼Œä½†æ˜¯è¿™ä¸ªæ”¹åŠ¨ä½¿å¾—æˆ‘ä»¬æœ‰è¶³å¤Ÿçš„ç†ç”±è®©æˆ‘ä»¬é‡æ–°è€ƒè™‘åœ¨Java 7ä¸­ä½¿ç”¨String.intern()ã€‚


Java8å…ƒç©ºé—´ï¼Œå­—ç¬¦ä¸²å¸¸é‡åœ¨å †

  
  
  

StringTable ä¸ºä»€ä¹ˆè¦è°ƒæ•´ï¼Ÿ

ä¸ºä»€ä¹ˆè¦è°ƒæ•´ä½ç½®ï¼Ÿ
æ°¸ä¹…ä»£çš„é»˜è®¤ç©ºé—´å¤§å°æ¯”è¾ƒå°
æ°¸ä¹…ä»£åƒåœ¾å›æ”¶é¢‘ç‡ä½ï¼Œå¤§é‡çš„å­—ç¬¦ä¸²æ— æ³•åŠæ—¶å›æ”¶ï¼Œå®¹æ˜“è¿›è¡ŒFull GCäº§ç”ŸSTWæˆ–è€…å®¹æ˜“äº§ç”ŸOOMï¼šPermGen Space
å †ä¸­ç©ºé—´è¶³å¤Ÿå¤§ï¼Œå­—ç¬¦ä¸²å¯è¢«åŠæ—¶å›æ”¶


åœ¨JDK 7ä¸­ï¼Œinternedå­—ç¬¦ä¸²ä¸å†åœ¨Javaå †çš„æ°¸ä¹…ä»£ä¸­åˆ†é…ï¼Œè€Œæ˜¯åœ¨Javaå †çš„ä¸»è¦éƒ¨åˆ†ï¼ˆç§°ä¸ºå¹´è½»ä»£å’Œå¹´è€ä»£ï¼‰ä¸­åˆ†é…ï¼Œä¸åº”ç”¨ç¨‹åºåˆ›å»ºçš„å…¶ä»–å¯¹è±¡ä¸€èµ·åˆ†é…ã€‚
æ­¤æ›´æ”¹å°†å¯¼è‡´é©»ç•™åœ¨ä¸»Javaå †ä¸­çš„æ•°æ®æ›´å¤šï¼Œé©»ç•™åœ¨æ°¸ä¹…ç”Ÿæˆä¸­çš„æ•°æ®æ›´å°‘ï¼Œå› æ­¤å¯èƒ½éœ€è¦è°ƒæ•´å †å¤§å°ã€‚

  å®˜æ–¹æ–‡æ¡£:https://www.oracle.com/java/technologies/javase/jdk7-relnotes.html#jdk7changes
  ä»£ç ç¤ºä¾‹ï¼š
  package com.peppa.strings;import java.util.HashSet;import java.util.Set;/** * jdk6ä¸­ï¼š * -XX:PermSize=10m -XX:MaxPermSize=10m -Xms10m -Xmx10m * * jdk8ä¸­ï¼š * -XX:MetaspaceSize=6m -XX:MaxMetaspaceSize=10m -Xms10m -Xmx10m */public class StringTest3 &#123;    public static void main(String[] args) &#123;        //ä½¿ç”¨Setä¿æŒç€å¸¸é‡æ± å¼•ç”¨ï¼Œé¿å…full gcå›æ”¶å¸¸é‡æ± è¡Œä¸º        Set&lt;String&gt; set = new HashSet&lt;String&gt;();        //åœ¨shortå¯ä»¥å–å€¼çš„èŒƒå›´å†…è¶³ä»¥è®©10MBçš„PermSizeæˆ–heapäº§ç”ŸOOMäº†ã€‚        short i = 0;        while(true)&#123;            set.add(String.valueOf(i++).intern());        &#125;    &#125;&#125;
  è¾“å‡ºç»“æœï¼šå­—ç¬¦ä¸²çœŸçš„åœ¨å †ä¸­ï¼ˆJDK8ï¼‰
  Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Java heap space	at java.util.HashMap.resize(HashMap.java:704)	at java.util.HashMap.putVal(HashMap.java:663)	at java.util.HashMap.put(HashMap.java:612)	at java.util.HashSet.add(HashSet.java:220)	at com.peppa.strings.StringTest3.main(StringTest3.java:20)Process finished with exit code 1

String çš„åŸºæœ¬æ“ä½œ
  Javaè¯­è¨€è§„èŒƒé‡Œè¦æ±‚å®Œå…¨ç›¸åŒçš„å­—ç¬¦ä¸²å­—é¢é‡ï¼Œåº”è¯¥åŒ…å«åŒæ ·çš„Unicodeå­—ç¬¦åºåˆ—ï¼ˆåŒ…å«åŒä¸€ä»½ç ç‚¹åºåˆ—çš„å¸¸é‡ï¼‰ï¼Œå¹¶ä¸”å¿…é¡»æ˜¯æŒ‡å‘åŒä¸€ä¸ªStringç±»å®ä¾‹ã€‚
  package com.peppa.strings;public class StringTest4 &#123;    public static void main(String[] args) &#123;        System.out.println();//2051        System.out.println(&quot;1&quot;);//2052        System.out.println(&quot;2&quot;);        System.out.println(&quot;3&quot;);        System.out.println(&quot;4&quot;);        System.out.println(&quot;5&quot;);        System.out.println(&quot;6&quot;);        System.out.println(&quot;7&quot;);        System.out.println(&quot;8&quot;);        System.out.println(&quot;9&quot;);        System.out.println(&quot;10&quot;);//2303        //å¦‚ä¸‹çš„å­—ç¬¦ä¸²&quot;1&quot; åˆ° &quot;10&quot;ä¸ä¼šå†æ¬¡åŠ è½½        System.out.println(&quot;1&quot;);//2304        System.out.println(&quot;2&quot;);//2304        System.out.println(&quot;3&quot;);        System.out.println(&quot;4&quot;);        System.out.println(&quot;5&quot;);        System.out.println(&quot;6&quot;);        System.out.println(&quot;7&quot;);        System.out.println(&quot;8&quot;);        System.out.println(&quot;9&quot;);        System.out.println(&quot;10&quot;);//2304    &#125;&#125;

åˆ†æå­—ç¬¦ä¸²å¸¸é‡æ± çš„å˜åŒ–-æ¡ˆä¾‹1ï¼š
  1ã€ç¨‹åºå¯åŠ¨æ—¶å·²ç»åŠ è½½äº† *2051*ä¸ªå­—ç¬¦ä¸²å¸¸é‡
  
  2ã€åŠ è½½äº†ä¸€ä¸ªæ¢è¡Œç¬¦ï¼ˆprintlnï¼‰ï¼Œæ‰€ä»¥å¤šäº†ä¸€ä¸ª
  
  3ã€ä¹‹åçš„å­—ç¬¦ä¸²â€1â€ åˆ° â€œ10â€ä¸ä¼šå†æ¬¡åŠ è½½
  

åˆ†æå­—ç¬¦ä¸²å¸¸é‡æ± çš„å˜åŒ–-æ¡ˆä¾‹2ï¼š

å®˜æ–¹ç¤ºä¾‹ä»£ç 

  //å®˜æ–¹ç¤ºä¾‹ä»£ç class Memory &#123;    public static void main(String[] args) &#123;//line 1        int i = 1;//line 2        Object obj = new Object();//line 3        Memory mem = new Memory();//line 4        mem.foo(obj);//line 5    &#125;//line 9    private void foo(Object param) &#123;//line 6        String str = param.toString();//line 7        System.out.println(str);    &#125;//line 8&#125;

åˆ†æè¿è¡Œæ—¶å†…å­˜ï¼ˆfoo() æ–¹æ³•æ˜¯å®ä¾‹æ–¹æ³•ï¼Œå…¶å®å›¾ä¸­å°‘äº†ä¸€ä¸ª this å±€éƒ¨å˜é‡ï¼‰

  




3.å­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œ
å­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œ

å¸¸é‡ä¸å¸¸é‡çš„æ‹¼æ¥ç»“æœåœ¨å¸¸é‡æ± ï¼ŒåŸç†æ˜¯ç¼–è¯‘æœŸä¼˜åŒ–
å¸¸é‡æ± ä¸­ä¸ä¼šå­˜åœ¨ç›¸åŒå†…å®¹çš„å˜é‡
åªè¦å…¶ä¸­æœ‰ä¸€ä¸ªæ˜¯å˜é‡ï¼Œç»“æœå°±åœ¨å †ä¸­ã€‚å˜é‡æ‹¼æ¥çš„åŸç†æ˜¯StringBuilder
å¦‚æœæ‹¼æ¥çš„ç»“æœè°ƒç”¨intern()æ–¹æ³•ï¼Œåˆ™ä¸»åŠ¨å°†å¸¸é‡æ± ä¸­è¿˜æ²¡æœ‰çš„å­—ç¬¦ä¸²å¯¹è±¡æ”¾å…¥æ± ä¸­ï¼Œå¹¶è¿”å›æ­¤å¯¹è±¡åœ°å€


å¸¸é‡ä¸å¸¸é‡çš„æ‹¼æ¥ç»“æœåœ¨å¸¸é‡æ± ï¼ŒåŸç†æ˜¯ç¼–è¯‘æœŸä¼˜åŒ–
  @Testpublic void test1()&#123;    String s1 = &quot;a&quot; + &quot;b&quot; + &quot;c&quot;;//ç¼–è¯‘æœŸä¼˜åŒ–ï¼šç­‰åŒäº&quot;abc&quot;    String s2 = &quot;abc&quot;; //&quot;abc&quot;ä¸€å®šæ˜¯æ”¾åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œå°†æ­¤åœ°å€èµ‹ç»™s2    /*     * æœ€ç»ˆ.javaç¼–è¯‘æˆ.class,å†æ‰§è¡Œ.class     * String s1 = &quot;abc&quot;;     * String s2 = &quot;abc&quot;     */    System.out.println(s1 == s2); //true    System.out.println(s1.equals(s2)); //true&#125;
  ä»å­—èŠ‚ç æŒ‡ä»¤çœ‹å‡ºï¼šç¼–è¯‘å™¨åšäº†ä¼˜åŒ–ï¼Œå°† â€œaâ€ + â€œbâ€ + â€œcâ€ ä¼˜åŒ–æˆäº† â€œabcâ€
  0: ldc           #2                  // String abc2: astore_13: ldc           #2                  // String abc5: astore_26: getstatic     #3                  // Field java/lang/System.out:Ljava/io/PrintStream;9: aload_110: aload_211: if_acmpne     1814: iconst_115: goto          1918: iconst_019: invokevirtual #4                  // Method java/io/PrintStream.println:(Z)V22: getstatic     #3                  // Field java/lang/System.out:Ljava/io/PrintStream;25: aload_126: aload_227: invokevirtual #5                  // Method java/lang/String.equals:(Ljava/lang/Object;)Z30: invokevirtual #4                  // Method java/io/PrintStream.println:(Z)V33: return
  IDEA åç¼–è¯‘ class æ–‡ä»¶åï¼Œæ¥çœ‹è¿™ä¸ªé—®é¢˜
  

æ‹¼æ¥å‰åï¼Œåªè¦å…¶ä¸­æœ‰ä¸€ä¸ªæ˜¯å˜é‡ï¼Œç»“æœå°±åœ¨å †ä¸­
  public void test2()&#123;    String s1 = &quot;javaEE&quot;;    String s2 = &quot;hadoop&quot;;    String s3 = &quot;javaEEhadoop&quot;;    String s4 = &quot;javaEE&quot; + &quot;hadoop&quot;;//ç¼–è¯‘æœŸä¼˜åŒ–    //å¦‚æœæ‹¼æ¥ç¬¦å·çš„å‰åå‡ºç°äº†å˜é‡ï¼Œåˆ™ç›¸å½“äºåœ¨å †ç©ºé—´ä¸­new String()ï¼Œå…·ä½“çš„å†…å®¹ä¸ºæ‹¼æ¥çš„ç»“æœï¼šjavaEEhadoop    String s5 = s1 + &quot;hadoop&quot;;    String s6 = &quot;javaEE&quot; + s2;    String s7 = s1 + s2;    System.out.println(s3 == s4);//true    System.out.println(s3 == s5);//false    System.out.println(s3 == s6);//false    System.out.println(s3 == s7);//false    System.out.println(s5 == s6);//false    System.out.println(s5 == s7);//false    System.out.println(s6 == s7);//false    //intern():åˆ¤æ–­å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ˜¯å¦å­˜åœ¨javaEEhadoopå€¼ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™è¿”å›å¸¸é‡æ± ä¸­javaEEhadoopçš„åœ°å€ï¼›    //å¦‚æœå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ä¸å­˜åœ¨javaEEhadoopï¼Œåˆ™åœ¨å¸¸é‡æ± ä¸­åŠ è½½ä¸€ä»½javaEEhadoopï¼Œå¹¶è¿”å›æ¬¡å¯¹è±¡çš„åœ°å€ã€‚    String s8 = s6.intern();    System.out.println(s3 == s8);//true&#125;
  ä»ä¸Šè¿°çš„ç»“æœæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼š
  ä»å­—èŠ‚ç è§’åº¦æ¥çœ‹ï¼šæ‹¼æ¥å‰åæœ‰å˜é‡ï¼Œéƒ½ä¼šä½¿ç”¨åˆ° StringBuilder ç±»
  å¦‚æœæ‹¼æ¥ç¬¦å·çš„å‰åå‡ºç°äº†å˜é‡ï¼Œåˆ™ç›¸å½“äºåœ¨å †ç©ºé—´ä¸­new String()ï¼Œå…·ä½“çš„å†…å®¹ä¸ºæ‹¼æ¥çš„ç»“æœ
  è€Œè°ƒç”¨internæ–¹æ³•ï¼Œåˆ™ä¼šåˆ¤æ–­å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ˜¯å¦å­˜åœ¨JavaEEhadoopå€¼ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›å¸¸é‡æ± ä¸­çš„å€¼ï¼Œå¦è€…å°±åœ¨å¸¸é‡æ± ä¸­åˆ›å»º

åº•å±‚åŸç†

æ‹¼æ¥æ“ä½œçš„åº•å±‚å…¶å®ä½¿ç”¨äº†StringBuilder
  public void test3()&#123;    String s1 = &quot;a&quot;;    String s2 = &quot;b&quot;;    String s3 = &quot;ab&quot;;    /*    å¦‚ä¸‹çš„s1 + s2 çš„æ‰§è¡Œç»†èŠ‚ï¼š(å˜é‡sæ˜¯æˆ‘ä¸´æ—¶å®šä¹‰çš„ï¼‰    â‘  StringBuilder s = new StringBuilder();    â‘¡ s.append(&quot;a&quot;)    â‘¢ s.append(&quot;b&quot;)    â‘£ s.toString()  --&gt; çº¦ç­‰äº new String(&quot;ab&quot;)ï¼Œä½†ä¸ç­‰ä»·    è¡¥å……ï¼šåœ¨jdk5.0ä¹‹åä½¿ç”¨çš„æ˜¯StringBuilder,åœ¨jdk5.0ä¹‹å‰ä½¿ç”¨çš„æ˜¯StringBuffer     */    String s4 = s1 + s2;//    System.out.println(s3 == s4);//false&#125;
  

å­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œä¸ä¸€å®šä½¿ç”¨çš„æ˜¯StringBuilder


  /*    1. å­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œä¸ä¸€å®šä½¿ç”¨çš„æ˜¯StringBuilder!       å¦‚æœæ‹¼æ¥ç¬¦å·å·¦å³ä¸¤è¾¹éƒ½æ˜¯å­—ç¬¦ä¸²å¸¸é‡æˆ–å¸¸é‡å¼•ç”¨ï¼Œåˆ™ä»ç„¶ä½¿ç”¨ç¼–è¯‘æœŸä¼˜åŒ–ï¼Œå³éStringBuilderçš„æ–¹å¼ã€‚    2. é’ˆå¯¹äºfinalä¿®é¥°ç±»ã€æ–¹æ³•ã€åŸºæœ¬æ•°æ®ç±»å‹ã€å¼•ç”¨æ•°æ®ç±»å‹çš„é‡çš„ç»“æ„æ—¶ï¼Œèƒ½ä½¿ç”¨ä¸Šfinalçš„æ—¶å€™å»ºè®®ä½¿ç”¨ä¸Šã€‚     */    @Test    public void test4()&#123;        final String s1 = &quot;a&quot;;        final String s2 = &quot;b&quot;;        String s3 = &quot;ab&quot;;        String s4 = s1 + s2;        System.out.println(s3 == s4);//true    &#125;

ä»å­—èŠ‚ç è§’åº¦æ¥çœ‹ï¼šä¸ºå˜é‡ s4 èµ‹å€¼æ—¶ï¼Œç›´æ¥ä½¿ç”¨ #16 ç¬¦å·å¼•ç”¨ï¼Œå³å­—ç¬¦ä¸²å¸¸é‡ â€œabâ€
  0 ldc #14 &lt;a&gt;2 astore_13 ldc #15 &lt;b&gt;5 astore_26 ldc #16 &lt;ab&gt;8 astore_39 ldc #16 &lt;ab&gt;11 astore 413 getstatic #3 &lt;java/lang/System.out&gt;16 aload_317 aload 419 if_acmpne 26 (+7)22 iconst_123 goto 27 (+4)26 iconst_027 invokevirtual #4 &lt;java/io/PrintStream.println&gt;30 return


æ‹¼æ¥æ“ä½œå’Œappendæ€§èƒ½å¯¹æ¯”
  public static void method1(int highLevel) &#123;    String src = &quot;&quot;;    for (int i = 0; i &lt; highLevel; i++) &#123;        src += &quot;a&quot;; // æ¯æ¬¡å¾ªç¯éƒ½ä¼šåˆ›å»ºä¸€ä¸ªStringBuilderå¯¹è±¡    &#125;&#125;public static void method2(int highLevel) &#123;    StringBuilder sb = new StringBuilder();    for (int i = 0; i &lt; highLevel; i++) &#123;        sb.append(&quot;a&quot;);    &#125;&#125;

æ–¹æ³•1è€—è´¹çš„æ—¶é—´ï¼š4005msï¼Œæ–¹æ³•2æ¶ˆè€—æ—¶é—´ï¼š7ms
  ç»“è®ºï¼š

é€šè¿‡StringBuilderçš„append()æ–¹å¼æ·»åŠ å­—ç¬¦ä¸²çš„æ•ˆç‡ï¼Œè¦è¿œè¿œé«˜äºStringçš„å­—ç¬¦ä¸²æ‹¼æ¥æ–¹æ³•

  å¥½å¤„

StringBuilderçš„appendçš„æ–¹å¼ï¼Œè‡ªå§‹è‡³ç»ˆåªåˆ›å»ºä¸€ä¸ªStringBuilderçš„å¯¹è±¡
å¯¹äºå­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼ï¼Œè¿˜éœ€è¦åˆ›å»ºå¾ˆå¤šStringBuilderå¯¹è±¡å’Œ è°ƒç”¨toStringæ—¶å€™åˆ›å»ºçš„Stringå¯¹è±¡
å†…å­˜ä¸­ç”±äºåˆ›å»ºäº†è¾ƒå¤šçš„StringBuilderå’ŒStringå¯¹è±¡ï¼Œå†…å­˜å ç”¨è¿‡å¤§ï¼Œå¦‚æœè¿›è¡ŒGCé‚£ä¹ˆå°†ä¼šè€—è´¹æ›´å¤šçš„æ—¶é—´

  æ”¹è¿›çš„ç©ºé—´

æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯StringBuilderçš„ç©ºå‚æ„é€ å™¨ï¼Œé»˜è®¤çš„å­—ç¬¦ä¸²å®¹é‡æ˜¯16ï¼Œç„¶åå°†åŸæ¥çš„å­—ç¬¦ä¸²æ‹·è´åˆ°æ–°çš„å­—ç¬¦ä¸²ä¸­ï¼Œ æˆ‘ä»¬ä¹Ÿå¯ä»¥é»˜è®¤åˆå§‹åŒ–æ›´å¤§çš„é•¿åº¦ï¼Œå‡å°‘æ‰©å®¹çš„æ¬¡æ•°
å› æ­¤åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬èƒ½å¤Ÿç¡®å®šï¼Œå‰å‰ååéœ€è¦æ·»åŠ çš„å­—ç¬¦ä¸²ä¸é«˜äºæŸä¸ªé™å®šå€¼ï¼Œé‚£ä¹ˆå»ºè®®ä½¿ç”¨æ„é€ å™¨åˆ›å»ºä¸€ä¸ªé˜ˆå€¼çš„é•¿åº¦




intern()çš„ä½¿ç”¨


intern() æ–¹æ³•çš„è¯´æ˜



  public native String intern();

internæ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼Œè°ƒç”¨çš„æ˜¯åº•å±‚Cçš„æ–¹æ³•

å­—ç¬¦ä¸²å¸¸é‡æ± æ± æœ€åˆæ˜¯ç©ºçš„ï¼Œç”±Stringç±»ç§æœ‰åœ°ç»´æŠ¤ã€‚åœ¨è°ƒç”¨internæ–¹æ³•æ—¶ï¼Œå¦‚æœæ± ä¸­å·²ç»åŒ…å«äº†ç”±equals(object)æ–¹æ³•ç¡®å®šçš„ä¸è¯¥å­—ç¬¦ä¸²å†…å®¹ç›¸ç­‰çš„å­—ç¬¦ä¸²ï¼Œåˆ™è¿”å›æ± ä¸­çš„å­—ç¬¦ä¸²åœ°å€ã€‚å¦åˆ™ï¼Œè¯¥å­—ç¬¦ä¸²å¯¹è±¡å°†è¢«æ·»åŠ åˆ°æ± ä¸­ï¼Œå¹¶è¿”å›å¯¹è¯¥å­—ç¬¦ä¸²å¯¹è±¡çš„åœ°å€ã€‚ï¼ˆè¿™æ˜¯æºç é‡Œçš„å¤§æ¦‚ç¿»è¯‘ï¼‰

å¦‚æœä¸æ˜¯ç”¨åŒå¼•å·å£°æ˜çš„Stringå¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨Stringæä¾›çš„internæ–¹æ³•ï¼šinternæ–¹æ³•ä¼šä»å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æŸ¥è¯¢å½“å‰å­—ç¬¦ä¸²æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨å°±ä¼šå°†å½“å‰å­—ç¬¦ä¸²æ”¾å…¥å¸¸é‡æ± ä¸­ã€‚æ¯”å¦‚ï¼š
 String myInfo = new string(&quot;I love atguigu&quot;).intern();

ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœåœ¨ä»»æ„å­—ç¬¦ä¸²ä¸Šè°ƒç”¨String.internæ–¹æ³•ï¼Œé‚£ä¹ˆå…¶è¿”å›ç»“æœæ‰€æŒ‡å‘çš„é‚£ä¸ªç±»å®ä¾‹ï¼Œå¿…é¡»å’Œç›´æ¥ä»¥å¸¸é‡å½¢å¼å‡ºç°çš„å­—ç¬¦ä¸²å®ä¾‹å®Œå…¨ç›¸åŒã€‚å› æ­¤ï¼Œä¸‹åˆ—è¡¨è¾¾å¼çš„å€¼å¿…å®šæ˜¯true
 (&quot;a&quot;+&quot;b&quot;+&quot;c&quot;).intern()==&quot;abc&quot;

é€šä¿—ç‚¹è®²ï¼ŒInterned Stringå°±æ˜¯ç¡®ä¿å­—ç¬¦ä¸²åœ¨å†…å­˜é‡Œåªæœ‰ä¸€ä»½æ‹·è´ï¼Œè¿™æ ·å¯ä»¥èŠ‚çº¦å†…å­˜ç©ºé—´ï¼ŒåŠ å¿«å­—ç¬¦ä¸²æ“ä½œä»»åŠ¡çš„æ‰§è¡Œé€Ÿåº¦ã€‚æ³¨æ„ï¼Œè¿™ä¸ªå€¼ä¼šè¢«å­˜æ”¾åœ¨å­—ç¬¦ä¸²å†…éƒ¨æ± ï¼ˆString Intern Poolï¼‰



new String() çš„è¯´æ˜

new String(â€œabâ€)ä¼šåˆ›å»ºå‡ ä¸ªå¯¹è±¡ï¼Ÿ
  /** * é¢˜ç›®ï¼š * new String(&quot;ab&quot;)ä¼šåˆ›å»ºå‡ ä¸ªå¯¹è±¡ï¼Ÿçœ‹å­—èŠ‚ç ï¼Œå°±çŸ¥é“æ˜¯ä¸¤ä¸ªã€‚ *     ä¸€ä¸ªå¯¹è±¡æ˜¯ï¼šnewå…³é”®å­—åœ¨å †ç©ºé—´åˆ›å»ºçš„ *     å¦ä¸€ä¸ªå¯¹è±¡æ˜¯ï¼šå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„å¯¹è±¡&quot;ab&quot;ã€‚ å­—èŠ‚ç æŒ‡ä»¤ï¼šldc * */public class StringNewTest &#123;    public static void main(String[] args) &#123;        String str = new String(&quot;ab&quot;);    &#125;&#125;

å­—èŠ‚ç æŒ‡ä»¤

  0 new #2 &lt;java/lang/String&gt;3 dup4 ldc #3 &lt;ab&gt;6 invokespecial #4 &lt;java/lang/String.&lt;init&gt;&gt;9 astore_110 return
  0 new #2 &lt;java/lang/String&gt;ï¼šåœ¨å †ä¸­åˆ›å»ºäº†ä¸€ä¸ª String å¯¹è±¡
  4 ldc #3 &lt;ab&gt;Â ï¼šåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ”¾å…¥ â€œabâ€ï¼ˆå¦‚æœä¹‹å‰å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ²¡æœ‰ â€œabâ€ çš„è¯ï¼‰
  

new String(â€œaâ€) + new String(â€œbâ€) ä¼šåˆ›å»ºå‡ ä¸ªå¯¹è±¡ï¼Ÿ

ä»£ç 

  /** * æ€è€ƒï¼š * new String(&quot;a&quot;) + new String(&quot;b&quot;)å‘¢ï¼Ÿ *  å¯¹è±¡1ï¼šnew StringBuilder() *  å¯¹è±¡2ï¼š new String(&quot;a&quot;) *  å¯¹è±¡3ï¼š å¸¸é‡æ± ä¸­çš„&quot;a&quot; *  å¯¹è±¡4ï¼š new String(&quot;b&quot;) *  å¯¹è±¡5ï¼š å¸¸é‡æ± ä¸­çš„&quot;b&quot; * *  æ·±å…¥å‰–æï¼š StringBuilderçš„toString(): *      å¯¹è±¡6 ï¼šnew String(&quot;ab&quot;) *       å¼ºè°ƒä¸€ä¸‹ï¼ŒtoString()çš„è°ƒç”¨ï¼Œåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œæ²¡æœ‰ç”Ÿæˆ&quot;ab&quot; * */public class StringNewTest &#123;    public static void main(String[] args) &#123;        String str = new String(&quot;a&quot;) + new String(&quot;b&quot;);    &#125;&#125;
  å­—èŠ‚ç æŒ‡ä»¤
  0: new           #2                  // class java/lang/StringBuilder3: dup4: invokespecial #3                  // Method java/lang/StringBuilder.&quot;&lt;init&gt;&quot;:()V7: new           #4                  // class java/lang/String10: dup11: ldc           #5                  // String a13: invokespecial #6                  // Method java/lang/String.&quot;&lt;init&gt;&quot;:(Ljava/lang/String;)V16: invokevirtual #7                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;19: new           #4                  // class java/lang/String22: dup23: ldc           #8                  // String b25: invokespecial #6                  // Method java/lang/String.&quot;&lt;init&gt;&quot;:(Ljava/lang/String;)V28: invokevirtual #7                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;31: invokevirtual #9                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;34: astore_135: return
  æˆ‘ä»¬åˆ›å»ºäº†6ä¸ªå¯¹è±¡

å¯¹è±¡1ï¼šnew StringBuilder()
å¯¹è±¡2ï¼šnew String(â€œaâ€)
å¯¹è±¡3ï¼šå¸¸é‡æ± çš„ a
å¯¹è±¡4ï¼šnew String(â€œbâ€)
å¯¹è±¡5ï¼šå¸¸é‡æ± çš„ b
å¯¹è±¡6ï¼štoStringä¸­ä¼šåˆ›å»ºä¸€ä¸ª new String(â€œabâ€)
è°ƒç”¨toStringæ–¹æ³•ï¼Œä¸ä¼šåœ¨å¸¸é‡æ± ä¸­ç”Ÿæˆab






internçš„ä½¿ç”¨ï¼šJDK6å’ŒJDK7

JDK6ä¸­
  String s = new String(&quot;1&quot;);  // åœ¨å¸¸é‡æ± ä¸­å·²ç»æœ‰äº†s.intern(); // å°†è¯¥å¯¹è±¡æ”¾å…¥åˆ°å¸¸é‡æ± ã€‚ä½†æ˜¯è°ƒç”¨æ­¤æ–¹æ³•æ²¡æœ‰å¤ªå¤šçš„åŒºåˆ«ï¼Œå› ä¸ºå·²ç»å­˜åœ¨äº†1String s2 = &quot;1&quot;;System.out.println(s == s2); // falseString s3 = new String(&quot;1&quot;) + new String(&quot;1&quot;);s3.intern();String s4 = &quot;11&quot;;System.out.println(s3 == s4); // false
  è¾“å‡ºç»“æœ
  falsefalse

ä¸ºä»€ä¹ˆå¯¹è±¡ä¼šä¸ä¸€æ ·å‘¢ï¼Ÿ

ä¸€ä¸ªæ˜¯newåˆ›å»ºçš„å¯¹è±¡ï¼Œä¸€ä¸ªæ˜¯å¸¸é‡æ± ä¸­çš„å¯¹è±¡ï¼Œæ˜¾ç„¶ä¸æ˜¯åŒä¸€ä¸ª




å¦‚æœæ˜¯ä¸‹é¢è¿™æ ·çš„ï¼Œé‚£ä¹ˆå°±æ˜¯true
  String s = new String(&quot;1&quot;);s = s.intern();String s2 = &quot;1&quot;;System.out.println(s == s2); // true
  è€Œå¯¹äºä¸‹é¢çš„æ¥è¯´ï¼Œå› ä¸º s3å˜é‡è®°å½•çš„åœ°å€æ˜¯ new String(â€œ11â€)ï¼Œç„¶åè¿™æ®µä»£ç æ‰§è¡Œå®Œä»¥åï¼Œå¸¸é‡æ± ä¸­ä¸å­˜åœ¨ â€œ11â€ï¼Œè¿™æ˜¯JDK6çš„å…³ç³»ï¼Œç„¶åæ‰§è¡Œ s3.intern()åï¼Œå°±ä¼šåœ¨å¸¸é‡æ± ä¸­ç”Ÿæˆ â€œ11â€ï¼Œæœ€å s4ç”¨çš„å°±æ˜¯s3çš„åœ°å€

ä¸ºä»€ä¹ˆæœ€åè¾“å‡ºçš„ s3 &#x3D;&#x3D; s4 ä¼šä¸ºfalseå‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºåœ¨JDK6ä¸­åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ â€œ11â€ï¼Œä¹Ÿå°±æ˜¯æœ‰äº†æ–°çš„åœ°å€ï¼Œ s2 &#x3D; æ–°åœ°å€è€Œåœ¨JDK7ä¸­ï¼Œåœ¨JDK7ä¸­ï¼Œå¹¶æ²¡æœ‰åˆ›æ–°ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œè€Œæ˜¯æŒ‡å‘å¸¸é‡æ± ä¸­çš„æ–°å¯¹è±¡


JDK7ä¸­
  String s = new String(&quot;1&quot;);s.intern();String s2 = &quot;1&quot;;System.out.println(s == s2); // falseString s3 = new String(&quot;1&quot;) + new String(&quot;1&quot;);s3.intern();String s4 = &quot;11&quot;;System.out.println(s3 == s4); // true
  



æ‰©å±•
  /** * StringIntern.javaä¸­ç»ƒä¹ çš„æ‹“å±•ï¼š * */public class StringIntern1 &#123;    public static void main(String[] args) &#123;        //æ‰§è¡Œå®Œä¸‹ä¸€è¡Œä»£ç ä»¥åï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œæ˜¯å¦å­˜åœ¨&quot;11&quot;å‘¢ï¼Ÿç­”æ¡ˆï¼šä¸å­˜åœ¨ï¼ï¼        String s3 = new String(&quot;1&quot;) + new String(&quot;1&quot;);//new String(&quot;11&quot;)        //åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ç”Ÿæˆå¯¹è±¡&quot;11&quot;ï¼Œä»£ç é¡ºåºæ¢ä¸€ä¸‹ï¼Œå®æ‰“å®çš„åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± é‡Œæœ‰ä¸€ä¸ª&quot;11&quot;å¯¹è±¡        String s4 = &quot;11&quot;;        String s5 = s3.intern();        // s3 æ˜¯å †ä¸­çš„ &quot;ab&quot; ï¼Œs4 æ˜¯å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„ &quot;ab&quot;        System.out.println(s3 == s4);//false        // s5 æ˜¯ä»å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å–å›æ¥çš„å¼•ç”¨ï¼Œå½“ç„¶å’Œ s4 ç›¸ç­‰        System.out.println(s5 == s4);//true    &#125;&#125;

æ€»ç»“stringçš„internï¼ˆï¼‰çš„ä½¿ç”¨ï¼š
  JDK1.6ä¸­ï¼Œå°†è¿™ä¸ªå­—ç¬¦ä¸²å¯¹è±¡å°è¯•æ”¾å…¥ä¸²æ± ã€‚

å¦‚æœä¸²æ± ä¸­æœ‰ï¼Œåˆ™å¹¶ä¸ä¼šæ”¾å…¥ã€‚è¿”å›å·²æœ‰çš„ä¸²æ± ä¸­çš„å¯¹è±¡çš„åœ°å€
å¦‚æœæ²¡æœ‰ï¼Œä¼šæŠŠæ­¤å¯¹è±¡å¤åˆ¶ä¸€ä»½ï¼Œæ”¾å…¥ä¸²æ± ï¼Œå¹¶è¿”å›ä¸²æ± ä¸­çš„å¯¹è±¡åœ°å€

  JDK1.7èµ·ï¼Œå°†è¿™ä¸ªå­—ç¬¦ä¸²å¯¹è±¡å°è¯•æ”¾å…¥ä¸²æ± ã€‚

å¦‚æœä¸²æ± ä¸­æœ‰ï¼Œåˆ™å¹¶ä¸ä¼šæ”¾å…¥ã€‚è¿”å›å·²æœ‰çš„ä¸²æ± ä¸­çš„å¯¹è±¡çš„åœ°å€
å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šæŠŠå¯¹è±¡çš„å¼•ç”¨åœ°å€å¤åˆ¶ä¸€ä»½ï¼Œæ”¾å…¥ä¸²æ± ï¼Œå¹¶è¿”å›ä¸²æ± ä¸­çš„å¼•ç”¨åœ°å€


ç»ƒä¹ ï¼š
  

åœ¨JDK6ä¸­ï¼Œåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸² â€œabâ€
åœ¨JDK8ä¸­ï¼Œåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ²¡æœ‰åˆ›å»º â€œabâ€ï¼Œè€Œæ˜¯å°†å †ä¸­çš„åœ°å€å¤åˆ¶åˆ° ä¸²æ± ä¸­ã€‚
æ‰€ä»¥ä¸Šè¿°ç»“æœï¼Œåœ¨JDK6ä¸­æ˜¯ï¼š

  truefalse

åœ¨JDK8ä¸­æ˜¯

  falsetrue
  
  é’ˆå¯¹ä¸‹é¢è¿™é¢˜ï¼Œåœ¨JDK6å’Œ8ä¸­è¡¨ç°çš„æ˜¯ä¸€æ ·çš„
  


4.StringTableçš„åƒåœ¾å›æ”¶package com.peppa.strings;/** * Stringçš„åƒåœ¾å›æ”¶: * -Xms15m -Xmx15m -XX:+PrintStringTableStatistics -XX:+PrintGCDetails */public class StringGCTest &#123;    public static void main(String[] args) &#123;        for (int j = 0; j &lt; 100000; j++) &#123;            String.valueOf(j).intern();        &#125;    &#125;&#125;

[GC (Allocation Failure) [PSYoungGen: 4096K-&gt;488K(4608K)] 4096K-&gt;664K(15872K), 0.0011215 secs] [Times: user=0.02 sys=0.00, real=0.00 secs] Heap PSYoungGen      total 4608K, used 3577K [0x00000000ffb00000, 0x0000000100000000, 0x0000000100000000)  eden space 4096K, 75% used [0x00000000ffb00000,0x00000000ffe04688,0x00000000fff00000)  from space 512K, 95% used [0x00000000fff00000,0x00000000fff7a020,0x00000000fff80000)  to   space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000) ParOldGen       total 11264K, used 176K [0x00000000ff000000, 0x00000000ffb00000, 0x00000000ffb00000)  object space 11264K, 1% used [0x00000000ff000000,0x00000000ff02c000,0x00000000ffb00000) Metaspace       used 3234K, capacity 4496K, committed 4864K, reserved 1056768K  class space    used 350K, capacity 388K, committed 512K, reserved 1048576KSymbolTable statistics:Number of buckets       :     20011 =    160088 bytes, avg   8.000Number of entries       :     13304 =    319296 bytes, avg  24.000Number of literals      :     13304 =    568608 bytes, avg  42.740Total footprint         :           =   1047992 bytesAverage bucket size     :     0.665Variance of bucket size :     0.666Std. dev. of bucket size:     0.816Maximum bucket size     :         6StringTable statistics:Number of buckets       :     60013 =    480104 bytes, avg   8.000Number of entries       :     57042 =   1369008 bytes, avg  24.000Number of literals      :     57042 =   3253608 bytes, avg  57.039Total footprint         :           =   5102720 bytesAverage bucket size     :     0.950Variance of bucket size :     0.750Std. dev. of bucket size:     0.866Maximum bucket size     :         5

5.G1 ä¸­çš„ String å»é‡æ“ä½œå®˜æ–¹ï¼šJEP 192: String Deduplication in G1 (java.net)
æ³¨æ„è¿™é‡Œè¯´çš„é‡å¤ï¼ŒæŒ‡çš„æ˜¯åœ¨å †ä¸­çš„æ•°æ®ï¼Œè€Œä¸æ˜¯å¸¸é‡æ± ä¸­çš„ï¼Œå› ä¸ºå¸¸é‡æ± ä¸­çš„æœ¬èº«å°±ä¸ä¼šé‡å¤

æè¿°

èƒŒæ™¯ï¼šå¯¹è®¸å¤šJavaåº”ç”¨ï¼ˆæœ‰å¤§çš„ä¹Ÿæœ‰å°çš„ï¼‰åšçš„æµ‹è¯•å¾—å‡ºä»¥ä¸‹ç»“æœï¼š
å †å­˜æ´»æ•°æ®é›†åˆé‡Œé¢stringå¯¹è±¡å äº†25%
å †å­˜æ´»æ•°æ®é›†åˆé‡Œé¢é‡å¤çš„stringå¯¹è±¡æœ‰13.5%
stringå¯¹è±¡çš„å¹³å‡é•¿åº¦æ˜¯45


è®¸å¤šå¤§è§„æ¨¡çš„Javaåº”ç”¨çš„ç“¶é¢ˆåœ¨äºå†…å­˜ï¼Œæµ‹è¯•è¡¨æ˜ï¼Œåœ¨è¿™äº›ç±»å‹çš„åº”ç”¨é‡Œé¢ï¼ŒJavaå †ä¸­å­˜æ´»çš„æ•°æ®é›†åˆå·®ä¸å¤š25%æ˜¯stringå¯¹è±¡ã€‚æ›´è¿›ä¸€æ­¥ï¼Œè¿™é‡Œé¢å·®ä¸å¤šä¸€åŠstringå¯¹è±¡æ˜¯é‡å¤çš„ï¼Œé‡å¤çš„æ„æ€æ˜¯è¯´ï¼š stringl.equalsï¼ˆstring2ï¼‰&#x3D; trueã€‚å †ä¸Šå­˜åœ¨é‡å¤çš„stringå¯¹è±¡å¿…ç„¶æ˜¯ä¸€ç§å†…å­˜çš„æµªè´¹ã€‚è¿™ä¸ªé¡¹ç›®å°†åœ¨G1åƒåœ¾æ”¶é›†å™¨ä¸­å®ç°è‡ªåŠ¨æŒç»­å¯¹é‡å¤çš„stringå¯¹è±¡è¿›è¡Œå»é‡ï¼Œè¿™æ ·å°±èƒ½é¿å…æµªè´¹å†…å­˜ã€‚


String å»é‡çš„çš„å®ç°

å½“åƒåœ¾æ”¶é›†å™¨å·¥ä½œçš„æ—¶å€™ï¼Œä¼šè®¿é—®å †ä¸Šå­˜æ´»çš„å¯¹è±¡ã€‚å¯¹æ¯ä¸€ä¸ªè®¿é—®çš„å¯¹è±¡éƒ½ä¼šæ£€æŸ¥æ˜¯å¦æ˜¯å€™é€‰çš„è¦å»é‡çš„Stringå¯¹è±¡ã€‚
å¦‚æœæ˜¯ï¼ŒæŠŠè¿™ä¸ªå¯¹è±¡çš„ä¸€ä¸ªå¼•ç”¨æ’å…¥åˆ°é˜Ÿåˆ—ä¸­ç­‰å¾…åç»­çš„å¤„ç†ã€‚ä¸€ä¸ªå»é‡çš„çº¿ç¨‹åœ¨åå°è¿è¡Œï¼Œå¤„ç†è¿™ä¸ªé˜Ÿåˆ—ã€‚å¤„ç†é˜Ÿåˆ—çš„ä¸€ä¸ªå…ƒç´ æ„å‘³ç€ä»é˜Ÿåˆ—åˆ é™¤è¿™ä¸ªå…ƒç´ ï¼Œç„¶åå°è¯•å»é‡å®ƒå¼•ç”¨çš„Stringå¯¹è±¡ã€‚
ä½¿ç”¨ä¸€ä¸ªHashtableæ¥è®°å½•æ‰€æœ‰çš„è¢«Stringå¯¹è±¡ä½¿ç”¨çš„ä¸é‡å¤çš„charæ•°ç»„ã€‚å½“å»é‡çš„æ—¶å€™ï¼Œä¼šæŸ¥è¿™ä¸ªHashtableï¼Œæ¥çœ‹å †ä¸Šæ˜¯å¦å·²ç»å­˜åœ¨ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„charæ•°ç»„ã€‚
å¦‚æœå­˜åœ¨ï¼ŒStringå¯¹è±¡ä¼šè¢«è°ƒæ•´å¼•ç”¨é‚£ä¸ªæ•°ç»„ï¼Œé‡Šæ”¾å¯¹åŸæ¥çš„æ•°ç»„çš„å¼•ç”¨ï¼Œæœ€ç»ˆä¼šè¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶æ‰ã€‚
å¦‚æœæŸ¥æ‰¾å¤±è´¥ï¼Œcharæ•°ç»„ä¼šè¢«æ’å…¥åˆ°Hashtableï¼Œè¿™æ ·ä»¥åçš„æ—¶å€™å°±å¯ä»¥å…±äº«è¿™ä¸ªæ•°ç»„äº†ã€‚


å‘½ä»¤è¡Œé€‰é¡¹

UseStringDeduplication(bool) ï¼šå¼€å¯Stringå»é‡ï¼Œé»˜è®¤æ˜¯ä¸å¼€å¯çš„ï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯ã€‚
PrintStringDeduplicationStatistics(bool) ï¼šæ‰“å°è¯¦ç»†çš„å»é‡ç»Ÿè®¡ä¿¡æ¯
stringDeduplicationAgeThreshold(uintx) ï¼šè¾¾åˆ°è¿™ä¸ªå¹´é¾„çš„Stringå¯¹è±¡è¢«è®¤ä¸ºæ˜¯å»é‡çš„å€™é€‰å¯¹è±¡



]]></content>
      <categories>
        <category>JVMè™šæ‹Ÿæœºè¯¦è§£</category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>JVMè™šæ‹Ÿæœºè¯¦è§£</tag>
      </tags>
  </entry>
  <entry>
    <title>JVMè™šæ‹Ÿæœºè¯¦è§£(å››)**è¿è¡Œæ—¶æ•°æ®åŒºæ¦‚è¿°åŠçº¿ç¨‹</title>
    <url>/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E8%A7%A3(%E5%9B%9B)%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA%E6%A6%82%E8%BF%B0%E5%8F%8A%E7%BA%BF%E7%A8%8B/</url>
    <content><![CDATA[JVMè™šæ‹Ÿæœºè¯¦è§£(å››)è¿è¡Œæ—¶æ•°æ®åŒºæ¦‚è¿°åŠçº¿ç¨‹1. å‰è¨€æœ¬èŠ‚ä¸»è¦è®²çš„æ˜¯è¿è¡Œæ—¶æ•°æ®åŒºï¼Œä¹Ÿå°±æ˜¯ä¸‹å›¾è¿™éƒ¨åˆ†ï¼Œå®ƒæ˜¯åœ¨ç±»åŠ è½½å®Œæˆåçš„é˜¶æ®µ

å½“æˆ‘ä»¬é€šè¿‡å‰é¢çš„ï¼šç±»çš„åŠ è½½-&gt; éªŒè¯ -&gt; å‡†å¤‡ -&gt; è§£æ -&gt; åˆå§‹åŒ– è¿™å‡ ä¸ªé˜¶æ®µå®Œæˆåï¼Œå°±ä¼šç”¨åˆ°æ‰§è¡Œå¼•æ“å¯¹æˆ‘ä»¬çš„ç±»è¿›è¡Œä½¿ç”¨ï¼ŒåŒæ—¶æ‰§è¡Œå¼•æ“å°†ä¼šä½¿ç”¨åˆ°æˆ‘ä»¬è¿è¡Œæ—¶æ•°æ®åŒº

ä¹Ÿå°±æ˜¯å¤§å¨åšé¥­ï¼Œæˆ‘ä»¬æŠŠå¤§å¨åé¢çš„ä¸œè¥¿ï¼ˆåˆ‡å¥½çš„èœï¼Œåˆ€ï¼Œè°ƒæ–™ï¼‰ï¼Œæ¯”ä½œæ˜¯è¿è¡Œæ—¶æ•°æ®åŒºã€‚è€Œå¨å¸ˆå¯ä»¥ç±»æ¯”äºæ‰§è¡Œå¼•æ“ï¼Œå°†é€šè¿‡å‡†å¤‡çš„ä¸œè¥¿è¿›è¡Œåˆ¶ä½œæˆç²¾ç¾çš„èœå“

å†…å­˜æ˜¯éå¸¸é‡è¦çš„ç³»ç»Ÿèµ„æºï¼Œæ˜¯ç¡¬ç›˜å’ŒCPUçš„ä¸­é—´ä»“åº“åŠæ¡¥æ¢ï¼Œæ‰¿è½½ç€æ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºçš„å®æ—¶è¿è¡ŒJVMå†…å­˜å¸ƒå±€è§„å®šäº†Javaåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å†…å­˜ç”³è¯·ã€åˆ†é…ã€ç®¡ç†çš„ç­–ç•¥ï¼Œä¿è¯äº†JVMçš„é«˜æ•ˆç¨³å®šè¿è¡Œã€‚ä¸åŒçš„JVMå¯¹äºå†…å­˜çš„åˆ’åˆ†æ–¹å¼å’Œç®¡ç†æœºåˆ¶å­˜åœ¨ç€éƒ¨åˆ†å·®å¼‚ã€‚ç»“åˆJVMè™šæ‹Ÿæœºè§„èŒƒï¼Œæ¥æ¢è®¨ä¸€ä¸‹ç»å…¸çš„JVMå†…å­˜å¸ƒå±€ã€‚

æˆ‘ä»¬é€šè¿‡ç£ç›˜æˆ–è€…ç½‘ç»œIOå¾—åˆ°çš„æ•°æ®ï¼Œéƒ½éœ€è¦å…ˆåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç„¶åCPUä»å†…å­˜ä¸­è·å–æ•°æ®è¿›è¡Œè¯»å–ï¼Œä¹Ÿå°±æ˜¯è¯´å†…å­˜å……å½“äº†CPUå’Œç£ç›˜ä¹‹é—´çš„æ¡¥æ¢


è¿è¡Œæ—¶æ•°æ®åŒºçš„å®Œæ•´å›¾
  
  Javaè™šæ‹Ÿæœºå®šä¹‰äº†è‹¥å¹²ç§ç¨‹åºè¿è¡ŒæœŸé—´ä¼šä½¿ç”¨åˆ°çš„è¿è¡Œæ—¶æ•°æ®åŒºï¼Œå…¶ä¸­æœ‰ä¸€äº›ä¼šéšç€è™šæ‹Ÿæœºå¯åŠ¨è€Œåˆ›å»ºï¼Œéšç€è™šæ‹Ÿæœºé€€å‡ºè€Œé”€æ¯ã€‚å¦å¤–ä¸€äº›åˆ™æ˜¯ä¸çº¿ç¨‹ä¸€ä¸€å¯¹åº”çš„ï¼Œè¿™äº›ä¸çº¿ç¨‹å¯¹åº”çš„æ•°æ®åŒºåŸŸä¼šéšç€çº¿ç¨‹å¼€å§‹å’Œç»“æŸè€Œåˆ›å»ºå’Œé”€æ¯ã€‚
  ç°è‰²çš„ä¸ºå•ç‹¬çº¿ç¨‹ç§æœ‰çš„ï¼Œçº¢è‰²çš„ä¸ºå¤šä¸ªçº¿ç¨‹å…±äº«çš„ã€‚å³ï¼š

æ¯ä¸ªçº¿ç¨‹ï¼šç‹¬ç«‹åŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€æ ˆã€æœ¬åœ°æ ˆã€‚
çº¿ç¨‹é—´å…±äº«ï¼šå †ã€å †å¤–å†…å­˜ï¼ˆæ°¸ä¹…ä»£æˆ–å…ƒç©ºé—´ã€ä»£ç ç¼“å­˜ï¼‰

  


2. çº¿ç¨‹
JVM çº¿ç¨‹
çº¿ç¨‹æ˜¯ä¸€ä¸ªç¨‹åºé‡Œçš„è¿è¡Œå•å…ƒã€‚JVMå…è®¸ä¸€ä¸ªåº”ç”¨æœ‰å¤šä¸ªçº¿ç¨‹å¹¶è¡Œçš„æ‰§è¡Œ
åœ¨Hotspot JVMé‡Œï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¸æ“ä½œç³»ç»Ÿçš„æœ¬åœ°çº¿ç¨‹ç›´æ¥æ˜ å°„
å½“ä¸€ä¸ªJavaçº¿ç¨‹å‡†å¤‡å¥½æ‰§è¡Œä»¥åï¼Œæ­¤æ—¶ä¸€ä¸ªæ“ä½œç³»ç»Ÿçš„æœ¬åœ°çº¿ç¨‹ä¹ŸåŒæ—¶åˆ›å»ºã€‚Javaçº¿ç¨‹æ‰§è¡Œç»ˆæ­¢åï¼Œæœ¬åœ°çº¿ç¨‹ä¹Ÿä¼šå›æ”¶


æ“ä½œç³»ç»Ÿè´Ÿè´£å°†çº¿ç¨‹å®‰æ’è°ƒåº¦åˆ°ä»»ä½•ä¸€ä¸ªå¯ç”¨çš„CPUä¸Šã€‚ä¸€æ—¦æœ¬åœ°çº¿ç¨‹åˆå§‹åŒ–æˆåŠŸï¼Œå®ƒå°±ä¼šè°ƒç”¨Javaçº¿ç¨‹ä¸­çš„run()æ–¹æ³•


JVM ç³»ç»Ÿçº¿ç¨‹
å¦‚æœä½ ä½¿ç”¨jconsoleæˆ–è€…æ˜¯ä»»ä½•ä¸€ä¸ªè°ƒè¯•å·¥å…·ï¼Œéƒ½èƒ½çœ‹åˆ°åœ¨åå°æœ‰è®¸å¤šçº¿ç¨‹åœ¨è¿è¡Œã€‚è¿™äº›åå°çº¿ç¨‹ä¸åŒ…æ‹¬è°ƒç”¨public static void main(String[])çš„mainçº¿ç¨‹ä»¥åŠæ‰€æœ‰è¿™ä¸ªmainçº¿ç¨‹è‡ªå·±åˆ›å»ºçš„çº¿ç¨‹ã€‚
è¿™äº›ä¸»è¦çš„åå°ç³»ç»Ÿçº¿ç¨‹åœ¨Hotspot JVMé‡Œä¸»è¦æ˜¯ä»¥ä¸‹å‡ ä¸ªï¼š
è™šæ‹Ÿæœºçº¿ç¨‹ï¼šè¿™ç§çº¿ç¨‹çš„æ“ä½œæ˜¯éœ€è¦JVMè¾¾åˆ°å®‰å…¨ç‚¹æ‰ä¼šå‡ºç°ã€‚è¿™äº›æ“ä½œå¿…é¡»åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­å‘ç”Ÿçš„åŸå› æ˜¯ä»–ä»¬éƒ½éœ€è¦JVMè¾¾åˆ°å®‰å…¨ç‚¹ï¼Œè¿™æ ·å †æ‰ä¸ä¼šå˜åŒ–ã€‚è¿™ç§çº¿ç¨‹çš„æ‰§è¡Œç±»å‹æ‹¬â€stop-the-worldâ€çš„åƒåœ¾æ”¶é›†ï¼Œçº¿ç¨‹æ ˆæ”¶é›†ï¼Œçº¿ç¨‹æŒ‚èµ·ä»¥åŠåå‘é”æ’¤é”€
å‘¨æœŸä»»åŠ¡çº¿ç¨‹ï¼šè¿™ç§çº¿ç¨‹æ˜¯æ—¶é—´å‘¨æœŸäº‹ä»¶çš„ä½“ç°ï¼ˆæ¯”å¦‚ä¸­æ–­ï¼‰ï¼Œä»–ä»¬ä¸€èˆ¬ç”¨äºå‘¨æœŸæ€§æ“ä½œçš„è°ƒåº¦æ‰§è¡Œ
GCçº¿ç¨‹ï¼šè¿™ç§çº¿ç¨‹å¯¹åœ¨JVMé‡Œä¸åŒç§ç±»çš„åƒåœ¾æ”¶é›†è¡Œä¸ºæä¾›äº†æ”¯æŒ
ç¼–è¯‘çº¿ç¨‹ï¼šè¿™ç§çº¿ç¨‹åœ¨è¿è¡Œæ—¶ä¼šå°†å­—èŠ‚ç ç¼–è¯‘æˆåˆ°æœ¬åœ°ä»£ç 
ä¿¡å·è°ƒåº¦çº¿ç¨‹ï¼šè¿™ç§çº¿ç¨‹æ¥æ”¶ä¿¡å·å¹¶å‘é€ç»™JVMï¼Œåœ¨å®ƒå†…éƒ¨é€šè¿‡è°ƒç”¨é€‚å½“çš„æ–¹æ³•è¿›è¡Œå¤„ç†





]]></content>
      <categories>
        <category>JVMè™šæ‹Ÿæœºè¯¦è§£</category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>JVMè™šæ‹Ÿæœºè¯¦è§£</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(ä¸€)è®¤è¯†JAVAå¤šçº¿ç¨‹</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E4%B8%80)%E8%AE%A4%E8%AF%86JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B/</url>
    <content><![CDATA[1. ä»€ä¹ˆæ˜¯çº¿ç¨‹å’Œè¿›ç¨‹?&emsp;&emsp;åœ¨æ—©æœŸçš„è®¡ç®—æœºä¸­ä¸åŒ…å«æ“ä½œç³»ç»Ÿï¼Œå®ƒä»¬ä»å¤´åˆ°å°¾åªæ‰§è¡Œä¸€ä¸ªç¨‹åºï¼Œå¹¶è‚¯è¿™ä¸ªç¨‹åºèƒ½è®¿é—®è®¡ç®—æœºä¸­çš„æ‰€æœ‰çš„æ‰€æœ‰èµ„æºã€‚åœ¨è¿™ç§è£¸æœºç¯å¢ƒä¸­ï¼Œä¸ä»…å¾ˆéš¾ç¼–å†™å’Œè¿è¡Œç¨‹åºï¼Œè€Œä¸”æ¯æ¬¡åªèƒ½è¿è¡Œä¸€ä¸ªç¨‹åºï¼Œè¿™å¯¹äºæ˜‚è´µå¹¶ä¸”ç¨€æœ‰çš„è®¡ç®—æœºèµ„æºæ¥è¯´ä¹Ÿæ˜¯ä¸€ç§æµªè´¹ã€‚
&emsp;&emsp;æ“ä½œç³»ç»Ÿçš„å‡ºç°ä½¿å¾—è®¡ç®—æœºæ¯æ¬¡èƒ½è¿è¡Œå¤šä¸ªç¨‹åºï¼Œå¹¶ä¸”ä¸åŒçš„ç¨‹åºéƒ½åœ¨å•ç‹¬çš„è¿›ç¨‹ä¸­è¿è¡Œï¼šæ“ä½œç³»ç»Ÿä¸ºå„ä¸ªç‹¬ç«‹æ‰§è¡Œçš„è¿›ç¨‹åˆ†é…å„ç§èµ„æºï¼ŒåŒ…æ‹¬å†…å­˜ï¼Œæ–‡ä»¶å¥æŸ„ä»¥åŠå®‰å…¨è¯ä¹¦ç­‰ã€‚å¦‚æœéœ€è¦çš„è¯ï¼Œåœ¨ä¸åŒçš„è¿›ç¨‹ä¹‹é—´å¯ä»¥é€šè¿‡ä¸€äº›ç²—ç²’åº¦çš„é€šä¿¡æœºåˆ¶æ¥äº¤æ¢æ•°æ®ï¼ŒåŒ…æ‹¬ï¼šå¥—æ¥å­—ã€ä¿¡å·å¤„ç†å™¨ã€å…±äº«å†…å­˜ã€ä¿¡å·é‡ä»¥åŠæ–‡ä»¶ç­‰ã€‚
1.1 ä»€ä¹ˆæ˜¯è¿›ç¨‹è¿›ç¨‹æ˜¯ç¨‹åºçš„ä¸€æ¬¡æ‰§è¡Œè¿‡ç¨‹ï¼Œæ˜¯ç³»ç»Ÿè¿è¡Œç¨‹åºçš„åŸºæœ¬å•ä½ï¼Œå› æ­¤è¿›ç¨‹æ˜¯åŠ¨æ€çš„ã€‚ç³»ç»Ÿè¿è¡Œä¸€ä¸ªç¨‹åºå³æ˜¯ä¸€ä¸ªè¿›ç¨‹ä»åˆ›å»ºï¼Œè¿è¡Œåˆ°æ¶ˆäº¡çš„è¿‡ç¨‹ã€‚
åœ¨ Java ä¸­ï¼Œå½“æˆ‘ä»¬å¯åŠ¨ main å‡½æ•°æ—¶å…¶å®å°±æ˜¯å¯åŠ¨äº†ä¸€ä¸ª JVM çš„è¿›ç¨‹ï¼Œè€Œ main å‡½æ•°æ‰€åœ¨çš„çº¿ç¨‹å°±æ˜¯è¿™ä¸ªè¿›ç¨‹ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œä¹Ÿç§°ä¸»çº¿ç¨‹ã€‚
å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨ windows ä¸­é€šè¿‡æŸ¥çœ‹ä»»åŠ¡ç®¡ç†å™¨çš„æ–¹å¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¸…æ¥šçœ‹åˆ° window å½“å‰è¿è¡Œçš„è¿›ç¨‹ï¼ˆ.exe æ–‡ä»¶çš„è¿è¡Œï¼‰ã€‚
1.2 ä»€ä¹ˆæ˜¯çº¿ç¨‹çº¿ç¨‹ä¸è¿›ç¨‹ç›¸ä¼¼ï¼Œä½†çº¿ç¨‹æ˜¯ä¸€ä¸ªæ¯”è¿›ç¨‹æ›´å°çš„æ‰§è¡Œå•ä½ã€‚ä¸€ä¸ªè¿›ç¨‹åœ¨å…¶æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å¯ä»¥äº§ç”Ÿå¤šä¸ªçº¿ç¨‹ã€‚ä¸è¿›ç¨‹ä¸åŒçš„æ˜¯åŒç±»çš„å¤šä¸ªçº¿ç¨‹å…±äº«è¿›ç¨‹çš„å †å’Œæ–¹æ³•åŒºèµ„æºï¼Œä½†æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆï¼Œæ‰€ä»¥ç³»ç»Ÿåœ¨äº§ç”Ÿä¸€ä¸ªçº¿ç¨‹ï¼Œæˆ–æ˜¯åœ¨å„ä¸ªçº¿ç¨‹ä¹‹é—´ä½œåˆ‡æ¢å·¥ä½œæ—¶ï¼Œè´Ÿæ‹…è¦æ¯”è¿›ç¨‹å°å¾—å¤šï¼Œä¹Ÿæ­£å› ä¸ºå¦‚æ­¤ï¼Œçº¿ç¨‹ä¹Ÿè¢«ç§°ä¸ºè½»é‡çº§è¿›ç¨‹ã€‚
2. Javaä¸­åˆ›å»ºçº¿ç¨‹&emsp;&emsp;åœ¨Javaä¸­åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼æœ‰ä¸‰ç§ï¼šç»§æ‰¿Threadç±»é‡å†™runæ–¹æ³•ã€å®ç°runnableæ¥å£é‡å†™runæ–¹æ³•å’Œå®ç°callableæ¥å£é‡å†™callæ–¹æ³•é…åˆfutureTaskä½¿ç”¨
2.1 ç»§æ‰¿Threadç±»ç»§æ‰¿Threadç±»çš„æ–¹å¼åˆ›å»ºçº¿ç¨‹ç®—æ˜¯æœ€ç®€å•çš„äº†ï¼Œä½†æ˜¯ä½ çš„çº¿ç¨‹ç±»å¾€å¾€è¦ç»§æ‰¿é¡¹ç›®ä¸­çš„å…¶ä»–ç±»ï¼Œè€ŒJavaæ˜¯å•ç»§æ‰¿æœºåˆ¶çš„ï¼Œæ‰€ä»¥ä½¿ç”¨æ­¤æ–¹æ³•ä¼šæœ‰å¾ˆå¤§çš„å±€é™æ€§ã€‚
package com.yuanxw.chapter1;/** * Javaä¸­åˆ›å»ºçº¿ç¨‹ä¸€ï¼šç»§æ‰¿Threadç±»é‡å†™runæ–¹æ³• */public class MyThread extends Thread &#123;    public static void main(String[] args) &#123;        MyThread myThread = new MyThread();        myThread.start();        System.out.println(String.format(&quot;çº¿ç¨‹ï¼šã€%sã€‘,è¿è¡Œç»“æŸ&quot;, currentThread().getName()));    &#125;    @Override    public void run() &#123;        for (int i = 0; i &lt; 20; i++) &#123;            try &#123;                System.out.println(String.format(&quot;çº¿ç¨‹ï¼šã€%sã€‘,æ‰“å°ï¼š%s&quot;, currentThread().getName(),i));                Thread.sleep(1000);            &#125; catch (InterruptedException e) &#123;                e.printStackTrace();            &#125;        &#125;        System.out.println(String.format(&quot;çº¿ç¨‹ï¼šã€%sã€‘,è¿è¡Œç»“æŸ&quot;, currentThread().getName()));    &#125;&#125;
2.2 å®ç°Runnableæ¥å£Threadç±»çš„æ„é€ æ–¹æ³•å…è®¸ä¼ å…¥ä¸€ä¸ªå®ç°Runnableæ¥å£çš„targetè¿›å»ï¼Œçº¿ç¨‹å¯åŠ¨å°†ä¼šæ‰§è¡Œtarget.runæ–¹æ³•ã€‚å®ç°Runnableæ¥å£çš„æ–¹å¼å¯ä»¥å¾ˆå¥½çš„é¿å…å•ç»§æ‰¿é—®é¢˜ã€‚
package com.yuanxw.chapter1;/** * Javaä¸­åˆ›å»ºçº¿ç¨‹äºŒï¼šå®ç°Runnableæ¥å£é‡å†™runæ–¹æ³• */public class MyRunnable implements Runnable&#123;    public static void main(String[] args) &#123;        MyRunnable myRunnable = new MyRunnable();        Thread thread = new Thread(myRunnable);        thread.start();        System.out.println(String.format(&quot;çº¿ç¨‹ï¼šã€%sã€‘,è¿è¡Œç»“æŸ&quot;, Thread.currentThread().getName()));    &#125;    @Override    public void run() &#123;        for (int i = 0; i &lt; 20; i++) &#123;            try &#123;                System.out.println(String.format(&quot;çº¿ç¨‹ï¼šã€%sã€‘,æ‰“å°ï¼š%s&quot;, Thread.currentThread().getName(),i));                Thread.sleep(1000);            &#125; catch (InterruptedException e) &#123;                e.printStackTrace();            &#125;        &#125;        System.out.println(String.format(&quot;çº¿ç¨‹ï¼šã€%sã€‘,è¿è¡Œç»“æŸ&quot;, Thread.currentThread().getName()));    &#125;&#125;
2.3 å®ç°Callableæ¥å£callæ–¹æ³•ä¸runæ–¹æ³•æœ€å¤§çš„åŒºåˆ«åœ¨äºcallæ–¹æ³•å­˜åœ¨è¿”å›å€¼futureTaskçš„getæ–¹æ³•å¯ä»¥è·å–è¿™ä¸ªè¿”å›å€¼ã€‚ä½¿ç”¨æ­¤ç§æ–¹æ³•å®ç°çº¿ç¨‹çš„å¥½å¤„æ˜¯å½“ä½ åˆ›å»ºçš„ä»»åŠ¡çš„ç»“æœä¸æ˜¯ç«‹å³å°±è¦æ—¶ï¼Œä½ å¯ä»¥æäº¤ä¸€ä¸ªçº¿ç¨‹åœ¨åå°æ‰§è¡Œï¼Œè€Œä½ çš„ç¨‹åºä»å¯ä»¥æ­£å¸¸è¿è¡Œä¸‹å»ï¼Œåœ¨éœ€è¦æ‰§è¡Œç»“æœæ—¶ä½¿ç”¨futureTaskå»è·å–å³å¯ã€‚è¿™æ˜¯ä¸€ç§å…¸å‹çš„å¼‚æ­¥ä»»åŠ¡å¤„ç†çš„æ–¹æ³•ã€‚
package com.yuanxw.chapter1;import java.util.concurrent.Callable;import java.util.concurrent.ExecutionException;import java.util.concurrent.FutureTask;import java.util.concurrent.TimeoutException;public class MyCallable implements Callable &#123;    public static void main(String[] args) throws InterruptedException, ExecutionException, TimeoutException &#123;        FutureTask futureTask1 = new FutureTask(new MyCallable());        new Thread(futureTask1,&quot;å­çº¿ç¨‹-A&quot;).start();        FutureTask futureTask2 = new FutureTask(new MyCallable());        new Thread(futureTask2,&quot;å­çº¿ç¨‹-B&quot;).start();        // futureTaskå¯ä»¥åœ¨æŒ‡å®šæ—¶é—´å†…è·å–çº¿ç¨‹æ‰§è¡Œçš„è¿”å›å€¼ï¼Œè¶…æ—¶åˆ™ä¸¢å¼ƒä»»åŠ¡        //  å› æ­¤futureTaskå¯ä»¥ç”¨ä½œå¼‚æ­¥ä»»åŠ¡å¤„ç†        // futureTask.get(1000, TimeUnit.SECONDS);        System.out.println(String.format(&quot;çº¿ç¨‹ï¼šã€%sã€‘,è¿è¡Œç»“æŸ&quot;, Thread.currentThread().getName()));    &#125;    @Override    public Object call() throws Exception &#123;        int sum = 0;        for (int i = 0; i &lt; 50; i++) &#123;            try &#123;                System.out.println(String.format(&quot;çº¿ç¨‹ï¼šã€%sã€‘,æ‰“å°ï¼š%s&quot;, Thread.currentThread().getName(),i));                Thread.sleep(100);            &#125; catch (InterruptedException e) &#123;                e.printStackTrace();            &#125;            sum += i;        &#125;        System.out.println(String.format(&quot;çº¿ç¨‹ï¼šã€%sã€‘,è¿è¡Œç»“æŸ&quot;, Thread.currentThread().getName()));        System.out.println(&quot;æ‰§è¡Œç»“æœï¼š&quot; + sum);        return sum;    &#125;&#125;

3. çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå’ŒçŠ¶æ€Java çº¿ç¨‹åœ¨è¿è¡Œçš„ç”Ÿå‘½å‘¨æœŸä¸­çš„æŒ‡å®šæ—¶åˆ»åªå¯èƒ½å¤„äºä¸‹é¢ 6 ç§ä¸åŒçŠ¶æ€çš„å…¶ä¸­ä¸€ä¸ªçŠ¶æ€ï¼ˆå›¾æºã€ŠJava å¹¶å‘ç¼–ç¨‹è‰ºæœ¯ã€‹4.1.4 èŠ‚ï¼‰ã€‚çº¿ç¨‹åœ¨ç”Ÿå‘½å‘¨æœŸä¸­å¹¶ä¸æ˜¯å›ºå®šå¤„äºæŸä¸€ä¸ªçŠ¶æ€è€Œæ˜¯éšç€ä»£ç çš„æ‰§è¡Œåœ¨ä¸åŒçŠ¶æ€ä¹‹é—´åˆ‡æ¢ã€‚Java çº¿ç¨‹çŠ¶æ€å˜è¿å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆå›¾æºã€ŠJava å¹¶å‘ç¼–ç¨‹è‰ºæœ¯ã€‹4.1.4 èŠ‚ï¼‰ï¼šç”±ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼šçº¿ç¨‹åˆ›å»ºä¹‹åå®ƒå°†å¤„äº NEWï¼ˆæ–°å»ºï¼‰ çŠ¶æ€ï¼Œè°ƒç”¨ start() æ–¹æ³•åå¼€å§‹è¿è¡Œï¼Œçº¿ç¨‹è¿™æ—¶å€™å¤„äº READYï¼ˆå¯è¿è¡Œï¼‰ çŠ¶æ€ã€‚å¯è¿è¡ŒçŠ¶æ€çš„çº¿ç¨‹è·å¾—äº† CPU æ—¶é—´ç‰‡ï¼ˆtimesliceï¼‰åå°±å¤„äº RUNNINGï¼ˆè¿è¡Œï¼‰ çŠ¶æ€ã€‚å½“çº¿ç¨‹æ‰§è¡Œ wait()æ–¹æ³•ä¹‹åï¼Œçº¿ç¨‹è¿›å…¥ WAITINGï¼ˆç­‰å¾…ï¼‰ çŠ¶æ€ã€‚è¿›å…¥ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹éœ€è¦ä¾é å…¶ä»–çº¿ç¨‹çš„é€šçŸ¥æ‰èƒ½å¤Ÿè¿”å›åˆ°è¿è¡ŒçŠ¶æ€ï¼Œè€Œ TIME_WAITING(è¶…æ—¶ç­‰å¾…) çŠ¶æ€ç›¸å½“äºåœ¨ç­‰å¾…çŠ¶æ€çš„åŸºç¡€ä¸Šå¢åŠ äº†è¶…æ—¶é™åˆ¶ï¼Œæ¯”å¦‚é€šè¿‡ sleepï¼ˆlong millisï¼‰æ–¹æ³•æˆ– waitï¼ˆlong millisï¼‰æ–¹æ³•å¯ä»¥å°† Java çº¿ç¨‹ç½®äº TIMED WAITING çŠ¶æ€ã€‚å½“è¶…æ—¶æ—¶é—´åˆ°è¾¾å Java çº¿ç¨‹å°†ä¼šè¿”å›åˆ° RUNNABLE çŠ¶æ€ã€‚å½“çº¿ç¨‹è°ƒç”¨åŒæ­¥æ–¹æ³•æ—¶ï¼Œåœ¨æ²¡æœ‰è·å–åˆ°é”çš„æƒ…å†µä¸‹ï¼Œçº¿ç¨‹å°†ä¼šè¿›å…¥åˆ° BLOCKEDï¼ˆé˜»å¡ï¼‰ çŠ¶æ€ã€‚çº¿ç¨‹åœ¨æ‰§è¡Œ Runnable çš„run()æ–¹æ³•ä¹‹åå°†ä¼šè¿›å…¥åˆ° TERMINATEDï¼ˆç»ˆæ­¢ï¼‰ çŠ¶æ€ã€‚
å­¦ä¹ æ¨èä¹¦ç±ï¼š [1]: ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®è·µ ã€‹ [2]: ã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ ã€‹ [3]: ã€ŠJavaé«˜å¹¶å‘ç¼–ç¨‹è¯¦è§£ï¼šå¤šçº¿ç¨‹ä¸æ¶æ„è®¾è®¡ ã€‹ [4]: ã€ŠJavaå¤šçº¿ç¨‹ç¼–ç¨‹æ ¸å¿ƒæŠ€æœ¯ï¼ˆç¬¬2ç‰ˆï¼‰ ã€‹
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(ä¸ƒ)Javaå¤šçº¿ç¨‹ä¹‹synchronized(åŒæ­¥é”)</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E4%B8%83)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8Bsynchronized(%E5%90%8C%E6%AD%A5%E9%94%81)/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(ä¸ƒ)Javaå¤šçº¿ç¨‹ä¹‹synchronized(åŒæ­¥é”)1.1 synchronized(åŒæ­¥é”)&emsp;&emsp;synchronizedå…³é”®å­—è§£å†³çš„æ˜¯å¤šä¸ªçº¿ç¨‹ä¹‹é—´è®¿é—®èµ„æºçš„åŒæ­¥æ€§ï¼Œsynchronizedå…³é”®å­—å¯ä»¥ä¿è¯è¢«å®ƒä¿®é¥°çš„æ–¹æ³•æˆ–è€…ä»£ç å—åœ¨ä»»æ„æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚
å¦å¤–ï¼Œåœ¨ Java æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œsynchronizedå±äºé‡é‡çº§é”ï¼Œæ•ˆç‡ä½ä¸‹ï¼Œå› ä¸ºç›‘è§†å™¨é”ï¼ˆmonitorï¼‰æ˜¯ä¾èµ–äºåº•å±‚çš„æ“ä½œç³»ç»Ÿçš„ Mutex Lock æ¥å®ç°çš„ï¼ŒJava çš„çº¿ç¨‹æ˜¯æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿçš„åŸç”Ÿçº¿ç¨‹ä¹‹ä¸Šçš„ã€‚å¦‚æœè¦æŒ‚èµ·æˆ–è€…å”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œéƒ½éœ€è¦æ“ä½œç³»ç»Ÿå¸®å¿™å®Œæˆï¼Œè€Œæ“ä½œç³»ç»Ÿå®ç°çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢æ—¶éœ€è¦ä»ç”¨æˆ·æ€è½¬æ¢åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¹‹é—´çš„è½¬æ¢éœ€è¦ç›¸å¯¹æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œæ—¶é—´æˆæœ¬ç›¸å¯¹è¾ƒé«˜ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ—©æœŸçš„ synchronized æ•ˆç‡ä½çš„åŸå› ã€‚åº†å¹¸çš„æ˜¯åœ¨ Java 6 ä¹‹å Java å®˜æ–¹å¯¹ä» JVM å±‚é¢å¯¹synchronized è¾ƒå¤§ä¼˜åŒ–ï¼Œæ‰€ä»¥ç°åœ¨çš„ synchronized é”æ•ˆç‡ä¹Ÿä¼˜åŒ–å¾—å¾ˆä¸é”™äº†ã€‚JDK1.6å¯¹é”çš„å®ç°å¼•å…¥äº†å¤§é‡çš„ä¼˜åŒ–ï¼Œå¦‚è‡ªæ—‹é”ã€é€‚åº”æ€§è‡ªæ—‹é”ã€é”æ¶ˆé™¤ã€é”ç²—åŒ–ã€åå‘é”ã€è½»é‡çº§é”ç­‰æŠ€æœ¯æ¥å‡å°‘é”æ“ä½œçš„å¼€é”€ã€‚
synchronized å…³é”®å­—æœ€ä¸»è¦çš„ä¸‰ç§ä½¿ç”¨æ–¹å¼ï¼š

ä¿®é¥°å®ä¾‹æ–¹æ³•: ä½œç”¨äºå½“å‰å¯¹è±¡å®ä¾‹åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾—å½“å‰å¯¹è±¡å®ä¾‹çš„é”
ä¿®é¥°é™æ€æ–¹æ³•: ä¹Ÿå°±æ˜¯ç»™å½“å‰ç±»åŠ é”ï¼Œä¼šä½œç”¨äºç±»çš„æ‰€æœ‰å¯¹è±¡å®ä¾‹ï¼Œå› ä¸ºé™æ€æˆå‘˜ä¸å±äºä»»ä½•ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œæ˜¯ç±»æˆå‘˜ï¼ˆ static è¡¨æ˜è¿™æ˜¯è¯¥ç±»çš„ä¸€ä¸ªé™æ€èµ„æºï¼Œä¸ç®¡newäº†å¤šå°‘ä¸ªå¯¹è±¡ï¼Œåªæœ‰ä¸€ä»½ï¼‰ã€‚æ‰€ä»¥å¦‚æœä¸€ä¸ªçº¿ç¨‹Aè°ƒç”¨ä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„éé™æ€ synchronized æ–¹æ³•ï¼Œè€Œçº¿ç¨‹Béœ€è¦è°ƒç”¨è¿™ä¸ªå®ä¾‹å¯¹è±¡æ‰€å±ç±»çš„é™æ€ synchronized æ–¹æ³•ï¼Œæ˜¯å…è®¸çš„ï¼Œä¸ä¼šå‘ç”Ÿäº’æ–¥ç°è±¡ï¼Œå› ä¸ºè®¿é—®é™æ€ synchronized æ–¹æ³•å ç”¨çš„é”æ˜¯å½“å‰ç±»çš„é”ï¼Œè€Œè®¿é—®éé™æ€ synchronized æ–¹æ³•å ç”¨çš„é”æ˜¯å½“å‰å®ä¾‹å¯¹è±¡é”ã€‚ ä¿®é¥°ä»£ç å—: æŒ‡å®šåŠ é”å¯¹è±¡ï¼Œå¯¹ç»™å®šå¯¹è±¡åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç åº“å‰è¦è·å¾—ç»™å®šå¯¹è±¡çš„é”ã€‚

æ€»ç»“ ï¼š synchronized å…³é”®å­—åŠ åˆ° static é™æ€æ–¹æ³•å’Œ synchronized(class)ä»£ç å—ä¸Šéƒ½æ˜¯æ˜¯ç»™ Class ç±»ä¸Šé”ã€‚synchronized å…³é”®å­—åŠ åˆ°å®ä¾‹æ–¹æ³•ä¸Šæ˜¯ç»™å¯¹è±¡å®ä¾‹ä¸Šé”ã€‚å°½é‡ä¸è¦ä½¿ç”¨ synchronized(String a) å› ä¸ºJVMä¸­ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± å…·æœ‰ç¼“å­˜åŠŸèƒ½ï¼
1.1.1.æ¨¡æ‹Ÿå¤šçº¿ç¨‹ä¸‹å•å‡åº“å­˜ï¼Œåœ¨ä¸é”çš„æƒ…å†µçš„ç»“æœä¸€ä¸ªæŠ¢è´­æ´»åŠ¨æŸä¸ªå•†å“çš„æ€»æ•°æ˜¯ä¸€ä¸ªå¸¸æ•°ï¼Œè´­ä¹°è€…å¯ä»¥æœ‰å¤šä¸ªï¼Œæ¯ä¸ªè´­ä¹°æ“ä½œéƒ½ä¼šä½¿æ€»æ•°å‡å°‘ã€‚æˆ‘ä»¬ç«Ÿç„¶å‘ç°äº† ä½™ç¥¨ä¸º-1 -2çš„æƒ…å†µï¼Œè¿™å°±ä¸å®é™…ä¸ç¬¦ã€‚åŸå› åœ¨äº å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡ŒåŒä¸€æ®µä»£ç ï¼Œå¯¼è‡´å˜é‡é”™è¯¯ã€‚
package com.yuanxw.chapter7;/** * å¤šçº¿ç¨‹å¤„ç†è®¢å• */public class ThreadOrder &#123;    public static void main(String[] args) &#123;        OrderPayService orderPayService = new OrderPayService();        new Thread(orderPayService).start();        new Thread(orderPayService).start();        new Thread(orderPayService).start();        new Thread(orderPayService).start();    &#125;&#125;class OrderPayService implements Runnable &#123;    /** æœ€å¤§åº“å­˜ **/    private  int maxQuantityNum = 10;    @Override    public void run() &#123;        while (maxQuantityNum &gt;0)&#123;            try &#123;                Thread.sleep(3);            &#125; catch (InterruptedException e) &#123;                e.printStackTrace();            &#125;            System.out.println(String.format(&quot;æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€%sã€‘ä¸ªå•†å“&quot;, maxQuantityNum--));        &#125;    &#125;&#125;
æ‰§è¡Œç»“æœ
æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€9ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€8ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€7ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€10ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€6ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€6ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€4ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€5ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€3ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€3ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€2ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€1ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€-1ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€0ã€‘ä¸ªå•†å“
æˆ‘ä»¬åº”å¯¹è¿™æ®µä»£ç è¿›è¡ŒåŠ é”æ§åˆ¶
package com.yuanxw.chapter7;/** * å¤šçº¿ç¨‹å¤„ç†è®¢å• */public class ThreadOrderSynchronized &#123;    public static void main(String[] args) &#123;        OrderPaymentService orderPaymentService = new OrderPaymentService();        new Thread(orderPaymentService).start();        new Thread(orderPaymentService).start();        new Thread(orderPaymentService).start();        new Thread(orderPaymentService).start();    &#125;&#125;class OrderPaymentService implements Runnable &#123;    /** æœ€å¤§åº“å­˜ **/    private  int maxQuantityNum = 10;    /** ç›‘æ§ **/    private final Object MONITOR = new Object();    @Override    public void run() &#123;        // synchronized å…³é”®å­—åŠ åˆ°å®ä¾‹æ–¹æ³•ä¸Šæ˜¯ç»™å¯¹è±¡å®ä¾‹ä¸Šé”        synchronized (MONITOR) &#123;            while (maxQuantityNum &gt; 0) &#123;                try &#123;                    Thread.sleep(3);                &#125; catch (InterruptedException e) &#123;                    e.printStackTrace();                &#125;                System.out.println(String.format(&quot;æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€%sã€‘ä¸ªå•†å“&quot;, maxQuantityNum--));            &#125;        &#125;    &#125;&#125;
æ‰§è¡Œç»“æœ
æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€10ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€9ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€8ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€7ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€6ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€5ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€4ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€3ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€2ã€‘ä¸ªå•†å“æ‚¨æŠ¢è´­å•†å“ï¼Œåº“å­˜åªå‰©ä¸‹ã€1ã€‘ä¸ªå•†å“

é€šè¿‡ JDK è‡ªå¸¦çš„ javap å‘½ä»¤æŸ¥çœ‹ OrderPaymentService.class ç±»çš„ç›¸å…³å­—èŠ‚ç ä¿¡æ¯ï¼šé¦–å…ˆåˆ‡æ¢åˆ°ç±»çš„å¯¹åº”ç›®å½•æ‰§è¡Œ javac OrderPaymentService.java å‘½ä»¤ç”Ÿæˆç¼–è¯‘åçš„ OrderPaymentService.class æ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œjavap -c -s -v -l OrderPaymentService.classä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼š
synchronized åŒæ­¥è¯­å¥å—çš„å®ç°ä½¿ç”¨çš„æ˜¯ monitorenter å’Œ monitorexit æŒ‡ä»¤ï¼Œå…¶ä¸­ monitorenter æŒ‡ä»¤æŒ‡å‘åŒæ­¥ä»£ç å—çš„å¼€å§‹ä½ç½®ï¼Œmonitorexit æŒ‡ä»¤åˆ™æŒ‡æ˜åŒæ­¥ä»£ç å—çš„ç»“æŸä½ç½®ã€‚ å½“æ‰§è¡Œ monitorenter æŒ‡ä»¤æ—¶ï¼Œçº¿ç¨‹è¯•å›¾è·å–é”ä¹Ÿå°±æ˜¯è·å– monitor(monitorå¯¹è±¡å­˜åœ¨äºæ¯ä¸ªJavaå¯¹è±¡çš„å¯¹è±¡å¤´ä¸­ï¼Œsynchronized é”ä¾¿æ˜¯é€šè¿‡è¿™ç§æ–¹å¼è·å–é”çš„ï¼Œä¹Ÿæ˜¯ä¸ºä»€ä¹ˆJavaä¸­ä»»æ„å¯¹è±¡å¯ä»¥ä½œä¸ºé”çš„åŸå› ) çš„æŒæœ‰æƒã€‚å½“è®¡æ•°å™¨ä¸º0åˆ™å¯ä»¥æˆåŠŸè·å–ï¼Œè·å–åå°†é”è®¡æ•°å™¨è®¾ä¸º1ä¹Ÿå°±æ˜¯åŠ 1ã€‚ç›¸åº”çš„åœ¨æ‰§è¡Œ monitorexit æŒ‡ä»¤åï¼Œå°†é”è®¡æ•°å™¨è®¾ä¸º0ï¼Œè¡¨æ˜é”è¢«é‡Šæ”¾ã€‚å¦‚æœè·å–å¯¹è±¡é”å¤±è´¥ï¼Œé‚£å½“å‰çº¿ç¨‹å°±è¦é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°é”è¢«å¦å¤–ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾ä¸ºæ­¢ã€‚
1.2 å•ä¾‹æ¨¡å¼(ä¸€)ï¼šã€åŒé‡æ ¡éªŒé”å®ç°å¯¹è±¡å•ä¾‹ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰ã€‘åŒé‡æ£€éªŒé”æ–¹å¼å®ç°å•ä¾‹æ¨¡å¼çš„åŸç†ï¼šéœ€è¦æ³¨æ„ uniqueInstance é‡‡ç”¨ volatile å…³é”®å­—ä¿®é¥°ä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦ã€‚
package com.yuanxw.chapter7;/** * å•ä¾‹æ¨¡å¼ï¼šä¸€ */public class Singleton &#123;    // å†…å­˜å¯è§æ€§    private volatile static Singleton uniqueInstance;    private Singleton() &#123;    &#125;    public static Singleton getUniqueInstance() &#123;        //å…ˆåˆ¤æ–­å¯¹è±¡æ˜¯å¦å·²ç»å®ä¾‹è¿‡ï¼Œæ²¡æœ‰å®ä¾‹åŒ–è¿‡æ‰è¿›å…¥åŠ é”ä»£ç         if (uniqueInstance == null) &#123;            //ç±»å¯¹è±¡åŠ é”            synchronized (Singleton.class) &#123;                if (uniqueInstance == null) &#123;                    uniqueInstance = new Singleton();                &#125;            &#125;        &#125;        return uniqueInstance;    &#125;&#125;

uniqueInstance é‡‡ç”¨ volatile å…³é”®å­—ä¿®é¥°ä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œ uniqueInstance &#x3D; new Singleton(); è¿™æ®µä»£ç å…¶å®æ˜¯åˆ†ä¸ºä¸‰æ­¥æ‰§è¡Œï¼š
ä¸º uniqueInstance åˆ†é…å†…å­˜ç©ºé—´
åˆå§‹åŒ– uniqueInstance
å°† uniqueInstance æŒ‡å‘åˆ†é…çš„å†…å­˜åœ°å€

ä½†æ˜¯ç”±äº JVM å…·æœ‰æŒ‡ä»¤é‡æ’çš„ç‰¹æ€§ï¼Œæ‰§è¡Œé¡ºåºæœ‰å¯èƒ½å˜æˆ 1-&gt;3-&gt;2ã€‚æŒ‡ä»¤é‡æ’åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹ä¸ä¼šå‡ºç°é—®é¢˜ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¼šå¯¼è‡´ä¸€ä¸ªçº¿ç¨‹è·å¾—è¿˜æ²¡æœ‰åˆå§‹åŒ–çš„å®ä¾‹ã€‚ä¾‹å¦‚ï¼Œçº¿ç¨‹ T1 æ‰§è¡Œäº† 1 å’Œ 3ï¼Œæ­¤æ—¶ T2 è°ƒç”¨ getUniqueInstance() åå‘ç° uniqueInstance ä¸ä¸ºç©ºï¼Œå› æ­¤è¿”å› uniqueInstanceï¼Œä½†æ­¤æ—¶ uniqueInstance è¿˜æœªè¢«åˆå§‹åŒ–ã€‚
ä½¿ç”¨ volatile å¯ä»¥ç¦æ­¢ JVM çš„æŒ‡ä»¤é‡æ’ï¼Œä¿è¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œã€‚
1.3 å•ä¾‹æ¨¡å¼(äºŒ)å•ä¾‹æ¨¡å¼(äºŒ)ï¼šJVMç±»åœ¨åŠ è½½çš„æ—¶å€™ï¼Œåªä¼šè¿è¡Œä¸€æ¬¡ï¼Œé™æ€ç±»å¯ä»¥ä¸¥æ ¼çš„ä¿è¯çº¿ç¨‹æ‰§è¡Œé¡ºåº 
package com.yuanxw.chapter7;/** * å•ä¾‹æ¨¡å¼ï¼šäºŒ */public class SingletonHolder &#123;    private SingletonHolder()&#123;    &#125;    /** JVMç±»åœ¨åŠ è½½çš„æ—¶å€™ï¼Œåªä¼šè¿è¡Œä¸€æ¬¡ï¼Œé™æ€ç±»å¯ä»¥ä¸¥æ ¼çš„ä¿è¯çº¿ç¨‹æ‰§è¡Œé¡ºåº **/    private static class InstanceHolder&#123;        private final static SingletonHolder instance = new SingletonHolder();    &#125;    public static SingletonHolder getInstance()&#123;        // åªæœ‰ä½¿ç”¨æ—¶æ‰ä¼šåŠ è½½ã€‚        return  SingletonHolder.getInstance();    &#125;&#125;
1.4 å•ä¾‹æ¨¡å¼(ä¸‰)é€šè¿‡æšä¸¾çš„æ–¹å¼ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨ã€‚æšä¸¾æ„é€ å‡½æ•°åªä¼šè¢«è£…è½½ä¸€æ¬¡ï¼Œå› æ­¤å¯ä»¥ä¿è¯å¯¹è±¡åªä¼šè¢«åˆ›å»ºä¸€æ¬¡ã€‚
package com.yuanxw.chapter7;/** * å•ä¾‹æ¨¡å¼ï¼šä¸‰ * æ¨èä½¿ç”¨ */public class SingtonEnum &#123;    private SingtonEnum()&#123;    &#125;    /**     * é€šè¿‡æšä¸¾çš„æ–¹å¼ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨     */    private enum Sington &#123;        INSTANCE;        private final SingtonEnum instance;        Sington() &#123;            // åªä¼šè¢«åˆ›å»ºä¸€æ¬¡            instance = new SingtonEnum();        &#125;        public SingtonEnum getInstance() &#123;            return instance;        &#125;    &#125;    /**     * è·å¾—å•ä¾‹     * @return     */    public static SingtonEnum getInstance()&#123;        return Sington.INSTANCE.getInstance();    &#125;&#125;


 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(ä¸ƒ)Javaå¤šçº¿ç¨‹ä¹‹synchronized(åŒæ­¥é”)ã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(ä¸‰)Javaå¤šçº¿ç¨‹ä¹‹å®ˆæŠ¤çº¿ç¨‹</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E4%B8%89)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8B%E5%AE%88%E6%8A%A4%E7%BA%BF%E7%A8%8B/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(ä¸‰)Javaå¤šçº¿ç¨‹ä¹‹å®ˆæŠ¤çº¿ç¨‹1.1 daemon(å®ˆæŠ¤çº¿ç¨‹)&emsp;&emsp;Javaä¸­æœ‰ä¸¤ç±»çº¿ç¨‹ï¼šUser Thread(ç”¨æˆ·çº¿ç¨‹)ã€Daemon Thread(å®ˆæŠ¤çº¿ç¨‹)ã€‚ç”¨æˆ·çº¿ç¨‹å³è¿è¡Œåœ¨å‰å°çš„çº¿ç¨‹ï¼Œè€Œå®ˆæŠ¤çº¿ç¨‹æ˜¯è¿è¡Œåœ¨åå°çš„çº¿ç¨‹ã€‚

&emsp;&emsp; ç”¨æˆ·çº¿ç¨‹ï¼šè¿è¡Œåœ¨å‰å°ï¼Œæ‰§è¡Œå…·ä½“çš„ä»»åŠ¡ï¼Œç¨‹åºçš„ä¸»çº¿ç¨‹ï¼Œè¿æ¥ç½‘ç»œçš„å­çº¿ç¨‹ç­‰éƒ½æ˜¯ç”¨æˆ·çº¿ç¨‹ã€‚

&emsp;&emsp; å®ˆæŠ¤çº¿ç¨‹ï¼šè¿è¡Œåœ¨åå°ï¼Œä¸ºå…¶ä»–å‰å°çº¿ç¨‹æœåŠ¡ã€‚

ç‰¹ç‚¹ï¼šå½“æ‰€æœ‰éå®ˆæŠ¤çº¿ç¨‹ç»“æŸæ—¶ï¼Œç¨‹åºä¹Ÿå°±ç»ˆæ­¢ï¼ŒåŒæ—¶ä¼šæ€æ­»æ‰€æœ‰å®ˆæŠ¤çº¿ç¨‹ã€‚
åº”ç”¨ï¼šæ•°æ®åº“è¿æ¥æ± ä¸­çš„ç›‘æµ‹çº¿ç¨‹JVMå¯åŠ¨åçš„ç›‘æµ‹çº¿ç¨‹
æœ€å¸¸è§çš„å®ˆæŠ¤çº¿ç¨‹ï¼šåƒåœ¾å›æ”¶çº¿ç¨‹
å¦‚ä½•è®¾ç½®å®ˆæŠ¤çº¿ç¨‹ï¼šå¯ä»¥é€šè¿‡Threadç±»çš„setDaemonï¼ˆtrueï¼‰æ–¹æ³•æ¥è®¾ç½®å½“å‰çš„çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹



package com.yuanxw.chapter3;/** * å®ˆæŠ¤çº¿ç¨‹ */public class DaemonThread &#123;    public static void main(String[] args) &#123;        Thread thread = new Thread()&#123;            @Override            public void run() &#123;                while (true)&#123;                    try &#123;                        sleep(500L);                    &#125; catch (InterruptedException e) &#123;                        e.printStackTrace();                    &#125;                    System.out.println(&quot;connecting to network ...&quot;);                &#125;            &#125;        &#125;;        /**         * è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼Œå¿…é¡»çš„è°ƒç”¨start()æ–¹æ³•ä¹‹å‰è®¾ç½®ã€‚         * åœ¨start()æ–¹æ³•ä¹‹åè®¾ç½®ï¼šException in thread &quot;main&quot; java.lang.IllegalThreadStateException         */        thread.setDaemon(true);        thread.start();    &#125;&#125;

 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(ä¸‰)Javaå¤šçº¿ç¨‹ä¹‹å®ˆæŠ¤çº¿ç¨‹ã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(ä¹)Javaå¤šçº¿ç¨‹ä¹‹ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E4%B9%9D)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8B%E7%94%9F%E4%BA%A7%E8%80%85%E4%B8%8E%E6%B6%88%E8%B4%B9%E8%80%85/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(ä¹)Javaå¤šçº¿ç¨‹ä¹‹ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…
éœ€æ±‚å¦‚ä¸‹ï¼šè‡ªå®šä¹‰å¤šçº¿ç¨‹ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…
1.å¦‚æœç”Ÿäº§è€…æ²¡æœ‰ç”Ÿäº§æ¶ˆæ¯ï¼Œå°±éœ€è¦å»ç”Ÿäº§æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…å°±éœ€è¦ç­‰å¾…æ¶ˆè´¹è€…ç”Ÿäº§å®Œä»¥åå†å»æ¶ˆè´¹ã€‚
2.å¦‚æœæ¶ˆè´¹è€…æ²¡æœ‰æ¶ˆè´¹æ¶ˆæ¯ï¼Œé‚£ä¹ˆç”Ÿäº§è€…å°±éœ€è¦ç­‰å¾…ï¼Œæ¶ˆè´¹éƒ½æ¶ˆè´¹å®Œæˆåï¼Œå†å»ç”Ÿäº§æ¶ˆæ¯ã€‚

1.1 ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ã€ä¸€ä¸ªç”Ÿäº§çº¿ç¨‹å’Œä¸€ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ã€‘package com.yuanxw.chapter9;/** * è‡ªå®šä¹‰å¤šçº¿ç¨‹ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€… * 1.å¦‚æœç”Ÿäº§è€…æ²¡æœ‰ç”Ÿäº§æ¶ˆæ¯ï¼Œå°±éœ€è¦å»ç”Ÿäº§æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…å°±éœ€è¦ç­‰å¾…æ¶ˆè´¹è€…ç”Ÿäº§å®Œä»¥åå†å»æ¶ˆè´¹ã€‚ * 2.å¦‚æœæ¶ˆè´¹è€…æ²¡æœ‰æ¶ˆè´¹æ¶ˆæ¯ï¼Œé‚£ä¹ˆç”Ÿäº§è€…å°±éœ€è¦ç­‰å¾…ï¼Œæ¶ˆè´¹éƒ½æ¶ˆè´¹å®Œæˆåï¼Œå†å»ç”Ÿäº§æ¶ˆæ¯ã€‚ */public class ProduceConsumer &#123;    /** ç”Ÿäº§æ•°é‡ **/    private int num = 0;    /** é” **/    protected final Object LOCK = new Object();    /** volatile:å†…å­˜å¯è§æ€§å…³é”®å­—ï¼Œé»˜è®¤ä¸ºæ²¡æœ‰ç”Ÿäº§ï¼Œå¯ä»¥è¿›è¡Œç”Ÿäº§ **/    private volatile boolean isProducted = false;    /**     * ç”Ÿäº§æ–¹æ³•     * @return     */    public void produce() throws InterruptedException &#123;        // åŒæ­¥ç”Ÿäº§        synchronized (LOCK)&#123;            // å¦‚æœæ¶ˆæ¯å·²ç»ç”Ÿäº§ï¼Œéœ€è¦ç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹åå†å»ç”Ÿäº§            if(isProducted)&#123;                /**                 * è°ƒç”¨ wait() ä½¿å¾—çº¿ç¨‹ç­‰å¾…æŸä¸ªæ¡ä»¶æ»¡è¶³ï¼Œçº¿ç¨‹åœ¨ç­‰å¾…æ—¶ä¼šè¢«æŒ‚èµ·ï¼Œå½“å…¶ä»–çº¿ç¨‹çš„è¿è¡Œä½¿å¾—è¿™ä¸ªæ¡ä»¶æ»¡è¶³æ—¶ï¼Œå…¶å®ƒçº¿ç¨‹ä¼šè°ƒç”¨ notify() æˆ–è€… notifyAll() æ¥å”¤é†’æŒ‚èµ·çš„çº¿ç¨‹ã€‚                 * å®ƒä»¬éƒ½å±äº Object çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸å±äº Threadã€‚                 */                LOCK.wait();            &#125;else &#123;                // å¦‚æœå·²ç»æ¶ˆè´¹ï¼Œé‚£ä¹ˆå°±éœ€è¦è¿›è¡Œç”Ÿäº§                num++;                System.out.println(String.format(&quot;ç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€%sã€‘&quot;, num));                /**                 * è°ƒç”¨ wait() ä½¿å¾—çº¿ç¨‹ç­‰å¾…æŸä¸ªæ¡ä»¶æ»¡è¶³ï¼Œçº¿ç¨‹åœ¨ç­‰å¾…æ—¶ä¼šè¢«æŒ‚èµ·ï¼Œå½“å…¶ä»–çº¿ç¨‹çš„è¿è¡Œä½¿å¾—è¿™ä¸ªæ¡ä»¶æ»¡è¶³æ—¶ï¼Œå…¶å®ƒçº¿ç¨‹ä¼šè°ƒç”¨ notify() æˆ–è€… notifyAll() æ¥å”¤é†’æŒ‚èµ·çš„çº¿ç¨‹ã€‚                 * å®ƒä»¬éƒ½å±äº Object çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸å±äº Threadã€‚                 */                // é€šçŸ¥æ¶ˆè´¹è€…ï¼Œå¯ä»¥è¿›è¡Œæ¶ˆè´¹                LOCK.notify();                // è®¾ç½®æ ‡è®°ï¼šå·²ç»ç”Ÿäº§                isProducted = true;            &#125;        &#125;    &#125;    /**     * æ¶ˆè´¹æ–¹æ³•     */    public void consumer() throws InterruptedException &#123;        // åŒæ­¥æ¶ˆè´¹        synchronized (LOCK)&#123;            // å¦‚æœå·²ç»ç”Ÿäº§ï¼Œé‚£ä¹ˆæ¶ˆè´¹è€…æ¶ˆè´¹            if(isProducted)&#123;                System.out.println(String.format(&quot;æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;ã€%sã€‘&quot;, num));                // é€šçŸ¥ç”Ÿäº§è€…å·²ç»æ¶ˆè´¹                LOCK.notify();                // è®¾ç½®æ ‡è®°ï¼šæœªç”Ÿäº§                isProducted = false;            &#125;else &#123;                // å¦‚æœå·²ç»æ²¡æœ‰ç”Ÿäº§ï¼Œå³éœ€è¦æ¶ˆæ¯è´¹è¿›è¡Œç­‰å¾…ç”Ÿäº§è€…è¿›è¡Œç”Ÿäº§                LOCK.wait();            &#125;        &#125;    &#125;    public static void main(String[] args) &#123;        ProduceConsumer produceConsumer = new ProduceConsumer();        // ç”Ÿäº§è€…ï¼šç”Ÿäº§çº¿ç¨‹        new Thread(()-&gt;&#123;            try &#123;                while (true) &#123;                    produceConsumer.produce();                &#125;            &#125; catch (InterruptedException e) &#123;                e.printStackTrace();            &#125;        &#125;).start();        // æ¶ˆè´¹è€…ï¼šæ¶ˆè´¹çº¿ç¨‹        new Thread(()-&gt;&#123;            try &#123;                while (true) &#123;                    produceConsumer.consumer();                &#125;            &#125; catch (InterruptedException e) &#123;                e.printStackTrace();            &#125;        &#125;).start();    &#125;&#125;

æ‰§è¡Œç»“æœï¼š
ç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€1ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;ã€1ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€2ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;ã€2ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€3ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;ã€3ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€4ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;ã€4ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€5ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;ã€5ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€6ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;ã€6ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€7ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;ã€7ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€8ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;ã€8ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€9ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;ã€9ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€10ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;ã€10ã€‘

1.2 ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ã€å¤šä¸ªç”Ÿäº§çº¿ç¨‹å’Œå¤šä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ã€‘package com.yuanxw.chapter9;import java.util.Arrays;/** * è‡ªå®šä¹‰å¤šçº¿ç¨‹ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ã€å¤šç”Ÿç”¢è€…å¤šæ¶ˆè²»è€…ã€‘ * 1.å¦‚æœç”Ÿäº§è€…æ²¡æœ‰ç”Ÿäº§æ¶ˆæ¯ï¼Œå°±éœ€è¦å»ç”Ÿäº§æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…å°±éœ€è¦ç­‰å¾…æ¶ˆè´¹è€…ç”Ÿäº§å®Œä»¥åå†å»æ¶ˆè´¹ã€‚ * 2.å¦‚æœæ¶ˆè´¹è€…æ²¡æœ‰æ¶ˆè´¹æ¶ˆæ¯ï¼Œé‚£ä¹ˆç”Ÿäº§è€…å°±éœ€è¦ç­‰å¾…ï¼Œæ¶ˆè´¹éƒ½æ¶ˆè´¹å®Œæˆåï¼Œå†å»ç”Ÿäº§æ¶ˆæ¯ã€‚ */public class MultiProduceConsumer &#123;    /** ç”Ÿäº§æ•°é‡ **/    private int num = 0;    /** é” **/    protected final Object LOCK = new Object();    /** volatile:å†…å­˜å¯è§æ€§å…³é”®å­—ï¼Œé»˜è®¤ä¸ºæ²¡æœ‰ç”Ÿäº§ï¼Œå¯ä»¥è¿›è¡Œç”Ÿäº§ **/    private volatile boolean isProducted = false;    /**     * ç”Ÿäº§æ–¹æ³•     * @return     */    public void produce() throws InterruptedException &#123;        // åŒæ­¥ç”Ÿäº§        synchronized (LOCK)&#123;            // å¦‚æœæ¶ˆæ¯å·²ç»ç”Ÿäº§ï¼Œéœ€è¦ç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹åå†å»ç”Ÿäº§            while (isProducted)&#123;                /**                 * è°ƒç”¨ wait() ä½¿å¾—çº¿ç¨‹ç­‰å¾…æŸä¸ªæ¡ä»¶æ»¡è¶³ï¼Œçº¿ç¨‹åœ¨ç­‰å¾…æ—¶ä¼šè¢«æŒ‚èµ·ï¼Œå½“å…¶ä»–çº¿ç¨‹çš„è¿è¡Œä½¿å¾—è¿™ä¸ªæ¡ä»¶æ»¡è¶³æ—¶ï¼Œå…¶å®ƒçº¿ç¨‹ä¼šè°ƒç”¨ notify() æˆ–è€… notifyAll() æ¥å”¤é†’æŒ‚èµ·çš„çº¿ç¨‹ã€‚                 * å®ƒä»¬éƒ½å±äº Object çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸å±äº Threadã€‚                 */                LOCK.wait();            &#125;            // å¦‚æœå·²ç»æ¶ˆè´¹ï¼Œé‚£ä¹ˆå°±éœ€è¦è¿›è¡Œç”Ÿäº§            num++;            System.out.println(String.format(&quot;ç”Ÿäº§æ¶ˆæ¯&gt;&gt;&gt;&gt;ã€%sã€‘&quot;, num));            /**             * è°ƒç”¨ wait() ä½¿å¾—çº¿ç¨‹ç­‰å¾…æŸä¸ªæ¡ä»¶æ»¡è¶³ï¼Œçº¿ç¨‹åœ¨ç­‰å¾…æ—¶ä¼šè¢«æŒ‚èµ·ï¼Œå½“å…¶ä»–çº¿ç¨‹çš„è¿è¡Œä½¿å¾—è¿™ä¸ªæ¡ä»¶æ»¡è¶³æ—¶ï¼Œå…¶å®ƒçº¿ç¨‹ä¼šè°ƒç”¨ notify() æˆ–è€… notifyAll() æ¥å”¤é†’æŒ‚èµ·çš„çº¿ç¨‹ã€‚             * å®ƒä»¬éƒ½å±äº Object çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸å±äº Threadã€‚             */            // é€šçŸ¥æ¶ˆè´¹è€…ï¼Œå¯ä»¥è¿›è¡Œæ¶ˆè´¹            LOCK.notifyAll();            // è®¾ç½®æ ‡è®°ï¼šå·²ç»ç”Ÿäº§            isProducted = true;        &#125;    &#125;    /**     * æ¶ˆè´¹æ–¹æ³•     */    public void consumer() throws InterruptedException &#123;        // åŒæ­¥æ¶ˆè´¹        synchronized (LOCK)&#123;            // å¦‚æœå·²ç»ç”Ÿäº§ï¼Œé‚£ä¹ˆæ¶ˆè´¹è€…æ¶ˆè´¹            while (!isProducted)&#123;                // å¦‚æœå·²ç»æ²¡æœ‰ç”Ÿäº§ï¼Œå³éœ€è¦æ¶ˆæ¯è´¹è¿›è¡Œç­‰å¾…ç”Ÿäº§è€…è¿›è¡Œç”Ÿäº§                LOCK.wait();            &#125;            System.out.println(String.format(&quot;æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€%sã€‘&quot;, num));            // é€šçŸ¥ç”Ÿäº§è€…å·²ç»æ¶ˆè´¹            LOCK.notifyAll();            // è®¾ç½®æ ‡è®°ï¼šæœªç”Ÿäº§            isProducted = false;        &#125;    &#125;    public static void main(String[] args) &#123;        MultiProduceConsumer produceConsumer = new MultiProduceConsumer();        Arrays.asList(&quot;Produce1&quot;,&quot;Produce2&quot;,&quot;Produce3&quot;,&quot;Produce4&quot;,&quot;Produce5&quot;,&quot;Produce6&quot;,&quot;Produce7&quot;,&quot;Produce8&quot;).forEach(p-&gt;&#123;            // ç”Ÿäº§è€…Produce            new Thread(()-&gt;&#123;                try &#123;                    while (true) &#123;                        produceConsumer.produce();                         Thread.sleep(10L);                    &#125;                &#125; catch (InterruptedException e) &#123;                    e.printStackTrace();                &#125;            &#125;,p).start();        &#125;);        Arrays.asList(&quot;Consumer1&quot;,&quot;Consumer2&quot;,&quot;Consumer3&quot;,&quot;Consumer4&quot;,&quot;Consumer5&quot;,&quot;Consumer6&quot;).forEach(c-&gt; &#123;            // æ¶ˆè´¹è€…            new Thread(() -&gt; &#123;                try &#123;                    while (true) &#123;                        produceConsumer.consumer();                         Thread.sleep(10L);                    &#125;                &#125; catch (InterruptedException e) &#123;                    e.printStackTrace();                &#125;            &#125;,c).start();        &#125;);    &#125;&#125;
æ‰§è¡Œç»“æœï¼š
ç”Ÿäº§æ¶ˆæ¯&gt;&gt;&gt;&gt;ã€1ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€1ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;&gt;&gt;ã€2ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€2ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;&gt;&gt;ã€3ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€3ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;&gt;&gt;ã€4ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€4ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;&gt;&gt;ã€5ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€5ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;&gt;&gt;ã€6ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€6ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;&gt;&gt;ã€7ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€7ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;&gt;&gt;ã€8ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€8ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;&gt;&gt;ã€9ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€9ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;&gt;&gt;ã€10ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€10ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;&gt;&gt;ã€11ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€11ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;&gt;&gt;ã€12ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€12ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;&gt;&gt;ã€13ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€13ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;&gt;&gt;ã€14ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€14ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;&gt;&gt;ã€15ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€15ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;&gt;&gt;ã€16ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€16ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;&gt;&gt;ã€17ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€17ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;&gt;&gt;ã€18ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€18ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;&gt;&gt;ã€19ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€19ã€‘ç”Ÿäº§æ¶ˆæ¯&gt;&gt;&gt;&gt;ã€20ã€‘æ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€20ã€‘

1.3 JAVAä¸­sleep() æ–¹æ³•å’Œ wait() æ–¹æ³•åŒºåˆ«
sleepæ–¹æ³•æ˜¯Threadç±»çš„æ–¹æ³•ï¼Œè€Œwaitæ–¹æ³•æ˜¯Objectæ–¹æ³•ã€‚
sleepæ–¹æ³•æ²¡æœ‰é‡Šæ”¾é”ï¼Œè€Œwaitæ–¹æ³•é‡Šæ”¾äº†é”ï¼Œå¹¶ä¸”åŠ å…¥åˆ°Objectçš„queueã€‚
ä½¿ç”¨sleepæ–¹æ³•ä¸ç”¨synchronizedç›‘æ§ï¼Œè€Œwaitæ–¹æ³•éœ€è¦ã€‚
ä½¿ç”¨sleepæ–¹æ³•ä¸éœ€è¦å”¤é†’ï¼Œè€Œwaitéœ€è¦ã€‚

 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(ä¹)Javaå¤šçº¿ç¨‹ä¹‹ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(äºŒ)Javaå¤šçº¿ç¨‹ä¹‹ç«è½¦ç¥¨</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E4%BA%8C)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8B%E7%81%AB%E8%BD%A6%E7%A5%A8/</url>
    <content><![CDATA[1. JAVAå¤šçº¿ç¨‹(äºŒ)Javaå¤šçº¿ç¨‹ä¹‹ç«è½¦ç¥¨&emsp;&emsp;éœ€æ±‚å¦‚ä¸‹ï¼šé“é“éƒ¨å‘å¸ƒäº†ä¸€ä¸ªå”®ç¥¨ä»»åŠ¡ï¼Œè¦æ±‚é”€å”®10å¼ ç¥¨ï¼Œè¦æ±‚æœ‰4ä¸ªçª—å£æ¥è¿›è¡Œé”€å”®ï¼Œè¯·ç¼–å†™å¤šçº¿ç¨‹ç¨‹åºæ¥æ¨¡æ‹Ÿè¿™ä¸ªæ•ˆæœ

ç¬¬001çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š1
ç¬¬004çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š2
ç¬¬002çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š3
ç¬¬003çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š4

1.1 ç»§æ‰¿Threadç±»å¤šçº¿ç¨‹è¿›è¡Œå”®ç¥¨ç»§æ‰¿Threadç±»çš„æ–¹å¼åˆ›å»ºå¤šçº¿ç¨‹è¿›è¡Œå”®ç¥¨çš„æ–¹å¼ï¼Œåœ¨ä¸åŠ é”çš„æƒ…å†µä¸‹ï¼Œæ¯ä¸€ä¸ªçª—å£éƒ½ç‹¬ç«‹ä¸ªä½“ï¼Œæ•°æ®æ²¡æœ‰å…±äº«ã€‚ï¼ˆå››ä¸ªçª—å£éƒ½å–äº†10å¼ ç¥¨ï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³çš„ç»“æœï¼‰ï¼Œä»£ç å¦‚ä¸‹ï¼š
package com.yuanxw.chapter2;/** * ç«è½¦ç¥¨å”®ç¥¨ */public class RailwayStation &#123;    public static void main(String[] args) &#123;        TicketWindow ticketWindow1 = new TicketWindow(&quot;001çª—å£&quot;);        TicketWindow ticketWindow2 = new TicketWindow(&quot;002çª—å£&quot;);        TicketWindow ticketWindow3 = new TicketWindow(&quot;003çª—å£&quot;);        TicketWindow ticketWindow4 = new TicketWindow(&quot;004çª—å£&quot;);        ticketWindow1.start();        ticketWindow2.start();        ticketWindow3.start();        ticketWindow4.start();    &#125;&#125;

package com.yuanxw.chapter2;/** * å”®ç¥¨çª—å£ * @author yuanxw */public class TicketWindow  extends Thread &#123;    /** æœ€å¤§å”®æ•° **/    private final int MAX_NUMBER = 10;    /** å½“å‰å”®æ•° **/    private int currentNumber = 1;    /** çª—å£åç§° **/    private String name;    public TicketWindow(String name) &#123;        this.name = name;    &#125;    @Override    public void run() &#123;        while (currentNumber &lt;= MAX_NUMBER)&#123;            System.out.println(String.format(&quot;ç¬¬%sï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š%s&quot;, name,currentNumber++));        &#125;    &#125;&#125;
æ‰§è¡Œç»“æœï¼š
ç¬¬001çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š1ç¬¬002çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š1ç¬¬003çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š1ç¬¬001çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š2ç¬¬004çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š1ç¬¬003çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š2ç¬¬001çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š3ç¬¬003çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š3ç¬¬001çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š4ç¬¬003çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š4ç¬¬002çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š2ç¬¬001çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š5ç¬¬003çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š5ç¬¬002çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š3ç¬¬004çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š2ç¬¬003çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š6ç¬¬002çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š4ç¬¬001çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š6ç¬¬003çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š7ç¬¬002çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š5ç¬¬001çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š7ç¬¬004çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š3ç¬¬002çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š6ç¬¬001çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š8ç¬¬003çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š8ç¬¬002çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š7ç¬¬001çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š9ç¬¬003çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š9ç¬¬002çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š8ç¬¬004çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š4ç¬¬001çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š10ç¬¬002çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š9ç¬¬003çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š10ç¬¬004çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š5ç¬¬002çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š10ç¬¬004çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š6ç¬¬004çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š7ç¬¬004çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š8ç¬¬004çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š9ç¬¬004çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š10

2.2 å®ç°Runnableæ¥å£å¤šçº¿ç¨‹è¿›è¡Œå”®ç¥¨å®ç°Runnableæ¥å£çš„æ–¹å¼å°†æˆ‘ä»¬å¯æ‰§è¡Œçš„é€»è¾‘å•å…ƒå’Œæˆ‘ä»¬çš„çº¿ç¨‹æ§åˆ¶åˆ†ç¦»ï¼ŒRunnableæ¥å£æ›´åŠ é€‚åˆå¤šä¸ªç›¸åŒçº¿ç¨‹å¤„ç†åŒä¸€ä»½èµ„æºçš„æƒ…å†µã€‚
package com.yuanxw.chapter2;/** * é«˜é“ç«™å”®ç¥¨ */public class HighSpeedRailStation &#123;    public static void main(String[] args) &#123;        TicketWindowRunnable ticketWindowRunnable = new TicketWindowRunnable();        Thread thread1 = new Thread(ticketWindowRunnable,&quot;001çª—å£&quot;);        Thread thread2 = new Thread(ticketWindowRunnable,&quot;002çª—å£&quot;);        Thread thread3 = new Thread(ticketWindowRunnable,&quot;003çª—å£&quot;);        Thread thread4 = new Thread(ticketWindowRunnable,&quot;004çª—å£&quot;);        thread1.start();        thread2.start();        thread3.start();        thread4.start();    &#125;&#125;

package com.yuanxw.chapter2;/** * å®ç°Runnableæ–¹å¼å”®ç¥¨ */public class TicketWindowRunnable implements Runnable &#123;    /** æœ€å¤§å”®æ•° **/    private final int MAX_NUMBER = 10;    /** å½“å‰å”®æ•° **/    private int currentNumber = 1;    @Override    public void run() &#123;        try &#123;            Thread.sleep(100);        &#125; catch (InterruptedException e) &#123;            e.printStackTrace();        &#125;        while (currentNumber &lt;= MAX_NUMBER)&#123;            System.out.println(String.format(&quot;ç¬¬%sï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š%s&quot;, Thread.currentThread().getName(),currentNumber++));        &#125;    &#125;&#125;

æ‰§è¡Œç»“æœï¼š
ç¬¬001çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š2ç¬¬002çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š3ç¬¬004çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š1ç¬¬003çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š4ç¬¬001çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š5ç¬¬002çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š6ç¬¬004çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š7ç¬¬001çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š9ç¬¬002çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š10ç¬¬003çª—å£ï¼Œæ­£åœ¨å”®ç¥¨ï¼Œç¥¨å·ï¼š8


 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(äºŒ)Javaå¤šçº¿ç¨‹ä¹‹ç«è½¦ç¥¨ã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVA å¤šçº¿ç¨‹(äºŒå)Java å¤šçº¿ç¨‹ä¹‹ FixedThreadPool å¯é‡ç”¨å›ºå®šçº¿ç¨‹æ•°çš„çº¿ç¨‹æ± </title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E4%BA%8C%E5%8D%81)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BFixedThreadPool%E5%8F%AF%E9%87%8D%E7%94%A8%E5%9B%BA%E5%AE%9A%E7%BA%BF%E7%A8%8B%E6%95%B0%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%B1%A0/</url>
    <content><![CDATA[1.JAVA å¤šçº¿ç¨‹(äºŒå)Java å¤šçº¿ç¨‹ä¹‹ FixedThreadPool å¯é‡ç”¨å›ºå®šçº¿ç¨‹æ•°çš„çº¿ç¨‹æ± 1.1 å¯é‡ç”¨å›ºå®šçº¿ç¨‹æ•°çš„çº¿ç¨‹æ±  FixedThreadPool&emsp;&emsp; å¯é‡ç”¨å›ºå®šçº¿ç¨‹æ•°çš„çº¿ç¨‹æ±  FixedThreadPool ç‰¹ç‚¹æ˜¯ï¼šåªæœ‰æ ¸å¿ƒçº¿ç¨‹ï¼Œä¸ä¼šè¢«å›æ”¶ã€çº¿ç¨‹æ•°é‡å›ºå®šã€ä»»åŠ¡é˜Ÿåˆ—æ— å¤§å°é™åˆ¶ï¼ˆè¶…å‡ºçš„çº¿ç¨‹ä»»åŠ¡ä¼šåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼‰ï¼Œé€šè¿‡æºä»£ç æŸ¥çœ‹ FixedThreadPool å®ç°ï¼š
/** * Creates a thread pool that reuses a fixed number of threads * operating off a shared unbounded queue.  At any point, at most * &#123;@code nThreads&#125; threads will be active processing tasks. * If additional tasks are submitted when all threads are active, * they will wait in the queue until a thread is available. * If any thread terminates due to a failure during execution * prior to shutdown, a new one will take its place if needed to * execute subsequent tasks.  The threads in the pool will exist * until it is explicitly &#123;@link ExecutorService#shutdown shutdown&#125;. * * @param nThreads the number of threads in the pool * @return the newly created thread pool * @throws IllegalArgumentException if &#123;@code nThreads &lt;= 0&#125; */public static ExecutorService newFixedThreadPool(int nThreads) &#123;    return new ThreadPoolExecutor(nThreads, nThreads,                                  0L, TimeUnit.MILLISECONDS,                                  new LinkedBlockingQueue&lt;Runnable&gt;());&#125;/** * Creates a thread pool that reuses a fixed number of threads * operating off a shared unbounded queue, using the provided * ThreadFactory to create new threads when needed.  At any point, * at most &#123;@code nThreads&#125; threads will be active processing * tasks.  If additional tasks are submitted when all threads are * active, they will wait in the queue until a thread is * available.  If any thread terminates due to a failure during * execution prior to shutdown, a new one will take its place if * needed to execute subsequent tasks.  The threads in the pool will * exist until it is explicitly &#123;@link ExecutorService#shutdown * shutdown&#125;. * * @param nThreads the number of threads in the pool * @param threadFactory the factory to use when creating new threads * @return the newly created thread pool * @throws NullPointerException if threadFactory is null * @throws IllegalArgumentException if &#123;@code nThreads &lt;= 0&#125; */public static ExecutorService newFixedThreadPool(int nThreads, ThreadFactory threadFactory) &#123;    return new ThreadPoolExecutor(nThreads, nThreads,                                  0L, TimeUnit.MILLISECONDS,                                  new LinkedBlockingQueue&lt;Runnable&gt;(),                                  threadFactory);&#125;/** * Creates a &#123;@code LinkedBlockingQueue&#125; with a capacity of * &#123;@link Integer#MAX_VALUE&#125;. */public LinkedBlockingQueue() &#123;    this(Integer.MAX_VALUE);&#125;

åœ¨ FixedThreadPool å®ç°ä¸­ï¼š

corePoolSize &amp;&amp; maximumPoolSizeï¼Œæ ¸å¿ƒçº¿ç¨‹æ•°å’Œå…è®¸æœ€å¤§çš„çº¿ç¨‹æ•°ä¸€è‡´ï¼Œå¯ä»¥æŒ‡å®šæ— é™å¤§ï¼Œåœ¨èµ„æºæœ‰é™çš„æƒ…å†µä¸‹å®¹æ˜“å¼•èµ· OOM å¼‚å¸¸ã€‚
keepAliveTime &#x3D;&gt; keepAliveTime ä¸º 0ï¼Œæ„å‘³ç€å¤šä½™çš„ç©ºé—²çº¿ç¨‹ä¼šè¢«ç«‹å³ç»ˆæ­¢ã€‚
workQueue &#x3D;&gt; é‡‡ç”¨æ— ç•Œé˜Ÿåˆ— LinkedBlockingQueue ä½œä¸ºçº¿ç¨‹æ± çš„å·¥ä½œé˜Ÿåˆ—ï¼ˆé˜Ÿåˆ—çš„å®¹é‡ä¸º Integer.MAX_VALUEï¼‰ï¼Œä¼šåœ¨å¾ªç¯ä¸­åå¤ä» LinkedBlockingQueue è·å–ä»»åŠ¡æ¥æ‰§è¡Œã€‚

1.2 FixedThreadPool ä½¿ç”¨æ ·ä¾‹FixedThreadPool çº¿ç¨‹æ± ä½¿ç”¨ LinkedBlockingQueue ä½œä¸ºçº¿ç¨‹æ± çš„å·¥ä½œé˜Ÿåˆ—ä¼šå¯¹çº¿ç¨‹æ± å¸¦æ¥å¦‚ä¸‹å½±å“ï¼š

å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°è¾¾åˆ° corePoolSize æ ¸å¿ƒçº¿ç¨‹æ•°åï¼Œæ–°ä»»åŠ¡å°†åœ¨æ— ç•Œé˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œå› æ­¤çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸ä¼šè¶…è¿‡ corePoolSize æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚
ä½¿ç”¨æ— ç•Œé˜Ÿåˆ—ï¼Œè¿è¡Œä¸­çš„ FixedThreadPool ä¸ä¼šæ‹’ç»ä»»åŠ¡ï¼Œï¼ˆæœªæ‰§è¡Œæ–¹æ³• shutdown()æˆ– shutdownNow()ï¼Œä¸ä¼šè°ƒç”¨ RejectedExecutionHandler.rejectedExecution æ–¹æ³•ï¼‰ï¼Œåœ¨ä»»åŠ¡æ¯”è¾ƒå¤šçš„æ—¶å€™ä¼šå¯¼è‡´ OOMï¼ˆå†…å­˜æº¢å‡ºï¼‰ã€‚

package com.yuanxw.chapter20;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.ThreadPoolExecutor;import java.util.concurrent.TimeUnit;public class FixedThreadPoolExample &#123;    public static void main(String[] args) throws InterruptedException &#123;        ExecutorService executorService = Executors.newFixedThreadPool(5);        ThreadPoolExecutor threadPoolExecutor = (ThreadPoolExecutor) executorService;        System.out.println(&quot;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š&quot; + threadPoolExecutor.getActiveCount());        for (int i = 0; i &lt; 10; i++) &#123;            executorService.execute(()-&gt;&#123;                try &#123;                    TimeUnit.SECONDS.sleep(1);                    System.out.println(String.format(&quot;çº¿ç¨‹ã€%sã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;&quot;, Thread.currentThread().getName()));                    System.out.println(&quot;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š&quot; + threadPoolExecutor.getActiveCount());                &#125; catch (InterruptedException e) &#123;                    e.printStackTrace();                &#125;            &#125;);        &#125;        TimeUnit.SECONDS.sleep(5);        System.out.println(&quot;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š&quot; + threadPoolExecutor.getActiveCount());        // corePoolSize ç­‰äº maximumPoolSizeï¼Œå› æ­¤åº”ç”¨ç¨‹åºä¸ä¼šç»“æŸï¼Œéœ€è¦è°ƒç”¨executorService.shutdown()æ–¹æ³•ï¼Œå…³é—­çº¿ç¨‹æ± ã€‚        executorService.shutdown();    &#125;&#125;

æ‰§è¡Œç»“æœï¼š
è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š0çº¿ç¨‹ã€pool-1-thread-2ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;çº¿ç¨‹ã€pool-1-thread-3ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š5çº¿ç¨‹ã€pool-1-thread-1ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š4çº¿ç¨‹ã€pool-1-thread-5ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š5è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š5çº¿ç¨‹ã€pool-1-thread-4ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š5çº¿ç¨‹ã€pool-1-thread-4ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;çº¿ç¨‹ã€pool-1-thread-3ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;çº¿ç¨‹ã€pool-1-thread-2ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;çº¿ç¨‹ã€pool-1-thread-5ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š5çº¿ç¨‹ã€pool-1-thread-1ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š5è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š5è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š5è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š4è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š0

FixedThreadPool çš„ execute()æ–¹æ³•çš„æ‰§è¡Œç¤ºæ„å›¾ï¼ˆè¯¥å›¾ç‰‡æ¥æºï¼šã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹ï¼‰ï¼š

å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å°äº corePoolSizeï¼Œ å¦‚æœå†æ¥æ–°ä»»åŠ¡çš„è¯ï¼Œå°±åˆ›å»ºæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼›
å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°ç­‰äº corePoolSize åï¼Œ å¦‚æœå†æ¥æ–°ä»»åŠ¡çš„è¯ï¼Œä¼šå°†ä»»åŠ¡åŠ å…¥ LinkedBlockingQueueï¼›
çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ‰§è¡Œå®Œå½“å‰çš„ä»»åŠ¡åï¼Œä¼šåœ¨å¾ªç¯ä¸­åå¤ä» LinkedBlockingQueue ä¸­è·å–ä»»åŠ¡æ¥æ‰§è¡Œï¼›

&emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVA å¤šçº¿ç¨‹(äºŒå)Java å¤šçº¿ç¨‹ä¹‹ FixedThreadPool å¯é‡ç”¨å›ºå®šçº¿ç¨‹æ•°çš„çº¿ç¨‹æ± ã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚
  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(äºŒåä¸ƒ)Javaå¤šçº¿ç¨‹ä¹‹LinkedBlockingQueueå®¹å™¨</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E4%BA%8C%E5%8D%81%E4%B8%83)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BLinkedBlockingQueue%E5%AE%B9%E5%99%A8/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(äºŒåä¸ƒ)Javaå¤šçº¿ç¨‹ä¹‹LinkedBlockingQueueå®¹å™¨1.1 ä»€ä¹ˆæ˜¯LinkedBlockingQueue&emsp;&emsp;LinkedBlockingQueue åº•å±‚åŸºäºå•å‘é“¾è¡¨å®ç°çš„é˜»å¡é˜Ÿåˆ—ï¼Œå¯ä»¥å½“åšæ— ç•Œé˜Ÿåˆ—ä¹Ÿå¯ä»¥å½“åšæœ‰ç•Œé˜Ÿåˆ—æ¥ä½¿ç”¨ï¼ŒåŒæ ·æ»¡è¶³ FIFO çš„ç‰¹æ€§ï¼Œä¸ ArrayBlockingQueue ç›¸æ¯”èµ·æ¥å…·æœ‰æ›´é«˜çš„ååé‡ï¼Œä¸ºäº†é˜²æ­¢ LinkedBlockingQueue å®¹é‡è¿…é€Ÿå¢ï¼ŒæŸè€—å¤§é‡å†…å­˜ã€‚é€šå¸¸åœ¨åˆ›å»º LinkedBlockingQueue å¯¹è±¡æ—¶ï¼Œä¼šæŒ‡å®šå…¶å¤§å°ï¼Œå¦‚æœæœªæŒ‡å®šï¼Œå®¹é‡ç­‰äº Integer.MAX_VALUEã€‚
ä¸‹é¢æ˜¯ LinkedBlockingQueueç»§æ‰¿ç»“æ„å…³ç³»å›¾ï¼š

1.2 LinkedBlockingQueueå•å‘é“¾è¡¨å®ç°çš„é˜»å¡é˜Ÿåˆ—&emsp;&emsp;LinkedBlockingQueueæ˜¯ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ï¼Œå†…éƒ¨ç”±ä¸¤ä¸ªReentrantLockæ¥å®ç°å‡ºå…¥é˜Ÿåˆ—çš„çº¿ç¨‹å®‰å…¨ï¼Œç”±å„è‡ªçš„Conditionå¯¹è±¡çš„awaitå’Œsignalæ¥å®ç°ç­‰å¾…å’Œå”¤é†’åŠŸèƒ½ã€‚å®ƒå’ŒArrayBlockingQueueçš„ä¸åŒç‚¹åœ¨äºï¼š

é˜Ÿåˆ—å¤§å°æœ‰æ‰€ä¸åŒï¼ŒArrayBlockingQueueæ˜¯æœ‰ç•Œçš„åˆå§‹åŒ–å¿…é¡»æŒ‡å®šå¤§å°ï¼Œè€ŒLinkedBlockingQueueå¯ä»¥æ˜¯æœ‰ç•Œçš„ä¹Ÿå¯ä»¥æ˜¯æ— ç•Œçš„(Integer.MAX_VALUE)ï¼Œå¯¹äºåè€…è€Œè¨€ï¼Œå½“æ·»åŠ é€Ÿåº¦å¤§äºç§»é™¤é€Ÿåº¦æ—¶ï¼Œåœ¨æ— ç•Œçš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šé€ æˆå†…å­˜æº¢å‡ºç­‰é—®é¢˜ã€‚
æ•°æ®å­˜å‚¨å®¹å™¨ä¸åŒï¼ŒArrayBlockingQueueé‡‡ç”¨çš„æ˜¯æ•°ç»„ä½œä¸ºæ•°æ®å­˜å‚¨å®¹å™¨ï¼Œè€ŒLinkedBlockingQueueé‡‡ç”¨çš„åˆ™æ˜¯ä»¥NodeèŠ‚ç‚¹ä½œä¸ºè¿æ¥å¯¹è±¡çš„é“¾è¡¨ã€‚
ç”±äºArrayBlockingQueueé‡‡ç”¨çš„æ˜¯æ•°ç»„çš„å­˜å‚¨å®¹å™¨ï¼Œå› æ­¤åœ¨æ’å…¥æˆ–åˆ é™¤å…ƒç´ æ—¶ä¸ä¼šäº§ç”Ÿæˆ–é”€æ¯ä»»ä½•é¢å¤–çš„å¯¹è±¡å®ä¾‹ï¼Œè€ŒLinkedBlockingQueueåˆ™ä¼šç”Ÿæˆä¸€ä¸ªé¢å¤–çš„Nodeå¯¹è±¡ã€‚è¿™å¯èƒ½åœ¨é•¿æ—¶é—´å†…éœ€è¦é«˜æ•ˆå¹¶å‘åœ°å¤„ç†å¤§æ‰¹é‡æ•°æ®çš„æ—¶ï¼Œå¯¹äºGCå¯èƒ½å­˜åœ¨è¾ƒå¤§å½±å“ã€‚
ä¸¤è€…çš„å®ç°é˜Ÿåˆ—æ·»åŠ æˆ–ç§»é™¤çš„é”ä¸ä¸€æ ·ï¼ŒArrayBlockingQueueå®ç°çš„é˜Ÿåˆ—ä¸­çš„é”æ˜¯æ²¡æœ‰åˆ†ç¦»çš„ï¼Œå³æ·»åŠ æ“ä½œå’Œç§»é™¤æ“ä½œé‡‡ç”¨çš„åŒä¸€ä¸ªReenterLocké”ï¼Œè€ŒLinkedBlockingQueueå®ç°çš„é˜Ÿåˆ—ä¸­çš„é”æ˜¯åˆ†ç¦»çš„ï¼Œå…¶æ·»åŠ é‡‡ç”¨çš„æ˜¯putLockï¼Œç§»é™¤é‡‡ç”¨çš„åˆ™æ˜¯takeLockï¼Œè¿™æ ·èƒ½å¤§å¤§æé«˜é˜Ÿåˆ—çš„ååé‡ï¼Œä¹Ÿæ„å‘³ç€åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å¯ä»¥å¹¶è¡Œåœ°æ“ä½œé˜Ÿåˆ—ä¸­çš„æ•°æ®ï¼Œä»¥æ­¤æ¥æé«˜æ•´ä¸ªé˜Ÿåˆ—çš„å¹¶å‘æ€§èƒ½ã€‚

é€šè¿‡æºä»£ç æŸ¥çœ‹LinkedBlockingQueueå®ç°ï¼š
/** * åˆ›å»ºä¸€ä¸ª LinkedBlockingQueue ï¼Œå®¹é‡ä¸º Integer.MAX_VALUE ã€‚  * * Creates a &#123;@code LinkedBlockingQueue&#125; with a capacity of * &#123;@link Integer#MAX_VALUE&#125;. */public LinkedBlockingQueue() &#123;    this(Integer.MAX_VALUE);&#125;/** * åˆ›å»ºä¸€ä¸ªå…·æœ‰ç»™å®šï¼ˆå›ºå®šï¼‰å®¹é‡çš„ LinkedBlockingQueue ã€‚  * Creates a &#123;@code LinkedBlockingQueue&#125; with the given (fixed) capacity. * * @param capacity the capacity of this queue * @throws IllegalArgumentException if &#123;@code capacity&#125; is not greater *         than zero */public LinkedBlockingQueue(int capacity) &#123;    if (capacity &lt;= 0) throw new IllegalArgumentException();    this.capacity = capacity;    last = head = new Node&lt;E&gt;(null);&#125;/** * åˆ›å»ºä¸€ä¸ª LinkedBlockingQueue ï¼Œå®¹é‡ä¸º Integer.MAX_VALUE ï¼Œæœ€åˆåŒ…å«ç»™å®šé›†åˆçš„å…ƒç´ ï¼Œä»¥é›†åˆçš„è¿­ä»£* å™¨çš„éå†é¡ºåºæ·»åŠ ã€‚  * Creates a &#123;@code LinkedBlockingQueue&#125; with a capacity of * &#123;@link Integer#MAX_VALUE&#125;, initially containing the elements of the * given collection, * added in traversal order of the collection&#x27;s iterator. * * @param c the collection of elements to initially contain * @throws NullPointerException if the specified collection or any *         of its elements are null */public LinkedBlockingQueue(Collection&lt;? extends E&gt; c) &#123;    this(Integer.MAX_VALUE);    final ReentrantLock putLock = this.putLock;    putLock.lock(); // Never contended, but necessary for visibility    try &#123;        int n = 0;        for (E e : c) &#123;            if (e == null)                throw new NullPointerException();            if (n == capacity)                throw new IllegalStateException(&quot;Queue full&quot;);            enqueue(new Node&lt;E&gt;(e));            ++n;        &#125;        count.set(n);    &#125; finally &#123;        putLock.unlock();    &#125;&#125;

1.3 å¸¸ç”¨çš„æ–¹æ³•package com.yuanxw.thread.chapter27;import java.util.concurrent.LinkedBlockingQueue;import java.util.concurrent.Executors;import java.util.concurrent.TimeUnit;public class LinkedBlockingQueueExample &#123;    public static void main(String[] args) throws InterruptedException &#123;        // add();        // offer();        // put();        // poll();        // peek();        // element();         remove();    &#125;    /**     å¦‚æœå¯ä»¥åœ¨ä¸è¶…è¿‡é˜Ÿåˆ—çš„å®¹é‡çš„æƒ…å†µä¸‹ç«‹å³å°†å…¶æŒ‡å®šçš„å…ƒç´ æ’å…¥åˆ°è¯¥é˜Ÿåˆ—ï¼Œ     å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™è¿”å› trueå¹¶æŠ›å‡º IllegalStateException ã€‚     æ‰§è¡Œç»“æœï¼š         =====æ‰§è¡Œadd()ç­¾åæ–¹æ³•-å¼€å§‹=====         linkedBlockingQueue.add()æ‰§è¡Œè¿”å›ç»“æœï¼štrue         linkedBlockingQueue.add()æ‰§è¡Œè¿”å›ç»“æœï¼štrue         linkedBlockingQueue.add()æ‰§è¡Œè¿”å›ç»“æœï¼štrue         Exception in thread &quot;main&quot; java.lang.IllegalStateException: Queue full         at java.util.AbstractQueue.add(AbstractQueue.java:98)         at com.yuanxw.thread.chapter27.LinkedBlockingQueueExample.add(LinkedBlockingQueueExample.java:38)         at com.yuanxw.thread.chapter27.LinkedBlockingQueueExample.main(LinkedBlockingQueueExample.java:9)     */    public static void add() &#123;        System.out.println(&quot;=====æ‰§è¡Œadd()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        LinkedBlockingQueue linkedBlockingQueue = new LinkedBlockingQueue(3);        System.out.println(&quot;linkedBlockingQueue.add()æ‰§è¡Œè¿”å›ç»“æœï¼š&quot;+linkedBlockingQueue.add(&quot;Message 1&quot;));        System.out.println(&quot;linkedBlockingQueue.add()æ‰§è¡Œè¿”å›ç»“æœï¼š&quot;+linkedBlockingQueue.add(&quot;Message 2&quot;));        System.out.println(&quot;linkedBlockingQueue.add()æ‰§è¡Œè¿”å›ç»“æœï¼š&quot;+linkedBlockingQueue.add(&quot;Message 3&quot;));        System.out.println(&quot;linkedBlockingQueue.add()æ‰§è¡Œè¿”å›ç»“æœï¼š&quot;+linkedBlockingQueue.add(&quot;Message 4&quot;));        System.out.println(&quot;=====æ‰§è¡Œadd()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**     * å¦‚æœå¯ä»¥åœ¨ä¸è¶…è¿‡é˜Ÿåˆ—å®¹é‡çš„æƒ…å†µä¸‹ç«‹å³å°†å…¶æŒ‡å®šçš„å…ƒç´ æ’å…¥è¯¥é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œ     * åˆ™åœ¨æˆåŠŸæ—¶trueå¦‚æœè¯¥é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™è¿”å›false ã€‚     æ‰§è¡Œç»“æœï¼š         =====æ‰§è¡Œoffer()ç­¾åæ–¹æ³•-å¼€å§‹=====         linkedBlockingQueue.offer()æ‰§è¡Œè¿”å›ç»“æœï¼štrue         linkedBlockingQueue.offer()æ‰§è¡Œè¿”å›ç»“æœï¼štrue         linkedBlockingQueue.offer()æ‰§è¡Œè¿”å›ç»“æœï¼štrue         linkedBlockingQueue.offer()æ‰§è¡Œè¿”å›ç»“æœï¼šfalse         =====æ‰§è¡Œoffer()ç­¾åæ–¹æ³•-ç»“æŸ=====     */    public static void offer()&#123;        System.out.println(&quot;=====æ‰§è¡Œoffer()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        LinkedBlockingQueue linkedBlockingQueue = new LinkedBlockingQueue(3);        System.out.println(&quot;linkedBlockingQueue.offer()æ‰§è¡Œè¿”å›ç»“æœï¼š&quot;+linkedBlockingQueue.offer(&quot;Message 1&quot;));        System.out.println(&quot;linkedBlockingQueue.offer()æ‰§è¡Œè¿”å›ç»“æœï¼š&quot;+linkedBlockingQueue.offer(&quot;Message 2&quot;));        System.out.println(&quot;linkedBlockingQueue.offer()æ‰§è¡Œè¿”å›ç»“æœï¼š&quot;+linkedBlockingQueue.offer(&quot;Message 3&quot;));        System.out.println(&quot;linkedBlockingQueue.offer()æ‰§è¡Œè¿”å›ç»“æœï¼š&quot;+linkedBlockingQueue.offer(&quot;Message 4&quot;));        System.out.println(&quot;=====æ‰§è¡Œoffer()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**     * åœ¨è¯¥é˜Ÿåˆ—çš„å°¾éƒ¨æ’å…¥æŒ‡å®šçš„å…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™ç­‰å¾…ç©ºé—´å˜ä¸ºå¯ç”¨ã€‚     æ‰§è¡Œç»“æœï¼š     =====æ‰§è¡Œput()ç­¾åæ–¹æ³•-å¼€å§‹=====     å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼š3     å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­çš„å®¹é‡ï¼š0     å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­take()æ•°æ®å€¼ä¸ºï¼šMessage 1     Message 2     Message 3     Message 4     =====æ‰§è¡Œput()ç­¾åæ–¹æ³•-ç»“æŸ=====     */    public static void put() throws InterruptedException &#123;        System.out.println(&quot;=====æ‰§è¡Œput()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        LinkedBlockingQueue linkedBlockingQueue = new LinkedBlockingQueue(3);        linkedBlockingQueue.put(&quot;Message 1&quot;);        linkedBlockingQueue.put(&quot;Message 2&quot;);        linkedBlockingQueue.put(&quot;Message 3&quot;);        Executors.newSingleThreadExecutor().execute(()-&gt;&#123;            System.out.println(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼š&quot; + linkedBlockingQueue.size());            System.out.println(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­çš„å®¹é‡ï¼š&quot; + linkedBlockingQueue.remainingCapacity());            try &#123;                TimeUnit.SECONDS.sleep(5);                // æ£€ç´¢å¹¶åˆ é™¤æ­¤é˜Ÿåˆ—çš„å¤´                Object take = linkedBlockingQueue.take();                System.out.println(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­take()æ•°æ®å€¼ä¸ºï¼š&quot; + take);            &#125; catch (InterruptedException e) &#123;                e.printStackTrace();            &#125;        &#125;);        linkedBlockingQueue.put(&quot;Message 4&quot;);        linkedBlockingQueue.forEach(System.out::println);        System.out.println(&quot;=====æ‰§è¡Œput()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**     * æ£€ç´¢å¹¶åˆ é™¤æ­¤é˜Ÿåˆ—çš„å¤´ï¼Œåˆ™ç­‰å¾…ç©ºé—´å˜ä¸ºå¯ç”¨ã€‚     æ‰§è¡Œç»“æœï¼š     =====æ‰§è¡Œpoll()ç­¾åæ–¹æ³•-å¼€å§‹=====     å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€3ã€‘,å®¹é‡ï¼šã€0ã€‘     å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼šMessage 1     å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼šMessage 2     å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€1ã€‘,å®¹é‡ï¼šã€2ã€‘     å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼šMessage 3     å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼šnull     å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼šnull     =====æ‰§è¡Œpoll()ç­¾åæ–¹æ³•-ç»“æŸ=====     */    public static void poll() throws InterruptedException &#123;        System.out.println(&quot;=====æ‰§è¡Œpoll()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        LinkedBlockingQueue linkedBlockingQueue = new LinkedBlockingQueue(3);        linkedBlockingQueue.put(&quot;Message 1&quot;);        linkedBlockingQueue.put(&quot;Message 2&quot;);        linkedBlockingQueue.put(&quot;Message 3&quot;);        System.out.println(String.format(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, linkedBlockingQueue.size(),linkedBlockingQueue.remainingCapacity()));        System.out.println(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼š&quot; + linkedBlockingQueue.poll());        System.out.println(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼š&quot; + linkedBlockingQueue.poll());        System.out.println(String.format(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, linkedBlockingQueue.size(),linkedBlockingQueue.remainingCapacity()));        System.out.println(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼š&quot; + linkedBlockingQueue.poll());        System.out.println(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼š&quot; + linkedBlockingQueue.poll());        System.out.println(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼š&quot; + linkedBlockingQueue.poll());        System.out.println(&quot;=====æ‰§è¡Œpoll()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**     * æ£€ç´¢ä½†ä¸åˆ é™¤æ­¤é˜Ÿåˆ—çš„å¤´ï¼Œå¦‚æœæ­¤é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿”å› nullã€‚     æ‰§è¡Œç»“æœï¼š         =====æ‰§è¡Œpeek()ç­¾åæ–¹æ³•-å¼€å§‹=====         å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€3ã€‘,å®¹é‡ï¼šã€0ã€‘         å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼šMessage 1         å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼šMessage 1         å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€3ã€‘,å®¹é‡ï¼šã€0ã€‘         å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼šMessage 1         å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼šMessage 1         å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼šMessage 1         =====æ‰§è¡Œpeek()ç­¾åæ–¹æ³•-ç»“æŸ=====     */    public static void peek() throws InterruptedException &#123;        System.out.println(&quot;=====æ‰§è¡Œpeek()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        LinkedBlockingQueue linkedBlockingQueue = new LinkedBlockingQueue(3);        linkedBlockingQueue.put(&quot;Message 1&quot;);        linkedBlockingQueue.put(&quot;Message 2&quot;);        linkedBlockingQueue.put(&quot;Message 3&quot;);        System.out.println(String.format(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, linkedBlockingQueue.size(),linkedBlockingQueue.remainingCapacity()));        System.out.println(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼š&quot; + linkedBlockingQueue.peek());        System.out.println(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼š&quot; + linkedBlockingQueue.peek());        System.out.println(String.format(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, linkedBlockingQueue.size(),linkedBlockingQueue.remainingCapacity()));        System.out.println(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼š&quot; + linkedBlockingQueue.peek());        System.out.println(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼š&quot; + linkedBlockingQueue.peek());        System.out.println(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼š&quot; + linkedBlockingQueue.peek());        System.out.println(&quot;=====æ‰§è¡Œpeek()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**     * æ£€ç´¢ï¼Œä½†ä¸åˆ é™¤ï¼Œè¿™ä¸ªé˜Ÿåˆ—çš„å¤´ã€‚ æ­¤æ–¹æ³•ä¸peekçš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œå¦‚æœæ­¤é˜Ÿåˆ—ä¸ºç©ºï¼Œå®ƒå°†æŠ›å‡ºå¼‚å¸¸ã€‚     æ‰§è¡Œç»“æœï¼š         =====æ‰§è¡Œelement()ç­¾åæ–¹æ³•-å¼€å§‹=====         å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€3ã€‘,å®¹é‡ï¼šã€0ã€‘         å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€0ã€‘,å®¹é‡ï¼šã€3ã€‘         Exception in thread &quot;main&quot; java.util.NoSuchElementException         at java.util.AbstractQueue.element(AbstractQueue.java:136)         at com.yuanxw.thread.chapter27.LinkedBlockingQueueExample.element(LinkedBlockingQueueExample.java:181)         at com.yuanxw.thread.chapter27.LinkedBlockingQueueExample.main(LinkedBlockingQueueExample.java:14)     */    public static void element() throws InterruptedException &#123;        System.out.println(&quot;=====æ‰§è¡Œelement()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        LinkedBlockingQueue linkedBlockingQueue = new LinkedBlockingQueue(3);        linkedBlockingQueue.put(&quot;Message 1&quot;);        linkedBlockingQueue.put(&quot;Message 2&quot;);        linkedBlockingQueue.put(&quot;Message 3&quot;);        System.out.println(String.format(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, linkedBlockingQueue.size(),linkedBlockingQueue.remainingCapacity()));        linkedBlockingQueue.clear();        System.out.println(String.format(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, linkedBlockingQueue.size(),linkedBlockingQueue.remainingCapacity()));        System.out.println(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­element()æ•°æ®å€¼ä¸ºï¼š&quot; + linkedBlockingQueue.element());        System.out.println(&quot;=====æ‰§è¡Œelement()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**     * æ£€ç´¢å¹¶åˆ é™¤æ­¤é˜Ÿåˆ—çš„å¤´ã€‚ æ­¤æ–¹æ³•ä¸pollä¸åŒä¹‹å¤„åœ¨äºï¼Œå¦‚æœæ­¤é˜Ÿåˆ—ä¸ºç©ºï¼Œå®ƒå°†æŠ›å‡ºå¼‚å¸¸ã€‚     æ‰§è¡Œç»“æœï¼š         =====æ‰§è¡Œremove()ç­¾åæ–¹æ³•-å¼€å§‹=====         å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€3ã€‘,å®¹é‡ï¼šã€0ã€‘         å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­remove()æ•°æ®å€¼ä¸ºï¼šMessage 1         å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­remove()æ•°æ®å€¼ä¸ºï¼šMessage 2         å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­remove()æ•°æ®å€¼ä¸ºï¼šMessage 3         Exception in thread &quot;main&quot; java.util.NoSuchElementException         at java.util.AbstractQueue.remove(AbstractQueue.java:117)         at com.yuanxw.thread.chapter27.LinkedBlockingQueueExample.remove(LinkedBlockingQueueExample.java:205)         at com.yuanxw.thread.chapter27.LinkedBlockingQueueExample.main(LinkedBlockingQueueExample.java:15)     */    public static void remove() throws InterruptedException &#123;        System.out.println(&quot;=====æ‰§è¡Œremove()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        LinkedBlockingQueue linkedBlockingQueue = new LinkedBlockingQueue(3);        linkedBlockingQueue.put(&quot;Message 1&quot;);        linkedBlockingQueue.put(&quot;Message 2&quot;);        linkedBlockingQueue.put(&quot;Message 3&quot;);        System.out.println(String.format(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, linkedBlockingQueue.size(),linkedBlockingQueue.remainingCapacity()));        System.out.println(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­remove()æ•°æ®å€¼ä¸ºï¼š&quot; + linkedBlockingQueue.remove());        System.out.println(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­remove()æ•°æ®å€¼ä¸ºï¼š&quot; + linkedBlockingQueue.remove());        System.out.println(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­remove()æ•°æ®å€¼ä¸ºï¼š&quot; + linkedBlockingQueue.remove());        System.out.println(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­remove()æ•°æ®å€¼ä¸ºï¼š&quot; + linkedBlockingQueue.remove());        System.out.println(String.format(&quot;å½“å‰linkedBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, linkedBlockingQueue.size(),linkedBlockingQueue.remainingCapacity()));        System.out.println(&quot;=====æ‰§è¡Œremove()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;&#125;

 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(äºŒåä¸ƒ)Javaå¤šçº¿ç¨‹ä¹‹LinkedBlockingQueueå®¹å™¨ã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(äºŒåä¸‰)Javaå¤šçº¿ç¨‹ä¹‹ScheduledThreadPoolExecutorå®šæ—¶æ‰§è¡Œä»»åŠ¡çº¿ç¨‹æ± </title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E4%BA%8C%E5%8D%81%E4%B8%89)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BScheduledThreadPool%E5%AE%9A%E6%9C%9F%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1%E7%BA%BF%E7%A8%8B%E6%B1%A0/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(äºŒåä¸‰)Javaå¤šçº¿ç¨‹ä¹‹ScheduledThreadPoolExecutorå®šæ—¶æ‰§è¡Œä»»åŠ¡çº¿ç¨‹æ± 1.1 å®šæ—¶æ‰§è¡Œä»»åŠ¡çº¿ç¨‹æ± ScheduledThreadPoolExecutor&emsp;&emsp; ScheduledThreadPoolExecutoræ˜¯ä¸€ä¸ªä½¿ç”¨çº¿ç¨‹æ± æ‰§è¡Œå®šæ—¶ä»»åŠ¡çš„ç±»ï¼Œç›¸è¾ƒäºJavaä¸­æä¾›çš„å¦ä¸€ä¸ªæ‰§è¡Œå®šæ—¶ä»»åŠ¡çš„ç±»Timerï¼Œå…¶ä¸»è¦æœ‰å¦‚ä¸‹ä¸¤ä¸ªä¼˜ç‚¹ï¼š

ä½¿ç”¨å¤šçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œä¸ç”¨æ‹…å¿ƒä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿è€Œå¯¼è‡´ä»»åŠ¡ç›¸äº’é˜»å¡çš„æƒ…å†µï¼ŒTimeræ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„ï¼Œå› è€Œä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ã€‚
ä¸ç”¨æ‹…å¿ƒä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœçº¿ç¨‹å¤±æ´»ï¼Œå…¶ä¼šæ–°å»ºçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼ŒTimerç±»çš„å•çº¿ç¨‹æŒ‚æ‰ä¹‹åæ˜¯ä¸ä¼šé‡æ–°åˆ›å»ºçº¿ç¨‹æ‰§è¡Œåç»­ä»»åŠ¡çš„ã€‚

æ—¶cheduledThreadPoolExecutorå®š æ‰§è¡Œä»»åŠ¡çº¿ç¨‹æ± ç»§æ‰¿ç»“æ„å…³ç³»å›¾ï¼š
é€šè¿‡æºä»£ç æŸ¥çœ‹ScheduledThreadPoolExecutoræ„é€ å‡½æ•°å®ç°ï¼š
/** * åˆ›å»ºä¸€ä¸ªScheduledThreadPoolExecutorï¼Œéœ€è¦æŒ‡å®šæ ¸å¿ƒçº¿ç¨‹æ± å¤§å°ã€‚ * Creates a new &#123;@code ScheduledThreadPoolExecutor&#125; with the * given core pool size. * * @param corePoolSize the number of threads to keep in the pool, even *        if they are idle, unless &#123;@code allowCoreThreadTimeOut&#125; is set * @throws IllegalArgumentException if &#123;@code corePoolSize &lt; 0&#125; */public ScheduledThreadPoolExecutor(int corePoolSize) &#123;    super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS,          new DelayedWorkQueue());&#125;/** * Creates a new ScheduledThreadPoolExecutor with the given * initial parameters. * * @param corePoolSize the number of threads to keep in the pool, even *        if they are idle, unless &#123;@code allowCoreThreadTimeOut&#125; is set * @param handler the handler to use when execution is blocked *        because the thread bounds and queue capacities are reached * @throws IllegalArgumentException if &#123;@code corePoolSize &lt; 0&#125; * @throws NullPointerException if &#123;@code handler&#125; is null */public ScheduledThreadPoolExecutor(int corePoolSize,                                   RejectedExecutionHandler handler) &#123;    super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS,          new DelayedWorkQueue(), handler);&#125;/** * Creates a new &#123;@code ScheduledThreadPoolExecutor&#125; with the * given initial parameters. * * @param corePoolSize the number of threads to keep in the pool, even *        if they are idle, unless &#123;@code allowCoreThreadTimeOut&#125; is set * @param threadFactory the factory to use when the executor *        creates a new thread * @throws IllegalArgumentException if &#123;@code corePoolSize &lt; 0&#125; * @throws NullPointerException if &#123;@code threadFactory&#125; is null */public ScheduledThreadPoolExecutor(int corePoolSize,                                   ThreadFactory threadFactory) &#123;    super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS,          new DelayedWorkQueue(), threadFactory);&#125;/** * Creates a new ScheduledThreadPoolExecutor with the given * initial parameters. * * @param corePoolSize the number of threads to keep in the pool, even *        if they are idle, unless &#123;@code allowCoreThreadTimeOut&#125; is set * @param threadFactory the factory to use when the executor *        creates a new thread * @param handler the handler to use when execution is blocked *        because the thread bounds and queue capacities are reached * @throws IllegalArgumentException if &#123;@code corePoolSize &lt; 0&#125; * @throws NullPointerException if &#123;@code threadFactory&#125; or *         &#123;@code handler&#125; is null */public ScheduledThreadPoolExecutor(int corePoolSize,                                   ThreadFactory threadFactory,                                   RejectedExecutionHandler handler) &#123;    super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS,          new DelayedWorkQueue(), threadFactory, handler);&#125;
åœ¨ScheduledThreadPoolExecutorå®ç°ä¸­ï¼š

corePoolSize &#x3D;&gt; éœ€è¦è‡ªå·±ä¼ é€’å‚æ•°ï¼ŒæŒ‡å®šæ ¸å¿ƒçº¿ç¨‹æ•°å¤§å°ã€‚
maximumPoolSize &#x3D;&gt; å…è®¸æœ€å¤§çš„çº¿ç¨‹æ•°é»˜è®¤Integer.MAX_VALUEæ— é™å¤§ã€‚
keepAliveTime &#x3D;&gt; keepAliveTimeä¸º0ï¼Œæ„å‘³ç€å¤šä½™çš„ç©ºé—²çº¿ç¨‹ä¼šè¢«ç«‹å³ç»ˆæ­¢ã€‚
workQueue &#x3D;&gt; é‡‡ç”¨DelayedWorkQueueä½œä¸ºçº¿ç¨‹æ± çš„å·¥ä½œé˜Ÿåˆ—ã€‚è¯¥é˜Ÿåˆ—æ˜¯ä¸€ä¸ªä½¿ç”¨æ•°ç»„å®ç°çš„ä¼˜å…ˆé˜Ÿåˆ—ï¼Œåœ¨è°ƒç”¨ScheduledFutureTask::cancel()æ–¹æ³•æ—¶ï¼Œå…¶ä¼šæ ¹æ®removeOnCancelå˜é‡çš„è®¾ç½®æ¥ç¡®è®¤æ˜¯å¦éœ€è¦å°†å½“å‰ä»»åŠ¡çœŸæ­£çš„ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œè€Œä¸åªæ˜¯æ ‡è¯†å…¶ä¸ºå·²åˆ é™¤çŠ¶æ€ã€‚

1.2 ScheduledThreadPoolExecutorä½¿ç”¨æ ·ä¾‹package com.yuanxw.chapter23;import java.util.concurrent.ScheduledFuture;import java.util.concurrent.ScheduledThreadPoolExecutor;import java.util.concurrent.TimeUnit;public class ScheduledThreadPoolExample &#123;    public static void main(String[] args) &#123;        // schedule();        // scheduleAtFixedRate();        scheduleWithFixedDelay();    &#125;    /**     * å•æ¬¡å®šæ—¶ä»»åŠ¡è°ƒç”¨     * schedule(Runnable command, long delay, TimeUnit unit) // æ— è¿”å›å€¼çš„å»¶è¿Ÿä»»åŠ¡     * schedule(Callable callable, long delay, TimeUnit unit) // æœ‰è¿”å›å€¼çš„å»¶è¿Ÿä»»åŠ¡     */    private static void schedule() &#123;        // è®¾ç½®æ ¸å¿ƒçº¿ç¨‹æ•°        ScheduledThreadPoolExecutor scheduledThreadPoolExecutor = new ScheduledThreadPoolExecutor(2);        // åˆ›å»ºå¹¶æ‰§è¡Œåœ¨ç»™å®šå»¶è¿Ÿåå¯ç”¨çš„å•æ¬¡æ“ä½œã€‚        ScheduledFuture&lt;?&gt; scheduledFuture = scheduledThreadPoolExecutor.schedule(() -&gt; System.out.println(&quot;å®šæ—¶ä»»åŠ¡æ­£åœ¨è¢«æ‰§è¡Œ&gt;&gt;&gt;&quot;), 2L, TimeUnit.SECONDS);        // å°è¯•å–æ¶ˆæ‰§è¡Œæ­¤ä»»åŠ¡ã€‚        System.out.println(scheduledFuture.cancel(true));    &#125;    /**         æ‰§è¡Œç»“æœï¼š          true     */          /**     * å›ºå®šé¢‘ç‡å‘¨æœŸä»»åŠ¡     * æ³¨æ„ï¼šä¸€æ¬¡ä»»åŠ¡è¶…æ—¶ï¼Œä¼šæŒç»­çš„å½±å“åç»­çš„ä»»åŠ¡å‘¨æœŸï¼›     */    private static void scheduleAtFixedRate()&#123;        // è®¾ç½®æ ¸å¿ƒçº¿ç¨‹æ•°        ScheduledThreadPoolExecutor scheduledThreadPoolExecutor = new ScheduledThreadPoolExecutor(5);        scheduledThreadPoolExecutor.scheduleAtFixedRate(()-&gt;System.out.println(String.format(&quot;===å®šæ—¶ä»»åŠ¡çº¿ç¨‹ã€%sã€‘æ­£åœ¨æ‰§è¡Œï¼Œæ‰§è¡Œæ—¶é—´ï¼šã€%sã€‘===&quot;, Thread.currentThread().getName(),System.currentTimeMillis())),2,2,TimeUnit.SECONDS);        /**         æ‰§è¡Œç»“æœï¼š          ===å®šæ—¶ä»»åŠ¡çº¿ç¨‹ã€pool-1-thread-1ã€‘æ­£åœ¨æ‰§è¡Œï¼Œæ‰§è¡Œæ—¶é—´ï¼šã€1580728645370ã€‘===          ===å®šæ—¶ä»»åŠ¡çº¿ç¨‹ã€pool-1-thread-1ã€‘æ­£åœ¨æ‰§è¡Œï¼Œæ‰§è¡Œæ—¶é—´ï¼šã€1580728647372ã€‘===          ===å®šæ—¶ä»»åŠ¡çº¿ç¨‹ã€pool-1-thread-2ã€‘æ­£åœ¨æ‰§è¡Œï¼Œæ‰§è¡Œæ—¶é—´ï¼šã€1580728649372ã€‘===          ===å®šæ—¶ä»»åŠ¡çº¿ç¨‹ã€pool-1-thread-1ã€‘æ­£åœ¨æ‰§è¡Œï¼Œæ‰§è¡Œæ—¶é—´ï¼šã€1580728651374ã€‘===          ===å®šæ—¶ä»»åŠ¡çº¿ç¨‹ã€pool-1-thread-3ã€‘æ­£åœ¨æ‰§è¡Œï¼Œæ‰§è¡Œæ—¶é—´ï¼šã€1580728653371ã€‘===         */    &#125;    /**     * å›ºå®šå»¶è¿Ÿå‘¨æœŸä»»åŠ¡     * æ³¨æ„ï¼šå›ºå®šå»¶è¿Ÿå‘¨æœŸä»»åŠ¡ï¼Œå³æ¯æ¬¡ä»»åŠ¡ç»“æŸåï¼Œéœ€è¦å†åŠ ä¸Šç­‰å¾…å›ºå®šæ—¶é—´ï¼›     */    private static void scheduleWithFixedDelay()&#123;        // è®¾ç½®æ ¸å¿ƒçº¿ç¨‹æ•°        ScheduledThreadPoolExecutor scheduledThreadPoolExecutor = new ScheduledThreadPoolExecutor(5);        scheduledThreadPoolExecutor.scheduleWithFixedDelay(() -&gt; &#123;            System.out.println(String.format(&quot;===å®šæ—¶ä»»åŠ¡çº¿ç¨‹ã€%sã€‘æ­£åœ¨æ‰§è¡Œï¼Œæ‰§è¡Œæ—¶é—´ï¼šã€%sã€‘===&quot;, Thread.currentThread().getName(),System.currentTimeMillis()));            try &#123;                // ç¡çœ 5ç§’                TimeUnit.SECONDS.sleep(5);            &#125; catch (InterruptedException e) &#123;                e.printStackTrace();            &#125;        &#125;,1,2,TimeUnit.SECONDS);        /**         æ‰§è¡Œç»“æœï¼š         ===å®šæ—¶ä»»åŠ¡çº¿ç¨‹ã€pool-1-thread-1ã€‘æ­£åœ¨æ‰§è¡Œï¼Œæ‰§è¡Œæ—¶é—´ï¼šã€1580729087258ã€‘===         ===å®šæ—¶ä»»åŠ¡çº¿ç¨‹ã€pool-1-thread-1ã€‘æ­£åœ¨æ‰§è¡Œï¼Œæ‰§è¡Œæ—¶é—´ï¼šã€1580729094268ã€‘===         ===å®šæ—¶ä»»åŠ¡çº¿ç¨‹ã€pool-1-thread-2ã€‘æ­£åœ¨æ‰§è¡Œï¼Œæ‰§è¡Œæ—¶é—´ï¼šã€1580729101272ã€‘===         ===å®šæ—¶ä»»åŠ¡çº¿ç¨‹ã€pool-1-thread-1ã€‘æ­£åœ¨æ‰§è¡Œï¼Œæ‰§è¡Œæ—¶é—´ï¼šã€1580729108273ã€‘===         ===å®šæ—¶ä»»åŠ¡çº¿ç¨‹ã€pool-1-thread-3ã€‘æ­£åœ¨æ‰§è¡Œï¼Œæ‰§è¡Œæ—¶é—´ï¼šã€1580729115275ã€‘===         ===å®šæ—¶ä»»åŠ¡çº¿ç¨‹ã€pool-1-thread-3ã€‘æ­£åœ¨æ‰§è¡Œï¼Œæ‰§è¡Œæ—¶é—´ï¼šã€1580729122277ã€‘===         ===å®šæ—¶ä»»åŠ¡çº¿ç¨‹ã€pool-1-thread-3ã€‘æ­£åœ¨æ‰§è¡Œï¼Œæ‰§è¡Œæ—¶é—´ï¼šã€1580729129279ã€‘===         */    &#125;&#125;

1.3 ScheduledThreadPoolExecutorè¿è¡Œæœºåˆ¶&emsp;&emsp; ScheduledThreadPoolExecutor ä½¿ç”¨çš„ä»»åŠ¡é˜Ÿåˆ— DelayQueue å°è£…äº†ä¸€ä¸ª PriorityQueueï¼ŒPriorityQueue ä¼šå¯¹é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡è¿›è¡Œæ’åºï¼Œæ‰§è¡Œæ‰€éœ€æ—¶é—´çŸ­çš„æ”¾åœ¨å‰é¢å…ˆè¢«æ‰§è¡Œ(ScheduledFutureTask çš„ time å˜é‡å°çš„å…ˆæ‰§è¡Œ)ï¼Œå¦‚æœæ‰§è¡Œæ‰€éœ€æ—¶é—´ç›¸åŒåˆ™å…ˆæäº¤çš„ä»»åŠ¡å°†è¢«å…ˆæ‰§è¡Œ(ScheduledFutureTask çš„ squenceNumber å˜é‡å°çš„å…ˆæ‰§è¡Œ)ã€‚

ScheduledThreadPoolExecutor å’Œ Timer çš„æ¯”è¾ƒï¼š

Timer å¯¹ç³»ç»Ÿæ—¶é’Ÿçš„å˜åŒ–æ•æ„Ÿï¼ŒScheduledThreadPoolExecutorä¸æ˜¯ï¼›
Timer åªæœ‰ä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹ï¼Œå› æ­¤é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡å¯ä»¥å»¶è¿Ÿå…¶ä»–ä»»åŠ¡ã€‚ ScheduledThreadPoolExecutor å¯ä»¥é…ç½®ä»»æ„æ•°é‡çš„çº¿ç¨‹ã€‚ æ­¤å¤–ï¼Œå¦‚æœä½ æƒ³ï¼ˆé€šè¿‡æä¾› ThreadFactoryï¼‰ï¼Œä½ å¯ä»¥å®Œå…¨æ§åˆ¶åˆ›å»ºçš„çº¿ç¨‹;
åœ¨TimerTask ä¸­æŠ›å‡ºçš„è¿è¡Œæ—¶å¼‚å¸¸ä¼šæ€æ­»ä¸€ä¸ªçº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ Timer æ­»æœº:-( â€¦å³è®¡åˆ’ä»»åŠ¡å°†ä¸å†è¿è¡Œã€‚ScheduledThreadExecutor ä¸ä»…æ•è·è¿è¡Œæ—¶å¼‚å¸¸ï¼Œè¿˜å…è®¸æ‚¨åœ¨éœ€è¦æ—¶å¤„ç†å®ƒä»¬ï¼ˆé€šè¿‡é‡å†™ afterExecute æ–¹æ³•ThreadPoolExecutorï¼‰ã€‚æŠ›å‡ºå¼‚å¸¸çš„ä»»åŠ¡å°†è¢«å–æ¶ˆï¼Œä½†å…¶ä»–ä»»åŠ¡å°†ç»§ç»­è¿è¡Œã€‚


ScheduledThreadPoolExecutor çš„æ‰§è¡Œä¸»è¦åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼š

å½“è°ƒç”¨ ScheduledThreadPoolExecutor çš„ scheduleAtFixedRate() æ–¹æ³•æˆ–è€…scheduleWirhFixedDelay() æ–¹æ³•æ—¶ï¼Œä¼šå‘ ScheduledThreadPoolExecutor çš„ DelayQueue æ·»åŠ ä¸€ä¸ªå®ç°äº† RunnableScheduledFuture æ¥å£çš„ ScheduledFutureTask ã€‚  çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ä» DelayQueue ä¸­è·å– ScheduledFutureTaskï¼Œç„¶åæ‰§è¡Œä»»åŠ¡ã€‚


ScheduledThreadPoolExecutor ä¸ºäº†å®ç°å‘¨æœŸæ€§çš„æ‰§è¡Œä»»åŠ¡ï¼Œå¯¹ ThreadPoolExecutor åšäº†å¦‚ä¸‹ä¿®æ”¹ï¼š

ä½¿ç”¨ DelayQueue ä½œä¸ºä»»åŠ¡é˜Ÿåˆ—ï¼›
è·å–ä»»åŠ¡çš„æ–¹ä¸åŒ
æ‰§è¡Œå‘¨æœŸä»»åŠ¡åï¼Œå¢åŠ äº†é¢å¤–çš„å¤„ç†



1.4 ScheduledThreadPoolExecutor æ‰§è¡Œå‘¨æœŸä»»åŠ¡çš„æ­¥éª¤

çº¿ç¨‹ 1 ä» DelayQueue ä¸­è·å–å·²åˆ°æœŸçš„ ScheduledFutureTaskï¼ˆDelayQueue.take()ï¼‰ã€‚åˆ°æœŸä»»åŠ¡æ˜¯æŒ‡ ScheduledFutureTask çš„ time å¤§äºç­‰äºå½“å‰ç³»ç»Ÿçš„æ—¶é—´ï¼›
çº¿ç¨‹ 1 æ‰§è¡Œè¿™ä¸ª ScheduledFutureTaskï¼›
çº¿ç¨‹ 1 ä¿®æ”¹ ScheduledFutureTask çš„ time å˜é‡ä¸ºä¸‹æ¬¡å°†è¦è¢«æ‰§è¡Œçš„æ—¶é—´ï¼›
çº¿ç¨‹ 1 æŠŠè¿™ä¸ªä¿®æ”¹ time ä¹‹åçš„ ScheduledFutureTask æ”¾å› DelayQueue ä¸­ï¼ˆDelayQueue.add())ã€‚

 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(äºŒåä¸‰)Javaå¤šçº¿ç¨‹ä¹‹ScheduledThreadPoolExecutorå®šæ—¶æ‰§è¡Œä»»åŠ¡çº¿ç¨‹æ± ã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(äºŒåä¸€)Javaå¤šçº¿ç¨‹ä¹‹SingleThreadExecutorå•çº¿ç¨‹åŒ–çº¿ç¨‹æ± </title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E4%BA%8C%E5%8D%81%E4%B8%80)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BSingleThreadExecutor%E5%8D%95%E7%BA%BF%E7%A8%8B%E5%8C%96%E7%BA%BF%E7%A8%8B%E6%B1%A0/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(äºŒåä¸€)Javaå¤šçº¿ç¨‹ä¹‹SingleThreadExecutorå•çº¿ç¨‹åŒ–çº¿ç¨‹æ± 1.1 å•çº¿ç¨‹åŒ–çº¿ç¨‹æ± SingleThreadExecutor&emsp;&emsp; SingleThreadExecutor æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚é€šè¿‡æºä»£ç æŸ¥çœ‹SingleThreadExecutorå®ç°ï¼š
/** * Creates an Executor that uses a single worker thread operating * off an unbounded queue. (Note however that if this single * thread terminates due to a failure during execution prior to * shutdown, a new one will take its place if needed to execute * subsequent tasks.)  Tasks are guaranteed to execute * sequentially, and no more than one task will be active at any * given time. Unlike the otherwise equivalent * &#123;@code newFixedThreadPool(1)&#125; the returned executor is * guaranteed not to be reconfigurable to use additional threads. * * @return the newly created single-threaded Executor */public static ExecutorService newSingleThreadExecutor() &#123;    return new FinalizableDelegatedExecutorService        (new ThreadPoolExecutor(1, 1,                                0L, TimeUnit.MILLISECONDS,                                new LinkedBlockingQueue&lt;Runnable&gt;()));&#125;/** * Creates an Executor that uses a single worker thread operating * off an unbounded queue, and uses the provided ThreadFactory to * create a new thread when needed. Unlike the otherwise * equivalent &#123;@code newFixedThreadPool(1, threadFactory)&#125; the * returned executor is guaranteed not to be reconfigurable to use * additional threads. * * @param threadFactory the factory to use when creating new * threads * * @return the newly created single-threaded Executor * @throws NullPointerException if threadFactory is null */public static ExecutorService newSingleThreadExecutor(ThreadFactory threadFactory) &#123;    return new FinalizableDelegatedExecutorService        (new ThreadPoolExecutor(1, 1,                                0L, TimeUnit.MILLISECONDS,                                new LinkedBlockingQueue&lt;Runnable&gt;(),                                threadFactory));&#125;/** * Creates a &#123;@code LinkedBlockingQueue&#125; with a capacity of * &#123;@link Integer#MAX_VALUE&#125;. */public LinkedBlockingQueue() &#123;    this(Integer.MAX_VALUE);&#125;
åœ¨SingleThreadExecutorå®ç°ä¸­ï¼š

corePoolSize &amp;&amp; maximumPoolSizeï¼ŒcorePoolSize å’Œ maximumPoolSize éƒ½è¢«è®¾ç½®ä¸ºï¼š1ã€‚
keepAliveTime &#x3D;&gt; keepAliveTimeä¸º0ï¼Œæ„å‘³ç€å¤šä½™çš„ç©ºé—²çº¿ç¨‹ä¼šè¢«ç«‹å³ç»ˆæ­¢ã€‚
workQueue &#x3D;&gt; é‡‡ç”¨æ— ç•Œé˜Ÿåˆ—LinkedBlockingQueueä½œä¸ºçº¿ç¨‹æ± çš„å·¥ä½œé˜Ÿåˆ—ï¼ˆé˜Ÿåˆ—çš„å®¹é‡ä¸ºInteger.MAX_VALUEï¼‰ï¼Œä¼šåœ¨å¾ªç¯ä¸­åå¤ä»LinkedBlockingQueueè·å–ä»»åŠ¡æ¥æ‰§è¡Œã€‚

1.2 SingleThreadExecutorä½¿ç”¨æ ·ä¾‹
å•çº¿ç¨‹åŒ–çº¿ç¨‹æ± SingleThreadExecutorç‰¹ç‚¹ï¼š
åªæœ‰ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹ï¼ˆä¿è¯æ‰€æœ‰ä»»åŠ¡æŒ‰ç…§æŒ‡å®šé¡ºåºåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä¸éœ€è¦å¤„ç†çº¿ç¨‹åŒæ­¥çš„é—®é¢˜ï¼‰ã€‚
åº”ç”¨åœºæ™¯ï¼šä¸é€‚åˆå¹¶å‘ä½†å¯èƒ½å¼•èµ·IOé˜»å¡æ€§åŠå½±å“UIçº¿ç¨‹å“åº”çš„æ“ä½œï¼Œå¦‚æ•°æ®åº“æ“ä½œï¼Œæ–‡ä»¶æ“ä½œç­‰ã€‚


SingleThreadExecutorçš„æ„ä¹‰ï¼š
ç¼“å­˜çº¿ç¨‹ã€è¿›è¡Œæ± åŒ–ï¼Œå¯å®ç°çº¿ç¨‹é‡å¤åˆ©ç”¨ã€é¿å…é‡å¤åˆ›å»ºå’Œé”€æ¯æ‰€å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚
å½“çº¿ç¨‹è°ƒåº¦ä»»åŠ¡å‡ºç°å¼‚å¸¸æ—¶ï¼Œä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ›¿ä»£æ‰å‘ç”Ÿå¼‚å¸¸çš„çº¿ç¨‹ã€‚
ä»»åŠ¡æ‰§è¡ŒæŒ‰ç…§è§„å®šçš„è°ƒåº¦è§„åˆ™æ‰§è¡Œã€‚çº¿ç¨‹æ± é€šè¿‡é˜Ÿåˆ—å½¢å¼æ¥æ¥æ”¶ä»»åŠ¡ã€‚å†é€šè¿‡ç©ºé—²çº¿ç¨‹æ¥é€ä¸€å–å‡ºè¿›è¡Œä»»åŠ¡è°ƒåº¦ã€‚å³çº¿ç¨‹æ± å¯ä»¥æ§åˆ¶ä»»åŠ¡è°ƒåº¦çš„æ‰§è¡Œé¡ºåºã€‚
å¯åˆ¶å®šæ‹’ç»ç­–ç•¥ã€‚å³ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡æ—¶ï¼Œåæ¥ä»»åŠ¡çš„æ‹’ç»å¤„ç†è§„åˆ™ã€‚



package com.yuanxw.chapter21;import java.util.Random;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.TimeUnit;import java.util.stream.IntStream;public class ScheduledThreadPoolExample &#123;    // éšæœºæ•°ï¼šä½¿ç”¨longå‚æ•°çš„æ‰€æœ‰64ä½ä½œä¸ºå› å­å€¼ã€‚    private static Random random = new Random(System.currentTimeMillis());    public static void main(String[] args) &#123;        // ä½¿ç”¨Executorsåˆ›å»ºå•ä¸ªworkerçº¿ç¨‹çš„Executor        ExecutorService executorService = Executors.newSingleThreadExecutor();        // å§‹ç»ˆåªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰§è¡ŒScheduledThreadPoolExample#processTaskæ–¹æ³•        IntStream.range(1, 10).forEach(i -&gt; executorService.execute(ScheduledThreadPoolExample::processTask));        // corePoolSize å’Œ maximumPoolSizeéƒ½æ˜¯ï¼š1ï¼Œå› æ­¤åº”ç”¨ç¨‹åºä¸ä¼šç»“æŸï¼Œéœ€è¦è°ƒç”¨executorService.shutdown()æ–¹æ³•ï¼Œå…³é—­çº¿ç¨‹æ± ã€‚        executorService.shutdown();    &#125;    /**     * çº¿ç¨‹ä¼‘çœ çš„æ–¹æ³•     */    private static void processTask() &#123;        try &#123;            long start = System.currentTimeMillis();            TimeUnit.SECONDS.sleep(random.nextInt(5));            long end = System.currentTimeMillis();            System.out.println(String.format(&quot;ã€%sã€‘çº¿ç¨‹æ‰§è¡Œç»“æŸï¼Œè€—æ—¶ã€%sã€‘ç§’&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;, Thread.currentThread().getName(),((end - start)/1000)));        &#125; catch (InterruptedException e) &#123;            e.printStackTrace();        &#125;    &#125;&#125;
æ‰§è¡Œç»“æœï¼š
ã€pool-1-thread-1ã€‘çº¿ç¨‹æ‰§è¡Œç»“æŸï¼Œè€—æ—¶ã€1ã€‘ç§’&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;ã€pool-1-thread-1ã€‘çº¿ç¨‹æ‰§è¡Œç»“æŸï¼Œè€—æ—¶ã€2ã€‘ç§’&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;ã€pool-1-thread-1ã€‘çº¿ç¨‹æ‰§è¡Œç»“æŸï¼Œè€—æ—¶ã€4ã€‘ç§’&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;ã€pool-1-thread-1ã€‘çº¿ç¨‹æ‰§è¡Œç»“æŸï¼Œè€—æ—¶ã€2ã€‘ç§’&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;ã€pool-1-thread-1ã€‘çº¿ç¨‹æ‰§è¡Œç»“æŸï¼Œè€—æ—¶ã€3ã€‘ç§’&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;ã€pool-1-thread-1ã€‘çº¿ç¨‹æ‰§è¡Œç»“æŸï¼Œè€—æ—¶ã€1ã€‘ç§’&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;ã€pool-1-thread-1ã€‘çº¿ç¨‹æ‰§è¡Œç»“æŸï¼Œè€—æ—¶ã€1ã€‘ç§’&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;ã€pool-1-thread-1ã€‘çº¿ç¨‹æ‰§è¡Œç»“æŸï¼Œè€—æ—¶ã€4ã€‘ç§’&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;ã€pool-1-thread-1ã€‘çº¿ç¨‹æ‰§è¡Œç»“æŸï¼Œè€—æ—¶ã€3ã€‘ç§’&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;

SingleThreadExecutor çš„ execute()æ–¹æ³•çš„æ‰§è¡Œç¤ºæ„å›¾ï¼ˆè¯¥å›¾ç‰‡æ¥æºï¼šã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹ï¼‰ï¼š

å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å°‘äº corePoolSizeï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼›
å½“å‰çº¿ç¨‹æ± ä¸­æœ‰ä¸€ä¸ªè¿è¡Œçš„çº¿ç¨‹åï¼Œå°†ä»»åŠ¡åŠ å…¥ LinkedBlockingQueue
çº¿ç¨‹æ‰§è¡Œå®Œå½“å‰çš„ä»»åŠ¡åï¼Œä¼šåœ¨å¾ªç¯ä¸­åå¤ä» LinkedBlockingQueue ä¸­è·å–ä»»åŠ¡æ¥æ‰§è¡Œï¼›

 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(äºŒåä¸€)Javaå¤šçº¿ç¨‹ä¹‹SingleThreadExecutorå•çº¿ç¨‹åŒ–çº¿ç¨‹æ± ã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(äºŒåäºŒ)Javaå¤šçº¿ç¨‹ä¹‹WorkStealingPoolå·¥ä½œçªƒå–çº¿ç¨‹æ± </title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E4%BA%8C%E5%8D%81%E4%BA%8C)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BWorkStealingPool%E5%B7%A5%E4%BD%9C%E7%AA%83%E5%8F%96%E7%BA%BF%E7%A8%8B%E6%B1%A0/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(äºŒåäºŒ)Javaå¤šçº¿ç¨‹ä¹‹WorkStealingPoolå·¥ä½œçªƒå–çº¿ç¨‹æ± 1.1 å·¥ä½œçªƒå–çº¿ç¨‹æ± WorkStealingPool&emsp;&emsp; åœ¨Java 8ä¸­ï¼Œå¼•å…¥äº†ä¸€ç§æ–°å‹çš„çº¿ç¨‹æ± ï¼Œä½œä¸ºnewWorkStealingPool()æ¥è¡¥å……ç°æœ‰çš„çº¿ç¨‹æ± ã€‚WorkStealingPoolçº¿ç¨‹æ± ï¼Œæ¥ç»´æŒç›¸åº”çš„å¹¶è¡Œçº§åˆ«ï¼Œå®ƒä¼šé€šè¿‡å·¥ä½œçªƒå–çš„æ–¹å¼ï¼Œä½¿å¾—å¤šæ ¸çš„ CPU ä¸ä¼šé—²ç½®ï¼Œæ€»ä¼šæœ‰æ´»ç€çš„çº¿ç¨‹è®© CPU å»è¿è¡Œã€‚
&emsp;&emsp;é¡¾åæ€ä¹‰ï¼Œå®ƒåŸºäº  å·¥ä½œçªƒå–ç®—æ³•ï¼Œå…¶ä¸­ä»»åŠ¡å¯ä»¥ç”Ÿæˆå…¶ä»–è¾ƒå°çš„ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡å°†æ·»åŠ åˆ°å¹¶è¡Œå¤„ç†çº¿ç¨‹çš„é˜Ÿåˆ—ä¸­ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹å®Œæˆäº†å·¥ä½œå¹¶ä¸”æ— äº‹å¯åšï¼Œåˆ™å¯ä»¥ä»å¦ä¸€çº¿ç¨‹çš„é˜Ÿåˆ—ä¸­â€œçªƒå–â€å·¥ä½œã€‚é€šè¿‡æºä»£ç æŸ¥çœ‹WorkStealingPoolå®ç°ï¼š
/** * Creates a work-stealing thread pool using all * &#123;@link Runtime#availableProcessors available processors&#125; * as its target parallelism level. * @return the newly created thread pool * @see #newWorkStealingPool(int) * @since 1.8 */public static ExecutorService newWorkStealingPool() &#123;    return new ForkJoinPool        (Runtime.getRuntime().availableProcessors(),         ForkJoinPool.defaultForkJoinWorkerThreadFactory,         null, true);&#125;/** * Creates a thread pool that maintains enough threads to support * the given parallelism level, and may use multiple queues to * reduce contention. The parallelism level corresponds to the * maximum number of threads actively engaged in, or available to * engage in, task processing. The actual number of threads may * grow and shrink dynamically. A work-stealing pool makes no * guarantees about the order in which submitted tasks are * executed. * * @param parallelism the targeted parallelism level * @return the newly created thread pool * @throws IllegalArgumentException if &#123;@code parallelism &lt;= 0&#125; * @since 1.8 */public static ExecutorService newWorkStealingPool(int parallelism) &#123;    return new ForkJoinPool        (parallelism,         ForkJoinPool.defaultForkJoinWorkerThreadFactory,         null, true);&#125;
åœ¨WorkStealingPoolå®ç°ä¸­ï¼š

parallelism &#x3D;&gt; Runtime.getRuntime().availableProcessors() - è¿™æ˜¯JVMå¯ç”¨çš„å¤„ç†å™¨æ•°ã€‚
handler &#x3D;&gt; ForkJoinPool.defaultForkJoinWorkerThreadFactory - è¿”å›æ–°çº¿ç¨‹çš„é»˜è®¤çº¿ç¨‹å·¥å‚ã€‚
asyncMode &#x3D;&gt; true â€“ ä½¿å…¶åœ¨aysncæ¨¡å¼ä¸‹å·¥ä½œï¼Œå¹¶ä¸ºåˆ†å‰çš„ä»»åŠ¡è®¾ç½®FIFOé¡ºåºï¼Œè¿™äº›ä»»åŠ¡æ°¸è¿œä¸ä¼šä»å…¶å·¥ä½œé˜Ÿåˆ—ä¸­åŠ å…¥ã€‚


1.2 WorkStealingPoolä½¿ç”¨æ ·ä¾‹
å•çº¿ç¨‹åŒ–çº¿ç¨‹æ± WorkStealingPoolç‰¹ç‚¹ï¼š
WorkStealingPoolæ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œä½¿ç”¨ForkJoinPoolå®ç°çš„WorkStealingPoolæ ¹æ®å½“å‰æ“ä½œç³»ç»Ÿçš„CPUæœ‰å‡ ä¸ªæ ¸å°±ä¼šåˆ›å»ºå‡ ä¸ªçº¿ç¨‹ã€‚
åº”ç”¨åœºæ™¯ï¼šWorkStealingPoolèƒ½å¤Ÿåˆç†çš„ä½¿ç”¨CPUè¿›è¡Œå¯¹ä»»åŠ¡æ“ä½œï¼ˆå¹¶è¡Œæ“ä½œï¼‰é€‚åˆä½¿ç”¨åœ¨å¾ˆè€—æ—¶çš„æ“ä½œã€‚



package com.yuanxw.chapter22;import java.util.List;import java.util.concurrent.Callable;import java.util.concurrent.ExecutionException;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.TimeUnit;import java.util.stream.Collectors;import java.util.stream.IntStream;/** * ä½¿ç”¨WorkStealingPoolå·¥ä½œçªƒå–çº¿ç¨‹æ± ï¼Œåˆ›å»ºCallableç±»å‹çš„å¤šçº¿ç¨‹ï¼Œå¹¶æœ€ç»ˆè¿”å›ç»“æœ * https://blog.csdn.net/yuan_xw/article/details/103730628 */public class WorkStealingPoolExample &#123;    public static void main(String[] args) throws InterruptedException &#123;        System.out.println(&quot;è·å¾—JAVAè™šæ‹Ÿæœºå¯ç”¨çš„æœ€å¤§CPUå¤„ç†å™¨æ•°é‡ï¼š&quot; + Runtime.getRuntime().availableProcessors());        ExecutorService executorService = Executors.newWorkStealingPool();        /**         * callæ–¹æ³•å­˜åœ¨è¿”å›å€¼futureTaskçš„getæ–¹æ³•å¯ä»¥è·å–è¿™ä¸ªè¿”å›å€¼ã€‚         * ä½¿ç”¨æ­¤ç§æ–¹æ³•å®ç°çº¿ç¨‹çš„å¥½å¤„æ˜¯å½“ä½ åˆ›å»ºçš„ä»»åŠ¡çš„ç»“æœä¸æ˜¯ç«‹å³å°±è¦æ—¶ï¼Œ         * ä½ å¯ä»¥æäº¤ä¸€ä¸ªçº¿ç¨‹åœ¨åå°æ‰§è¡Œï¼Œè€Œä½ çš„ç¨‹åºä»å¯ä»¥æ­£å¸¸è¿è¡Œä¸‹å»ï¼Œ         * åœ¨éœ€è¦æ‰§è¡Œç»“æœæ—¶ä½¿ç”¨futureTaskå»è·å–å³å¯ã€‚         */        List&lt;Callable&lt;String&gt;&gt; callableList = IntStream.range(0, 20).boxed().map(i -&gt; (Callable&lt;String&gt;) () -&gt; &#123;            TimeUnit.SECONDS.sleep(3);            System.out.println(String.format(&quot;å½“å‰ã€%sã€‘çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ&gt;&gt;&gt;&quot;, Thread.currentThread().getName()));            return &quot;callable type thread taskï¼š&quot; + i;        &#125;).collect(Collectors.toList());        // æ‰§è¡Œç»™å®šçš„ä»»åŠ¡ï¼Œè¿”å›æŒæœ‰ä»–ä»¬çš„çŠ¶æ€å’Œç»“æœçš„æ‰€æœ‰å®Œæˆçš„æœŸå¾…åˆ—è¡¨ã€‚        executorService.invokeAll(callableList).stream().map(futureTask-&gt; &#123;            try &#123;                return futureTask.get();            &#125; catch (InterruptedException e) &#123;                e.printStackTrace();            &#125; catch (ExecutionException e) &#123;                e.printStackTrace();            &#125;            return null;        &#125;).forEach(System.out::println);    &#125;&#125;
æ‰§è¡Œç»“æœï¼š
è·å¾—JAVAè™šæ‹Ÿæœºå¯ç”¨çš„æœ€å¤§CPUå¤„ç†å™¨æ•°é‡ï¼š8å½“å‰ã€ForkJoinPool-1-worker-0ã€‘çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ&gt;&gt;&gt;å½“å‰ã€ForkJoinPool-1-worker-6ã€‘çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ&gt;&gt;&gt;å½“å‰ã€ForkJoinPool-1-worker-1ã€‘çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ&gt;&gt;&gt;å½“å‰ã€ForkJoinPool-1-worker-3ã€‘çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ&gt;&gt;&gt;å½“å‰ã€ForkJoinPool-1-worker-5ã€‘çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ&gt;&gt;&gt;å½“å‰ã€ForkJoinPool-1-worker-7ã€‘çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ&gt;&gt;&gt;å½“å‰ã€ForkJoinPool-1-worker-2ã€‘çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ&gt;&gt;&gt;å½“å‰ã€ForkJoinPool-1-worker-4ã€‘çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ&gt;&gt;&gt;å½“å‰ã€ForkJoinPool-1-worker-1ã€‘çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ&gt;&gt;&gt;å½“å‰ã€ForkJoinPool-1-worker-3ã€‘çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ&gt;&gt;&gt;å½“å‰ã€ForkJoinPool-1-worker-2ã€‘çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ&gt;&gt;&gt;å½“å‰ã€ForkJoinPool-1-worker-5ã€‘çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ&gt;&gt;&gt;å½“å‰ã€ForkJoinPool-1-worker-6ã€‘çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ&gt;&gt;&gt;å½“å‰ã€ForkJoinPool-1-worker-0ã€‘çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ&gt;&gt;&gt;å½“å‰ã€ForkJoinPool-1-worker-7ã€‘çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ&gt;&gt;&gt;å½“å‰ã€ForkJoinPool-1-worker-4ã€‘çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ&gt;&gt;&gt;å½“å‰ã€ForkJoinPool-1-worker-1ã€‘çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ&gt;&gt;&gt;å½“å‰ã€ForkJoinPool-1-worker-2ã€‘çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ&gt;&gt;&gt;å½“å‰ã€ForkJoinPool-1-worker-5ã€‘çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ&gt;&gt;&gt;å½“å‰ã€ForkJoinPool-1-worker-3ã€‘çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ&gt;&gt;&gt;callable type thread taskï¼š0callable type thread taskï¼š1callable type thread taskï¼š2callable type thread taskï¼š3callable type thread taskï¼š4callable type thread taskï¼š5callable type thread taskï¼š6callable type thread taskï¼š7callable type thread taskï¼š8callable type thread taskï¼š9callable type thread taskï¼š10callable type thread taskï¼š11callable type thread taskï¼š12callable type thread taskï¼š13callable type thread taskï¼š14callable type thread taskï¼š15callable type thread taskï¼š16callable type thread taskï¼š17callable type thread taskï¼š18callable type thread taskï¼š19



 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(äºŒåäºŒ)Javaå¤šçº¿ç¨‹ä¹‹WorkStealingPoolå·¥ä½œçªƒå–çº¿ç¨‹æ± ã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVA å¤šçº¿ç¨‹(äºŒåäº”)Java å¤šçº¿ç¨‹ä¹‹ ArrayBlockingQueue å®¹å™¨</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E4%BA%8C%E5%8D%81%E4%BA%94)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BArrayBlockingQueue%E5%AE%B9%E5%99%A8/</url>
    <content><![CDATA[1.JAVA å¤šçº¿ç¨‹(äºŒåäº”)Java å¤šçº¿ç¨‹ä¹‹ ArrayBlockingQueue å®¹å™¨1.1 ä»€ä¹ˆæ˜¯ BlockingQueue&emsp;&emsp;é˜»å¡é˜Ÿåˆ—ï¼ˆBlockingQueueï¼‰è¢«å¹¿æ³›ä½¿ç”¨åœ¨â€œç”Ÿäº§è€…-æ¶ˆè´¹è€…â€é—®é¢˜ä¸­ï¼Œå…¶åŸå› æ˜¯ BlockingQueue æä¾›äº†å¯é˜»å¡çš„æ’å…¥å’Œç§»é™¤çš„æ–¹æ³•ã€‚å½“é˜Ÿåˆ—å®¹å™¨å·²æ»¡ï¼Œç”Ÿäº§è€…çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—æœªæ»¡ï¼›å½“é˜Ÿåˆ—å®¹å™¨ä¸ºç©ºæ—¶ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œç›´è‡³é˜Ÿåˆ—éç©ºæ—¶ä¸ºæ­¢ã€‚
BlockingQueue å’Œ ArrayBlockingQueue ä¹‹é—´çš„å…³ç³»ï¼š&emsp;&emsp;BlockingQueue æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç»§æ‰¿è‡ª Queueï¼Œæ‰€ä»¥å…¶å®ç°ç±»ä¹Ÿå¯ä»¥ä½œä¸º Queue çš„å®ç°æ¥ä½¿ç”¨ï¼Œè€Œ Queue åˆç»§æ‰¿è‡ª Collection æ¥å£ã€‚ä¸‹é¢æ˜¯ BlockingQueue ç»§æ‰¿ç»“æ„å…³ç³»å›¾ï¼š
1.2 ArrayBlockingQueue æœ‰ç•Œçš„é˜»å¡é˜Ÿåˆ—&emsp;&emsp;ArrayBlockingQueue æ˜¯ BlockingQueue æ¥å£çš„æœ‰ç•Œé˜Ÿåˆ—å®ç°ç±»ï¼Œåº•å±‚é‡‡ç”¨æ•°ç»„æ¥å®ç°ã€‚ArrayBlockingQueue ä¸€æ—¦åˆ›å»ºï¼Œå®¹é‡ä¸èƒ½æ”¹å˜ã€‚å…¶å¹¶å‘æ§åˆ¶é‡‡ç”¨å¯é‡å…¥é”æ¥æ§åˆ¶ï¼Œä¸ç®¡æ˜¯æ’å…¥æ“ä½œè¿˜æ˜¯è¯»å–æ“ä½œï¼Œéƒ½éœ€è¦è·å–åˆ°é”æ‰èƒ½è¿›è¡Œæ“ä½œã€‚å½“é˜Ÿåˆ—å®¹é‡æ»¡æ—¶ï¼Œå°è¯•å°†å…ƒç´ æ”¾å…¥é˜Ÿåˆ—å°†å¯¼è‡´æ“ä½œé˜»å¡;å°è¯•ä»ä¸€ä¸ªç©ºé˜Ÿåˆ—ä¸­å–ä¸€ä¸ªå…ƒç´ ä¹Ÿä¼šåŒæ ·é˜»å¡ã€‚
ArrayBlockingQueue é»˜è®¤æƒ…å†µä¸‹ä¸èƒ½ä¿è¯çº¿ç¨‹è®¿é—®é˜Ÿåˆ—çš„å…¬å¹³æ€§ï¼Œæ‰€è°“å…¬å¹³æ€§æ˜¯æŒ‡ä¸¥æ ¼æŒ‰ç…§çº¿ç¨‹ç­‰å¾…çš„ç»å¯¹æ—¶é—´é¡ºåºï¼Œå³æœ€å…ˆç­‰å¾…çš„çº¿ç¨‹èƒ½å¤Ÿæœ€å…ˆè®¿é—®åˆ° ArrayBlockingQueueã€‚è€Œéå…¬å¹³æ€§åˆ™æ˜¯æŒ‡è®¿é—® ArrayBlockingQueue çš„é¡ºåºä¸æ˜¯éµå®ˆä¸¥æ ¼çš„æ—¶é—´é¡ºåºï¼Œæœ‰å¯èƒ½å­˜åœ¨ï¼Œå½“ ArrayBlockingQueue å¯ä»¥è¢«è®¿é—®æ—¶ï¼Œé•¿æ—¶é—´é˜»å¡çš„çº¿ç¨‹ä¾ç„¶æ— æ³•è®¿é—®åˆ° ArrayBlockingQueueã€‚å¦‚æœä¿è¯å…¬å¹³æ€§ï¼Œé€šå¸¸ä¼šé™ä½ååé‡ã€‚é€šè¿‡æºä»£ç æŸ¥çœ‹ ArrayBlockingQueue å®ç°ï¼š
/** * åˆ›å»ºå…·æœ‰ç»™å®šï¼ˆå›ºå®šï¼‰å®¹é‡å’Œé»˜è®¤è®¿é—®ç­–ç•¥çš„ ArrayBlockingQueue ã€‚ * Creates an &#123;@code ArrayBlockingQueue&#125; with the given (fixed) * capacity and default access policy. * * @param capacity the capacity of this queue * @throws IllegalArgumentException if &#123;@code capacity &lt; 1&#125; */public ArrayBlockingQueue(int capacity) &#123;    this(capacity, false);&#125;/** * åˆ›å»ºä¸€ä¸ª ArrayBlockingQueueå…·æœ‰ç»™å®šï¼ˆå›ºå®šï¼‰å®¹é‡å’ŒæŒ‡å®šè®¿é—®ç­–ç•¥ã€‚ * å¦‚æœtrueç„¶åå¯¹æ’å…¥æˆ–åˆ é™¤é˜»å¡çš„çº¿ç¨‹è¿›è¡Œé˜Ÿåˆ—è®¿é—®ï¼Œåˆ™æŒ‰FIFOé¡ºåºå¤„ç†; å¦‚æœfalseè®¿é—®é¡ºåºæœªæŒ‡å®šã€‚ * Creates an &#123;@code ArrayBlockingQueue&#125; with the given (fixed) * capacity and the specified access policy. * * @param capacity the capacity of this queue * @param fair if &#123;@code true&#125; then queue accesses for threads blocked *        on insertion or removal, are processed in FIFO order; *        if &#123;@code false&#125; the access order is unspecified. * @throws IllegalArgumentException if &#123;@code capacity &lt; 1&#125; */public ArrayBlockingQueue(int capacity, boolean fair) &#123;    if (capacity &lt;= 0)        throw new IllegalArgumentException();    this.items = new Object[capacity];    lock = new ReentrantLock(fair);    notEmpty = lock.newCondition();    notFull =  lock.newCondition();&#125;/** * åˆ›å»ºä¸€ä¸ª ArrayBlockingQueueå…·æœ‰ç»™å®šï¼ˆå›ºå®šï¼‰å®¹é‡ï¼ŒæŒ‡å®šè®¿é—®ç­–ç•¥å’Œæœ€åˆåŒ…å«ç»™å®šé›†åˆä¸­çš„å…ƒç´ ï¼Œæ·»åŠ åœ¨æ”¶é›†* è¿­ä»£å™¨çš„éå†é¡ºåºã€‚ * Creates an &#123;@code ArrayBlockingQueue&#125; with the given (fixed) * capacity, the specified access policy and initially containing the * elements of the given collection, * added in traversal order of the collection&#x27;s iterator. * * @param capacity the capacity of this queue * @param fair if &#123;@code true&#125; then queue accesses for threads blocked *        on insertion or removal, are processed in FIFO order; *        if &#123;@code false&#125; the access order is unspecified. * @param c the collection of elements to initially contain * @throws IllegalArgumentException if &#123;@code capacity&#125; is less than *         &#123;@code c.size()&#125;, or less than 1. * @throws NullPointerException if the specified collection or any *         of its elements are null */public ArrayBlockingQueue(int capacity, boolean fair,                          Collection&lt;? extends E&gt; c) &#123;    this(capacity, fair);    final ReentrantLock lock = this.lock;    lock.lock(); // Lock only for visibility, not mutual exclusion    try &#123;        int i = 0;        try &#123;            for (E e : c) &#123;                checkNotNull(e);                items[i++] = e;            &#125;        &#125; catch (ArrayIndexOutOfBoundsException ex) &#123;            throw new IllegalArgumentException();        &#125;        count = i;        putIndex = (i == capacity) ? 0 : i;    &#125; finally &#123;        lock.unlock();    &#125;&#125;

1.3 ArrayBlockingQueue æœ‰ç•Œçš„é˜»å¡é˜Ÿåˆ—ç‰¹ç‚¹
ArrayBlockingQueue æ˜¯ä¸€ä¸ªç”¨æ•°ç»„å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œæ­¤é˜Ÿåˆ—æŒ‰ç…§å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚
ArrayBlockingQueue æ˜¯åŸºäºæ•°ç»„å®ç°çš„ï¼Œä¹Ÿå°±å…·æœ‰æ•°ç»„çš„ç‰¹æ€§ï¼šä¸€æ—¦åˆå§‹åŒ–ï¼Œå¤§å°å°±æ— æ³•ä¿®æ”¹ã€‚

1.4 å¸¸ç”¨çš„æ–¹æ³•package com.yuanxw.thread.chapter25;import java.util.concurrent.ArrayBlockingQueue;import java.util.concurrent.Executors;import java.util.concurrent.TimeUnit;public class ArrayBlockingQueueExample &#123;    public static void main(String[] args) throws InterruptedException &#123;        // add();        // offer();        // put();        // poll();        // peek();        // element();        remove();    &#125;    /**     * å¦‚æœå¯ä»¥åœ¨ä¸è¶…è¿‡é˜Ÿåˆ—çš„å®¹é‡çš„æƒ…å†µä¸‹ç«‹å³å°†å…¶æŒ‡å®šçš„å…ƒç´ æ’å…¥åˆ°è¯¥é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œ     * å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™è¿”å› trueå¹¶æŠ›å‡º IllegalStateException ã€‚     * æ‰§è¡Œç»“æœï¼š     *     =====æ‰§è¡Œadd()ç­¾åæ–¹æ³•-å¼€å§‹=====     *     arrayBlockingQueue.add()æ‰§è¡Œè¿”å›ç»“æœï¼štrue     *     arrayBlockingQueue.add()æ‰§è¡Œè¿”å›ç»“æœï¼štrue     *     arrayBlockingQueue.add()æ‰§è¡Œè¿”å›ç»“æœï¼štrue     *     Exception in thread &quot;main&quot; java.lang.IllegalStateException: Queue full     *     at java.util.AbstractQueue.add(AbstractQueue.java:98)     *     at java.util.concurrent.ArrayBlockingQueue.add(ArrayBlockingQueue.java:312)     *     at com.yuanxw.thread.chapter25.ArrayBlockingQueueExample.add(ArrayBlockingQueueExample.java:28)     *     at com.yuanxw.thread.chapter25.ArrayBlockingQueueExample.main(ArrayBlockingQueueExample.java:7)     */    public static void add() &#123;        System.out.println(&quot;=====æ‰§è¡Œadd()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        ArrayBlockingQueue arrayBlockingQueue = new ArrayBlockingQueue(3);        System.out.println(&quot;arrayBlockingQueue.add()æ‰§è¡Œè¿”å›ç»“æœï¼š&quot;+arrayBlockingQueue.add(&quot;Message 1&quot;));        System.out.println(&quot;arrayBlockingQueue.add()æ‰§è¡Œè¿”å›ç»“æœï¼š&quot;+arrayBlockingQueue.add(&quot;Message 2&quot;));        System.out.println(&quot;arrayBlockingQueue.add()æ‰§è¡Œè¿”å›ç»“æœï¼š&quot;+arrayBlockingQueue.add(&quot;Message 3&quot;));        System.out.println(&quot;arrayBlockingQueue.add()æ‰§è¡Œè¿”å›ç»“æœï¼š&quot;+arrayBlockingQueue.add(&quot;Message 4&quot;));        System.out.println(&quot;=====æ‰§è¡Œadd()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**      * å¦‚æœå¯ä»¥åœ¨ä¸è¶…è¿‡é˜Ÿåˆ—å®¹é‡çš„æƒ…å†µä¸‹ç«‹å³å°†å…¶æŒ‡å®šçš„å…ƒç´ æ’å…¥è¯¥é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œ      * åˆ™åœ¨æˆåŠŸæ—¶trueå¦‚æœè¯¥é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™è¿”å›false ã€‚      * æ‰§è¡Œç»“æœï¼š      *  =====æ‰§è¡Œoffer()ç­¾åæ–¹æ³•-å¼€å§‹=====      *  arrayBlockingQueue.offer()æ‰§è¡Œè¿”å›ç»“æœï¼štrue      *  arrayBlockingQueue.offer()æ‰§è¡Œè¿”å›ç»“æœï¼štrue      *  arrayBlockingQueue.offer()æ‰§è¡Œè¿”å›ç»“æœï¼štrue      *  arrayBlockingQueue.offer()æ‰§è¡Œè¿”å›ç»“æœï¼šfalse      *  =====æ‰§è¡Œoffer()ç­¾åæ–¹æ³•-ç»“æŸ=====      */    public static void offer()&#123;        System.out.println(&quot;=====æ‰§è¡Œoffer()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        ArrayBlockingQueue arrayBlockingQueue = new ArrayBlockingQueue(3);        System.out.println(&quot;arrayBlockingQueue.offer()æ‰§è¡Œè¿”å›ç»“æœï¼š&quot;+arrayBlockingQueue.offer(&quot;Message 1&quot;));        System.out.println(&quot;arrayBlockingQueue.offer()æ‰§è¡Œè¿”å›ç»“æœï¼š&quot;+arrayBlockingQueue.offer(&quot;Message 2&quot;));        System.out.println(&quot;arrayBlockingQueue.offer()æ‰§è¡Œè¿”å›ç»“æœï¼š&quot;+arrayBlockingQueue.offer(&quot;Message 3&quot;));        System.out.println(&quot;arrayBlockingQueue.offer()æ‰§è¡Œè¿”å›ç»“æœï¼š&quot;+arrayBlockingQueue.offer(&quot;Message 4&quot;));        System.out.println(&quot;=====æ‰§è¡Œoffer()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**      * åœ¨è¯¥é˜Ÿåˆ—çš„å°¾éƒ¨æ’å…¥æŒ‡å®šçš„å…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™ç­‰å¾…ç©ºé—´å˜ä¸ºå¯ç”¨ã€‚      *  æ‰§è¡Œç»“æœï¼š      *   =====æ‰§è¡Œput()ç­¾åæ–¹æ³•-å¼€å§‹=====      *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼š3      *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­çš„å®¹é‡ï¼š0      *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­take()æ•°æ®å€¼ä¸ºï¼šMessage 1      *   Message 2      *   Message 3      *   Message 4      *   =====æ‰§è¡Œput()ç­¾åæ–¹æ³•-ç»“æŸ=====     */    public static void put() throws InterruptedException &#123;        System.out.println(&quot;=====æ‰§è¡Œput()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        ArrayBlockingQueue arrayBlockingQueue = new ArrayBlockingQueue(3);        arrayBlockingQueue.put(&quot;Message 1&quot;);        arrayBlockingQueue.put(&quot;Message 2&quot;);        arrayBlockingQueue.put(&quot;Message 3&quot;);        Executors.newSingleThreadExecutor().execute(()-&gt;&#123;            System.out.println(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼š&quot; + arrayBlockingQueue.size());            System.out.println(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­çš„å®¹é‡ï¼š&quot; + arrayBlockingQueue.remainingCapacity());            try &#123;                TimeUnit.SECONDS.sleep(5);                // æ£€ç´¢å¹¶åˆ é™¤æ­¤é˜Ÿåˆ—çš„å¤´                Object take = arrayBlockingQueue.take();                System.out.println(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­take()æ•°æ®å€¼ä¸ºï¼š&quot; + take);            &#125; catch (InterruptedException e) &#123;                e.printStackTrace();            &#125;        &#125;);        arrayBlockingQueue.put(&quot;Message 4&quot;);        arrayBlockingQueue.forEach(System.out::println);        System.out.println(&quot;=====æ‰§è¡Œput()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**      * æ£€ç´¢å¹¶åˆ é™¤æ­¤é˜Ÿåˆ—çš„å¤´ï¼Œåˆ™ç­‰å¾…ç©ºé—´å˜ä¸ºå¯ç”¨ã€‚      *  æ‰§è¡Œç»“æœï¼š      *   =====æ‰§è¡Œpoll()ç­¾åæ–¹æ³•-å¼€å§‹=====      *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€3ã€‘,å®¹é‡ï¼šã€0ã€‘      *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼šMessage 1      *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼šMessage 2      *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€1ã€‘,å®¹é‡ï¼šã€2ã€‘      *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼šMessage 3      *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼šnull      *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼šnull      *   =====æ‰§è¡Œpoll()ç­¾åæ–¹æ³•-ç»“æŸ=====     */    public static void poll() throws InterruptedException &#123;        System.out.println(&quot;=====æ‰§è¡Œpoll()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        ArrayBlockingQueue arrayBlockingQueue = new ArrayBlockingQueue(3);        arrayBlockingQueue.put(&quot;Message 1&quot;);        arrayBlockingQueue.put(&quot;Message 2&quot;);        arrayBlockingQueue.put(&quot;Message 3&quot;);        System.out.println(String.format(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, arrayBlockingQueue.size(),arrayBlockingQueue.remainingCapacity()));        System.out.println(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼š&quot; + arrayBlockingQueue.poll());        System.out.println(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼š&quot; + arrayBlockingQueue.poll());        System.out.println(String.format(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, arrayBlockingQueue.size(),arrayBlockingQueue.remainingCapacity()));        System.out.println(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼š&quot; + arrayBlockingQueue.poll());        System.out.println(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼š&quot; + arrayBlockingQueue.poll());        System.out.println(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼š&quot; + arrayBlockingQueue.poll());        System.out.println(&quot;=====æ‰§è¡Œpoll()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**      * æ£€ç´¢ä½†ä¸åˆ é™¤æ­¤é˜Ÿåˆ—çš„å¤´ï¼Œå¦‚æœæ­¤é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿”å› nullã€‚      *  æ‰§è¡Œç»“æœï¼š      *   =====æ‰§è¡Œpeek()ç­¾åæ–¹æ³•-å¼€å§‹=====      *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€3ã€‘,å®¹é‡ï¼šã€0ã€‘      *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼šMessage 1      *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼šMessage 1      *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€3ã€‘,å®¹é‡ï¼šã€0ã€‘      *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼šMessage 1      *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼šMessage 1      *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼šMessage 1      *   =====æ‰§è¡Œpeek()ç­¾åæ–¹æ³•-ç»“æŸ=====     */    public static void peek() throws InterruptedException &#123;        System.out.println(&quot;=====æ‰§è¡Œpeek()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        ArrayBlockingQueue arrayBlockingQueue = new ArrayBlockingQueue(3);        arrayBlockingQueue.put(&quot;Message 1&quot;);        arrayBlockingQueue.put(&quot;Message 2&quot;);        arrayBlockingQueue.put(&quot;Message 3&quot;);        System.out.println(String.format(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, arrayBlockingQueue.size(),arrayBlockingQueue.remainingCapacity()));        System.out.println(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼š&quot; + arrayBlockingQueue.peek());        System.out.println(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼š&quot; + arrayBlockingQueue.peek());        System.out.println(String.format(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, arrayBlockingQueue.size(),arrayBlockingQueue.remainingCapacity()));        System.out.println(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼š&quot; + arrayBlockingQueue.peek());        System.out.println(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼š&quot; + arrayBlockingQueue.peek());        System.out.println(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼š&quot; + arrayBlockingQueue.peek());        System.out.println(&quot;=====æ‰§è¡Œpeek()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**     * æ£€ç´¢ï¼Œä½†ä¸åˆ é™¤ï¼Œè¿™ä¸ªé˜Ÿåˆ—çš„å¤´ã€‚ æ­¤æ–¹æ³•ä¸peekçš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œå¦‚æœæ­¤é˜Ÿåˆ—ä¸ºç©ºï¼Œå®ƒå°†æŠ›å‡ºå¼‚å¸¸ã€‚     *  æ‰§è¡Œç»“æœï¼š     *   =====æ‰§è¡Œelement()ç­¾åæ–¹æ³•-å¼€å§‹=====     *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€3ã€‘,å®¹é‡ï¼šã€0ã€‘     *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­take()æ•°æ®å€¼ä¸ºï¼šMessage 1     *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­take()æ•°æ®å€¼ä¸ºï¼šMessage 2     *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­take()æ•°æ®å€¼ä¸ºï¼šMessage 3     *   å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€0ã€‘,å®¹é‡ï¼šã€3ã€‘     *   Exception in thread &quot;main&quot; java.util.NoSuchElementException     *   at java.util.AbstractQueue.element(AbstractQueue.java:136)     *   at com.yuanxw.thread.chapter25.ArrayBlockingQueueExample.element(ArrayBlockingQueueExample.java:182)     *   at com.yuanxw.thread.chapter25.ArrayBlockingQueueExample.main(ArrayBlockingQueueExample.java:14)     */    public static void element() throws InterruptedException &#123;        System.out.println(&quot;=====æ‰§è¡Œelement()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        ArrayBlockingQueue arrayBlockingQueue = new ArrayBlockingQueue(3);        arrayBlockingQueue.put(&quot;Message 1&quot;);        arrayBlockingQueue.put(&quot;Message 2&quot;);        arrayBlockingQueue.put(&quot;Message 3&quot;);        System.out.println(String.format(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, arrayBlockingQueue.size(),arrayBlockingQueue.remainingCapacity()));        System.out.println(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­take()æ•°æ®å€¼ä¸ºï¼š&quot; + arrayBlockingQueue.take());        System.out.println(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­take()æ•°æ®å€¼ä¸ºï¼š&quot; + arrayBlockingQueue.take());        System.out.println(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­take()æ•°æ®å€¼ä¸ºï¼š&quot; + arrayBlockingQueue.take());        System.out.println(String.format(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, arrayBlockingQueue.size(),arrayBlockingQueue.remainingCapacity()));        System.out.println(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­element()æ•°æ®å€¼ä¸ºï¼š&quot; + arrayBlockingQueue.element());        System.out.println(&quot;=====æ‰§è¡Œelement()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**      * æ£€ç´¢å¹¶åˆ é™¤æ­¤é˜Ÿåˆ—çš„å¤´ã€‚ æ­¤æ–¹æ³•ä¸pollä¸åŒä¹‹å¤„åœ¨äºï¼Œå¦‚æœæ­¤é˜Ÿåˆ—ä¸ºç©ºï¼Œå®ƒå°†æŠ›å‡ºå¼‚å¸¸ã€‚      * æ‰§è¡Œç»“æœï¼š      * =====æ‰§è¡Œremove()ç­¾åæ–¹æ³•-å¼€å§‹=====      * å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€3ã€‘,å®¹é‡ï¼šã€0ã€‘      * å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­remove()æ•°æ®å€¼ä¸ºï¼šMessage 1      * å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­remove()æ•°æ®å€¼ä¸ºï¼šMessage 2      * å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­remove()æ•°æ®å€¼ä¸ºï¼šMessage 3      * Exception in thread &quot;main&quot; java.util.NoSuchElementException      * at java.util.AbstractQueue.remove(AbstractQueue.java:117)      * at com.yuanxw.thread.chapter25.ArrayBlockingQueueExample.remove(ArrayBlockingQueueExample.java:212)      * at com.yuanxw.thread.chapter25.ArrayBlockingQueueExample.main(ArrayBlockingQueueExample.java:15)     */    public static void remove() throws InterruptedException &#123;        System.out.println(&quot;=====æ‰§è¡Œremove()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        ArrayBlockingQueue arrayBlockingQueue = new ArrayBlockingQueue(3);        arrayBlockingQueue.put(&quot;Message 1&quot;);        arrayBlockingQueue.put(&quot;Message 2&quot;);        arrayBlockingQueue.put(&quot;Message 3&quot;);        System.out.println(String.format(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, arrayBlockingQueue.size(),arrayBlockingQueue.remainingCapacity()));        System.out.println(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­remove()æ•°æ®å€¼ä¸ºï¼š&quot; + arrayBlockingQueue.remove());        System.out.println(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­remove()æ•°æ®å€¼ä¸ºï¼š&quot; + arrayBlockingQueue.remove());        System.out.println(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­remove()æ•°æ®å€¼ä¸ºï¼š&quot; + arrayBlockingQueue.remove());        System.out.println(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­remove()æ•°æ®å€¼ä¸ºï¼š&quot; + arrayBlockingQueue.remove());        System.out.println(String.format(&quot;å½“å‰arrayBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, arrayBlockingQueue.size(),arrayBlockingQueue.remainingCapacity()));        System.out.println(&quot;=====æ‰§è¡Œremove()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;&#125;

&emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVA å¤šçº¿ç¨‹(äºŒåäº”)Java å¤šçº¿ç¨‹ä¹‹ ArrayBlockingQueue å®¹å™¨ã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚
  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(äºŒåå…«)Javaå¤šçº¿ç¨‹ä¹‹SynchronousQueueå®¹å™¨</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E4%BA%8C%E5%8D%81%E5%85%AB)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BSynchronousQue/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(äºŒåå…«)Javaå¤šçº¿ç¨‹ä¹‹SynchronousQueueå®¹å™¨1.1 ä»€ä¹ˆæ˜¯SynchronousQueue&emsp;&emsp;Java 6çš„å¹¶å‘ç¼–ç¨‹åŒ…ä¸­çš„SynchronousQueueæ˜¯ä¸€ä¸ªæ²¡æœ‰æ•°æ®ç¼“å†²çš„BlockingQueueï¼Œç”Ÿäº§è€…çº¿ç¨‹å¯¹å…¶çš„æ’å…¥æ“ä½œputå¿…é¡»ç­‰å¾…æ¶ˆè´¹è€…çš„ç§»é™¤æ“ä½œtakeï¼Œåè¿‡æ¥ä¹Ÿä¸€æ ·ã€‚
ä¸åƒArrayBlockingQueueæˆ–LinkedListBlockingQueueï¼ŒSynchronousQueueå†…éƒ¨å¹¶æ²¡æœ‰æ•°æ®ç¼“å­˜ç©ºé—´ï¼Œä½ ä¸èƒ½è°ƒç”¨peek()æ–¹æ³•æ¥çœ‹é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰æ•°æ®å…ƒç´ ï¼Œå› ä¸ºæ•°æ®å…ƒç´ åªæœ‰å½“ä½ è¯•ç€å–èµ°çš„æ—¶å€™æ‰å¯èƒ½å­˜åœ¨ï¼Œä¸å–èµ°è€Œåªæƒ³å·çª¥ä¸€ä¸‹æ˜¯ä¸è¡Œçš„ï¼Œå½“ç„¶éå†è¿™ä¸ªé˜Ÿåˆ—çš„æ“ä½œä¹Ÿæ˜¯ä¸å…è®¸çš„ã€‚é˜Ÿåˆ—å¤´å…ƒç´ æ˜¯ç¬¬ä¸€ä¸ªæ’é˜Ÿè¦æ’å…¥æ•°æ®çš„çº¿ç¨‹ï¼Œè€Œä¸æ˜¯è¦äº¤æ¢çš„æ•°æ®ã€‚æ•°æ®æ˜¯åœ¨é…å¯¹çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çº¿ç¨‹ä¹‹é—´ç›´æ¥ä¼ é€’çš„ï¼Œå¹¶ä¸ä¼šå°†æ•°æ®ç¼“å†²æ•°æ®åˆ°é˜Ÿåˆ—ä¸­ã€‚å¯ä»¥è¿™æ ·æ¥ç†è§£ï¼šç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…äº’ç›¸ç­‰å¾…å¯¹æ–¹ï¼Œæ¡æ‰‹ï¼Œç„¶åä¸€èµ·ç¦»å¼€ã€‚
SynchronousQueueçš„ä¸€ä¸ªä½¿ç”¨åœºæ™¯æ˜¯åœ¨çº¿ç¨‹æ± é‡Œã€‚Executors.newCachedThreadPool()å°±ä½¿ç”¨äº†SynchronousQueueï¼Œè¿™ä¸ªçº¿ç¨‹æ± æ ¹æ®éœ€è¦ï¼ˆæ–°ä»»åŠ¡åˆ°æ¥æ—¶ï¼‰åˆ›å»ºæ–°çš„çº¿ç¨‹ï¼Œå¦‚æœæœ‰ç©ºé—²çº¿ç¨‹åˆ™ä¼šé‡å¤ä½¿ç”¨ï¼Œçº¿ç¨‹ç©ºé—²äº†60ç§’åä¼šè¢«å›æ”¶ã€‚
ä¸‹é¢æ˜¯ SynchronousQueueç»§æ‰¿ç»“æ„å…³ç³»å›¾ï¼š

é€šè¿‡æºä»£ç æŸ¥çœ‹SynchronousQueueå®ç°ï¼š
/** * åˆ›å»ºä¸€ä¸ª SynchronousQueueéå…¬å¹³ç­–ç•¥ã€‚  * Creates a &#123;@code SynchronousQueue&#125; with nonfair access policy. */public SynchronousQueue() &#123;    this(false);&#125;/** * åˆ›å»ºä¸€ä¸ª SynchronousQueueéå…¬å¹³ç­–ç•¥ã€‚ å¦‚æœfairå‚æ•°ï¼štrueï¼Œç­‰å¾…çº¿ç¨‹åœ¨FIFOé¡ºåºä¸­è¿›è¡Œè®¿é—®;  * Creates a &#123;@code SynchronousQueue&#125; with the specified fairness policy. * * @param fair if true, waiting threads contend in FIFO order for *        access; otherwise the order is unspecified. */public SynchronousQueue(boolean fair) &#123;    transferer = fair ? new TransferQueue&lt;E&gt;() : new TransferStack&lt;E&gt;();&#125;
1.2 SynchronousQueueé˜Ÿåˆ—ç‰¹ç‚¹
SynchronousQueueæ²¡æœ‰å®¹é‡ã€‚ä¸å…¶ä»–BlockingQueueä¸åŒï¼ŒSynchronousQueueæ˜¯ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„BlockingQueueã€‚æ¯ä¸€ä¸ªputæ“ä½œå¿…é¡»è¦ç­‰å¾…ä¸€ä¸ªtakeæ“ä½œï¼Œå¦åˆ™ä¸èƒ½ç»§ç»­æ·»åŠ å…ƒç´ ï¼Œåä¹‹äº¦ç„¶ã€‚

å› ä¸ºæ²¡æœ‰å®¹é‡ï¼Œæ‰€ä»¥å¯¹åº”çš„peekã€containsã€clearã€isEmptyâ€¦..ç­‰æ–¹æ³•å…¶å®æ˜¯æ— æ•ˆçš„ã€‚ä¾‹å¦‚clearæ˜¯ä¸æ‰§è¡Œä»»ä½•æ“ä½œçš„ï¼Œcontainså§‹ç»ˆè¿”å›falseï¼Œpeekå§‹ç»ˆè¿”å›nullã€‚

SynchronousQueueåˆ†ä¸ºå…¬å¹³å’Œéå…¬å¹³ï¼Œé»˜è®¤æƒ…å†µä¸‹é‡‡ç”¨éå…¬å¹³æ€§è®¿é—®ç­–ç•¥ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡æ„é€ å‡½æ•°æ¥è®¾ç½®ä¸ºå…¬å¹³æ€§è®¿é—®ç­–ç•¥ï¼ˆä¸ºtrueå³å¯ï¼‰ã€‚

SynchronousQueueå†…éƒ¨é‡‡ç”¨äº†æ— é”å®ç°ï¼ˆCASï¼‰ã€‚


1.3 å¸¸ç”¨çš„æ–¹æ³•package com.yuanxw.thread.chapter28;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.SynchronousQueue;import java.util.concurrent.TimeUnit;public class SynchronousQueueExample &#123;    public static void main(String[] args) throws InterruptedException &#123;        // add();        // addAndTake();        // offer();        put();    &#125;    /**     å¦‚æœå¯ä»¥åœ¨ä¸è¶…è¿‡é˜Ÿåˆ—çš„å®¹é‡çš„æƒ…å†µä¸‹ç«‹å³å°†å…¶æŒ‡å®šçš„å…ƒç´ æ’å…¥åˆ°è¯¥é˜Ÿåˆ—ä¸­ï¼Œ     å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™è¿”å› trueå¹¶æŠ›å‡º IllegalStateException ã€‚     æ‰§è¡Œç»“æœï¼š         =====æ‰§è¡Œadd()ç­¾åæ–¹æ³•-å¼€å§‹=====         Exception in thread &quot;main&quot; java.lang.IllegalStateException: Queue full         at java.util.AbstractQueue.add(AbstractQueue.java:98)         at com.yuanxw.thread.chapter28.SynchronousQueueExample.add(SynchronousQueueExample.java:16)         at com.yuanxw.thread.chapter28.SynchronousQueueExample.main(SynchronousQueueExample.java:10)     */    public static void add() throws InterruptedException &#123;        System.out.println(&quot;=====æ‰§è¡Œadd()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        SynchronousQueue synchronousQueue = new SynchronousQueue();        synchronousQueue.add(&quot;Message 1&quot;);        System.out.println(&quot;=====æ‰§è¡Œadd()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    public static void addAndTake() throws InterruptedException &#123;        System.out.println(&quot;=====æ‰§è¡Œadd()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        SynchronousQueue synchronousQueue = new SynchronousQueue();        ExecutorService executorService = Executors.newSingleThreadExecutor();        executorService.execute(()-&gt;&#123;            try &#123;                System.out.println(String.format(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, synchronousQueue.size(),synchronousQueue.remainingCapacity()));                Object take = synchronousQueue.take();                System.out.println(&quot;å½“å‰synchronousQueueå¯¹è±¡ä¸­take()æ•°æ®å€¼ä¸ºï¼š&quot; + take);            &#125; catch (InterruptedException e) &#123;                e.printStackTrace();            &#125;        &#125;);        TimeUnit.SECONDS.sleep(3);        System.out.println(&quot;synchronousQueue.add()æ‰§è¡Œè¿”å›ç»“æœï¼š&quot;+synchronousQueue.add(&quot;Message 1&quot;));        executorService.shutdown();        System.out.println(&quot;=====æ‰§è¡Œadd()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**     å¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨ç­‰å¾…æ¥æ”¶ï¼Œåˆ™å°†æŒ‡å®šçš„å…ƒç´ æ’å…¥åˆ°æ­¤é˜Ÿåˆ—ä¸­ã€‚     trueå¦‚æœå…ƒç´ è¢«æ·»åŠ åˆ°è¿™ä¸ªé˜Ÿåˆ—ï¼Œå¦åˆ™ false     æ‰§è¡Œç»“æœï¼š         =====æ‰§è¡Œoffer()ç­¾åæ–¹æ³•-å¼€å§‹=====         synchronousQueue.offer()æ‰§è¡Œè¿”å›ç»“æœï¼šfalse         ------------------------------------         synchronousQueue.offer()æ‰§è¡Œè¿”å›ç»“æœï¼štrue         å½“å‰synchronousQueueå¯¹è±¡ä¸­take()æ•°æ®å€¼ä¸ºï¼šMessage 2         =====æ‰§è¡Œoffer()ç­¾åæ–¹æ³•-ç»“æŸ=====     */    public static void offer() throws InterruptedException &#123;        System.out.println(&quot;=====æ‰§è¡Œoffer()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        SynchronousQueue synchronousQueue = new SynchronousQueue();        System.out.println(&quot;synchronousQueue.offer()æ‰§è¡Œè¿”å›ç»“æœï¼š&quot;+synchronousQueue.offer(&quot;Message 1&quot;));        System.out.println(&quot;------------------------------------&quot;);        ExecutorService executorService = Executors.newSingleThreadExecutor();        executorService.execute(()-&gt;&#123;            try &#123;                Object take = synchronousQueue.take();                System.out.println(&quot;å½“å‰synchronousQueueå¯¹è±¡ä¸­take()æ•°æ®å€¼ä¸ºï¼š&quot; + take);            &#125; catch (InterruptedException e) &#123;                e.printStackTrace();            &#125;        &#125;);        TimeUnit.SECONDS.sleep(3);        System.out.println(&quot;synchronousQueue.offer()æ‰§è¡Œè¿”å›ç»“æœï¼š&quot;+synchronousQueue.offer(&quot;Message 2&quot;));        executorService.shutdown();        System.out.println(&quot;=====æ‰§è¡Œoffer()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**     * å°†æŒ‡å®šçš„å…ƒç´ æ·»åŠ åˆ°æ­¤é˜Ÿåˆ—ï¼Œç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ¥æ”¶å®ƒã€‚     æ‰§è¡Œç»“æœï¼š         =====æ‰§è¡Œput()ç­¾åæ–¹æ³•-å¼€å§‹=====         å½“å‰synchronousQueueå¯¹è±¡ä¸­take()æ•°æ®å€¼ä¸ºï¼šMessage 1         =====æ‰§è¡Œput()ç­¾åæ–¹æ³•-ç»“æŸ=====     */    public static void put() throws InterruptedException &#123;        System.out.println(&quot;=====æ‰§è¡Œput()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        SynchronousQueue synchronousQueue = new SynchronousQueue();        ExecutorService executorService = Executors.newSingleThreadExecutor();        executorService.execute(()-&gt;&#123;            try &#123;                TimeUnit.SECONDS.sleep(2);                // æ£€ç´¢å¹¶åˆ é™¤æ­¤é˜Ÿåˆ—çš„å¤´                Object take = synchronousQueue.take();                System.out.println(&quot;å½“å‰synchronousQueueå¯¹è±¡ä¸­take()æ•°æ®å€¼ä¸ºï¼š&quot; + take);            &#125; catch (InterruptedException e) &#123;                e.printStackTrace();            &#125;        &#125;);        // putæ–¹æ³•ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–ã€‚        synchronousQueue.put(&quot;Message 1&quot;);        executorService.shutdown();        System.out.println(&quot;=====æ‰§è¡Œput()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;&#125;
1.4 åº”ç”¨åœºæ™¯ &emsp;&emsp;å¯ç¼“å­˜çº¿ç¨‹æ± CachedThreadPoolçš„æºç å®ç°ï¼Œä½¿ç”¨SynchronousQueueä½œä¸ºå·¥ä½œé˜Ÿåˆ—ï¼Œå·¥ä½œé˜Ÿåˆ—æœ¬èº«å¹¶ä¸é™åˆ¶å¾…æ‰§è¡Œçš„ä»»åŠ¡çš„æ•°é‡ã€‚ä½†æ­¤æ—¶éœ€è¦é™å®šçº¿ç¨‹æ± çš„æœ€å¤§å¤§å°ä¸ºä¸€ä¸ªåˆç†çš„æœ‰é™å€¼ï¼Œè€Œä¸æ˜¯Integer.MAX_VALUEï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´çº¿ç¨‹æ± ä¸­çš„å·¥ä½œè€…çº¿ç¨‹çš„æ•°é‡ä¸€ç›´å¢åŠ åˆ°ç³»ç»Ÿèµ„æºæ‰€æ— æ³•æ‰¿å—ä¸ºæ­¢ã€‚å¦‚æœåº”ç”¨ç¨‹åºç¡®å®éœ€è¦æ¯”è¾ƒå¤§çš„å·¥ä½œé˜Ÿåˆ—å®¹é‡ï¼Œè€Œåˆæƒ³é¿å…æ— ç•Œå·¥ä½œé˜Ÿåˆ—å¯èƒ½å¯¼è‡´çš„é—®é¢˜ï¼Œä¸å¦¨è€ƒè™‘SynchronousQueueã€‚SynchronousQueueå®ç°ä¸Šå¹¶ä¸ä½¿ç”¨ç¼“å­˜ç©ºé—´ã€‚ä½¿ç”¨SynchronousQueueçš„ç›®çš„å°±æ˜¯ä¿è¯â€œå¯¹äºæäº¤çš„ä»»åŠ¡ï¼Œå¦‚æœæœ‰ç©ºé—²çº¿ç¨‹ï¼Œåˆ™ä½¿ç”¨ç©ºé—²çº¿ç¨‹æ¥å¤„ç†ï¼›å¦åˆ™æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡â€ã€‚JAVAå¤šçº¿ç¨‹(åä¹)Javaå¤šçº¿ç¨‹ä¹‹CachedThreadPoolå¯ç¼“å­˜çº¿ç¨‹æ± ã€‚
&emsp;&emsp;å¯ç¼“å­˜çº¿ç¨‹æ± CachedThreadPoolæºä»£ç å®ç°ï¼š
/** * Creates a thread pool that creates new threads as needed, but * will reuse previously constructed threads when they are * available.  These pools will typically improve the performance * of programs that execute many short-lived asynchronous tasks. * Calls to &#123;@code execute&#125; will reuse previously constructed * threads if available. If no existing thread is available, a new * thread will be created and added to the pool. Threads that have * not been used for sixty seconds are terminated and removed from * the cache. Thus, a pool that remains idle for long enough will * not consume any resources. Note that pools with similar * properties but different details (for example, timeout parameters) * may be created using &#123;@link ThreadPoolExecutor&#125; constructors. * * @return the newly created thread pool */public static ExecutorService newCachedThreadPool() &#123;    return new ThreadPoolExecutor(0, Integer.MAX_VALUE,                                  60L, TimeUnit.SECONDS,                                  new SynchronousQueue&lt;Runnable&gt;());&#125;



 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(äºŒåå…«)Javaå¤šçº¿ç¨‹ä¹‹SynchronousQueueå®¹å™¨ã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(äºŒåå…­)Javaå¤šçº¿ç¨‹ä¹‹PriorityBlockingQueueå®¹å™¨</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E4%BA%8C%E5%8D%81%E5%85%AD)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BPriorityBlockingQueue%E5%AE%B9%E5%99%A8/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(äºŒåå…­)Javaå¤šçº¿ç¨‹ä¹‹PriorityBlockingQueueå®¹å™¨1.1 ä»€ä¹ˆæ˜¯PriorityBlockingQueue&emsp;&emsp;PriorityBlockingQueue æ˜¯ä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚é»˜è®¤æƒ…å†µä¸‹å…ƒç´ é‡‡ç”¨è‡ªç„¶é¡ºåºè¿›è¡Œæ’åºï¼Œä¹Ÿå¯ä»¥é€šè¿‡è‡ªå®šä¹‰ç±»å®ç° compareTo() æ–¹æ³•æ¥æŒ‡å®šå…ƒç´ æ’åºè§„åˆ™ï¼Œæˆ–è€…åˆå§‹åŒ–æ—¶é€šè¿‡æ„é€ å™¨å‚æ•° Comparator æ¥æŒ‡å®šæ’åºè§„åˆ™ã€‚
PriorityBlockingQueue å¹¶å‘æ§åˆ¶é‡‡ç”¨çš„æ˜¯ ReentrantLockï¼Œé˜Ÿåˆ—ä¸ºæ— ç•Œé˜Ÿåˆ—ï¼ˆArrayBlockingQueue æ˜¯æœ‰ç•Œé˜Ÿåˆ—ï¼ŒLinkedBlockingQueue ä¹Ÿå¯ä»¥é€šè¿‡åœ¨æ„é€ å‡½æ•°ä¸­ä¼ å…¥ capacity æŒ‡å®šé˜Ÿåˆ—æœ€å¤§çš„å®¹é‡ï¼Œä½†æ˜¯ PriorityBlockingQueue åªèƒ½æŒ‡å®šåˆå§‹çš„é˜Ÿåˆ—å¤§å°ï¼Œåé¢æ’å…¥å…ƒç´ çš„æ—¶å€™ï¼Œå¦‚æœç©ºé—´ä¸å¤Ÿçš„è¯ä¼šè‡ªåŠ¨æ‰©å®¹ï¼‰ã€‚
ä¸‹é¢æ˜¯ PriorityBlockingQueueç»§æ‰¿ç»“æ„å…³ç³»å›¾ï¼š
1.2 PriorityBlockingQueueæ— ç•Œé˜»å¡é˜Ÿåˆ—&emsp;&emsp;ç®€å•åœ°è¯´ï¼Œå®ƒå°±æ˜¯ PriorityQueue çš„çº¿ç¨‹å®‰å…¨ç‰ˆæœ¬ã€‚ä¸å¯ä»¥æ’å…¥ null å€¼ï¼ŒåŒæ—¶ï¼Œæ’å…¥é˜Ÿåˆ—çš„å¯¹è±¡å¿…é¡»æ˜¯å¯æ¯”è¾ƒå¤§å°çš„ï¼ˆcomparableï¼‰ï¼Œå¦åˆ™æŠ¥ ClassCastException å¼‚å¸¸ã€‚å®ƒçš„æ’å…¥æ“ä½œ put æ–¹æ³•ä¸ä¼š blockï¼Œå› ä¸ºå®ƒæ˜¯æ— ç•Œé˜Ÿåˆ—ï¼ˆtake æ–¹æ³•åœ¨é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ä¼šé˜»å¡ï¼‰ã€‚é€šè¿‡æºä»£ç æŸ¥çœ‹PriorityBlockingQueueå®ç°ï¼š
/** * åˆ›å»ºä¸€ä¸ªPriorityBlockingQueue ï¼Œå…·æœ‰é»˜è®¤çš„åˆå§‹å®¹é‡ï¼ˆ11ï¼‰ï¼Œæ ¹æ®å®ƒä»¬çš„Comparableå¯¹å…¶å…ƒç´ è¿›è¡Œæ’åº ã€‚  * * Creates a &#123;@code PriorityBlockingQueue&#125; with the default * initial capacity (11) that orders its elements according to * their &#123;@linkplain Comparable natural ordering&#125;. */public PriorityBlockingQueue() &#123;    this(DEFAULT_INITIAL_CAPACITY, null);&#125;/** * åˆ›å»ºä¸€ä¸ªPriorityBlockingQueue ï¼ŒæŒ‡å®šå®¹é‡å¤§å°ï¼Œæ ¹æ®å®ƒä»¬çš„Comparableå¯¹å…¶å…ƒç´ è¿›è¡Œæ’åº ã€‚  * * Creates a &#123;@code PriorityBlockingQueue&#125; with the specified * initial capacity that orders its elements according to their * &#123;@linkplain Comparable natural ordering&#125;. * * @param initialCapacity the initial capacity for this priority queue * @throws IllegalArgumentException if &#123;@code initialCapacity&#125; is less *         than 1 */public PriorityBlockingQueue(int initialCapacity) &#123;    this(initialCapacity, null);&#125;/** * åˆ›å»ºå…·æœ‰ PriorityBlockingQueueåˆå§‹å®¹é‡çš„PriorityBlockingQueueï¼Œæ ¹æ®æŒ‡å®šçš„æ¯”è¾ƒå™¨å¯¹å…¶å…ƒç´ è¿›è¡Œæ’åºã€‚  * * Creates a &#123;@code PriorityBlockingQueue&#125; with the specified initial * capacity that orders its elements according to the specified * comparator. * * @param initialCapacity the initial capacity for this priority queue * @param  comparator the comparator that will be used to order this *         priority queue.  If &#123;@code null&#125;, the &#123;@linkplain Comparable *         natural ordering&#125; of the elements will be used. * @throws IllegalArgumentException if &#123;@code initialCapacity&#125; is less *         than 1 */public PriorityBlockingQueue(int initialCapacity,                             Comparator&lt;? super E&gt; comparator) &#123;    if (initialCapacity &lt; 1)        throw new IllegalArgumentException();    this.lock = new ReentrantLock();    this.notEmpty = lock.newCondition();    this.comparator = comparator;    this.queue = new Object[initialCapacity];&#125;/** * åˆ›å»ºä¸€ä¸ª PriorityBlockingQueueé›†åˆä¸­çš„å…ƒç´ çš„PriorityBlockingQueueã€‚  * åœ¨æŒ‡å®šçš„é›†åˆä¸­ã€‚å¦‚æœæŒ‡å®šçš„é›†åˆæ˜¯ &#123;@link SortedSet&#125;æˆ–&#123;@link PriorityQueue&#125;ï¼Œ * è¿™ä¸ªä¼˜å…ˆé˜Ÿåˆ—å°†æŒ‰ç…§ç›¸åŒçš„é¡ºåºæ’åºã€‚å¦åˆ™ï¼Œæ­¤ä¼˜å…ˆé˜Ÿåˆ—å°†æ ¹æ®&#123;@linkplainå¯æ¯”è¾ƒçš„è‡ªç„¶æ’åº&#125;ã€‚ * * Creates a &#123;@code PriorityBlockingQueue&#125; containing the elements * in the specified collection.  If the specified collection is a * &#123;@link SortedSet&#125; or a &#123;@link PriorityQueue&#125;, this * priority queue will be ordered according to the same ordering. * Otherwise, this priority queue will be ordered according to the * &#123;@linkplain Comparable natural ordering&#125; of its elements. * * @param  c the collection whose elements are to be placed *         into this priority queue * @throws ClassCastException if elements of the specified collection *         cannot be compared to one another according to the priority *         queue&#x27;s ordering * @throws NullPointerException if the specified collection or any *         of its elements are null */public PriorityBlockingQueue(Collection&lt;? extends E&gt; c) &#123;    this.lock = new ReentrantLock();    this.notEmpty = lock.newCondition();    boolean heapify = true; // true if not known to be in heap order    boolean screen = true;  // true if must screen for nulls    if (c instanceof SortedSet&lt;?&gt;) &#123;        SortedSet&lt;? extends E&gt; ss = (SortedSet&lt;? extends E&gt;) c;        this.comparator = (Comparator&lt;? super E&gt;) ss.comparator();        heapify = false;    &#125;    else if (c instanceof PriorityBlockingQueue&lt;?&gt;) &#123;        PriorityBlockingQueue&lt;? extends E&gt; pq =            (PriorityBlockingQueue&lt;? extends E&gt;) c;        this.comparator = (Comparator&lt;? super E&gt;) pq.comparator();        screen = false;        if (pq.getClass() == PriorityBlockingQueue.class) // exact match            heapify = false;    &#125;    Object[] a = c.toArray();    int n = a.length;    // If c.toArray incorrectly doesn&#x27;t return Object[], copy it.    if (a.getClass() != Object[].class)        a = Arrays.copyOf(a, n, Object[].class);    if (screen &amp;&amp; (n == 1 || this.comparator != null)) &#123;        for (int i = 0; i &lt; n; ++i)            if (a[i] == null)                throw new NullPointerException();    &#125;    this.queue = a;    this.size = n;    if (heapify)        heapify();&#125;
1.3 PriorityBlockingQueueæ— ç•Œé˜»å¡é˜Ÿåˆ—ç‰¹ç‚¹
PriorityBlockingQueueæ— ç•Œé˜Ÿåˆ—ï¼Œåªèƒ½æŒ‡å®šåˆå§‹çš„é˜Ÿåˆ—å¤§å°ï¼Œåé¢æ’å…¥å…ƒç´ çš„æ—¶å€™ï¼Œå¦‚æœç©ºé—´ä¸å¤Ÿçš„è¯ä¼šè‡ªåŠ¨æ‰©å®¹ã€‚
PriorityBlockingQueueä¸å¯ä»¥æ’å…¥ null å€¼ã€‚
æ’å…¥é˜Ÿåˆ—çš„å¯¹è±¡å¿…é¡»æ˜¯å¯æ¯”è¾ƒå¤§å°çš„ï¼ˆcomparableï¼‰ã€‚

1.4 å¸¸ç”¨çš„æ–¹æ³•package com.yuanxw.thread.chapter26;import java.util.concurrent.PriorityBlockingQueue;public class PriorityBlockingQueueExample &#123;    public static void main(String[] args) throws InterruptedException &#123;        // add();        // poll();        // peek();        // element();        // remove();        // addNoComparable();        addWithNull();            &#125;    /**     * PriorityBlockingQueue     * å°†æŒ‡å®šçš„å…ƒç´ æ’å…¥åˆ°æ­¤ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­ã€‚ ç”±äºé˜Ÿåˆ—æ— é™åˆ¶ï¼Œæ­¤æ–¹æ³•å°†æ°¸è¿œä¸ä¼šè¿”å›false ã€‚     * add()æ–¹æ³•ã€put()æ–¹æ³•ï¼Œéƒ½è°ƒç”¨ç”¨offer()æ–¹æ³•ã€‚     æ‰§è¡Œç»“æœï¼š         =====æ‰§è¡Œadd()ç­¾åæ–¹æ³•-å¼€å§‹=====         Message 1         Message 2         Message 3         =====æ‰§è¡Œadd()ç­¾åæ–¹æ³•-å¼€å§‹=====     */    public static void add()&#123;        System.out.println(&quot;=====æ‰§è¡Œadd()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        // åˆ›å»ºä¸€ä¸ªPriorityBlockingQueue ï¼Œå…·æœ‰æŒ‡å®šçš„åˆå§‹å®¹é‡ï¼Œæ ¹æ®å®ƒä»¬çš„natural orderingå¯¹å…¶å…ƒç´ è¿›è¡Œæ’åº ã€‚        // è¶…è¿‡å®¹é‡ä¹‹åä¼šè‡ªåŠ¨æ‰©å®¹        PriorityBlockingQueue priorityBlockingQueue = new PriorityBlockingQueue(2);        priorityBlockingQueue.add(&quot;Message 1&quot;);        priorityBlockingQueue.put(&quot;Message 2&quot;);        priorityBlockingQueue.offer(&quot;Message 3&quot;);        priorityBlockingQueue.forEach(System.out::println);        System.out.println(&quot;=====æ‰§è¡Œadd()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);    &#125;    /**     * æ£€ç´¢å¹¶åˆ é™¤æ­¤é˜Ÿåˆ—çš„å¤´ï¼Œåˆ™ç­‰å¾…ç©ºé—´å˜ä¸ºå¯ç”¨ã€‚     =====æ‰§è¡Œpoll()ç­¾åæ–¹æ³•-å¼€å§‹=====     æ‰§è¡Œç»“æœï¼š         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€3ã€‘,å®¹é‡ï¼šã€2147483647ã€‘         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼šMessage 1         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼šMessage 2         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€1ã€‘,å®¹é‡ï¼šã€2147483647ã€‘         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼šMessage 3         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼šnull         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼šnull     =====æ‰§è¡Œpoll()ç­¾åæ–¹æ³•-ç»“æŸ=====     */    public static void poll() &#123;        System.out.println(&quot;=====æ‰§è¡Œpoll()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        PriorityBlockingQueue priorityBlockingQueue = new PriorityBlockingQueue(2);        priorityBlockingQueue.put(&quot;Message 1&quot;);        priorityBlockingQueue.put(&quot;Message 2&quot;);        priorityBlockingQueue.put(&quot;Message 3&quot;);        System.out.println(String.format(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, priorityBlockingQueue.size(),priorityBlockingQueue.remainingCapacity()));        System.out.println(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼š&quot; + priorityBlockingQueue.poll());        System.out.println(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼š&quot; + priorityBlockingQueue.poll());        System.out.println(String.format(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, priorityBlockingQueue.size(),priorityBlockingQueue.remainingCapacity()));        System.out.println(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼š&quot; + priorityBlockingQueue.poll());        System.out.println(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼š&quot; + priorityBlockingQueue.poll());        System.out.println(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­poll()æ•°æ®å€¼ä¸ºï¼š&quot; + priorityBlockingQueue.poll());        System.out.println(&quot;=====æ‰§è¡Œpoll()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**     * æ£€ç´¢ä½†ä¸åˆ é™¤æ­¤é˜Ÿåˆ—çš„å¤´ï¼Œå¦‚æœæ­¤é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿”å› nullã€‚     æ‰§è¡Œç»“æœï¼š         =====æ‰§è¡Œpeek()ç­¾åæ–¹æ³•-å¼€å§‹=====         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€3ã€‘,å®¹é‡ï¼šã€2147483647ã€‘         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼šMessage 1         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼šMessage 1         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€3ã€‘,å®¹é‡ï¼šã€2147483647ã€‘         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼šMessage 1         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼šMessage 1         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼šMessage 1         =====æ‰§è¡Œpeek()ç­¾åæ–¹æ³•-ç»“æŸ=====     */    public static void peek()  &#123;        System.out.println(&quot;=====æ‰§è¡Œpeek()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        PriorityBlockingQueue priorityBlockingQueue = new PriorityBlockingQueue(2);        priorityBlockingQueue.put(&quot;Message 1&quot;);        priorityBlockingQueue.put(&quot;Message 2&quot;);        priorityBlockingQueue.put(&quot;Message 3&quot;);        System.out.println(String.format(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, priorityBlockingQueue.size(),priorityBlockingQueue.remainingCapacity()));        System.out.println(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼š&quot; + priorityBlockingQueue.peek());        System.out.println(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼š&quot; + priorityBlockingQueue.peek());        System.out.println(String.format(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, priorityBlockingQueue.size(),priorityBlockingQueue.remainingCapacity()));        System.out.println(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼š&quot; + priorityBlockingQueue.peek());        System.out.println(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼š&quot; + priorityBlockingQueue.peek());        System.out.println(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­peek()æ•°æ®å€¼ä¸ºï¼š&quot; + priorityBlockingQueue.peek());        System.out.println(&quot;=====æ‰§è¡Œpeek()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**     * æ£€ç´¢ï¼Œä½†ä¸åˆ é™¤ï¼Œè¿™ä¸ªé˜Ÿåˆ—çš„å¤´ã€‚ æ­¤æ–¹æ³•ä¸peekçš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œå¦‚æœæ­¤é˜Ÿåˆ—ä¸ºç©ºï¼Œå®ƒå°†æŠ›å‡ºå¼‚å¸¸ã€‚     æ‰§è¡Œç»“æœï¼š         =====æ‰§è¡Œelement()ç­¾åæ–¹æ³•-å¼€å§‹=====         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€3ã€‘,å®¹é‡ï¼šã€2147483647ã€‘         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­take()æ•°æ®å€¼ä¸ºï¼šMessage 1         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­take()æ•°æ®å€¼ä¸ºï¼šMessage 2         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­take()æ•°æ®å€¼ä¸ºï¼šMessage 3         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€0ã€‘,å®¹é‡ï¼šã€2147483647ã€‘         Exception in thread &quot;main&quot; java.util.NoSuchElementException         at java.util.AbstractQueue.element(AbstractQueue.java:136)         at com.yuanxw.thread.chapter26.PriorityBlockingQueueExample.element(PriorityBlockingQueueExample.java:123)         at com.yuanxw.thread.chapter26.PriorityBlockingQueueExample.main(PriorityBlockingQueueExample.java:11)     */    public static void element() throws InterruptedException &#123;        System.out.println(&quot;=====æ‰§è¡Œelement()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        PriorityBlockingQueue priorityBlockingQueue = new PriorityBlockingQueue(3);        priorityBlockingQueue.put(&quot;Message 1&quot;);        priorityBlockingQueue.put(&quot;Message 2&quot;);        priorityBlockingQueue.put(&quot;Message 3&quot;);        System.out.println(String.format(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, priorityBlockingQueue.size(),priorityBlockingQueue.remainingCapacity()));        System.out.println(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­take()æ•°æ®å€¼ä¸ºï¼š&quot; + priorityBlockingQueue.take());        System.out.println(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­take()æ•°æ®å€¼ä¸ºï¼š&quot; + priorityBlockingQueue.take());        System.out.println(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­take()æ•°æ®å€¼ä¸ºï¼š&quot; + priorityBlockingQueue.take());        System.out.println(String.format(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, priorityBlockingQueue.size(),priorityBlockingQueue.remainingCapacity()));        System.out.println(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­element()æ•°æ®å€¼ä¸ºï¼š&quot; + priorityBlockingQueue.element());        System.out.println(&quot;=====æ‰§è¡Œelement()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**     * æ£€ç´¢å¹¶åˆ é™¤æ­¤é˜Ÿåˆ—çš„å¤´ã€‚ æ­¤æ–¹æ³•ä¸pollä¸åŒä¹‹å¤„åœ¨äºï¼Œå¦‚æœæ­¤é˜Ÿåˆ—ä¸ºç©ºï¼Œå®ƒå°†æŠ›å‡ºå¼‚å¸¸ã€‚     æ‰§è¡Œç»“æœï¼š         =====æ‰§è¡Œremove()ç­¾åæ–¹æ³•-å¼€å§‹=====         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€3ã€‘,å®¹é‡ï¼šã€2147483647ã€‘         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­remove()æ•°æ®å€¼ä¸ºï¼šMessage 1         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­remove()æ•°æ®å€¼ä¸ºï¼šMessage 2         å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­remove()æ•°æ®å€¼ä¸ºï¼šMessage 3         Exception in thread &quot;main&quot; java.util.NoSuchElementException         at java.util.AbstractQueue.remove(AbstractQueue.java:117)         at com.yuanxw.thread.chapter26.PriorityBlockingQueueExample.remove(PriorityBlockingQueueExample.java:151)         at com.yuanxw.thread.chapter26.PriorityBlockingQueueExample.main(PriorityBlockingQueueExample.java:12)     */    public static void remove() &#123;        System.out.println(&quot;=====æ‰§è¡Œremove()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        PriorityBlockingQueue priorityBlockingQueue = new PriorityBlockingQueue(3);        priorityBlockingQueue.put(&quot;Message 1&quot;);        priorityBlockingQueue.put(&quot;Message 2&quot;);        priorityBlockingQueue.put(&quot;Message 3&quot;);        System.out.println(String.format(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, priorityBlockingQueue.size(),priorityBlockingQueue.remainingCapacity()));        System.out.println(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­remove()æ•°æ®å€¼ä¸ºï¼š&quot; + priorityBlockingQueue.remove());        System.out.println(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­remove()æ•°æ®å€¼ä¸ºï¼š&quot; + priorityBlockingQueue.remove());        System.out.println(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­remove()æ•°æ®å€¼ä¸ºï¼š&quot; + priorityBlockingQueue.remove());        System.out.println(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­remove()æ•°æ®å€¼ä¸ºï¼š&quot; + priorityBlockingQueue.remove());        System.out.println(String.format(&quot;å½“å‰priorityBlockingQueueå¯¹è±¡ä¸­çš„ä¸ªæ•°ï¼šã€%sã€‘,å®¹é‡ï¼šã€%sã€‘&quot;, priorityBlockingQueue.size(),priorityBlockingQueue.remainingCapacity()));        System.out.println(&quot;=====æ‰§è¡Œremove()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**     * éªŒè¯ï¼š     * æ·»åŠ å…ƒç´ æ—¶ï¼Œæ’å…¥é˜Ÿåˆ—çš„å¯¹è±¡å¿…é¡»æ˜¯å¯æ¯”è¾ƒå¤§å°çš„ï¼ˆcomparableï¼‰ï¼Œå¦åˆ™æŠ¥ ClassCastException å¼‚å¸¸ã€‚     æ‰§è¡Œç»“æœï¼š         =====æ‰§è¡ŒaddNoComparable()ç­¾åæ–¹æ³•-å¼€å§‹=====         Exception in thread &quot;main&quot; java.lang.ClassCastException: com.yuanxw.thread.chapter26.PriorityBlockingQueueExample$Order cannot be cast to java.lang.Comparable         at java.util.concurrent.PriorityBlockingQueue.siftUpComparable(PriorityBlockingQueue.java:358)         at java.util.concurrent.PriorityBlockingQueue.offer(PriorityBlockingQueue.java:490)         at java.util.concurrent.PriorityBlockingQueue.add(PriorityBlockingQueue.java:464)         at com.yuanxw.thread.chapter26.PriorityBlockingQueueExample.addNoComparable(PriorityBlockingQueueExample.java:166)         at com.yuanxw.thread.chapter26.PriorityBlockingQueueExample.main(PriorityBlockingQueueExample.java:12)     */    public static void addNoComparable()&#123;        System.out.println(&quot;=====æ‰§è¡ŒaddNoComparable()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        // é»˜è®¤é•¿åº¦ä¸ºï¼š11        PriorityBlockingQueue priorityBlockingQueue = new PriorityBlockingQueue();        priorityBlockingQueue.add(new Order());        priorityBlockingQueue.forEach(System.out::println);        System.out.println(&quot;=====æ‰§è¡ŒaddNoComparable()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**     * éªŒè¯ï¼š     * æ·»åŠ å…ƒç´ æ—¶ï¼Œæ’å…¥é˜Ÿåˆ—çš„å¯¹è±¡æ˜¯nullï¼ŒæŠ¥ NullPointerException å¼‚å¸¸ã€‚     æ‰§è¡Œç»“æœï¼š         =====æ‰§è¡ŒaddWithNull()ç­¾åæ–¹æ³•-å¼€å§‹=====         Exception in thread &quot;main&quot; java.lang.NullPointerException         at java.util.concurrent.PriorityBlockingQueue.offer(PriorityBlockingQueue.java:480)         at java.util.concurrent.PriorityBlockingQueue.add(PriorityBlockingQueue.java:464)         at com.yuanxw.thread.chapter26.PriorityBlockingQueueExample.addWithNull(PriorityBlockingQueueExample.java:194)         at com.yuanxw.thread.chapter26.PriorityBlockingQueueExample.main(PriorityBlockingQueueExample.java:13)     */    public static void addWithNull()&#123;        System.out.println(&quot;=====æ‰§è¡ŒaddWithNull()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        // é»˜è®¤é•¿åº¦ä¸ºï¼š11        PriorityBlockingQueue priorityBlockingQueue = new PriorityBlockingQueue();        priorityBlockingQueue.add(null);        priorityBlockingQueue.forEach(System.out::println);        System.out.println(&quot;=====æ‰§è¡ŒaddWithNull()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    private static class Order&#123;&#125;&#125;

 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(äºŒåå…­)Javaå¤šçº¿ç¨‹ä¹‹PriorityBlockingQueueå®¹å™¨ã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(äºŒåå››)Javaå¤šçº¿ç¨‹ä¹‹CompletableFutureç±»</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E4%BA%8C%E5%8D%81%E5%9B%9B)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BCompletableFuture%E7%B1%BB/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(äºŒåå››)Javaå¤šçº¿ç¨‹ä¹‹CompletableFutureç±»1.1 ä»€ä¹ˆæ˜¯Future&emsp;&emsp;Futureæ˜¯Java 5æ·»åŠ çš„ç±»ï¼Œç”¨æ¥æè¿°ä¸€ä¸ªå¼‚æ­¥è®¡ç®—çš„ç»“æœã€‚ä½ å¯ä»¥ä½¿ç”¨isDoneæ–¹æ³•æ£€æŸ¥è®¡ç®—æ˜¯å¦å®Œæˆï¼Œæˆ–è€…ä½¿ç”¨geté˜»å¡ä½è°ƒç”¨çº¿ç¨‹ï¼Œç›´åˆ°è®¡ç®—å®Œæˆè¿”å›ç»“æœï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨cancelæ–¹æ³•åœæ­¢ä»»åŠ¡çš„æ‰§è¡Œã€‚
package com.yuanxw.chapter24;import java.util.concurrent.ExecutionException;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.Future;import java.util.concurrent.ThreadLocalRandom;import java.util.concurrent.TimeUnit;public class FutureExample &#123;    public static void main(String[] args) throws ExecutionException, InterruptedException &#123;        // æ„é€ ä¸€ä¸ªçº¿ç¨‹æ±         ExecutorService executorService = Executors.newCachedThreadPool();        // æäº¤çº¿ç¨‹ä»»åŠ¡        Future&lt;Integer&gt; future = executorService.submit(() -&gt; &#123;            try &#123;                System.out.println(String.format(&quot;å½“å‰ã€%sã€‘çº¿ç¨‹å·¥ä½œ-å¼€å§‹...&quot;, Thread.currentThread().getName()));                TimeUnit.SECONDS.sleep(10);                System.out.println(String.format(&quot;å½“å‰ã€%sã€‘çº¿ç¨‹å·¥ä½œ-ç»“æŸ...&quot;, Thread.currentThread().getName()));                return ThreadLocalRandom.current().nextInt(100);            &#125; catch (InterruptedException e) &#123;                e.printStackTrace();                return -1;            &#125;        &#125;);        System.out.println(String.format(&quot;ã€%sã€‘åœ¨ç­‰å¾…çº¿ç¨‹æ‰§è¡Œç»“æœ...&quot;, Thread.currentThread().getName()));        System.out.println(&quot;æ˜¯å¦æ‰§è¡Œç»“æŸï¼š&quot;+future.isDone());        System.out.println(future.get());        System.out.println(&quot;æ˜¯å¦æ‰§è¡Œç»“æŸï¼š&quot;+future.isDone());    &#125;&#125;
æ‰§è¡Œç»“æœï¼š
å½“å‰ã€pool-1-thread-1ã€‘çº¿ç¨‹å·¥ä½œ-å¼€å§‹...ã€mainã€‘åœ¨ç­‰å¾…çº¿ç¨‹æ‰§è¡Œç»“æœ...æ˜¯å¦æ‰§è¡Œç»“æŸï¼šfalseå½“å‰ã€pool-1-thread-1ã€‘çº¿ç¨‹å·¥ä½œ-ç»“æŸ...76æ˜¯å¦æ‰§è¡Œç»“æŸï¼štrue
1.2 Futureçš„å±€é™æ€§&emsp;&emsp;è™½ç„¶Futureä»¥åŠç›¸å…³ä½¿ç”¨æ–¹æ³•æä¾›äº†å¼‚æ­¥æ‰§è¡Œä»»åŠ¡çš„èƒ½åŠ›ï¼Œä½†æ˜¯å¯¹äºç»“æœçš„è·å–å´æ˜¯å¾ˆä¸æ–¹ä¾¿ï¼Œåªèƒ½é€šè¿‡é˜»å¡æˆ–è€…è½®è¯¢çš„æ–¹å¼å¾—åˆ°ä»»åŠ¡çš„ç»“æœã€‚é˜»å¡çš„æ–¹å¼æ˜¾ç„¶å’Œæˆ‘ä»¬çš„å¼‚æ­¥ç¼–ç¨‹çš„åˆè¡·ç›¸è¿èƒŒï¼Œè½®è¯¢çš„æ–¹å¼åˆä¼šè€—è´¹æ— è°“çš„CPUèµ„æºï¼Œè€Œä¸”ä¹Ÿä¸èƒ½åŠæ—¶åœ°å¾—åˆ°è®¡ç®—ç»“æœã€‚CompletableFutureçš„å‡ºç°è§£å†³äº†Futureæ¨¡å¼çš„ç¼ºç‚¹ã€‚

ä¸èƒ½æ‰‹åŠ¨å®Œæˆï¼š
å½“ä½ å†™äº†ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºé€šè¿‡ä¸€ä¸ªè¿œç¨‹APIè·å–ä¸€ä¸ªç”µå­å•†åŠ¡äº§å“æœ€æ–°ä»·æ ¼ã€‚å› ä¸ºè¿™ä¸ª API å¤ªè€—æ—¶ï¼Œä½ æŠŠå®ƒå…è®¸åœ¨ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ä¸­ï¼Œå¹¶ä¸”ä»ä½ çš„å‡½æ•°ä¸­è¿”å›ä¸€ä¸ª Futureã€‚ç°åœ¨å‡è®¾è¿™ä¸ªAPIæœåŠ¡å®•æœºäº†ï¼Œè¿™æ—¶ä½ æƒ³é€šè¿‡è¯¥äº§å“çš„æœ€æ–°ç¼“å­˜ä»·æ ¼æ‰‹å·¥å®Œæˆè¿™ä¸ªFuture ã€‚ä½ ä¼šå‘ç°æ— æ³•è¿™æ ·åšã€‚


Futureçš„ç»“æœåœ¨éé˜»å¡çš„æƒ…å†µä¸‹ï¼Œä¸èƒ½æ‰§è¡Œæ›´è¿›ä¸€æ­¥çš„æ“ä½œï¼š
Future ä¸ä¼šé€šçŸ¥ä½ å®ƒå·²ç»å®Œæˆäº†ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªé˜»å¡çš„ get() æ–¹æ³•é€šçŸ¥ä½ ç»“æœã€‚ä½ æ— æ³•ç»™ Future æ¤å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“ Future ç»“æœå¯ç”¨çš„æ—¶å€™ï¼Œç”¨è¯¥å›è°ƒå‡½æ•°è‡ªåŠ¨çš„è°ƒç”¨ Future çš„ç»“æœã€‚


å¤šä¸ªFutureä¸èƒ½ä¸²è”åœ¨ä¸€èµ·ç»„æˆé“¾å¼è°ƒç”¨ï¼š
æœ‰æ—¶å€™ä½ éœ€è¦æ‰§è¡Œä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„è®¡ç®—ä»»åŠ¡ï¼Œå¹¶ä¸”å½“è®¡ç®—ä»»åŠ¡å®Œæˆçš„æ—¶å€™ï¼Œä½ éœ€è¦æŠŠå®ƒçš„è®¡ç®—ç»“æœå‘é€ç»™å¦å¤–ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„è®¡ç®—ä»»åŠ¡ç­‰ç­‰ã€‚ä½ ä¼šå‘ç°ä½ æ— æ³•ä½¿ç”¨ Future åˆ›å»ºè¿™æ ·çš„ä¸€ä¸ªå·¥ä½œæµã€‚  ä¸èƒ½ç»„åˆå¤šä¸ª Future çš„ç»“æœ  å‡è®¾ä½ æœ‰10ä¸ªä¸åŒçš„Futureï¼Œä½ æƒ³å¹¶è¡Œçš„è¿è¡Œï¼Œç„¶ååœ¨å®ƒä»¬è¿è¡Œæœªå®Œæˆåè¿è¡Œä¸€äº›å‡½æ•°ã€‚ä½ ä¼šå‘ç°ä½ ä¹Ÿæ— æ³•ä½¿ç”¨ Future è¿™æ ·åšã€‚


æ²¡æœ‰å¼‚å¸¸å¤„ç†ï¼š
Future API æ²¡æœ‰ä»»åŠ¡çš„å¼‚å¸¸å¤„ç†ç»“æ„å±…ç„¶æœ‰å¦‚æ­¤å¤šçš„é™åˆ¶ï¼Œå¹¸å¥½æˆ‘ä»¬æœ‰CompletableFutureï¼Œä½ å¯ä»¥ä½¿ç”¨ CompletableFuture è¾¾åˆ°ä»¥ä¸Šæ‰€æœ‰ç›®çš„ã€‚



1.3 ä»€ä¹ˆæ˜¯CompletableFuture&emsp;&emsp; åœ¨Javaä¸­CompletableFutureç”¨äºå¼‚æ­¥ç¼–ç¨‹ï¼Œå¼‚æ­¥ç¼–ç¨‹æ˜¯ç¼–å†™éé˜»å¡çš„ä»£ç ï¼Œè¿è¡Œçš„ä»»åŠ¡åœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ï¼Œä¸ä¸»çº¿ç¨‹éš”ç¦»ï¼Œå¹¶ä¸”ä¼šé€šçŸ¥ä¸»çº¿ç¨‹å®ƒçš„è¿›åº¦ï¼ŒæˆåŠŸæˆ–è€…å¤±è´¥ã€‚åœ¨è¿™ç§æ–¹å¼ä¸­ï¼Œä¸»çº¿ç¨‹ä¸ä¼šè¢«é˜»å¡ï¼Œä¸éœ€è¦ä¸€ç›´ç­‰åˆ°å­çº¿ç¨‹å®Œæˆã€‚ä¸»çº¿ç¨‹å¯ä»¥å¹¶è¡Œçš„æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚ä½¿ç”¨è¿™ç§å¹¶è¡Œæ–¹å¼ï¼Œå¯ä»¥æå¤§çš„æé«˜ç¨‹åºçš„æ€§èƒ½ã€‚&emsp;&emsp; CompletableFuture å®ç°äº† Future å’Œ CompletionStageæ¥å£ï¼Œå¹¶ä¸”æä¾›äº†è®¸å¤šå…³äºåˆ›å»ºï¼Œé“¾å¼è°ƒç”¨å’Œç»„åˆå¤šä¸ª Future çš„ä¾¿åˆ©æ–¹æ³•é›†ï¼Œè€Œä¸”æœ‰å¹¿æ³›çš„å¼‚å¸¸å¤„ç†æ”¯æŒã€‚&emsp;&emsp; CompletableFutureå’ŒJava8çš„Streamæ­é…ä½¿ç”¨ï¼Œä½¿ç”¨å¯¹äºä¸€äº›å¹¶è¡Œè®¿é—®çš„è€—æ—¶æ“ä½œæœ‰å¾ˆå¤§çš„æ“ä½œã€‚
CompletableFutureç»§æ‰¿ç»“æ„å…³ç³»å›¾ï¼š
CompletableFutureç±»å®ç°äº†CompletionStageå’ŒFutureæ¥å£ï¼Œæ‰€ä»¥ä½ è¿˜æ˜¯å¯ä»¥åƒä»¥å‰ä¸€æ ·é€šè¿‡é˜»å¡æˆ–è€…è½®è¯¢çš„æ–¹å¼è·å¾—ç»“æœï¼Œå°½ç®¡è¿™ç§æ–¹å¼ä¸æ¨èä½¿ç”¨ã€‚
1.4 CompletableFutureæ–¹æ³•åˆ†ç±»1.4.1. åˆ›å»ºCompletableFutureå¯¹è±¡&emsp;&emsp;ä»¥Asyncç»“å°¾å¹¶ä¸”æ²¡æœ‰æŒ‡å®šExecutorçš„æ–¹æ³•ä¼šä½¿ç”¨ForkJoinPool.commonPool()ä½œä¸ºå®ƒçš„çº¿ç¨‹æ± æ‰§è¡Œå¼‚æ­¥ä»£ç ã€‚runAsyncæ–¹æ³•ä¹Ÿå¥½ç†è§£ï¼Œå®ƒä»¥Runnableå‡½æ•°å¼æ¥å£ç±»å‹ä¸ºå‚æ•°ï¼Œæ‰€ä»¥CompletableFutureçš„è®¡ç®—ç»“æœä¸ºç©ºã€‚supplyAsyncæ–¹æ³•ä»¥Supplier&lt;U&gt;å‡½æ•°å¼æ¥å£ç±»å‹ä¸ºå‚æ•°,CompletableFutureçš„è®¡ç®—ç»“æœç±»å‹ä¸ºUã€‚CompletableFutureçš„é™æ€å·¥å‚æ–¹æ³•ï¼š



æ–¹æ³•å
æè¿°



runAsync(Runnable runnable)
ä½¿ç”¨ForkJoinPool.commonPool()ä½œä¸ºå®ƒçš„çº¿ç¨‹æ± æ‰§è¡Œå¼‚æ­¥ä»£ç ã€‚


runAsync(Runnable runnable, Executor executor)
ä½¿ç”¨æŒ‡å®šçš„thread poolæ‰§è¡Œå¼‚æ­¥ä»£ç ã€‚


supplyAsync(Supplier supplier)
ä½¿ç”¨ForkJoinPool.commonPool()ä½œä¸ºå®ƒçš„çº¿ç¨‹æ± æ‰§è¡Œå¼‚æ­¥ä»£ç ï¼Œå¼‚æ­¥æ“ä½œæœ‰è¿”å›å€¼ã€‚


supplyAsync(Supplier supplier, Executor executor)
ä½¿ç”¨æŒ‡å®šçš„thread poolæ‰§è¡Œå¼‚æ­¥ä»£ç ï¼Œå¼‚æ­¥æ“ä½œæœ‰è¿”å›å€¼ã€‚



CompletableFuture.completedFutureæ˜¯ä¸€ä¸ªé™æ€è¾…åŠ©æ–¹æ³•ï¼Œç”¨æ¥è¿”å›ä¸€ä¸ªå·²ç»è®¡ç®—å¥½çš„CompletableFutureã€‚

/** * Returns a new CompletableFuture that is already completed with * the given value. * * @param value the value * @param &lt;U&gt; the type of the value * @return the completed CompletableFuture */public static &lt;U&gt; CompletableFuture&lt;U&gt; completedFuture(U value) &#123;    return new CompletableFuture&lt;U&gt;((value == null) ? NIL : value);&#125;


è€Œä»¥ä¸‹å››ä¸ªé™æ€æ–¹æ³•ç”¨æ¥ä¸ºä¸€æ®µå¼‚æ­¥æ‰§è¡Œçš„ä»£ç åˆ›å»ºCompletableFutureå¯¹è±¡ï¼š

/** * Returns a new CompletableFuture that is asynchronously completed * by a task running in the &#123;@link ForkJoinPool#commonPool()&#125; with * the value obtained by calling the given Supplier. * * @param supplier a function returning the value to be used * to complete the returned CompletableFuture * @param &lt;U&gt; the function&#x27;s return type * @return the new CompletableFuture */public static &lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(Supplier&lt;U&gt; supplier) &#123;    return asyncSupplyStage(asyncPool, supplier);&#125;/** * Returns a new CompletableFuture that is asynchronously completed * by a task running in the given executor with the value obtained * by calling the given Supplier. * * @param supplier a function returning the value to be used * to complete the returned CompletableFuture * @param executor the executor to use for asynchronous execution * @param &lt;U&gt; the function&#x27;s return type * @return the new CompletableFuture */public static &lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(Supplier&lt;U&gt; supplier,Executor executor) &#123;    return asyncSupplyStage(screenExecutor(executor), supplier);&#125;/** * Returns a new CompletableFuture that is asynchronously completed * by a task running in the &#123;@link ForkJoinPool#commonPool()&#125; after * it runs the given action. * * @param runnable the action to run before completing the * returned CompletableFuture * @return the new CompletableFuture */public static CompletableFuture&lt;Void&gt; runAsync(Runnable runnable) &#123;    return asyncRunStage(asyncPool, runnable);&#125;/** * Returns a new CompletableFuture that is asynchronously completed * by a task running in the given executor after it runs the given * action. * * @param runnable the action to run before completing the * returned CompletableFuture * @param executor the executor to use for asynchronous execution * @return the new CompletableFuture */public static CompletableFuture&lt;Void&gt; runAsync(Runnable runnable,Executor executor) &#123;    return asyncRunStage(screenExecutor(executor), runnable);&#125;

1.4.2. ä¸»åŠ¨å®Œæˆè®¡ç®—


æ–¹æ³•å
æè¿°



get()
æ–¹æ³•åŒæ­¥ç­‰å¾…ç»“æœã€‚


get(timeout,unit)
get(timeout,unit)ç­¾åæ–¹æ³•ï¼Œç»™å®šæ—¶é—´ï¼Œç„¶åè¿”å›å…¶ç»“æœï¼Œå¦‚æœè¶…æ—¶ï¼ŒæŠ›å‡ºå¼‚å¸¸


join()
å®Œæˆåè¿”å›ç»“æœå€¼ï¼Œå¦‚æœå®Œæˆå¼‚å¸¸ï¼Œåˆ™è¿”å›ï¼ˆæœªæ£€æŸ¥ï¼‰å¼‚å¸¸ã€‚


getNow()
å¦‚æœå·²å®Œæˆï¼Œåˆ™è¿”å›ç»“æœå€¼ï¼ˆæˆ–æŠ›å‡ºä»»ä½•é‡åˆ°çš„å¼‚å¸¸ï¼‰ï¼Œå¦åˆ™è¿”å›ç»™å®šçš„å€¼IfAbsentã€‚


package com.yuanxw.chapter24;import java.util.concurrent.CompletableFuture;import java.util.concurrent.ExecutionException;import java.util.concurrent.ThreadLocalRandom;import java.util.concurrent.TimeUnit;import java.util.concurrent.TimeoutException;public class CompletableFutureExample1 &#123;    public static void main(String[] args) throws ExecutionException, InterruptedException &#123;        runAsync();        // get() æ–¹æ³•åŒæ­¥ç­‰å¾…ç»“æœã€‚        get();        // get(timeout,unit)ç­¾åæ–¹æ³•ï¼Œç»™å®šæ—¶é—´ï¼Œç„¶åè¿”å›å…¶ç»“æœï¼Œå¦‚æœè¶…æ—¶ï¼ŒæŠ›å‡ºå¼‚å¸¸        get(3,TimeUnit.SECONDS);        // join() å®Œæˆåè¿”å›ç»“æœå€¼ï¼Œå¦‚æœå®Œæˆå¼‚å¸¸ï¼Œåˆ™è¿”å›ï¼ˆæœªæ£€æŸ¥ï¼‰å¼‚å¸¸ã€‚        join();        // getNow() å¦‚æœå·²å®Œæˆï¼Œåˆ™è¿”å›ç»“æœå€¼ï¼ˆæˆ–æŠ›å‡ºä»»ä½•é‡åˆ°çš„å¼‚å¸¸ï¼‰ï¼Œå¦åˆ™è¿”å›ç»™å®šçš„å€¼IfAbsentã€‚        getNow();    &#125;    /**     * runAsync()å¼‚æ­¥æ‰§è¡ŒrunAsyncè¿”å›çš„CompletableFutureæ˜¯æ²¡æœ‰è¿”å›å€¼çš„ã€‚     * supplyAsync()å¼‚æ­¥æ‰§è¡ŒrunAsyncè¿”å›çš„CompletableFutureæ˜¯æœ‰è¿”å›å€¼çš„ã€‚     æ‰§è¡Œç»“æœï¼š     =====ã€mainã€‘æ‰§è¡ŒrunAsync()ç­¾åæ–¹æ³•-å¼€å§‹=====     Hello worldï¼ï¼ï¼     =====ã€mainã€‘æ‰§è¡ŒrunAsync()ç­¾åæ–¹æ³•-ç»“æŸ=====     * @throws ExecutionException     * @throws InterruptedException     */    private static void runAsync() throws ExecutionException, InterruptedException &#123;        System.out.println(String.format(&quot;=====ã€%sã€‘æ‰§è¡ŒrunAsync()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;, Thread.currentThread().getName()));        CompletableFuture.runAsync(() -&gt; System.out.println(&quot;Hello worldï¼ï¼ï¼&quot;)).get();        System.out.println(String.format(&quot;=====ã€%sã€‘æ‰§è¡ŒrunAsync()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;, Thread.currentThread().getName()));    &#125;    /**     get() æ–¹æ³•åŒæ­¥ç­‰å¾…ç»“æœã€‚     æ‰§è¡Œç»“æœï¼š          =====ã€mainã€‘æ‰§è¡Œget()ç­¾åæ–¹æ³•-å¼€å§‹=====          get()ç­¾åæ–¹æ³•ï¼Œæ‰§è¡Œç»“æœï¼š4          =====ã€mainã€‘æ‰§è¡Œget()ç­¾åæ–¹æ³•-ç»“æŸ=====     * @throws ExecutionException     * @throws InterruptedException     */    private static void get() throws ExecutionException, InterruptedException &#123;        System.out.println(String.format(&quot;=====ã€%sã€‘æ‰§è¡Œget()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;, Thread.currentThread().getName()));        CompletableFuture&lt;Integer&gt; completableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;            // ç¡çœ 5ç§’            processSleep(5);            return ThreadLocalRandom.current().nextInt(10) * 2;        &#125;);        /** get() æ–¹æ³•åŒæ­¥ç­‰å¾…ç»“æœã€‚ **/        System.out.println(&quot;get()ç­¾åæ–¹æ³•ï¼Œæ‰§è¡Œç»“æœï¼š&quot;+completableFuture.get());        System.out.println(String.format(&quot;=====ã€%sã€‘æ‰§è¡Œget()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;, Thread.currentThread().getName()));    &#125;    /**     get(timeout,unit)ç­¾åæ–¹æ³•ï¼Œç»™å®šæ—¶é—´ï¼Œç„¶åè¿”å›å…¶ç»“æœï¼Œå¦‚æœè¶…æ—¶ï¼ŒæŠ›å‡ºå¼‚å¸¸     æ‰§è¡Œç»“æœï¼š     =====ã€mainã€‘æ‰§è¡Œget(timeout,unit)ç­¾åæ–¹æ³•-å¼€å§‹=====     java.util.concurrent.TimeoutException     	at java.util.concurrent.CompletableFuture.timedGet(CompletableFuture.java:1771)     	at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1915)     	at com.yuanxw.chapter24.CompletableFutureExample.get(CompletableFutureExample.java:53)     	at com.yuanxw.chapter24.CompletableFutureExample.main(CompletableFutureExample.java:11)     =====ã€mainã€‘æ‰§è¡Œget(timeout,unit)ç­¾åæ–¹æ³•-ç»“æŸ=====     *     * @param timeout     * @param unit     * @throws ExecutionException     * @throws InterruptedException     */    private static void get(long timeout, TimeUnit unit) throws ExecutionException, InterruptedException &#123;        System.out.println(String.format(&quot;=====ã€%sã€‘æ‰§è¡Œget(timeout,unit)ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;, Thread.currentThread().getName()));        CompletableFuture&lt;Integer&gt; completableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;            // ç¡çœ 5ç§’            processSleep(5);            return ThreadLocalRandom.current().nextInt(10) * 2;        &#125;);        try &#123;            System.out.println(&quot;get(timeout,unit)ç­¾åæ–¹æ³•ï¼Œæ‰§è¡Œç»“æœï¼š&quot;+completableFuture.get(timeout,unit));        &#125; catch (TimeoutException e) &#123;            e.printStackTrace();        &#125;        System.out.println(String.format(&quot;=====ã€%sã€‘æ‰§è¡Œget(timeout,unit)ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;, Thread.currentThread().getName()));    &#125;    /**      join() å®Œæˆåè¿”å›ç»“æœå€¼ï¼Œå¦‚æœå®Œæˆå¼‚å¸¸ï¼Œåˆ™è¿”å›ï¼ˆæœªæ£€æŸ¥ï¼‰å¼‚å¸¸ã€‚     æ‰§è¡Œç»“æœï¼š         =====ã€mainã€‘æ‰§è¡Œjoin()ç­¾åæ–¹æ³•-å¼€å§‹=====         join()ç­¾åæ–¹æ³•ï¼Œæ‰§è¡Œç»“æœï¼š40         =====ã€mainã€‘æ‰§è¡Œjoin()ç­¾åæ–¹æ³•-ç»“æŸ=====     * @throws ExecutionException     * @throws InterruptedException     */    private static void join() throws ExecutionException, InterruptedException &#123;        System.out.println(String.format(&quot;=====ã€%sã€‘æ‰§è¡Œjoin()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;, Thread.currentThread().getName()));        CompletableFuture&lt;Integer&gt; completableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;            // ç¡çœ 5ç§’            processSleep(5);            return ThreadLocalRandom.current().nextInt(10) * 5;        &#125;);        /** join() å®Œæˆåè¿”å›ç»“æœå€¼ï¼Œå¦‚æœå®Œæˆå¼‚å¸¸ï¼Œåˆ™è¿”å›ï¼ˆæœªæ£€æŸ¥ï¼‰å¼‚å¸¸ã€‚ **/        System.out.println(&quot;join()ç­¾åæ–¹æ³•ï¼Œæ‰§è¡Œç»“æœï¼š&quot;+ completableFuture.join());        System.out.println(String.format(&quot;=====ã€%sã€‘æ‰§è¡Œjoin()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;, Thread.currentThread().getName()));    &#125;    /**     getNow() å¦‚æœå·²å®Œæˆï¼Œåˆ™è¿”å›ç»“æœå€¼ï¼ˆæˆ–æŠ›å‡ºä»»ä½•é‡åˆ°çš„å¼‚å¸¸ï¼‰ï¼Œå¦åˆ™è¿”å›ç»™å®šçš„å€¼IfAbsentã€‚     æ‰§è¡Œç»“æœï¼š      =====ã€mainã€‘æ‰§è¡ŒgetNow()ç­¾åæ–¹æ³•-å¼€å§‹=====      getNow()ç­¾åæ–¹æ³•ï¼Œæ‰§è¡Œç»“æœï¼š===unknown===      getNow()ç­¾åæ–¹æ³•ï¼Œæ‰§è¡Œç»“æœï¼šN      =====ã€mainã€‘getNow()ç­¾åæ–¹æ³•-ç»“æŸ=====     */    private static void getNow() &#123;        System.out.println(String.format(&quot;=====ã€%sã€‘æ‰§è¡ŒgetNow()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;, Thread.currentThread().getName()));        CompletableFuture&lt;String&gt; completableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;            // ç¡çœ 5ç§’            processSleep(5);            // ç”Ÿæˆéšæœºå­—ç¬¦            char c = (char) (ThreadLocalRandom.current().nextInt(25 )+ 65);            return String.valueOf(c);        &#125;);        /** getNow() å¦‚æœå·²å®Œæˆï¼Œåˆ™è¿”å›ç»“æœå€¼ï¼ˆæˆ–æŠ›å‡ºä»»ä½•é‡åˆ°çš„å¼‚å¸¸ï¼‰ï¼Œå¦åˆ™è¿”å›ç»™å®šçš„å€¼IfAbsentã€‚ **/        System.out.println(&quot;getNow()ç­¾åæ–¹æ³•ï¼Œæ‰§è¡Œç»“æœï¼š&quot;+ completableFuture.getNow(&quot;===unknown===&quot;));        processSleep(6);        System.out.println(&quot;getNow()ç­¾åæ–¹æ³•ï¼Œæ‰§è¡Œç»“æœï¼š&quot;+ completableFuture.getNow(&quot;===unknown===&quot;));        System.out.println(String.format(&quot;=====ã€%sã€‘getNow()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;, Thread.currentThread().getName()));    &#125;    /**     * çº¿ç¨‹ä¼‘çœ çš„æ–¹æ³•     * @param seconds     */    private static void processSleep(long seconds) &#123;        try &#123;            TimeUnit.SECONDS.sleep(seconds);        &#125; catch (InterruptedException e) &#123;            e.printStackTrace();        &#125;    &#125;&#125;

1.4.3. è®¡ç®—ç»“æœå®Œæˆæ—¶çš„å¤„ç† &emsp;&emsp; å½“CompletableFutureè®¡ç®—ç»“æœå®Œæˆæ—¶,æˆ‘ä»¬éœ€è¦å¯¹ç»“æœè¿›è¡Œå¤„ç†ï¼Œæˆ–è€…å½“CompletableFutureäº§ç”Ÿå¼‚å¸¸çš„æ—¶å€™éœ€è¦å¯¹å¼‚å¸¸è¿›è¡Œå¤„ç†ã€‚æœ‰å¦‚ä¸‹å‡ ç§æ–¹æ³•:



æ–¹æ³•å
æè¿°



whenComplete(BiConsumer&lt;? super T, ? super Throwable&gt; action)
å½“CompletableFutureå®Œæˆè®¡ç®—ç»“æœæ—¶å¯¹ç»“æœè¿›è¡Œå¤„ç†ï¼Œæˆ–è€…å½“CompletableFutureäº§ç”Ÿå¼‚å¸¸çš„æ—¶å€™å¯¹å¼‚å¸¸è¿›è¡Œå¤„ç†ã€‚


whenCompleteAsync(BiConsumer&lt;? super T, ? super Throwable&gt; action)
å½“CompletableFutureå®Œæˆè®¡ç®—ç»“æœæ—¶å¯¹ç»“æœè¿›è¡Œå¤„ç†ï¼Œæˆ–è€…å½“CompletableFutureäº§ç”Ÿå¼‚å¸¸çš„æ—¶å€™å¯¹å¼‚å¸¸è¿›è¡Œå¤„ç†ã€‚ä½¿ç”¨ForkJoinPoolã€‚


BiConsumer&lt;? super T, ? super Throwable&gt; action, Executor executor)
å½“CompletableFutureå®Œæˆè®¡ç®—ç»“æœæ—¶å¯¹ç»“æœè¿›è¡Œå¤„ç†ï¼Œæˆ–è€…å½“CompletableFutureäº§ç”Ÿå¼‚å¸¸çš„æ—¶å€™å¯¹å¼‚å¸¸è¿›è¡Œå¤„ç†ã€‚ä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ± ã€‚


package com.yuanxw.chapter24;import java.util.concurrent.CompletableFuture;import java.util.concurrent.TimeUnit;public class CompletableFutureExample2 &#123;    public static void main(String[] args) throws InterruptedException &#123;        whenComplete();        Thread.currentThread().join();    &#125;    /**     * runAsync()å¼‚æ­¥æ‰§è¡ŒrunAsyncè¿”å›çš„CompletableFutureæ˜¯æ²¡æœ‰è¿”å›å€¼çš„ã€‚     * supplyAsync()å¼‚æ­¥æ‰§è¡ŒrunAsyncè¿”å›çš„CompletableFutureæ˜¯æœ‰è¿”å›å€¼çš„ã€‚     æ‰§è¡Œç»“æœï¼š     =====ã€mainã€‘æ‰§è¡ŒrunAsync()ç­¾åæ–¹æ³•-å¼€å§‹=====     Hello worldï¼ï¼ï¼     =====ã€mainã€‘æ‰§è¡ŒrunAsync()ç­¾åæ–¹æ³•-ç»“æŸ=====     */    /**     * whenComplete()ï¼šå½“CompletableFutureå®Œæˆè®¡ç®—ç»“æœæ—¶å¯¹ç»“æœè¿›è¡Œå¤„ç†ï¼Œæˆ–è€…å½“CompletableFutureäº§ç”Ÿå¼‚å¸¸çš„æ—¶å€™å¯¹å¼‚å¸¸è¿›è¡Œå¤„ç†ã€‚     æ‰§è¡Œç»“æœï¼š         =====æ‰§è¡ŒwhenComplete()ç­¾åæ–¹æ³•-å¼€å§‹=====         æ‰§è¡ŒsupplyAsync()ç­¾åæ–¹æ³•-ç»“æŸ&gt;&gt;&gt;&gt;&gt;         ç»Ÿè®¡å­—ç¬¦ä¸²é•¿åº¦ï¼š14         =====æ‰§è¡ŒwhenComplete()ç­¾åæ–¹æ³•-ç»“æŸ=====     */    private static void whenComplete()  &#123;        System.out.println(&quot;=====æ‰§è¡ŒwhenComplete()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        CompletableFuture.supplyAsync(() -&gt;&#123;            // ç¡çœ 5ç§’            processSleep(5);            System.out.println(&quot;æ‰§è¡ŒsupplyAsync()ç­¾åæ–¹æ³•-ç»“æŸ&gt;&gt;&gt;&gt;&gt;&quot;);            return &quot;Hello worldï¼ï¼ï¼&quot;;        &#125;).whenComplete((s, throwable) -&gt; &#123;            System.out.println(&quot;ç»Ÿè®¡å­—ç¬¦ä¸²é•¿åº¦ï¼š&quot;+s.length());            System.out.println(&quot;=====æ‰§è¡ŒwhenComplete()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);        &#125;);    &#125;    /**     * çº¿ç¨‹ä¼‘çœ çš„æ–¹æ³•     * @param seconds     */    private static void processSleep(long seconds) &#123;        try &#123;            TimeUnit.SECONDS.sleep(seconds);        &#125; catch (InterruptedException e) &#123;            e.printStackTrace();        &#125;    &#125;&#125;


1.4.4. è®¡ç®—ç»“æœå®Œæˆæ—¶çš„è½¬æ¢ &emsp;&emsp; è¿™é‡ŒåŒæ ·ä¹Ÿæ˜¯è¿”å›CompletableFutureï¼Œä½†æ˜¯è¿™ä¸ªç»“æœä¼šç”±æˆ‘ä»¬è‡ªå®šä¹‰è¿”å›å»è½¬æ¢ä»–ï¼ŒåŒæ ·çš„ä¸ä»¥Asyncç»“å°¾çš„æ–¹æ³•ç”±åŸæ¥çš„çº¿ç¨‹è®¡ç®—ï¼Œä»¥Asyncç»“å°¾çš„æ–¹æ³•ç”±é»˜è®¤çš„çº¿ç¨‹æ± ForkJoinPool.commonPool()æˆ–è€…æŒ‡å®šçš„çº¿ç¨‹æ± executorè¿è¡Œã€‚



æ–¹æ³•å
æè¿°



public &lt;U&gt; CompletableFuture&lt;U&gt; thenApply(Function&lt;? super T,? extends U&gt; fn)
æ¥å—ä¸€ä¸ªFunction&lt;? super T,? extends U&gt;å‚æ•°ç”¨æ¥è½¬æ¢CompletableFutureã€‚


public &lt;U&gt; CompletableFuture&lt;U&gt; thenApplyAsync(Function&lt;? super T,? extends U&gt; fn)
æ¥å—ä¸€ä¸ªFunction&lt;? super T,? extends U&gt;å‚æ•°ç”¨æ¥è½¬æ¢CompletableFutureï¼Œä½¿ç”¨ForkJoinPoolã€‚


public &lt;U&gt; CompletableFuture&lt;U&gt; thenApplyAsync(Function&lt;? super T,? extends U&gt; fn, Executor executor)
æ¥å—ä¸€ä¸ªFunction&lt;? super T,? extends U&gt;å‚æ•°ç”¨æ¥è½¬æ¢CompletableFutureï¼Œä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ± ã€‚


package com.yuanxw.chapter24;import java.util.concurrent.CompletableFuture;import java.util.concurrent.ExecutionException;import java.util.concurrent.ThreadLocalRandom;import java.util.concurrent.TimeUnit;import java.util.stream.IntStream;public class CompletableFutureExample3 &#123;    public static void main(String[] args) throws ExecutionException, InterruptedException &#123;        thenApply();    &#125;    /**     thenApply() å½“åŸæ¥çš„CompletableFutureè®¡ç®—å®Œåï¼Œå°†ç»“æœä¼ é€’ç»™å‡½æ•°fnï¼Œå°†fnçš„ç»“æœä½œä¸ºæ–°çš„CompletableFutureè®¡ç®—ç»“æœã€‚     å› æ­¤å®ƒçš„åŠŸèƒ½ç›¸å½“äºå°†CompletableFuture&lt;T&gt;è½¬æ¢æˆCompletableFuture&lt;U&gt;ã€‚ã€‚     æ‰§è¡Œç»“æœï¼š         =====æ‰§è¡ŒthenApply()ç­¾åæ–¹æ³•-å¼€å§‹=====         thenApply()ç­¾åæ–¹æ³•ï¼Œåœ¨supplyAsyncé˜¶æ®µï¼Œæ‰§è¡Œç»“æœï¼šDFRHHQ         thenApply()ç­¾åæ–¹æ³•ï¼Œæ‰§è¡Œç»“æœï¼š###ã€dfrhhqã€‘###         =====thenApply()ç­¾åæ–¹æ³•-ç»“æŸ=====     */    private static void thenApply() throws ExecutionException, InterruptedException &#123;        System.out.println(&quot;=====æ‰§è¡ŒthenApply()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        CompletableFuture&lt;String&gt; completableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;            // ç¡çœ 5ç§’            processSleep(5);            StringBuffer buffer = new StringBuffer();            IntStream.range(0,6).boxed().forEach(integer -&gt; &#123;                // ç”Ÿæˆéšæœºå­—ç¬¦                char c = (char) (ThreadLocalRandom.current().nextInt(25 )+ 65);                buffer.append(c);            &#125;);            System.out.println(&quot;thenApply()ç­¾åæ–¹æ³•ï¼Œåœ¨supplyAsyncé˜¶æ®µï¼Œæ‰§è¡Œç»“æœï¼š&quot; + buffer.toString());            return buffer.toString();        &#125;).thenApply(str -&gt; String.format(&quot;###ã€%sã€‘###&quot;, str.toLowerCase()));        System.out.println(&quot;thenApply()ç­¾åæ–¹æ³•ï¼Œæ‰§è¡Œç»“æœï¼š&quot;+ completableFuture.get());        System.out.println(&quot;=====thenApply()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**     * çº¿ç¨‹ä¼‘çœ çš„æ–¹æ³•     * @param seconds     */    private static void processSleep(long seconds) &#123;        try &#123;            TimeUnit.SECONDS.sleep(seconds);        &#125; catch (InterruptedException e) &#123;            e.printStackTrace();        &#125;    &#125;&#125;

1.4.5. è®¡ç®—ç»“æœå®Œæˆæ—¶çš„æ¶ˆè´¹ &emsp;&emsp; è¿™é‡Œè¿˜ä¼šæœ‰ä¸€ä¸ªåªä¼šå¯¹è®¡ç®—ç»“æœæ¶ˆè´¹ä¸ä¼šè¿”å›ä»»ä½•ç»“æœçš„æ–¹æ³•ã€‚åŒæ ·çš„ä¸ä»¥Asyncç»“å°¾çš„æ–¹æ³•ç”±åŸæ¥çš„çº¿ç¨‹è®¡ç®—ï¼Œä»¥Asyncç»“å°¾çš„æ–¹æ³•ç”±é»˜è®¤çš„çº¿ç¨‹æ± ForkJoinPool.commonPool()æˆ–è€…æŒ‡å®šçš„çº¿ç¨‹æ± executorè¿è¡Œã€‚



æ–¹æ³•å
æè¿°



public CompletableFuture thenAccept(Consumer&lt;? super T&gt; action)
å½“CompletableFutureå®Œæˆè®¡ç®—ç»“æœï¼Œåªå¯¹ç»“æœæ‰§è¡ŒActionï¼Œè€Œä¸è¿”å›æ–°çš„è®¡ç®—å€¼ã€‚


public CompletableFuture thenAcceptAsync(Consumer&lt;? super T&gt; action)
å½“CompletableFutureå®Œæˆè®¡ç®—ç»“æœï¼Œåªå¯¹ç»“æœæ‰§è¡ŒActionï¼Œè€Œä¸è¿”å›æ–°çš„è®¡ç®—å€¼ï¼Œä½¿ç”¨ForkJoinPoolã€‚


public CompletableFuture thenAcceptAsync(Consumer&lt;? super T&gt; action,Executor executor)
å½“CompletableFutureå®Œæˆè®¡ç®—ç»“æœï¼Œåªå¯¹ç»“æœæ‰§è¡ŒActionï¼Œè€Œä¸è¿”å›æ–°çš„è®¡ç®—å€¼ã€‚


package com.yuanxw.chapter24;import java.util.concurrent.CompletableFuture;import java.util.concurrent.ExecutionException;import java.util.concurrent.ThreadLocalRandom;import java.util.concurrent.TimeUnit;import java.util.stream.IntStream;public class CompletableFutureExample4 &#123;    public static void main(String[] args) throws ExecutionException, InterruptedException &#123;        thenAccept();    &#125;    /**     thenAccept() CompletableFutureå®Œæˆè®¡ç®—ç»“æœï¼Œåªå¯¹ç»“æœæ‰§è¡ŒActionï¼Œè€Œä¸è¿”å›æ–°çš„è®¡ç®—å€¼ã€‚     æ‰§è¡Œç»“æœï¼š     =====æ‰§è¡ŒthenAccept()ç­¾åæ–¹æ³•-å¼€å§‹=====     ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆçš„6ä½éªŒè¯ç ï¼šEHSRHTï¼Œè¯¥éªŒè¯ç 5åˆ†é’Ÿæœ‰æ•ˆï¼Œè¯·å‹¿æ³„éœ²ç»™ä»–äººã€‚     =====thenAccept()ç­¾åæ–¹æ³•-ç»“æŸ=====     */    private static void thenAccept() throws ExecutionException, InterruptedException &#123;        System.out.println(&quot;=====æ‰§è¡ŒthenAccept()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        CompletableFuture                .supplyAsync(() -&gt; &quot;ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆçš„6ä½éªŒè¯ç ï¼š&quot;)                .thenApply((str) -&gt; str + verifiCode())                .thenApply((str) -&gt; str + &quot;ï¼Œè¯¥éªŒè¯ç 5åˆ†é’Ÿæœ‰æ•ˆï¼Œè¯·å‹¿æ³„éœ²ç»™ä»–äººã€‚&quot;)                .thenAccept(System.out::println);        System.out.println(&quot;=====thenAccept()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**     * ç”Ÿæˆ6ä½æ•°éªŒè¯ç      * @return     */    private static String verifiCode()&#123;        StringBuffer buffer = new StringBuffer();        IntStream.range(0,6).boxed().forEach(integer -&gt; &#123;            // ç”Ÿæˆéšæœºå­—ç¬¦            char c = (char) (ThreadLocalRandom.current().nextInt(25 )+ 65);            buffer.append(c);        &#125;);        return buffer.toString();    &#125;&#125;
1.4.6. è®¡ç®—ç»“æœå®Œæˆæ—¶çš„æ¶ˆè´¹åˆå¹¶ç»“æœ &emsp;&emsp; thenAcceptBothä»¥åŠç›¸å…³æ–¹æ³•æä¾›äº†ç±»ä¼¼çš„åŠŸèƒ½ï¼Œå½“ä¸¤ä¸ªCompletionStageéƒ½æ­£å¸¸å®Œæˆè®¡ç®—çš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡Œæä¾›çš„actionï¼Œå®ƒç”¨æ¥ç»„åˆå¦å¤–ä¸€ä¸ªå¼‚æ­¥çš„ç»“æœã€‚
&emsp;&emsp; runAfterBothæ˜¯å½“ä¸¤ä¸ªCompletionStageéƒ½æ­£å¸¸å®Œæˆè®¡ç®—çš„æ—¶å€™,æ‰§è¡Œä¸€ä¸ªRunnableï¼Œè¿™ä¸ªRunnableå¹¶ä¸ä½¿ç”¨è®¡ç®—çš„ç»“æœã€‚



æ–¹æ³•å
æè¿°



public &lt;U&gt; CompletableFuture&lt;Void&gt; thenAcceptBoth(CompletionStage&lt;? extends U&gt; other,BiConsumer&lt;? super T, ? super U&gt; action)
å½“ä¸¤ä¸ªCompletableFutureéƒ½æ­£å¸¸å®Œæˆåï¼Œæ‰§è¡Œæä¾›çš„actionï¼Œç”¨å®ƒæ¥ç»„åˆå¦å¤–ä¸€ä¸ªCompletableFutureçš„ç»“æœã€‚


public &lt;U&gt; CompletableFuture&lt;Void&gt; thenAcceptBothAsync(CompletionStage&lt;? extends U&gt; other,BiConsumer&lt;? super T, ? super U&gt; action)
å½“ä¸¤ä¸ªCompletableFutureéƒ½æ­£å¸¸å®Œæˆåï¼Œæ‰§è¡Œæä¾›çš„actionï¼Œç”¨å®ƒæ¥ç»„åˆå¦å¤–ä¸€ä¸ªCompletableFutureçš„ç»“æœã€‚ä½¿ç”¨ForkJoinPoolã€‚


public &lt;U&gt; CompletableFuture&lt;Void&gt; thenAcceptBothAsync(CompletionStage&lt;? extends U&gt; other,BiConsumer&lt;? super T, ? super U&gt; action, Executor executor)
å½“ä¸¤ä¸ªCompletableFutureéƒ½æ­£å¸¸å®Œæˆåï¼Œæ‰§è¡Œæä¾›çš„actionï¼Œç”¨å®ƒæ¥ç»„åˆå¦å¤–ä¸€ä¸ªCompletableFutureçš„ç»“æœã€‚ä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ± ã€‚


public CompletableFuture&lt;Void&gt; runAfterBoth(CompletionStage&lt;?&gt; other,Runnable action)
å½“ä¸¤ä¸ªCompletionStageéƒ½æ­£å¸¸å®Œæˆè®¡ç®—çš„æ—¶å€™,æ‰§è¡Œä¸€ä¸ªRunnableï¼Œè¿™ä¸ªRunnableå¹¶ä¸ä½¿ç”¨è®¡ç®—çš„ç»“æœã€‚


public CompletableFuture&lt;Void&gt; runAfterBothAsync(CompletionStage&lt;?&gt; other,Runnable action)
å½“ä¸¤ä¸ªCompletionStageéƒ½æ­£å¸¸å®Œæˆè®¡ç®—çš„æ—¶å€™,æ‰§è¡Œä¸€ä¸ªRunnableï¼Œè¿™ä¸ªRunnableå¹¶ä¸ä½¿ç”¨è®¡ç®—çš„ç»“æœã€‚ä½¿ç”¨ForkJoinPoolã€‚


public CompletableFuture&lt;Void&gt; runAfterBothAsync(CompletionStage&lt;?&gt; other,Runnable action,Executor executor)
å½“ä¸¤ä¸ªCompletionStageéƒ½æ­£å¸¸å®Œæˆè®¡ç®—çš„æ—¶å€™,æ‰§è¡Œä¸€ä¸ªRunnableï¼Œè¿™ä¸ªRunnableå¹¶ä¸ä½¿ç”¨è®¡ç®—çš„ç»“æœã€‚ä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ± ã€‚


package com.yuanxw.chapter24;import java.util.concurrent.CompletableFuture;import java.util.concurrent.TimeUnit;public class CompletableFutureExample5 &#123;    public static void main(String[] args) throws InterruptedException &#123;        thenAcceptBoth();        runAfterBoth();        Thread.currentThread().join();    &#125;    /**     thenAcceptBoth() å½“ä½ æƒ³è¦ä½¿ç”¨ä¸¤ä¸ªFutureç»“æœæ—¶ï¼Œä½†ä¸éœ€è¦å°†ä»»ä½•ç»“æœå€¼è¿›è¡Œè¿”å›æ—¶ï¼Œ     å¯ä»¥ç”¨ thenAcceptBoth ï¼Œå®ƒè¡¨ç¤ºåç»­çš„å¤„ç†ä¸éœ€è¦è¿”å›å€¼ã€‚     æ‰§è¡Œç»“æœï¼š         =====æ‰§è¡ŒthenAcceptBoth()ç­¾åæ–¹æ³•-å¼€å§‹=====         Hello World         =====thenAcceptBoth()ç­¾åæ–¹æ³•-ç»“æŸ=====     */    private static void thenAcceptBoth() &#123;        System.out.println(&quot;=====æ‰§è¡ŒthenAcceptBoth()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        CompletableFuture.supplyAsync(() -&gt; &quot;Hello&quot;)                .thenAcceptBoth(CompletableFuture.supplyAsync(() -&gt; &quot; World&quot;),                        (s1, s2) -&gt; System.out.println(s1 + s2));        System.out.println(&quot;=====thenAcceptBoth()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**     * runAfterBothæ˜¯å½“ä¸¤ä¸ªCompletionStageéƒ½æ­£å¸¸å®Œæˆè®¡ç®—çš„æ—¶å€™,     æ‰§è¡Œä¸€ä¸ªRunnableï¼Œè¿™ä¸ªRunnableå¹¶ä¸ä½¿ç”¨è®¡ç®—çš„ç»“æœã€‚     æ‰§è¡Œç»“æœï¼š          =====æ‰§è¡ŒrunAfterBoth()ç­¾åæ–¹æ³•-å¼€å§‹=====          ForkJoinPool.commonPool-worker-1çº¿ç¨‹ï¼Œå·¥ä½œ-å¼€å§‹&gt;&gt;          ForkJoinPool.commonPool-worker-2çº¿ç¨‹ï¼Œå·¥ä½œ-å¼€å§‹&gt;&gt;          =====runAfterBoth()ç­¾åæ–¹æ³•-ç»“æŸ=====          ForkJoinPool.commonPool-worker-2çº¿ç¨‹ï¼Œå·¥ä½œ-ç»“æŸ&lt;&lt;          ForkJoinPool.commonPool-worker-1çº¿ç¨‹ï¼Œå·¥ä½œ-ç»“æŸ&lt;&lt;          ===æ‰§è¡Œä»»åŠ¡ç»“æŸ===     */    private static void runAfterBoth() &#123;        System.out.println(&quot;=====æ‰§è¡ŒrunAfterBoth()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        CompletableFuture.supplyAsync(() -&gt; &#123;            System.out.println(Thread.currentThread().getName() + &quot;çº¿ç¨‹ï¼Œå·¥ä½œ-å¼€å§‹&gt;&gt;&quot;);            // ç¡çœ 5ç§’            processSleep(5);            System.out.println(Thread.currentThread().getName() + &quot;çº¿ç¨‹ï¼Œå·¥ä½œ-ç»“æŸ&lt;&lt;&quot;);            return 1;        &#125;).runAfterBoth(CompletableFuture.supplyAsync(() -&gt; &#123;            System.out.println(Thread.currentThread().getName() + &quot;çº¿ç¨‹ï¼Œå·¥ä½œ-å¼€å§‹&gt;&gt;&quot;);            // ç¡çœ 1ç§’            processSleep(1);            System.out.println(Thread.currentThread().getName() + &quot;çº¿ç¨‹ï¼Œå·¥ä½œ-ç»“æŸ&lt;&lt;&quot;);            return 2;        &#125;), () -&gt; System.out.println(&quot;===æ‰§è¡Œä»»åŠ¡ç»“æŸ===&quot;));        System.out.println(&quot;=====runAfterBoth()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**     * çº¿ç¨‹ä¼‘çœ çš„æ–¹æ³•     * @param seconds     */    private static void processSleep(long seconds) &#123;        try &#123;            TimeUnit.SECONDS.sleep(seconds);        &#125; catch (InterruptedException e) &#123;            e.printStackTrace();        &#125;    &#125;&#125;


1.4.7. å¯¹è®¡ç®—ç»“æœçš„ç»„åˆ &emsp;&emsp; å¯¹äºComposeå¯ä»¥è¿æ¥ä¸¤ä¸ªCompletableFutureï¼Œå…¶å†…éƒ¨å¤„ç†é€»è¾‘æ˜¯å½“ç¬¬ä¸€ä¸ªCompletableFutureå¤„ç†æ²¡æœ‰å®Œæˆæ—¶ä¼šåˆå¹¶æˆä¸€ä¸ªCompletableFuture,å¦‚æœå¤„ç†å®Œæˆï¼Œç¬¬äºŒä¸ªfutureä¼šç´§æ¥ä¸Šä¸€ä¸ªCompletableFutureè¿›è¡Œå¤„ç†ã€‚



æ–¹æ³•å
æè¿°



public &lt;U,V&gt; CompletableFuture&lt;V&gt; thenCombine(CompletionStage&lt;? extends U&gt; other,BiFunction&lt;? super T,? super U,? extends V&gt; fn)
å½“ä¸¤ä¸ªCompletableFutureéƒ½æ­£å¸¸å®Œæˆåï¼Œæ‰§è¡Œæä¾›çš„fnï¼Œç”¨å®ƒæ¥ç»„åˆå¦å¤–ä¸€ä¸ªCompletableFutureçš„ç»“æœã€‚


public &lt;U,V&gt; CompletableFuture&lt;V&gt; thenCombineAsync(CompletionStage&lt;? extends U&gt; other,BiFunction&lt;? super T,? super U,? extends V&gt; fn)
å½“ä¸¤ä¸ªCompletableFutureéƒ½æ­£å¸¸å®Œæˆåï¼Œæ‰§è¡Œæä¾›çš„fnï¼Œç”¨å®ƒæ¥ç»„åˆå¦å¤–ä¸€ä¸ªCompletableFutureçš„ç»“æœã€‚ä½¿ç”¨ForkJoinPoolã€‚


public &lt;U,V&gt; CompletableFuture&lt;V&gt; thenCombineAsync(CompletionStage&lt;? extends U&gt; other,BiFunction&lt;? super T,? super U,? extends V&gt; fn, Executor executor)
å½“ä¸¤ä¸ªCompletableFutureéƒ½æ­£å¸¸å®Œæˆåï¼Œæ‰§è¡Œæä¾›çš„fnï¼Œç”¨å®ƒæ¥ç»„åˆå¦å¤–ä¸€ä¸ªCompletableFutureçš„ç»“æœã€‚ä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ± ã€‚


package com.yuanxw.chapter24;import java.util.concurrent.CompletableFuture;import java.util.concurrent.ExecutionException;public class CompletableFutureExample6 &#123;    public static void main(String[] args) throws ExecutionException, InterruptedException &#123;        thenCombine();    &#125;    /**     * æ‰§è¡ŒthenCombine()å¯¹äºComposeå¯ä»¥è¿æ¥ä¸¤ä¸ªCompletableFutureï¼Œ     * å…¶å†…éƒ¨å¤„ç†é€»è¾‘æ˜¯å½“ç¬¬ä¸€ä¸ªCompletableFutureå¤„ç†æ²¡æœ‰å®Œæˆæ—¶ä¼šåˆå¹¶æˆä¸€ä¸ªCompletableFuture,     * å¦‚æœå¤„ç†å®Œæˆï¼Œç¬¬äºŒä¸ªfutureä¼šç´§æ¥ä¸Šä¸€ä¸ªCompletableFutureè¿›è¡Œå¤„ç†ã€‚      æ‰§è¡Œç»“æœï¼š         =====æ‰§è¡ŒthenCombine()ç­¾åæ–¹æ³•-å¼€å§‹=====         thenCombine()ç­¾åæ–¹æ³•ï¼Œæ‰§è¡Œç»“æœï¼šè®¡ç®—ç»“æœï¼š30         =====thenCombine()ç­¾åæ–¹æ³•-ç»“æŸ=====     */    private static void thenCombine() throws ExecutionException, InterruptedException &#123;        System.out.println(&quot;=====æ‰§è¡ŒthenCombine()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        CompletableFuture&lt;Integer&gt; future1 = CompletableFuture.supplyAsync(() -&gt; 10);        CompletableFuture&lt;Integer&gt; future2 = CompletableFuture.supplyAsync(() -&gt; 20);        CompletableFuture&lt;String&gt; completableFuture = future1.thenCombine(future2, (x, y) -&gt; &quot;è®¡ç®—ç»“æœï¼š&quot; + (x + y));        System.out.println(&quot;thenCombine()ç­¾åæ–¹æ³•ï¼Œæ‰§è¡Œç»“æœï¼š&quot;+ completableFuture.get());        System.out.println(&quot;=====thenCombine()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;&#125;

1.4.8. å¯¹è®¡ç®—ç»“æœçš„å¼‚å¸¸å¤„ç† &emsp;&emsp; å½“CompletableFutureçš„è®¡ç®—ç»“æœå®Œæˆï¼Œæˆ–è€…æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡handleæ–¹æ³•å¯¹ç»“æœè¿›è¡Œå¤„ç†ã€‚&emsp;&emsp; exceptionally() æ–¹æ³•å°†å¯¼è‡´CompletableFuture å†…å‘ç”Ÿé—®é¢˜çš„å¼‚å¸¸æŠ›å‡ºã€‚



æ–¹æ³•å
æè¿°



public  CompletableFuture handle(BiFunction&lt;? super T, Throwable, ? extends U&gt; fn)
å½“CompletableFutureçš„è®¡ç®—ç»“æœå®Œæˆï¼Œæˆ–è€…æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡handleæ–¹æ³•å¯¹ç»“æœè¿›è¡Œå¤„ç†ã€‚


public  CompletableFuture handleAsync(BiFunction&lt;? super T, Throwable, ? extends U&gt; fn)
å½“CompletableFutureçš„è®¡ç®—ç»“æœå®Œæˆï¼Œæˆ–è€…æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡handleæ–¹æ³•å¯¹ç»“æœè¿›è¡Œå¤„ç†ã€‚ä½¿ç”¨ForkJoinPoolã€‚


public  CompletableFuture handleAsync(BiFunction&lt;? super T, Throwable, ? extends U&gt; fn, Executor executor)
å½“CompletableFutureçš„è®¡ç®—ç»“æœå®Œæˆï¼Œæˆ–è€…æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡handleæ–¹æ³•å¯¹ç»“æœè¿›è¡Œå¤„ç†ã€‚ä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ± ã€‚


public CompletableFuture exceptionally(Function&lt;Throwable, ? extends T&gt; fn)
exceptionally() æ–¹æ³•å°†å¯¼è‡´CompletableFuture å†…å‘ç”Ÿé—®é¢˜çš„å¼‚å¸¸æŠ›å‡ºã€‚


package com.yuanxw.chapter24;import java.util.concurrent.CompletableFuture;import java.util.concurrent.ExecutionException;public class CompletableFutureExample7 &#123;    public static void main(String[] args) throws ExecutionException, InterruptedException &#123;        handle();        exceptionally();    &#125;    /**     handle() å½“CompletableFutureçš„è®¡ç®—ç»“æœå®Œæˆï¼Œæˆ–è€…æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡handleæ–¹æ³•å¯¹ç»“æœè¿›è¡Œå¤„ç†ã€‚     æ‰§è¡Œç»“æœï¼š         =====handle()ç­¾åæ–¹æ³•-å¼€å§‹=====         handle()ç­¾åæ–¹æ³•ï¼Œåœ¨supplyAsyncé˜¶æ®µï¼Œæ‰§è¡Œ1/0ç»“æœã€‚         handle()ç­¾åæ–¹æ³•ï¼Œæ‰§è¡Œç»“æœï¼š-1         =====handle()ç­¾åæ–¹æ³•-ç»“æŸ=====         java.util.concurrent.CompletionException: java.lang.ArithmeticException: / by zero         at java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:273)         at java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:280)         at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1592)         at java.util.concurrent.CompletableFuture$AsyncSupply.exec(CompletableFuture.java:1582)         at java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:289)         at java.util.concurrent.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1056)         at java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1692)         at java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:157)         Caused by: java.lang.ArithmeticException: / by zero         at com.yuanxw.chapter24.CompletableFutureExample7.lambda$handle$0(CompletableFutureExample3.java:26)         at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1590)         ... 5 more     */    private static void handle() throws ExecutionException, InterruptedException &#123;        System.out.println(&quot;=====handle()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        CompletableFuture&lt;Integer&gt; completableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;            System.out.println(&quot;handle()ç­¾åæ–¹æ³•ï¼Œåœ¨supplyAsyncé˜¶æ®µï¼Œæ‰§è¡Œ1/0ç»“æœã€‚&quot;);            return 1/0;        &#125;).handle((integer, throwable) -&gt; &#123;            if(throwable != null)&#123;                throwable.printStackTrace();                return -1;            &#125;           return integer;        &#125;);        System.out.println(&quot;handle()ç­¾åæ–¹æ³•ï¼Œæ‰§è¡Œç»“æœï¼š&quot;+ completableFuture.get());        System.out.println(&quot;=====handle()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**     * exceptionally() æ–¹æ³•å°†å¯¼è‡´CompletableFuture å†…å‘ç”Ÿé—®é¢˜çš„å¼‚å¸¸æŠ›å‡ºã€‚     * è¿™æ ·ï¼Œå½“æ‰§è¡Œä»»åŠ¡å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè°ƒç”¨get()æ–¹æ³•çš„çº¿ç¨‹å°†ä¼šæ”¶åˆ°ä¸€ä¸ª ExecutionException å¼‚å¸¸ï¼Œ     * è¯¥å¼‚å¸¸æ¥æ”¶äº†ä¸€ä¸ªåŒ…å«å¤±è´¥åŸå› çš„Exception å‚æ•°ã€‚     * æ‰§è¡Œç»“æœï¼š         =====exceptionally()ç­¾åæ–¹æ³•-å¼€å§‹=====         exceptionally()ç­¾åæ–¹æ³•ï¼Œåœ¨supplyAsyncé˜¶æ®µï¼Œæ‰§è¡Œ1/0ç»“æœã€‚         exceptionally()ç­¾åæ–¹æ³•ï¼Œæ‰§è¡Œç»“æœï¼šjava.lang.ArrayIndexOutOfBoundsException: 1         =====exceptionally()ç­¾åæ–¹æ³•-ç»“æŸ=====     * @throws ExecutionException     * @throws InterruptedException     */    private static void exceptionally() throws ExecutionException, InterruptedException &#123;        System.out.println(&quot;=====exceptionally()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        CompletableFuture&lt;String&gt; completableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;            System.out.println(&quot;exceptionally()ç­¾åæ–¹æ³•ï¼Œåœ¨supplyAsyncé˜¶æ®µï¼Œæ‰§è¡Œ1/0ç»“æœã€‚&quot;);            String [] array = new String[]&#123;&#125;;            // æ­¤å¤„å¼‚å¸¸ï¼šjava.lang.ArrayIndexOutOfBoundsException: 1            return array[1];        &#125;).exceptionally(ex -&gt; ex.getMessage());        System.out.println(&quot;exceptionally()ç­¾åæ–¹æ³•ï¼Œæ‰§è¡Œç»“æœï¼š&quot;+ completableFuture.get());        System.out.println(&quot;=====exceptionally()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;&#125;
1.4.9. å…¶å®ƒæ–¹æ³• &emsp;&emsp;allOfæ–¹æ³•æ˜¯å½“æ‰€æœ‰çš„CompletableFutureéƒ½æ‰§è¡Œå®Œåæ‰§è¡Œè®¡ç®—ã€‚anyOfæ–¹æ³•æ˜¯å½“ä»»æ„ä¸€ä¸ªCompletableFutureæ‰§è¡Œå®Œåå°±ä¼šæ‰§è¡Œè®¡ç®—ï¼Œè®¡ç®—çš„ç»“æœç›¸åŒã€‚



æ–¹æ³•å
æè¿°



public static CompletableFuture allOf(CompletableFuture&lt;?&gt;â€¦ cfs)
allOfæ–¹æ³•æ˜¯å½“æ‰€æœ‰çš„CompletableFutureéƒ½æ‰§è¡Œå®Œåæ‰§è¡Œè®¡ç®—ã€‚


public static CompletableFuture anyOf(CompletableFuture&lt;?&gt;â€¦ cfs)
anyOfæ–¹æ³•æ˜¯å½“ä»»æ„ä¸€ä¸ªCompletableFutureæ‰§è¡Œå®Œåå°±ä¼šæ‰§è¡Œè®¡ç®—ï¼Œè®¡ç®—çš„ç»“æœç›¸åŒã€‚


package com.yuanxw.chapter24;import java.util.concurrent.CompletableFuture;import java.util.concurrent.ExecutionException;import java.util.concurrent.TimeUnit;public class CompletableFutureExample8 &#123;    public static void main(String[] args) throws ExecutionException, InterruptedException &#123;        anyAndAllOfCompletableFuture();    &#125;    /**     allOfæ–¹æ³•æ˜¯å½“æ‰€æœ‰çš„CompletableFutureéƒ½æ‰§è¡Œå®Œåæ‰§è¡Œè®¡ç®—ã€‚     anyOfæ–¹æ³•æ˜¯å½“ä»»æ„ä¸€ä¸ªCompletableFutureæ‰§è¡Œå®Œåå°±ä¼šæ‰§è¡Œè®¡ç®—ï¼Œè®¡ç®—çš„ç»“æœç›¸åŒã€‚     æ‰§è¡Œç»“æœï¼š         =====anyAndAllOfCompletableFuture()ç­¾åæ–¹æ³•-å¼€å§‹=====         ForkJoinPool.commonPool-worker-1çº¿ç¨‹ï¼Œå·¥ä½œ-å¼€å§‹&gt;&gt;         ForkJoinPool.commonPool-worker-2çº¿ç¨‹ï¼Œå·¥ä½œ-å¼€å§‹&gt;&gt;         ForkJoinPool.commonPool-worker-2çº¿ç¨‹ï¼Œå·¥ä½œ-ç»“æŸ&lt;&lt;         anyOf()ç­¾åæ–¹æ³•ï¼Œæ‰§è¡Œç»“æœï¼šresult-2         ForkJoinPool.commonPool-worker-1çº¿ç¨‹ï¼Œå·¥ä½œ-ç»“æŸ&lt;&lt;         =====anyAndAllOfCompletableFuture()ç­¾åæ–¹æ³•-ç»“æŸ=====     */    private static void anyAndAllOfCompletableFuture() throws ExecutionException, InterruptedException &#123;        System.out.println(&quot;=====anyAndAllOfCompletableFuture()ç­¾åæ–¹æ³•-å¼€å§‹=====&quot;);        CompletableFuture&lt;String&gt; completableFuture1=CompletableFuture.supplyAsync(()-&gt;&#123;            //æ¨¡æ‹Ÿæ‰§è¡Œè€—æ—¶ä»»åŠ¡            System.out.println(Thread.currentThread().getName() + &quot;çº¿ç¨‹ï¼Œå·¥ä½œ-å¼€å§‹&gt;&gt;&quot;);            // ç¡çœ 5ç§’            processSleep(5);            System.out.println(Thread.currentThread().getName() + &quot;çº¿ç¨‹ï¼Œå·¥ä½œ-ç»“æŸ&lt;&lt;&quot;);            //è¿”å›ç»“æœ            return &quot;result-1&quot;;        &#125;);        CompletableFuture&lt;String&gt; completableFuture2=CompletableFuture.supplyAsync(()-&gt;&#123;            //æ¨¡æ‹Ÿæ‰§è¡Œè€—æ—¶ä»»åŠ¡            System.out.println(Thread.currentThread().getName() + &quot;çº¿ç¨‹ï¼Œå·¥ä½œ-å¼€å§‹&gt;&gt;&quot;);            // ç¡çœ 5ç§’            processSleep(1);            System.out.println(Thread.currentThread().getName() + &quot;çº¿ç¨‹ï¼Œå·¥ä½œ-ç»“æŸ&lt;&lt;&quot;);            //è¿”å›ç»“æœ            return &quot;result-2&quot;;        &#125;);        CompletableFuture&lt;Object&gt; anyOfCompletableFuture = CompletableFuture.anyOf(completableFuture1,completableFuture2);        System.out.println(&quot;anyOf()ç­¾åæ–¹æ³•ï¼Œæ‰§è¡Œç»“æœï¼š&quot;+ anyOfCompletableFuture.get());        CompletableFuture&lt;Void&gt; allOfCompletableFuture = CompletableFuture.allOf(completableFuture1,completableFuture2);        // é˜»å¡ç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆ        allOfCompletableFuture.join();        System.out.println(&quot;=====anyAndAllOfCompletableFuture()ç­¾åæ–¹æ³•-ç»“æŸ=====&quot;);    &#125;    /**     * çº¿ç¨‹ä¼‘çœ çš„æ–¹æ³•     * @param seconds     */    private static void processSleep(long seconds) &#123;        try &#123;            TimeUnit.SECONDS.sleep(seconds);        &#125; catch (InterruptedException e) &#123;            e.printStackTrace();        &#125;    &#125;&#125;

 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(äºŒåå››)Javaå¤šçº¿ç¨‹ä¹‹CompletableFutureç±»ã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(äº”)Javaå¤šçº¿ç¨‹ä¹‹interruptedçº¿ç¨‹ä¸­æ–­</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E4%BA%94)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8Binterrupted%E7%BA%BF%E7%A8%8B%E4%B8%AD%E6%96%AD/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(äº”)Javaå¤šçº¿ç¨‹ä¹‹interruptedçº¿ç¨‹ä¸­æ–­1.1 interrupted(çº¿ç¨‹ä¸­æ–­)&emsp;&emsp;ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•ä¹‹åä¼šè‡ªåŠ¨ç»“æŸï¼Œå¦‚æœåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ä¹Ÿä¼šæå‰ç»“æŸã€‚é€šè¿‡è°ƒç”¨ä¸€ä¸ªçº¿ç¨‹çš„ interrupt() æ¥ä¸­æ–­è¯¥çº¿ç¨‹ï¼Œå¦‚æœè¯¥çº¿ç¨‹å¤„äºé˜»å¡ã€é™æœŸç­‰å¾…æˆ–è€…æ— é™æœŸç­‰å¾…çŠ¶æ€ï¼Œé‚£ä¹ˆå°±ä¼šæŠ›å‡º InterruptedExceptionï¼Œä»è€Œæå‰ç»“æŸè¯¥çº¿ç¨‹ã€‚ä½†æ˜¯ä¸èƒ½ä¸­æ–­ I&#x2F;O é˜»å¡å’Œ synchronized é”é˜»å¡ã€‚å¯¹äºä»¥ä¸‹ä»£ç ï¼Œåœ¨ main() ä¸­å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ä¹‹åå†ä¸­æ–­å®ƒï¼Œç”±äºçº¿ç¨‹ä¸­è°ƒç”¨äº† Thread.sleep() æ–¹æ³•ï¼Œå› æ­¤ä¼šæŠ›å‡ºä¸€ä¸ª InterruptedExceptionï¼Œä»è€Œæå‰ç»“æŸçº¿ç¨‹ï¼Œä¸æ‰§è¡Œä¹‹åçš„è¯­å¥ã€‚
package com.yuanxw.chapter5;/** * ä¸­æ–­çº¿ç¨‹ */public class InterruptThread &#123;    public static void main(String[] args) throws InterruptedException &#123;        Thread thread = new Thread() &#123;            @Override            public void run() &#123;                try &#123;                    while (true) &#123;                        sleep(500);                        System.out.println(Thread.currentThread().getName() + &quot;æ­£åœ¨è¿è¡Œ...&quot;);                    &#125;                &#125; catch (InterruptedException e) &#123;                    e.printStackTrace();                    System.out.println(Thread.currentThread().getName() + &quot;çº¿ç¨‹è¢«æ‰“æ–­äº†...&quot;);                &#125;            &#125;        &#125;;        thread.start();        /** mainçº¿ç¨‹ä¼‘æ¯2ç§’ **/        Thread.sleep(2000);        System.out.println(String.format(&quot;ã€%sã€‘çº¿ç¨‹æ˜¯å¦ä¸­æ–­ï¼š%s&quot;, thread.getName(),thread.isInterrupted()));        /** ä¸­æ–­çº¿ç¨‹æ“ä½œ **/        thread.interrupt();        System.out.println(String.format(&quot;ã€%sã€‘çº¿ç¨‹æ˜¯å¦ä¸­æ–­ï¼š%s&quot;, thread.getName(),thread.isInterrupted()));    &#125;&#125;
æ‰§è¡Œç»“æœï¼š
Thread-0æ­£åœ¨è¿è¡Œ...Thread-0æ­£åœ¨è¿è¡Œ...Thread-0æ­£åœ¨è¿è¡Œ...Thread-0æ­£åœ¨è¿è¡Œ...ã€Thread-0ã€‘çº¿ç¨‹æ˜¯å¦ä¸­æ–­ï¼šfalseã€Thread-0ã€‘çº¿ç¨‹æ˜¯å¦ä¸­æ–­ï¼štrueThread-0çº¿ç¨‹è¢«æ‰“æ–­äº†...java.lang.InterruptedException: sleep interrupted	at java.lang.Thread.sleep(Native Method)	at com.yuanxw.chapter3.InterruptThread$1.run(InterruptThread.java:13) 

 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(äº”)Javaå¤šçº¿ç¨‹ä¹‹interruptedçº¿ç¨‹ä¸­æ–­ã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(å…«)Javaå¤šçº¿ç¨‹ä¹‹æ­»é”</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E5%85%AB)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8B%E6%AD%BB%E9%94%81/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(å…«)Javaå¤šçº¿ç¨‹ä¹‹æ­»é”1.1ä»€ä¹ˆæ˜¯çº¿ç¨‹æ­»é”?å¦‚ä½•é¿å…æ­»é”?&emsp;&emsp;å¤šä¸ªçº¿ç¨‹åŒæ—¶è¢«é˜»å¡ï¼Œå®ƒä»¬ä¸­çš„ä¸€ä¸ªæˆ–è€…å…¨éƒ¨éƒ½åœ¨ç­‰å¾…æŸä¸ªèµ„æºè¢«é‡Šæ”¾ã€‚ç”±äºçº¿ç¨‹è¢«æ— é™æœŸåœ°é˜»å¡ï¼Œå› æ­¤ç¨‹åºä¸å¯èƒ½æ­£å¸¸ç»ˆæ­¢ã€‚
å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçº¿ç¨‹ A æŒæœ‰èµ„æº 2ï¼Œçº¿ç¨‹ B æŒæœ‰èµ„æº 1ï¼Œä»–ä»¬åŒæ—¶éƒ½æƒ³ç”³è¯·å¯¹æ–¹çš„èµ„æºï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªçº¿ç¨‹å°±ä¼šäº’ç›¸ç­‰å¾…è€Œè¿›å…¥æ­»é”çŠ¶æ€ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](&#x2F;images&#x2F;java_multithreading&#x2F;chapter8&#x2F;20191230105715913.png
ä¸‹é¢é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜çº¿ç¨‹æ­»é”,ä»£ç æ¨¡æ‹Ÿäº†ä¸Šå›¾çš„æ­»é”çš„æƒ…å†µ (ä»£ç æ¥æºäºã€Šå¹¶å‘ç¼–ç¨‹ä¹‹ç¾ã€‹)ï¼š
package com.yuanxw.chapter8;/** * æ­»é” */public class DeadLockDemo &#123;    private static Object resource1 = new Object();//èµ„æº 1    private static Object resource2 = new Object();//èµ„æº 2    public static void main(String[] args) &#123;        new Thread(() -&gt; &#123;            synchronized (resource1) &#123;                System.out.println(Thread.currentThread() + &quot;get resource1&quot;);                try &#123;                    Thread.sleep(1000);                &#125; catch (InterruptedException e) &#123;                    e.printStackTrace();                &#125;                System.out.println(Thread.currentThread() + &quot;waiting get resource2&quot;);                synchronized (resource2) &#123;                    System.out.println(Thread.currentThread() + &quot;get resource2&quot;);                &#125;            &#125;        &#125;, &quot;çº¿ç¨‹A&quot;).start();        new Thread(() -&gt; &#123;            synchronized (resource2) &#123;                System.out.println(Thread.currentThread() + &quot;get resource2&quot;);                try &#123;                    Thread.sleep(1000);                &#125; catch (InterruptedException e) &#123;                    e.printStackTrace();                &#125;                System.out.println(Thread.currentThread() + &quot;waiting get resource1&quot;);                synchronized (resource1) &#123;                    System.out.println(Thread.currentThread() + &quot;get resource1&quot;);                &#125;            &#125;        &#125;, &quot;çº¿ç¨‹B&quot;).start();    &#125;&#125;
æ‰§è¡Œç»“æœ
Thread[çº¿ç¨‹A,5,main]get resource1Thread[çº¿ç¨‹B,5,main]get resource2Thread[çº¿ç¨‹B,5,main]waiting get resource1Thread[çº¿ç¨‹A,5,main]waiting get resource2

çº¿ç¨‹ A é€šè¿‡ synchronized (resource1) è·å¾— resource1 çš„ç›‘è§†å™¨é”ï¼Œç„¶åé€šè¿‡Thread.sleep(1000);è®©çº¿ç¨‹ A ä¼‘çœ  1s ä¸ºçš„æ˜¯è®©çº¿ç¨‹ B å¾—åˆ°æ‰§è¡Œç„¶åè·å–åˆ° resource2 çš„ç›‘è§†å™¨é”ã€‚çº¿ç¨‹ A å’Œçº¿ç¨‹ B ä¼‘çœ ç»“æŸäº†éƒ½å¼€å§‹ä¼å›¾è¯·æ±‚è·å–å¯¹æ–¹çš„èµ„æºï¼Œç„¶åè¿™ä¸¤ä¸ªçº¿ç¨‹å°±ä¼šé™·å…¥äº’ç›¸ç­‰å¾…çš„çŠ¶æ€ï¼Œè¿™ä¹Ÿå°±äº§ç”Ÿäº†æ­»é”ã€‚ä¸Šé¢çš„ä¾‹å­ç¬¦åˆäº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ã€‚
å­¦è¿‡æ“ä½œç³»ç»Ÿçš„æœ‹å‹éƒ½çŸ¥é“äº§ç”Ÿæ­»é”å¿…é¡»å…·å¤‡ä»¥ä¸‹å››ä¸ªæ¡ä»¶ï¼š

äº’æ–¥æ¡ä»¶ï¼šè¯¥èµ„æºä»»æ„ä¸€ä¸ªæ—¶åˆ»åªç”±ä¸€ä¸ªçº¿ç¨‹å ç”¨ã€‚
è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼šä¸€ä¸ªè¿›ç¨‹å› è¯·æ±‚èµ„æºè€Œé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚
ä¸å‰¥å¤ºæ¡ä»¶:çº¿ç¨‹å·²è·å¾—çš„èµ„æºåœ¨æœ«ä½¿ç”¨å®Œä¹‹å‰ä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹å¼ºè¡Œå‰¥å¤ºï¼Œåªæœ‰è‡ªå·±ä½¿ç”¨å®Œæ¯•åæ‰é‡Šæ”¾èµ„æºã€‚
å¾ªç¯ç­‰å¾…æ¡ä»¶:è‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»ã€‚

1.2é€šè¿‡å‘½ä»¤æ£€æŸ¥æ­»é”
 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(å…«)Javaå¤šçº¿ç¨‹ä¹‹æ­»é”ã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(å…­)Javaå¤šçº¿ç¨‹ä¹‹ThreadGroup</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E5%85%AD)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BThreadGroup/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(å…­)Javaå¤šçº¿ç¨‹ä¹‹ThreadGroup1.1 ThreadGroup&emsp;&emsp;ThreadGroupæ˜¯Javaæä¾›çš„ä¸€ç§å¯¹çº¿ç¨‹è¿›è¡Œåˆ†ç»„ç®¡ç†çš„æ‰‹æ®µï¼Œå¯ä»¥å¯¹æ‰€æœ‰çº¿ç¨‹ä»¥ç»„ä¸ºå•ä½è¿›è¡Œæ“ä½œï¼Œå¦‚è®¾ç½®ä¼˜å…ˆçº§ã€å®ˆæŠ¤çº¿ç¨‹ç­‰ã€‚
&emsp;&emsp;åœ¨Javaç¨‹åºä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ–°çš„çº¿ç¨‹éƒ½ä¼šåŠ å…¥åˆ° main çº¿ç¨‹æ‰€åœ¨çš„ group ä¸­ï¼Œ main çº¿ç¨‹çš„ group å’Œçº¿ç¨‹åŒåã€‚å’Œçº¿ç¨‹å­˜åœ¨çˆ¶å­å…³ç³»ä¸€æ ·ï¼Œ ThreadGroup ä¹Ÿå­˜åœ¨çˆ¶å­å…³ç³»

package com.yuanxw.chapter6;import java.util.Arrays;public class ThreadGroupService &#123;    public static void main(String[] args) &#123;        Thread thread = new Thread(&quot;thread-0&quot;)&#123;            @Override            public void run() &#123;                try &#123;                    // ç¡çœ 100L                    sleep(100L);                &#125; catch (InterruptedException e) &#123;                    e.printStackTrace();                &#125;            &#125;        &#125;;        thread.start();        // è·å¾—å½“å‰çº¿ç¨‹çš„åç§°        System.out.println(&quot;è·å¾—å½“å‰çº¿ç¨‹çš„åç§°ï¼š&quot;+Thread.currentThread().getName());        // è·å¾—å½“å‰çº¿ç¨‹çš„çº¿ç¨‹çº¿åç§°        System.out.println(&quot;è·å¾—å½“å‰çº¿ç¨‹çš„çº¿ç¨‹çº¿åç§°ï¼š&quot;+Thread.currentThread().getThreadGroup().getName());        // è·å¾—thread-0çº¿ç¨‹çš„çº¿ç¨‹çº¿åç§°        System.out.println(&quot;è·å¾—&quot;+thread.getName()+&quot;çº¿ç¨‹çš„çº¿ç¨‹çº¿åç§°ï¼š&quot;+thread.getThreadGroup().getName());        // å‰µå»ºçº¿ç¨‹ç»„        ThreadGroup syncDbGroup = new ThreadGroup(&quot;SYNC_DB_GROUP&quot;);        Arrays.asList(&quot;thread-A&quot;,&quot;thread-B&quot;,&quot;thread-C&quot;,&quot;thread-D&quot;).forEach(name -&gt;&#123;            Thread t = new Thread(syncDbGroup, () -&gt; &#123;                while (true) &#123;&#125;            &#125;, name);            t.setDaemon(true);            t.start();        &#125;);        ThreadGroup syncErpDbGroup = new ThreadGroup(syncDbGroup,&quot;SYNC_ERP_DB_GROUP&quot;);        ThreadGroup syncOADbGroup = new ThreadGroup(syncDbGroup,&quot;SYNC_OA_DB_GROUP&quot;);        Arrays.asList(&quot;thread-1&quot;,&quot;thread-2&quot;).forEach(name -&gt;&#123;            Thread t = new Thread(syncErpDbGroup, () -&gt; &#123;                while (true) &#123;&#125;            &#125;, name);            t.setDaemon(true);            t.start();        &#125;);        System.out.println(&quot;è¿”å›æ­¤çº¿ç¨‹ç»„åŠå…¶å­ç»„ä¸­æ´»åŠ¨çº¿ç¨‹æ•°çš„ä¼°è®¡ï¼š&quot;+syncDbGroup.activeCount());        System.out.println(&quot;è¿”å›æ­¤çº¿ç¨‹ç»„åŠå…¶å­ç»„ä¸­æ´»åŠ¨ç»„æ•°çš„ä¼°è®¡ï¼š&quot;+syncDbGroup.activeGroupCount());        // è®¾ç½®çº¿ç¨‹ç»„ä¸ºåå°çº¿ç¨‹ç»„----æœ€åä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç»“æŸæˆ–è€…è¢«é”€æ¯å,è¯¥åå°çº¿ç¨‹ç»„è‡ªåŠ¨é”€æ¯        syncDbGroup.setDaemon(true);        // interrupt çš„ä½œç”¨å…¶å®ä¹Ÿä¸æ˜¯ä¸­æ–­çº¿ç¨‹ï¼Œè€Œæ˜¯ã€Œé€šçŸ¥çº¿ç¨‹åº”è¯¥ä¸­æ–­äº†ã€ï¼Œå…·ä½“åˆ°åº•ä¸­æ–­è¿˜æ˜¯ç»§ç»­è¿è¡Œï¼Œåº”è¯¥ç”±è¢«é€šçŸ¥çš„çº¿ç¨‹è‡ªå·±å¤„ç†ã€‚        syncErpDbGroup.interrupt();    &#125;&#125;
æ‰§è¡Œç»“æœï¼š
è·å¾—å½“å‰çº¿ç¨‹çš„åç§°ï¼šmainè·å¾—å½“å‰çº¿ç¨‹çš„çº¿ç¨‹çº¿åç§°ï¼šmainè·å¾—thread-0çº¿ç¨‹çš„çº¿ç¨‹çº¿åç§°ï¼šmainè¿”å›æ­¤çº¿ç¨‹ç»„åŠå…¶å­ç»„ä¸­æ´»åŠ¨çº¿ç¨‹æ•°çš„ä¼°è®¡ï¼š6è¿”å›æ­¤çº¿ç¨‹ç»„åŠå…¶å­ç»„ä¸­æ´»åŠ¨ç»„æ•°çš„ä¼°è®¡ï¼š2


 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(å…­)Javaå¤šçº¿ç¨‹ä¹‹ThreadGroupã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(å)Javaå¤šçº¿ç¨‹ä¹‹ThreadLocal</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E5%8D%81)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BThreadLocal/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(å)Javaå¤šçº¿ç¨‹ä¹‹ThreadLocal1.1 ThreadLocalç±»&emsp;&emsp;  ThreadLocalç±»ä¸»è¦è§£å†³çš„å°±æ˜¯è®©æ¯ä¸ªçº¿ç¨‹ç»‘å®šè‡ªå·±çš„å€¼ï¼Œå¯ä»¥å°†ThreadLocalç±»å½¢è±¡çš„æ¯”å–»æˆå­˜æ”¾æ•°æ®çš„ç›’å­ï¼Œç›’å­ä¸­å¯ä»¥å­˜å‚¨æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰æ•°æ®ã€‚å¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ªThreadLocalå˜é‡ï¼Œé‚£ä¹ˆè®¿é—®è¿™ä¸ªå˜é‡çš„æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰è¿™ä¸ªå˜é‡çš„æœ¬åœ°å‰¯æœ¬ï¼Œè¿™ä¹Ÿæ˜¯ThreadLocalå˜é‡åçš„ç”±æ¥ã€‚ä»–ä»¬å¯ä»¥ä½¿ç”¨ get()å’Œ set())æ–¹æ³•æ¥è·å–é»˜è®¤å€¼æˆ–å°†å…¶å€¼æ›´æ”¹ä¸ºå½“å‰çº¿ç¨‹æ‰€å­˜çš„å‰¯æœ¬çš„å€¼ï¼Œä»è€Œé¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚
æ¯ä¸ªçº¿ç¨‹å¾€ThreadLocalä¸­è¯»å†™æ•°æ®æ˜¯çº¿ç¨‹éš”ç¦»ï¼Œäº’ç›¸ä¹‹é—´ä¸ä¼šå½±å“çš„ï¼Œç”±äºä¸éœ€è¦å…±äº«ä¿¡æ¯ï¼Œè‡ªç„¶å°±ä¸å­˜åœ¨ç«äº‰é—®é¢˜äº†ï¼Œä»è€Œä¿è¯äº†æŸäº›æƒ…å†µä¸‹çº¿ç¨‹çš„å®‰å…¨ï¼Œä»¥åŠé¿å…äº†æŸäº›æƒ…å†µéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨å¿…é¡»åŒæ­¥å¸¦æ¥çš„æ€§èƒ½æŸå¤±ï¼
1.2 ThreadLocalç¤ºä¾‹package com.yuanxw.chapter10;import java.util.Random;/** * ThreadLocal * çº¿ç¨‹å±€éƒ¨å˜é‡ */public class ThreadLocalExample &#123;    private static ThreadLocal&lt;String&gt; defaultThreadLocal = new ThreadLocal()&#123;        @Override        protected Object initialValue() &#123;            return &quot;==initialValue==&quot;;        &#125;    &#125;;    private static ThreadLocal&lt;String&gt; threadLocal = new ThreadLocal();    public static void main(String[] args) throws InterruptedException &#123;        System.out.println(&quot;è·å¾—defaultThreadLocalé»˜è®¤å€¼ï¼š&quot;+defaultThreadLocal.get());        // çº¿ç¨‹-A        Thread thread1 = new Thread(() -&gt; &#123;            // è®¾ç½®ã€threadLocalã€‘å¯¹è±¡å€¼ä¸ºï¼šå¼ ä¸‰            threadLocal.set(&quot;å¼ ä¸‰&quot;);            try &#123;                Thread.sleep(new Random().nextInt(1000));            &#125; catch (InterruptedException e) &#123;                e.printStackTrace();            &#125;            System.out.println(String.format(&quot;ã€%sã€‘çº¿ç¨‹-æ‰§è¡ŒthreadLocalå€¼ï¼šã€%sã€‘&quot;, Thread.currentThread().getName(),threadLocal.get()));        &#125;, &quot;Thread-A&quot;);        // çº¿ç¨‹-B        Thread thread2 = new Thread(() -&gt; &#123;            // è®¾ç½®ã€threadLocalã€‘å¯¹è±¡å€¼ä¸ºï¼šæå››            threadLocal.set(&quot;æå››&quot;);            try &#123;                Thread.sleep(new Random().nextInt(1000));            &#125; catch (InterruptedException e) &#123;                e.printStackTrace();            &#125;            System.out.println(String.format(&quot;ã€%sã€‘çº¿ç¨‹-æ‰§è¡ŒthreadLocalå€¼ï¼šã€%sã€‘&quot;, Thread.currentThread().getName(),threadLocal.get()));        &#125;, &quot;Thread-B&quot;);        thread1.join();        thread2.join();        thread1.start();        thread2.start();        Thread.sleep(new Random().nextInt(1000));        System.out.println(String.format(&quot;ã€%sã€‘çº¿ç¨‹-æ‰§è¡ŒthreadLocalå€¼ï¼šã€%sã€‘&quot;, Thread.currentThread().getName(),threadLocal.get()));    &#125;&#125;
æ‰§è¡Œç»“æœï¼š
è·å¾—defaultThreadLocalé»˜è®¤å€¼ï¼š==initialValue==ã€Thread-Bã€‘çº¿ç¨‹-æ‰§è¡ŒthreadLocalå€¼ï¼šã€æå››ã€‘ã€Thread-Aã€‘çº¿ç¨‹-æ‰§è¡ŒthreadLocalå€¼ï¼šã€å¼ ä¸‰ã€‘ã€mainã€‘çº¿ç¨‹-æ‰§è¡ŒthreadLocalå€¼ï¼šã€nullã€‘
1.3 ThreadLocalå¯¹åº”çš„åº•å±‚ç»“æ„å›¾
æ¯ä¸ª Thread éƒ½æœ‰ä¸€ä¸ª ThreadLocal.ThreadLocalMap å¯¹è±¡ã€‚å½“è°ƒç”¨ä¸€ä¸ª ThreadLocal çš„ set(T value) æ–¹æ³•æ—¶ï¼Œå…ˆå¾—åˆ°å½“å‰çº¿ç¨‹çš„ ThreadLocalMap å¯¹è±¡ï¼Œç„¶åå°† ThreadLocal-&gt;value é”®å€¼å¯¹æ’å…¥åˆ°è¯¥ Map ä¸­ï¼Œget() æ–¹æ³•ç±»ä¼¼ã€‚
/* ThreadLocal values pertaining to this thread. This map is maintained * by the ThreadLocal class. */ThreadLocal.ThreadLocalMap threadLocals = null;/** * Returns the value in the current thread&#x27;s copy of this * thread-local variable.  If the variable has no value for the * current thread, it is first initialized to the value returned * by an invocation of the &#123;@link #initialValue&#125; method. * * @return the current thread&#x27;s value of this thread-local */public T get() &#123;    Thread t = Thread.currentThread();    ThreadLocalMap map = getMap(t);    if (map != null) &#123;        ThreadLocalMap.Entry e = map.getEntry(this);        if (e != null) &#123;            @SuppressWarnings(&quot;unchecked&quot;)            T result = (T)e.value;            return result;        &#125;    &#125;    return setInitialValue();&#125;/** * Sets the current thread&#x27;s copy of this thread-local variable * to the specified value.  Most subclasses will have no need to * override this method, relying solely on the &#123;@link #initialValue&#125; * method to set the values of thread-locals. * * @param value the value to be stored in the current thread&#x27;s copy of *        this thread-local. */public void set(T value) &#123;    Thread t = Thread.currentThread();    ThreadLocalMap map = getMap(t);    if (map != null)        map.set(this, value);    else        createMap(t, value);&#125;

1.3 ThreadLocal å†…å­˜æ³„éœ²é—®é¢˜åœ¨ä¸€äº›åœºæ™¯ (å°¤å…¶æ˜¯ä½¿ç”¨çº¿ç¨‹æ± ) ä¸‹ï¼ŒThreadLocal æ²¡æœ‰è¢«å¤–éƒ¨å¼ºå¼•ç”¨çš„æƒ…å†µä¸‹ï¼Œåœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™ï¼Œkey ä¼šè¢«æ¸…ç†æ‰ï¼Œè€Œ value ä¸ä¼šè¢«æ¸…ç†æ‰ã€‚è¿™æ ·ä¸€æ¥ï¼ŒThreadLocalMap ä¸­å°±ä¼šå‡ºç°keyä¸ºnullçš„Entryã€‚å‡å¦‚æˆ‘ä»¬ä¸åšä»»ä½•æªæ–½çš„è¯ï¼Œvalue æ°¸è¿œæ— æ³•è¢«GC å›æ”¶ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯èƒ½ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ã€‚ThreadLocalMapå®ç°ä¸­å·²ç»è€ƒè™‘äº†è¿™ç§æƒ…å†µï¼Œåœ¨è°ƒç”¨ set()ã€get()ã€remove() æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ¸…ç†æ‰ key ä¸º null çš„è®°å½•ã€‚ä½¿ç”¨å®Œ ThreadLocalæ–¹æ³•å æœ€å¥½æ‰‹åŠ¨è°ƒç”¨remove()æ–¹æ³•ã€‚
 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(å)Javaå¤šçº¿ç¨‹ä¹‹ThreadLocalã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(åä¸€)Javaå¤šçº¿ç¨‹ä¹‹è‡ªå®šä¹‰çº¿ç¨‹æ± </title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E5%8D%81%E4%B8%80)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BA%BF%E7%A8%8B%E6%B1%A0/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(åä¸€)Javaå¤šçº¿ç¨‹ä¹‹è‡ªå®šä¹‰çº¿ç¨‹æ± 1.1 ä»€ä¹ˆæ˜¯ç”¨çº¿ç¨‹æ± &emsp;&emsp; çº¿ç¨‹æ± æ˜¯ä¸€ç§å¤šçº¿ç¨‹å¤„ç†å½¢å¼ï¼Œå¤„ç†è¿‡ç¨‹ä¸­å°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ï¼Œç„¶ååœ¨åˆ›å»ºçº¿ç¨‹åè‡ªåŠ¨å¯åŠ¨è¿™äº›ä»»åŠ¡ã€‚çº¿ç¨‹æ± çº¿ç¨‹éƒ½æ˜¯åå°çº¿ç¨‹ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½ä½¿ç”¨é»˜è®¤çš„å †æ ˆå¤§å°ï¼Œä»¥é»˜è®¤çš„ä¼˜å…ˆçº§è¿è¡Œï¼Œå¹¶å¤„äºå¤šçº¿ç¨‹å•å…ƒä¸­ã€‚å¦‚æœæŸä¸ªçº¿ç¨‹åœ¨æ‰˜ç®¡ä»£ç ä¸­ç©ºé—²ï¼ˆå¦‚æ­£åœ¨ç­‰å¾…æŸä¸ªäº‹ä»¶ï¼‰,åˆ™çº¿ç¨‹æ± å°†æ’å…¥å¦ä¸€ä¸ªè¾…åŠ©çº¿ç¨‹æ¥ä½¿æ‰€æœ‰å¤„ç†å™¨ä¿æŒç¹å¿™ã€‚å¦‚æœæ‰€æœ‰çº¿ç¨‹æ± çº¿ç¨‹éƒ½å§‹ç»ˆä¿æŒç¹å¿™ï¼Œä½†é˜Ÿåˆ—ä¸­åŒ…å«æŒ‚èµ·çš„å·¥ä½œï¼Œåˆ™çº¿ç¨‹æ± å°†åœ¨ä¸€æ®µæ—¶é—´ååˆ›å»ºå¦ä¸€ä¸ªè¾…åŠ©çº¿ç¨‹ä½†çº¿ç¨‹çš„æ•°ç›®æ°¸è¿œä¸ä¼šè¶…è¿‡æœ€å¤§å€¼ã€‚è¶…è¿‡æœ€å¤§å€¼çš„çº¿ç¨‹å¯ä»¥æ’é˜Ÿï¼Œä½†ä»–ä»¬è¦ç­‰åˆ°å…¶ä»–çº¿ç¨‹å®Œæˆåæ‰å¯åŠ¨ã€‚
1.2 ä¸ºä»€ä¹ˆè¦ç”¨çº¿ç¨‹æ± &emsp;&emsp;æ± åŒ–æŠ€æœ¯ç›¸æ¯”å¤§å®¶å·²ç»å±¡è§ä¸é²œäº†ï¼Œçº¿ç¨‹æ± ã€æ•°æ®åº“è¿æ¥æ± ã€Http è¿æ¥æ± ç­‰ç­‰éƒ½æ˜¯å¯¹è¿™ä¸ªæ€æƒ³çš„åº”ç”¨ã€‚æ± åŒ–æŠ€æœ¯çš„æ€æƒ³ä¸»è¦æ˜¯ä¸ºäº†å‡å°‘æ¯æ¬¡è·å–èµ„æºçš„æ¶ˆè€—ï¼Œæé«˜å¯¹èµ„æºçš„åˆ©ç”¨ç‡ã€‚çº¿ç¨‹æ± æä¾›äº†ä¸€ç§é™åˆ¶å’Œç®¡ç†èµ„æºï¼ˆåŒ…æ‹¬æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼‰ã€‚ æ¯ä¸ªçº¿ç¨‹æ± è¿˜ç»´æŠ¤ä¸€äº›åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾‹å¦‚å·²å®Œæˆä»»åŠ¡çš„æ•°é‡ã€‚
è¿™é‡Œå€Ÿç”¨ã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹æåˆ°çš„æ¥è¯´ä¸€ä¸‹ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„ï¼š

é™ä½èµ„æºæ¶ˆè€—ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—ã€‚
æé«˜å“åº”é€Ÿåº¦ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦çš„ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚
æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚

1.3 å¦‚ä½•è‡ªå®šä¹‰çº¿ç¨‹æ± &emsp;&emsp;è‡ªå®šä¹‰ç®€å•çš„çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ± å¤§å°ï¼Œä»»åŠ¡é˜Ÿåˆ—å¤§å°ï¼Œæ‹’ç»ç­–ç•¥ç­‰ï¼Œä¸‹é¢çš„ä»£ç ç®€å•å®ç°çº¿ç¨‹æ± ã€‚

å®šä¹‰ä»»åŠ¡çŠ¶æ€

package com.yuanxw.chapter11;/** * ä»»åŠ¡çŠ¶æ€ */public enum TaskState &#123;        /**         * ç©ºé—²         **/        FREE,        /**         * è¿è¡Œä¸­         **/        RUNNING,        /**         * é˜»å¡         **/        BLOCKED,        /**         * æ­»äº¡         **/        DEAD;&#125;


è‡ªå®šä¹‰å¼‚å¸¸

package com.yuanxw.chapter11;/** * è‡ªå®šä¹‰å¼‚å¸¸ */public class DiscardException extends RuntimeException&#123;    public DiscardException(String message) &#123;        super(message);    &#125;&#125;


å®šä¹‰æ‹’ç»ç­–ç•¥æ¥å£

package com.yuanxw.chapter11;/** * æ‹’ç»ç­–ç•¥ */public interface DiscardPolicy &#123;    /** å®šä¹‰æ‹’ç»ç­–ç•¥ **/    void discard() throws DiscardException;&#125;


å®šä¹‰æ‹’ç»ç­–ç•¥æ¥å£å®ç°

package com.yuanxw.chapter11;/** * é»˜è®¤ï¼šæ‹’ç»ç­–ç•¥ */public class DefaultDiscardPolicyImpl implements DiscardPolicy&#123;    @Override    public void discard() throws DiscardException &#123;        throw new DiscardException(&quot;è¯¥ä»»åŠ¡å·²ç»è¢«æ‹’ç»ï¼&quot;);    &#125;&#125;


çº¿ç¨‹æ± å®ç°æ–¹æ³•

package com.yuanxw.chapter11;import java.util.ArrayList;import java.util.LinkedList;import java.util.List;/** * è‡ªå®šä¹‰ç®€å•çš„çº¿ç¨‹æ±  */public class SimpleThreadPool &#123;    /**     * çº¿ç¨‹æ± å¤§å°     **/    private final int size;    /**     * ä»»åŠ¡é˜Ÿåˆ—å¤§å°     **/    private final int taskQueueSize;    /**     * é»˜è®¤çº¿ç¨‹æ± å¤§å°ä¸ºï¼š5     **/    private final static int DEFAULT_SIZE = 5;    /**     * é»˜è®¤ä»»åŠ¡é˜Ÿåˆ—å¤§å°ï¼š2000     **/    private final static int DEFAULT_TASK_QUEUE_SIZE = 2000;    /**     * çº¿ç¨‹åºå·     */    private static volatile int seq = 0;    /**     * çº¿ç¨‹å‰ç¼€     **/    private final static String THREAD_PREFIX = &quot;SIMPLE-THREAD-POOL-&quot;;    /**     * å®šä¹‰çº¿ç¨‹ç¨‹     **/    private final static ThreadGroup GROUP = new ThreadGroup(&quot;POOL_GROUP&quot;);    /**     * å®šçº¿ç¨‹é˜Ÿåˆ—     **/    private final static List&lt;WorkerTask&gt; THREAD_QUEUE = new ArrayList&lt;&gt;();    /**     * ä»»åŠ¡é˜Ÿåˆ—     */    private static LinkedList&lt;Runnable&gt; TASK_QUEUE = new LinkedList&lt;&gt;();    /**     * é»˜è®¤ç­–ç•¥     **/    public static final DiscardPolicy DEFAULT_DISCARD_POLICY = new DefaultDiscardPolicyImpl();    /** å®šä¹‰ç­–ç•¥å˜é‡ **/    private final DiscardPolicy discardPolicy;    /** æ˜¯å¦å·²ç»é”€æ¯ **/    private volatile boolean destroy = false;    public SimpleThreadPool() &#123;        this(DEFAULT_SIZE, DEFAULT_TASK_QUEUE_SIZE, DEFAULT_DISCARD_POLICY);    &#125;    public SimpleThreadPool(int size, int taskQueueSize, DiscardPolicy discardPolicy) &#123;        this.size = size;        this.taskQueueSize = taskQueueSize;        this.discardPolicy = discardPolicy;        init();    &#125;    /**     * åˆå§‹åŒ–æ–¹æ³•     */    private void init() &#123;        // åˆ›å»ºsizeçº¿ç¨‹        for (int i = 0; i &lt; size; i++) &#123;            createWorkTask();        &#125;    &#125;    /**     * åˆ›å»ºçº¿ç¨‹å‡½æ•°     */    private void createWorkTask() &#123;        /** åˆ›å»ºçº¿ç¨‹ **/        WorkerTask task = new WorkerTask(GROUP, THREAD_PREFIX + (seq++));        /** å¯åŠ¨çº¿ç¨‹ **/        task.start();        /** çº¿ç¨‹æ·»åŠ åˆ°ç»„ä¸­ **/        THREAD_QUEUE.add(task);    &#125;    /**     * ä»»åŠ¡æäº¤     * @param runnable     */    public void submit(Runnable runnable) &#123;        if(destroy)&#123;            throw new IllegalStateException(&quot;çº¿ç¨‹æ± å·²ç»é”€æ¯ä¸èƒ½å†æäº¤æ–°çš„ä»»åŠ¡...&quot;);        &#125;        synchronized (TASK_QUEUE) &#123;            // é˜Ÿåˆ—é•¿åº¦å¤§äºæŒ‡å®šé˜Ÿåˆ—é•¿åº¦ï¼Œæ‰§è¡Œç­–ç•¥            if (TASK_QUEUE.size() &gt; taskQueueSize) &#123;                discardPolicy.discard();            &#125;            // ä»åé¢æ·»åŠ æ–°ä»»åŠ¡            TASK_QUEUE.addLast(runnable);            // é€šçŸ¥å”¤é†’çº¿ç¨‹            TASK_QUEUE.notifyAll();        &#125;    &#125;    /**     * åœæ­¢çº¿ç¨‹æ± è¿è¡Œ     */    public void shutdonw() throws InterruptedException &#123;        // å¦‚æœçº¿ç¨‹é˜Ÿåˆ—ä¸­è¿˜æœ‰åœ¨æ‰§è¡Œçš„ç»“ç¨‹ï¼Œé‚£æ‰§è¡Œåœæ­¢çš„æ–¹æ³•éœ€è¦ç­‰å¾…ã€‚ç­‰å¾…åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½æ‰§è¡Œå®Œæˆã€‚        while (!TASK_QUEUE.isEmpty()) &#123;            Thread.sleep(50);        &#125;        int initVal = THREAD_QUEUE.size();        while (initVal &gt; 0) &#123;            for (WorkerTask workerTask : THREAD_QUEUE) &#123;                if (workerTask.getTaskState() == TaskState.BLOCKED) &#123;                    // æ‰“æ–­çº¿ç¨‹                    workerTask.interrupt();                    // ä¿®æ”¹çº¿ç¨‹çŠ¶æ€ä¸ºç»“æŸçŠ¶æ€                    workerTask.close();                    initVal--;                &#125; else &#123;                    Thread.sleep(10);                &#125;            &#125;        &#125;        this.destroy = true;        System.out.println(&quot;çº¿ç¨‹å·²ç»è¿è¡Œç»“æŸ...&quot;);    &#125;    private static class WorkerTask extends Thread &#123;        /**         * é»˜è®¤çº¿ç¨‹çš„çŠ¶æ€æ˜¯ç©ºé—²çš„         **/        private volatile TaskState taskState = TaskState.FREE;        /**         * è®¾ç½®çº¿ç¨‹ç»„         **/        public WorkerTask(ThreadGroup group, String name) &#123;            super(group, name);        &#125;        @Override        public void run() &#123;            OUTTER:            // çŠ¶æ€ä¸æ˜¯DEADçŠ¶æ€ï¼Œä¸€ç›´å¤„ç†çº¿ç¨‹            while (this.taskState != TaskState.DEAD) &#123;                Runnable runnable;                synchronized (TASK_QUEUE) &#123;                    // ç¨‹çº¿æ± ä¸­ä¸€ç›´æ˜¯ç©ºçš„ï¼Œä¸€ç›´ç­‰å¾…                    while (TASK_QUEUE.isEmpty()) &#123;                        try &#123;                            this.taskState = TaskState.BLOCKED;                            TASK_QUEUE.wait();                        &#125; catch (InterruptedException e) &#123;                            // e.printStackTrace();                            break OUTTER;                        &#125;                    &#125;                    // ä»æ­¤åˆ—è¡¨ä¸­åˆ é™¤å¹¶è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚                    runnable = TASK_QUEUE.removeFirst();                &#125;                if (runnable != null) &#123;                    // è®¾ç½®çº¿ç¨‹çŠ¶æ€ï¼Œè¿è¡Œä¸­                    taskState = TaskState.RUNNING;                    // runå‡½æ•°                    runnable.run();                    // è®¾ç½®çº¿ç¨‹çŠ¶æ€ï¼Œç©ºé—²                    taskState = TaskState.FREE;                &#125;            &#125;        &#125;        /**         * è·å¾—çº¿ç¨‹çŠ¶æ€         *         * @return         */        public TaskState getTaskState() &#123;            return this.taskState;        &#125;        /**         * ç»“æŸçº¿ç¨‹çŠ¶æ€         */        public void close() &#123;            this.taskState = TaskState.DEAD;        &#125;    &#125;    public static void main(String[] args) throws InterruptedException &#123;        SimpleThreadPool simpleThreadPool = new SimpleThreadPool();        // æ‹’ç»ç­–ç•¥        // SimpleThreadPool simpleThreadPool = new SimpleThreadPool(6, 10, DEFAULT_DISCARD_POLICY);        for (int i = 0; i &lt; 50; i++) &#123;            simpleThreadPool.submit(new Runnable() &#123;                @Override                public void run() &#123;                    System.out.println(String.format(&quot;çº¿ç¨‹ã€%sã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œ&quot;, Thread.currentThread()));                    try &#123;                        Thread.sleep(1000L);                    &#125; catch (InterruptedException e) &#123;                        e.printStackTrace();                    &#125;                    System.out.println(String.format(&quot;çº¿ç¨‹ã€%sã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸ&quot;, Thread.currentThread()));                &#125;            &#125;);        &#125;        Thread.sleep(1000L);        simpleThreadPool.shutdonw();    &#125;&#125;
æ‰§è¡Œç»“æœï¼š
çº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-4,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-1,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-3,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-2,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-0,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-0,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-4,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-3,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-1,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-2,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-3,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-4,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-0,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-2,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-1,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-2,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-3,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-1,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-0,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-4,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-1,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-3,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-2,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-4,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-0,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-4,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-0,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-2,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-1,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-3,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-2,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-0,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-4,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-3,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-1,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-2,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-3,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-1,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-3,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-0,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-1,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-4,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-0,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-2,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-4,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-2,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-0,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-1,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-0,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-3,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-4,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-1,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-4,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-2,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-3,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-2,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-3,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-4,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-0,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-1,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-4,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-0,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-3,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-2,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-1,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-0,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-4,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-3,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-2,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-1,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-3,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-4,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-1,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-0,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-2,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-0,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-3,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-0,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-2,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-3,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-1,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-4,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-2,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-4,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-1,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-4,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-3,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-2,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-0,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-2,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-0,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-1,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-3,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-4,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-1,5,POOL_GROUP]ã€‘ï¼Œå·²ç»å¼€å§‹&gt;&gt;è¿è¡Œçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-0,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-1,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-2,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-3,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹ã€Thread[SIMPLE-THREAD-POOL-4,5,POOL_GROUP]ã€‘ï¼Œå·²ç»&lt;&lt;ç»“æŸçº¿ç¨‹å·²ç»è¿è¡Œç»“æŸ...



 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(åä¸€)Javaå¤šçº¿ç¨‹ä¹‹è‡ªå®šä¹‰çº¿ç¨‹æ± ã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(åä¸ƒ)Javaå¤šçº¿ç¨‹ä¹‹ForkJoinæ¡†æ¶</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E5%8D%81%E4%B8%83)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BForkJoin%E6%A1%86%E6%9E%B6/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(åä¸ƒ)Javaå¤šçº¿ç¨‹ä¹‹ForkJoinæ¡†æ¶1.1 ä»€ä¹ˆæ˜¯ForkJoinæ¡†æ¶ï¼Ÿ&emsp;&emsp; Fork&#x2F;Join æ¡†æ¶ï¼Œå¯ä»¥å°†ä¸€ä¸ªå¤§çš„ä»»åŠ¡æ‹†åˆ†æˆå¤šä¸ªå­ä»»åŠ¡è¿›è¡Œå¹¶è¡Œå¤„ç†ï¼Œæœ€åå°†å­ä»»åŠ¡ç»“æœåˆå¹¶æˆæœ€åçš„è®¡ç®—ç»“æœï¼Œå¹¶è¿›è¡Œè¾“å‡ºã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒFork&#x2F;Join èƒ½è¯•ç€å»ä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„å¤„ç†å™¨ï¼Œä»¥è¾¾åˆ°åŠ é€Ÿå¤„ç†å¤šçº¿ç¨‹çš„ç›®çš„ã€‚æœ¬æ–‡ä¸­å¯¹Fork&#x2F;Joinæ¡†æ¶çš„è®²è§£ï¼ŒåŸºäºJDK1.8+ä¸­çš„Fork&#x2F;Joinæ¡†æ¶å®ç°ã€‚

Fork&#x2F;Joinæ¡†æ¶è¦å®Œæˆä¸¤ä»¶äº‹æƒ…ï¼š

ä»»åŠ¡åˆ†å‰²ï¼š&emsp;&emsp; é¦–å…ˆFork&#x2F;Joinæ¡†æ¶éœ€è¦æŠŠå¤§çš„ä»»åŠ¡åˆ†å‰²æˆè¶³å¤Ÿå°çš„å­ä»»åŠ¡ï¼Œå¦‚æœå­ä»»åŠ¡æ¯”è¾ƒå¤§çš„è¯è¿˜è¦å¯¹å­ä»»åŠ¡è¿›è¡Œç»§ç»­åˆ†å‰²ã€‚

æ‰§è¡Œä»»åŠ¡å¹¶åˆå¹¶ç»“æœï¼š&emsp;&emsp; åˆ†å‰²çš„å­ä»»åŠ¡åˆ†åˆ«æ”¾åˆ°åŒç«¯é˜Ÿåˆ—é‡Œï¼Œç„¶åå‡ ä¸ªå¯åŠ¨çº¿ç¨‹åˆ†åˆ«ä»åŒç«¯é˜Ÿåˆ—é‡Œè·å–ä»»åŠ¡æ‰§è¡Œã€‚å­ä»»åŠ¡æ‰§è¡Œå®Œçš„ç»“æœéƒ½æ”¾åœ¨å¦å¤–ä¸€ä¸ªé˜Ÿåˆ—é‡Œï¼Œå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ä»é˜Ÿåˆ—é‡Œå–æ•°æ®ï¼Œç„¶ååˆå¹¶è¿™äº›æ•°æ®ã€‚

ForkJoinTaskç±»ï¼š&emsp;&emsp;ä½¿ç”¨Fork&#x2F;Joinæ¡†æ¶ï¼Œé¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ªForkJoinä»»åŠ¡ã€‚è¯¥ç±»æä¾›äº†åœ¨ä»»åŠ¡ä¸­æ‰§è¡Œforkå’Œjoinçš„æœºåˆ¶ã€‚é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬ä¸éœ€è¦ç›´æ¥é›†æˆForkJoinTaskç±»ï¼Œåªéœ€è¦ç»§æ‰¿å®ƒçš„å­ç±»ï¼ŒFork&#x2F;Joinæ¡†æ¶æä¾›äº†ä¸¤ä¸ªå­ç±»:&emsp;&emsp;RecursiveTaskï¼š ç”¨äºæœ‰è¿”å›ç»“æœçš„ä»»åŠ¡&emsp;&emsp;RecursiveActionï¼šç”¨äºæ²¡æœ‰è¿”å›ç»“æœçš„ä»»åŠ¡



1.2 RecursiveTaskä½¿ç”¨æ ·ä¾‹ä½¿ç”¨CalculatorRecursiveTask extends RecursiveTaskå®Œæˆ1åˆ°10000ç´¯åŠ çš„éœ€æ±‚ï¼Œä»£ç å¦‚ä¸‹ï¼š
package com.yuanxw.chapter17;import java.util.concurrent.ExecutionException;import java.util.concurrent.ForkJoinPool;import java.util.concurrent.ForkJoinTask;import java.util.concurrent.RecursiveTask;import java.util.stream.IntStream;/** * ä½¿ç”¨CalculatorRecursiveTask extends RecursiveTaskå®Œæˆ1åˆ°10000ç´¯åŠ çš„éœ€æ±‚ */public class ForkJoinRecursiveTask &#123;    // é˜ˆå€¼    private final static int THRESHOLD = 200;    public static void main(String[] args) throws ExecutionException, InterruptedException &#123;        // è®¡ç®—1-50ç´¯åŠ å€¼        CalculatorRecursiveTask calculatorRecursiveTask = new CalculatorRecursiveTask(1,10000);        ForkJoinPool forkJoinPool = new ForkJoinPool();        ForkJoinTask&lt;Integer&gt; forkJoinTask = forkJoinPool.submit(calculatorRecursiveTask);        System.out.println(&quot;è®¡ç®—ç»“æœï¼š&quot;+forkJoinTask.get());    &#125;    /**     * æœ‰è¿”å›å€¼ForkJoinä»»åŠ¡     */    private static class CalculatorRecursiveTask extends RecursiveTask&lt;Integer&gt; &#123;        // å¼€å§‹è®¡ç®—æœºä½ç½®        public int first;        // ç»“æŸè®¡ç®—æœºä½ç½®        private int last;        /**         * æ„é€ å‡½æ•°         *         * @param first         * @param last         */        public CalculatorRecursiveTask(int first, int last) &#123;            this.first = first;            this.last = last;        &#125;        @Override        protected Integer compute() &#123;            if (last - first &lt;= THRESHOLD) &#123;                /**                 * ä»»åŠ¡è¶³å¤Ÿå°åˆ™ç›´æ¥è®¡ç®—                 * ä½¿ç”¨lambdaè¡¨è¾¾å¼ç®€åŒ–å¦‚ä¸‹ä»£ç                  * &lt;pre&gt;                 * for (int i = first; i &lt;= last; i++) &#123;                 *     result += i;                 * &#125;                 * &lt;/pre&gt;                 */                return IntStream.rangeClosed(first, last).sum();            &#125; else &#123;                // è·å¾—ä¸­é—´å€¼ï¼Œå‘ä¸Šå–æ•´                int middle = (first + last) / 2;                CalculatorRecursiveTask leftTask = new CalculatorRecursiveTask(first, middle);                CalculatorRecursiveTask rightTask = new CalculatorRecursiveTask(middle + 1, last);                leftTask.fork();                rightTask.fork();                return leftTask.join() + rightTask.join();            &#125;        &#125;    &#125;&#125;
æ‰§è¡Œç»“æœï¼š
è®¡ç®—ç»“æœï¼š50005000

1.3 ForkJoinPoolçº¿ç¨‹æ± &emsp;&emsp;ForkJoin ä½¿ç”¨ ForkJoinPool æ¥å¯åŠ¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ•°é‡å–å†³äº CPU æ ¸æ•°ã€‚
public class ForkJoinPool extends AbstractExecutorService &#123;    /**     * Creates a &#123;@code ForkJoinPool&#125; with parallelism equal to &#123;@link     * java.lang.Runtime#availableProcessors&#125;, using the &#123;@linkplain     * #defaultForkJoinWorkerThreadFactory default thread factory&#125;,     * no UncaughtExceptionHandler, and non-async LIFO processing mode.     *     * @throws SecurityException if a security manager exists and     *         the caller is not permitted to modify threads     *         because it does not hold &#123;@link     *         java.lang.RuntimePermission&#125;&#123;@code (&quot;modifyThread&quot;)&#125;     */    public ForkJoinPool() &#123;        this(Math.min(MAX_CAP, Runtime.getRuntime().availableProcessors()),             defaultForkJoinWorkerThreadFactory, null, false);    &#125;
ForkJoinPool å®ç°äº†å·¥ä½œçªƒå–ç®—æ³•æ¥æé«˜ CPU çš„åˆ©ç”¨ç‡ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½ç»´æŠ¤äº†ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—ï¼Œç”¨æ¥å­˜å‚¨éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚å·¥ä½œçªƒå–ç®—æ³•å…è®¸ç©ºé—²çš„çº¿ç¨‹ä»å…¶å®ƒçº¿ç¨‹çš„åŒç«¯é˜Ÿåˆ—ä¸­çªƒå–ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œã€‚çªƒå–çš„ä»»åŠ¡å¿…é¡»æ˜¯æœ€æ™šçš„ä»»åŠ¡ï¼Œé¿å…å’Œé˜Ÿåˆ—æ‰€å±çº¿ç¨‹å‘ç”Ÿç«äº‰ã€‚ä¾‹å¦‚ä¸‹å›¾ä¸­ï¼ŒThread2 ä» Thread1 çš„é˜Ÿåˆ—ä¸­æ‹¿å‡ºæœ€æ™šçš„ Task1 ä»»åŠ¡ï¼ŒThread1 ä¼šæ‹¿å‡º Task2 æ¥æ‰§è¡Œï¼Œè¿™æ ·å°±é¿å…å‘ç”Ÿç«äº‰ã€‚ä½†æ˜¯å¦‚æœé˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªä»»åŠ¡æ—¶è¿˜æ˜¯ä¼šå‘ç”Ÿç«äº‰ã€‚

1.4 RecursiveActionä½¿ç”¨æ ·ä¾‹
ç”¨äºæ²¡æœ‰è¿”å›ç»“æœçš„ä»»åŠ¡ï¼Œåˆ©ç”¨RecursiveActionï¼Œæ‹†åˆ†å¤§æ–‡ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š

package com.yuanxw.chapter17;import java.io.File;import java.io.FileInputStream;import java.io.FileNotFoundException;import java.io.FileOutputStream;import java.io.IOException;import java.nio.channels.FileChannel;import java.util.concurrent.ForkJoinPool;import java.util.concurrent.ForkJoinTask;import java.util.concurrent.RecursiveAction;import java.util.concurrent.TimeUnit;/** * åˆ©ç”¨RecursiveActionï¼Œæ‹†åˆ†å¤§æ–‡ä»¶ */public class ForkJoinRecursiveAction &#123;    // é˜ˆå€¼    private final static int SPLIT_THRESHOLD = 100_000_000;    public static void main(String[] args) throws IOException, InterruptedException &#123;        String fileFullPath = &quot;G:\\å½“å¹¸ç¦æ¥æ•²é—¨BDä¸­è‹±åŒå­—1280é«˜æ¸….rmvb&quot;;        File bigFile = new File(fileFullPath);        FileInputStream fileInputStream = new FileInputStream(bigFile);        ForkJoinPool forkJoinPool = new ForkJoinPool();        ForkJoinTask&lt;Void&gt; submit = forkJoinPool.submit(new SplitFileRecursiveAction(fileInputStream, fileFullPath, 0, (int) bigFile.length()));        // ç­‰å¾…ä»»åŠ¡æ‰§è¡Œç»“æŸ        forkJoinPool.awaitTermination(1, TimeUnit.SECONDS);    &#125;    /**     * æ— è¿”å›å€¼ForkJoinä»»åŠ¡     */    private static class SplitFileRecursiveAction extends RecursiveAction &#123;        // æ–‡ä»¶è¾“å‡ºæµ        private FileInputStream fileInputStream;        // æ–‡ä»¶å…¨è·¯å¾„        private String fileFullPath;        // å¼€å§‹ä½ç½®        private int start;        // ç»“æŸä½ç½®        private int end;        public SplitFileRecursiveAction(FileInputStream fileInputStream, String fileFullPath, int start, int end) &#123;            this.fileInputStream = fileInputStream;            this.fileFullPath = fileFullPath;            this.start = start;            this.end = end;        &#125;        @Override        protected void compute() &#123;            // å¦‚æœä»»åŠ¡è®¡ç®—å°äºé˜ˆå€¼ï¼Œåˆ™å¼€å§‹æ‹†åˆ†æ–‡ä»¶            int length = end - start;            System.out.println(start +&quot;-&quot;+end);            if(length &lt;= SPLIT_THRESHOLD)&#123;                try &#123;                    // æ¯æ¬¡åˆ‡å‰²å¤§å°                    byte[] buffer = new byte[length];                    File currentTempFile = new File(fileFullPath);                    String[] split = currentTempFile.getName().split(&quot;\\.&quot;);                    File fileName = new File(String.format(&quot;%s_%s_%s.%s&quot;, currentTempFile.getParent()+split[0], start, end, split[1]));                    FileOutputStream fileOutputStream = new FileOutputStream(fileName);                    FileChannel outputChannel = fileOutputStream.getChannel();                    // é€šé“ä¼ è¾“æ–‡ä»¶æ•°æ®                    fileInputStream.getChannel().transferTo(start, end, outputChannel);                    fileOutputStream.write(buffer);                    fileOutputStream.flush();                    outputChannel.close();                &#125; catch (FileNotFoundException e) &#123;                    e.printStackTrace();                &#125; catch (IOException e) &#123;                    e.printStackTrace();                &#125;            &#125; else &#123;                // è·å¾—ä¸­é—´å€¼ï¼Œå‘ä¸Šå–æ•´                int middle = (end + start) / 2;                SplitFileRecursiveAction leftAction = new SplitFileRecursiveAction(fileInputStream,fileFullPath,start,middle);                SplitFileRecursiveAction rightAction = new SplitFileRecursiveAction(fileInputStream,fileFullPath,middle+1,end);                leftAction.fork();                rightAction.fork();                leftAction.join();                rightAction.join();            &#125;        &#125;    &#125;&#125;
æ‰§è¡Œç»“æœï¼š

 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(åä¸ƒ)Javaå¤šçº¿ç¨‹ä¹‹ForkJoinæ¡†æ¶ã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(åä¸‰)Javaå¤šçº¿ç¨‹ä¹‹CyclicBarrier</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E5%8D%81%E4%B8%89)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BCyclicBarrier/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(åä¸‰)Javaå¤šçº¿ç¨‹ä¹‹CyclicBarrier&emsp;&emsp; CyclicBarrier å’Œ CountDownLatch éå¸¸ç±»ä¼¼ï¼Œå®ƒä¹Ÿå¯ä»¥å®ç°çº¿ç¨‹é—´çš„æŠ€æœ¯ç­‰å¾…ï¼Œä½†æ˜¯å®ƒçš„åŠŸèƒ½æ¯” CountDownLatch æ›´åŠ å¤æ‚å’Œå¼ºå¤§ã€‚ä¸»è¦åº”ç”¨åœºæ™¯å’Œ CountDownLatch ç±»ä¼¼ã€‚
1.1 CyclicBarrierç±»&emsp;&emsp;  CyclicBarrieræ˜¯java.util.concurrentåŒ…ä¸‹é¢çš„ä¸€ä¸ªå·¥å…·ç±»ï¼Œå­—é¢æ„æ€æ˜¯å¯å¾ªç¯ä½¿ç”¨ï¼ˆCyclicï¼‰çš„å±éšœï¼ˆBarrierï¼‰ï¼Œé€šè¿‡å®ƒå¯ä»¥å®ç°è®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœï¼ˆä¹Ÿå¯ä»¥å«åŒæ­¥ç‚¹ï¼‰æ—¶è¢«é˜»å¡ï¼Œç›´åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œæ‰€æœ‰è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚

CyclicBarrieræ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶,å®ƒå¯ä»¥ä½¿å¾—ä¸€ç»„çº¿ç¨‹åœ¨åŒä¸€ä¸ªéšœç¢ç‚¹è¿›è¡Œç­‰å¾…ã€‚
CyclicBarriers å¯ä»¥é€šè¿‡é‡ç½®è®¡æ•°å™¨ä»è€Œé‡æ–°ä½¿ç”¨ã€‚
CyclicBarrieræ”¯æŒä¸€ä¸ªå¯é€‰çš„Runnableå‘½ä»¤(å®ä¾‹åŒ–æ„é€ å‡½æ•°ä¸­çš„å‚æ•°)ï¼Œè¯¥å‘½ä»¤åœ¨æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾åï¼Œä½†åœ¨ä»»ä½•çº¿ç¨‹è¢«é‡Šæ”¾ä¹‹å‰è¢«æ‰§è¡Œã€‚è¿™ä¸€å‘½ä»¤åœ¨barrierå¤„åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡,ä¸”ç”±æœ€ååˆ°è¾¾çš„çº¿ç¨‹å®Œæˆã€‚è¿™ç§å±éšœè¡Œä¸ºå¯¹äºåœ¨ä»»ä½•ä¸€æ–¹ç»§ç»­ä¹‹å‰æ›´æ–°å…±äº«çŠ¶æ€éƒ½å¾ˆæœ‰ç”¨ã€‚
all-or-noneç ´æŸæ¨¡å‹ï¼šå¦‚æœä¸€ä¸ªçº¿ç¨‹å› ä¸ºä¸­æ–­(oræ‰§è¡Œè¿‡ç¨‹çš„å¤±è´¥,è¶…æ—¶ç­‰)è¿‡æ—©çš„ç¦»å¼€äº†barrierç‚¹,é‚£ä¹ˆç­‰å¾…åœ¨barrierç‚¹çš„å…¶ä»–æ‰€æœ‰çº¿ç¨‹ä¹Ÿä¼šåœ¨åŒä¸€æ—¶é—´å› ä¸ºBrokenBarrierExceptionæˆ–è€…InterruptedExceptionå¼‚å¸¸è€Œç¦»å¼€barrierã€‚å†…å­˜ä¸€è‡´æ€§å½±å“ï¼š

çº¿ç¨‹åœ¨è°ƒç”¨await()æ–¹æ³•ä¹‹å‰çš„è¡Œä¸ºè¦ä¼˜å…ˆäºbarrier actionä¸­çš„ä»»ä½•è¡Œä¸ºã€‚



barrier actionæˆåŠŸè¿”å›è¿™ä¸€è¡Œä¸ºè¦ä¼˜å…ˆäºæ‰€æœ‰å…¶ä»–ç­‰å¾…çº¿ç¨‹await()åçš„è¡Œä¸ºã€‚



1.2 CyclicBarrierç¤ºä¾‹package com.yuanxw.chapter13;import java.util.concurrent.BrokenBarrierException;import java.util.concurrent.CyclicBarrier;import java.util.concurrent.TimeUnit;/** * CyclicBarrier çš„å­—é¢æ„æ€æ˜¯å¯å¾ªç¯ä½¿ç”¨ï¼ˆCyclicï¼‰çš„å±éšœï¼ˆBarrierï¼‰ã€‚ * å®ƒè¦åšçš„äº‹æƒ…æ˜¯ï¼Œè®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœï¼ˆä¹Ÿå¯ä»¥å«åŒæ­¥ç‚¹ï¼‰æ—¶è¢«é˜»å¡ï¼Œç›´åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œå±éšœæ‰ä¼šå¼€é—¨ï¼Œæ‰€æœ‰è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹æ‰ä¼šç»§ç»­å¹²æ´»ã€‚ * CyclicBarrieré»˜è®¤çš„æ„é€ æ–¹æ³•æ˜¯CyclicBarrier(int parties)ï¼Œå…¶å‚æ•°è¡¨ç¤ºå±éšœæ‹¦æˆªçš„çº¿ç¨‹æ•°é‡ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨awaitæ–¹æ³•å‘Šè¯‰CyclicBarrieræˆ‘å·²ç»åˆ°è¾¾äº†å±éšœï¼Œç„¶åå½“å‰çº¿ç¨‹è¢«é˜»å¡ã€‚ */public class CyclicBarrierExample &#123;    private static volatile boolean isRunning = true;    public static void main(String[] args) throws BrokenBarrierException, InterruptedException &#123;        final CyclicBarrier cyclicBarrier = new CyclicBarrier(2, new Runnable() &#123;            @Override            public void run() &#123;                isRunning = false;                System.out.println(&quot;ä»»åŠ¡æ‰§è¡Œç»“æŸåï¼Œå›è°ƒå‡½æ•°ï¼ï¼ï¼&quot;);            &#125;        &#125;);        /** çº¿ç¨‹-A **/        new Thread(()-&gt;&#123;            try &#123;                TimeUnit.SECONDS.sleep(20);                System.out.println(String.format(&quot;çº¿ç¨‹ã€%sã€‘æ‰§è¡Œå®Œæˆ&quot;, Thread.currentThread().getName()));                cyclicBarrier.await();            &#125; catch (InterruptedException e) &#123;                e.printStackTrace();            &#125; catch (BrokenBarrierException e) &#123;                e.printStackTrace();            &#125;        &#125;,&quot;Thread-A&quot;).start();        /** çº¿ç¨‹-A **/        new Thread(()-&gt;&#123;            try &#123;                TimeUnit.SECONDS.sleep(10);                System.out.println(String.format(&quot;çº¿ç¨‹ã€%sã€‘æ‰§è¡Œå®Œæˆ&quot;, Thread.currentThread().getName()));                cyclicBarrier.await();            &#125; catch (InterruptedException e) &#123;                e.printStackTrace();            &#125; catch (BrokenBarrierException e) &#123;                e.printStackTrace();            &#125;        &#125;,&quot;Thread-B&quot;).start();        while (isRunning) &#123;            System.out.println(String.format(&quot;å½“å‰æ­£åœ¨ç­‰å¾…æ•°é‡ï¼šã€%sã€‘&quot;, cyclicBarrier.getNumberWaiting()));            System.out.println(String.format(&quot;æ­£åœ¨ç­‰å¾…æ‰€éœ€æ•°é‡ï¼šã€%sã€‘ &quot;, cyclicBarrier.getParties()));            System.out.println(String.format(&quot;ä¸­æ–­æˆ–è¶…æ—¶ï¼šã€%sã€‘&quot;, cyclicBarrier.isBroken()));            TimeUnit.SECONDS.sleep(5);        &#125;    &#125;&#125;
æ‰§è¡Œç»“æœï¼š
å½“å‰æ­£åœ¨ç­‰å¾…æ•°é‡ï¼šã€0ã€‘æ­£åœ¨ç­‰å¾…æ‰€éœ€æ•°é‡ï¼šã€2ã€‘ ä¸­æ–­æˆ–è¶…æ—¶ï¼šã€falseã€‘å½“å‰æ­£åœ¨ç­‰å¾…æ•°é‡ï¼šã€0ã€‘æ­£åœ¨ç­‰å¾…æ‰€éœ€æ•°é‡ï¼šã€2ã€‘ ä¸­æ–­æˆ–è¶…æ—¶ï¼šã€falseã€‘çº¿ç¨‹ã€Thread-Bã€‘æ‰§è¡Œå®Œæˆå½“å‰æ­£åœ¨ç­‰å¾…æ•°é‡ï¼šã€1ã€‘æ­£åœ¨ç­‰å¾…æ‰€éœ€æ•°é‡ï¼šã€2ã€‘ ä¸­æ–­æˆ–è¶…æ—¶ï¼šã€falseã€‘å½“å‰æ­£åœ¨ç­‰å¾…æ•°é‡ï¼šã€1ã€‘æ­£åœ¨ç­‰å¾…æ‰€éœ€æ•°é‡ï¼šã€2ã€‘ ä¸­æ–­æˆ–è¶…æ—¶ï¼šã€falseã€‘çº¿ç¨‹ã€Thread-Aã€‘æ‰§è¡Œå®Œæˆä»»åŠ¡æ‰§è¡Œç»“æŸåï¼Œå›è°ƒå‡½æ•°ï¼ï¼ï¼

1.3 CyclicBarrier å’Œ CountDownLatch çš„åŒºåˆ«
CountDownLatch æ˜¯è®¡æ•°å™¨ï¼Œåªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œè€Œ CyclicBarrier çš„è®¡æ•°å™¨æä¾› reset åŠŸèƒ½ï¼Œå¯ä»¥å¤šæ¬¡ä½¿ç”¨ã€‚
å¯¹äº CountDownLatch æ¥è¯´ï¼Œé‡ç‚¹æ˜¯â€œä¸€ä¸ªçº¿ç¨‹ï¼ˆå¤šä¸ªçº¿ç¨‹ï¼‰ç­‰å¾…â€ï¼Œè€Œå…¶ä»–çš„ N ä¸ªçº¿ç¨‹åœ¨å®Œæˆâ€œæŸä»¶äº‹æƒ…â€ä¹‹åï¼Œå¯ä»¥ç»ˆæ­¢ï¼Œä¹Ÿå¯ä»¥ç­‰å¾…ã€‚è€Œå¯¹äº CyclicBarrierï¼Œé‡ç‚¹æ˜¯å¤šä¸ªçº¿ç¨‹ï¼Œåœ¨ä»»æ„ä¸€ä¸ªçº¿ç¨‹æ²¡æœ‰å®Œæˆï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½å¿…é¡»ç­‰å¾…ã€‚
CountDownLatch æ˜¯è®¡æ•°å™¨ï¼Œçº¿ç¨‹å®Œæˆä¸€ä¸ªè®°å½•ä¸€ä¸ªï¼Œåªä¸è¿‡è®¡æ•°ä¸æ˜¯é€’å¢è€Œæ˜¯é€’å‡ï¼Œè€Œ CyclicBarrier æ›´åƒæ˜¯ä¸€ä¸ªé˜€é—¨ï¼Œéœ€è¦æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾ï¼Œé˜€é—¨æ‰èƒ½æ‰“å¼€ï¼Œç„¶åç»§ç»­æ‰§è¡Œã€‚

 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(åä¸‰)Javaå¤šçº¿ç¨‹ä¹‹CyclicBarrierã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVA å¤šçº¿ç¨‹(åä¹)Java å¤šçº¿ç¨‹ä¹‹ CachedThreadPool å¯ç¼“å­˜çº¿ç¨‹æ± </title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E5%8D%81%E4%B9%9D)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BnewCachedThreadPool%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%B1%BB/</url>
    <content><![CDATA[1.JAVA å¤šçº¿ç¨‹(åä¹)Java å¤šçº¿ç¨‹ä¹‹ CachedThreadPool å¯ç¼“å­˜çº¿ç¨‹æ± 1.1 å¯ç¼“å­˜çº¿ç¨‹æ±  CachedThreadPool&emsp;&emsp; å¯ç¼“å­˜çº¿ç¨‹æ±  CachedThreadPool æ˜¯ä¸€ä¸ªæ ¹æ®éœ€è¦åˆ›å»ºæ–°çº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚é€šè¿‡æºä»£ç æŸ¥çœ‹ CachedThreadPool å®ç°ï¼š
/** * Creates a thread pool that creates new threads as needed, but * will reuse previously constructed threads when they are * available.  These pools will typically improve the performance * of programs that execute many short-lived asynchronous tasks. * Calls to &#123;@code execute&#125; will reuse previously constructed * threads if available. If no existing thread is available, a new * thread will be created and added to the pool. Threads that have * not been used for sixty seconds are terminated and removed from * the cache. Thus, a pool that remains idle for long enough will * not consume any resources. Note that pools with similar * properties but different details (for example, timeout parameters) * may be created using &#123;@link ThreadPoolExecutor&#125; constructors. * * @return the newly created thread pool */public static ExecutorService newCachedThreadPool() &#123;    return new ThreadPoolExecutor(0, Integer.MAX_VALUE,                                  60L, TimeUnit.SECONDS,                                  new SynchronousQueue&lt;Runnable&gt;());&#125;/** * Creates a thread pool that creates new threads as needed, but * will reuse previously constructed threads when they are * available, and uses the provided * ThreadFactory to create new threads when needed. * @param threadFactory the factory to use when creating new threads * @return the newly created thread pool * @throws NullPointerException if threadFactory is null */public static ExecutorService newCachedThreadPool(ThreadFactory threadFactory) &#123;    return new ThreadPoolExecutor(0, Integer.MAX_VALUE,                                  60L, TimeUnit.SECONDS,                                  new SynchronousQueue&lt;Runnable&gt;(),                                  threadFactory);&#125;

åœ¨ CachedThreadPool å®ç°ä¸­ï¼š

corePoolSize &#x3D;&gt; 0ï¼Œæ ¸å¿ƒçº¿ç¨‹æ± çš„æ•°é‡ä¸ºï¼š0
maximumPoolSize &#x3D;&gt; Integer.MAX_VALUEï¼Œçº¿ç¨‹æ± æœ€å¤§æ•°é‡ä¸º Integer.MAX_VALUEï¼Œå¯ä»¥è®¤ä¸ºå¯ä»¥æ— é™åˆ›å»ºçº¿ç¨‹ã€‚åœ¨èµ„æºæœ‰é™çš„æƒ…å†µä¸‹å®¹æ˜“å¼•èµ· OOM å¼‚å¸¸ã€‚
keepAliveTime &#x3D;&gt; keepAliveTime ä¸º 60 å°‘ï¼Œæ„å‘³ç€çº¿ç¨‹ç©ºé—²æ—¶é—´è¶…è¿‡ 60S å°±ä¼šè¢«æ€æ­»ï¼›
workQueue &#x3D;&gt; é‡‡ç”¨ SynchronousQueue è£…ç­‰å¾…çš„ä»»åŠ¡ï¼Œè¿™ä¸ªé˜»å¡é˜Ÿåˆ—æ²¡æœ‰å­˜å‚¨ç©ºé—´ï¼Œè¿™æ„å‘³ç€åªè¦æœ‰è¯·æ±‚åˆ°æ¥ï¼Œå°±å¿…é¡»è¦æ‰¾åˆ°ä¸€æ¡å·¥ä½œçº¿ç¨‹å¤„ç†ä»–ï¼Œå¦‚æœå½“å‰æ²¡æœ‰ç©ºé—²çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆå°±ä¼šå†åˆ›å»ºä¸€æ¡æ–°çš„çº¿ç¨‹ã€‚

1.2 CachedThreadPool ä½¿ç”¨æ ·ä¾‹CachedThreadPool çº¿ç¨‹æ± ç‰¹ç‚¹ï¼š

å·¥ä½œçº¿ç¨‹çš„åˆ›å»ºæ•°é‡å‡ ä¹æ²¡æœ‰é™åˆ¶(å…¶å®ä¹Ÿæœ‰é™åˆ¶çš„,æ•°ç›®ä¸º Interger. MAX_VALUE), è¿™æ ·å¯çµæ´»çš„å¾€çº¿ç¨‹æ± ä¸­æ·»åŠ çº¿ç¨‹ã€‚
keepAliveTime æ—¶é•¿ä¸º 60 ç§’ï¼Œè¶…è¿‡ 60 ç§’çš„ç©ºé—²çº¿ç¨‹å°±ä¼šè¢«å›æ”¶ï¼Œå½“çº¿ç¨‹æ± éƒ½å¤„äºé—²ç½®çŠ¶æ€æ—¶ï¼Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹éƒ½ä¼šå› ä¸ºè¶…æ—¶è€Œè¢«å›æ”¶ï¼Œæ‰€ä»¥å‡ ä¹ä¸ä¼šå ç”¨ä»€ä¹ˆç³»ç»Ÿèµ„æºã€‚ä»»åŠ¡é˜Ÿåˆ—é‡‡ç”¨çš„æ˜¯ SynchronousQueueï¼Œè¿™ä¸ªé˜Ÿåˆ—æ˜¯æ— æ³•æ’å…¥ä»»åŠ¡çš„ï¼Œä¸€æœ‰ä»»åŠ¡ç«‹å³æ‰§è¡Œï¼Œæ‰€ä»¥ CachedThreadPool æ¯”è¾ƒé€‚åˆä»»åŠ¡é‡å¤§ä½†è€—æ—¶å°‘çš„ä»»åŠ¡ã€‚

package com.yuanxw.chapter19;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.ThreadPoolExecutor;import java.util.concurrent.TimeUnit;public class CachedThreadPoolExample &#123;    public static void main(String[] args) throws InterruptedException &#123;        ExecutorService executorService = Executors.newCachedThreadPool();        ThreadPoolExecutor threadPoolExecutor = (ThreadPoolExecutor) executorService;        System.out.println(&quot;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š&quot; + threadPoolExecutor.getActiveCount());        executorService.execute(()-&gt;System.out.println(String.format(&quot;çº¿ç¨‹ã€%sã€‘æ­£åœ¨å·¥ä½œ......&quot;, Thread.currentThread().getName())));        System.out.println(&quot;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š&quot; + threadPoolExecutor.getActiveCount());        for (int i = 0; i &lt; 20; i++) &#123;            executorService.execute(()-&gt;&#123;                    try &#123;                        TimeUnit.SECONDS.sleep(1);                        System.out.println(String.format(&quot;çº¿ç¨‹ã€%sã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;&quot;, Thread.currentThread().getName()));                        System.out.println(&quot;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š&quot; + threadPoolExecutor.getActiveCount());                    &#125; catch (InterruptedException e) &#123;                        e.printStackTrace();                    &#125;            &#125;);        &#125;        TimeUnit.SECONDS.sleep(5);        System.out.println(&quot;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š&quot; + threadPoolExecutor.getActiveCount());    &#125;&#125;

æ‰§è¡Œç»“æœï¼š
è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š0è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š1çº¿ç¨‹ã€pool-1-thread-1ã€‘æ­£åœ¨å·¥ä½œ......çº¿ç¨‹ã€pool-1-thread-3ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;çº¿ç¨‹ã€pool-1-thread-7ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;çº¿ç¨‹ã€pool-1-thread-5ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š20çº¿ç¨‹ã€pool-1-thread-4ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;çº¿ç¨‹ã€pool-1-thread-6ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;çº¿ç¨‹ã€pool-1-thread-2ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š19è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š19è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š20è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š20è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š19çº¿ç¨‹ã€pool-1-thread-19ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;çº¿ç¨‹ã€pool-1-thread-15ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;çº¿ç¨‹ã€pool-1-thread-21ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;çº¿ç¨‹ã€pool-1-thread-16ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;çº¿ç¨‹ã€pool-1-thread-20ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;çº¿ç¨‹ã€pool-1-thread-14ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š14çº¿ç¨‹ã€pool-1-thread-8ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š14è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š14çº¿ç¨‹ã€pool-1-thread-11ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;çº¿ç¨‹ã€pool-1-thread-12ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;çº¿ç¨‹ã€pool-1-thread-18ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š14è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š11è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š11è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š11è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š13çº¿ç¨‹ã€pool-1-thread-9ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;çº¿ç¨‹ã€pool-1-thread-13ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š14çº¿ç¨‹ã€pool-1-thread-10ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š14çº¿ç¨‹ã€pool-1-thread-17ã€‘æ­£åœ¨å·¥ä½œ&gt;&gt;&gt;&gt;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š5è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š6è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š6è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š4è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š0

CachedThreadPool çš„ execute()æ–¹æ³•çš„æ‰§è¡Œç¤ºæ„å›¾ï¼ˆè¯¥å›¾ç‰‡æ¥æºï¼šã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹ï¼‰ï¼š

é¦–å…ˆæ‰§è¡Œ SynchronousQueue.offer(Runnable task) æäº¤ä»»åŠ¡åˆ°ä»»åŠ¡é˜Ÿåˆ—ã€‚å¦‚æœå½“å‰ maximumPool ä¸­æœ‰é—²çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ SynchronousQueue.poll(keepAliveTime,TimeUnit.NANOSECONDS)ï¼Œé‚£ä¹ˆä¸»çº¿ç¨‹æ‰§è¡Œ offer æ“ä½œä¸ç©ºé—²çº¿ç¨‹æ‰§è¡Œçš„ poll æ“ä½œé…å¯¹æˆåŠŸï¼Œä¸»çº¿ç¨‹æŠŠä»»åŠ¡äº¤ç»™ç©ºé—²çº¿ç¨‹æ‰§è¡Œï¼Œexecute()æ–¹æ³•æ‰§è¡Œå®Œæˆï¼Œå¦åˆ™æ‰§è¡Œä¸‹é¢çš„æ­¥éª¤

å½“åˆå§‹ maximumPool ä¸ºç©ºï¼Œæˆ–è€… maximumPool ä¸­æ²¡æœ‰ç©ºé—²çº¿ç¨‹æ—¶ï¼Œå°†æ²¡æœ‰çº¿ç¨‹æ‰§è¡Œ SynchronousQueue.poll(keepAliveTime,TimeUnit.NANOSECONDS)ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ­¥éª¤ 1 å°†å¤±è´¥ï¼Œæ­¤æ—¶ CachedThreadPool ä¼šåˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œexecute æ–¹æ³•æ‰§è¡Œå®Œæˆï¼›


&emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVA å¤šçº¿ç¨‹(åä¹)Java å¤šçº¿ç¨‹ä¹‹ CachedThreadPool å¯ç¼“å­˜çº¿ç¨‹æ± ã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚
  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(åäºŒ)Javaå¤šçº¿ç¨‹ä¹‹CountDownLatch</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E5%8D%81%E4%BA%8C)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BCountDownLatch/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(åäºŒ)Javaå¤šçº¿ç¨‹ä¹‹CountDownLatch1.1 CountDownLatchæ˜¯ä»€ä¹ˆ?&emsp;&emsp; CountDownLatch æ˜¯ä¸€ä¸ªåŒæ­¥å·¥å…·ç±»ï¼Œå®ƒå…è®¸ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹çš„æ“ä½œæ‰§è¡Œå®Œåå†æ‰§è¡Œã€‚CountDownLatchæ˜¯åœ¨java1.5è¢«å¼•å…¥çš„ï¼Œè·Ÿå®ƒä¸€èµ·è¢«å¼•å…¥çš„å¹¶å‘å·¥å…·ç±»è¿˜æœ‰CyclicBarrierã€Semaphoreã€ConcurrentHashMapå’ŒBlockingQueueï¼Œå®ƒä»¬éƒ½å­˜åœ¨äºjava.util.concurrentåŒ…ä¸‹ã€‚CountDownLatchè¿™ä¸ªç±»èƒ½å¤Ÿä½¿ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆå„è‡ªçš„å·¥ä½œåå†æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œåº”ç”¨ç¨‹åºçš„ä¸»çº¿ç¨‹å¸Œæœ›åœ¨è´Ÿè´£å¯åŠ¨æ¡†æ¶æœåŠ¡çš„çº¿ç¨‹å·²ç»å¯åŠ¨æ‰€æœ‰çš„æ¡†æ¶æœåŠ¡ä¹‹åå†æ‰§è¡Œã€‚

æŸä¸€çº¿ç¨‹åœ¨å¼€å§‹è¿è¡Œå‰ç­‰å¾… n ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚å°† CountDownLatch çš„è®¡æ•°å™¨åˆå§‹åŒ–ä¸º n ï¼šnew CountDownLatch(n)ï¼Œæ¯å½“ä¸€ä¸ªä»»åŠ¡çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå°±å°†è®¡æ•°å™¨å‡ 1 countdownlatch.countDown()ï¼Œå½“è®¡æ•°å™¨çš„å€¼å˜ä¸º 0 æ—¶ï¼Œåœ¨CountDownLatchä¸Š await() çš„çº¿ç¨‹å°±ä¼šè¢«å”¤é†’ã€‚ä¸€ä¸ªå…¸å‹åº”ç”¨åœºæ™¯å°±æ˜¯å¯åŠ¨ä¸€ä¸ªæœåŠ¡æ—¶ï¼Œä¸»çº¿ç¨‹éœ€è¦ç­‰å¾…å¤šä¸ªç»„ä»¶åŠ è½½å®Œæ¯•ï¼Œä¹‹åå†ç»§ç»­æ‰§è¡Œã€‚

å®ç°å¤šä¸ªçº¿ç¨‹å¼€å§‹æ‰§è¡Œä»»åŠ¡çš„æœ€å¤§å¹¶è¡Œæ€§ã€‚æ³¨æ„æ˜¯å¹¶è¡Œæ€§ï¼Œä¸æ˜¯å¹¶å‘ï¼Œå¼ºè°ƒçš„æ˜¯å¤šä¸ªçº¿ç¨‹åœ¨æŸä¸€æ—¶åˆ»åŒæ—¶å¼€å§‹æ‰§è¡Œã€‚ç±»ä¼¼äºèµ›è·‘ï¼Œå°†å¤šä¸ªçº¿ç¨‹æ”¾åˆ°èµ·ç‚¹ï¼Œç­‰å¾…å‘ä»¤æªå“ï¼Œç„¶ååŒæ—¶å¼€è·‘ã€‚åšæ³•æ˜¯åˆå§‹åŒ–ä¸€ä¸ªå…±äº«çš„ CountDownLatch å¯¹è±¡ï¼Œå°†å…¶è®¡æ•°å™¨åˆå§‹åŒ–ä¸º 1 ï¼šnew CountDownLatch(1)ï¼Œå¤šä¸ªçº¿ç¨‹åœ¨å¼€å§‹æ‰§è¡Œä»»åŠ¡å‰é¦–å…ˆ coundownlatch.await()ï¼Œå½“ä¸»çº¿ç¨‹è°ƒç”¨ countDown() æ—¶ï¼Œè®¡æ•°å™¨å˜ä¸º 0ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è¢«å”¤é†’ã€‚

CountDownLatchç»´æŠ¤äº†ä¸€ä¸ªè®¡æ•°å™¨ cntï¼Œæ¯æ¬¡è°ƒç”¨ countDown() æ–¹æ³•ä¼šè®©è®¡æ•°å™¨çš„å€¼å‡ 1ï¼Œå‡åˆ° 0 çš„æ—¶å€™ï¼Œé‚£äº›å› ä¸ºè°ƒç”¨ await() æ–¹æ³•è€Œåœ¨ç­‰å¾…çš„çº¿ç¨‹å°±ä¼šè¢«å”¤é†’ã€‚



1.2 CountdownLatchä½¿ç”¨ä¾‹å­package com.yuanxw.chapter12;import java.util.Random;import java.util.concurrent.CountDownLatch;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.stream.IntStream;public class CountdownLatchExample &#123;    /** éšæœºæ•°ï¼šä½¿ç”¨longå‚æ•°çš„æ‰€æœ‰64ä½ä½œä¸ºå› å­å€¼ã€‚ **/    private static Random random = new Random(System.currentTimeMillis());    /** æ€»çº¿ç¨‹æ•° **/    private static final int TOTAL_THREAD_NUMBER = 5;    /** é€šè¿‡çº¿ç¨‹æ± ï¼Œåˆ›å»º5ä¸ªçº¿ç¨‹ **/    private static ExecutorService executorService = Executors.newFixedThreadPool(TOTAL_THREAD_NUMBER);    /** åˆ›å»ºCountDownLatchå¯¹è±¡ **/    private static CountDownLatch countDownLatch = new CountDownLatch(TOTAL_THREAD_NUMBER);    public static void main(String[] args) throws InterruptedException &#123;        IntStream.range(0,5).forEach(i-&gt;&#123;            executorService.execute(()-&gt;&#123;                doWorking();                /** å°†countå€¼å‡1 **/                countDownLatch.countDown();            &#125;);        &#125;);        /** å½“å‰çº¿ç¨‹ç­‰åˆ°é”å­˜å™¨è®¡æ•°åˆ°é›¶  **/        countDownLatch.await();        executorService.shutdown();        System.out.println(&quot;æ‰€æœ‰çº¿ç¨‹å·¥ä½œå·²ç»æ‰§è¡Œå®Œæˆï¼ï¼ï¼&quot;);    &#125;    /**     * æ¨¡æ‹Ÿå·¥ä½œæ–¹æ³•     */    private static void doWorking()&#123;        try &#123;            System.out.println(String.format(&quot;çº¿ç¨‹ã€%sã€‘å·¥ä½œ&gt;&gt;å¼€å§‹&quot;, Thread.currentThread().getName()));            Thread.sleep(random.nextInt(1000));            System.out.println(String.format(&quot;çº¿ç¨‹ã€%sã€‘å·¥ä½œ&lt;&lt;ç»“æŸ&quot;, Thread.currentThread().getName()));        &#125; catch (InterruptedException e) &#123;            e.printStackTrace();        &#125;    &#125;&#125;
æ‰§è¡Œç»“æœï¼š
çº¿ç¨‹ã€pool-1-thread-2ã€‘å·¥ä½œ&gt;&gt;å¼€å§‹çº¿ç¨‹ã€pool-1-thread-5ã€‘å·¥ä½œ&gt;&gt;å¼€å§‹çº¿ç¨‹ã€pool-1-thread-3ã€‘å·¥ä½œ&gt;&gt;å¼€å§‹çº¿ç¨‹ã€pool-1-thread-4ã€‘å·¥ä½œ&gt;&gt;å¼€å§‹çº¿ç¨‹ã€pool-1-thread-1ã€‘å·¥ä½œ&gt;&gt;å¼€å§‹çº¿ç¨‹ã€pool-1-thread-4ã€‘å·¥ä½œ&lt;&lt;ç»“æŸçº¿ç¨‹ã€pool-1-thread-2ã€‘å·¥ä½œ&lt;&lt;ç»“æŸçº¿ç¨‹ã€pool-1-thread-3ã€‘å·¥ä½œ&lt;&lt;ç»“æŸçº¿ç¨‹ã€pool-1-thread-1ã€‘å·¥ä½œ&lt;&lt;ç»“æŸçº¿ç¨‹ã€pool-1-thread-5ã€‘å·¥ä½œ&lt;&lt;ç»“æŸæ‰€æœ‰çº¿ç¨‹å·¥ä½œå·²ç»æ‰§è¡Œå®Œæˆï¼ï¼ï¼


 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(åä¸€)Javaå¤šçº¿ç¨‹ä¹‹CountDownLatchã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(åäº”)Javaå¤šçº¿ç¨‹ä¹‹ReentrantLocké‡å…¥é”</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E5%8D%81%E4%BA%94)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BReentrantLock%E9%87%8D%E5%85%A5%E9%94%81/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(åäº”)Javaå¤šçº¿ç¨‹ä¹‹ReentrantLocké‡å…¥é”1.1 ä»€ä¹ˆæ˜¯ReentrantLocké‡å…¥é”ï¼Ÿ&emsp;&emsp; é‡å…¥é”ï¼šè‡ªå·±å¯ä»¥å†æ¬¡è·å–è‡ªå·±çš„å†…éƒ¨é”ã€‚æ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹è·å¾—äº†æŸä¸ªå¯¹è±¡çš„é”ï¼Œæ­¤æ—¶è¿™ä¸ªå¯¹è±¡é”è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œå½“å…¶å†æ¬¡æƒ³è¦è·å–è¿™ä¸ªå¯¹è±¡çš„é”çš„æ—¶å€™è¿˜æ˜¯å¯ä»¥è·å–çš„ï¼Œå¦‚æœä¸å¯é”é‡å…¥çš„è¯ï¼Œå°±ä¼šé€ æˆæ­»é”ã€‚åŒä¸€ä¸ªçº¿ç¨‹æ¯æ¬¡è·å–é”ï¼Œé”çš„è®¡æ•°å™¨éƒ½è‡ªå¢1ï¼Œæ‰€ä»¥è¦ç­‰åˆ°é”çš„è®¡æ•°å™¨ä¸‹é™ä¸º0æ—¶æ‰èƒ½é‡Šæ”¾é”ã€‚
1.2 synchronizedå’ŒReentrantLock çš„åŒºåˆ«
ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”ã€‚
synchronized ä¾èµ–äº JVM è€Œ ReentrantLock ä¾èµ–äº APIsynchronized æ˜¯ä¾èµ–äº JVM å®ç°çš„ï¼Œå‰é¢æˆ‘ä»¬ä¹Ÿè®²åˆ°äº† è™šæ‹Ÿæœºå›¢é˜Ÿåœ¨ JDK1.6 ä¸º synchronized å…³é”®å­—è¿›è¡Œäº†å¾ˆå¤šä¼˜åŒ–ï¼Œä½†æ˜¯è¿™äº›ä¼˜åŒ–éƒ½æ˜¯åœ¨è™šæ‹Ÿæœºå±‚é¢å®ç°çš„ï¼Œå¹¶æ²¡æœ‰ç›´æ¥æš´éœ²ç»™æˆ‘ä»¬ã€‚ReentrantLock æ˜¯ JDK å±‚é¢å®ç°çš„ï¼ˆä¹Ÿå°±æ˜¯ API å±‚é¢ï¼Œéœ€è¦ lock() å’Œ unlock() æ–¹æ³•é…åˆ try&#x2F;finally è¯­å¥å—æ¥å®Œæˆï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹å®ƒçš„æºä»£ç ï¼Œæ¥çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ã€‚
ReentrantLock æ¯” synchronized å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½:


ç­‰å¾…å¯ä¸­æ–­ï¼š&emsp;&emsp; ReentrantLockæä¾›äº†ä¸€ç§èƒ½å¤Ÿä¸­æ–­ç­‰å¾…é”çš„çº¿ç¨‹çš„æœºåˆ¶ï¼Œé€šè¿‡lock.lockInterruptibly()æ¥å®ç°è¿™ä¸ªæœºåˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥é€‰æ‹©æ”¾å¼ƒç­‰å¾…ï¼Œæ”¹ä¸ºå¤„ç†å…¶ä»–äº‹æƒ…ã€‚

å¯å®ç°å…¬å¹³é”ï¼šReentrantLockå¯ä»¥æŒ‡å®šæ˜¯å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ã€‚è€Œsynchronizedåªèƒ½æ˜¯éå…¬å¹³é”ã€‚æ‰€è°“çš„å…¬å¹³é”å°±æ˜¯å…ˆç­‰å¾…çš„çº¿ç¨‹å…ˆè·å¾—é”ã€‚ ReentrantLocké»˜è®¤æƒ…å†µæ˜¯éå…¬å¹³çš„ï¼Œå¯ä»¥é€šè¿‡ ReentrantLockç±»çš„ReentrantLock(boolean fair)æ„é€ æ–¹æ³•æ¥åˆ¶å®šæ˜¯å¦æ˜¯å…¬å¹³çš„

å¯å®ç°é€‰æ‹©æ€§é€šçŸ¥ï¼ˆé”å¯ä»¥ç»‘å®šå¤šä¸ªæ¡ä»¶ï¼‰synchronizedå…³é”®å­—ä¸wait()å’Œnotify()&#x2F;notifyAll()æ–¹æ³•ç›¸ç»“åˆå¯ä»¥å®ç°ç­‰å¾…&#x2F;é€šçŸ¥æœºåˆ¶ï¼ŒReentrantLockç±»å½“ç„¶ä¹Ÿå¯ä»¥å®ç°ï¼Œä½†æ˜¯éœ€è¦å€ŸåŠ©äºConditionæ¥å£ä¸newCondition() æ–¹æ³•ã€‚Conditionæ˜¯JDK1.5ä¹‹åæ‰æœ‰çš„ï¼Œå®ƒå…·æœ‰å¾ˆå¥½çš„çµæ´»æ€§ï¼Œæ¯”å¦‚å¯ä»¥å®ç°å¤šè·¯é€šçŸ¥åŠŸèƒ½ä¹Ÿå°±æ˜¯åœ¨ä¸€ä¸ªLockå¯¹è±¡ä¸­å¯ä»¥åˆ›å»ºå¤šä¸ªConditionå®ä¾‹ï¼ˆå³å¯¹è±¡ç›‘è§†å™¨ï¼‰ï¼Œçº¿ç¨‹å¯¹è±¡å¯ä»¥æ³¨å†Œåœ¨æŒ‡å®šçš„Conditionä¸­ï¼Œä»è€Œå¯ä»¥æœ‰é€‰æ‹©æ€§çš„è¿›è¡Œçº¿ç¨‹é€šçŸ¥ï¼Œåœ¨è°ƒåº¦çº¿ç¨‹ä¸Šæ›´åŠ çµæ´»ã€‚ åœ¨ä½¿ç”¨notify()&#x2F;notifyAll()æ–¹æ³•è¿›è¡Œé€šçŸ¥æ—¶ï¼Œè¢«é€šçŸ¥çš„çº¿ç¨‹æ˜¯ç”± JVM é€‰æ‹©çš„ï¼Œç”¨ReentrantLockç±»ç»“åˆConditionå®ä¾‹å¯ä»¥å®ç°â€œé€‰æ‹©æ€§é€šçŸ¥â€ ï¼Œè¿™ä¸ªåŠŸèƒ½éå¸¸é‡è¦ï¼Œè€Œä¸”æ˜¯Conditionæ¥å£é»˜è®¤æä¾›çš„ã€‚è€Œsynchronizedå…³é”®å­—å°±ç›¸å½“äºæ•´ä¸ªLockå¯¹è±¡ä¸­åªæœ‰ä¸€ä¸ªConditionå®ä¾‹ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½æ³¨å†Œåœ¨å®ƒä¸€ä¸ªèº«ä¸Šã€‚å¦‚æœæ‰§è¡ŒnotifyAll()æ–¹æ³•çš„è¯å°±ä¼šé€šçŸ¥æ‰€æœ‰å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹è¿™æ ·ä¼šé€ æˆå¾ˆå¤§çš„æ•ˆç‡é—®é¢˜ï¼Œè€ŒConditionå®ä¾‹çš„signalAll()æ–¹æ³• åªä¼šå”¤é†’æ³¨å†Œåœ¨è¯¥Conditionå®ä¾‹ä¸­çš„æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ã€‚



ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”&emsp;&emsp;JDK5ä¸­ï¼Œsynchronizedæ˜¯æ€§èƒ½ä½æ•ˆçš„ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªé‡é‡çº§æ“ä½œï¼Œå¯¹æ€§èƒ½çš„æœ€å¤§å½±å“æ˜¯é˜»å¡çš„å®ç°ï¼ŒæŒ‚èµ·çº¿ç¨‹å’Œæ¢å¤çº¿ç¨‹çš„æ“ä½œï¼Œéƒ½éœ€è¦è½¬å…¥å†…æ ¸æ€ä¸­å®Œæˆï¼Œç»™å¹¶å‘å¸¦æ¥äº†å¾ˆå¤§å‹åŠ›ã€‚JDK6ä¸­synchronizedåŠ å…¥äº†è‡ªé€‚åº”è‡ªæ—‹ã€é”æ¶ˆé™¤ã€é”ç²—åŒ–ã€è½»é‡çº§é”ã€åå‘é”ç­‰ä¸€ç³»åˆ—ä¼˜åŒ–ï¼Œå®˜æ–¹ä¹Ÿæ”¯æŒsynchronizedï¼Œæå€¡åœ¨synchronizedèƒ½å®ç°éœ€æ±‚çš„å‰æä¸‹ï¼Œä¼˜å…ˆè€ƒè™‘synchronizedæ¥è¿›è¡ŒåŒæ­¥ã€‚

1.3 ReentrantLockä½¿ç”¨æ ·ä¾‹package com.yuanxw.chapter15;import java.util.concurrent.TimeUnit;import java.util.concurrent.locks.Lock;import java.util.concurrent.locks.ReentrantLock;import java.util.stream.IntStream;/** * ReentrantLocké‡å…¥é” */public class ReentrantLockExample &#123;    private static final Lock LOCK = new ReentrantLock();    public static void main(String[] args) &#123;        // åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹        IntStream.range(0, 2).forEach(i -&gt; &#123;            new Thread(() -&gt; testReentrantLock()).start();        &#125;);    &#125;    public static void testReentrantLock() &#123;        try &#123;            LOCK.lock();            System.out.println(String.format(&quot;çº¿ç¨‹ã€%sã€‘å·¥ä½œ---&gt;å¼€å§‹&quot;, Thread.currentThread().getName()));            TimeUnit.SECONDS.sleep(5);        &#125; catch (InterruptedException e) &#123;            e.printStackTrace();        &#125; finally &#123;            LOCK.unlock();            System.out.println(String.format(&quot;çº¿ç¨‹ã€%sã€‘å·¥ä½œ---&gt;ç»“æŸ&quot;, Thread.currentThread().getName()));        &#125;    &#125;&#125;

æ‰§è¡Œç»“æœï¼š
çº¿ç¨‹ã€Thread-0ã€‘å·¥ä½œ---&gt;å¼€å§‹çº¿ç¨‹ã€Thread-0ã€‘å·¥ä½œ---&gt;ç»“æŸçº¿ç¨‹ã€Thread-1ã€‘å·¥ä½œ---&gt;å¼€å§‹çº¿ç¨‹ã€Thread-1ã€‘å·¥ä½œ---&gt;ç»“æŸ
1.4 ReentrantLockæºç 
æ„é€ æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºé»˜è®¤çš„æ— å‚æ˜¯éå…¬å¹³é”ï¼Œæœ‰å‚æ„é€ trueè¡¨ç¤ºå…¬å¹³ï¼Œfalseè¡¨ç¤ºéå…¬å¹³ã€‚lock()è·å–é”ï¼Œå…¶å®å°±æ˜¯æŠŠstateä»0å˜æˆnï¼ˆé‡å…¥é”å¯ä»¥ç´¯åŠ ï¼‰ã€‚å®é™…è°ƒç”¨çš„æ˜¯syncçš„lockæ–¹æ³•ï¼Œåˆ†å…¬å¹³å’Œéå…¬å¹³ã€‚

/** * Creates an instance of &#123;@code ReentrantLock&#125;. * This is equivalent to using &#123;@code ReentrantLock(false)&#125;. */public ReentrantLock() &#123;    sync = new NonfairSync();&#125;/** * Creates an instance of &#123;@code ReentrantLock&#125; with the * given fairness policy. * * @param fair &#123;@code true&#125; if this lock should use a fair ordering policy */public ReentrantLock(boolean fair) &#123;    sync = fair ? new FairSync() : new NonfairSync();&#125;

å…¬å¹³å®ç°ï¼šFairSyncï¼Œæˆ‘ä»¬å‘ç°å…¶å®è°ƒç”¨çš„æ˜¯acquireï¼Œå…¶å®è¿™ä¸ªæ˜¯AQSçš„acquireï¼Œç„¶åaqsçš„acquireçš„æ–¹æ³•é‡Œé¢åˆä¼šè°ƒç”¨tryAcquireæ–¹æ³•ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•éœ€è¦åŒæ­¥ç»„ä»¶è‡ªå·±å»å®ç°ï¼Œæ‰€ä»¥ReentrantLocké‡Œé¢é‡å†™äº†AQSçš„tryAcquireæ–¹æ³•,æ‰€ä»¥æˆ‘ä»¬è·å–åˆ°é”å°±ä¼šè¿”å›trueï¼Œæ²¡æœ‰å°±ä¼šè¿”å›falseï¼›ç„¶åæ²¡æœ‰è·å–åˆ°é”çš„çº¿ç¨‹å°±äº¤ç»™AQSå»å¤„ç†ã€‚

/** * Sync object for fair locks */static final class FairSync extends Sync &#123;    private static final long serialVersionUID = -3000897897090466540L;    final void lock() &#123;        acquire(1);    &#125;    /**     * Fair version of tryAcquire.  Don&#x27;t grant access unless     * recursive call or no waiters or is first.     */    protected final boolean tryAcquire(int acquires) &#123;        // è·å–å½“å‰çš„çº¿ç¨‹        final Thread current = Thread.currentThread();        // è·å–é”çš„çŠ¶æ€        int c = getState();        if (c == 0) &#123;            /**              * hasQueuedPredecessors åˆ¤æ–­é˜Ÿåˆ—è¿˜æœ‰æ²¡æœ‰å…¶å®ƒnode,è¦ä¿è¯å…¬å¹³             * æ²¡æœ‰åœ¨ç”¨casè®¾ç½®çŠ¶æ€            **/            if (!hasQueuedPredecessors() &amp;&amp;                compareAndSetState(0, acquires)) &#123;                // è®¾ç½®è·å–é”çš„çº¿ç¨‹                setExclusiveOwnerThread(current);                return true;            &#125;        &#125;        // åˆ¤æ–­å½“å‰çº¿ç¨‹æœ‰æ²¡æœ‰è·å–åˆ°é”        else if (current == getExclusiveOwnerThread()) &#123;            // è·å–è¿‡äº†å°±ç´¯åŠ ï¼Œå› ä¸ºå¯ä»¥é‡å…¥            int nextc = c + acquires;            if (nextc &lt; 0)                throw new Error(&quot;Maximum lock count exceeded&quot;);            // é‡æ–°è®¾ç½®é”çš„çŠ¶æ€            setState(nextc);            return true;        &#125;        return false;    &#125;&#125;

éå…¬å¹³å®ç°ï¼šNonfairSync,æˆ‘ä»¬å¯ä»¥å‘ç°åŸºæœ¬å’Œå…¬å¹³ä¸€æ ·ï¼Œå°±æ²¡æœ‰hasQueuedPredecessorsæ–¹æ³•ï¼Œæ²¡æœ‰éµå¾ªFIFOé˜Ÿåˆ—çš„æ¨¡å¼ï¼Œè€Œæ˜¯ä¸ç®¡é˜Ÿåˆ—æœ‰æ²¡æœ‰nodeï¼Œè‡ªå·±éƒ½å¯ä»¥å»è·å–é”ï¼Œä¸éœ€è¦æ’é˜Ÿ

/** * Sync object for fair locks */static final class FairSync extends Sync &#123;    private static final long serialVersionUID = -3000897897090466540L;    final void lock() &#123;        acquire(1);    &#125;    /**     * Fair version of tryAcquire.  Don&#x27;t grant access unless     * recursive call or no waiters or is first.     */    protected final boolean tryAcquire(int acquires) &#123;        final Thread current = Thread.currentThread();        int c = getState();        if (c == 0) &#123;            if (!hasQueuedPredecessors() &amp;&amp;                compareAndSetState(0, acquires)) &#123;                setExclusiveOwnerThread(current);                return true;            &#125;        &#125;        else if (current == getExclusiveOwnerThread()) &#123;            int nextc = c + acquires;            if (nextc &lt; 0)                throw new Error(&quot;Maximum lock count exceeded&quot;);            setState(nextc);            return true;        &#125;        return false;    &#125;&#125;

unlocké‡Šæ”¾é”ï¼šå…¶å®å°±æ˜¯æŠŠstateä»nï¼ˆå¯èƒ½å‘ç”Ÿäº†é”çš„é‡å…¥ï¼Œéœ€è¦å¤šæ¬¡é‡Šæ”¾ï¼‰å˜æˆ0ï¼Œè¿™ä¸ªä¸åŒºåˆ†å…¬å¹³ä¸éå…¬å¹³ï¼Œé¦–å…ˆå…¶å®ä¹Ÿæ˜¯è°ƒç”¨AQSçš„releaseæ–¹æ³•ï¼Œç„¶åAQSåœ¨è°ƒç”¨å­ç±»Syncçš„tryReleaseæ–¹æ³•ã€‚

/** * Attempts to release this lock. * * &lt;p&gt;If the current thread is the holder of this lock then the hold * count is decremented.  If the hold count is now zero then the lock * is released.  If the current thread is not the holder of this * lock then &#123;@link IllegalMonitorStateException&#125; is thrown. * * @throws IllegalMonitorStateException if the current thread does not *         hold this lock */public void unlock() &#123;    sync.release(1);&#125;protected final boolean tryRelease(int releases) &#123;    // è·å–é”çš„çŠ¶æ€    int c = getState() - releases;    // è·å¾—é”çš„çº¿ç¨‹æ‰èƒ½é‡Šæ”¾é”    if (Thread.currentThread() != getExclusiveOwnerThread())        throw new IllegalMonitorStateException();    boolean free = false;    // ç›´åˆ°é”çš„çŠ¶æ€æ˜¯0ï¼Œè¯´æ˜é”é‡Šæ”¾æˆåŠŸï¼Œå› ä¸ºæœ‰é‡å…¥é”    // è¯´æ˜æˆ‘ä»¬åœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œé¢è°ƒç”¨å‡ æ¬¡lockï¼Œå°±è¦è°ƒç”¨å‡ æ¬¡unlockï¼Œæ‰èƒ½æœ€ç»ˆé‡Šæ”¾é”    if (c == 0) &#123;        free = true;        // é‡Šæ”¾çº¿ç¨‹çš„æ‹¥æœ‰è€…        setExclusiveOwnerThread(null);    &#125;    // è®¾ç½®é”çš„çŠ¶æ€    setState(c);    return free;&#125;/** * Releases in exclusive mode.  Implemented by unblocking one or * more threads if &#123;@link #tryRelease&#125; returns true. * This method can be used to implement method &#123;@link Lock#unlock&#125;. * * @param arg the release argument.  This value is conveyed to *        &#123;@link #tryRelease&#125; but is otherwise uninterpreted and *        can represent anything you like. * @return the value returned from &#123;@link #tryRelease&#125; */public final boolean release(int arg) &#123;    if (tryRelease(arg)) &#123;        Node h = head;        if (h != null &amp;&amp; h.waitStatus != 0)            unparkSuccessor(h);        return true;    &#125;    return false;&#125;

 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(åäº”)Javaå¤šçº¿ç¨‹ä¹‹ReentrantLocké‡å…¥é”ã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(åå…«)Javaå¤šçº¿ç¨‹ä¹‹Executoræ¡†æ¶&amp;ThreadPoolExecutorç±»</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E5%8D%81%E5%85%AB)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BExecutor%E6%A1%86%E6%9E%B6&amp;ThreadPoolExecutor%E7%B1%BB/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(åå…«)Javaå¤šçº¿ç¨‹ä¹‹Executoræ¡†æ¶&amp;ThreadPoolExecutorç±»&emsp;&emsp; Executor æ¡†æ¶æ˜¯ Java5 ä¹‹åå¼•è¿›çš„ï¼Œåœ¨ Java 5 ä¹‹åï¼Œé€šè¿‡ Executor æ¥å¯åŠ¨çº¿ç¨‹æ¯”ä½¿ç”¨ Thread çš„ start æ–¹æ³•æ›´å¥½ï¼Œé™¤äº†æ›´æ˜“ç®¡ç†ï¼Œæ•ˆç‡æ›´å¥½ï¼ˆç”¨çº¿ç¨‹æ± å®ç°ï¼ŒèŠ‚çº¦å¼€é”€ï¼‰å¤–ï¼Œè¿˜æœ‰å…³é”®çš„ä¸€ç‚¹ï¼šæœ‰åŠ©äºé¿å… this é€ƒé€¸é—®é¢˜ã€‚

this é€ƒé€¸æ˜¯æŒ‡åœ¨æ„é€ å‡½æ•°è¿”å›ä¹‹å‰å…¶ä»–çº¿ç¨‹å°±æŒæœ‰è¯¥å¯¹è±¡çš„å¼•ç”¨. è°ƒç”¨å°šæœªæ„é€ å®Œå…¨çš„å¯¹è±¡çš„æ–¹æ³•å¯èƒ½å¼•å‘ä»¤äººç–‘æƒ‘çš„é”™è¯¯ã€‚

åœ¨å¼€å‘ä¸­å¦‚æœéœ€è¦åˆ›å»ºçº¿ç¨‹å¯ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨Executorï¼Œæ— è®ºä½ éœ€è¦å¤šçº¿ç¨‹è¿˜æ˜¯å•çº¿ç¨‹ï¼ŒExecutorä¸ºä½ æä¾›äº†å¾ˆå¤šå…¶ä»–åŠŸèƒ½ï¼ŒåŒ…æ‹¬çº¿ç¨‹çŠ¶æ€ï¼Œç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†ã€‚Executor æ¡†æ¶ä¸ä»…åŒ…æ‹¬äº†çº¿ç¨‹æ± çš„ç®¡ç†ï¼Œè¿˜æä¾›äº†çº¿ç¨‹å·¥å‚ã€é˜Ÿåˆ—ä»¥åŠæ‹’ç»ç­–ç•¥ç­‰ï¼ŒExecutor æ¡†æ¶è®©å¹¶å‘ç¼–ç¨‹å˜å¾—æ›´åŠ ç®€å•ã€‚
1.1 æ— é™åˆ¶åˆ›å»ºçº¿ç¨‹ä¸è¶³åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œâ€œä¸ºæ¯ä¸ªä»»åŠ¡åˆ†é…ä¸€ä¸ªçº¿ç¨‹â€è¿™ç§æ–¹æ³•å­˜åœ¨ä¸€äº›ç¼ºé™·ï¼Œå°¤å…¶æ˜¯å½“éœ€è¦åˆ›å»ºå¤§é‡çº¿ç¨‹æ—¶ï¼š

ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå¼€é”€éå¸¸é«˜ï¼šç®¡ç†è¿™äº›çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¼šæ˜æ˜¾å¢åŠ  CPU çš„æ‰§è¡Œæ—¶é—´ï¼Œä¼šæ¶ˆè€—å¤§é‡è®¡ç®—èµ„æºã€‚
èµ„æºæ¶ˆè€—ï¼šæ´»è·ƒçš„çº¿ç¨‹ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œå°¤å…¶æ˜¯å†…å­˜ã€‚å¦‚æœå¯è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤šäºå¯ç”¨çš„å¤„ç†å™¨çš„æ•°é‡ï¼Œé‚£ä¹ˆæœ‰äº›çº¿ç¨‹å°†é—²ç½®ã€‚å¤§é‡ç©ºé—²çš„çº¿ç¨‹ä¼šå ç”¨è®¸å¤šå†…å­˜ï¼Œç»™åƒåœ¾å›æ”¶å™¨å¸¦æ¥å‹åŠ›ï¼Œè€Œä¸”å¤§é‡çº¿ç¨‹åœ¨ç«äº‰CPUèµ„æºæ—¶è¿˜å°†äº§ç”Ÿå…¶ä»–çš„æ€§èƒ½å¼€é”€ã€‚å¦‚æœä½ å·²ç»æ‹¥æœ‰è¶³å¤Ÿå¤šçš„çº¿ç¨‹ä½¿æ‰€æœ‰çš„CPUä¿æŒå¿™ç¢ŒçŠ¶æ€ï¼Œé‚£ä¹ˆå†åˆ›å»ºæ›´å¤šçš„çº¿ç¨‹åè€Œä¼šé™ä½æ€§èƒ½ã€‚
ç¨³å®šæ€§ï¼šåˆ›å»ºçº¿ç¨‹çš„æ•°é‡å­˜åœ¨ä¸€ä¸ªé™åˆ¶ï¼Œè¿™ä¸ªé™åˆ¶å°†éšç€å¹³å°çš„ä¸åŒè€Œä¸åŒï¼Œå¹¶ä¸”å—å¤šä¸ªå› ç´ åˆ¶çº¦ï¼ŒåŒ…æ‹¬jvmçš„å¯åŠ¨å‚æ•°ã€Threadæ„é€ å‡½æ•°ä¸­è¯·æ±‚çš„æ ˆå¤§å°ï¼Œä»¥åŠåº•å±‚æ“ä½œçš„é™åˆ¶ç­‰ã€‚å¦‚æœè¶…è¿‡äº†è¿™ä¸ªé™åˆ¶ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½æŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ï¼Œè¿™å¯¹äºè¿è¡Œä¸­çš„åº”ç”¨æ¥è¯´æ˜¯éå¸¸å±é™©çš„ã€‚

æ‰€æœ‰çš„è¿™äº›å› ç´ éƒ½ä¼šå¯¼è‡´ç³»ç»Ÿååé‡ä¸‹é™ã€‚çº¿ç¨‹æ± é€šè¿‡ä¿æŒä¸€äº›å­˜æ´»çº¿ç¨‹å¹¶é‡ç”¨è¿™äº›çº¿ç¨‹æ¥å…‹æœè¿™ä¸ªé—®é¢˜ã€‚å½“æäº¤åˆ°çº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡å¤šäºçº¿ç¨‹æ± æœ€å¤§ä»»åŠ¡æ•°æ—¶ï¼Œé‚£äº›å¤šä½™çš„ä»»åŠ¡å°†è¢«æ”¾åˆ°ä¸€ä¸ªé˜Ÿåˆ—ä¸­ã€‚ ä¸€æ—¦æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹æœ‰ç©ºé—²äº†ï¼Œå®ƒä»¬ä¼šä»é˜Ÿåˆ—ä¸­å–ä¸‹ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œã€‚JDK ä¸­çš„ Executorsä¸­ï¼Œ æ­¤ä»»åŠ¡é˜Ÿåˆ—æ˜¯æ²¡æœ‰é•¿åº¦é™åˆ¶çš„ã€‚
1.2 Executorçš„å®ç°å…³ç³»å›¾Executoræ¡†æ¶åŒ…æ‹¬3å¤§éƒ¨åˆ†ï¼š

ä»»åŠ¡ï¼šåŒ…æ‹¬è¢«æ‰§è¡Œçš„ä»»åŠ¡éœ€è¦å®ç°çš„æ¥å£ï¼šRunable æ¥å£ã€Callableæ¥å£ï¼›Runnable æ¥å£æˆ– Callable æ¥å£ å®ç°ç±»éƒ½å¯ä»¥è¢« ThreadPoolExecutor æˆ– ScheduledThreadPoolExecutor æ‰§è¡Œã€‚
ä»»åŠ¡çš„æ‰§è¡Œï¼šåŒ…æ‹¬ä»»åŠ¡æ‰§è¡Œæœºåˆ¶çš„æ ¸å¿ƒæ¥å£Executorï¼Œä»¥åŠç»§æ‰¿è‡ªExecutorçš„ExecutorServiceæ¥å£ã€‚Executoræ¡†æ¶æœ‰ä¸¤ä¸ªå…³é”®ç±»å®ç°äº†ExecutorServiceæ¥å£ï¼šThreadPoolExecutor å’Œ ScheduledThreadPoolExecutorã€ForkJoinPoolï¼›è¿™é‡Œæäº†å¾ˆå¤šåº•å±‚çš„ç±»å…³ç³»ï¼Œä½†æ˜¯ï¼Œå®é™…ä¸Šæˆ‘ä»¬éœ€è¦æ›´å¤šå…³æ³¨çš„æ˜¯ ThreadPoolExecutor è¿™ä¸ªç±»ï¼Œè¿™ä¸ªç±»åœ¨æˆ‘ä»¬å®é™…ä½¿ç”¨çº¿ç¨‹æ± çš„è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨é¢‘ç‡è¿˜æ˜¯éå¸¸é«˜çš„ã€‚
ä»»åŠ¡çš„å¼‚æ­¥è®¡ç®—ç»“æœï¼šåŒ…æ‹¬Futureæ¥å£å’Œå®ç°Futureæ¥å£çš„FutureTaskç±»ã€ForkJoinTaskç±»ï¼Œéƒ½å¯ä»¥ä»£è¡¨å¼‚æ­¥è®¡ç®—çš„ç»“æœã€‚å½“æˆ‘ä»¬æŠŠ Runnableæ¥å£ æˆ– Callable æ¥å£ çš„å®ç°ç±»æäº¤ç»™ ThreadPoolExecutor æˆ– ScheduledThreadPoolExecutor æ‰§è¡Œã€‚ï¼ˆè°ƒç”¨ submit() æ–¹æ³•æ—¶ä¼šè¿”å›ä¸€ä¸ª FutureTask å¯¹è±¡ï¼‰

Javaä¼˜ç§€æ¡†æ¶çš„è®¾è®¡æ€è·¯ï¼Œé¡¶çº§æ¥å£-æ¬¡çº§æ¥å£-è™šæ‹Ÿå®ç°ç±»-å®ç°ç±»ã€‚



å±æ€§
è¯´æ˜



Executor
æ‰§è¡Œè€…ï¼Œjavaçº¿ç¨‹æ± æ¡†æ¶çš„æœ€ä¸Šå±‚çˆ¶æ¥å£ï¼Œåœ°ä½ç±»ä¼¼äºspringçš„BeanFactryã€é›†åˆæ¡†æ¶çš„Collectionæ¥å£ï¼Œåœ¨Executorè¿™ä¸ªæ¥å£ä¸­åªæœ‰ä¸€ä¸ªexecuteæ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯å‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡å¹¶æ‰§è¡Œã€‚


ExecutorService
è¯¥æ¥å£ç»§æ‰¿è‡ªExecutoræ¥å£ï¼Œæ·»åŠ äº†shutdownã€shutdownAllã€submitã€invokeAllç­‰ä¸€ç³»åˆ—å¯¹çº¿ç¨‹çš„æ“ä½œæ–¹æ³•ï¼Œè¯¥æ¥å£æ¯”è¾ƒé‡è¦ï¼Œåœ¨ä½¿ç”¨çº¿ç¨‹æ± æ¡†æ¶çš„æ—¶å€™ï¼Œç»å¸¸ç”¨åˆ°è¯¥æ¥å£ã€‚


AbstractExecutorService
è¿™æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ç°ExecuotrServiceæ¥å£


ThreadPoolExecutor
è¿™æ˜¯Javaçº¿ç¨‹æ± æœ€æ ¸å¿ƒçš„ä¸€ä¸ªç±»ï¼Œè¯¥ç±»ç»§æ‰¿è‡ªAbstractExecutorServiceï¼Œä¸»è¦åŠŸèƒ½æ˜¯åˆ›å»ºçº¿ç¨‹æ± ï¼Œç»™ä»»åŠ¡åˆ†é…çº¿ç¨‹èµ„æºï¼Œæ‰§è¡Œä»»åŠ¡ã€‚


ScheduledExecutorSerivce
æä¾›äº†å¦ä¸€ç§çº¿ç¨‹æ± ï¼šå»¶è¿Ÿæ‰§è¡Œå’Œå‘¨æœŸæ€§æ‰§è¡Œçš„çº¿ç¨‹æ± ã€‚


ScheduledThreadPoolExecutor
æä¾›äº†å¦ä¸€ç§çº¿ç¨‹æ± ï¼šå»¶è¿Ÿæ‰§è¡Œå’Œå‘¨æœŸæ€§æ‰§è¡Œçš„çº¿ç¨‹æ± ã€‚


Executors
è¿™æ˜¯ä¸€ä¸ªé™æ€å·¥å‚ç±»ï¼Œè¯¥ç±»å®šä¹‰äº†ä¸€ç³»åˆ—é™æ€å·¥å‚æ–¹æ³•ï¼Œé€šè¿‡è¿™äº›å·¥å‚æ–¹æ³•å¯ä»¥è¿”å›å„ç§ä¸åŒçš„çº¿ç¨‹æ± ã€‚


1.3 ThreadPoolExecutor ç±»
çº¿ç¨‹æ± å®ç°ç±» ThreadPoolExecutor æ˜¯ Executor æ¡†æ¶æœ€æ ¸å¿ƒçš„ç±»ã€‚ThreadPoolExecutor ç±»ä¸­æä¾›çš„å››ä¸ªæ„é€ æ–¹æ³•ï¼Œç›´æ¥çœ‹å‚æ•°æœ€å¤šçš„æ„é€ æ–¹æ³•ï¼Œå…¶ä½™ä¸‰ä¸ªéƒ½æ˜¯åœ¨è¿™ä¸ªæ„é€ æ–¹æ³•çš„åŸºç¡€ä¸Šäº§ç”Ÿã€‚æºä»£ç å¦‚ä¸‹ï¼š

/** * Creates a new &#123;@code ThreadPoolExecutor&#125; with the given initial * parameters. * * @param corePoolSize the number of threads to keep in the pool, even *        if they are idle, unless &#123;@code allowCoreThreadTimeOut&#125; is set * @param maximumPoolSize the maximum number of threads to allow in the *        pool * @param keepAliveTime when the number of threads is greater than *        the core, this is the maximum time that excess idle threads *        will wait for new tasks before terminating. * @param unit the time unit for the &#123;@code keepAliveTime&#125; argument * @param workQueue the queue to use for holding tasks before they are *        executed.  This queue will hold only the &#123;@code Runnable&#125; *        tasks submitted by the &#123;@code execute&#125; method. * @param threadFactory the factory to use when the executor *        creates a new thread * @param handler the handler to use when execution is blocked *        because the thread bounds and queue capacities are reached * @throws IllegalArgumentException if one of the following holds:&lt;br&gt; *         &#123;@code corePoolSize &lt; 0&#125;&lt;br&gt; *         &#123;@code keepAliveTime &lt; 0&#125;&lt;br&gt; *         &#123;@code maximumPoolSize &lt;= 0&#125;&lt;br&gt; *         &#123;@code maximumPoolSize &lt; corePoolSize&#125; * @throws NullPointerException if &#123;@code workQueue&#125; *         or &#123;@code threadFactory&#125; or &#123;@code handler&#125; is null */public ThreadPoolExecutor(int corePoolSize,     // çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°é‡ï¼Œå³ä½¿ç©ºé—²æ—¶ä»ä¿ç•™åœ¨æ± ä¸­çš„çº¿ç¨‹æ•°ï¼Œé™¤éè®¾ç½® allowCoreThreadTimeOut                           int maximumPoolSize,  // æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°                           long keepAliveTime,   // å½“çº¿ç¨‹æ•°å¤§äºå†…æ ¸æ—¶ï¼Œè¿™æ˜¯å¤šä½™çš„ç©ºé—²çº¿ç¨‹åœ¨ç»ˆæ­¢å‰ç­‰å¾…æ–°ä»»åŠ¡çš„æœ€å¤§æ—¶é—´ã€‚                           TimeUnit unit,        // keepAliveTimeå‚æ•°çš„æ—¶é—´å•ä½                          BlockingQueue&lt;Runnable&gt; workQueue,    // ç”¨äºåœ¨æ‰§è¡Œä»»åŠ¡ä¹‹å‰ä½¿ç”¨çš„é˜Ÿåˆ—ã€‚ è¿™ä¸ªé˜Ÿåˆ—å°†ä»…ä¿å­˜executeæ–¹æ³•æäº¤çš„Runnableä»»åŠ¡ã€‚                           ThreadFactory threadFactory,  // çº¿ç¨‹å·¥å‚ï¼Œç”¨æ¥åˆ›å»ºçº¿ç¨‹ï¼Œä¸€èˆ¬é»˜è®¤å³å¯                          RejectedExecutionHandler handler // æ‹’ç»ç­–ç•¥ï¼Œå½“æäº¤çš„ä»»åŠ¡è¿‡å¤šè€Œä¸èƒ½åŠæ—¶å¤„ç†æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å®šåˆ¶ç­–ç•¥æ¥å¤„ç†ä»»åŠ¡                          ) &#123;    if (corePoolSize &lt; 0 ||        maximumPoolSize &lt;= 0 ||        maximumPoolSize &lt; corePoolSize ||        keepAliveTime &lt; 0)        throw new IllegalArgumentException();    if (workQueue == null || threadFactory == null || handler == null)        throw new NullPointerException();    this.acc = System.getSecurityManager() == null ?            null :            AccessController.getContext();    this.corePoolSize = corePoolSize;    this.maximumPoolSize = maximumPoolSize;    this.workQueue = workQueue;    this.keepAliveTime = unit.toNanos(keepAliveTime);    this.threadFactory = threadFactory;    this.handler = handler;&#125;



ä½¿ç”¨Executorsé£é™©ï¼š&emsp;&emsp;çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨Executorså»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ThreadPoolExecutorçš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼è®©å†™çš„åŒå­¦æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©ã€‚

ã€è¯´æ˜ã€‘ï¼šExecutorsè¿”å›çš„çº¿ç¨‹æ± å¯¹è±¡çš„å¼Šç«¯å¦‚ä¸‹ï¼š 

FixedThreadPoolå’ŒSingleThreadPoolï¼š å…è®¸çš„è¯·æ±‚é˜Ÿåˆ—é•¿åº¦ä¸ºInteger.MAX_VALUEï¼Œå¯èƒ½ä¼šå †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´OOMã€‚ 
CachedThreadPoolï¼š å…è®¸çš„åˆ›å»ºçº¿ç¨‹æ•°é‡ä¸ºInteger.MAX_VALUEï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´OOMã€‚æ‘˜è‡ªã€Šé˜¿é‡Œå·´å·´Javaå¼€å‘æ‰‹å†Œï¼ˆåå±±ç‰ˆï¼‰ã€‹

package com.yuanxw.chapter18;import java.util.Random;import java.util.concurrent.ArrayBlockingQueue;import java.util.concurrent.ThreadPoolExecutor;import java.util.concurrent.TimeUnit;public class ThreadPoolExecutorExample &#123;    // éšæœºæ•°ï¼šä½¿ç”¨longå‚æ•°çš„æ‰€æœ‰64ä½ä½œä¸ºå› å­å€¼ã€‚    private static Random random = new Random(System.currentTimeMillis());    public static void main(String[] args) throws InterruptedException &#123;        /**         * ThreadPoolExecutor æ„é€ å‡½æ•°åˆ›å»ºçº¿ç¨‹æ±          * int corePoolSize,     // çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°é‡ï¼Œå³ä½¿ç©ºé—²æ—¶ä»ä¿ç•™åœ¨æ± ä¸­çš„çº¿ç¨‹æ•°ï¼Œé™¤éè®¾ç½® allowCoreThreadTimeOutã€‚         * int maximumPoolSize,  // æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ã€‚         * long keepAliveTime,   // å½“çº¿ç¨‹æ•°å¤§äºå†…æ ¸æ—¶ï¼Œè¿™æ˜¯å¤šä½™çš„ç©ºé—²çº¿ç¨‹åœ¨ç»ˆæ­¢å‰ç­‰å¾…æ–°ä»»åŠ¡çš„æœ€å¤§æ—¶é—´ã€‚         * TimeUnit unit,        // keepAliveTimeå‚æ•°çš„æ—¶é—´å•ä½ã€‚         * BlockingQueue&lt;Runnable&gt; workQueue,    // ç”¨äºåœ¨æ‰§è¡Œä»»åŠ¡ä¹‹å‰ä½¿ç”¨çš„é˜Ÿåˆ—ã€‚ è¿™ä¸ªé˜Ÿåˆ—å°†ä»…ä¿å­˜executeæ–¹æ³•æäº¤çš„Runnableä»»åŠ¡ã€‚         * ThreadFactory threadFactory,  // çº¿ç¨‹å·¥å‚ï¼Œç”¨æ¥åˆ›å»ºçº¿ç¨‹ï¼Œä¸€èˆ¬é»˜è®¤å³å¯ã€‚         * RejectedExecutionHandler handler // æ‹’ç»ç­–ç•¥ï¼Œå½“æäº¤çš„ä»»åŠ¡è¿‡å¤šè€Œä¸èƒ½åŠæ—¶å¤„ç†æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å®šåˆ¶ç­–ç•¥æ¥å¤„ç†ä»»åŠ¡ã€‚         */        ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(1, 2, 30, TimeUnit.SECONDS, new ArrayBlockingQueue&lt;&gt;(1), r -&gt; new Thread(r), new ThreadPoolExecutor.AbortPolicy());        threadPoolExecutor.execute(() -&gt; processTask(random.nextInt(100)));        threadPoolExecutor.execute(() -&gt; processTask(random.nextInt(100)));        threadPoolExecutor.execute(() -&gt; processTask(random.nextInt(100)));        /**         * shutdown() VS shutdownNow()         * - shutdownï¼ˆï¼‰ :å…³é—­çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ± çš„çŠ¶æ€å˜ä¸º SHUTDOWNã€‚çº¿ç¨‹æ± ä¸å†æ¥å—æ–°ä»»åŠ¡äº†ï¼Œä½†æ˜¯é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡å¾—æ‰§è¡Œå®Œæ¯•ã€‚         * - shutdownNowï¼ˆï¼‰ :å…³é—­çº¿ç¨‹æ± ï¼Œçº¿ç¨‹çš„çŠ¶æ€å˜ä¸º STOPã€‚çº¿ç¨‹æ± ä¼šç»ˆæ­¢å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œå¹¶åœæ­¢å¤„ç†æ’é˜Ÿçš„ä»»åŠ¡å¹¶è¿”å›æ­£åœ¨ç­‰å¾…æ‰§è¡Œçš„ Listã€‚         */        threadPoolExecutor.shutdown();        int activeCount = -1;        int queueSize = -1;        while (true) &#123;            /**             * isTerminated() VS isShutdown()             * - isShutDown å½“è°ƒç”¨ shutdown() æ–¹æ³•åè¿”å›ä¸º trueã€‚             * - isTerminated å½“è°ƒç”¨ shutdown() æ–¹æ³•åï¼Œå¹¶ä¸”æ‰€æœ‰æäº¤çš„ä»»åŠ¡å®Œæˆåè¿”å›ä¸º trueã€‚             */            if(threadPoolExecutor.isTerminated())&#123;                break;            &#125;            if (activeCount != threadPoolExecutor.getActiveCount()                    || queueSize != threadPoolExecutor.getQueue().size()) &#123;                System.out.println(&quot;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š&quot; + threadPoolExecutor.getActiveCount());                System.out.println(&quot;æ ¸å¿ƒçº¿ç¨‹æ•°ï¼š&quot; + threadPoolExecutor.getCorePoolSize());                System.out.println(&quot;æ‰§è¡Œç¨‹åºä½¿ç”¨çš„ä»»åŠ¡é˜Ÿåˆ—å¤§å°ï¼š&quot; + threadPoolExecutor.getQueue().size());                System.out.println(&quot;å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ï¼š&quot; + threadPoolExecutor.getMaximumPoolSize());                activeCount = threadPoolExecutor.getActiveCount();                queueSize = threadPoolExecutor.getQueue().size();                System.out.println(&quot;--------------------------------------------&quot;);                TimeUnit.SECONDS.sleep(1);            &#125;        &#125;    &#125;    /**     * çº¿ç¨‹ä¼‘çœ çš„æ–¹æ³•     *     * @param seconds     */    private static void processTask(long seconds) &#123;        try &#123;            System.out.println(String.format(&quot;&gt;&gt;&gt;&gt;&gt;ã€%sã€‘çº¿ç¨‹æ­£åœ¨å¤„ç†ä»»åŠ¡&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;, Thread.currentThread().getName()));            TimeUnit.SECONDS.sleep(1);        &#125; catch (InterruptedException e) &#123;            e.printStackTrace();        &#125;    &#125;&#125;
æ‰§è¡Œç»“æœï¼š
è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š2æ ¸å¿ƒçº¿ç¨‹æ•°ï¼š1æ‰§è¡Œç¨‹åºä½¿ç”¨çš„ä»»åŠ¡é˜Ÿåˆ—å¤§å°ï¼š1å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ï¼š2--------------------------------------------&gt;&gt;&gt;&gt;&gt;ã€Thread-0ã€‘çº¿ç¨‹æ­£åœ¨å¤„ç†ä»»åŠ¡&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;ã€Thread-1ã€‘çº¿ç¨‹æ­£åœ¨å¤„ç†ä»»åŠ¡&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š1&gt;&gt;&gt;&gt;&gt;ã€Thread-0ã€‘çº¿ç¨‹æ­£åœ¨å¤„ç†ä»»åŠ¡&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;æ ¸å¿ƒçº¿ç¨‹æ•°ï¼š1æ‰§è¡Œç¨‹åºä½¿ç”¨çš„ä»»åŠ¡é˜Ÿåˆ—å¤§å°ï¼š0å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ï¼š2--------------------------------------------è·å¾—æ´»åŠ¨çš„çº¿ç¨‹è¯„ä¼°æ•°ï¼š0æ ¸å¿ƒçº¿ç¨‹æ•°ï¼š1æ‰§è¡Œç¨‹åºä½¿ç”¨çš„ä»»åŠ¡é˜Ÿåˆ—å¤§å°ï¼š0å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ï¼š2--------------------------------------------

1.4 ThreadPoolExecutorçº¿ç¨‹æ± åŸç†åˆ†æ&emsp;&emsp;ä¸ºäº†ææ‡‚çº¿ç¨‹æ± çš„åŸç†ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆåˆ†æä¸€ä¸‹ executeæ–¹æ³•ã€‚threadPoolExecutor.execute()ï¼Œæ¥æäº¤ä¸€ä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± ä¸­å»ï¼Œè¿™ä¸ªæ–¹æ³•éå¸¸é‡è¦ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„æºç ï¼š
// å­˜æ”¾çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ (runState) å’Œçº¿ç¨‹æ± å†…æœ‰æ•ˆçº¿ç¨‹çš„æ•°é‡ (workerCount)private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));// Packing and unpacking ctlprivate static int runStateOf(int c)     &#123; return c &amp; ~CAPACITY; &#125;private static int workerCountOf(int c)  &#123; return c &amp; CAPACITY; &#125;private static int ctlOf(int rs, int wc) &#123; return rs | wc; &#125;/** * The queue used for holding tasks and handing off to worker * threads.  We do not require that workQueue.poll() returning * null necessarily means that workQueue.isEmpty(), so rely * solely on isEmpty to see if the queue is empty (which we must * do for example when deciding whether to transition from * SHUTDOWN to TIDYING).  This accommodates special-purpose * queues such as DelayQueues for which poll() is allowed to * return null even if it may later return non-null when delays * expire. */private final BlockingQueue&lt;Runnable&gt; workQueue;/** * Executes the given task sometime in the future.  The task * may execute in a new thread or in an existing pooled thread. * * If the task cannot be submitted for execution, either because this * executor has been shutdown or because its capacity has been reached, * the task is handled by the current &#123;@code RejectedExecutionHandler&#125;. * * @param command the task to execute * @throws RejectedExecutionException at discretion of *         &#123;@code RejectedExecutionHandler&#125;, if the task *         cannot be accepted for execution * @throws NullPointerException if &#123;@code command&#125; is null */public void execute(Runnable command) &#123;    // å¦‚æœä»»åŠ¡ä¸ºnullï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚    if (command == null)        throw new NullPointerException();    /*     * Proceed in 3 steps:     *     * 1. If fewer than corePoolSize threads are running, try to     * start a new thread with the given command as its first     * task.  The call to addWorker atomically checks runState and     * workerCount, and so prevents false alarms that would add     * threads when it shouldn&#x27;t, by returning false.     *     * 2. If a task can be successfully queued, then we still need     * to double-check whether we should have added a thread     * (because existing ones died since last checking) or that     * the pool shut down since entry into this method. So we     * recheck state and if necessary roll back the enqueuing if     * stopped, or start a new thread if there are none.     *     * 3. If we cannot queue task, then we try to add a new     * thread.  If it fails, we know we are shut down or saturated     * and so reject the task.     */     // ctl ä¸­ä¿å­˜çš„çº¿ç¨‹æ± å½“å‰çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯    int c = ctl.get();    // ä¸‹é¢ä¼šæ¶‰åŠåˆ° 3 æ­¥ æ“ä½œ    // 1.é¦–å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ± ä¸­æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡æ˜¯å¦å°äº corePoolSize    // å¦‚æœå°äºçš„è¯ï¼Œé€šè¿‡addWorker(command, true)æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶å°†ä»»åŠ¡(command)æ·»åŠ åˆ°è¯¥çº¿ç¨‹ä¸­ï¼›ç„¶åï¼Œå¯åŠ¨è¯¥çº¿ç¨‹ä»è€Œæ‰§è¡Œä»»åŠ¡    if (workerCountOf(c) &lt; corePoolSize) &#123;        if (addWorker(command, true))            return;        c = ctl.get();    &#125;    // 2.å¦‚æœå½“å‰æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡å¤§äºç­‰äº corePoolSize çš„æ—¶å€™å°±ä¼šèµ°åˆ°è¿™é‡Œ    // é€šè¿‡ isRunning æ–¹æ³•åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€ï¼Œçº¿ç¨‹æ± å¤„äº RUNNING çŠ¶æ€æ‰ä¼šè¢«å¹¶ä¸”é˜Ÿåˆ—å¯ä»¥åŠ å…¥ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡æ‰ä¼šè¢«åŠ å…¥è¿›å»    if (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;        // å†æ¬¡è·å–çº¿ç¨‹æ± çŠ¶æ€ï¼Œå¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸æ˜¯ RUNNING çŠ¶æ€å°±éœ€è¦ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­ç§»é™¤ä»»åŠ¡ï¼Œå¹¶å°è¯•åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ã€‚åŒæ—¶æ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚        int recheck = ctl.get();        if (! isRunning(recheck) &amp;&amp; remove(command))            reject(command);        // å¦‚æœå½“å‰çº¿ç¨‹æ± ä¸ºç©ºå°±æ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¹¶æ‰§è¡Œã€‚        else if (workerCountOf(recheck) == 0)            addWorker(null, false);    &#125;    // 3. é€šè¿‡addWorker(command, false)æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶å°†ä»»åŠ¡(command)æ·»åŠ åˆ°è¯¥çº¿ç¨‹ä¸­ï¼›ç„¶åï¼Œå¯åŠ¨è¯¥çº¿ç¨‹ä»è€Œæ‰§è¡Œä»»åŠ¡ã€‚    // å¦‚æœaddWorker(command, false)æ‰§è¡Œå¤±è´¥ï¼Œåˆ™é€šè¿‡reject()æ‰§è¡Œç›¸åº”çš„æ‹’ç»ç­–ç•¥çš„å†…å®¹ã€‚    else if (!addWorker(command, false))        reject(command);&#125;
&emsp;&emsp;æ‰§è¡ŒthreadPoolExecutor.execute()æ–¹æ³•ï¼Œæäº¤ä»»åŠ¡æ•ˆæœå›¾ï¼Œé€šè¿‡ä¸‹å›¾å¯ä»¥æ›´å¥½çš„å¯¹ä¸Šé¢è¿™ 3 æ­¥åšä¸€ä¸ªå±•ç¤ºï¼š

1.5 ThreadPoolExecutoræ‹’ç»ç­–ç•¥&emsp;&emsp;å¦‚æœå½“å‰åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°é‡å¹¶ä¸”é˜Ÿåˆ—ä¹Ÿå·²ç»è¢«æ”¾æ»¡äº†ä»»æ—¶ï¼ŒThreadPoolTaskExecutor å®šä¹‰ä¸€äº›ç­–ç•¥:

ThreadPoolExecutor.AbortPolicyï¼šï¼ˆé»˜è®¤ç­–ç•¥ï¼‰æŠ›å‡º RejectedExecutionExceptionå¼‚å¸¸æ¥æ‹’ç»æ–°æ¥çš„ä»»åŠ¡ ï¼Œè¿™ä»£è¡¨ä½ å°†ä¸¢å¤±å¯¹è¿™ä¸ªä»»åŠ¡çš„å¤„ç†ã€‚
ThreadPoolExecutor.CallerRunsPolicyï¼šï¼ˆå»ºè®®ä½¿ç”¨ï¼‰è°ƒç”¨æ‰§è¡Œè‡ªå·±çš„çº¿ç¨‹è¿è¡Œä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥åœ¨è°ƒç”¨executeæ–¹æ³•çš„çº¿ç¨‹ä¸­è¿è¡Œ(run)è¢«æ‹’ç»çš„ä»»åŠ¡ï¼Œå¦‚æœæ‰§è¡Œç¨‹åºå·²å…³é—­ï¼Œåˆ™ä¼šä¸¢å¼ƒè¯¥ä»»åŠ¡ã€‚å› æ­¤è¿™ç§ç­–ç•¥ä¼šé™ä½å¯¹äºæ–°ä»»åŠ¡æäº¤é€Ÿåº¦ï¼Œå½±å“ç¨‹åºçš„æ•´ä½“æ€§èƒ½ã€‚å¦å¤–ï¼Œè¿™ä¸ªç­–ç•¥å½“æœ€å¤§æ± è¢«å¡«æ»¡æ—¶ï¼Œæ­¤ç­–ç•¥ä¸ºæˆ‘ä»¬æä¾›å¯ä¼¸ç¼©é˜Ÿåˆ—ã€‚å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºå¯ä»¥æ‰¿å—æ­¤å»¶è¿Ÿå¹¶ä¸”ä½ ä¸èƒ½ä»»åŠ¡ä¸¢å¼ƒä»»ä½•ä¸€ä¸ªä»»åŠ¡è¯·æ±‚çš„è¯ï¼Œä½ å¯ä»¥é€‰æ‹©è¿™ä¸ªç­–ç•¥ã€‚
ThreadPoolExecutor.DiscardPolicyï¼š ä¸å¤„ç†æ–°ä»»åŠ¡ï¼Œç›´æ¥ä¸¢å¼ƒæ‰ã€‚
ThreadPoolExecutor.DiscardOldestPolicyï¼š æ­¤ç­–ç•¥å°†ä¸¢å¼ƒæœ€æ—©çš„æœªå¤„ç†çš„ä»»åŠ¡è¯·æ±‚ã€‚

 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(åå…«)Javaå¤šçº¿ç¨‹ä¹‹Executoræ¡†æ¶&amp;ThreadPoolExecutorç±»ã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(åå…­)Javaå¤šçº¿ç¨‹ä¹‹Conditionå¯¹è±¡</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E5%8D%81%E5%85%AD)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BCondition/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(åå…­)Javaå¤šçº¿ç¨‹ä¹‹Conditionå¯¹è±¡1.1 ä»€ä¹ˆæ˜¯Conditionï¼Ÿ&emsp;&emsp; Conditionæ˜¯åœ¨java 1.5ä¸­æ‰å‡ºç°çš„ï¼Œå®ƒç”¨æ¥æ›¿ä»£ä¼ ç»Ÿçš„Objectçš„wait()ã€notify()å®ç°çº¿ç¨‹é—´çš„åä½œï¼Œç›¸æ¯”ä½¿ç”¨Objectçš„wait()ã€notify()ï¼Œä½¿ç”¨Conditionçš„await()ã€signal()è¿™ç§æ–¹å¼å®ç°çº¿ç¨‹é—´åä½œæ›´åŠ å®‰å…¨å’Œé«˜æ•ˆã€‚å› æ­¤é€šå¸¸æ¥è¯´æ¯”è¾ƒæ¨èä½¿ç”¨Conditionï¼Œé˜»å¡é˜Ÿåˆ—å®é™…ä¸Šæ˜¯ä½¿ç”¨äº†Conditionæ¥æ¨¡æ‹Ÿçº¿ç¨‹é—´åä½œã€‚
&emsp;&emsp; æˆ‘ä»¬ä½¿ç”¨synchronizedæ¥æ§åˆ¶åŒæ­¥ï¼Œé…åˆObjectçš„wait()ã€notify()ç³»åˆ—æ–¹æ³•å¯ä»¥å®ç°ç­‰å¾…&#x2F;é€šçŸ¥æ¨¡å¼ã€‚åœ¨Java SE5åï¼ŒJavaæä¾›äº†Lockæ¥å£ï¼Œç›¸å¯¹äºSynchronizedè€Œè¨€ï¼ŒLockæä¾›äº†æ¡ä»¶Conditionï¼Œå¯¹çº¿ç¨‹çš„ç­‰å¾…ã€å”¤é†’æ“ä½œæ›´åŠ è¯¦ç»†å’Œçµæ´»ã€‚ä¸‹å›¾æ˜¯Conditionä¸Objectçš„ç›‘è§†å™¨æ–¹æ³•çš„å¯¹æ¯”ï¼ˆæ‘˜è‡ªã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹ï¼‰
1.2 Conditionä½¿ç”¨æ ·ä¾‹package com.yuanxw.chapter16;import java.util.Arrays;import java.util.concurrent.TimeUnit;import java.util.concurrent.locks.Condition;import java.util.concurrent.locks.ReentrantLock;public class ConditionExample &#123;    // å®šä¹‰ã€é‡å…¥é”ã€‘éå…¬å¹³é”    private static final ReentrantLock REENTRANT_LOCK = new ReentrantLock();    // è·å¾—Conditionå®ä¾‹    private static final Condition CONDITION = REENTRANT_LOCK.newCondition();    // volatile:å†…å­˜å¯è§æ€§å…³é”®å­—ï¼Œé»˜è®¤ä¸ºæ²¡æœ‰ç”Ÿäº§ï¼Œå¯ä»¥è¿›è¡Œç”Ÿäº§    private static volatile boolean isProducted = false;    // ç”Ÿäº§æ•°é‡    private static int num = 0;    /**     * ç”Ÿäº§æ–¹æ³•     */    public static void produce() &#123;        try &#123;            // åŠ é”            REENTRANT_LOCK.lock();            while (isProducted) &#123;                CONDITION.await();            &#125;            // ç”Ÿäº§æ¶ˆæ¯æ•°é‡ + 1            num++;            // è®¾ç½®ä¸ºå·²ç»ç”Ÿäº§æ¶ˆæ¯            isProducted = true;            // é€šçŸ¥æ¶ˆè´¹è€…ï¼Œå¯ä»¥è¿›è¡Œæ¶ˆè´¹            CONDITION.signalAll();            System.out.println(String.format(&quot;çº¿ç¨‹ã€%sã€‘ï¼Œç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€%sã€‘&quot;, Thread.currentThread().getName(), num));        &#125; catch (InterruptedException e) &#123;            e.printStackTrace();        &#125; finally &#123;            // è§£é”            REENTRANT_LOCK.unlock();        &#125;    &#125;    /**     * æ¶ˆæ¯æ–¹æ³•     */    public static void consumer() &#123;        // åŠ é”        try &#123;            REENTRANT_LOCK.lock();            // å¦‚æœå·²ç»ç”Ÿäº§ï¼Œé‚£ä¹ˆæ¶ˆè´¹è€…æ¶ˆè´¹            while (!isProducted) &#123;                CONDITION.await();            &#125;            System.out.println(String.format(&quot;çº¿ç¨‹ã€%sã€‘ï¼Œæ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€%sã€‘&quot;, Thread.currentThread().getName(), num));            // è®¾ç½®æ ‡è®°ï¼šæœªç”Ÿäº§            isProducted = false;            // é€šçŸ¥ç”Ÿäº§è€…å·²ç»æ¶ˆè´¹            CONDITION.signalAll();        &#125; catch (InterruptedException e) &#123;            e.printStackTrace();        &#125; finally &#123;            REENTRANT_LOCK.unlock();        &#125;    &#125;    public static void main(String[] args) &#123;        // åˆ›å»ºä¸¤ä¸ªç”Ÿäº§è€…çº¿ç¨‹åˆ†åˆ«ä¸ºï¼šProduce1ã€Produce2        Arrays.asList(&quot;Produce1&quot;, &quot;Produce2&quot;).forEach(produceName -&gt; &#123;            new Thread(() -&gt; &#123;                while (true) &#123;                    ConditionExample.produce();                    try &#123;                        TimeUnit.SECONDS.sleep(1);                    &#125; catch (InterruptedException e) &#123;                        e.printStackTrace();                    &#125;                &#125;            &#125;,produceName).start();        &#125;);        // åˆ›å»ºä¸‰ä¸ªç”Ÿäº§è€…çº¿ç¨‹åˆ†åˆ«ä¸ºï¼šConsumer1ã€Consumer2ã€Consumer3        Arrays.asList(&quot;Consumer1&quot;, &quot;Consumer2&quot;, &quot;Consumer3&quot;).forEach(consumerName -&gt; &#123;            new Thread(() -&gt; &#123;                while (true) &#123;                    ConditionExample.consumer();                    try &#123;                        TimeUnit.SECONDS.sleep(1);                    &#125; catch (InterruptedException e) &#123;                        e.printStackTrace();                    &#125;                &#125;            &#125;,consumerName).start();        &#125;);    &#125;&#125;
æ‰§è¡Œç»“æœï¼š
çº¿ç¨‹ã€Produce1ã€‘ï¼Œç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€1ã€‘çº¿ç¨‹ã€Consumer1ã€‘ï¼Œæ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€1ã€‘çº¿ç¨‹ã€Produce2ã€‘ï¼Œç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€2ã€‘çº¿ç¨‹ã€Consumer2ã€‘ï¼Œæ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€2ã€‘çº¿ç¨‹ã€Produce1ã€‘ï¼Œç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€3ã€‘çº¿ç¨‹ã€Consumer3ã€‘ï¼Œæ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€3ã€‘çº¿ç¨‹ã€Produce2ã€‘ï¼Œç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€4ã€‘çº¿ç¨‹ã€Consumer1ã€‘ï¼Œæ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€4ã€‘çº¿ç¨‹ã€Produce1ã€‘ï¼Œç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€5ã€‘çº¿ç¨‹ã€Consumer2ã€‘ï¼Œæ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€5ã€‘çº¿ç¨‹ã€Produce2ã€‘ï¼Œç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€6ã€‘çº¿ç¨‹ã€Consumer1ã€‘ï¼Œæ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€6ã€‘çº¿ç¨‹ã€Produce1ã€‘ï¼Œç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€7ã€‘çº¿ç¨‹ã€Consumer3ã€‘ï¼Œæ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€7ã€‘çº¿ç¨‹ã€Produce2ã€‘ï¼Œç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€8ã€‘çº¿ç¨‹ã€Consumer1ã€‘ï¼Œæ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€8ã€‘çº¿ç¨‹ã€Produce2ã€‘ï¼Œç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€9ã€‘çº¿ç¨‹ã€Consumer2ã€‘ï¼Œæ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€9ã€‘çº¿ç¨‹ã€Produce1ã€‘ï¼Œç”Ÿäº§æ¶ˆæ¯&gt;&gt;ã€10ã€‘çº¿ç¨‹ã€Consumer1ã€‘ï¼Œæ¶ˆè´¹æ¶ˆæ¯&lt;&lt;&lt;&lt;ã€10ã€‘

 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(åå…­)Javaå¤šçº¿ç¨‹ä¹‹Conditionå¯¹è±¡ã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(åå››)Javaå¤šçº¿ç¨‹ä¹‹Semaphoreä¿¡å·é‡</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E5%8D%81%E5%9B%9B)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BSemaphore%E4%BF%A1%E5%8F%B7%E9%87%8F/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(åå››)Javaå¤šçº¿ç¨‹ä¹‹Semaphoreä¿¡å·é‡&emsp;&emsp; Semaphoreï¼ˆä¿¡å·é‡ï¼‰æ˜¯ç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°é‡ï¼Œå®ƒé€šè¿‡åè°ƒå„ä¸ªçº¿ç¨‹ï¼Œä»¥ä¿è¯åˆç†çš„ä½¿ç”¨å…¬å…±èµ„æºã€‚æŠŠå®ƒæ¯”ä½œæ˜¯æ§åˆ¶æµé‡çš„çº¢ç»¿ç¯ï¼Œæ¯”å¦‚ä¸€æ¡é©¬è·¯è¦é™åˆ¶æµé‡ï¼Œåªå…è®¸åŒæ—¶æœ‰ä¸€ç™¾è¾†è½¦åœ¨è¿™æ¡è·¯ä¸Šè¡Œä½¿ï¼Œå…¶ä»–çš„éƒ½å¿…é¡»åœ¨è·¯å£ç­‰å¾…ï¼Œæ‰€ä»¥å‰ä¸€ç™¾è¾†è½¦ä¼šçœ‹åˆ°ç»¿ç¯ï¼Œå¯ä»¥å¼€è¿›è¿™æ¡é©¬è·¯ï¼Œåé¢çš„è½¦ä¼šçœ‹åˆ°çº¢ç¯ï¼Œä¸èƒ½é©¶å…¥é©¬è·¯ï¼Œä½†æ˜¯å¦‚æœå‰ä¸€ç™¾è¾†ä¸­æœ‰äº”è¾†è½¦å·²ç»ç¦»å¼€äº†é©¬è·¯ï¼Œé‚£ä¹ˆåé¢å°±å…è®¸æœ‰5è¾†è½¦é©¶å…¥é©¬è·¯ï¼Œè¿™ä¸ªä¾‹å­é‡Œè¯´çš„è½¦å°±æ˜¯çº¿ç¨‹ï¼Œé©¶å…¥é©¬è·¯å°±è¡¨ç¤ºçº¿ç¨‹åœ¨æ‰§è¡Œï¼Œç¦»å¼€é©¬è·¯å°±è¡¨ç¤ºçº¿ç¨‹æ‰§è¡Œå®Œæˆï¼Œçœ‹è§çº¢ç¯å°±è¡¨ç¤ºçº¿ç¨‹è¢«é˜»å¡ï¼Œä¸èƒ½æ‰§è¡Œã€‚
1.1 Semaphore(ä¿¡å·é‡)-å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®&emsp;&emsp; æ‰§è¡Œ acquire æ–¹æ³•é˜»å¡ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªè®¸å¯è¯å¯ä»¥è·å¾—ç„¶åæ‹¿èµ°ä¸€ä¸ªè®¸å¯è¯ï¼›æ¯ä¸ª release æ–¹æ³•å¢åŠ ä¸€ä¸ªè®¸å¯è¯ï¼Œè¿™å¯èƒ½ä¼šé‡Šæ”¾ä¸€ä¸ªé˜»å¡çš„ acquire æ–¹æ³•ã€‚ç„¶è€Œï¼Œå…¶å®å¹¶æ²¡æœ‰å®é™…çš„è®¸å¯è¯è¿™ä¸ªå¯¹è±¡ï¼ŒSemaphore åªæ˜¯ç»´æŒäº†ä¸€ä¸ªå¯è·å¾—è®¸å¯è¯çš„æ•°é‡ã€‚ Semaphore ç»å¸¸ç”¨äºé™åˆ¶è·å–æŸç§èµ„æºçš„çº¿ç¨‹æ•°é‡ã€‚
&emsp;&emsp; ä»¥ä¸‹ä»£ç æ¨¡æ‹Ÿäº†å¯¹æŸä¸ªæœåŠ¡çš„å¹¶å‘è¯·æ±‚ï¼Œæ¯æ¬¡åªèƒ½æœ‰ 3 ä¸ªå®¢æˆ·ç«¯åŒæ—¶è®¿é—®ï¼Œè¯·æ±‚æ€»æ•°ä¸º 10ï¼Œä»£ç å¦‚ä¸‹ï¼š
package com.yuanxw.chapter14;import java.util.Random;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.Semaphore;import java.util.concurrent.TimeUnit;import java.util.stream.IntStream;public class SemaphoreExample &#123;    /** éšæœºæ•°ï¼šä½¿ç”¨longå‚æ•°çš„æ‰€æœ‰64ä½ä½œä¸ºå› å­å€¼ã€‚ **/    private static Random random = new Random(System.currentTimeMillis());    /** æ€»çº¿ç¨‹æ•° **/    private static final int TOTAL_THREAD_NUMBER = 10;    /** å…è®¸æ‰§è¡Œçš„çº¿ç¨‹æ•° **/    final static int ACQUIRE_THREAD_NUMBER = 3;    public static void main(String[] args) throws InterruptedException &#123;        Semaphore semaphore = new Semaphore(ACQUIRE_THREAD_NUMBER);        ExecutorService executorService = Executors.newFixedThreadPool(TOTAL_THREAD_NUMBER);        IntStream.range(0,TOTAL_THREAD_NUMBER).forEach(i -&gt; &#123;            executorService.execute(()-&gt;&#123;                try &#123;                    System.out.println(String.format(&quot;çº¿ç¨‹ã€%sã€‘&gt;&gt;&gt;&gt;å‡†å¤‡å·¥ä½œ&quot;, Thread.currentThread().getName()));                    semaphore.acquire();                    System.out.println(String.format(&quot;çº¿ç¨‹ã€%sã€‘å·¥ä½œ===&gt;å¼€å§‹&quot;, Thread.currentThread().getName()));                    TimeUnit.SECONDS.sleep(random.nextInt(5));                    System.out.println(String.format(&quot;çº¿ç¨‹ã€%sã€‘å·¥ä½œ&lt;====ç»“æŸ&quot;, Thread.currentThread().getName()));                &#125; catch (InterruptedException e) &#123;                    e.printStackTrace();                &#125;finally &#123;                    semaphore.release();                &#125;            &#125;);        &#125;);        executorService.shutdown();        // mainçº¿ç¨‹ç›‘æ§ä¿¡å·é‡ä¸­è®¸å¯æ•°å˜åŒ–        while (true) &#123;            if(executorService.isTerminated())&#123;break;&#125;            System.out.println(&quot;ä¿¡å·é‡ä¸­å½“å‰å¯ç”¨çš„è®¸å¯æ•°ï¼š&quot; + semaphore.availablePermits());            System.out.println(&quot;ç­‰å¾…è·å–çš„çº¿ç¨‹æ•°:&quot; + semaphore.getQueueLength());            TimeUnit.SECONDS.sleep(1);        &#125;    &#125;&#125;

æ‰§è¡Œç»“æœï¼š
ä¿¡å·é‡ä¸­å½“å‰å¯ç”¨çš„è®¸å¯æ•°ï¼š3ç­‰å¾…è·å–çš„çº¿ç¨‹æ•°:0çº¿ç¨‹ã€pool-1-thread-6ã€‘&gt;&gt;&gt;&gt;å‡†å¤‡å·¥ä½œçº¿ç¨‹ã€pool-1-thread-5ã€‘&gt;&gt;&gt;&gt;å‡†å¤‡å·¥ä½œçº¿ç¨‹ã€pool-1-thread-7ã€‘&gt;&gt;&gt;&gt;å‡†å¤‡å·¥ä½œçº¿ç¨‹ã€pool-1-thread-1ã€‘&gt;&gt;&gt;&gt;å‡†å¤‡å·¥ä½œçº¿ç¨‹ã€pool-1-thread-3ã€‘&gt;&gt;&gt;&gt;å‡†å¤‡å·¥ä½œçº¿ç¨‹ã€pool-1-thread-8ã€‘&gt;&gt;&gt;&gt;å‡†å¤‡å·¥ä½œçº¿ç¨‹ã€pool-1-thread-7ã€‘å·¥ä½œ===&gt;å¼€å§‹çº¿ç¨‹ã€pool-1-thread-5ã€‘å·¥ä½œ===&gt;å¼€å§‹çº¿ç¨‹ã€pool-1-thread-6ã€‘å·¥ä½œ===&gt;å¼€å§‹çº¿ç¨‹ã€pool-1-thread-2ã€‘&gt;&gt;&gt;&gt;å‡†å¤‡å·¥ä½œçº¿ç¨‹ã€pool-1-thread-4ã€‘&gt;&gt;&gt;&gt;å‡†å¤‡å·¥ä½œçº¿ç¨‹ã€pool-1-thread-9ã€‘&gt;&gt;&gt;&gt;å‡†å¤‡å·¥ä½œçº¿ç¨‹ã€pool-1-thread-10ã€‘&gt;&gt;&gt;&gt;å‡†å¤‡å·¥ä½œä¿¡å·é‡ä¸­å½“å‰å¯ç”¨çš„è®¸å¯æ•°ï¼š0ç­‰å¾…è·å–çš„çº¿ç¨‹æ•°:7ä¿¡å·é‡ä¸­å½“å‰å¯ç”¨çš„è®¸å¯æ•°ï¼š0ç­‰å¾…è·å–çš„çº¿ç¨‹æ•°:7çº¿ç¨‹ã€pool-1-thread-5ã€‘å·¥ä½œ&lt;====ç»“æŸçº¿ç¨‹ã€pool-1-thread-6ã€‘å·¥ä½œ&lt;====ç»“æŸçº¿ç¨‹ã€pool-1-thread-7ã€‘å·¥ä½œ&lt;====ç»“æŸçº¿ç¨‹ã€pool-1-thread-3ã€‘å·¥ä½œ===&gt;å¼€å§‹çº¿ç¨‹ã€pool-1-thread-1ã€‘å·¥ä½œ===&gt;å¼€å§‹çº¿ç¨‹ã€pool-1-thread-8ã€‘å·¥ä½œ===&gt;å¼€å§‹ä¿¡å·é‡ä¸­å½“å‰å¯ç”¨çš„è®¸å¯æ•°ï¼š0ç­‰å¾…è·å–çš„çº¿ç¨‹æ•°:4ä¿¡å·é‡ä¸­å½“å‰å¯ç”¨çš„è®¸å¯æ•°ï¼š0ç­‰å¾…è·å–çš„çº¿ç¨‹æ•°:4çº¿ç¨‹ã€pool-1-thread-8ã€‘å·¥ä½œ&lt;====ç»“æŸçº¿ç¨‹ã€pool-1-thread-1ã€‘å·¥ä½œ&lt;====ç»“æŸçº¿ç¨‹ã€pool-1-thread-3ã€‘å·¥ä½œ&lt;====ç»“æŸçº¿ç¨‹ã€pool-1-thread-2ã€‘å·¥ä½œ===&gt;å¼€å§‹çº¿ç¨‹ã€pool-1-thread-4ã€‘å·¥ä½œ===&gt;å¼€å§‹çº¿ç¨‹ã€pool-1-thread-9ã€‘å·¥ä½œ===&gt;å¼€å§‹ä¿¡å·é‡ä¸­å½“å‰å¯ç”¨çš„è®¸å¯æ•°ï¼š0ç­‰å¾…è·å–çš„çº¿ç¨‹æ•°:1ä¿¡å·é‡ä¸­å½“å‰å¯ç”¨çš„è®¸å¯æ•°ï¼š0ç­‰å¾…è·å–çš„çº¿ç¨‹æ•°:1çº¿ç¨‹ã€pool-1-thread-4ã€‘å·¥ä½œ&lt;====ç»“æŸçº¿ç¨‹ã€pool-1-thread-2ã€‘å·¥ä½œ&lt;====ç»“æŸçº¿ç¨‹ã€pool-1-thread-9ã€‘å·¥ä½œ&lt;====ç»“æŸçº¿ç¨‹ã€pool-1-thread-10ã€‘å·¥ä½œ===&gt;å¼€å§‹ä¿¡å·é‡ä¸­å½“å‰å¯ç”¨çš„è®¸å¯æ•°ï¼š2ç­‰å¾…è·å–çš„çº¿ç¨‹æ•°:0ä¿¡å·é‡ä¸­å½“å‰å¯ç”¨çš„è®¸å¯æ•°ï¼š2ç­‰å¾…è·å–çš„çº¿ç¨‹æ•°:0çº¿ç¨‹ã€pool-1-thread-10ã€‘å·¥ä½œ&lt;====ç»“æŸ
1.3 Semaphore(ä¿¡å·é‡)-æ„é€ Locké”Semaphoreç±»å…¶å®å°±æ˜¯synchronizedå…³é”®å­—çš„å‡çº§ç‰ˆï¼Œè¿™ä¸ªç±»ä¸»è¦ä½œç”¨å°±æ˜¯æ§åˆ¶çº¿ç¨‹å¹¶å‘çš„æ•°é‡ã€‚å½“æˆ‘ä»¬æŠŠè®¸å¯çš„æ•°é‡è®¾ç½®ä¸º1æ—¶ï¼Œå°±å˜æˆäº†åŒæ­¥é”.
package com.yuanxw.chapter14;import java.util.Random;import java.util.concurrent.Semaphore;import java.util.concurrent.TimeUnit;import java.util.stream.IntStream;/** * ä¿¡å·é‡é” */public class SemaphoreExampleV2 &#123;    /**     * éšæœºæ•°ï¼šä½¿ç”¨longå‚æ•°çš„æ‰€æœ‰64ä½ä½œä¸ºå› å­å€¼ã€‚     **/    private static Random random = new Random(System.currentTimeMillis());    public static void main(String[] args) &#123;        final SemaphoreLock semaphoreLock = new SemaphoreLock();        IntStream.range(0, 5).forEach(i -&gt; &#123;            new Thread(() -&gt; &#123;                try &#123;                    System.out.println(String.format(&quot;çº¿ç¨‹ã€%sã€‘å·²ç»å¼€å§‹å·¥ä½œ&quot;, Thread.currentThread().getName()));                    semaphoreLock.lock();                    System.out.println(String.format(&quot;çº¿ç¨‹ã€%sã€‘è·å¾—é”&quot;, Thread.currentThread().getName()));                    TimeUnit.SECONDS.sleep(random.nextInt(5));                    System.out.println(String.format(&quot;çº¿ç¨‹ã€%sã€‘å·²ç»é‡Šæ”¾é”&quot;, Thread.currentThread().getName()));                &#125; catch (InterruptedException e) &#123;                    e.printStackTrace();                &#125;finally &#123;                    semaphoreLock.unLock();                &#125;            &#125;).start();        &#125;);    &#125;    static class SemaphoreLock &#123;        /**         * åœ¨JDK1.8ï¼Œéœ€è¦åŠ ä¸Švolatileå…³é”®å­—         * æ„é€ ä¸€ä¸ª Semaphoreä¸ç»™åªæœ‰ä¸€ä¸ªæ•°é‡çš„è®¸å¯è¯         **/        private volatile static  Semaphore semaphore = new Semaphore(1);        /**         * åŠ é”æ–¹æ³•         *         * @throws InterruptedException         */        public void lock() throws InterruptedException &#123;            semaphore.acquire(1);        &#125;        /**         * è§£é”æ–¹æ³•         */        public void unLock() &#123;            semaphore.release(1);        &#125;    &#125;&#125;
æ‰§è¡Œç»“æœï¼š
çº¿ç¨‹ã€Thread-1ã€‘å·²ç»å¼€å§‹å·¥ä½œçº¿ç¨‹ã€Thread-3ã€‘å·²ç»å¼€å§‹å·¥ä½œçº¿ç¨‹ã€Thread-0ã€‘å·²ç»å¼€å§‹å·¥ä½œçº¿ç¨‹ã€Thread-4ã€‘å·²ç»å¼€å§‹å·¥ä½œçº¿ç¨‹ã€Thread-2ã€‘å·²ç»å¼€å§‹å·¥ä½œçº¿ç¨‹ã€Thread-1ã€‘è·å¾—é”çº¿ç¨‹ã€Thread-1ã€‘å·²ç»é‡Šæ”¾é”çº¿ç¨‹ã€Thread-0ã€‘è·å¾—é”çº¿ç¨‹ã€Thread-0ã€‘å·²ç»é‡Šæ”¾é”çº¿ç¨‹ã€Thread-3ã€‘è·å¾—é”çº¿ç¨‹ã€Thread-3ã€‘å·²ç»é‡Šæ”¾é”çº¿ç¨‹ã€Thread-4ã€‘è·å¾—é”çº¿ç¨‹ã€Thread-4ã€‘å·²ç»é‡Šæ”¾é”çº¿ç¨‹ã€Thread-2ã€‘è·å¾—é”çº¿ç¨‹ã€Thread-2ã€‘å·²ç»é‡Šæ”¾é”

1.3 Semaphore(ä¿¡å·é‡)JDKæºç -æ„é€ æ–¹æ³•Semaphoreè¿™ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼Œéƒ½å¿…é¡»æä¾›è®¸å¯çš„æ•°é‡ï¼Œç¬¬äºŒä¸ªæ„é€ æ–¹æ³•å¯ä»¥æŒ‡å®šæ˜¯å…¬å¹³æ¨¡å¼è¿˜æ˜¯éå…¬å¹³æ¨¡å¼ï¼Œé»˜è®¤éå…¬å¹³æ¨¡å¼ã€‚

å…¬å¹³æ¨¡å¼ï¼š è°ƒç”¨ acquire çš„é¡ºåºå°±æ˜¯è·å–è®¸å¯è¯çš„é¡ºåºï¼Œéµå¾ª FIFOï¼›
æŠ¢å å¼ï¼š  æœ‰å¯èƒ½ä¸€ä¸ªæ–°çš„è·å–çº¿ç¨‹æ°å¥½åœ¨ä¸€ä¸ªè®¸å¯è¯é‡Šæ”¾æ—¶å¾—åˆ°äº†è¿™ä¸ªè®¸å¯è¯ï¼Œè€Œå‰é¢è¿˜æœ‰ç­‰å¾…çš„çº¿ç¨‹ã€‚

/** * Creates a &#123;@code Semaphore&#125; with the given number of * permits and nonfair fairness setting. * * @param permits the initial number of permits available. *        This value may be negative, in which case releases *        must occur before any acquires will be granted. */public Semaphore(int permits) &#123;    sync = new NonfairSync(permits);&#125;/** * Creates a &#123;@code Semaphore&#125; with the given number of * permits and the given fairness setting. * * @param permits the initial number of permits available. *        This value may be negative, in which case releases *        must occur before any acquires will be granted. * @param fair &#123;@code true&#125; if this semaphore will guarantee *        first-in first-out granting of permits under contention, *        else &#123;@code false&#125; */public Semaphore(int permits, boolean fair) &#123;    sync = fair ? new FairSync(permits) : new NonfairSync(permits);&#125;

 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(åå››)Javaå¤šçº¿ç¨‹ä¹‹Semaphoreã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAå¤šçº¿ç¨‹(å››)Javaå¤šçº¿ç¨‹ä¹‹joinç­‰å¾…ç»“æŸ</title>
    <url>/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B(%E5%9B%9B)Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8Bjoin%E7%AD%89%E5%BE%85%E7%BB%93%E6%9D%9F/</url>
    <content><![CDATA[1.JAVAå¤šçº¿ç¨‹(å››)Javaå¤šçº¿ç¨‹ä¹‹joinç­‰å¾…ç»“æŸ1.1 join(ç­‰å¾…ç»“æŸ)&emsp;&emsp;join()æ–¹æ³•çš„ä½œç”¨ï¼Œæ˜¯ç­‰å¾…è¿™ä¸ªçº¿ç¨‹ç»“æŸï¼›
ä¹Ÿå°±æ˜¯è¯´ï¼Œthread.join()æ–¹æ³•é˜»å¡è°ƒç”¨æ­¤æ–¹æ³•çš„çº¿ç¨‹(calling thread)è¿›å…¥ TIMED_WAITING çŠ¶æ€ï¼Œç›´åˆ°çº¿ç¨‹threadå®Œæˆï¼Œæ­¤çº¿ç¨‹å†ç»§ç»­ï¼›é€šå¸¸ç”¨äºåœ¨main()ä¸»çº¿ç¨‹å†…ï¼Œç­‰å¾…å…¶å®ƒçº¿ç¨‹å®Œæˆå†ç»“æŸmain()ä¸»çº¿ç¨‹ã€‚
package com.yuanxw.chapter4;public class ThreadJoin &#123;    public static void main(String[] args) throws InterruptedException &#123;        long startTime = System.currentTimeMillis();        Thread thread1 = new Thread(new SyncDatabase(&quot;T1&quot;,&quot;192.168.185.26&quot;,1000L));        Thread thread2 = new Thread(new SyncDatabase(&quot;T2&quot;,&quot;192.168.185.27&quot;,1500L));        Thread thread3 = new Thread(new SyncDatabase(&quot;T3&quot;,&quot;192.168.185.28&quot;,2500L));        thread1.start();        thread2.start();        thread3.start();        // ç­‰å¾…ã€thread1ã€thread2ã€thread3ã€‘å¯¹è±¡çº¿ç¨‹æ­»äº¡ï¼ˆç»“æŸï¼‰        thread1.join();        thread2.join();        thread3.join();        long endTime = System.currentTimeMillis();        System.out.println(String.format(&quot;æ‰€æœ‰æœåŠ¡å™¨æ•°æ®åŒæ­¥å®Œæˆï¼Œå…±è€—æ—¶ã€%sã€‘æ¯«ç§’&quot;,endTime - startTime ));    &#125;&#125;/** * åŒæ­¥æ•°æ®åº“æ•°æ® */class SyncDatabase implements Runnable&#123;    /** åŒæ­¥æœåŠ¡å™¨åç§° **/    private String serviceName;    /** åŒæ­¥æœåŠ¡IPåœ°å€ **/    private String ipAddr;    /** åŒæ­¥æ—¶é—´ **/    private long syncTime;    public SyncDatabase(String serviceName, String ipAddr, long syncTime) &#123;        this.serviceName = serviceName;        this.ipAddr = ipAddr;        this.syncTime = syncTime;    &#125;    @Override    public void run() &#123;        try &#123;            Thread.sleep(syncTime);            System.out.println(String.format(&quot;åŒæ­¥ã€%sã€‘æœåŠ¡å™¨ï¼ŒIPåœ°å€ã€%sã€‘ï¼Œæ•°æ®åŒæ­¥å®Œæˆï¼Œå…±è€—æ—¶ã€%sã€‘æ¯«ç§’&quot;, serviceName,ipAddr,syncTime));        &#125; catch (InterruptedException e) &#123;            e.printStackTrace();        &#125;    &#125;&#125;
æ‰§è¡Œç»“æœï¼š
åŒæ­¥ã€T1ã€‘æœåŠ¡å™¨ï¼ŒIPåœ°å€ã€192.168.185.26ã€‘ï¼Œæ•°æ®åŒæ­¥å®Œæˆï¼Œå…±è€—æ—¶ã€1000ã€‘æ¯«ç§’åŒæ­¥ã€T2ã€‘æœåŠ¡å™¨ï¼ŒIPåœ°å€ã€192.168.185.27ã€‘ï¼Œæ•°æ®åŒæ­¥å®Œæˆï¼Œå…±è€—æ—¶ã€1500ã€‘æ¯«ç§’åŒæ­¥ã€T3ã€‘æœåŠ¡å™¨ï¼ŒIPåœ°å€ã€192.168.185.28ã€‘ï¼Œæ•°æ®åŒæ­¥å®Œæˆï¼Œå…±è€—æ—¶ã€2500ã€‘æ¯«ç§’æ‰€æœ‰æœåŠ¡å™¨æ•°æ®åŒæ­¥å®Œæˆï¼Œå…±è€—æ—¶ã€2502ã€‘æ¯«ç§’

 &emsp;&emsp;&emsp;&emsp;â€“ ä»¥ä¸Šä¸ºã€ŠJAVAå¤šçº¿ç¨‹(å››)Javaå¤šçº¿ç¨‹ä¹‹joinç­‰å¾…ç»“æŸã€‹ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„è¯·æŒ‡å‡ºï¼Œæˆ‘åç»­é€æ­¥å®Œå–„æ›´æ­£ï¼Œå¤§å®¶å…±åŒæé«˜ã€‚è°¢è°¢å¤§å®¶å¯¹æˆ‘çš„å…³æ³¨ã€‚  â€”â€”åšç§¯è–„å‘(yuanxw)
]]></content>
      <categories>
        <category>Javaå¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>Kafkaæºç åˆ†æ(ä¸€)ç¯å¢ƒæ­å»º</title>
    <url>/Kafka%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/Kafka%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%80)%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[Kafkaæºç åˆ†æ(ä¸€)ç¯å¢ƒæ­å»ºä¸€ã€å‰è¨€æºç çš„æ€è·¯æ˜¯å…ˆåˆ†æè€ç‰ˆæœ¬ï¼Œå†åˆ†ææ–°ç‰ˆæœ¬ã€‚å› ä¸ºè€ç‰ˆæœ¬çš„æ¶æ„æ˜¯ç¨³å®šçš„ï¼ŒåŸºç¡€ç‰¹æ€§éƒ½æ˜¯æœ‰çš„ã€‚æœ€åæˆ‘ä»¬å¯¹æ¯”Featureæå‡å¯¹Kafkaç†è§£ã€‚ç”±æµ…å…¥æ·±ï¼šå‡è®¾æˆ‘ä»¬è®¤ä¸ºKafkaæ˜¯ä¸€ä¸ªå•ä½“çš„ï¼Œé¦–å…ˆåˆ†æä¸€æ¡æ¶ˆæ¯ä»Producerå‘åˆ°Kafkaå†åˆ°Consumerçš„ä¸€ä¸ªæ¶ˆè´¹ï¼Œå†åˆ°é›†ç¾¤çš„å¤„ç†çš„æ¶ˆè´¹ã€‚
äºŒã€å‰ç½®æ¡ä»¶2.1 å®‰è£…å’Œé…ç½®JDK
JDKé…ç½®è¦æ±‚JDK1.8ï¼Œä½¿ç”¨java -versionå‘½ä»¤æ¥æŸ¥çœ‹å½“å‰JDKçš„ç‰ˆæœ¬ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š
  C:\Users\yuanxw&gt;java -versionjava version &quot;1.8.0_241&quot;Java(TM) SE Runtime Environment (build 1.8.0_241-b07)Java HotSpot(TM) 64-Bit Server VM (build 25.241-b07, mixed mode)

2.2 ä¸‹è½½å¹¶å®‰è£…é…ç½®Gradle
ä¸‹è½½åœ°å€ä¸ºï¼šhttps://gradle.org/releases/ï¼Œç¬”è€…ä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯5.6.4ã€‚ä¸€èˆ¬åªéœ€è¦å°†ä¸‹è½½çš„åŒ…è§£å‹ï¼Œç„¶åå†å°†GRADLE_HOME&#x2F;binçš„è·¯å¾„æ·»åŠ åˆ°ç¯å¢ƒå˜é‡Pathä¸­å³å¯ï¼Œå…¶ä¸­;GRADLE_HOMEæŒ‡çš„æ˜¯Gradleçš„æ ¹ç›®å½•ã€‚å¯ä»¥ä½¿ç”¨gradle -vå‘½ä»¤æ¥éªŒè¯Gradleæ˜¯å¦å·²ç»é…ç½®å®Œæˆï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š
  C:\Users\yuanxw&gt;gradle -vWelcome to Gradle 5.6.4!Here are the highlights of this release: - Incremental Groovy compilation - Groovy compile avoidance - Test fixtures for Java projects - Manage plugin versions via settings scriptFor more details see https://docs.gradle.org/5.6.4/release-notes.html------------------------------------------------------------Gradle 5.6.4------------------------------------------------------------Build time:   2019-11-01 20:42:00 UTCRevision:     dd870424f9bd8e195d614dc14bb140f43c22da98Kotlin:       1.3.41Groovy:       2.5.4Ant:          Apache Ant(TM) version 1.9.14 compiled on March 12 2019JVM:          1.8.0_241 (Oracle Corporation 25.241-b07)OS:           Windows 10 10.0 amd64

2.3 ä¸‹è½½å¹¶å®‰è£…é…ç½®Scala
åœ¨winä¸Šå®‰è£…Scala 2.10.6ï¼Œä¸Šå®˜ç½‘æ‰¾åˆ°2.10.6ç‰ˆæœ¬å¯¹åº”çš„ä¸‹è½½åœ°å€ï¼Œkafkaçš„æœåŠ¡å™¨ç«¯çš„æºç æ˜¯scalaå†™çš„ï¼Œä½†æ˜¯æ–°ç‰ˆæœ¬çš„å®¢æˆ·ç«¯çš„æºç æ˜¯javaå†™çš„https://www.scala-lang.org/download/2.10.6.htmlç„¶åå°±å¯ä»¥ä¸‹è½½winä¸Šçš„å®‰è£…åŒ…ï¼Œscala.msiï¼Œä¸‹è½½å¥½ä¹‹åå‚»ç“œå¼å®‰è£…å°±å¯ä»¥äº†ï¼Œæ¥ç€å¿…é¡»é…ç½®SCALA_HOMEå’ŒPATHä¸¤ä¸ªç¯å¢ƒå˜é‡ï¼Œé¦–å…ˆå¿…é¡»å¾—æœ‰Javaå’ŒScalaä¸¤ç§ç¼–ç¨‹è¯­è¨€çš„æ”¯æŒæ‰å¯ä»¥ã€‚
  C:\Users\yuanxw&gt;scala -versionScala code runner version 2.10.6 -- Copyright 2002-2013, LAMP/EPFL

2.4 æ„å»ºKafkaæºç ç¯å¢ƒ
åœ¨GitHubä¸Šforkä¸€ä»½kafkaæºç åˆ°è‡ªå·²ä»“åº“ï¼Œä»è‡ªå·±çš„ä»“åº“ä¸­ä¸‹è½½ï¼Œä¸‹è½½åœ°å€ï¼šhttps://github.com/apache/kafka.git
  # åœ¨ Eï¼š ç›˜æ–°å»ºä¸€ä¸ª kafka ç›®å½•ï¼Œç„¶åæŠŠ Kafka é¡¹ç›® Clone åˆ°è¿™é‡Œã€‚(ä½œè€…ä½ç½®ï¼šE:\workspace\IdeaWork\github)E:\workspace\IdeaWork\github&gt;**git clone git@github.com:yuanxw/kafka.git**Cloning into &#x27;kafka&#x27;...remote: Enumerating objects: 451197, done.remote: Total 451197 (delta 0), reused 0 (delta 0), pack-reused 451197 (from 1)Receiving objects: 100% (451197/451197), 227.47 MiB | 81.00 KiB/s, done.Resolving deltas: 100% (220962/220962), done.Updating files: 100% (6890/6890), done.# åˆ‡æ¢åˆ° 0.10.2 ç‰ˆæœ¬*git checkout origin/0.10.2

Gradle æ„å»º Kafka é¡¹ç›®ä¹‹å‰ç¡®è®¤äº‹é¡¹ï¼š

ç¡®ä¿ gradle.properties é…ç½®æ–‡ä»¶ä¸­çš„ scalaVersion ä¸ Windows ä¸­ Scala ç‰ˆæœ¬ä¸€è‡´ï¼Œ0.10.2 ç‰ˆæœ¬çš„ Kafka æ˜¯ 2.10.6 ç‰ˆæœ¬çš„ Scalaã€‚
 group=org.apache.kafka# NOTE: When you change this version number, you should also make sure to update# the version numbers in tests/kafkatest/__init__.py and kafka-merge-pr.py.version=0.10.2.3-SNAPSHOTscalaVersion=2.10.6task=buildorg.gradle.jvmargs=-XX:MaxPermSize=512m -Xmx1024m -Xss2m

é…ç½® Gradle çš„ä»“åº“ä¸ºé˜¿é‡Œçš„é•œåƒä»“åº“

æ”¹ä¹‹å‰é‡åˆ°çš„é”™è¯¯ï¼š

 E:\workspace\IdeaWork\github\kafka&gt;gradle ideaStarting a Gradle Daemon (subsequent builds will be faster)&gt; Configure project :[Fatal Error] gradle-versions-plugin-0.13.0.pom:7:3: å…ƒç´ ç±»å‹ &quot;hr&quot; å¿…é¡»ç”±åŒ¹é…çš„ç»“æŸæ ‡è®° &quot;&lt;/hr&gt;&quot; ç»ˆæ­¢ã€‚FAILURE: Build failed with an exception.* What went wrong:A problem occurred configuring root project &#x27;kafka&#x27;.&gt; Could not resolve all artifacts for configuration &#x27;:classpath&#x27;.   &gt; Could not resolve com.github.ben-manes:gradle-versions-plugin:0.13.0.     Required by:         project :      &gt; Could not resolve com.github.ben-manes:gradle-versions-plugin:0.13.0.         &gt; Could not parse POM http://dl.bintray.com/content/netflixoss/external-gradle-plugins/com/github/ben-manes/gradle-versions-plugin/0.13.0/gradle-versions-plugin-0.13.0.pom            &gt; å…ƒç´ ç±»å‹ &quot;hr&quot; å¿…é¡»ç”±åŒ¹é…çš„ç»“æŸæ ‡è®° &quot;&lt;/hr&gt;&quot; ç»ˆæ­¢ã€‚* Try:Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output. Run with --scan to get full insights.* Get more help at https://help.gradle.orgBUILD FAILED in 12s

ä¿®æ”¹ org.scoverage:gradle-scoverage çš„ç‰ˆæœ¬å·
 dependencies &#123;  // For Apache Rat plugin to ignore non-Git files  classpath &quot;org.ajoberstar:grgit:1.7.0&quot;  classpath &#x27;com.github.ben-manes:gradle-versions-plugin:0.13.0&#x27;    // è¿™é‡ŒåŸæ¥æ˜¯ 2.1.0 ä¿®æ”¹ä¸º 2.5.0  // classpath &#x27;org.scoverage:gradle-scoverage:2.1.0&#x27;  classpath &#x27;org.scoverage:gradle-scoverage:2.5.0&#x27;  &#125;

æ”¹ä¹‹å‰é‡åˆ°çš„é”™è¯¯ï¼š

 &gt; Configure project :\github\kafka&gt;gradle ideaBuilding project &#x27;core&#x27; with Scala version 2.10.6FAILURE: Build failed with an exception.* Where:Build file &#x27;E:\workspace\IdeaWork\github\kafka\build.gradle&#x27; line: 388* What went wrong:A problem occurred evaluating root project &#x27;kafka&#x27;.&gt; Failed to apply plugin [id &#x27;org.scoverage&#x27;]   &gt; Could not create an instance of type org.scoverage.ScoverageExtension.      &gt; You can&#x27;t map a property that does not exist: propertyName=testClassesDir* Try:Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output. Run with --scan to get full insights.* Get more help at https://help.gradle.orgDeprecated Gradle features were used in this build, making it incompatible with Gradle 6.0.Use &#x27;--warning-mode all&#x27; to show the individual deprecation warnings.See https://docs.gradle.org/5.6.4/userguide/command_line_interface.html#sec:command_line_warningsBUILD FAILED in 1s

ä¿®æ”¹å¥½ä¸Šé¢çš„æ–‡ä»¶ä¹‹åå°±å¯ä»¥åœ¨ kafka æ ¹ç›®å½•ç›´æ¥æ‰§è¡ŒÂ gradle ideaï¼Œç­‰æˆåŠŸä¹‹åå°±å¯ä»¥ç”¨ IDEA æ‰“å¼€äº†ã€‚
 E:\workspace\IdeaWork\github\kafka&gt;gradle idea&gt; Configure project :Building project &#x27;core&#x27; with Scala version 2.10.6&gt; Task :ideaGenerated IDEA project at file:///E:/workspace/IdeaWork/github/kafka/kafka.iprDeprecated Gradle features were used in this build, making it incompatible with Gradle 6.0.Use &#x27;--warning-mode all&#x27; to show the individual deprecation warnings.See https://docs.gradle.org/5.6.4/userguide/command_line_interface.html#sec:command_line_warningsBUILD SUCCESSFUL in 3m 19s19 actionable tasks: 19 executed
 




2.5 Ideaé…ç½®Kafkaæºç ç¯å¢ƒ
IDEA å®‰è£… Scala æ’ä»¶ï¼Œåœ¨ File -&gt; Settings -&gt; Plugin ä¸­æœç´¢ Scala å¹¶å®‰è£…ã€‚
  

é…ç½® Scala SDKï¼Œåœ¨ File -&gt; Settings -&gt; ProjectStructure
  

å°† config ç›®å½•ä¸‹çš„ log4j.properties æ–‡ä»¶æ‹·è´åˆ° core&#x2F;src&#x2F;main&#x2F;scala ç›®å½•ä¸‹ï¼Œè¿™æ ·å¯ä»¥è®© Kafka åœ¨è¿è¡Œæ—¶èƒ½å¤Ÿè¾“å‡ºæ—¥å¿—ä¿¡æ¯ã€‚
  

é…ç½® server.properties æ–‡ä»¶
  # å¼€å¯è¿™ä¸ªåŠŸèƒ½æ–¹ä¾¿Kafkaåœ¨è¿è¡Œä¸€æ®µæ—¶é—´ä¹‹åï¼Œèƒ½å¤Ÿåˆ é™¤ä¸€äº›ä¸éœ€è¦çš„ä¸´æ—¶topicdelete.topic.enable=true# ç¦ç”¨è‡ªåŠ¨åˆ›å»ºtopicçš„åŠŸèƒ½auto.create.topics.enable=false# åœ¨Windowsç¯å¢ƒä¸‹è¿è¡Œï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹è¿™ä¸ªé…ç½®ï¼Œæ³¨æ„è¿™é‡Œçš„åŒåæ–œæ log.dirs=E:\\workspace\\IdeaWork\\github\\kafka\\tmp\\kafka-logs# é…ç½®kafkaä¾èµ–çš„zookeeperè·¯å¾„åœ°å€ï¼Œè¿™é‡Œçš„å‰ææ˜¯åœ¨æœ¬åœ°å¼€å¯äº†ä¸€ä¸ªzookeeperçš„æœåŠ¡zookeeper.connect=localhost:2181/kafka

2.6 Zookeeperçš„å®‰è£…ã€é…ç½®åŠå¯åŠ¨Kafkaéœ€è¦ä½¿ç”¨Zookeeperæ¥ç®¡ç†å…ƒæ•°æ®ï¼Œæ¯”å¦‚è®°å½•topicã€partitionsï¼ˆåˆ†åŒºï¼‰ä»¥åŠreplicaï¼ˆå‰¯æœ¬ï¼‰çš„åˆ†é…ä¿¡æ¯ã€‚ç”±äºè¿™é‡Œåªæ˜¯é˜è¿°å¦‚ä½•æ„å»ºKafkaçš„æºç ç¯å¢ƒæ­å»ºï¼Œæ‰€ä»¥è¿™é‡Œçš„Zookeeperçš„å®‰è£…ä¹Ÿä»¥æç®€ä¸ºä¸»ï¼Œå³é‡‡ç”¨å•æœºé…ç½®ã€‚Zookeeperä¸‹è½½åœ°å€ä¸ºï¼šhttp://zookeeper.apache.org/releases.htmlï¼Œä¸‹è½½ä¹‹åè§£å‹ï¼Œç„¶åå°†**$ZOOKEEPER_HOMEç›®å½•ä¸‹çš„conf&#x2F;zoo_sample.cfgé‡å‘½åä¸ºzoo.cfgï¼Œå…¶ä¸­$ZOOKEEPER_HOME**æŒ‡çš„æ˜¯ZooKeeperçš„æ ¹ç›®å½•ã€‚
ä¿®æ”¹**$ZOOKEEPER_HOME**&#x2F;conf&#x2F;zoo.cfgé…ç½®ï¼Œç¤ºä¾‹é…ç½®å¦‚ä¸‹ï¼ˆå…¶ä½™é…ç½®å¯ä»¥ä¸åšä¿®æ”¹ï¼‰ï¼š

æœ¬åœ°ä¸‹è½½Zookeeper

ä¸‹è½½ç‰ˆæœ¬ï¼šapache-zookeeper-3.6.1
ä¿®æ”¹é…ç½®ï¼šdataDir&#x3D;D:\software\apache-zookeeper-3.6.1\data


é…ç½®zookeeperç¯å¢ƒå˜é‡
  å°†$ZOOKEEPER_HOME&#x2F;biné…ç½®åˆ°Pathä¸­ï¼Œä¹‹åç›´æ¥è¿è¡ŒzkServerå‘½ä»¤å³å¯å¼€å¯ZookeeperæœåŠ¡ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š
  C:\Users\yuanxw&gt;zkServerC:\Users\yuanxw&gt;call &quot;D:\software\Java\jdk1.8\jdk1.8.0_241&quot;\bin\java &quot;-Dzookeeper.log.dir=D:\software\apache-zookeeper-3.6.1\bin\..\logs&quot; &quot;-Dzookeeper.root.logger=INFO,CONSOLE&quot; &quot;-Dzookeeper.log.file=zookeeper-yuanxw-server-DESKTOP-EDMKNEI.log&quot; &quot;-XX:+HeapDumpOnOutOfMemoryError&quot; &quot;-XX:OnOutOfMemoryError=cmd /c taskkill /pid %%p /t /f&quot; -cp &quot;D:\software\apache-zookeeper-3.6.1\bin\..\build\classes;D:\software\apache-zookeeper-3.6.1\bin\..\build\lib\*;D:\software\apache-zookeeper-3.6.1\bin\..\*;D:\software\apache-zookeeper-3.6.1\bin\..\lib\*;D:\software\apache-zookeeper-3.6.1\bin\..\conf&quot; org.apache.zookeeper.server.quorum.QuorumPeerMain &quot;D:\software\apache-zookeeper-3.6.1\bin\..\conf\zoo.cfg&quot;2025-07-13 12:03:32,539 [myid:] - INFO  [main:QuorumPeerConfig@173] - Reading configuration from: D:\software\apache-zookeeper-3.6.1\bin\..\conf\zoo.cfg2025-07-13 12:03:32,566 [myid:] - INFO  [main:QuorumPeerConfig@459] - clientPortAddress is 0.0.0.0:21812025-07-13 12:03:32,567 [myid:] - INFO  [main:QuorumPeerConfig@463] - secureClientPort is not set2025-07-13 12:03:32,567 [myid:] - INFO  [main:QuorumPeerConfig@479] - observerMasterPort is not set2025-07-13 12:03:32,569 [myid:] - INFO  [main:QuorumPeerConfig@496] - metricsProvider.className is org.apache.zookeeper.metrics.impl.DefaultMetricsProvider2025-07-13 12:03:32,570 [myid:] - INFO  [main:DatadirCleanupManager@78] - autopurge.snapRetainCount set to 32025-07-13 12:03:32,570 [myid:] - INFO  [main:DatadirCleanupManager@79] - autopurge.purgeInterval set to 02025-07-13 12:03:32,570 [myid:] - INFO  [main:DatadirCleanupManager@101] - Purge task is not scheduled.2025-07-13 12:03:32,570 [myid:] - WARN  [main:QuorumPeerMain@138] - Either no config or no quorum defined in config, running in standalone mode2025-07-13 12:03:32,574 [myid:] - INFO  [main:ManagedUtil@44] - Log4j 1.2 jmx support found and enabled.2025-07-13 12:03:32,630 [myid:] - INFO  [main:QuorumPeerConfig@173] - Reading configuration from: D:\software\apache-zookeeper-3.6.1\bin\..\conf\zoo.cfg2025-07-13 12:03:32,631 [myid:] - INFO  [main:QuorumPeerConfig@459] - clientPortAddress is 0.0.0.0:21812025-07-13 12:03:32,631 [myid:] - INFO  [main:QuorumPeerConfig@463] - secureClientPort is not set2025-07-13 12:03:32,632 [myid:] - INFO  [main:QuorumPeerConfig@479] - observerMasterPort is not set2025-07-13 12:03:32,632 [myid:] - INFO  [main:QuorumPeerConfig@496] - metricsProvider.className is org.apache.zookeeper.metrics.impl.DefaultMetricsProvider2025-07-13 12:03:32,632 [myid:] - INFO  [main:ZooKeeperServerMain@122] - Starting server2025-07-13 12:03:32,680 [myid:] - INFO  [main:ServerMetrics@62] - ServerMetrics initialized with provider org.apache.zookeeper.metrics.impl.DefaultMetricsProvider@7a929222025-07-13 12:03:32,683 [myid:] - INFO  [main:FileTxnSnapLog@124] - zookeeper.snapshot.trust.empty : false2025-07-13 12:03:32,691 [myid:] - INFO  [main:ZookeeperBanner@42] -2025-07-13 12:03:32,691 [myid:] - INFO  [main:ZookeeperBanner@42] -   ______                  _2025-07-13 12:03:32,691 [myid:] - INFO  [main:ZookeeperBanner@42] -  |___  /                 | |2025-07-13 12:03:32,692 [myid:] - INFO  [main:ZookeeperBanner@42] -     / /    ___     ___   | | __   ___    ___   _ __     ___   _ __2025-07-13 12:03:32,692 [myid:] - INFO  [main:ZookeeperBanner@42] -    / /    / _ \   / _ \  | |/ /  / _ \  / _ \ | &#x27;_ \   / _ \ | &#x27;__|2025-07-13 12:03:32,692 [myid:] - INFO  [main:ZookeeperBanner@42] -   / /__  | (_) | | (_) | |   &lt;  |  __/ |  __/ | |_) | |  __/ | |2025-07-13 12:03:32,693 [myid:] - INFO  [main:ZookeeperBanner@42] -  /_____|  \___/   \___/  |_|\_\  \___|  \___| | .__/   \___| |_|2025-07-13 12:03:32,693 [myid:] - INFO  [main:ZookeeperBanner@42] -                                               | |2025-07-13 12:03:32,693 [myid:] - INFO  [main:ZookeeperBanner@42] -                                               |_|2025-07-13 12:03:32,694 [myid:] - INFO  [main:ZookeeperBanner@42] -2025-07-13 12:03:32,705 [myid:] - INFO  [main:Environment@98] - Server environment:zookeeper.version=3.6.1--104dcb3e3fb464b30c5186d229e00af9f332524b, built on 04/21/2020 15:01 GMT2025-07-13 12:03:32,705 [myid:] - INFO  [main:Environment@98] - Server environment:host.name=DESKTOP-EDMKNEI2025-07-13 12:03:32,705 [myid:] - INFO  [main:Environment@98] - Server environment:java.version=1.8.0_2412025-07-13 12:03:32,706 [myid:] - INFO  [main:Environment@98] - Server environment:java.vendor=Oracle Corporation2025-07-13 12:03:32,708 [myid:] - INFO  [main:Environment@98] - Server environment:java.home=D:\software\Java\jdk1.8\jdk1.8.0_241\jre2025-07-13 12:03:32,874 [myid:] - INFO  [main:ContextHandler@825] - Started o.e.j.s.ServletContextHandler@887af79&#123;/,null,AVAILABLE&#125;2025-07-13 12:03:33,262 [myid:] - INFO  [main:AbstractConnector@330] - Started ServerConnector@57baeedf&#123;HTTP/1.1,[http/1.1]&#125;&#123;0.0.0.0:8080&#125;2025-07-13 12:03:33,263 [myid:] - INFO  [main:Server@399] - Started @925ms2025-07-13 12:03:33,264 [myid:] - INFO  [main:JettyAdminServer@178] - Started AdminServer on address 0.0.0.0, port 8080 and command URL /commands2025-07-13 12:03:33,268 [myid:] - INFO  [main:ServerCnxnFactory@169] - Using org.apache.zookeeper.server.NIOServerCnxnFactory as server connection factory2025-07-13 12:03:33,269 [myid:] - WARN  [main:ServerCnxnFactory@309] - maxCnxns is not configured, using default value 0.2025-07-13 12:03:33,271 [myid:] - INFO  [main:NIOServerCnxnFactory@666] - Configuring NIO connection handler with 10s sessionless connection timeout, 2 selector thread(s), 16 worker threads, and 64 kB direct buffers.2025-07-13 12:03:33,272 [myid:] - INFO  [main:NIOServerCnxnFactory@674] - binding to port 0.0.0.0/0.0.0.0:21812025-07-13 12:03:33,285 [myid:] - INFO  [main:WatchManagerFactory@42] - Using org.apache.zookeeper.server.watch.WatchManager as watch manager2025-07-13 12:03:33,286 [myid:] - INFO  [main:WatchManagerFactory@42] - Using org.apache.zookeeper.server.watch.WatchManager as watch manager2025-07-13 12:03:33,286 [myid:] - INFO  [main:ZKDatabase@132] - zookeeper.snapshotSizeFactor = 0.332025-07-13 12:03:33,286 [myid:] - INFO  [main:ZKDatabase@152] - zookeeper.commitLogCount=5002025-07-13 12:03:33,290 [myid:] - INFO  [main:SnapStream@61] - zookeeper.snapshot.compression.method = CHECKED2025-07-13 12:03:33,291 [myid:] - INFO  [main:FileSnap@85] - Reading snapshot D:\software\apache-zookeeper-3.6.1\data\version-2\snapshot.02025-07-13 12:03:33,293 [myid:] - INFO  [main:DataTree@1737] - The digest value is empty in snapshot2025-07-13 12:03:33,298 [myid:] - INFO  [main:ZKDatabase@289] - Snapshot loaded in 11 ms, highest zxid is 0x0, digest is 13719855042025-07-13 12:03:33,299 [myid:] - INFO  [main:FileTxnSnapLog@470] - Snapshotting: 0x0 to D:\software\apache-zookeeper-3.6.1\data\version-2\snapshot.02025-07-13 12:03:33,301 [myid:] - INFO  [main:ZooKeeperServer@519] - Snapshot taken in 2 ms2025-07-13 12:03:33,315 [myid:] - INFO  [main:RequestThrottler@74] - zookeeper.request_throttler.shutdownTimeout = 100002025-07-13 12:03:33,326 [myid:] - INFO  [main:ContainerManager@83] - Using checkIntervalMs=60000 maxPerMinute=10000 maxNeverUsedIntervalMs=02025-07-13 12:03:33,328 [myid:] - INFO  [main:ZKAuditProvider@42] - ZooKeeper audit is disabled.

]]></content>
      <categories>
        <category>Kafka</category>
      </categories>
      <tags>
        <tag>Kafka</tag>
        <tag>Kafkaæºç åˆ†æ</tag>
      </tags>
  </entry>
  <entry>
    <title>Kafkaæºç åˆ†æ(ä¸‰)Senderçº¿ç¨‹è·å–metadataæ•°æ®</title>
    <url>/Kafka%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/Kafka%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%89)Sender%E7%BA%BF%E7%A8%8B%E8%8E%B7%E5%8F%96metadata%E6%95%B0%E6%8D%AE/</url>
    <content><![CDATA[Kafkaæºç åˆ†æ(ä¸‰)Senderçº¿ç¨‹è·å–metadataæ•°æ®ä¸€ã€å‰è¨€
å‰é¢KafkaProducer ç±»é‡Œé¢å¼€å¯senderçº¿ç¨‹ã€‚

private KafkaProducer(ProducerConfig config, Serializer&lt;K&gt; keySerializer, Serializer&lt;V&gt; valueSerializer) &#123;// .....çœç•¥....// å¯åŠ¨Kafkaç½‘ç»œçº¿ç¨‹this.ioThread = new KafkaThread(ioThreadName, this.sender, true);this.ioThread.start();// .....çœç•¥....

äºŒã€Senderçº¿ç¨‹æ‰§è¡Œæµç¨‹å›¾

sequenceDiagram
autonumber
KafkaProducer -&gt;&gt; Sender: ioThread.start()
Sender-&gt;&gt;Sender: run()å¤šçº¿ç¨‹æ–¹æ³•
loop while (running)[æ­»å¾ªç¯]
    Sender-&gt;&gt;Sender: è·å–å½“å‰é›†ç¾¤metadataä¿¡æ¯ metadata.fetch();
    Sender-&gt;&gt;Sender: è·å–å·²å‡†å¤‡å¥½å‘é€æ•°æ®çš„åˆ†åŒºè¯·æ±‚
    Sender-&gt;&gt;Sender: åˆ›å»ºæ‰¹æ¬¡è¯·æ±‚this.accumulator.drain
    Sender-&gt;&gt;Sender: ä¿è¯æ¶ˆæ¯é¡ºåºï¼ŒguaranteeMessageOrderï¼šfalse
    Sender-&gt;&gt;Sender: å‡†å¤‡å¾…å‘é€è¯·æ±‚çš„æ•°æ®ï¼ŒsendProduceRequests(batches, now);
    Sender-&gt;&gt;NetworkClient: this.client.poll(pollTimeout, now);
    NetworkClient-&gt;&gt; NetworkClient: å°è£…è¦æ‹‰å–å…ƒæ•°æ®çš„è¯·æ±‚metadataUpdater.maybeUpdate(now);
    NetworkClient-&gt;&gt; Selector: é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æœ‰å¯ç”¨è¿æ¥æˆ–è¶…æ—¶select(timeout);
end



ä¸‰ã€æºä»£ç åˆ†æ
Senderçº¿ç¨‹çš„runæ–¹æ³•è¢«æ‰§è¡Œ

	/**  * producerçº¿ç¨‹çš„ä¸» run å¾ªç¯  */ public void run() &#123;     log.debug(&quot;Starting Kafka producer I/O thread.&quot;);     // main å¾ªç¯ï¼Œä¸€ç›´è¿è¡Œç›´åˆ°è°ƒç”¨ close     while (running) &#123;         try &#123;             run(time.milliseconds());         &#125; catch (Exception e) &#123;             log.error(&quot;Uncaught error in kafka producer I/O thread: &quot;, e);         &#125;     &#125;     log.debug(&quot;Beginning shutdown of Kafka producer I/O thread, sending remaining records.&quot;);     // okay we stopped accepting requests but there may still be     // requests in the accumulator or waiting for acknowledgment,     // wait until these are completed.     while (!forceClose &amp;&amp; (this.accumulator.hasUnsent() || this.client.inFlightRequestCount() &gt; 0)) &#123;         try &#123;             run(time.milliseconds());         &#125; catch (Exception e) &#123;             log.error(&quot;Uncaught error in kafka producer I/O thread: &quot;, e);         &#125;     &#125;     if (forceClose) &#123;         // We need to fail all the incomplete batches and wake up the threads waiting on         // the futures.         this.accumulator.abortIncompleteBatches();     &#125;     try &#123;         this.client.close();     &#125; catch (Exception e) &#123;         log.error(&quot;Failed to close network client&quot;, e);     &#125;     log.debug(&quot;Shutdown of Kafka producer I/O thread has completed.&quot;); &#125;

/** * Run a single iteration of sending *  * @param now *            The current POSIX time in milliseconds */void run(long now) &#123;    // è·å–å½“å‰é›†ç¾¤metadataä¿¡æ¯    Cluster cluster = metadata.fetch();    // è·å–å·²å‡†å¤‡å¥½å‘é€æ•°æ®çš„èŠ‚ç‚¹    RecordAccumulator.ReadyCheckResult result = this.accumulator.ready(cluster, now);    // å¦‚æœæœ‰ä»»ä½•åˆ†åŒºçš„ leader å°šä¸æ¸…æ¥šï¼Œåˆ™å¼ºåˆ¶å…ƒæ•°æ®æ›´æ–°ã€‚ç¬¬ä¸€æ¬¡æ‰§è¡Œtopicï¼Œä¸ä¼šèµ°    if (!result.unknownLeaderTopics.isEmpty()) &#123;        // The set of topics with unknown leader contains topics with leader election pending as well as        // topics which may have expired. Add the topic again to metadata to ensure it is included        // and request metadata update, since there are messages to send to the topic.        for (String topic : result.unknownLeaderTopics)            this.metadata.add(topic);        this.metadata.requestUpdate();    &#125;    // åˆ¤æ–­èŠ‚ç‚¹æœ‰æ²¡æœ‰å‡†å¤‡å¥½ï¼Œå¹¶ç§»é™¤æ²¡æœ‰å‡†å¤‡çš„èŠ‚ç‚¹    // remove any nodes we aren&#x27;t ready to send to    Iterator&lt;Node&gt; iter = result.readyNodes.iterator();    long notReadyTimeout = Long.MAX_VALUE;    while (iter.hasNext()) &#123;        Node node = iter.next();        if (!this.client.ready(node, now)) &#123;            iter.remove();            notReadyTimeout = Math.min(notReadyTimeout, this.client.connectionDelay(node, now));        &#125;    &#125;    // åˆ›å»ºæ‰¹æ¬¡è¯·æ±‚    Map&lt;Integer, List&lt;RecordBatch&gt;&gt; batches = this.accumulator.drain(cluster,                                                                     result.readyNodes,                                                                     this.maxRequestSize,                                                                     now);    // ä¿è¯æ¶ˆæ¯é¡ºåºï¼Œç¬¬ä¸€æ¬¡æ‰§è¡ŒguaranteeMessageOrderä¸ºfalseï¼Œä¸ä¼šèµ°    if (guaranteeMessageOrder) &#123;        // Mute all the partitions drained        for (List&lt;RecordBatch&gt; batchList : batches.values()) &#123;            for (RecordBatch batch : batchList)                this.accumulator.mutePartition(batch.topicPartition);        &#125;    &#125;    // æ£€æŸ¥è¶…æ—¶çš„æ‰¹æ¬¡ï¼Œç¬¬ä¸€æ¬¡æ‰§è¡Œæ²¡expiredBatchesä¸ºç©º    List&lt;RecordBatch&gt; expiredBatches = this.accumulator.abortExpiredBatches(this.requestTimeout, now);    // æ›´æ–°è¶…æ—¶æ‰¹æ¬¡çš„é”™è¯¯è®¡æ•°    for (RecordBatch expiredBatch : expiredBatches)        this.sensors.recordErrors(expiredBatch.topicPartition.topic(), expiredBatch.recordCount);    sensors.updateProduceRequestMetrics(batches);    // If we have any nodes that are ready to send + have sendable data, poll with 0 timeout so this can immediately    // loop and try sending more data. Otherwise, the timeout is determined by nodes that have partitions with data    // that isn&#x27;t yet sendable (e.g. lingering, backing off). Note that this specifically does not include nodes    // with sendable data that aren&#x27;t ready to send since they would cause busy looping.    long pollTimeout = Math.min(result.nextReadyCheckDelayMs, notReadyTimeout);    if (!result.readyNodes.isEmpty()) &#123;        log.trace(&quot;Nodes with data ready to send: &#123;&#125;&quot;, result.readyNodes);        pollTimeout = 0;    &#125;    // å‡†å¤‡å¾…å‘é€è¯·æ±‚çš„æ•°æ®    sendProduceRequests(batches, now);    // æ‰§è¡Œç½‘ç»œè¯·æ±‚    // if some partitions are already ready to be sent, the select time would be 0;    // otherwise if some partition already has some data accumulated but not ready yet,    // the select time will be the time difference between now and its linger expiry time;    // otherwise the select time will be the time difference between now and the metadata expiry time;    this.client.poll(pollTimeout, now);&#125;


æ‹‰å–å…ƒæ•°æ®çš„è¯·æ±‚ï¼Œåœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸ä¼šè¿”å›ä»»ä½•çš„æ•°æ®

/** * Do actual reads and writes to sockets. * * @param timeout The maximum amount of time to wait (in ms) for responses if there are none immediately, *                must be non-negative. The actual timeout will be the minimum of timeout, request timeout and *                metadata timeout * @param now The current time in milliseconds * @return The list of responses received */@Overridepublic List&lt;ClientResponse&gt; poll(long timeout, long now) &#123;    // å°è£…è¦æ‹‰å–å…ƒæ•°æ®çš„è¯·æ±‚    long metadataTimeout = metadataUpdater.maybeUpdate(now);    try &#123;        this.selector.poll(Utils.min(timeout, metadataTimeout, requestTimeoutMs));    &#125; catch (IOException e) &#123;        log.error(&quot;Unexpected error during I/O&quot;, e);    &#125;    // å¤„ç†å·²å®Œæˆè¯·æ±‚çš„æ“ä½œ    long updatedNow = this.time.milliseconds();    List&lt;ClientResponse&gt; responses = new ArrayList&lt;&gt;();    handleAbortedSends(responses);    handleCompletedSends(responses, updatedNow);    handleCompletedReceives(responses, updatedNow);    handleDisconnections(responses, updatedNow);    handleConnections();    handleInitiateApiVersionRequests(updatedNow);    handleTimedOutRequests(responses, updatedNow);    // invoke callbacks    for (ClientResponse response : responses) &#123;        try &#123;            response.onComplete();        &#125; catch (Exception e) &#123;            log.error(&quot;Uncaught error in request completion:&quot;, e);        &#125;    &#125;    return responses;&#125;


æ‹‰å–å…ƒæ•°æ®ï¼Œç»™å®šè¶…æ—¶é—´è¿”å›å¯ç”¨çš„é€šé“æˆ–è¶…æ—¶

@Overridepublic void poll(long timeout) throws IOException &#123;    if (timeout &lt; 0)        throw new IllegalArgumentException(&quot;timeout should be &gt;= 0&quot;);    clear();    if (hasStagedReceives() || !immediatelyConnectedKeys.isEmpty())        timeout = 0;    /* check ready keys */    long startSelect = time.nanoseconds();    // é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æœ‰å¯ç”¨è¿æ¥æˆ–è¶…æ—¶    int readyKeys = select(timeout);    long endSelect = time.nanoseconds();    this.sensors.selectTime.record(endSelect - startSelect, time.milliseconds());    if (readyKeys &gt; 0 || !immediatelyConnectedKeys.isEmpty()) &#123;        pollSelectionKeys(this.nioSelector.selectedKeys(), false, endSelect);        pollSelectionKeys(immediatelyConnectedKeys, true, endSelect);    &#125;    addToCompletedReceives();    long endIo = time.nanoseconds();    this.sensors.ioTime.record(endIo - endSelect, time.milliseconds());    // we use the time at the end of select to ensure that we don&#x27;t close any connections that    // have just been processed in pollSelectionKeys    maybeCloseOldestConnection(endSelect);&#125;]]></content>
      <categories>
        <category>Kafka</category>
      </categories>
      <tags>
        <tag>Kafka</tag>
        <tag>Kafkaæºç åˆ†æ</tag>
      </tags>
  </entry>
  <entry>
    <title>Kafkaæºç åˆ†æ(äºŒ)KafkaProduceråˆå§‹åŒ–</title>
    <url>/Kafka%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/Kafka%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%BA%8C)KafkaProducer%E5%88%9D%E5%A7%8B%E5%8C%96/</url>
    <content><![CDATA[Kafkaæºç åˆ†æ(äºŒ)KafkaProduceråˆå§‹åŒ–ä¸€ã€å‰è¨€Kafkaçš„æºç ä¸­é™„å¸¦äº†ä¸€ä¸ªexamplesæ¨¡å—ï¼Œæˆ‘ä»¬ä»KafkaConsumerProducerDemoç±»ä¸­ä½œä¸ºProducerç”Ÿäº§è€…å…¥å£è¿›å…¥æºç ã€‚
äºŒã€æºç åˆ†æ
KafkaConsumerProducerDemo åœ¨Demoä¸­åˆ›å»ºProducerå®ä¾‹ï¼Œå¹¶ä¸”å¼€å¯å¤šçº¿ç¨‹start

public class KafkaConsumerProducerDemo &#123;    public static void main(String[] args) &#123;        // åˆ¤æ–­æ˜¯å¦æ˜¯å¼‚æ­¥ï¼šå¦‚æœå‚æ•°ä¸ªæ•°ä¸º0ï¼Œæˆ–è€…ç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯&quot;sync&quot;ï¼Œåˆ™æ˜¯å¼‚æ­¥ã€‚ç”Ÿäº§ç¯å¢ƒä¸€èˆ¬æ˜¯å¼‚æ­¥çš„æ•°æ®å¤„ç†ã€‚        boolean isAsync = args.length == 0 || !args[0].trim().equalsIgnoreCase(&quot;sync&quot;);        Producer producerThread = new Producer(KafkaProperties.TOPIC, isAsync);        producerThread.start();								// æœ¬ç« èŠ‚åªçœ‹Producerï¼Œå› æ­¤æŠŠConsumerç›¸å…³çš„ä»£ç æš‚æ—¶æ³¨é‡Šæ‰        // Consumer consumerThread = new Consumer(KafkaProperties.TOPIC);        // consumerThread.start();    &#125;&#125;


KafkaProduceråˆå§‹åŒ–æµç¨‹å›¾



sequenceDiagram
autonumber
Note right of Producer: Produceråˆå§‹åŒ–
Producer-&gt;&gt; Producer: KafkaProducerå®ä¾‹åŒ–ï¼Œä¼ å…¥propsé…ç½®ä¿¡æ¯
Producer-&gt;&gt; KafkaProducer: KafkaProducerå®ä¾‹åŒ–ï¼Œä¼ å…¥propsé…ç½®ä¿¡æ¯
KafkaProducer-&gt;&gt; ProducerConfig: ProducerConfigåˆå§‹åŒ–é…ç½®å¹¶éªŒè¯å‚æ•°ä¿¡æ¯
KafkaProducer-&gt;&gt; KafkaProducer: è·å–clientIdå±æ€§ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„id
KafkaProducer-&gt;&gt; KafkaProducer: ä»é…ç½®ä¸­è·å–åˆ†åŒºå™¨ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤åˆ†åŒºå™¨
KafkaProducer-&gt;&gt; KafkaProducer: è·å–é‡è¯•çš„é—´éš”æ—¶é—´ï¼Œé»˜è®¤100ms
KafkaProducer-&gt;&gt; KafkaProducer: è·å–åºåˆ—åŒ–å™¨
KafkaProducer-&gt;&gt; KafkaProducer: åˆå§‹åŒ–metadataå…ƒæ•°æ®ï¼Œå¹¶è®¾ç½®é›†ç¾¤èµ„æºç›‘å¬å™¨
KafkaProducer-&gt;&gt; KafkaProducer: åˆå§‹åŒ–ç¼“å­˜å¯¹è±¡accumulatorï¼Œç”¨äºç¼“å­˜å¾…å‘é€çš„è®°å½•
KafkaProducer-&gt;&gt; KafkaProducer: æ›´æ–°å…ƒæ•°æ®ï¼Œè®¾ç½®clusterä¿¡æ¯ï¼Œclusterä¿¡æ¯æ¥è‡ªäºé…ç½®æ–‡ä»¶ä¸­çš„bootstrap.servers
KafkaProducer-&gt;&gt; KafkaProducer: åˆå§‹åŒ–ç½‘ç»œå®¢æˆ·ç«¯ï¼Œç”¨äºå‘é€è¯·æ±‚ã€‚
KafkaProducer-&gt;&gt; KafkaProducer: åˆå§‹åŒ–ç½‘ç»œçº¿ç¨‹senderï¼Œç”¨äºå‘é€è¯·æ±‚ã€‚
KafkaProducer-&gt;&gt; KafkaProducer: å¯åŠ¨Kafkaç½‘ç»œçº¿ç¨‹this.ioThread.start();




ç”Ÿäº§è€…æ„é€ å‡½æ•°

/** * ç”Ÿäº§è€…æ„é€ å‡½æ•° * topic: ä¸»é¢˜åç§° * isAsync: æ˜¯å¦å¼‚æ­¥å‘é€ * * @param topic * @param isAsync */public Producer(String topic, Boolean isAsync) &#123;    Properties props = new Properties();    // è¿æ¥kafkaé›†ç¾¤åœ°å€ï¼Œè¿™é‡Œä½¿ç”¨é»˜è®¤é…ç½®ï¼šlocalhost:9092    props.put(&quot;bootstrap.servers&quot;, KafkaProperties.KAFKA_SERVER_URL + &quot;:&quot; + KafkaProperties.KAFKA_SERVER_PORT);    // client.id: å®¢æˆ·ç«¯IDï¼Œç”¨äºæ ‡è¯†å½“å‰ç”Ÿäº§è€…å®ä¾‹    props.put(&quot;client.id&quot;, &quot;DemoProducer&quot;);    // key.serializer: keyåºåˆ—åŒ–å™¨ï¼Œè¿™é‡Œä½¿ç”¨IntegerSerializer    // value.serializer: valueåºåˆ—åŒ–å™¨ï¼Œè¿™é‡Œä½¿ç”¨StringSerializer    props.put(&quot;key.serializer&quot;, &quot;org.apache.kafka.common.serialization.IntegerSerializer&quot;);    props.put(&quot;value.serializer&quot;, &quot;org.apache.kafka.common.serialization.StringSerializer&quot;);    // KafkaProducerå®ä¾‹åŒ–ï¼Œä¼ å…¥é…ç½®ä¿¡æ¯    producer = new KafkaProducer&lt;&gt;(props);    this.topic = topic;    this.isAsync = isAsync;&#125;


æ„å»ºKafkaProducer
   /**  * é€šè¿‡æä¾›ä¸€ç»„é”®å€¼å¯¹ä½œä¸ºé…ç½®æ¥å®ä¾‹åŒ–åˆ›å»ºè€…ã€‚æœ‰æ•ˆçš„é…ç½®å­—ç¬¦ä¸²  * è®°å½•åœ¨ &lt;a href=â€œhttp://kafka.apache.org/documentation.html#producerconfigsâ€&gt;è¿™é‡Œ&lt;/a&gt;ã€‚  * @param properties   ç”Ÿäº§è€…é…ç½®  */ public KafkaProducer(Properties properties) &#123;     this(new ProducerConfig(properties), null, null); &#125;/**  * é€šè¿‡æä¾›ä¸€ç»„é”®å€¼å¯¹ä½œä¸ºé…ç½®ã€ä¸€ä¸ªé”®å’Œä¸€ä¸ªå€¼ &#123;@link Serializer&#125; æ¥å®ä¾‹åŒ–ç”Ÿäº§è€…ã€‚  * æ­¤å¤„è®°å½•äº†æœ‰æ•ˆçš„é…ç½®å­—ç¬¦ä¸²&lt;a href=â€œhttp://kafka.apache.org/documentation.html#producerconfigsâ€&gt;&lt;/a&gt;ã€‚  * @param properties ç”Ÿäº§è€…é…ç½®  * @param keySerializer å®ç° &#123;@link Serializer&#125; çš„ key çš„åºåˆ—åŒ–å™¨ã€‚configureï¼ˆï¼‰ æ–¹æ³•ä¸ä¼šæ˜¯  * åœ¨ç›´æ¥ä¼ å…¥åºåˆ—åŒ–ç¨‹åºæ—¶åœ¨ producer ä¸­è°ƒç”¨ã€‚  * @param valueSerializer å®ç° &#123;@link Serializer&#125; çš„å€¼çš„åºåˆ—åŒ–å™¨ã€‚configureï¼ˆï¼‰ æ–¹æ³•ä¸ä¼š  * å½“ç›´æ¥ä¼ å…¥åºåˆ—åŒ–ç¨‹åºæ—¶ï¼Œåœ¨ producer ä¸­è°ƒç”¨ã€‚  */ public KafkaProducer(Properties properties, Serializer&lt;K&gt; keySerializer, Serializer&lt;V&gt; valueSerializer) &#123;     this(new ProducerConfig(ProducerConfig.addSerializerToConfig(properties, keySerializer, valueSerializer)),          keySerializer, valueSerializer); &#125;    

KafkaProducerå®ä¾‹åŒ–


private KafkaProducer(ProducerConfig config, Serializer&lt;K&gt; keySerializer, Serializer&lt;V&gt; valueSerializer) &#123;    try &#123;        log.trace(&quot;Starting the Kafka producer&quot;);        Map&lt;String, Object&gt; userProvidedConfigs = config.originals();        this.producerConfig = config;        this.time = Time.SYSTEM;        // è·å–clientIdå±æ€§ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„id        clientId = config.getString(ProducerConfig.CLIENT_ID_CONFIG);        if (clientId.length() &lt;= 0)            clientId = &quot;producer-&quot; + PRODUCER_CLIENT_ID_SEQUENCE.getAndIncrement();        // æŒ‡æ ‡ã€ç›‘æ§ç›¸å…³ä»£ç         Map&lt;String, String&gt; metricTags = new LinkedHashMap&lt;String, String&gt;();        metricTags.put(&quot;client-id&quot;, clientId);        MetricConfig metricConfig = new MetricConfig().samples(config.getInt(ProducerConfig.METRICS_NUM_SAMPLES_CONFIG))                .timeWindow(config.getLong(ProducerConfig.METRICS_SAMPLE_WINDOW_MS_CONFIG), TimeUnit.MILLISECONDS)                .tags(metricTags);        List&lt;MetricsReporter&gt; reporters = config.getConfiguredInstances(ProducerConfig.METRIC_REPORTER_CLASSES_CONFIG,                MetricsReporter.class);        reporters.add(new JmxReporter(JMX_PREFIX));        this.metrics = new Metrics(metricConfig, reporters, time);        // ä»é…ç½®ä¸­è·å–åˆ†åŒºå™¨ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤åˆ†åŒºå™¨        this.partitioner = config.getConfiguredInstance(ProducerConfig.PARTITIONER_CLASS_CONFIG, Partitioner.class);        // è·å–é‡è¯•çš„é—´éš”æ—¶é—´ï¼Œé»˜è®¤100ms        long retryBackoffMs = config.getLong(ProducerConfig.RETRY_BACKOFF_MS_CONFIG);        // è·å–åºåˆ—åŒ–å™¨        if (keySerializer == null) &#123;            this.keySerializer = config.getConfiguredInstance(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,                    Serializer.class);            this.keySerializer.configure(config.originals(), true);        &#125; else &#123;            config.ignore(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG);            this.keySerializer = keySerializer;        &#125;        if (valueSerializer == null) &#123;            this.valueSerializer = config.getConfiguredInstance(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,                    Serializer.class);            this.valueSerializer.configure(config.originals(), false);        &#125; else &#123;            config.ignore(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG);            this.valueSerializer = valueSerializer;        &#125;        // è®¾ç½®æ‹¦æˆªå™¨        userProvidedConfigs.put(ProducerConfig.CLIENT_ID_CONFIG, clientId);        List&lt;ProducerInterceptor&lt;K, V&gt;&gt; interceptorList = (List) (new ProducerConfig(userProvidedConfigs, false)).getConfiguredInstances(ProducerConfig.INTERCEPTOR_CLASSES_CONFIG,                ProducerInterceptor.class);        this.interceptors = interceptorList.isEmpty() ? null : new ProducerInterceptors&lt;&gt;(interceptorList);        // é›†ç¾¤èµ„æºç›‘å¬å™¨        ClusterResourceListeners clusterResourceListeners = configureClusterResourceListeners(keySerializer, valueSerializer, interceptorList, reporters);        /**         * åˆå§‹åŒ–metadataå…ƒæ•°æ®ç»“æ„ï¼Œå¹¶è®¾ç½®é›†ç¾¤èµ„æºç›‘å¬å™¨         * retryBackoffMs:é‡è¯•çš„é—´éš”æ—¶é—´ï¼Œé»˜è®¤100ms         * metadataMaxAgeMs:å…ƒæ•°æ®æœ€å¤§å­˜æ´»æ—¶é—´ï¼Œé»˜è®¤5åˆ†é’Ÿ         * allowAutoTopicCreation:æ˜¯å¦å…è®¸è‡ªåŠ¨åˆ›å»ºä¸»é¢˜ï¼Œé»˜è®¤true         * clusterResourceListeners:é›†ç¾¤èµ„æºç›‘å¬å™¨         */        this.metadata = new Metadata(retryBackoffMs, config.getLong(ProducerConfig.METADATA_MAX_AGE_CONFIG), true, clusterResourceListeners);        /**         * è·å–maxRequestSizeå±æ€§ï¼Œ(æœ€å¤§è¯·æ±‚å¤§å°)ï¼Œé»˜è®¤1M         * è·å–totalMemorySizeå±æ€§ï¼Œ(ç¼“å†²åŒºæ€»å¤§å°)ï¼Œé»˜è®¤32M         * è·å–compressionTypeå±æ€§ï¼Œ(å‹ç¼©ç±»å‹)ï¼Œé»˜è®¤none         */        this.maxRequestSize = config.getInt(ProducerConfig.MAX_REQUEST_SIZE_CONFIG);        this.totalMemorySize = config.getLong(ProducerConfig.BUFFER_MEMORY_CONFIG);        this.compressionType = CompressionType.forName(config.getString(ProducerConfig.COMPRESSION_TYPE_CONFIG));        /* æ£€æŸ¥ç”¨æˆ·å®šä¹‰çš„è®¾ç½®ã€‚         * å¦‚æœ BLOCK_ON_BUFFER_FULL è®¾ç½®ä¸º trueï¼Œåˆ™ä¸æ‰§è¡Œ METADATA_FETCH_TIMEOUT_CONFIGã€‚         * å½“å·²å¼ƒç”¨çš„é…ç½®è¢«åˆ é™¤æ—¶ï¼Œè¿™åº”è¯¥åœ¨ 0.9 ç‰ˆæœ¬ä¸­åˆ é™¤ã€‚         */        if (userProvidedConfigs.containsKey(ProducerConfig.BLOCK_ON_BUFFER_FULL_CONFIG)) &#123;            log.warn(ProducerConfig.BLOCK_ON_BUFFER_FULL_CONFIG + &quot; config is deprecated and will be removed soon. &quot; +                    &quot;Please use &quot; + ProducerConfig.MAX_BLOCK_MS_CONFIG);            boolean blockOnBufferFull = config.getBoolean(ProducerConfig.BLOCK_ON_BUFFER_FULL_CONFIG);            if (blockOnBufferFull) &#123;                this.maxBlockTimeMs = Long.MAX_VALUE;            &#125; else if (userProvidedConfigs.containsKey(ProducerConfig.METADATA_FETCH_TIMEOUT_CONFIG)) &#123;                log.warn(ProducerConfig.METADATA_FETCH_TIMEOUT_CONFIG + &quot; config is deprecated and will be removed soon. &quot; +                        &quot;Please use &quot; + ProducerConfig.MAX_BLOCK_MS_CONFIG);                this.maxBlockTimeMs = config.getLong(ProducerConfig.METADATA_FETCH_TIMEOUT_CONFIG);            &#125; else &#123;                this.maxBlockTimeMs = config.getLong(ProducerConfig.MAX_BLOCK_MS_CONFIG);            &#125;        &#125; else if (userProvidedConfigs.containsKey(ProducerConfig.METADATA_FETCH_TIMEOUT_CONFIG)) &#123;            // è·å–å…ƒæ•°æ®è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤60s            log.warn(ProducerConfig.METADATA_FETCH_TIMEOUT_CONFIG + &quot; config is deprecated and will be removed soon. &quot; +                    &quot;Please use &quot; + ProducerConfig.MAX_BLOCK_MS_CONFIG);            this.maxBlockTimeMs = config.getLong(ProducerConfig.METADATA_FETCH_TIMEOUT_CONFIG);        &#125; else &#123;            // è·å–æœ€å¤§é˜»å¡æ—¶é—´ï¼Œé»˜è®¤60s            this.maxBlockTimeMs = config.getLong(ProducerConfig.MAX_BLOCK_MS_CONFIG);        &#125;        /* æ£€æŸ¥ç”¨æˆ·å®šä¹‰çš„è®¾ç½®ã€‚         * å¦‚æœè®¾ç½®äº† TIME_OUT é…ç½®ï¼Œè¯·å°†å…¶ç”¨äºè¯·æ±‚è¶…æ—¶ã€‚         * è¿™åº”è¯¥åœ¨ 0.9 ç‰ˆä¸­åˆ é™¤         */        if (userProvidedConfigs.containsKey(ProducerConfig.TIMEOUT_CONFIG)) &#123;            log.warn(ProducerConfig.TIMEOUT_CONFIG + &quot; config is deprecated and will be removed soon. Please use &quot; +                    ProducerConfig.REQUEST_TIMEOUT_MS_CONFIG);            this.requestTimeoutMs = config.getInt(ProducerConfig.TIMEOUT_CONFIG);        &#125; else &#123;            // è·å–è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤30s            this.requestTimeoutMs = config.getInt(ProducerConfig.REQUEST_TIMEOUT_MS_CONFIG);        &#125;        // åˆå§‹åŒ–ç¼“å­˜å¯¹è±¡ï¼Œç”¨äºç¼“å­˜å¾…å‘é€çš„è®°å½•ã€‚        this.accumulator = new RecordAccumulator(config.getInt(ProducerConfig.BATCH_SIZE_CONFIG),                this.totalMemorySize,                this.compressionType,                config.getLong(ProducerConfig.LINGER_MS_CONFIG),                retryBackoffMs,                metrics,                time);        // æ›´æ–°å…ƒæ•°æ®ï¼Œè®¾ç½®clusterä¿¡æ¯ï¼Œclusterä¿¡æ¯æ¥è‡ªäºé…ç½®æ–‡ä»¶ä¸­çš„bootstrap.servers        List&lt;InetSocketAddress&gt; addresses = ClientUtils.parseAndValidateAddresses(config.getList(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG));        this.metadata.update(Cluster.bootstrap(addresses), Collections.&lt;String&gt;emptySet(), time.milliseconds());        /**         * åˆå§‹åŒ–ç®¡ç†ç½‘ç»œç»„ä»¶NetworkClient         * connections.max.idle.ms : è¿æ¥æœ€å¤§ç©ºé—²æ—¶é—´ï¼Œé»˜è®¤9åˆ†é’Ÿ         * max.in.flight.requests.per.connection : å•ä¸ªè¿æ¥æœ€å¤§æœªç¡®è®¤è¯·æ±‚æ•°ï¼Œé»˜è®¤5ã€‚å¦‚æœéœ€è¦æœ‰åºï¼Œéœ€è¦è®¾ç½®ï¼šä¸º1         * reconnect.backoff.ms : é‡è¿é—´éš”æ—¶é—´ï¼Œé»˜è®¤50æ¯«ç§’         * send.buffer.bytes : å‘é€ç¼“å†²åŒºå¤§å°ï¼Œé»˜è®¤128K         * receive.buffer.bytes : æ¥æ”¶ç¼“å†²åŒºå¤§å°ï¼Œé»˜è®¤32K         * requestTimeoutMsï¼šè¯·æ±‚è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤5åˆ†é’Ÿ         */        ChannelBuilder channelBuilder = ClientUtils.createChannelBuilder(config.values());        NetworkClient client = new NetworkClient(                new Selector(config.getLong(ProducerConfig.CONNECTIONS_MAX_IDLE_MS_CONFIG), this.metrics, time, &quot;producer&quot;, channelBuilder),                this.metadata,                clientId,                config.getInt(ProducerConfig.MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION),                config.getLong(ProducerConfig.RECONNECT_BACKOFF_MS_CONFIG),                config.getInt(ProducerConfig.SEND_BUFFER_CONFIG),                config.getInt(ProducerConfig.RECEIVE_BUFFER_CONFIG),                this.requestTimeoutMs,                time,                true);        /**         *  åˆå§‹åŒ–ç½‘ç»œSenderçº¿ç¨‹ï¼Œç”¨äºå‘é€è¯·æ±‚ã€‚         *  acksï¼šç¡®è®¤æ¨¡å¼ï¼šé»˜è®¤å€¼ä¸ºï¼š1         *      0ï¼šä¸ç¡®è®¤ï¼Œå³ä½¿é›†ç¾¤ä¸­æœ‰leaderï¼Œä¹Ÿä¸ä¼šç­‰å¾…ç¡®è®¤ã€‚         *      1ï¼šleaderç¡®è®¤ï¼Œå³ä½¿é›†ç¾¤ä¸­æœ‰followerï¼Œä¹Ÿä¸ä¼šç­‰å¾…ç¡®è®¤ã€‚         *      2ï¼šleaderå’Œfolloweréƒ½ç¡®è®¤ï¼Œç­‰å¾…æ‰€æœ‰å‰¯æœ¬ç¡®è®¤ã€‚         * retriesï¼šé‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤å€¼ä¸ºï¼š0ã€‚         */        this.sender = new Sender(client,                this.metadata,                this.accumulator,                config.getInt(ProducerConfig.MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION) == 1,                config.getInt(ProducerConfig.MAX_REQUEST_SIZE_CONFIG),                (short) parseAcks(config.getString(ProducerConfig.ACKS_CONFIG)),                config.getInt(ProducerConfig.RETRIES_CONFIG),                this.metrics,                Time.SYSTEM,                this.requestTimeoutMs);        String ioThreadName = &quot;kafka-producer-network-thread&quot; + (clientId.length() &gt; 0 ? &quot; | &quot; + clientId : &quot;&quot;);        // å¯åŠ¨Kafkaç½‘ç»œçº¿ç¨‹        this.ioThread = new KafkaThread(ioThreadName, this.sender, true);        this.ioThread.start();        this.errors = this.metrics.sensor(&quot;errors&quot;);        config.logUnused();        AppInfoParser.registerAppInfo(JMX_PREFIX, clientId);        log.debug(&quot;Kafka producer started&quot;);    &#125; catch (Throwable t) &#123;        // this is to prevent resource leak. see KAFKA-2121        close(0, TimeUnit.MILLISECONDS, true);        throw new KafkaException(&quot;Failed to construct kafka producer&quot;, t);    &#125;&#125;]]></content>
      <categories>
        <category>Kafka</category>
      </categories>
      <tags>
        <tag>Kafka</tag>
        <tag>Kafkaæºç åˆ†æ</tag>
      </tags>
  </entry>
  <entry>
    <title>Kafkaæºç åˆ†æ(å››)Producerç”Ÿäº§è€…æ‰§è¡Œæµç¨‹</title>
    <url>/Kafka%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/Kafka%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E5%9B%9B)Producer%E7%94%9F%E4%BA%A7%E8%80%85%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B/</url>
    <content><![CDATA[Kafkaæºç åˆ†æ(å››)Producerç”Ÿäº§è€…æ‰§è¡Œæµç¨‹ä¸€ã€å‰è¨€
ä»£ç çš„å…¥å£mainæ–¹æ³•ä¸­Producerç±»æ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹ï¼Œåœ¨mainä¸­å¯¹producerThreadè¿›è¡Œstartã€‚è¡¨ç¤ºå¼€å§‹äº†è¿™ä¸ªçº¿ç¨‹ï¼ŒProducerç±»ä¸­çš„runæ–¹æ³•è¢«è·å¾—è¢«æ‰§è¡Œã€‚

public class KafkaConsumerProducerDemo &#123;    public static void main(String[] args) &#123;        // åˆ¤æ–­æ˜¯å¦æ˜¯å¼‚æ­¥ï¼šå¦‚æœå‚æ•°ä¸ªæ•°ä¸º0ï¼Œæˆ–è€…ç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯&quot;sync&quot;ï¼Œåˆ™æ˜¯å¼‚æ­¥ã€‚ç”Ÿäº§ç¯å¢ƒä¸€èˆ¬æ˜¯å¼‚æ­¥çš„æ•°æ®å¤„ç†ã€‚        boolean isAsync = args.length == 0 || !args[0].trim().equalsIgnoreCase(&quot;sync&quot;);        Producer producerThread = new Producer(KafkaProperties.TOPIC, isAsync);        producerThread.start();        Consumer consumerThread = new Consumer(KafkaProperties.TOPIC);        consumerThread.start();    &#125;&#125;

äºŒã€Producerè·å–å…ƒæ•°æ®æµç¨‹å›¾
Produceræµç¨‹å›¾



è·å–å…ƒç´ æµç¨‹å›¾
  

Brokerå’ŒPartitionå…³ç³»å›¾
  




sequenceDiagram
autonumber
Producer -&gt;&gt; Producer: run()æ–¹æ³•
Producer -&gt;&gt; KafkaProducer:send()
KafkaProducer -&gt;&gt; KafkaProducer: æ‰§è¡Œæ‹¦æˆªå™¨
Note right of KafkaProducer : Producerå”¤é†’senderçº¿ç¨‹ç­‰å¾…å…ƒæ•°æ®æ›´æ–°
KafkaProducer -&gt;&gt; KafkaProducer: ä»æœåŠ¡ç«¯è·å–metadataæ•°æ®
	KafkaProducer -&gt;&gt; Metadata: å°†topicæ·»åŠ åˆ°metadataåˆ—è¡¨ï¼Œå¦‚æœåˆ—è¡¨ä¸­ä¸å­˜åœ¨topicï¼Œåˆ™æŠŠå±æ€§needUpdateè®¾ç½®ä¸ºï¼štrue
	KafkaProducer -&gt;&gt; KafkaProducer: ä»ç¼“å­˜ä¸­è·å–metadataæ•°æ®ï¼Œå¦‚æœå­˜åœ¨å·²ç»å­˜åœ¨ç¼“å­˜çš„æ•°æ®ï¼Œç›´æ¥è¿”å›æµç¨‹ç»“æŸ
  loop topicä¸»é¢˜åˆ†åŒºæ•°é‡ï¼špartitionsCount
      KafkaProducer -&gt;&gt; Metadata: å±æ€§needUpdateè®¾ç½®ä¸ºï¼štrue
      KafkaProducer --&gt;&gt; Sender: å”¤é†’senderçº¿ç¨‹
      KafkaProducer -&gt;&gt; Metadata: ç­‰å¾…å…ƒæ•°æ®æ›´æ–°ï¼Œç›´åˆ°å½“å‰ç‰ˆæœ¬å¤§äºæˆ‘ä»¬æ‰€çŸ¥é“çš„æœ€åä¸€ä¸ªç‰ˆæœ¬ï¼Œæˆ–è€…ç­‰å¾…è¶…æ—¶
  end
  
loop Senderçº¿ç¨‹while trueæ­»å¾ªç¯
			Note right of NetworkClient: è·å–å¹¶éªŒè¯apiVersionç‰ˆæœ¬ï¼šhandleInitiateApiVersionRequests()] 
			Sender -&gt;&gt; NetworkClient: å½“Producerçº¿ç¨‹æŠŠneedUpdateè®¾ç½®ä¸ºtrueæ—¶ï¼Œ&lt;br&#x2F;&gt;è¯´æ˜éœ€è¦æ›´æ–°metadataä¿¡æ¯
			NetworkClient -&gt;&gt; NetworkClient: ç¬¬ä¸€æ¬¡åˆå§‹åŒ–ç½‘ç»œè¿æ¥ï¼šinitiateConnect
			NetworkClient -&gt;&gt; NetworkClient: ç½‘ç»œè¿æ¥å·²ç»å®Œæˆåï¼Œæ³¨å†Œç‰ˆæœ¬æ·»åŠ ä¸€ä¸ªwriteå†™çš„äº‹ä»¶
			NetworkClient -&gt;&gt; NetworkClient : handleInitiateApiVersionRequests()å¤„ç†apiVersionè¯·æ±‚ã€‚
			NetworkClient -&gt;&gt; NetworkClient : å†æ¬¡å¾ªç¯handleApiVersionsResponse()æˆåŠŸæ ¡éªŒapiVersionç‰ˆæœ¬ï¼Œå¹¶ä¿®æ”¹è¿æ¥çŠ¶æ€ä¸ºready
			Note right of NetworkClient: å…ƒæ•°æ®è·å–
			NetworkClient -&gt;&gt; NetworkClient : æ„å»ºè·å–å…ƒæ•°æ®è¯·æ±‚å‚æ•°sendInternalMetadataRequest
			NetworkClient -&gt;&gt; NetworkClient : å¤„ç†è¿”å›å€¼handleCompletedMetadataResponseæ›´æ–°å…ƒç´ æ•°æ®metadataå¯¹è±¡ï¼Œç‰ˆæœ¬å·+1
			NetworkClient --&gt;&gt; Producer: notifyAllï¼Œå”¤é†’Producerä¸»çº¿ç¨‹
			Sender -&gt;&gt; Sender: è·å–å·²å‡†å¤‡å¥½å‘é€æ•°æ®çš„åˆ†åŒºè¯·æ±‚
			Sender -&gt;&gt; Sender: åˆ¤æ–­èŠ‚ç‚¹æœ‰æ²¡æœ‰å‡†å¤‡å¥½ï¼Œå¹¶ç§»é™¤æ²¡æœ‰å‡†å¤‡çš„èŠ‚ç‚¹
			Sender -&gt;&gt; NetworkClient: å¦‚æœæ²¡æœ‰å»ºç«‹è¿æ¥ -&gt; åˆå§‹åŒ–ç½‘ç»œè¿æ¥
			NetworkClient -&gt;&gt; Selector: å»ºç«‹è¿æ¥æ³¨å†Œçš„OP_CONNECTäº‹ä»¶
			Sender -&gt;&gt; Sender: å‡†å¤‡å¾…å‘é€è¯·æ±‚çš„æ•°æ®
			Sender -&gt;&gt; NetworkClient: æ‰§è¡Œç½‘ç»œè¯·æ±‚poll
			NetworkClient -&gt;&gt; NetworkClient: å°è£…è¦æ‹‰å–å…ƒæ•°æ®çš„è¯·æ±‚
			NetworkClient -&gt;&gt; NetworkClient: å¤„ç†è¿”å›è¯·æ±‚çš„æ“ä½œï¼ŒåŒ…æ‹¬ï¼š&lt;br&#x2F;&gt;å¤„ç†è¢«ä¸­æ­¢çš„å‘é€è¯·æ±‚ã€&lt;br&#x2F;&gt;å¤„ç†å·²å®Œæˆçš„å‘é€è¯·æ±‚ã€&lt;br&#x2F;&gt;å¤„ç†ä»Brokeræ¥æ”¶åˆ°çš„å“åº”ã€&lt;br&#x2F;&gt;å¤„ç†è¿æ¥æ–­å¼€äº‹ä»¶ã€&lt;br&#x2F;&gt;å»ºç«‹æ–°è¿æ¥ã€&lt;br&#x2F;&gt;å¤„ç†APIç‰ˆæœ¬åå•†è¯·æ±‚ã€&lt;br&#x2F;&gt;å¤„ç†è¶…æ—¶è¯·æ±‚
			NetworkClient -&gt;&gt; NetworkClient: æ‰§è¡Œå›è°ƒå‡½æ•°
			
	end	
	
KafkaProducer -&gt;&gt; KafkaProducer: å¯¹æ¶ˆæ¯keyå’Œvalueè¿›è¡Œåºåˆ—åŒ–
KafkaProducer -&gt;&gt; KafkaProducer: æ ¹æ®åˆ†åŒºç­–ç•¥è·å–æ¶ˆæ¯å‘é€çš„åˆ†åŒº
%% é»˜è®¤åˆ†åŒºç­–ç•¥ï¼ˆDefaultPartitioner.javaï¼‰
%% è·å¾—topicçš„åˆ†åŒºçš„æ•°é‡
%% å¦‚æœæ²¡æœ‰æŒ‡å®škeyï¼Œåˆ™ç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼Œæ­£æ•´æ•°ï¼Œç„¶åå–æ¨¡è·å¾—åˆ†åŒºå·ã€‚
%% æœ‰æŒ‡å®škeyï¼ŒæŠŠkeyçš„å­—èŠ‚æ•°ç»„ç”¨hashç®—æ³•ç”Ÿæˆä¸€ä¸ªæ•´æ•°ï¼Œç„¶åå–æ¨¡è·å¾—åˆ†åŒºå·ã€‚
KafkaProducer -&gt;&gt; KafkaProducer: è·å–åºåˆ—åŒ–åçš„æ¶ˆæ¯å¤§å°å¹¶éªŒè¯å¤§å°æ˜¯å¦è¶…è¿‡é»˜è®¤1Mé™åˆ¶
KafkaProducer -&gt;&gt; KafkaProducer: ç»‘å®šæ‹¦æˆªå™¨å’Œå›è°ƒå‡½æ•°
KafkaProducer -&gt;&gt; KafkaProducer: æ¶ˆæ¯æ·»åŠ åˆ°Accumulatorä¸­ï¼ŒAccumulatorè´Ÿè´£å°†æ¶ˆæ¯åˆ†æˆå¤šä¸ªæ‰¹æ¬¡ï¼Œå¹¶å°†æ¶ˆæ¯å‘é€åˆ°Kafkaé›†ç¾¤
KafkaProducer -&gt;&gt; KafkaProducer: å¦‚æœAccumulatorä¸­ç¼“å­˜çš„æ¶ˆæ¯æ•°é‡å·²æ»¡æˆ–å·²åˆ›å»ºæ–°çš„æ‰¹æ¬¡ï¼Œåˆ™å”¤é†’senderçº¿ç¨‹
KafkaProducer -&gt;&gt; KafkaProducer: è¿”å›RecordMetadataFutureï¼Œç”¨äºè·å–æ¶ˆæ¯å‘é€ç»“æœ



ä¸‰ã€æºä»£ç åˆ†æ
Producer ä¸»çº¿ç¨‹
  public class Producer extends Thread &#123;    private final KafkaProducer&lt;Integer, String&gt; producer;    private final String topic;    private final Boolean isAsync;    /**     * ç”Ÿäº§è€…æ„é€ å‡½æ•°     * topic: ä¸»é¢˜åç§°     * isAsync: æ˜¯å¦å¼‚æ­¥å‘é€     *     * @param topic     * @param isAsync     */    public Producer(String topic, Boolean isAsync) &#123;        Properties props = new Properties();        // è¿æ¥kafkaé›†ç¾¤åœ°å€ï¼Œè¿™é‡Œä½¿ç”¨é»˜è®¤é…ç½®ï¼šlocalhost:9092        props.put(&quot;bootstrap.servers&quot;, KafkaProperties.KAFKA_SERVER_URL + &quot;:&quot; + KafkaProperties.KAFKA_SERVER_PORT);        // client.id: å®¢æˆ·ç«¯IDï¼Œç”¨äºæ ‡è¯†å½“å‰ç”Ÿäº§è€…å®ä¾‹        props.put(&quot;client.id&quot;, &quot;DemoProducer&quot;);        // key.serializer: keyåºåˆ—åŒ–å™¨ï¼Œè¿™é‡Œä½¿ç”¨IntegerSerializer        // value.serializer: valueåºåˆ—åŒ–å™¨ï¼Œè¿™é‡Œä½¿ç”¨StringSerializer        props.put(&quot;key.serializer&quot;, &quot;org.apache.kafka.common.serialization.IntegerSerializer&quot;);        props.put(&quot;value.serializer&quot;, &quot;org.apache.kafka.common.serialization.StringSerializer&quot;);        // KafkaProducerå®ä¾‹åŒ–, ä¼ å…¥é…ç½®ä¿¡æ¯        producer = new KafkaProducer&lt;&gt;(props);        this.topic = topic;        this.isAsync = isAsync;    &#125;    public void run() &#123;        int messageNo = 1;        while (true) &#123;            String messageStr = &quot;Message_&quot; + messageNo;            long startTime = System.currentTimeMillis();            if (isAsync) &#123; // Send asynchronously                producer.send(new ProducerRecord&lt;&gt;(topic,                    messageNo,                    messageStr), new DemoCallBack(startTime, messageNo, messageStr));            &#125; else &#123; // Send synchronously                try &#123;                    producer.send(new ProducerRecord&lt;&gt;(topic,                        messageNo,                        messageStr)).get();                    System.out.println(&quot;Sent message: (&quot; + messageNo + &quot;, &quot; + messageStr + &quot;)&quot;);                &#125; catch (InterruptedException | ExecutionException e) &#123;                    e.printStackTrace();                &#125;            &#125;            ++messageNo;        &#125;    &#125;&#125;

KafkaProducer.send() å‘é€æ¶ˆæ¯ä¹‹å‰ï¼Œå…ˆå°†æ¶ˆæ¯æ‹¦æˆªå™¨æ‹¦æˆª
      @Overridepublic Future&lt;RecordMetadata&gt; send(ProducerRecord&lt;K, V&gt; record, Callback callback) &#123;    // å‘é€æ¶ˆæ¯ä¹‹å‰ï¼Œå…ˆå°†æ¶ˆæ¯æ‹¦æˆªå™¨æ‹¦æˆª    // intercept the record, which can be potentially modified; this method does not throw exceptions    ProducerRecord&lt;K, V&gt; interceptedRecord = this.interceptors == null ? record : this.interceptors.onSend(record);    // å‘é€æ¶ˆæ¯    return doSend(interceptedRecord, callback);&#125;    

KafkaProducer.doSend() å‘é€æ¶ˆæ¯
  private Future&lt;RecordMetadata&gt; doSend(ProducerRecord&lt;K, V&gt; record, Callback callback) &#123;    TopicPartition tp = null;    try &#123;        // ä»æœåŠ¡ç«¯è·å–å…ƒæ•°æ®ï¼šmaxBlockTimeMsï¼šæœ€å¤§é˜»å¡æ—¶é—´ï¼Œé»˜è®¤60s        ClusterAndWaitTime clusterAndWaitTime = waitOnMetadata(record.topic(), record.partition(), maxBlockTimeMs);        // remainingWaitMsï¼ˆå‰©ä½™å¯ç”¨æ—¶é—´ï¼‰ = maxBlockTimeMsï¼ˆæœ€å¤§é˜»å¡æ—¶é—´ï¼‰ - clusterAndWaitTime.waitedOnMetadataMs(ä¸Šæ¬¡è·å–å…ƒæ•°æ®è€—æ—¶)        long remainingWaitMs = Math.max(0, maxBlockTimeMs - clusterAndWaitTime.waitedOnMetadataMs);        Cluster cluster = clusterAndWaitTime.cluster;            // å¯¹æ¶ˆæ¯keyå’Œvalueè¿›è¡Œåºåˆ—åŒ–        byte[] serializedKey;        try &#123;            serializedKey = keySerializer.serialize(record.topic(), record.key());        &#125; catch (ClassCastException cce) &#123;            throw new SerializationException(&quot;Can&#x27;t convert key of class &quot; + record.key().getClass().getName() +                    &quot; to class &quot; + producerConfig.getClass(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG).getName() +                    &quot; specified in key.serializer&quot;);        &#125;        byte[] serializedValue;        try &#123;            serializedValue = valueSerializer.serialize(record.topic(), record.value());        &#125; catch (ClassCastException cce) &#123;            throw new SerializationException(&quot;Can&#x27;t convert value of class &quot; + record.value().getClass().getName() +                    &quot; to class &quot; + producerConfig.getClass(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG).getName() +                    &quot; specified in value.serializer&quot;);        &#125;            // æ ¹æ®åˆ†åŒºç­–ç•¥è·å–æ¶ˆæ¯å‘é€çš„åˆ†åŒº        int partition = partition(record, serializedKey, serializedValue, cluster);            // è·å–åºåˆ—åŒ–åçš„æ¶ˆæ¯å¤§å°        int serializedSize = Records.LOG_OVERHEAD + Record.recordSize(serializedKey, serializedValue);            // éªŒè¯æ¶ˆæ¯å¤§å°æ˜¯å¦è¶…å‡ºé™åˆ¶ï¼Œé»˜è®¤1M        ensureValidRecordSize(serializedSize);        tp = new TopicPartition(record.topic(), partition);        long timestamp = record.timestamp() == null ? time.milliseconds() : record.timestamp();        log.trace(&quot;Sending record &#123;&#125; with callback &#123;&#125; to topic &#123;&#125; partition &#123;&#125;&quot;, record, callback, record.topic(), partition);        // producer callback will make sure to call both &#x27;callback&#x27; and interceptor callback            // ç»‘å®šæ‹¦æˆªå™¨å’Œå›è°ƒå‡½æ•°        Callback interceptCallback = this.interceptors == null ? callback : new InterceptorCallback&lt;&gt;(callback, this.interceptors, tp);        // æ¶ˆæ¯æ·»åŠ åˆ°Accumulatorä¸­ï¼ŒAccumulatorè´Ÿè´£å°†æ¶ˆæ¯åˆ†æˆå¤šä¸ªæ‰¹æ¬¡ï¼Œå¹¶å°†æ¶ˆæ¯å‘é€åˆ°Kafkaé›†ç¾¤        RecordAccumulator.RecordAppendResult result = accumulator.append(tp, timestamp, serializedKey, serializedValue, interceptCallback, remainingWaitMs);            // å¦‚æœAccumulatorä¸­ç¼“å­˜çš„æ¶ˆæ¯æ•°é‡å·²æ»¡æˆ–å·²åˆ›å»ºæ–°çš„æ‰¹æ¬¡ï¼Œåˆ™å”¤é†’senderçº¿ç¨‹        if (result.batchIsFull || result.newBatchCreated) &#123;            log.trace(&quot;Waking up the sender since topic &#123;&#125; partition &#123;&#125; is either full or getting a new batch&quot;, record.topic(), partition);            this.sender.wakeup();        &#125;        // è¿”å›RecordMetadataFutureï¼Œç”¨äºè·å–æ¶ˆæ¯å‘é€ç»“æœ        return result.future;        // handling exceptions and record the errors;        // for API exceptions return them in the future,        // for other exceptions throw directly    &#125; catch (ApiException e) &#123;        log.debug(&quot;Exception occurred during message send:&quot;, e);        if (callback != null)            callback.onCompletion(null, e);        this.errors.record();        if (this.interceptors != null)            this.interceptors.onSendError(record, tp, e);        return new FutureFailure(e);    &#125; catch (InterruptedException e) &#123;        this.errors.record();        if (this.interceptors != null)            this.interceptors.onSendError(record, tp, e);        throw new InterruptException(e);    &#125; catch (BufferExhaustedException e) &#123;        this.errors.record();        this.metrics.sensor(&quot;buffer-exhausted-records&quot;).record();        if (this.interceptors != null)            this.interceptors.onSendError(record, tp, e);        throw e;    &#125; catch (KafkaException e) &#123;        this.errors.record();        if (this.interceptors != null)            this.interceptors.onSendError(record, tp, e);        throw e;    &#125; catch (Exception e) &#123;        // we notify interceptor about all exceptions, since onSend is called before anything else in this method        if (this.interceptors != null)            this.interceptors.onSendError(record, tp, e);        throw e;    &#125;&#125;

ä»æœåŠ¡ç«¯è·å–å…ƒæ•°æ®waitOnMetadata
  /** * Wait for cluster metadata including partitions for the given topic to be available. * @param topic The topic we want metadata for * @param partition A specific partition expected to exist in metadata, or null if there&#x27;s no preference * @param maxWaitMs The maximum time in ms for waiting on the metadata * @return The cluster containing topic metadata and the amount of time we waited in ms */private ClusterAndWaitTime waitOnMetadata(String topic, Integer partition, long maxWaitMs) throws InterruptedException &#123;    // å°†ä¸»é¢˜æ·»åŠ åˆ°å…ƒæ•°æ®ä¸»é¢˜åˆ—è¡¨ï¼ˆå¦‚æœå°šä¸å­˜åœ¨ï¼‰å¹¶é‡ç½®è¿‡æœŸæ—¶é—´å’ŒneedUpdateè®¾ç½®ä¸ºtrue    metadata.add(topic);    Cluster cluster = metadata.fetch();    Integer partitionsCount = cluster.partitionCountForTopic(topic);        // å¦‚æœæˆ‘ä»¬æœ‰ç¼“å­˜çš„metadataæ•°æ®ï¼Œå¹¶ä¸”æ¶ˆæ¯çš„åˆ†åŒºæœªå®šä¹‰æˆ–åœ¨å·²çŸ¥åˆ†åŒºèŒƒå›´å†…ï¼Œåˆ™è¿”å›ç¼“å­˜çš„metadataæ•°æ®    if (partitionsCount != null &amp;&amp; (partition == null || partition &lt; partitionsCount))        return new ClusterAndWaitTime(cluster, 0);        // å½“å‰æ—¶é—´    long begin = time.milliseconds();    // å‰©ä½™å¯ç”¨æ—¶é—´ï¼Œé»˜è®¤å€¼ä¸ºmaxWaitMsï¼Œæœ€å¤šå¯ä»¥ç­‰å¾…æ—¶é—´    long remainingWaitMs = maxWaitMs;    long elapsed;    // Issue metadata requests until we have metadata for the topic or maxWaitTimeMs is exceeded.    // In case we already have cached metadata for the topic, but the requested partition is greater    // than expected, issue an update request only once. This is necessary in case the metadata    // is stale and the number of partitions for this topic has increased in the meantime.    do &#123;        log.trace(&quot;Requesting metadata update for topic &#123;&#125;.&quot;, topic);        // needUpdateè®¾ç½®ä¸ºtrueï¼Œè¿”å›æ›´æ–°å‰çš„å½“å‰ç‰ˆæœ¬        int version = metadata.requestUpdate();        // å”¤é†’senderçº¿ç¨‹        sender.wakeup();            try &#123;            metadata.awaitUpdate(version, remainingWaitMs);        &#125; catch (TimeoutException ex) &#123;            // Rethrow with original maxWaitMs to prevent logging exception with remainingWaitMs            throw new TimeoutException(&quot;Failed to update metadata after &quot; + maxWaitMs + &quot; ms.&quot;);        &#125;        // å†æ¬¡è·å–é›†ç¾¤çš„å…ƒæ•°æ®ä¿¡æ¯        cluster = metadata.fetch();        // è®¡ç®—æ‹‰å–metadataæ•°æ®è€—æ—¶        elapsed = time.milliseconds() - begin;        // å¦‚æœæ‹‰å–metadataæ•°æ®è€—æ—¶è¶…è¿‡äº†æœ€å¤§é˜»å¡æ—¶é—´ï¼Œåˆ™æŠ›å‡ºè¶…æ—¶å¼‚å¸¸        if (elapsed &gt;= maxWaitMs)            throw new TimeoutException(&quot;Failed to update metadata after &quot; + maxWaitMs + &quot; ms.&quot;);        // å¦‚æœè·å–åˆ°metadataæ•°æ®ï¼Œtopicæ²¡æœ‰æˆæƒï¼Œåˆ™æŠ›å‡ºTopicAuthorizationException        if (cluster.unauthorizedTopics().contains(topic))            throw new TopicAuthorizationException(topic);        // è®¡ç®—å‰©ä½™å¯ç”¨æ—¶é—´        remainingWaitMs = maxWaitMs - elapsed;        // å¦‚æœtopicçš„åˆ†åŒºæ•°é‡æœªçŸ¥ï¼Œåˆ™ç»§ç»­ç­‰å¾…        partitionsCount = cluster.partitionCountForTopic(topic);    &#125; while (partitionsCount == null);        if (partition != null &amp;&amp; partition &gt;= partitionsCount) &#123;        throw new KafkaException(                String.format(&quot;Invalid partition given with record: %d is not in the range [0...%d).&quot;, partition, partitionsCount));    &#125;    // è¿”å›é›†ç¾¤å…ƒæ•°æ®å’Œè€—æ—¶æ—¶é—´    return new ClusterAndWaitTime(cluster, elapsed);&#125;

Senderçº¿ç¨‹åœ¨run()æ–¹æ³•æ­»å¾ªç¯
  /** * Run a single iteration of sending *  * @param now *            The current POSIX time in milliseconds */void run(long now) &#123;    // è·å–å½“å‰é›†ç¾¤metadataä¿¡æ¯    Cluster cluster = metadata.fetch();    // è·å–å·²å‡†å¤‡å¥½å‘é€æ•°æ®çš„åˆ†åŒºè¯·æ±‚    RecordAccumulator.ReadyCheckResult result = this.accumulator.ready(cluster, now);        // å¦‚æœæœ‰ä»»ä½•åˆ†åŒºçš„ leader å°šä¸æ¸…æ¥šï¼Œåˆ™å¼ºåˆ¶å…ƒæ•°æ®æ›´æ–°ã€‚ç¬¬ä¸€æ¬¡æ‰§è¡Œtopicï¼Œä¸ä¼šèµ°    if (!result.unknownLeaderTopics.isEmpty()) &#123;        // The set of topics with unknown leader contains topics with leader election pending as well as        // topics which may have expired. Add the topic again to metadata to ensure it is included        // and request metadata update, since there are messages to send to the topic.        for (String topic : result.unknownLeaderTopics)            this.metadata.add(topic);        this.metadata.requestUpdate();    &#125;    // åˆ¤æ–­èŠ‚ç‚¹æœ‰æ²¡æœ‰å‡†å¤‡å¥½ï¼Œå¹¶ç§»é™¤æ²¡æœ‰å‡†å¤‡çš„èŠ‚ç‚¹    // remove any nodes we aren&#x27;t ready to send to    Iterator&lt;Node&gt; iter = result.readyNodes.iterator();    long notReadyTimeout = Long.MAX_VALUE;    while (iter.hasNext()) &#123;        Node node = iter.next();        if (!this.client.ready(node, now)) &#123;            iter.remove();            notReadyTimeout = Math.min(notReadyTimeout, this.client.connectionDelay(node, now));        &#125;    &#125;        // åˆ›å»ºæ‰¹æ¬¡è¯·æ±‚    Map&lt;Integer, List&lt;RecordBatch&gt;&gt; batches = this.accumulator.drain(cluster,                                                                     result.readyNodes,                                                                     this.maxRequestSize,                                                                     now);    // ä¿è¯æ¶ˆæ¯é¡ºåºï¼Œç¬¬ä¸€æ¬¡æ‰§è¡ŒguaranteeMessageOrderä¸ºfalseï¼Œä¸ä¼šèµ°    if (guaranteeMessageOrder) &#123;        // Mute all the partitions drained        for (List&lt;RecordBatch&gt; batchList : batches.values()) &#123;            for (RecordBatch batch : batchList)                this.accumulator.mutePartition(batch.topicPartition);        &#125;    &#125;        // æ£€æŸ¥è¶…æ—¶çš„æ‰¹æ¬¡ï¼Œç¬¬ä¸€æ¬¡æ‰§è¡Œæ²¡expiredBatchesä¸ºç©º    List&lt;RecordBatch&gt; expiredBatches = this.accumulator.abortExpiredBatches(this.requestTimeout, now);    // æ›´æ–°è¶…æ—¶æ‰¹æ¬¡çš„é”™è¯¯è®¡æ•°    for (RecordBatch expiredBatch : expiredBatches)        this.sensors.recordErrors(expiredBatch.topicPartition.topic(), expiredBatch.recordCount);        sensors.updateProduceRequestMetrics(batches);        // If we have any nodes that are ready to send + have sendable data, poll with 0 timeout so this can immediately    // loop and try sending more data. Otherwise, the timeout is determined by nodes that have partitions with data    // that isn&#x27;t yet sendable (e.g. lingering, backing off). Note that this specifically does not include nodes    // with sendable data that aren&#x27;t ready to send since they would cause busy looping.    long pollTimeout = Math.min(result.nextReadyCheckDelayMs, notReadyTimeout);    if (!result.readyNodes.isEmpty()) &#123;        log.trace(&quot;Nodes with data ready to send: &#123;&#125;&quot;, result.readyNodes);        // å¦‚æœæœ‰å·²ç»å‡†å¤‡å¥½çš„èŠ‚ç‚¹ï¼Œè¶…æ—¶é—´éš”ä¸º0ï¼Œç«‹å³å‘é€è¯·æ±‚        pollTimeout = 0;    &#125;    // å‡†å¤‡å¾…å‘é€è¯·æ±‚çš„æ•°æ®    sendProduceRequests(batches, now);        // æ‰§è¡Œç½‘ç»œè¯·æ±‚    // if some partitions are already ready to be sent, the select time would be 0;    // otherwise if some partition already has some data accumulated but not ready yet,    // the select time will be the time difference between now and its linger expiry time;    // otherwise the select time will be the time difference between now and the metadata expiry time;    this.client.poll(pollTimeout, now);&#125;

è·å–å·²å‡†å¤‡å¥½å‘é€æ•°æ®çš„åˆ†åŒºè¯·æ±‚ready
  public ReadyCheckResult ready(Cluster cluster, long nowMs) &#123;    Set&lt;Node&gt; readyNodes = new HashSet&lt;&gt;();    long nextReadyCheckDelayMs = Long.MAX_VALUE;    Set&lt;String&gt; unknownLeaderTopics = new HashSet&lt;&gt;();        // å†…å­˜å·²ç»è€—å°½ï¼Œå¹¶ä¸”çº¿ç¨‹é˜»å¡ç­‰å¾…bufferï¼Œåˆ™æ‰€æœ‰partitionéƒ½å¯ä»¥å‘é€    boolean exhausted = this.free.queued() &gt; 0;        // éå†æ‰€æœ‰é˜Ÿåˆ—ï¼Œè·å–æ¯ä¸ªpartitionçš„leaderèŠ‚ç‚¹ï¼Œå¦‚æœleaderèŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ™è¯´æ˜è¯¥partitionçš„leaderèŠ‚ç‚¹æœªçŸ¥ï¼Œ    for (Map.Entry&lt;TopicPartition, Deque&lt;RecordBatch&gt;&gt; entry : this.batches.entrySet()) &#123;        TopicPartition part = entry.getKey();        Deque&lt;RecordBatch&gt; deque = entry.getValue();            Node leader = cluster.leaderFor(part);        synchronized (deque) &#123;            if (leader == null &amp;&amp; !deque.isEmpty()) &#123;                // This is a partition for which leader is not known, but messages are available to send.                // Note that entries are currently not removed from batches when deque is empty.                unknownLeaderTopics.add(part.topic());            &#125; else if (!readyNodes.contains(leader) &amp;&amp; !muted.contains(part)) &#123;                // ä»é˜Ÿåˆ—å¤´éƒ¨è·å–ç¬¬ä¸€ä¸ªæ‰¹æ¬¡ï¼Œå¦‚æœæ‰¹ä¸ä¸ºnullï¼Œåˆ™åˆ¤æ–­æ˜¯å¦å¯ä»¥å‘é€ï¼Œå¦‚æœå¯ä»¥å‘é€ï¼Œåˆ™æ·»åŠ åˆ°readyNodesé›†åˆä¸­                RecordBatch batch = deque.peekFirst();                if (batch != null) &#123;                    /**                     * batch.attemptsé‡è¯•çš„æ¬¡æ•°                     * batch.lastAttemptMsä¸Šæ¬¡é‡è¯•çš„æ—¶é—´                     * batch.retryBackoffMsé‡è¯•çš„é—´éš”æ—¶é—´                     * nowMså½“å‰æ—¶é—´                     */                    boolean backingOff = batch.attempts &gt; 0 &amp;&amp; batch.lastAttemptMs + retryBackoffMs &gt; nowMs;                    // waitedTimeMsï¼ˆå·²ç»ç­‰å¾…çš„æ—¶é—´ï¼‰ = nowMså½“å‰æ—¶é—´ - batch.lastAttemptMsä¸Šæ¬¡é‡è¯•çš„æ—¶é—´                    long waitedTimeMs = nowMs - batch.lastAttemptMs;                        // timeToWaitMsæœ€å¤šç­‰å¾…çš„æ—¶é—´ = backingOffæ˜¯å¦å¤„äºé‡è¯•çŠ¶æ€ï¼Ÿé‡è¯•é—´éš”æ—¶é—´ï¼šlingerMsç­‰å¾…æ—¶é—´ï¼Œé»˜è®¤ä¸ºï¼š0                    long timeToWaitMs = backingOff ? retryBackoffMs : lingerMs;                        // timeLeftMså‰©ä½™ç­‰å¾…çš„æ—¶é—´ = timeToWaitMsï¼ˆæœ€å¤šç­‰å¾…çš„æ—¶é—´ï¼‰ - waitedTimeMsï¼ˆå·²ç»ç­‰å¾…çš„æ—¶é—´ï¼‰                    long timeLeftMs = Math.max(timeToWaitMs - waitedTimeMs, 0);                        //fullæ˜¯å¦å·²æ»¡ = é˜Ÿåˆ—ä¸­æœ‰å¤šä¸ªæ‰¹æ¬¡ || å½“å‰æ‰¹æ¬¡å·²æ»¡                    boolean full = deque.size() &gt; 1 || batch.isFull();                        // expiredæ˜¯å¦å·²è¿‡æœŸ = waitedTimeMsï¼ˆå·²ç»ç­‰å¾…çš„æ—¶é—´ï¼‰ &gt;= timeToWaitMsï¼ˆæœ€å¤šç­‰å¾…çš„æ—¶é—´ï¼‰                    boolean expired = waitedTimeMs &gt;= timeToWaitMs;                        // sendableæ˜¯å¦å¯ä»¥å‘é€ = é˜Ÿåˆ—ä¸­æœ‰å¤šä¸ªæ‰¹æ¬¡æˆ–è€…å½“å‰æ‰¹æ¬¡å·²æ»¡ || ç­‰å¾…æ—¶é—´å·²è¿‡ || å†…å­˜è€—å°½ || å…³é—­ || æ­£åœ¨flush                    boolean sendable = full || expired || exhausted || closed || flushInProgress();                    if (sendable &amp;&amp; !backingOff) &#123;                        readyNodes.add(leader);                    &#125; else &#123;                        // Note that this results in a conservative estimate since an un-sendable partition may have                        // a leader that will later be found to have sendable data. However, this is good enough                        // since we&#x27;ll just wake up and then sleep again for the remaining time.                        nextReadyCheckDelayMs = Math.min(timeLeftMs, nextReadyCheckDelayMs);                    &#125;                &#125;            &#125;        &#125;    &#125;        return new ReadyCheckResult(readyNodes, nextReadyCheckDelayMs, unknownLeaderTopics);&#125;

åˆ¤æ–­èŠ‚ç‚¹æœ‰æ²¡æœ‰å‡†å¤‡å¥½ï¼Œå¹¶ç§»é™¤æ²¡æœ‰å‡†å¤‡çš„èŠ‚ç‚¹
      // åˆ¤æ–­èŠ‚ç‚¹æœ‰æ²¡æœ‰å‡†å¤‡å¥½ï¼Œå¹¶ç§»é™¤æ²¡æœ‰å‡†å¤‡çš„èŠ‚ç‚¹    // remove any nodes we aren&#x27;t ready to send to    Iterator&lt;Node&gt; iter = result.readyNodes.iterator();    long notReadyTimeout = Long.MAX_VALUE;    while (iter.hasNext()) &#123;        Node node = iter.next();        if (!this.client.ready(node, now)) &#123;            iter.remove();            notReadyTimeout = Math.min(notReadyTimeout, this.client.connectionDelay(node, now));        &#125;    &#125;         /** * Begin connecting to the given node, return true if we are already connected and ready to send to that node. * * @param node The node to check * @param now The current timestamp * @return True if we are ready to send to the given node */@Overridepublic boolean ready(Node node, long now) &#123;    if (node.isEmpty())        throw new IllegalArgumentException(&quot;Cannot connect to empty node &quot; + node);        if (isReady(node, now))        return true;        if (connectionStates.canConnect(node.idString(), now))        // åˆå§‹åŒ–ç½‘ç»œè¿æ¥        initiateConnect(node, now);        return false;&#125;    /** * åˆå§‹åŒ–è¿æ¥ï¼Œå¦‚æœè¿æ¥å¤±è´¥ï¼Œåˆ™ä¼šå°è¯•é‡è¯•ã€‚ */private void initiateConnect(Node node, long now) &#123;    String nodeConnectionId = node.idString();    try &#123;        log.debug(&quot;Initiating connection to node &#123;&#125; at &#123;&#125;:&#123;&#125;.&quot;, node.id(), node.host(), node.port());        // ä¿®æ”¹çŠ¶æ€ä¸ºæ­£åœ¨è¿æ¥        this.connectionStates.connecting(nodeConnectionId, now);        // å°è¯•è¿æ¥        selector.connect(nodeConnectionId,                         new InetSocketAddress(node.host(), node.port()),                         this.socketSendBuffer,                         this.socketReceiveBuffer);    &#125; catch (IOException e) &#123;        /* attempt failed, we&#x27;ll try again after the backoff */        connectionStates.disconnected(nodeConnectionId, now);        /* maybe the problem is our metadata, update it */        metadataUpdater.requestUpdate();        log.debug(&quot;Error connecting to node &#123;&#125; at &#123;&#125;:&#123;&#125;:&quot;, node.id(), node.host(), node.port(), e);    &#125;&#125;@Overridepublic void connect(String id, InetSocketAddress address, int sendBufferSize, int receiveBufferSize) throws IOException &#123;    if (this.channels.containsKey(id))        throw new IllegalStateException(&quot;There is already a connection for id &quot; + id);    // è·å–SocketChannel.open()    SocketChannel socketChannel = SocketChannel.open();    // è®¾ç½®éé˜»å¡æ¨¡å¼    socketChannel.configureBlocking(false);    // è·å–socket    Socket socket = socketChannel.socket();    socket.setKeepAlive(true);    // è®¾ç½®å‘é€ç¼“å†²åŒºå¤§å°ã€æ¥æ”¶ç¼“å†²åŒºå¤§å°    if (sendBufferSize != Selectable.USE_DEFAULT_BUFFER_SIZE)        socket.setSendBufferSize(sendBufferSize);    if (receiveBufferSize != Selectable.USE_DEFAULT_BUFFER_SIZE)        socket.setReceiveBufferSize(receiveBufferSize);    // è®¾ç½®TcpNoDelayå±æ€§ä¸ºtrueï¼Œç”¨äºæ§åˆ¶ TCP è¿æ¥ä¸­æ•°æ®åŒ…çš„å‘é€æ–¹å¼ã€‚    // é»˜è®¤æƒ…å†µä¸‹ï¼ŒTCP ä½¿ç”¨ Nagle ç®—æ³• æ¥å‡å°‘ç½‘ç»œä¸­çš„å°æ•°æ®åŒ…æ•°é‡ï¼Œä»è€Œæé«˜ç½‘ç»œåˆ©ç”¨ç‡ã€‚    // ç„¶è€Œï¼Œè¿™ç§æ–¹å¼å¯èƒ½ä¼šå¢åŠ å»¶è¿Ÿï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦å¿«é€Ÿå“åº”çš„åº”ç”¨ä¸­    socket.setTcpNoDelay(true);    boolean connected;    try &#123;        // å°è¯•è¿æ¥æœåŠ¡å™¨ï¼Œæœ‰å¯èƒ½è¿æ¥æˆåŠŸï¼štrueï¼Œä¹Ÿæœ‰å¯èƒ½è¿æ¥å¤±è´¥:false        connected = socketChannel.connect(address);    &#125; catch (UnresolvedAddressException e) &#123;        socketChannel.close();        throw new IOException(&quot;Can&#x27;t resolve address: &quot; + address, e);    &#125; catch (IOException e) &#123;        socketChannel.close();        throw e;    &#125;    // SocketChannel.register()æ³¨å†Œåˆ°Selectorï¼Œå¹¶è®¾ç½®OP_CONNECTäº‹ä»¶    SelectionKey key = socketChannel.register(nioSelector, SelectionKey.OP_CONNECT);    KafkaChannel channel;    try &#123;        // æ ¹æ®SocketChannelåˆ›å»ºKafkaChannel        channel = channelBuilder.buildChannel(id, key, maxReceiveSize);    &#125; catch (Exception e) &#123;        try &#123;            socketChannel.close();        &#125; finally &#123;            key.cancel();        &#125;        throw new IOException(&quot;Channel could not be created for socket &quot; + socketChannel, e);    &#125;    // æŠŠkeyå’Œchannelç»‘å®šï¼Œå¹¶è®¾ç½®é™„ä»¶ä¸ºchannel    key.attach(channel);    // ç¼“å­˜channel    this.channels.put(id, channel);        if (connected) &#123;        // OP_CONNECT won&#x27;t trigger for immediately connected channels        log.debug(&quot;Immediately connected to node &#123;&#125;&quot;, channel.id());        immediatelyConnectedKeys.add(key);        // å–æ¶ˆå‰é¢æ³¨å†Œçš„OP_CONNECTäº‹ä»¶        key.interestOps(0);    &#125;&#125;

åˆ›å»ºæ‰¹æ¬¡è¯·æ±‚
  // åˆ›å»ºæ‰¹æ¬¡è¯·æ±‚Map&lt;Integer, List&lt;RecordBatch&gt;&gt; batches = this.accumulator.drain(cluster,                                                                 result.readyNodes,                                                                 this.maxRequestSize,                                                                 now);                                                                     /** * å®ç°æŒ‰ç…§NodeIdè¿›è¡Œåˆ†ç»„ï¼ŒæŠŠç›¸åŒNodeIdçš„batchåˆ†åˆ°ä¸€ç»„ä¸­ï¼Œè¿”å›Map&lt;NodeId, List&lt;RecordBatch&gt;&gt; * Drain all the data for the given nodes and collate them into a list of batches that will fit within the specified * size on a per-node basis. This method attempts to avoid choosing the same topic-node over and over. *  * @param cluster The current cluster metadata * @param nodes The list of node to drain * @param maxSize The maximum number of bytes to drain * @param now The current unix time in milliseconds * @return A list of &#123;@link RecordBatch&#125; for each node specified with total size less than the requested maxSize. */public Map&lt;Integer, List&lt;RecordBatch&gt;&gt; drain(Cluster cluster,                                             Set&lt;Node&gt; nodes,                                             int maxSize,                                             long now) &#123;    if (nodes.isEmpty())        return Collections.emptyMap();        Map&lt;Integer, List&lt;RecordBatch&gt;&gt; batches = new HashMap&lt;&gt;();    for (Node node : nodes) &#123;        int size = 0;        List&lt;PartitionInfo&gt; parts = cluster.partitionsForNode(node.id());        List&lt;RecordBatch&gt; ready = new ArrayList&lt;&gt;();        /* to make starvation less likely this loop doesn&#x27;t start at 0 */        int start = drainIndex = drainIndex % parts.size();        do &#123;            PartitionInfo part = parts.get(drainIndex);            TopicPartition tp = new TopicPartition(part.topic(), part.partition());            // Only proceed if the partition has no in-flight batches.            if (!muted.contains(tp)) &#123;                Deque&lt;RecordBatch&gt; deque = getDeque(new TopicPartition(part.topic(), part.partition()));                if (deque != null) &#123;                    synchronized (deque) &#123;                        RecordBatch first = deque.peekFirst();                        if (first != null) &#123;                            boolean backoff = first.attempts &gt; 0 &amp;&amp; first.lastAttemptMs + retryBackoffMs &gt; now;                            // Only drain the batch if it is not during backoff period.                            if (!backoff) &#123;                                if (size + first.sizeInBytes() &gt; maxSize &amp;&amp; !ready.isEmpty()) &#123;                                    // there is a rare case that a single batch size is larger than the request size due                                    // to compression; in this case we will still eventually send this batch in a single                                    // request                                    break;                                &#125; else &#123;                                    RecordBatch batch = deque.pollFirst();                                    batch.close();                                    size += batch.sizeInBytes();                                    ready.add(batch);                                    batch.drainedMs = now;                                &#125;                            &#125;                        &#125;                    &#125;                &#125;            &#125;            this.drainIndex = (this.drainIndex + 1) % parts.size();        &#125; while (start != drainIndex);        batches.put(node.id(), ready);    &#125;    return batches;&#125;

æ‰§è¡Œç½‘ç»œè¯·æ±‚
  /** * Do actual reads and writes to sockets. * * @param timeout The maximum amount of time to wait (in ms) for responses if there are none immediately, *                must be non-negative. The actual timeout will be the minimum of timeout, request timeout and *                metadata timeout * @param now The current time in milliseconds * @return The list of responses received */@Overridepublic List&lt;ClientResponse&gt; poll(long timeout, long now) &#123;    // å°è£…è¦æ‹‰å–å…ƒæ•°æ®çš„è¯·æ±‚    long metadataTimeout = metadataUpdater.maybeUpdate(now);    try &#123;        this.selector.poll(Utils.min(timeout, metadataTimeout, requestTimeoutMs));    &#125; catch (IOException e) &#123;        log.error(&quot;Unexpected error during I/O&quot;, e);    &#125;        // å¤„ç†å·²å®Œæˆè¯·æ±‚çš„æ“ä½œ    long updatedNow = this.time.milliseconds();    List&lt;ClientResponse&gt; responses = new ArrayList&lt;&gt;();    handleAbortedSends(responses);    handleCompletedSends(responses, updatedNow);    handleCompletedReceives(responses, updatedNow);    handleDisconnections(responses, updatedNow);    handleConnections();    handleInitiateApiVersionRequests(updatedNow);    handleTimedOutRequests(responses, updatedNow);        // invoke callbacks    for (ClientResponse response : responses) &#123;        try &#123;            response.onComplete();        &#125; catch (Exception e) &#123;            log.error(&quot;Uncaught error in request completion:&quot;, e);        &#125;    &#125;        return responses;&#125;

æ›´æ–°å…ƒæ•°æ®ä¿¡æ¯
   @Override public long maybeUpdate(long now) &#123;     // æ˜¯å¦è¦æ›´æ–°metadataä¿¡æ¯ï¼Œå½“Producerçº¿ç¨‹æŠŠneedUpdateè®¾ç½®ä¸ºtrueæ—¶ï¼Œè¯´æ˜éœ€è¦æ›´æ–°metadataä¿¡æ¯     long timeToNextMetadataUpdate = metadata.timeToNextUpdate(now);     long waitForMetadataFetch = this.metadataFetchInProgress ? requestTimeoutMs : 0;         long metadataTimeout = Math.max(timeToNextMetadataUpdate, waitForMetadataFetch);     if (metadataTimeout &gt; 0) &#123;         return metadataTimeout;     &#125;         // Beware that the behavior of this method and the computation of timeouts for poll() are     // highly dependent on the behavior of leastLoadedNode.     // è·å–è¯·æ±‚æœ€å°‘çš„NodeèŠ‚ç‚¹     Node node = leastLoadedNode(now);     if (node == null) &#123;         log.debug(&quot;Give up sending metadata request since no node is available&quot;);         return reconnectBackoffMs;     &#125;         return maybeUpdate(now, node); &#125; /**  * Add a metadata request to the list of sends if we can make one  */ private long maybeUpdate(long now, Node node) &#123;     String nodeConnectionId = node.idString();         if (canSendRequest(nodeConnectionId)) &#123;         this.metadataFetchInProgress = true;         MetadataRequest.Builder metadataRequest;         if (metadata.needMetadataForAllTopics())             metadataRequest = MetadataRequest.Builder.allTopics();         else             metadataRequest = new MetadataRequest.Builder(new ArrayList&lt;&gt;(metadata.topics()));             log.debug(&quot;Sending metadata request &#123;&#125; to node &#123;&#125;&quot;, metadataRequest, node.id());         sendInternalMetadataRequest(metadataRequest, nodeConnectionId, now);         return requestTimeoutMs;     &#125;         // If there&#x27;s any connection establishment underway, wait until it completes. This prevents     // the client from unnecessarily connecting to additional nodes while a previous connection     // attempt has not been completed.     if (isAnyNodeConnecting()) &#123;         // Strictly the timeout we should return here is &quot;connect timeout&quot;, but as we don&#x27;t         // have such application level configuration, using reconnect backoff instead.         return reconnectBackoffMs;     &#125;         if (connectionStates.canConnect(nodeConnectionId, now)) &#123;         // we don&#x27;t have a connection to this node right now, make one         log.debug(&quot;Initialize connection to node &#123;&#125; for sending metadata request&quot;, node.id());         initiateConnect(node, now);         return reconnectBackoffMs;     &#125;         // connected, but can&#x27;t send more OR connecting     // In either case, we just need to wait for a network event to let us know the selected     // connection might be usable again.     return Long.MAX_VALUE; &#125;  

å‘é€Meatadataå…ƒæ•°æ®è¯·æ±‚


private void sendInternalMetadataRequest(MetadataRequest.Builder builder,                                          String nodeConnectionId, long now) &#123;     ClientRequest clientRequest = newClientRequest(nodeConnectionId, builder, now, true);     doSend(clientRequest, true, now); &#125; private void doSend(ClientRequest clientRequest, boolean isInternalRequest, long now) &#123;     String nodeId = clientRequest.destination();     if (!isInternalRequest) &#123;         // If this request came from outside the NetworkClient, validate         // that we can send data.  If the request is internal, we trust         // that that internal code has done this validation.  Validation         // will be slightly different for some internal requests (for         // example, ApiVersionsRequests can be sent prior to being in         // READY state.)         if (!canSendRequest(nodeId))             throw new IllegalStateException(&quot;Attempt to send a request to node &quot; + nodeId + &quot; which is not ready.&quot;);     &#125;     AbstractRequest request = null;     AbstractRequest.Builder&lt;?&gt; builder = clientRequest.requestBuilder();     try &#123;         NodeApiVersions versionInfo = nodeApiVersions.get(nodeId);         // Note: if versionInfo is null, we have no server version information. This would be         // the case when sending the initial ApiVersionRequest which fetches the version         // information itself.  It is also the case when discoverBrokerVersions is set to false.         if (versionInfo == null) &#123;             if (discoverBrokerVersions &amp;&amp; log.isTraceEnabled())                 log.trace(&quot;No version information found when sending message of type &#123;&#125; to node &#123;&#125;. &quot; +                         &quot;Assuming version &#123;&#125;.&quot;, clientRequest.apiKey(), nodeId, builder.version());         &#125; else &#123;             short version = versionInfo.usableVersion(clientRequest.apiKey());             builder.setVersion(version);         &#125;         // The call to build may also throw UnsupportedVersionException, if there are essential         // fields that cannot be represented in the chosen version.         request = builder.build();     &#125; catch (UnsupportedVersionException e) &#123;         // If the version is not supported, skip sending the request over the wire.         // Instead, simply add it to the local queue of aborted requests.         log.debug(&quot;Version mismatch when attempting to send &#123;&#125; to &#123;&#125;&quot;,                 clientRequest.toString(), clientRequest.destination(), e);         ClientResponse clientResponse = new ClientResponse(clientRequest.makeHeader(),                 clientRequest.callback(), clientRequest.destination(), now, now,                 false, e, null);         abortedSends.add(clientResponse);         return;     &#125;     RequestHeader header = clientRequest.makeHeader();     if (log.isDebugEnabled()) &#123;         int latestClientVersion = ProtoUtils.latestVersion(clientRequest.apiKey().id);         if (header.apiVersion() == latestClientVersion) &#123;             log.trace(&quot;Sending &#123;&#125; to node &#123;&#125;.&quot;, request, nodeId);         &#125; else &#123;             log.debug(&quot;Using older server API v&#123;&#125; to send &#123;&#125; to node &#123;&#125;.&quot;,                 header.apiVersion(), request, nodeId);         &#125;     &#125;     Send send = request.toSend(nodeId, header);     InFlightRequest inFlightRequest = new InFlightRequest(             header,             clientRequest.createdTimeMs(),             clientRequest.destination(),             clientRequest.callback(),             clientRequest.expectResponse(),             isInternalRequest,             send,             now);     this.inFlightRequests.add(inFlightRequest);     selector.send(inFlightRequest.send); &#125;  /**  * Queue the given request for sending in the subsequent &#123;@link #poll(long)&#125; calls  * @param send The request to send  */ public void send(Send send) &#123;     String connectionId = send.destination();     if (closingChannels.containsKey(connectionId))         this.failedSends.add(connectionId);     else &#123;         KafkaChannel channel = channelOrFail(connectionId, false);         try &#123;             channel.setSend(send);         &#125; catch (CancelledKeyException e) &#123;             this.failedSends.add(connectionId);             close(channel, false);         &#125;     &#125; &#125;  public void setSend(Send send) &#123;     if (this.send != null)         throw new IllegalStateException(&quot;Attempt to begin a send operation with prior send operation still in progress.&quot;);     this.send = send;     this.transportLayer.addInterestOps(SelectionKey.OP_WRITE); &#125;]]></content>
      <categories>
        <category>Kafka</category>
      </categories>
      <tags>
        <tag>Kafka</tag>
        <tag>Kafkaæºç åˆ†æ</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis(ä¸€)è®¤è¯†Redis</title>
    <url>/Redis/Redis%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8(%E4%B8%80)%E8%AE%A4%E8%AF%86Redis%E4%B8%AD%E9%97%B4%E4%BB%B6/</url>
    <content><![CDATA[Redis(ä¸€)è®¤è¯†Redis1. Redis æ˜¯ä»€ä¹ˆï¼ŸRedisï¼ˆRemote Dictionary Server )ï¼Œå³è¿œç¨‹å­—å…¸æœåŠ¡ !æ˜¯ä¸€ä¸ªå¼€æºçš„ä½¿ç”¨ANSI Cè¯­è¨€ç¼–å†™ã€æ”¯æŒç½‘ç»œã€å¯åŸºäºå†…å­˜äº¦å¯æŒä¹…åŒ–çš„æ—¥å¿—å‹ã€Key-Valueæ•°æ®åº“ï¼Œå¹¶æä¾›å¤šç§è¯­è¨€çš„APIã€‚
Redisä¼šå‘¨æœŸæ€§çš„æŠŠæ›´æ–°çš„æ•°æ®å†™å…¥ç£ç›˜æˆ–è€…æŠŠä¿®æ”¹æ“ä½œå†™å…¥è¿½åŠ çš„è®°å½•æ–‡ä»¶ï¼Œå¹¶ä¸”åœ¨æ­¤åŸºç¡€ä¸Šå®ç°äº†master-slave(ä¸»ä»)åŒæ­¥ã€‚å…è´¹å’Œå¼€æºï¼æ˜¯å½“ä¸‹æœ€çƒ­é—¨çš„ NoSQL æŠ€æœ¯ä¹‹ä¸€ï¼ä¹Ÿè¢«äººä»¬ç§°ä¹‹ä¸ºç»“æ„åŒ–æ•°æ®åº“ï¼

2. Redis èƒ½å¹²å˜›ï¼Ÿgoogle guavaæä¾›ä¸¤ç§æ–¹å¼ï¼š

å†…å­˜å­˜å‚¨ã€æŒä¹…åŒ–ï¼Œå†…å­˜ä¸­æ˜¯æ–­ç”µå³å¤±ã€æ‰€ä»¥è¯´æŒä¹…åŒ–å¾ˆé‡è¦ï¼ˆrdbã€aofï¼‰
æ•ˆç‡é«˜ï¼Œå¯ä»¥ç”¨äºé«˜é€Ÿç¼“å­˜
å‘å¸ƒè®¢é˜…ç³»ç»Ÿ
åœ°å›¾ä¿¡æ¯åˆ†æ
è®¡æ—¶å™¨ã€è®¡æ•°å™¨ï¼ˆæµè§ˆé‡ï¼ï¼‰â€¦â€¦..

3. ç‰¹æ€§
å¤šæ ·çš„æ•°æ®ç±»å‹
æŒä¹…åŒ–
é›†ç¾¤
äº‹åŠ¡

4. Rediså®‰è£…
Windowså®‰è£…

ä¸‹è½½å®‰è£…åŒ…ï¼šReleases Â· microsoftarchive&#x2F;redis Â· GitHub
ä¸‹è½½å®Œæ¯•å¾—åˆ°å‹ç¼©åŒ…ï¼š

  

è§£å‹åˆ°è‡ªå·±ç”µè„‘ä¸Šçš„ç¯å¢ƒç›®å½•ä¸‹çš„å°±å¯ä»¥çš„ï¼Redis ååˆ†çš„å°ï¼Œåªæœ‰5M

  

å¼€å¯Redisï¼ŒåŒå‡»è¿è¡ŒæœåŠ¡å³å¯ï¼

  

ä½¿ç”¨Rediså®¢æˆ·å•è¿æ¥redis

  
  127.0.0.1:6379&gt; pingPONG127.0.0.1:6379&gt; set name yuanxwOK127.0.0.1:6379&gt; get name&quot;yuanxw&quot;127.0.0.1:6379&gt;
  


4.2 Linuxå®‰è£…

ä¸‹è½½å®‰è£…åŒ…ï¼šwget https://download.redis.io/releases/redis-6.2.6.tar.gz
è§£å‹Redisçš„å®‰è£…åŒ…



è¿›å…¥è§£å‹åçš„æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬redisçš„é…ç½®æ–‡ä»¶



åŸºæœ¬çš„ç¯å¢ƒå®‰è£…

yum install gcc-c++makemake install




Redisçš„é»˜è®¤å®‰è£…è·¯å¾„

 ç›®å½•ï¼š&#x2F;usr&#x2F;local&#x2F;bin


å°†Redisé…ç½®æ–‡ä»¶ã€‚å¤åˆ¶åˆ°æˆ‘ä»¬å½“å‰ç›®å½•ä¸‹

mkdir /usr/local/bin/configcp /usr/local/software/redis-6.2.6/redis.conf /usr/local/bin/config


Redisé»˜è®¤ä¸æ˜¯åå°å¯åŠ¨çš„ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ï¼




å¯åŠ¨RedisæœåŠ¡

./redis-server config/redis.conf


éªŒè¯æœåŠ¡



ä½¿ç”¨redis-cli è¿›è¡Œè¿æ¥æµ‹è¯•



å¦‚ä½•å…³é—­RedisæœåŠ¡å‘¢

[root@localhost bin]# redis-cli 127.0.0.1:6379&gt; SHUTDOWN


5. Redisé»˜è®¤æœ‰16ä¸ªæ•°æ®åº“Redisé»˜è®¤æ•°æ®åº“æœ‰16ä¸ªï¼Œé»˜è®¤ä½¿ç”¨databaseï¼š0

å¯ä»¥ä½¿ç”¨ select è¿›è¡Œåˆ‡æ¢æ•°æ®åº“ï¼
127.0.0.1:6379&gt; select 3 # åˆ‡æ¢æ•°æ®åº“OK127.0.0.1:6379[3]&gt; DBSIZE # æŸ¥çœ‹DBå¤§å°ï¼(integer) 0


127.0.0.1:6379[3]&gt; keys * # æŸ¥çœ‹æ•°æ®åº“æ‰€æœ‰çš„key1) &quot;name&quot;

6. æ¸…é™¤å½“å‰æ•°æ®åº“flushdb

7. æ¸…é™¤å…¨éƒ¨æ•°æ®åº“çš„å†…å®¹FLUSHALL

127.0.0.1:6379[3]&gt; flushdbOK127.0.0.1:6379[3]&gt; keys *(empty array)

8. Redis æ˜¯å•çº¿ç¨‹çš„æ˜ç™½Redisæ˜¯å¾ˆå¿«çš„ï¼Œå®˜æ–¹è¡¨ç¤ºï¼ŒRedisæ˜¯åŸºäºå†…å­˜æ“ä½œï¼ŒCPUä¸æ˜¯Redisæ€§èƒ½ç“¶é¢ˆï¼ŒRedisçš„ç“¶é¢ˆæ˜¯æ ¹æ®æœºå™¨çš„å†…å­˜å’Œç½‘ç»œå¸¦å®½ï¼Œæ—¢ç„¶å¯ä»¥ä½¿ç”¨å•çº¿ç¨‹æ¥å®ç°ï¼Œå°±ä½¿ç”¨å•çº¿ç¨‹äº†ï¼æ‰€æœ‰å°±ä½¿ç”¨äº†å•çº¿ç¨‹äº†ï¼Redis æ˜¯C è¯­è¨€å†™çš„ï¼Œå®˜æ–¹æä¾›çš„æ•°æ®ä¸º 100000+ çš„QPSï¼Œå®Œå…¨ä¸æ¯”åŒæ ·æ˜¯ä½¿ç”¨ key-valeçš„Memecacheå·®ï¼

Redis ä¸ºä»€ä¹ˆå•çº¿ç¨‹è¿˜è¿™ä¹ˆå¿«ï¼Ÿ
è¯¯åŒº1ï¼šé«˜æ€§èƒ½çš„æœåŠ¡å™¨ä¸€å®šæ˜¯å¤šçº¿ç¨‹çš„ï¼Ÿ

è¯¯åŒº2ï¼šå¤šçº¿ç¨‹ï¼ˆCPUä¸Šä¸‹æ–‡ä¼šåˆ‡æ¢ï¼ï¼‰ä¸€å®šæ¯”å•çº¿ç¨‹æ•ˆç‡é«˜ï¼
  å…ˆå»CPU&gt;å†…å­˜&gt;ç¡¬ç›˜çš„é€Ÿåº¦è¦æœ‰æ‰€äº†è§£ï¼  æ ¸å¿ƒï¼šredis æ˜¯å°†æ‰€æœ‰çš„æ•°æ®å…¨éƒ¨æ”¾åœ¨å†…å­˜ä¸­çš„ï¼Œæ‰€ä»¥è¯´ä½¿ç”¨å•çº¿ç¨‹å»æ“ä½œæ•ˆç‡å°±æ˜¯æœ€é«˜çš„ï¼Œå¤šçº¿ç¨‹  ï¼ˆCPUä¸Šä¸‹æ–‡ä¼šåˆ‡æ¢ï¼šè€—æ—¶çš„æ“ä½œï¼ï¼ï¼ï¼‰ï¼Œå¯¹äºå†…å­˜ç³»ç»Ÿæ¥è¯´ï¼Œå¦‚æœæ²¡æœ‰ä¸Šä¸‹æ–‡åˆ‡æ¢æ•ˆç‡å°±æ˜¯æœ€é«˜  çš„ï¼å¤šæ¬¡è¯»å†™éƒ½æ˜¯åœ¨ä¸€ä¸ªCPUä¸Šçš„ï¼Œåœ¨å†…å­˜æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå°±æ˜¯æœ€ä½³çš„æ–¹æ¡ˆï¼




]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>RedisåŸºç¡€å…¥é—¨</tag>
      </tags>
  </entry>
  <entry>
    <title>RedisåŸºç¡€å…¥é—¨(ä¸ƒ)Redis.confè¯¦è§£</title>
    <url>/Redis/Redis%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8(%E4%B8%83)Redis%20conf%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[RedisåŸºç¡€å…¥é—¨(ä¸ƒ)Redis.confè¯¦è§£1. é…ç½®æ–‡ä»¶
å•ä½

é…ç½®æ–‡ä»¶ unitå•ä½ å¯¹å¤§å°å†™ä¸æ•æ„Ÿï¼

  

include(åŒ…å«)

å°±æ˜¯å¥½æ¯”æˆ‘ä»¬å­¦ä¹ Springã€Improtï¼Œ include

  

NETWORKï¼ˆç½‘ç»œï¼‰
  bind 127.0.0.1      # ç»‘å®šçš„ipprotected-mode yes  # ä¿æŠ¤æ¨¡å¼port 6379           # ç«¯å£è®¾ç½®

GENERAL(é€šç”¨ )
  daemonize yes # ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œï¼Œé»˜è®¤æ˜¯ noï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±å¼€å¯ä¸ºyesï¼pidfile /var/run/redis_6379.pid # å¦‚æœä»¥åå°çš„æ–¹å¼è¿è¡Œï¼Œæˆ‘ä»¬å°±éœ€è¦æŒ‡å®šä¸€ä¸ª pid æ–‡ä»¶ï¼# æ—¥å¿—# Specify the server verbosity level.# This can be one of:# debug (a lot of information, useful for development/testing)# verbose (many rarely useful info, but not a mess like the debug level)# notice (moderately verbose, what you want in production probably) ç”Ÿäº§ç¯å¢ƒ# warning (only very important / critical messages are logged)loglevel noticelogfile &quot;&quot; # æ—¥å¿—çš„æ–‡ä»¶ä½ç½®ådatabases 16 # æ•°æ®åº“çš„æ•°é‡ï¼Œé»˜è®¤æ˜¯ 16 ä¸ªæ•°æ®åº“always-show-logo yes # æ˜¯å¦æ€»æ˜¯æ˜¾ç¤ºLOGO

SNAPSHOTTINGï¼ˆå¿«ç…§ï¼‰

æŒä¹…åŒ–ï¼Œ åœ¨è§„å®šçš„æ—¶é—´å†…ï¼Œæ‰§è¡Œäº†å¤šå°‘æ¬¡æ“ä½œï¼Œåˆ™ä¼šæŒä¹…åŒ–åˆ°æ–‡ä»¶ .rdb. aofã€‚Redis æ˜¯å†…å­˜æ•°æ®åº“ï¼Œå¦‚æœæ²¡æœ‰æŒä¹…åŒ–ï¼Œé‚£ä¹ˆæ•°æ®æ–­ç”µåŠå¤±ï¼

  # å¦‚æœ900så†…ï¼Œå¦‚æœè‡³å°‘æœ‰ä¸€ä¸ª1 keyè¿›è¡Œäº†ä¿®æ”¹ï¼Œæˆ‘ä»¬åŠè¿›è¡ŒæŒä¹…åŒ–æ“ä½œsave 900 1# å¦‚æœ300så†…ï¼Œå¦‚æœè‡³å°‘10 keyè¿›è¡Œäº†ä¿®æ”¹ï¼Œæˆ‘ä»¬åŠè¿›è¡ŒæŒä¹…åŒ–æ“ä½œsave 300 10# å¦‚æœ60så†…ï¼Œå¦‚æœè‡³å°‘10000 keyè¿›è¡Œäº†ä¿®æ”¹ï¼Œæˆ‘ä»¬åŠè¿›è¡ŒæŒä¹…åŒ–æ“ä½œsave 60 10000# æˆ‘ä»¬ä¹‹åå­¦ä¹ æŒä¹…åŒ–ï¼Œä¼šè‡ªå·±å®šä¹‰è¿™ä¸ªæµ‹è¯•ï¼stop-writes-on-bgsave-error yes # æŒä¹…åŒ–å¦‚æœå‡ºé”™ï¼Œæ˜¯å¦è¿˜éœ€è¦ç»§ç»­å·¥ä½œï¼rdbcompression yes # æ˜¯å¦å‹ç¼© rdb æ–‡ä»¶ï¼Œéœ€è¦æ¶ˆè€—ä¸€äº›cpuèµ„æºï¼rdbchecksum yes # ä¿å­˜rdbæ–‡ä»¶çš„æ—¶å€™ï¼Œè¿›è¡Œé”™è¯¯çš„æ£€æŸ¥æ ¡éªŒï¼dir ./ # rdb æ–‡ä»¶ä¿å­˜çš„ç›®å½•ï¼

SECURITY (å®‰å…¨)
  å¯ä»¥åœ¨è¿™é‡Œè®¾ç½®redisçš„å¯†ç ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰å¯†ç ï¼


127.0.0.1:6379&gt; pingPONG127.0.0.1:6379&gt; config get requirepass # è·å–redisçš„å¯†ç 1) &quot;requirepass&quot;2) &quot;&quot;127.0.0.1:6379&gt; config set requirepass &quot;123456&quot; # è®¾ç½®redisçš„å¯†ç OK127.0.0.1:6379&gt; config get requirepass # å‘ç°æ‰€æœ‰çš„å‘½ä»¤éƒ½æ²¡æœ‰æƒé™äº†(error) NOAUTH Authentication required.127.0.0.1:6379&gt; ping(error) NOAUTH Authentication required.127.0.0.1:6379&gt; auth 123456 # ä½¿ç”¨å¯†ç è¿›è¡Œç™»å½•ï¼OK127.0.0.1:6379&gt; config get requirepass1) &quot;requirepass&quot;2) &quot;123456&quot;


CLIENTS(é™åˆ¶ )
  maxclients 10000 # è®¾ç½®èƒ½è¿æ¥ä¸Šredisçš„æœ€å¤§å®¢æˆ·ç«¯çš„æ•°é‡maxmemory &lt;bytes&gt; # redis é…ç½®æœ€å¤§çš„å†…å­˜å®¹é‡maxmemory-policy noeviction # å†…å­˜åˆ°è¾¾ä¸Šé™ä¹‹åçš„å¤„ç†ç­–ç•¥

å†…å­˜åˆ°è¾¾ä¸Šé™ä¹‹åçš„å¤„ç†ç­–ç•¥ï¼š
volatile-lruï¼š  åªå¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyè¿›è¡ŒLRUï¼ˆé»˜è®¤å€¼ï¼‰
allkeys-lru ï¼š åˆ é™¤lruç®—æ³•çš„key
volatile-randomï¼šéšæœºåˆ é™¤å³å°†è¿‡æœŸkey
allkeys-randomï¼šéšæœºåˆ é™¤
volatile-ttl ï¼š åˆ é™¤å³å°†è¿‡æœŸçš„
noeviction ï¼š æ°¸ä¸è¿‡æœŸï¼Œè¿”å›é”™è¯¯





APPEND ONLY æ¨¡å¼ aofé…ç½®ppendonly no # é»˜è®¤æ˜¯ä¸å¼€å¯aofæ¨¡å¼çš„ï¼Œé»˜è®¤æ˜¯ä½¿ç”¨rdbæ–¹å¼æŒä¹…åŒ–çš„ï¼Œåœ¨å¤§éƒ¨åˆ†æ‰€æœ‰çš„æƒ…å†µä¸‹ï¼Œrdbå®Œå…¨å¤Ÿç”¨ï¼appendfilename &quot;appendonly.aof&quot; # æŒä¹…åŒ–çš„æ–‡ä»¶çš„åå­—# appendfsync always # æ¯æ¬¡ä¿®æ”¹éƒ½ä¼š syncã€‚æ¶ˆè€—æ€§èƒ½appendfsync everysec # æ¯ç§’æ‰§è¡Œä¸€æ¬¡ syncï¼Œå¯èƒ½ä¼šä¸¢å¤±è¿™1sçš„æ•°æ®ï¼# appendfsync no # ä¸æ‰§è¡Œ syncï¼Œè¿™ä¸ªæ—¶å€™æ“ä½œç³»ç»Ÿè‡ªå·±åŒæ­¥æ•°æ®ï¼Œé€Ÿåº¦æœ€å¿«ï¼]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>RedisåŸºç¡€å…¥é—¨</tag>
      </tags>
  </entry>
  <entry>
    <title>RedisåŸºç¡€å…¥é—¨(ä¸‰)ä¸‰ç§ç‰¹æ®Šæ•°æ®ç±»å‹</title>
    <url>/Redis/Redis%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8(%E4%B8%89)%E4%B8%89%E7%A7%8D%E7%89%B9%E6%AE%8A%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/</url>
    <content><![CDATA[RedisåŸºç¡€å…¥é—¨(ä¸‰)ä¸‰ç§ç‰¹æ®Šæ•°æ®ç±»å‹1. Geospatial åœ°ç†ä½ç½®
æœ‹å‹çš„å®šä½ï¼Œé™„è¿‘çš„äººï¼Œæ‰“è½¦è·ç¦»è®¡ç®—ï¼Ÿ

Redis çš„ Geo åœ¨Redis3.2 ç‰ˆæœ¬å°±æ¨å‡ºäº†ï¼ è¿™ä¸ªåŠŸèƒ½å¯ä»¥æ¨ç®—åœ°ç†ä½ç½®çš„ä¿¡æ¯ï¼Œä¸¤åœ°ä¹‹é—´çš„è·ç¦»ï¼Œæ–¹åœ†å‡ é‡Œçš„äººï¼å¯ä»¥æŸ¥è¯¢ä¸€äº›æµ‹è¯•æ•°æ®ï¼šhttp://www.jsons.cn/lngcodeinfo/0706D99C19A781A3/

  


å®˜æ–¹æ–‡æ¡£ï¼šhttps://www.redis.net.cn/order/3685.html

getadd æ·»åŠ åœ°ç†ä½ç½®

# getadd æ·»åŠ åœ°ç†ä½ç½®# è§„åˆ™ï¼šä¸¤çº§æ— æ³•ç›´æ¥æ·»åŠ ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šä¸‹è½½åŸå¸‚æ•°æ®ï¼Œç›´æ¥é€šè¿‡javaç¨‹åºä¸€æ¬¡æ€§å¯¼å…¥ï¼# æœ‰æ•ˆçš„ç»åº¦ä»-180åº¦åˆ°180åº¦ã€‚# æœ‰æ•ˆçš„çº¬åº¦ä»-85.05112878åº¦åˆ°85.05112878åº¦ã€‚# å½“åæ ‡ä½ç½®è¶…å‡ºä¸Šè¿°æŒ‡å®šèŒƒå›´æ—¶ï¼Œè¯¥å‘½ä»¤å°†ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚# 127.0.0.1:6379&gt; geoadd china:city 39.90 116.40 beijin(error) ERR invalid longitude,latitude pair 39.900000,116.400000# å‚æ•° key å€¼ï¼ˆï¼‰127.0.0.1:6379&gt; geoadd china:city 116.40 39.90 beijing(integer) 1127.0.0.1:6379&gt; geoadd china:city 121.47 31.23 shanghai(integer) 1127.0.0.1:6379&gt; geoadd china:city 106.50 29.53 chongqing 114.05 22.52 shengzhen(integer) 2127.0.0.1:6379&gt; geoadd china:city 120.16 30.24 hangzhou 108.96 34.26 xian(integer) 2


getposè·å¾—å½“å‰å®šä½ï¼šä¸€å®šæ˜¯ä¸€ä¸ªåæ ‡å€¼ï¼

127.0.0.1:6379&gt; GEOPOS china:city beijing # è·å–æŒ‡å®šçš„åŸå¸‚çš„ç»åº¦å’Œçº¬åº¦ï¼1) 1) &quot;116.39999896287918091&quot;   2) &quot;39.90000009167092543&quot;127.0.0.1:6379&gt; GEOPOS china:city beijing chongqing1) 1) &quot;116.39999896287918091&quot;   2) &quot;39.90000009167092543&quot;2) 1) &quot;106.49999767541885376&quot;   2) &quot;29.52999957900659211&quot;


GEODIST ä¸¤äººä¹‹é—´çš„è·ç¦»

å•ä½ï¼š  m è¡¨ç¤ºå•ä½ä¸ºç±³ã€‚  km è¡¨ç¤ºå•ä½ä¸ºåƒç±³ã€‚  mi è¡¨ç¤ºå•ä½ä¸ºè‹±é‡Œã€‚  ft è¡¨ç¤ºå•ä½ä¸ºè‹±å°ºã€‚

  127.0.0.1:6379&gt; GEODIST china:city beijing shanghai km # æŸ¥çœ‹ä¸Šæµ·åˆ°åŒ—äº¬çš„ç›´çº¿è·ç¦»&quot;1067.3788&quot;127.0.0.1:6379&gt; GEODIST china:city beijing chongqing km # æŸ¥çœ‹é‡åº†åˆ°åŒ—äº¬çš„ç›´çº¿è·ç¦»&quot;1464.0708&quot;

georadius ä»¥ç»™å®šçš„ç»çº¬åº¦ä¸ºä¸­å¿ƒï¼Œ æ‰¾å‡ºæŸä¸€åŠå¾„å†…çš„å…ƒç´ 


127.0.0.1:6379&gt; GEORADIUS china:city 110 30 1000 km # ä»¥110ï¼Œ30 è¿™ä¸ªç»çº¬åº¦ä¸ºä¸­å¿ƒï¼Œå¯»æ‰¾æ–¹åœ†1000kmå†…çš„åŸå¸‚1) &quot;chongqing&quot;2) &quot;xian&quot;3) &quot;shengzhen&quot;4) &quot;hangzhou&quot;127.0.0.1:6379&gt; GEORADIUS china:city 110 30 500 km1) &quot;chongqing&quot;2) &quot;xian&quot;127.0.0.1:6379&gt; GEORADIUS china:city 110 30 500 km withdist # æ˜¾ç¤ºåˆ°ä¸­é—´è·ç¦»çš„ä½ç½®1) 1) &quot;chongqing&quot;   2) &quot;341.9374&quot;2) 1) &quot;xian&quot;   2) &quot;483.8340&quot;127.0.0.1:6379&gt; GEORADIUS china:city 110 30 500 km withcoord # æ˜¾ç¤ºä»–äººçš„å®šä½ä¿¡æ¯1) 1) &quot;chongqing&quot;   2) 1) &quot;106.49999767541885376&quot;      2) &quot;29.52999957900659211&quot;2) 1) &quot;xian&quot;   2) 1) &quot;108.96000176668167114&quot;      2) &quot;34.25999964418929977&quot;127.0.0.1:6379&gt; GEORADIUS china:city 110 30 500 km withdist withcoord count 1 # ç­›é€‰å‡ºæŒ‡å®šçš„ç»“æœï¼1) 1) &quot;chongqing&quot;   2) &quot;341.9374&quot;   3) 1) &quot;106.49999767541885376&quot;      2) &quot;29.52999957900659211&quot;127.0.0.1:6379&gt; GEORADIUS china:city 110 30 500 km withdist withcoord count 21) 1) &quot;chongqing&quot;   2) &quot;341.9374&quot;   3) 1) &quot;106.49999767541885376&quot;      2) &quot;29.52999957900659211&quot;2) 1) &quot;xian&quot;   2) &quot;483.8340&quot;   3) 1) &quot;108.96000176668167114&quot;      2) &quot;34.25999964418929977&quot;


GEORADIUSBYMEMBER  æ‰¾å‡ºä½äºæŒ‡å®šå…ƒç´ å‘¨å›´çš„å…¶ä»–å…ƒç´ ï¼

127.0.0.1:6379&gt; GEORADIUSBYMEMBER china:city beijing 1000 km1) &quot;beijing&quot;2) &quot;xian&quot;127.0.0.1:6379&gt; GEORADIUSBYMEMBER china:city shanghai 400 km1) &quot;hangzhou&quot;2) &quot;shanghai&quot;


GEOHASH å‘½ä»¤ - è¿”å›ä¸€ä¸ªæˆ–å¤šä¸ªä½ç½®å…ƒç´ çš„ Geohash è¡¨ç¤º

127.0.0.1:6379&gt; geohash china:city beijing chongqing # å°†äºŒç»´çš„ç»çº¬åº¦è½¬æ¢ä¸ºä¸€ç»´çš„å­—ç¬¦ä¸²ï¼Œå¦‚æœä¸¤ä¸ªå­—ç¬¦ä¸²è¶Šæ¥è¿‘ï¼Œé‚£ä¹ˆåˆ™è·ç¦»è¶Šè¿‘ï¼1) &quot;wx4fbxxfke0&quot;2) &quot;wm5xzrybty0&quot;


GEO åº•å±‚çš„å®ç°åŸç†å…¶å®å°±æ˜¯ Zsetï¼æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Zsetå‘½ä»¤æ¥æ“ä½œgeoï¼

127.0.0.1:6379&gt; ZRANGE china:city 0 -1 # æŸ¥çœ‹åœ°å›¾ä¸­å…¨éƒ¨çš„å…ƒç´ 1) &quot;chongqing&quot;2) &quot;xian&quot;3) &quot;shengzhen&quot;4) &quot;hangzhou&quot;5) &quot;shanghai&quot;6) &quot;beijing&quot;127.0.0.1:6379&gt; zrem china:city beijing # ç§»é™¤æŒ‡å®šå…ƒç´ ï¼(integer) 1127.0.0.1:6379&gt; ZRANGE china:city 0 -11) &quot;chongqing&quot;2) &quot;xian&quot;3) &quot;shengzhen&quot;4) &quot;hangzhou&quot;5) &quot;shanghai&quot;

Hyperloglog
ä»€ä¹ˆæ˜¯åŸºæ•°ï¼Ÿ

åŸºæ•°ï¼ˆä¸é‡å¤çš„å…ƒç´ ï¼‰ &#x3D; 5ï¼Œå¯ä»¥æ¥å—è¯¯å·®ï¼
A &#123;1,3,5,7,8,7&#125;B &#123;1,3,5,7,8&#125;


ç®€ä»‹
  Redis 2.8.9 ç‰ˆæœ¬å°±æ›´æ–°äº† Hyperloglog æ•°æ®ç»“æ„ï¼  Redis Hyperloglog åŸºæ•°ç»Ÿè®¡çš„ç®—æ³•ï¼

ç½‘é¡µçš„ UV ï¼ˆä¸€ä¸ªäººè®¿é—®ä¸€ä¸ªç½‘ç«™å¤šæ¬¡ï¼Œä½†æ˜¯è¿˜æ˜¯ç®—ä½œä¸€ä¸ªäººï¼ï¼‰
  ä¼ ç»Ÿçš„æ–¹å¼ï¼Œ set ä¿å­˜ç”¨æˆ·çš„idï¼Œç„¶åå°±å¯ä»¥ç»Ÿè®¡ set ä¸­çš„å…ƒç´ æ•°é‡ä½œä¸ºæ ‡å‡†åˆ¤æ–­ !  è¿™ä¸ªæ–¹å¼å¦‚æœä¿å­˜å¤§é‡çš„ç”¨æˆ·idï¼Œå°±ä¼šæ¯”è¾ƒéº»çƒ¦ï¼æˆ‘ä»¬çš„ç›®çš„æ˜¯ä¸ºäº†è®¡æ•°ï¼Œè€Œä¸æ˜¯ä¿å­˜ç”¨æˆ·idï¼›  0.81% é”™è¯¯ç‡ï¼ ç»Ÿè®¡UVä»»åŠ¡ï¼Œå¯ä»¥å¿½ç•¥ä¸è®¡çš„ï¼

æµ‹è¯•ä½¿ç”¨
  127.0.0.1:6379&gt; PFadd mykey a b c d e f g h i j # åˆ›å»ºç¬¬ä¸€ç»„å…ƒç´  mykey(integer) 1127.0.0.1:6379&gt; PFCOUNT mykey # ç»Ÿè®¡ mykey å…ƒç´ çš„åŸºæ•°æ•°é‡(integer) 10127.0.0.1:6379&gt; PFadd mykey2 i j z x c v b n m # åˆ›å»ºç¬¬äºŒç»„å…ƒç´  mykey2(integer) 1127.0.0.1:6379&gt; PFCOUNT mykey2(integer) 9127.0.0.1:6379&gt; PFMERGE mykey3 mykey mykey2 # åˆå¹¶ä¸¤ç»„ mykey mykey2 =&gt; mykey3 å¹¶é›†OK127.0.0.1:6379&gt; PFCOUNT mykey3 # çœ‹å¹¶é›†çš„æ•°é‡ï¼(integer) 15

  å¦‚æœå…è®¸å®¹é”™ï¼Œé‚£ä¹ˆä¸€å®šå¯ä»¥ä½¿ç”¨ Hyperloglog ï¼  å¦‚æœä¸å…è®¸å®¹é”™ï¼Œå°±ä½¿ç”¨ set æˆ–è€…è‡ªå·±çš„æ•°æ®ç±»å‹å³å¯ï¼


Bitmap ä½å­˜å‚¨ç»Ÿè®¡ç”¨æˆ·ä¿¡æ¯ï¼Œæ´»è·ƒï¼Œä¸æ´»è·ƒï¼ ç™»å½• ã€ æœªç™»å½•ï¼ æ‰“å¡ï¼Œ365æ‰“å¡ï¼ ä¸¤ä¸ªçŠ¶æ€çš„ï¼Œéƒ½å¯ä»¥ä½¿ç”¨Bitmapsï¼Bitmap ä½å›¾ï¼Œæ•°æ®ç»“æ„ï¼ éƒ½æ˜¯æ“ä½œäºŒè¿›åˆ¶ä½æ¥è¿›è¡Œè®°å½•ï¼Œå°±åªæœ‰0 å’Œ 1 ä¸¤ä¸ªçŠ¶æ€ï¼365 å¤© &#x3D; 365 bit 1å­—èŠ‚ &#x3D; 8bit 46 ä¸ªå­—èŠ‚å·¦å³ï¼

ä½¿ç”¨bitmap æ¥è®°å½• å‘¨ä¸€åˆ°å‘¨æ—¥çš„æ‰“å¡ï¼å‘¨ä¸€ï¼š1 å‘¨äºŒï¼š0 å‘¨ä¸‰ï¼š0 å‘¨å››ï¼š1 â€¦â€¦

127.0.0.1:6379&gt; setbit sign 0 1(integer) 0127.0.0.1:6379&gt; setbit sign 1 0(integer) 0127.0.0.1:6379&gt; setbit sign 2 0(integer) 0127.0.0.1:6379&gt; setbit sign 3 1(integer) 0127.0.0.1:6379&gt; setbit sign 4 1(integer) 0127.0.0.1:6379&gt; setbit sign 5 0(integer) 0127.0.0.1:6379&gt; setbit sign 6 0(integer) 0127.0.0.1:6379&gt; getbit sign 3 # æŸ¥çœ‹æŸä¸€å¤©æ˜¯å¦æœ‰æ‰“å¡ï¼(integer) 1127.0.0.1:6379&gt; getbit sign 6(integer) 0127.0.0.1:6379&gt; bitcount sign # ç»Ÿè®¡è¿™å‘¨çš„æ‰“å¡è®°å½•ï¼Œå°±å¯ä»¥çœ‹åˆ°æ˜¯å¦æœ‰å…¨å‹¤ï¼(integer) 3127.0.0.1:6379&gt;]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>RedisåŸºç¡€å…¥é—¨</tag>
      </tags>
  </entry>
  <entry>
    <title>RedisåŸºç¡€å…¥é—¨(ä¹)Rediså‘å¸ƒè®¢é˜…</title>
    <url>/Redis/Redis%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8(%E4%B9%9D)Redis%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85/</url>
    <content><![CDATA[RedisåŸºç¡€å…¥é—¨(ä¹)Rediså‘å¸ƒè®¢é˜…Redis å‘å¸ƒè®¢é˜…(pub&#x2F;sub)æ˜¯ä¸€ç§æ¶ˆæ¯é€šä¿¡æ¨¡å¼ï¼šå‘é€è€…(pub)å‘é€æ¶ˆæ¯ï¼Œè®¢é˜…è€…(sub)æ¥æ”¶æ¶ˆæ¯ã€‚å¾®ä¿¡ã€å¾®åšã€å…³æ³¨ç³»ç»Ÿï¼Redis å®¢æˆ·ç«¯å¯ä»¥è®¢é˜…ä»»æ„æ•°é‡çš„é¢‘é“ã€‚è®¢é˜…&#x2F;å‘å¸ƒæ¶ˆæ¯å›¾ï¼šç¬¬ä¸€ä¸ªï¼šæ¶ˆæ¯å‘é€è€…ï¼Œ ç¬¬äºŒä¸ªï¼šé¢‘é“ ç¬¬ä¸‰ä¸ªï¼šæ¶ˆæ¯è®¢é˜…è€…ï¼

ä¸‹å›¾å±•ç¤ºäº†é¢‘é“ channel1 ï¼Œ ä»¥åŠè®¢é˜…è¿™ä¸ªé¢‘é“çš„ä¸‰ä¸ªå®¢æˆ·ç«¯ â€”â€” client2 ã€ client5 å’Œ client1 ä¹‹é—´çš„

å½“æœ‰æ–°æ¶ˆæ¯é€šè¿‡ PUBLISH å‘½ä»¤å‘é€ç»™é¢‘é“ channel1 æ—¶ï¼Œ è¿™ä¸ªæ¶ˆæ¯å°±ä¼šè¢«å‘é€ç»™è®¢é˜…å®ƒçš„ä¸‰ä¸ªå®¢æˆ·ç«¯ï¼š


å‘½ä»¤

è¿™äº›å‘½ä»¤è¢«å¹¿æ³›ç”¨äºæ„å»ºå³æ—¶é€šä¿¡åº”ç”¨ï¼Œæ¯”å¦‚ç½‘ç»œèŠå¤©å®¤(chatroom)å’Œå®æ—¶å¹¿æ’­ã€å®æ—¶æé†’ç­‰ã€‚

  
  

æµ‹è¯•

è®¢é˜…ç«¯

  127.0.0.1:6379&gt; SUBSCRIBE peppa # è®¢é˜…ä¸€ä¸ªé¢‘é“ peppaReading messages... (press Ctrl-C to quit)1) &quot;subscribe&quot;2) &quot;peppa&quot;3) (integer) 1# ç­‰å¾…è¯»å–æ¨é€çš„ä¿¡æ¯1) &quot;message&quot; # æ¶ˆæ¯2) &quot;peppa&quot; # é‚£ä¸ªé¢‘é“çš„æ¶ˆæ¯3) &quot;hello,kuangshen&quot; # æ¶ˆæ¯çš„å…·ä½“å†…å®¹1) &quot;message&quot;2) &quot;peppa&quot;3) &quot;hello,redis&quot;

å‘é€ç«¯ï¼š

  127.0.0.1:6379&gt; PUBLISH peppa &quot;hello,kuangshen&quot; # å‘å¸ƒè€…å‘å¸ƒæ¶ˆæ¯åˆ°é¢‘é“ï¼(integer) 1127.0.0.1:6379&gt; PUBLISH peppa &quot;hello,redis&quot; # å‘å¸ƒè€…å‘å¸ƒæ¶ˆæ¯åˆ°é¢‘é“ï¼(integer) 1127.0.0.1:6379&gt;

åŸç†
  Redisæ˜¯ä½¿ç”¨Cå®ç°çš„ï¼Œé€šè¿‡åˆ†æ Redis æºç é‡Œçš„ pubsub.c æ–‡ä»¶ï¼Œäº†è§£å‘å¸ƒå’Œè®¢é˜…æœºåˆ¶çš„åº•å±‚å®ç°ï¼Œç±æ­¤åŠ æ·±å¯¹ Redis çš„ç†è§£ã€‚
  Redis é€šè¿‡ PUBLISH ã€SUBSCRIBE å’Œ PSUBSCRIBE ç­‰å‘½ä»¤å®ç°å‘å¸ƒå’Œè®¢é˜…åŠŸèƒ½ã€‚  å¾®ä¿¡ï¼š  é€šè¿‡ SUBSCRIBE å‘½ä»¤è®¢é˜…æŸé¢‘é“åï¼Œredis-server é‡Œç»´æŠ¤äº†ä¸€ä¸ªå­—å…¸ï¼Œå­—å…¸çš„é”®å°±æ˜¯ä¸€ä¸ªä¸ª é¢‘é“ï¼è€Œå­—å…¸çš„å€¼åˆ™æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨ä¸­ä¿å­˜äº†æ‰€æœ‰è®¢é˜…è¿™ä¸ª channel çš„å®¢æˆ·ç«¯ã€‚SUBSCRIBE å‘½ä»¤çš„å…³é”®ï¼Œå°±æ˜¯å°†å®¢æˆ·ç«¯æ·»åŠ åˆ°ç»™å®š channel çš„è®¢é˜…é“¾è¡¨ä¸­ã€‚
  


é€šè¿‡ PUBLISH å‘½ä»¤å‘è®¢é˜…è€…å‘é€æ¶ˆæ¯ï¼Œredis-server ä¼šä½¿ç”¨ç»™å®šçš„é¢‘é“ä½œä¸ºé”®ï¼Œåœ¨å®ƒæ‰€ç»´æŠ¤çš„ channelå­—å…¸ä¸­æŸ¥æ‰¾è®°å½•äº†è®¢é˜…è¿™ä¸ªé¢‘é“çš„æ‰€æœ‰å®¢æˆ·ç«¯çš„é“¾è¡¨ï¼Œéå†è¿™ä¸ªé“¾è¡¨ï¼Œå°†æ¶ˆæ¯å‘å¸ƒç»™æ‰€æœ‰è®¢é˜…è€…ã€‚
Pub&#x2F;Sub ä»å­—é¢ä¸Šç†è§£å°±æ˜¯å‘å¸ƒï¼ˆPublishï¼‰ä¸è®¢é˜…ï¼ˆSubscribeï¼‰ï¼Œåœ¨Redisä¸­ï¼Œä½ å¯ä»¥è®¾å®šå¯¹æŸä¸€ä¸ªkeyå€¼è¿›è¡Œæ¶ˆæ¯å‘å¸ƒåŠæ¶ˆæ¯è®¢é˜…ï¼Œå½“ä¸€ä¸ªkeyå€¼ä¸Šè¿›è¡Œäº†æ¶ˆæ¯å‘å¸ƒåï¼Œæ‰€æœ‰è®¢é˜…å®ƒçš„å®¢æˆ·ç«¯éƒ½ä¼šæ”¶åˆ°ç›¸åº”çš„æ¶ˆæ¯ã€‚è¿™ä¸€åŠŸèƒ½æœ€æ˜æ˜¾çš„ç”¨æ³•å°±æ˜¯ç”¨ä½œå®æ—¶æ¶ˆæ¯ç³»ç»Ÿï¼Œæ¯”å¦‚æ™®é€šçš„å³æ—¶èŠå¤©ï¼Œç¾¤èŠç­‰åŠŸèƒ½ã€‚

ä½¿ç”¨åœºæ™¯
å®æ—¶æ¶ˆæ¯ç³»ç»Ÿï¼
äº‹å®èŠå¤©ï¼ï¼ˆé¢‘é“å½“åšèŠå¤©å®¤ï¼Œå°†ä¿¡æ¯å›æ˜¾ç»™æ‰€æœ‰äººå³å¯ï¼ï¼‰
è®¢é˜…ï¼Œå…³æ³¨ç³»ç»Ÿéƒ½æ˜¯å¯ä»¥çš„ï¼ç¨å¾®å¤æ‚çš„åœºæ™¯æˆ‘ä»¬å°±ä¼šä½¿ç”¨ æ¶ˆæ¯ä¸­é—´ä»¶



]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>RedisåŸºç¡€å…¥é—¨</tag>
      </tags>
  </entry>
  <entry>
    <title>RedisåŸºç¡€å…¥é—¨(äºŒ)äº”å¤§æ•°æ®ç±»å‹</title>
    <url>/Redis/Redis%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8(%E4%BA%8C)%E4%BA%94%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/</url>
    <content><![CDATA[RedisåŸºç¡€å…¥é—¨(äºŒ)äº”å¤§æ•°æ®ç±»å‹1. å®˜ç½‘æ–‡æ¡£
Redis æ˜¯ä¸€ä¸ªå¼€æºï¼ˆBSDè®¸å¯ï¼‰çš„ï¼Œå†…å­˜ä¸­çš„æ•°æ®ç»“æ„å­˜å‚¨ç³»ç»Ÿï¼Œå®ƒå¯ä»¥ç”¨ä½œæ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä¸­é—´ä»¶ã€‚ å®ƒæ”¯æŒå¤šç§ç±»å‹çš„æ•°æ®ç»“æ„ï¼Œå¦‚Â å­—ç¬¦ä¸²ï¼ˆstringsï¼‰ï¼ŒÂ æ•£åˆ—ï¼ˆhashesï¼‰ï¼ŒÂ åˆ—è¡¨ï¼ˆlistsï¼‰ï¼ŒÂ é›†åˆï¼ˆsetsï¼‰ï¼ŒÂ æœ‰åºé›†åˆï¼ˆsorted setsï¼‰Â ä¸èŒƒå›´æŸ¥è¯¢ï¼ŒÂ bitmapsï¼ŒÂ hyperloglogsÂ å’ŒÂ åœ°ç†ç©ºé—´ï¼ˆgeospatialï¼‰Â ç´¢å¼•åŠå¾„æŸ¥è¯¢ã€‚ Redis å†…ç½®äº†Â å¤åˆ¶ï¼ˆreplicationï¼‰ï¼ŒLUAè„šæœ¬ï¼ˆLua scriptingï¼‰ï¼ŒÂ LRUé©±åŠ¨äº‹ä»¶ï¼ˆLRU evictionï¼‰ï¼Œäº‹åŠ¡ï¼ˆtransactionsï¼‰Â å’Œä¸åŒçº§åˆ«çš„Â ç£ç›˜æŒä¹…åŒ–ï¼ˆpersistenceï¼‰ï¼Œ å¹¶é€šè¿‡Â Rediså“¨å…µï¼ˆSentinelï¼‰å’Œè‡ªåŠ¨Â åˆ†åŒºï¼ˆClusterï¼‰æä¾›é«˜å¯ç”¨æ€§ï¼ˆhigh availabilityï¼‰ã€‚
2. Redis-Key127.0.0.1:6379&gt; keys * # æŸ¥çœ‹æ‰€æœ‰çš„key(empty list or set)127.0.0.1:6379&gt; set name     yuanxw # set keyOK127.0.0.1:6379&gt; keys *1) &quot;name&quot;127.0.0.1:6379&gt; set age 1OK127.0.0.1:6379&gt; keys *1) &quot;age&quot;2) &quot;name&quot;127.0.0.1:6379&gt; EXISTS name # åˆ¤æ–­å½“å‰çš„keyæ˜¯å¦å­˜åœ¨(integer) 1127.0.0.1:6379&gt; EXISTS name1(integer) 0127.0.0.1:6379&gt; move name 1 # ç§»é™¤å½“å‰çš„key(integer) 1127.0.0.1:6379&gt; keys *1) &quot;age&quot;127.0.0.1:6379&gt; set name beijingOK127.0.0.1:6379&gt; keys *1) &quot;age&quot;2) &quot;name&quot;127.0.0.1:6379&gt; clear127.0.0.1:6379&gt; keys *1) &quot;age&quot;2) &quot;name&quot;127.0.0.1:6379&gt; get name&quot;beijing&quot;127.0.0.1:6379&gt; EXPIRE name 10 # è®¾ç½®keyçš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½æ˜¯ç§’(integer) 1127.0.0.1:6379&gt; ttl name # æŸ¥çœ‹å½“å‰keyçš„å‰©ä½™æ—¶é—´(integer) 4127.0.0.1:6379&gt; ttl name(integer) 3127.0.0.1:6379&gt; ttl name(integer) 2127.0.0.1:6379&gt; ttl name(integer) 1127.0.0.1:6379&gt; ttl name(integer) -2127.0.0.1:6379&gt; get name(nil)127.0.0.1:6379&gt; type name # æŸ¥çœ‹å½“å‰keyçš„ä¸€ä¸ªç±»å‹ï¼string127.0.0.1:6379&gt; type agestring

åé¢å¦‚æœé‡åˆ°ä¸ä¼šçš„å‘½ä»¤ï¼Œå¯ä»¥åœ¨å®˜ç½‘æŸ¥çœ‹å¸®åŠ©æ–‡æ¡£ï¼

3. Stringï¼ˆå­—ç¬¦ä¸²ï¼‰##########################################################################127.0.0.1:6379&gt; set key1 v1 # è®¾ç½®å€¼OK127.0.0.1:6379&gt; get key1 # è·å¾—å€¼&quot;v1&quot;127.0.0.1:6379&gt; keys * # è·å¾—æ‰€æœ‰çš„key1) &quot;key1&quot;127.0.0.1:6379&gt; EXISTS key1 # åˆ¤æ–­æŸä¸€ä¸ªkeyæ˜¯å¦å­˜åœ¨(integer) 1127.0.0.1:6379&gt; APPEND key1 &quot;hello&quot; # è¿½åŠ å­—ç¬¦ä¸²ï¼Œå¦‚æœå½“å‰keyä¸å­˜åœ¨ï¼Œå°±ç›¸å½“äºsetkey(integer) 7127.0.0.1:6379&gt; get key1&quot;v1hello&quot;127.0.0.1:6379&gt; STRLEN key1 # è·å–å­—ç¬¦ä¸²çš„é•¿åº¦ï¼(integer) 7127.0.0.1:6379&gt; APPEND key1 &quot;,peppa&quot;(integer) 13127.0.0.1:6379&gt; STRLEN key1(integer) 13127.0.0.1:6379&gt; get key1&quot;v1hello,peppa&quot;########################################################################### i++# æ­¥é•¿ i+=127.0.0.1:6379&gt; set views 0 # åˆå§‹æµè§ˆé‡ä¸º0OK127.0.0.1:6379&gt; get views&quot;0&quot;127.0.0.1:6379&gt; incr views # è‡ªå¢1 æµè§ˆé‡å˜ä¸º1(integer) 1127.0.0.1:6379&gt; incr views(integer) 2127.0.0.1:6379&gt; get views&quot;2&quot;127.0.0.1:6379&gt; decr views # è‡ªå‡1 æµè§ˆé‡-1(integer) 1127.0.0.1:6379&gt; decr views(integer) 0127.0.0.1:6379&gt; decr views(integer) -1127.0.0.1:6379&gt; get views&quot;-1&quot;127.0.0.1:6379&gt; INCRBY views 10 # å¯ä»¥è®¾ç½®æ­¥é•¿ï¼ŒæŒ‡å®šå¢é‡ï¼(integer) 9127.0.0.1:6379&gt; INCRBY views 10(integer) 19127.0.0.1:6379&gt; DECRBY views 5(integer) 14########################################################################### å­—ç¬¦ä¸²èŒƒå›´ range127.0.0.1:6379&gt; set key1 &quot;hello,peppa&quot; # è®¾ç½® key1 çš„å€¼OK127.0.0.1:6379&gt; get key1&quot;hello,peppa&quot;127.0.0.1:6379&gt; GETRANGE key1 0 3 # æˆªå–å­—ç¬¦ä¸² [0,3]&quot;hell&quot;127.0.0.1:6379&gt; GETRANGE key1 0 -1 # è·å–å…¨éƒ¨çš„å­—ç¬¦ä¸² å’Œ get keyæ˜¯ä¸€æ ·çš„&quot;hello,peppa&quot;# æ›¿æ¢ï¼127.0.0.1:6379&gt; set key2 abcdefgOK127.0.0.1:6379&gt; get key2&quot;abcdefg&quot;127.0.0.1:6379&gt; SETRANGE key2 1 xx # æ›¿æ¢æŒ‡å®šä½ç½®å¼€å§‹çš„å­—ç¬¦ä¸²ï¼(integer) 7127.0.0.1:6379&gt; get key2&quot;axxdefg&quot;########################################################################### setex (set with expire) # è®¾ç½®è¿‡æœŸæ—¶é—´# setnx (set if not exist) # ä¸å­˜åœ¨åœ¨è®¾ç½® ï¼ˆåœ¨åˆ†å¸ƒå¼é”ä¸­ä¼šå¸¸å¸¸ä½¿ç”¨ï¼ï¼‰127.0.0.1:6379&gt; setex key3 30 &quot;hello&quot; # è®¾ç½®key3 çš„å€¼ä¸º hello,30ç§’åè¿‡æœŸOK127.0.0.1:6379&gt; ttl key3(integer) 26127.0.0.1:6379&gt; get key3&quot;hello&quot;127.0.0.1:6379&gt; setnx mykey &quot;redis&quot; # å¦‚æœmykey ä¸å­˜åœ¨ï¼Œåˆ›å»ºmykey(integer) 1127.0.0.1:6379&gt; keys *1) &quot;key2&quot;2) &quot;mykey&quot;3) &quot;key1&quot;127.0.0.1:6379&gt; ttl key3(integer) -2127.0.0.1:6379&gt; setnx mykey &quot;MongoDB&quot; # å¦‚æœmykeyå­˜åœ¨ï¼Œåˆ›å»ºå¤±è´¥ï¼(integer) 0127.0.0.1:6379&gt; get mykey&quot;redis&quot;##########################################################################msetmget127.0.0.1:6379&gt; mset k1 v1 k2 v2 k3 v3 # åŒæ—¶è®¾ç½®å¤šä¸ªå€¼OK127.0.0.1:6379&gt; keys *1) &quot;k1&quot;2) &quot;k2&quot;3) &quot;k3&quot;127.0.0.1:6379&gt; mget k1 k2 k3 # åŒæ—¶è·å–å¤šä¸ªå€¼1) &quot;v1&quot;2) &quot;v2&quot;3) &quot;v3&quot;127.0.0.1:6379&gt; msetnx k1 v1 k4 v4 # msetnx æ˜¯ä¸€ä¸ªåŸå­æ€§çš„æ“ä½œï¼Œè¦ä¹ˆä¸€èµ·æˆåŠŸï¼Œè¦ä¹ˆä¸€èµ·å¤±è´¥ï¼(integer) 0127.0.0.1:6379&gt; get k4(nil)# å¯¹è±¡set user:1 &#123;name:zhangsan,age:3&#125; # è®¾ç½®ä¸€ä¸ªuser:1 å¯¹è±¡ å€¼ä¸º jsonå­—ç¬¦æ¥ä¿å­˜ä¸€ä¸ªå¯¹è±¡ï¼# è¿™é‡Œçš„keyæ˜¯ä¸€ä¸ªå·§å¦™çš„è®¾è®¡ï¼š user:&#123;id&#125;:&#123;filed&#125; , å¦‚æ­¤è®¾è®¡åœ¨Redisä¸­æ˜¯å®Œå…¨OKäº†ï¼127.0.0.1:6379&gt; mset user:1:name zhangsan user:1:age 2OK127.0.0.1:6379&gt; mget user:1:name user:1:age1) &quot;zhangsan&quot;2) &quot;2&quot;##########################################################################getset # å…ˆgetç„¶ååœ¨set127.0.0.1:6379&gt; getset db redis # å¦‚æœä¸å­˜åœ¨å€¼ï¼Œåˆ™è¿”å› nil(nil)127.0.0.1:6379&gt; get db&quot;redis&quot;127.0.0.1:6379&gt; getset db mongodb # å¦‚æœå­˜åœ¨å€¼ï¼Œè·å–åŸæ¥çš„å€¼ï¼Œå¹¶è®¾ç½®æ–°çš„å€¼&quot;redis&quot;127.0.0.1:6379&gt; get db&quot;mongodb&quot;

æ•°æ®ç»“æ„æ˜¯ç›¸åŒçš„ï¼Stringç±»ä¼¼çš„ä½¿ç”¨åœºæ™¯ï¼švalueé™¤äº†æ˜¯æˆ‘ä»¬çš„å­—ç¬¦ä¸²è¿˜å¯ä»¥æ˜¯æˆ‘ä»¬çš„æ•°å­—ï¼

è®¡æ•°å™¨
ç»Ÿè®¡å¤šå•ä½çš„æ•°é‡
ç²‰ä¸æ•°
å¯¹è±¡ç¼“å­˜å­˜å‚¨ï¼

Listï¼ˆåˆ—è¡¨ï¼‰åŸºæœ¬çš„æ•°æ®ç±»å‹ï¼šåˆ—è¡¨
åœ¨redisé‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠlistç©æˆ ï¼Œæ ˆã€é˜Ÿåˆ—ã€é˜»å¡é˜Ÿåˆ—ï¼æ‰€æœ‰çš„listå‘½ä»¤éƒ½æ˜¯ç”¨lå¼€å¤´çš„ï¼ŒRedisä¸åŒºåˆ†å¤§å°å‘½ä»¤

åœ¨redisé‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠlistç©æˆ ï¼Œæ ˆã€é˜Ÿåˆ—ã€é˜»å¡é˜Ÿåˆ—ï¼æ‰€æœ‰çš„listå‘½ä»¤éƒ½æ˜¯ç”¨lå¼€å¤´çš„ï¼ŒRedisä¸åŒºåˆ†å¤§å°å‘½ä»¤

##########################################################################127.0.0.1:6379&gt; LPUSH list one # å°†ä¸€ä¸ªå€¼æˆ–è€…å¤šä¸ªå€¼ï¼Œæ’å…¥åˆ°åˆ—è¡¨å¤´éƒ¨ ï¼ˆå·¦ï¼‰(integer) 1127.0.0.1:6379&gt; LPUSH list two(integer) 2127.0.0.1:6379&gt; LPUSH list three(integer) 3127.0.0.1:6379&gt; LRANGE list 0 -1 # è·å–listä¸­å€¼ï¼1) &quot;three&quot;2) &quot;two&quot;3) &quot;one&quot;127.0.0.1:6379&gt; LRANGE list 0 1 # é€šè¿‡åŒºé—´è·å–å…·ä½“çš„å€¼ï¼1) &quot;three&quot;2) &quot;two&quot;127.0.0.1:6379&gt; Rpush list righr # å°†ä¸€ä¸ªå€¼æˆ–è€…å¤šä¸ªå€¼ï¼Œæ’å…¥åˆ°åˆ—è¡¨ä½éƒ¨ ï¼ˆå³ï¼‰(integer) 4127.0.0.1:6379&gt; LRANGE list 0 -11) &quot;three&quot;2) &quot;two&quot;3) &quot;one&quot;4) &quot;righr&quot;##########################################################################LPOPRPOP127.0.0.1:6379&gt; LRANGE list 0 -11) &quot;three&quot;2) &quot;two&quot;3) &quot;one&quot;4) &quot;righr&quot;127.0.0.1:6379&gt; Lpop list # ç§»é™¤listçš„ç¬¬ä¸€ä¸ªå…ƒç´ &quot;three&quot;127.0.0.1:6379&gt; Rpop list # ç§»é™¤listçš„æœ€åä¸€ä¸ªå…ƒç´ &quot;righr&quot;127.0.0.1:6379&gt; LRANGE list 0 -11) &quot;two&quot;2) &quot;one&quot;##########################################################################Lindex127.0.0.1:6379&gt; LRANGE list 0 -11) &quot;two&quot;2) &quot;one&quot;127.0.0.1:6379&gt; lindex list 1 # é€šè¿‡ä¸‹æ ‡è·å¾— list ä¸­çš„æŸä¸€ä¸ªå€¼ï¼&quot;one&quot;127.0.0.1:6379&gt; lindex list 0&quot;two&quot;##########################################################################Llen127.0.0.1:6379&gt; Lpush list one(integer) 1127.0.0.1:6379&gt; Lpush list two(integer) 2127.0.0.1:6379&gt; Lpush list three(integer) 3127.0.0.1:6379&gt; Llen list # è¿”å›åˆ—è¡¨çš„é•¿åº¦(integer) 3127.0.0.1:6379&gt; Lpush list three(integer) 4##########################################################################ç§»é™¤æŒ‡å®šçš„å€¼ï¼å–å…³ uidLrem127.0.0.1:6379&gt; LRANGE list 0 -11) &quot;three&quot;2) &quot;three&quot;3) &quot;two&quot;4) &quot;one&quot;127.0.0.1:6379&gt; lrem list 1 one # ç§»é™¤listé›†åˆä¸­æŒ‡å®šä¸ªæ•°çš„valueï¼Œç²¾ç¡®åŒ¹é…(integer) 1127.0.0.1:6379&gt; LRANGE list 0 -11) &quot;three&quot;2) &quot;three&quot;3) &quot;two&quot;127.0.0.1:6379&gt; lrem list 1 three(integer) 1127.0.0.1:6379&gt; LRANGE list 0 -11) &quot;three&quot;2) &quot;two&quot;127.0.0.1:6379&gt; Lpush list three(integer) 3127.0.0.1:6379&gt; lrem list 2 three(integer) 2127.0.0.1:6379&gt; LRANGE list 0 -11) &quot;two&quot;##########################################################################trim ä¿®å‰ªï¼›list æˆªæ–­!127.0.0.1:6379&gt; FLUSHDBOK127.0.0.1:6379&gt; keys *(empty list or set)127.0.0.1:6379&gt; Rpush mylist &quot;hello&quot;(integer) 1127.0.0.1:6379&gt; Rpush mylist &quot;hello1&quot;(integer) 2127.0.0.1:6379&gt; Rpush mylist &quot;hello2&quot;(integer) 3127.0.0.1:6379&gt; Rpush mylist &quot;hello3&quot;(integer) 4127.0.0.1:6379&gt; ltrim mylist 1 2 # é€šè¿‡ä¸‹æ ‡æˆªå–æŒ‡å®šçš„é•¿åº¦ï¼Œè¿™ä¸ªlistå·²ç»è¢«æ”¹å˜äº†ï¼Œæˆªæ–­äº†åªå‰©ä¸‹æˆªå–çš„å…ƒç´ ï¼OK127.0.0.1:6379&gt; LRANGE mylist 0 -11) &quot;hello1&quot;2) &quot;hello2&quot;##########################################################################rpoplpush # ç§»é™¤åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œå°†ä»–ç§»åŠ¨åˆ°æ–°çš„åˆ—è¡¨ä¸­ï¼127.0.0.1:6379&gt; FLUSHDBOK127.0.0.1:6379&gt; rpush mylist &quot;hello&quot;(integer) 1127.0.0.1:6379&gt; rpush mylist &quot;hello1&quot;(integer) 2127.0.0.1:6379&gt; rpush mylist &quot;hello2&quot;(integer) 3127.0.0.1:6379&gt; rpoplpush mylist myotherlist # ç§»é™¤åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œå°†ä»–ç§»åŠ¨åˆ°æ–°çš„åˆ—è¡¨ä¸­ï¼&quot;hello2&quot;127.0.0.1:6379&gt; lrange mylist 0 -1 # æŸ¥çœ‹åŸæ¥çš„åˆ—è¡¨1) &quot;hello&quot;2) &quot;hello1&quot;127.0.0.1:6379&gt; lrange myotherlist 0 -1 # æŸ¥çœ‹ç›®æ ‡åˆ—è¡¨ä¸­ï¼Œç¡®å®å­˜åœ¨æ”¹å€¼ï¼1) &quot;hello2&quot;##########################################################################lset å°†åˆ—è¡¨ä¸­æŒ‡å®šä¸‹æ ‡çš„å€¼æ›¿æ¢ä¸ºå¦å¤–ä¸€ä¸ªå€¼ï¼Œæ›´æ–°æ“ä½œ127.0.0.1:6379&gt; EXISTS list # åˆ¤æ–­è¿™ä¸ªåˆ—è¡¨æ˜¯å¦å­˜åœ¨(integer) 0127.0.0.1:6379&gt; lset list 0 item # å¦‚æœä¸å­˜åœ¨åˆ—è¡¨æˆ‘ä»¬å»æ›´æ–°å°±ä¼šæŠ¥é”™(error) ERR no such key127.0.0.1:6379&gt; lpush list value1(integer) 1127.0.0.1:6379&gt; LRANGE list 0 01) &quot;value1&quot;127.0.0.1:6379&gt; lset list 0 item # å¦‚æœå­˜åœ¨ï¼Œæ›´æ–°å½“å‰ä¸‹æ ‡çš„å€¼OK127.0.0.1:6379&gt; LRANGE list 0 01) &quot;item&quot;127.0.0.1:6379&gt; lset list 1 other # å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä¼šæŠ¥é”™ï¼(error) ERR index out of range##########################################################################linsert # å°†æŸä¸ªå…·ä½“çš„valueæ’å…¥åˆ°åˆ—æŠŠä½ ä¸­æŸä¸ªå…ƒç´ çš„å‰é¢æˆ–è€…åé¢ï¼127.0.0.1:6379&gt; FLUSHDBOK127.0.0.1:6379&gt; Rpush mylist &quot;hello&quot;(integer) 1127.0.0.1:6379&gt; Rpush mylist &quot;world&quot;(integer) 2127.0.0.1:6379&gt; LINSERT mylist before &quot;world&quot; &quot;other&quot;(integer) 3127.0.0.1:6379&gt; LRANGE mylist 0 -11) &quot;hello&quot;2) &quot;other&quot;3) &quot;world&quot;127.0.0.1:6379&gt; LINSERT mylist after world new(integer) 4127.0.0.1:6379&gt; LRANGE mylist 0 -11) &quot;hello&quot;2) &quot;other&quot;3) &quot;world&quot;4) &quot;new&quot;

å°ç»“ï¼š

listå®é™…ä¸Šæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œbefore Node after ï¼Œ leftï¼Œright éƒ½å¯ä»¥æ’å…¥å€¼ã€‚
å¦‚æœkey ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„é“¾è¡¨ã€‚å¦‚æœkeyå­˜åœ¨ï¼Œæ–°å¢å†…å®¹
å¦‚æœkeyå­˜åœ¨ï¼Œæ–°å¢å†…å®¹
åœ¨ä¸¤è¾¹æ’å…¥æˆ–è€…æ”¹åŠ¨å€¼ï¼Œæ•ˆç‡æœ€é«˜ï¼ ä¸­é—´å…ƒç´ ï¼Œç›¸å¯¹æ¥è¯´æ•ˆç‡ä¼šä½ä¸€ç‚¹~
æ¶ˆæ¯æ’é˜Ÿï¼æ¶ˆæ¯é˜Ÿåˆ— ï¼ˆLpush Rpopï¼‰ï¼Œ æ ˆï¼ˆ Lpush Lpopï¼‰ï¼

Setï¼ˆé›†åˆï¼‰setä¸­çš„å€¼æ˜¯ä¸èƒ½é‡è¯»çš„ï¼
#########################################################################127.0.0.1:6379&gt; sadd myset &quot;hello&quot; # seté›†åˆä¸­æ·»åŠ åŒ€é€Ÿ(integer) 1127.0.0.1:6379&gt; sadd myset &quot;peppa&quot;(integer) 1127.0.0.1:6379&gt; sadd myset &quot;lovepeppa&quot;(integer) 1127.0.0.1:6379&gt; SMEMBERS myset # æŸ¥çœ‹æŒ‡å®šsetçš„æ‰€æœ‰å€¼1) &quot;hello&quot;2) &quot;lovepeppa&quot;3) &quot;peppa&quot;127.0.0.1:6379&gt; SISMEMBER myset hello # åˆ¤æ–­æŸä¸€ä¸ªå€¼æ˜¯ä¸æ˜¯åœ¨seté›†åˆä¸­ï¼(integer) 1127.0.0.1:6379&gt; SISMEMBER myset world(integer) 0##########################################################################127.0.0.1:6379&gt; scard myset # è·å–seté›†åˆä¸­çš„å†…å®¹å…ƒç´ ä¸ªæ•°ï¼(integer) 3##########################################################################rem127.0.0.1:6379&gt; srem myset hello # ç§»é™¤seté›†åˆä¸­çš„æŒ‡å®šå…ƒç´ (integer) 1127.0.0.1:6379&gt; scard myset(integer) 2127.0.0.1:6379&gt; SMEMBERS myset2) &quot;lovepeppa&quot;3) &quot;peppa&quot;##########################################################################set æ— åºä¸é‡å¤é›†åˆã€‚æŠ½éšæœºï¼127.0.0.1:6379&gt; sadd myset &quot;lovepeppa2&quot;(integer) 1127.0.0.1:6379&gt; SMEMBERS myset1) &quot;lovepeppa2&quot;2) &quot;peppa&quot;3) &quot;lovepeppa&quot;127.0.0.1:6379&gt; SRANDMEMBER myset # éšæœºæŠ½é€‰å‡ºä¸€ä¸ªå…ƒç´ &quot;peppa&quot;127.0.0.1:6379&gt; SRANDMEMBER myset&quot;peppa&quot;127.0.0.1:6379&gt; SRANDMEMBER myset&quot;peppa&quot;127.0.0.1:6379&gt; SRANDMEMBER myset&quot;peppa&quot;127.0.0.1:6379&gt; SRANDMEMBER myset 2 # éšæœºæŠ½é€‰å‡ºæŒ‡å®šä¸ªæ•°çš„å…ƒç´ 1) &quot;lovepeppa&quot;2) &quot;lovepeppa2&quot;127.0.0.1:6379&gt; SRANDMEMBER myset 21) &quot;lovepeppa&quot;2) &quot;lovepeppa2&quot;127.0.0.1:6379&gt; SRANDMEMBER myset # éšæœºæŠ½é€‰å‡ºä¸€ä¸ªå…ƒç´ &quot;lovepeppa2&quot;##########################################################################åˆ é™¤å®šçš„keyï¼Œéšæœºåˆ é™¤keyï¼127.0.0.1:6379&gt; SMEMBERS myset1) &quot;lovepeppa2&quot;2) &quot;lovepeppa&quot;3) &quot;peppa&quot;127.0.0.1:6379&gt; spop myset # éšæœºåˆ é™¤ä¸€äº›seté›†åˆä¸­çš„å…ƒç´ ï¼&quot;lovepeppa2&quot;127.0.0.1:6379&gt; spop myset&quot;lovepeppa&quot;127.0.0.1:6379&gt; SMEMBERS myset1) &quot;peppa&quot;##########################################################################å°†ä¸€ä¸ªæŒ‡å®šçš„å€¼ï¼Œç§»åŠ¨åˆ°å¦å¤–ä¸€ä¸ªseté›†åˆï¼127.0.0.1:6379&gt; FLUSHDBOK127.0.0.1:6379&gt; sadd myset &quot;hello&quot;(integer) 1127.0.0.1:6379&gt; sadd myset &quot;world&quot;(integer) 1127.0.0.1:6379&gt; sadd myset &quot;peppa&quot;(integer) 1127.0.0.1:6379&gt; sadd myset2 &quot;set2&quot;(integer) 1127.0.0.1:6379&gt; smove myset myset2 &quot;peppa&quot; # å°†ä¸€ä¸ªæŒ‡å®šçš„å€¼ï¼Œç§»åŠ¨åˆ°å¦å¤–ä¸€ä¸ªseté›†åˆï¼(integer) 1127.0.0.1:6379&gt; SMEMBERS myset1) &quot;world&quot;2) &quot;hello&quot;127.0.0.1:6379&gt; SMEMBERS myset21) &quot;peppa&quot;2) &quot;set2&quot;##########################################################################å¾®åšï¼Œå¾®ä¿¡æœ‹å‹åœˆï¼Œå…±åŒå…³æ³¨ï¼(å¹¶é›†)æ•°å­—é›†åˆç±»ï¼š- å·®é›† SDIFF- äº¤é›†- å¹¶é›†127.0.0.1:6379&gt; FLUSHALLOK127.0.0.1:6379&gt; sadd key1 a  b c (integer) 3127.0.0.1:6379&gt; sadd key2 c  d  e (integer) 3127.0.0.1:6379&gt; SDIFF key1 key2 # å·®é›†1) &quot;b&quot;2) &quot;a&quot;127.0.0.1:6379&gt; SINTER key1 key2 # äº¤é›† å…±åŒå¥½å‹å°±å¯ä»¥è¿™æ ·å®ç°1) &quot;c&quot;127.0.0.1:6379&gt; SUNION key1 key2 # å¹¶é›†1) &quot;b&quot;2) &quot;c&quot;3) &quot;e&quot;4) &quot;a&quot;5) &quot;d&quot;

å¾®åšï¼ŒAç”¨æˆ·å°†æ‰€æœ‰å…³æ³¨çš„äººæ”¾åœ¨ä¸€ä¸ªseté›†åˆä¸­ï¼å°†å®ƒçš„ç²‰ä¸ä¹Ÿæ”¾åœ¨ä¸€ä¸ªé›†åˆä¸­ï¼å…±åŒå…³æ³¨ï¼Œå…±åŒçˆ±å¥½ï¼ŒäºŒåº¦å¥½å‹ï¼Œæ¨èå¥½å‹ï¼ï¼ˆå…­åº¦åˆ†å‰²ç†è®ºï¼‰
Hashï¼ˆå“ˆå¸Œï¼‰Mapé›†åˆï¼Œkey-map! æ—¶å€™è¿™ä¸ªå€¼æ˜¯ä¸€ä¸ªmapé›†åˆï¼ æœ¬è´¨å’ŒStringç±»å‹æ²¡æœ‰å¤ªå¤§åŒºåˆ«ï¼Œè¿˜æ˜¯ä¸€ä¸ªç®€å•çš„key-vlaueï¼set myhash field peppa
#########################################################################127.0.0.1:6379&gt; FLUSHDBOK127.0.0.1:6379&gt; hset myhash field1 peppa # setä¸€ä¸ªå…·ä½“ key-vlaue(integer) 1127.0.0.1:6379&gt; hget myhash field1 # è·å–ä¸€ä¸ªå­—æ®µå€¼&quot;peppa&quot;127.0.0.1:6379&gt; hmset myhash field1 hello field2 world # setå¤šä¸ª key-vlaueOK127.0.0.1:6379&gt; hmget myhash field1 field2 # è·å–å¤šä¸ªå­—æ®µå€¼1) &quot;hello&quot;2) &quot;world&quot;127.0.0.1:6379&gt; hgetall myhash # è·å–å…¨éƒ¨çš„æ•°æ®ï¼Œ1) &quot;field1&quot;2) &quot;hello&quot;3) &quot;field2&quot;4) &quot;world&quot;127.0.0.1:6379&gt; hdel myhash field1 # åˆ é™¤hashæŒ‡å®škeyå­—æ®µï¼å¯¹åº”çš„valueå€¼ä¹Ÿå°±æ¶ˆå¤±äº†ï¼(integer) 1127.0.0.1:6379&gt; hgetall myhash1) &quot;field2&quot;2) &quot;world&quot;##########################################################################hlen127.0.0.1:6379&gt; FLUSHDBOK127.0.0.1:6379&gt; hmset myhash field1 hello field2 worldOK127.0.0.1:6379&gt; HGETALL myhash1) &quot;field2&quot;2) &quot;world&quot;3) &quot;field1&quot;4) &quot;hello&quot;127.0.0.1:6379&gt; hlen myhash # è·å–hashè¡¨çš„å­—æ®µæ•°é‡ï¼(integer) 2##########################################################################127.0.0.1:6379&gt; HEXISTS myhash field1 # åˆ¤æ–­hashä¸­æŒ‡å®šå­—æ®µæ˜¯å¦å­˜åœ¨ï¼(integer) 1127.0.0.1:6379&gt; HEXISTS myhash field3(integer) 0########################################################################### åªè·å¾—æ‰€æœ‰field# åªè·å¾—æ‰€æœ‰value127.0.0.1:6379&gt; hkeys myhash # åªè·å¾—æ‰€æœ‰field1) &quot;field2&quot;2) &quot;field1&quot;

hashå˜æ›´çš„æ•°æ® user name age,å°¤å…¶æ˜¯æ˜¯ç”¨æˆ·ä¿¡æ¯ä¹‹ç±»çš„ï¼Œç»å¸¸å˜åŠ¨çš„ä¿¡æ¯ï¼ hash æ›´é€‚åˆäºå¯¹è±¡çš„å­˜å‚¨ï¼ŒStringæ›´åŠ é€‚åˆå­—ç¬¦ä¸²å­˜å‚¨ï¼
Zsetï¼ˆæœ‰åºé›†åˆï¼‰åœ¨setçš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†ä¸€ä¸ªå€¼ï¼Œset k1 v1 zset k1 score1 v1
127.0.0.1:6379&gt; FLUSHDBOK27.0.0.1:6379&gt; zadd myset 1 one # æ·»åŠ ä¸€ä¸ªå€¼(integer) 1127.0.0.1:6379&gt; zadd myset 2 two 3 three # æ·»åŠ å¤šä¸ªå€¼(integer) 2127.0.0.1:6379&gt; ZRANGE myset 0 -11) &quot;one&quot;2) &quot;two&quot;3) &quot;three&quot;##########################################################################æ’åºå¦‚ä½•å®ç°127.0.0.1:6379&gt; FLUSHDBOK127.0.0.1:6379&gt; zadd salary 2500 zhangsan # æ·»åŠ ä¸‰ä¸ªç”¨æˆ·(integer) 1127.0.0.1:6379&gt; zadd salary 5000 lisi(integer) 1127.0.0.1:6379&gt; zadd salary 500 wangwu(integer) 1# ZRANGEBYSCORE key min max127.0.0.1:6379&gt; ZRANGEBYSCORE salary -inf +inf # æ˜¾ç¤ºå…¨éƒ¨çš„ç”¨æˆ· ä»å°åˆ°å¤§ï¼1) &quot;wangwu&quot;2) &quot;zhangsan&quot;3) &quot;lisi&quot;127.0.0.1:6379&gt; ZREVRANGE salary 0 -1 # ä»å¤§åˆ°è¿›è¡Œæ’åºï¼1) &quot;lisi&quot;2) &quot;zhangsan&quot;3) &quot;wangwu&quot;127.0.0.1:6379&gt; ZRANGEBYSCORE salary -inf +inf withscores # æ˜¾ç¤ºå…¨éƒ¨çš„ç”¨æˆ·å¹¶ä¸”é™„å¸¦æˆç»©1) &quot;wangwu&quot;2) &quot;500&quot;3) &quot;zhangsan&quot;4) &quot;2500&quot;5) &quot;lisi&quot;6) &quot;5000&quot;127.0.0.1:6379&gt; ZRANGEBYSCORE salary -inf 2500 withscores # # æ˜¾ç¤ºå·¥èµ„å°äº2500å‘˜å·¥çš„å‡åºæ’åºï¼1) &quot;wangwu&quot;2) &quot;500&quot;3) &quot;zhangsan&quot;4) &quot;2500&quot;########################################################################### ç§»é™¤remä¸­çš„å…ƒç´ 127.0.0.1:6379&gt; zrange salary 0 -11) &quot;wangwu&quot;2) &quot;zhangsan&quot;3) &quot;lisi&quot;127.0.0.1:6379&gt; zrem salary zhangsan # ç§»é™¤æœ‰åºé›†åˆä¸­çš„æŒ‡å®šå…ƒç´ (integer) 1127.0.0.1:6379&gt; zrange salary 0 -11) &quot;wangwu&quot;2) &quot;lisi&quot;127.0.0.1:6379&gt; zcard salary # è·å–æœ‰åºé›†åˆä¸­çš„ä¸ªæ•°(integer) 2##########################################################################127.0.0.1:6379&gt; FLUSHDBOK127.0.0.1:6379&gt; zadd myset 1 hello(integer) 1127.0.0.1:6379&gt; zadd myset 2 world 3 peppa(integer) 2127.0.0.1:6379&gt; zcount myset 1 3 # è·å–æŒ‡å®šåŒºé—´çš„æˆå‘˜æ•°é‡ï¼(integer) 3127.0.0.1:6379&gt; zcount myset 1 2(integer) 2

å…¶å®ƒæ›´å¤šçš„APIï¼ŒæŸ¥è¯¢å®˜æ–¹æ–‡æ¡£ï¼šCommand reference â€“ Redis
æ¡ˆä¾‹æ€è·¯ï¼šset æ’åº å­˜å‚¨ç­çº§æˆç»©è¡¨ï¼Œå·¥èµ„è¡¨æ’åºï¼æ™®é€šæ¶ˆæ¯ï¼Œ1ï¼Œ é‡è¦æ¶ˆæ¯ 2ï¼Œå¸¦æƒé‡è¿›è¡Œåˆ¤æ–­ï¼æ’è¡Œæ¦œåº”ç”¨å®ç°ï¼Œå–Top N æµ‹è¯•ï¼
]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>RedisåŸºç¡€å…¥é—¨</tag>
      </tags>
  </entry>
  <entry>
    <title>RedisåŸºç¡€å…¥é—¨(äº”)Javaè¿æ¥å¼€å‘å·¥å…·Jedis</title>
    <url>/Redis/Redis%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8(%E4%BA%94)Java%E8%BF%9E%E6%8E%A5%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7Jedis/</url>
    <content><![CDATA[RedisåŸºç¡€å…¥é—¨(äº”)Javaè¿æ¥å¼€å‘å·¥å…·Jedisä»€ä¹ˆæ˜¯Jedis æ˜¯ Redis å®˜æ–¹æ¨èçš„ javaè¿æ¥å¼€å‘å·¥å…·ï¼ ä½¿ç”¨Java æ“ä½œRedis ä¸­é—´ä»¶ï¼å¦‚æœä½ è¦ä½¿ç”¨javaæ“ä½œredisï¼Œé‚£ä¹ˆä¸€å®šè¦å¯¹Jedis ååˆ†çš„ç†Ÿæ‚‰ï¼
1. æ–°å»ºJedisé¡¹ç›®åˆ›å»ºpeppa-jedisï¼Œå¼•ç”¨ç›¸å…³jaråŒ…

&lt;dependencies&gt;        &lt;!-- jedis --&gt;        &lt;dependency&gt;            &lt;groupId&gt;redis.clients&lt;/groupId&gt;            &lt;artifactId&gt;jedis&lt;/artifactId&gt;            &lt;version&gt;4.0.1&lt;/version&gt;        &lt;/dependency&gt;        &lt;!--fastjson--&gt;        &lt;dependency&gt;            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;            &lt;artifactId&gt;fastjson&lt;/artifactId&gt;            &lt;version&gt;1.2.79&lt;/version&gt;        &lt;/dependency&gt;        &lt;!-- junit --&gt;        &lt;dependency&gt;            &lt;groupId&gt;junit&lt;/groupId&gt;            &lt;artifactId&gt;junit&lt;/artifactId&gt;            &lt;version&gt;4.13.2&lt;/version&gt;        &lt;/dependency&gt;        &lt;!--slf4j --&gt;        &lt;dependency&gt;            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;            &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;            &lt;version&gt;2.0.0-alpha5&lt;/version&gt;        &lt;/dependency&gt;        &lt;!-- logback --&gt;        &lt;dependency&gt;            &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;            &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;            &lt;version&gt;1.3.0-alpha12&lt;/version&gt;        &lt;/dependency&gt;        &lt;dependency&gt;            &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;            &lt;artifactId&gt;logback-core&lt;/artifactId&gt;            &lt;version&gt;1.3.0-alpha12&lt;/version&gt;        &lt;/dependency&gt;        &lt;dependency&gt;            &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;            &lt;artifactId&gt;logback-access&lt;/artifactId&gt;            &lt;version&gt;1.3.0-alpha12&lt;/version&gt;        &lt;/dependency&gt;    &lt;/dependencies&gt;

2. PingTestæµ‹è¯•è¿æ¥package com.peppa;import org.junit.Test;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import redis.clients.jedis.Jedis;public class PingTest &#123;    private static final Logger logger= LoggerFactory.getLogger(PingTest.class);    @Test    public void ping()&#123;        Jedis jedis = new Jedis(&quot;192.168.3.21&quot;,6379);        logger.info(&quot;jedis.ping()==&gt;&#123;&#125;&quot;,jedis.ping());    &#125;&#125;

3. StringTestå­—ç¬¦package com.peppa;import org.junit.Test;import org.omg.CORBA.PUBLIC_MEMBER;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import redis.clients.jedis.Jedis;import java.util.Arrays;import java.util.Set;import java.util.concurrent.TimeUnit;public class StringTest &#123;    private static final Logger logger = LoggerFactory.getLogger(StringTest.class);    @Test    public void key() &#123;        Jedis jedis = new Jedis(&quot;192.168.3.21&quot;, 6379);        logger.info(&quot;æŒ‰ç´¢å¼•æŸ¥è¯¢ï¼š&#123;&#125;&quot;, jedis.select(0));        logger.info(&quot;æ¸…ç©ºæ•°æ®ï¼š&#123;&#125;&quot;, jedis.flushDB());        logger.info(&quot;åˆ¤æ–­æŸä¸ªé”®æ˜¯å¦å­˜åœ¨ï¼š&#123;&#125;&quot;, jedis.exists(&quot;username&quot; ));        logger.info(&quot;æ–°å¢&lt;&#x27;username&#x27;,&#x27;peppa&#x27;&gt;çš„é”®å€¼å¯¹ï¼š&#123;&#125;&quot;, jedis.set(&quot;username&quot;, &quot;peppa&quot; ));        logger.info(&quot;æ–°å¢&lt;&#x27;password&#x27;,&#x27;password&#x27;&gt;çš„é”®å€¼å¯¹ï¼š&#123;&#125;&quot;, jedis.set(&quot;password&quot;, &quot;123456&quot; ));        Set&lt;String&gt; keys = jedis.keys(&quot;*&quot; );        logger.info(&quot;ç³»ç»Ÿä¸­æ‰€æœ‰çš„é”®å¦‚ä¸‹ï¼š&#123;&#125;&quot;, Arrays.toString(keys.toArray()));        logger.info(&quot;åˆ é™¤é”®password:&#123;&#125;&quot;, jedis.del(&quot;password&quot; ));        logger.info(&quot;åˆ¤æ–­é”®passwordæ˜¯å¦å­˜åœ¨ï¼š&#123;&#125;&quot;, jedis.exists(&quot;password&quot; ));        logger.info(&quot;æŸ¥çœ‹é”®usernameæ‰€å­˜å‚¨çš„å€¼çš„ç±»å‹:&#123;&#125;&quot;, jedis.type(&quot;username&quot; ));        logger.info(&quot;éšæœºè¿”å›keyç©ºé—´çš„ä¸€ä¸ªï¼š&#123;&#125;&quot;, jedis.randomKey());        logger.info(&quot;é‡å‘½åkeyï¼š&#123;&#125;&quot;, jedis.rename(&quot;username&quot;, &quot;name&quot; ));        logger.info(&quot;å–å‡ºæ”¹åçš„nameï¼š&#123;&#125;&quot;, jedis.get(&quot;name&quot; ));        logger.info(&quot;åˆ é™¤å½“å‰é€‰æ‹©æ•°æ®åº“ä¸­çš„æ‰€æœ‰ï¼š&#123;&#125;&quot;, jedis.flushDB());        logger.info(&quot;è¿”å›å½“å‰æ•°æ®åº“ä¸­keyçš„æ•°ç›®ï¼š&#123;&#125;&quot;, jedis.dbSize());        logger.info(&quot;åˆ é™¤æ‰€æœ‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰keyï¼š&#123;&#125;&quot;, jedis.flushAll());    &#125;    @Test    public void str() throws InterruptedException &#123;        Jedis jedis = new Jedis(&quot;192.168.3.21&quot;, 6379);        jedis.flushDB();        logger.info(&quot;==========å¢åŠ æ•°æ®=========&quot; );        logger.info(jedis.set(&quot;key1&quot;, &quot;valuel&quot; ));        logger.info(jedis.set(&quot;key2&quot;, &quot;value2&quot; ));        logger.info(jedis.set(&quot;key3&quot;, &quot;value3&quot; ));        logger.info(&quot;åˆ é™¤é”®key2:&#123;&#125;&quot;, jedis.del(&quot;key2&quot; ));        logger.info(&quot;è·å–é”®key2:&#123;&#125;&quot;, jedis.get(&quot;key2&quot; ));        logger.info(&quot;ä¿®æ”¹key:&#123;&#125;&quot;, jedis.set(&quot;key1&quot;, &quot;valueChanged&quot; ));        logger.info(&quot;è·å–key1çš„å€¼ï¼š&#123;&#125;&quot;, jedis.get(&quot;key1&quot; ));        logger.info(&quot;åœ¨key3åé¢åŠ å…¥å€¼ï¼š&#123;&#125;&quot;, jedis.append(&quot;key3&quot;, &quot;End&quot; ));        logger.info(&quot;key3çš„å€¼ï¼š&quot; + jedis.get(&quot;key3&quot; ));        logger.info(&quot;å¢åŠ å¤šä¸ªé”®å€¼å¯¹ï¼š&#123;&#125;&quot;, jedis.mset(&quot;key01&quot;, &quot;value02&quot;, &quot;key02&quot;, &quot;value02&quot;, &quot;key03&quot;, &quot;value03&quot;, &quot;key04&quot;, &quot;value04&quot; ));        logger.info(&quot;è·å–å¤šä¸ªé”®å€¼å¯¹ï¼š&#123;&#125;&quot;, jedis.mget(&quot;key01&quot;, &quot;key02&quot;, &quot;key03&quot; ));        logger.info(&quot;è·å–å¤šä¸ªé”®å€¼å¯¹ï¼š&#123;&#125;&quot;, jedis.mget(&quot;key01&quot;, &quot;key02&quot;, &quot;key03&quot;, &quot;key04&quot; ));        logger.info(&quot;åˆ é™¤å¤šä¸ªé”®å€¼å¯¹ï¼š&#123;&#125;&quot;, jedis.del(&quot;key01&quot;, &quot;key02&quot; ));        logger.info(&quot;è·å–å¤šä¸ªé”®å€¼å¯¹ï¼š&#123;&#125;&quot;, jedis.mget(&quot;key01&quot;, &quot;key02&quot;, &quot;key03&quot; ));        jedis.flushDB();        logger.info(&quot;===========æ–°å¢é”®å€¼å¯¹é˜²æ­¢è¦†ç›–ç­›å…ˆå€¼=============&quot; );        logger.info(&quot;jedis.setnx():&#123;&#125;&quot;, jedis.setnx(&quot;key1&quot;, &quot;value1&quot; ));        logger.info(&quot;jedis.setnx():&#123;&#125;&quot;, jedis.setnx(&quot;key2&quot;, &quot;value2&quot; ));        logger.info(&quot;jedis.setnx():&#123;&#125;&quot;, jedis.setnx(&quot;key2&quot;, &quot;value2-new&quot; ));        logger.info(&quot;jedis.get():&#123;&#125;&quot;, jedis.get(&quot;key1&quot; ));        logger.info(&quot;jedis.get():&#123;&#125;&quot;, jedis.get(&quot;key2&quot; ));        logger.info(&quot;=======æ–°å¢é”®å€¼å¯¹å¹¶è®¾ç½®æœ‰æ•ˆæ—¶é—´=====&quot; );        logger.info(&quot;jedis.setex():&#123;&#125;&quot;, jedis.setex(&quot;key3&quot;, 2, &quot;value3&quot; ));        logger.info(&quot;jedis.get(key3):&#123;&#125;&quot;, jedis.get(&quot;key3&quot; ));        TimeUnit.SECONDS.sleep(3);        logger.info(&quot;jedis.get(key3):&#123;&#125;&quot;, jedis.get(&quot;key3&quot; ));        logger.info(&quot;===========è·å–åŸå€¼ï¼Œæ›´æ–°ä¸ºæ–°å€¼===========&quot; );        logger.info(jedis.getSet(&quot;key2&quot;, &quot;key2GetSet&quot; ));        logger.info(jedis.get(&quot;key2&quot; ));        logger.info(&quot;è·å¾—key2çš„å€¼çš„å­—ä¸²ï¼š&#123;&#125;&quot;, jedis.getrange(&quot;key2&quot;, 2, 4));    &#125;&#125;

4. ListTeståˆ—è¡¨package com.peppa;import org.junit.Test;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import redis.clients.jedis.Jedis;public class ListTest &#123;    private static final Logger logger = LoggerFactory.getLogger(ListTest.class);    @Test    public void list() &#123;        Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);        jedis.flushDB();        logger.info(&quot;=======æ·»åŠ ä¸€ä¸ª1ist===========&quot; );        jedis.lpush(&quot;collections&quot;, &quot;ArrayList&quot;, &quot;Vector&quot;, &quot;Stack&quot;, &quot;HashMap&quot;, &quot;WeakHashMap&quot;, &quot;LinkedHashMap&quot; );        jedis.lpush(&quot;collections&quot;, &quot;HashSet&quot; );        jedis.lpush(&quot;collections&quot;, &quot;TreeSet&quot; );        jedis.lpush(&quot;collections&quot;, &quot;TreeMap&quot; );        logger.info(&quot;collectionsçš„å†…å®¹ï¼š&#123;&#125;&quot; ,jedis.lrange(&quot;collections&quot;, 0, -1)); //-1ä»£è¡¨å€’æ•°ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œ-2ä»£è¡¨å€’æ•°ç¬¬äºŒä¸ªå…ƒç´         logger.info(&quot;collectionsåŒºé—´0-3çš„å…ƒç´ ï¼š&#123;&#125;&quot; ,jedis.lrange(&quot;collections&quot;, 0, 3));        logger.info(&quot;=================================&quot; );        // åˆ é™¤åˆ—è¡¨æŒ‡å®šçš„å€¼ï¼Œç¬¬äºŒä¸ªå‚æ•°çš„ä¸ªæ•°ï¼ˆæœ‰é‡å¤æ—¶ï¼‰ï¼Œåaddè¿›å»çš„å€¼å…ˆè¢«åˆ ï¼Œç±»ä¼¼äºå‡ºæ ˆ        logger.info(&quot;åˆ é™¤æŒ‡å®šå…ƒç´ ä¸ªæ•°ï¼š&#123;&#125;&quot; ,jedis.lrem(&quot;collections&quot;, 2, &quot;HashMap&quot; ));        logger.info(&quot;collectionsçš„å†…å®¹ï¼š&#123;&#125;&quot; ,jedis.lrange(&quot;collections&quot;, 0, -1));        logger.info(&quot;åˆ é™¤ä¸‹è¡¨0-3åŒºé—´ä¹‹å¤–çš„å…ƒç´ ï¼š&#123;&#125;&quot; ,jedis.ltrim(&quot;collections&quot;, 0, 3));        logger.info(&quot;collectionsçš„å†…å®¹ï¼š&#123;&#125;&quot; ,jedis.lrange(&quot;collections&quot;, 0, -1));        logger.info(&quot;collectionsåˆ—è¡¨å‡ºæ ˆï¼ˆå·¦ç«¯ï¼‰ï¼š&#123;&#125;&quot; ,jedis.lpop(&quot;collections&quot; ));        logger.info(&quot;collectionsçš„å†…å®¹ï¼š&#123;&#125;&quot; ,jedis.lrange(&quot;collections&quot;, 0, -1));        logger.info(&quot;collectionsæ·»åŠ å…ƒç´ ï¼Œä»åˆ—è¡¨å³ç«¯ï¼Œä¸1pushç›¸å¯¹åº”ï¼š&#123;&#125;&quot; ,jedis.rpush(&quot;collections&quot;, &quot;EnumMap&quot; ));        logger.info(&quot;collectionsçš„å†…å®¹ï¼š&#123;&#125;&quot; ,jedis.lrange(&quot;collections&quot;, 0, -1));        logger.info(&quot;collections3åˆ—è¡¨å‡ºæ ˆï¼ˆå³ç«¯ï¼‰ï¼š&#123;&#125;&quot; ,jedis.rpop(&quot;collections&quot; ));        logger.info(&quot;collectionsçš„å†…å®¹ï¼š&#123;&#125;&quot; ,jedis.lrange(&quot;collections&quot;, 0, -1));        logger.info(&quot;ä¿®æ”¹collectionsæŒ‡å®šä¸‹æ ‡1çš„å†…å®¹ï¼š&#123;&#125;&quot; ,jedis.lset(&quot;collections&quot;, 1, &quot;LinkedArrayList&quot; ));        logger.info(&quot;collectionsçš„å†…å®¹ï¼š&#123;&#125;&quot; ,jedis.lrange(&quot;collections&quot;, 0, -1));        logger.info(&quot;=================================&quot; );        logger.info(&quot;collectionsçš„é•¿åº¦ï¼š&#123;&#125;&quot; ,jedis.llen(&quot;collections&quot; ));        logger.info(&quot;è·å–collectionsä¸‹æ ‡ä¸º2çš„å…ƒç´ ï¼š&#123;&#125;&quot; ,jedis.lindex(&quot;collections&quot;, 2));        logger.info(&quot;=================================&quot; );        jedis.lpush(&quot;sortedList&quot;, &quot;3&quot;, &quot;6&quot;, &quot;2&quot;, &quot;0&quot;, &quot;7&quot;, &quot;4&quot; );        logger.info(&quot;sortedListæ’åºå‰ï¼š&#123;&#125;&quot; ,jedis.lrange(&quot;sortedList&quot;, 0, -1));        logger.info(&quot;jedis.sort():&#123;&#125;&quot;,jedis.sort(&quot;sortedList&quot; ));        logger.info(&quot;sortedListæ’åºåï¼š&#123;&#125;&quot; ,jedis.lrange(&quot;sortedList&quot;, 0, -1));    &#125;&#125;

5. SetTesté›†åˆpackage com.peppa;import org.junit.Test;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import redis.clients.jedis.Jedis;public class SetTest &#123;    private static final Logger logger = LoggerFactory.getLogger(SetTest.class);    @Test    public void set() &#123;        Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);        jedis.flushDB();        logger.info(&quot;================å‘é›†åˆä¸­æ·»åŠ å…ƒç´ ï¼ˆä¸é‡å¤ï¼‰============&quot; );        logger.info(&quot;jedis.sadd():&#123;&#125;&quot;,jedis.sadd(&quot;eleSet&quot;, &quot;e1&quot;, &quot;e2&quot;, &quot;e4&quot;, &quot;e3&quot;, &quot;e0&quot;, &quot;e8&quot;, &quot;e7&quot;, &quot;e5&quot; ));        logger.info(&quot;jedis.sadd():&#123;&#125;&quot;,jedis.sadd(&quot;eleSet&quot;, &quot;e6&quot; ));        logger.info(&quot;jedis.sadd():&#123;&#125;&quot;,jedis.sadd(&quot;eleSet&quot;, &quot;e6&quot; ));        logger.info(&quot;eleSetçš„æ‰€æœ‰å…ƒç´ ä¸ºï¼š&#123;&#125;&quot; ,jedis.smembers(&quot;eleSet&quot; ));        logger.info(&quot;åˆ é™¤ä¸€ä¸ªå…ƒç´ e0ï¼š&#123;&#125;&quot; ,jedis.srem(&quot;eleSet&quot;, &quot;e0&quot; ));        logger.info(&quot;eleSetçš„æ‰€æœ‰å…ƒç´ ä¸ºï¼š&#123;&#125;&quot; ,jedis.smembers(&quot;eleSet&quot; ));        logger.info(&quot;åˆ é™¤ä¸¤ä¸ªå…ƒç´ e7å’Œe6ï¼š&#123;&#125;&quot; ,jedis.srem(&quot;eleSet&quot;, &quot;e7&quot;, &quot;e6&quot; ));        logger.info(&quot;eleSetçš„æ‰€æœ‰å…ƒç´ ä¸ºï¼š&#123;&#125;&quot; ,jedis.smembers(&quot;eleSet&quot; ));        logger.info(&quot;éšæœºçš„ç§»é™¤é›†åˆä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼š&#123;&#125;&quot; ,jedis.spop(&quot;eleSet&quot; ));        logger.info(&quot;éšæœºçš„ç§»é™¤é›†åˆä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼š&#123;&#125;&quot; ,jedis.spop(&quot;eleSet&quot; ));        logger.info(&quot;eleSetçš„æ‰€æœ‰å…ƒç´ ä¸ºï¼š&#123;&#125;&quot; ,jedis.smembers(&quot;eleSet&quot; ));        logger.info(&quot;eleSetä¸­åŒ…å«å…ƒç´ çš„ä¸ªæ•°ï¼š&#123;&#125;&quot; ,jedis.scard(&quot;eleSet&quot; ));        logger.info(&quot;e3æ˜¯å¦åœ¨eleSetä¸­ï¼š&#123;&#125;&quot; ,jedis.sismember(&quot;eleSet&quot;, &quot;e3&quot; ));        logger.info(&quot;e1æ˜¯å¦åœ¨eleSetä¸­ï¼š&#123;&#125;&quot; ,jedis.sismember(&quot;eleSet&quot;, &quot;e1&quot; ));        logger.info(&quot;e1æ˜¯å¦åœ¨eleSetä¸­ï¼š&#123;&#125;&quot; ,jedis.sismember(&quot;eleSet&quot;, &quot;e5&quot; ));        logger.info(&quot;=============================&quot; );        logger.info(&quot;jedis.sadd():&#123;&#125;&quot;,jedis.sadd(&quot;eleSet1&quot;, &quot;e1&quot;, &quot;e2&quot;, &quot;e4&quot;, &quot;e3&quot;, &quot;e0&quot;, &quot;e8&quot;, &quot;e7&quot;, &quot;e5&quot; ));        logger.info(&quot;jedis.sadd():&#123;&#125;&quot;,jedis.sadd(&quot;eleSet2&quot;, &quot;e1&quot;, &quot;e2&quot;, &quot;e4&quot;, &quot;e3&quot;, &quot;e0&quot;, &quot;e8&quot; ));        logger.info(&quot;å°†eleSet1ä¸­åˆ é™¤e1å¹¶å­˜å…¥eleSet3ä¸­ï¼š&#123;&#125;&quot; ,jedis.smove(&quot;eleSet1&quot;, &quot;eleSet3&quot;, &quot;el&quot; ));//ç§»åˆ°é›†åˆå…ƒç´          logger.info(&quot;å°†eleSet1ä¸­åˆ é™¤e2å¹¶å­˜å…¥eleSet3ä¸­ï¼š&#123;&#125;&quot; ,jedis.smove(&quot;eleSet1&quot;, &quot;eleSet3&quot;, &quot;e2&quot; ));        logger.info(&quot;eleSet1ä¸­çš„å…ƒç´ ï¼š&#123;&#125;&quot; ,jedis.smembers(&quot;eleSet1&quot; ));        logger.info(&quot;eleSet3ä¸­çš„å…ƒç´ ï¼š&#123;&#125;&quot; ,jedis.smembers(&quot;eleSet3&quot; ));        logger.info(&quot;=================é›†åˆè¿ç®—================&quot; );        logger.info(&quot;eleSet1ä¸­çš„å…ƒç´ ï¼š&#123;&#125;&quot; ,jedis.smembers(&quot;eleSet1&quot; ));        logger.info(&quot;eleSet2ä¸­çš„å…ƒç´ ï¼š&#123;&#125;&quot; ,jedis.smembers(&quot;eleSet2&quot; ));        logger.info(&quot;eleSet1å’ŒeleSet2çš„äº¤é›†ï¼š&#123;&#125;&quot; ,jedis.sinter(&quot;eleSet1&quot;, &quot;eleSet2&quot; ));        logger.info(&quot;eleSet1å’ŒeleSet2çš„å¹¶é›†ï¼š&#123;&#125;&quot; ,jedis.sunion(&quot;eleSet1&quot;, &quot;eleSet2&quot; ));        logger.info(&quot;eleSet1å’ŒeleSet2çš„å·®é›†:&quot; + jedis.sdiff(&quot;eleSet1&quot;, &quot;eleSet2&quot; ));//eLeSet1ä¸­æœ‰ï¼ŒeLeSet2ä¸­æ²¡æœ‰        jedis.sinterstore( &quot;eleSet4&quot;, &quot;eleSet1&quot;,&quot;eleSet2&quot;);//æ±‚äº¤é›†å¹¶å°†äº¤é›†ä¿        logger.info(&quot;eleSet4ä¸­çš„å…ƒç´ ï¼š&#123;&#125;&quot;,jedis.smembers(&quot;eleSet4&quot;));    &#125;&#125;

6. TestHashpackage com.peppa;import org.junit.Test;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import redis.clients.jedis.Jedis;import java.util.HashMap;import java.util.Map;public class TestHash &#123;    private static final Logger logger = LoggerFactory.getLogger(ListTest.class);    @Test    public void hash() &#123;        Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);        jedis.flushDB();        Map&lt;String, String&gt; map = new HashMap&lt;&gt;();        map.put(&quot;key1&quot;, &quot;value1&quot; );        map.put(&quot;key2&quot;, &quot;value2&quot; );        map.put(&quot;key3&quot;, &quot;value3&quot; );        map.put(&quot;key4&quot;, &quot;value4&quot; );        //æ·»åŠ åç§°ä¸ºhashï¼ˆkeyï¼‰çš„hashå…ƒç´         jedis.hmset(&quot;hash&quot;, map);        //åç§°ä¸ºhashçš„hashä¸­æ·»åŠ Rey ä¸ºkey5ï¼ŒvaLueä¸ºvatue5å…ƒç´         jedis.hset(&quot;hash&quot;, &quot;key5&quot;, &quot;value5&quot; );        logger.info(&quot;æ•£åˆ—hashçš„æ‰€æœ‰é”®å€¼å¯¹ä¸ºï¼š&#123;&#125;&quot; ,jedis.hgetAll(&quot;hash&quot; )); //return Map&lt;s        logger.info(&quot;æ•£åˆ—hashçš„æ‰€æœ‰é”®ä¸ºï¼š&#123;&#125;&quot; ,jedis.hkeys(&quot;hash&quot; )); //return Set&lt;String&gt;        logger.info(&quot;æ•£åˆ—hashçš„æ‰€æœ‰å€¼ä¸ºï¼š&#123;&#125;&quot; ,jedis.hvals(&quot;hash&quot; )); //return List&lt;String        logger.info(&quot;å°†key6ä¿å­˜çš„å€¼åŠ ä¸Šä¸€ä¸ªæ•´æ•°ï¼Œå¦‚æœkey6ä¸å­˜åœ¨åˆ™æ·»åŠ key6ï¼š&#123;&#125;&quot; ,jedis.hincrBy(&quot;hash&quot;, &quot;key6&quot;, 5));        logger.info(&quot;æ•£åˆ—hashçš„æ‰€æœ‰é”®å€¼å¯¹ä¸ºï¼š&#123;&#125;&quot; ,jedis.hgetAll(&quot;hash&quot; ));        logger.info(&quot;å°†key6ä¿å­˜çš„å€¼åŠ ä¸Šä¸€ä¸ªæ•´æ•°ï¼Œå¦‚æœkey6ä¸å­˜åœ¨åˆ™æ·»åŠ key6ï¼š&#123;&#125;&quot; ,jedis.hincrBy(&quot;hash&quot;, &quot;key6&quot;, 10));        logger.info(&quot;æ•£åˆ—hashçš„æ‰€æœ‰é”®å€¼å¯¹ä¸ºï¼š&#123;&#125;&quot; ,jedis.hgetAll(&quot;hash&quot; ));        logger.info(&quot;åˆ é™¤ä¸€ä¸ªæˆ–è€…å¤šä¸ªé”®å€¼å¯¹ï¼š&#123;&#125;&quot; ,jedis.hdel(&quot;hash&quot;, &quot;key2&quot; ));        logger.info(&quot;æ•£åˆ—hashçš„æ‰€æœ‰é”®å€¼å¯¹ä¸ºï¼š&#123;&#125;&quot; ,jedis.hgetAll(&quot;hash&quot; ));        logger.info(&quot;æ•£åˆ—hashä¸­é”®å€¼å¯¹çš„ä¸ªæ•°ï¼š &quot; + jedis.hlen(&quot;hash&quot; ));        logger.info(&quot;åˆ¤æ–­hashä¸­æ˜¯å¦å­˜åœ¨key2ï¼š&#123;&#125;&quot; ,jedis.hexists(&quot;hash&quot;, &quot;key2&quot; ));        logger.info(&quot;åˆ¤æ–­hashä¸­æ˜¯å¦å­˜åœ¨key3ï¼š&#123;&#125;&quot; ,jedis.hexists(&quot;hash&quot;, &quot;key3&quot; ));        logger.info(&quot;è·å–hashä¸­çš„å€¼ï¼š&#123;&#125;&quot; ,jedis.hmget(&quot;hash&quot;, &quot;key3&quot; ));        logger.info(&quot;è·å–hashä¸­çš„å€¼ï¼š&#123;&#125;&quot; ,jedis.hmget(&quot;hash&quot;, &quot;key3&quot;, &quot;key4&quot; ));    &#125;&#125;

7. TransactionTestï¼ˆäº‹åŠ¡ï¼‰package com.peppa;import com.alibaba.fastjson.JSONObject;import org.junit.Test;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import redis.clients.jedis.Jedis;import redis.clients.jedis.Transaction;public class TransactionTest &#123;    private static final Logger logger = LoggerFactory.getLogger(ListTest.class);    @Test    public void transaction()&#123;        Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);        jedis.flushDB();        JSONObject jsonObject = new JSONObject();        jsonObject.put(&quot;hello&quot;,&quot;world&quot;);        // å¼€å¯äº‹åŠ¡        Transaction multi = jedis.multi();        String jsonStr = jsonObject.toJSONString();        multi.set(&quot;user1&quot;,jsonStr);        try&#123;            // ä»£ç æŠ›å‡ºå¼‚å¸¸ï¼Œæ‰§è¡Œå¤±è´¥            int i = 1/0;            // æ‰§è¡Œäº‹åŠ¡            multi.exec();        &#125;catch(Exception ex)&#123;            logger.error(ex.getMessage(),ex);            multi.discard(); // æ”¾å¼ƒäº‹åŠ¡        &#125;finally &#123;            // å…³é—­è¿æ¥            jedis.close();            logger.info(&quot;jsonStr:&#123;&#125;&quot;,jedis.get(&quot;user1&quot;));        &#125;    &#125;&#125;]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>RedisåŸºç¡€å…¥é—¨</tag>
      </tags>
  </entry>
  <entry>
    <title>RedisåŸºç¡€å…¥é—¨(å…«)RedisæŒä¹…åŒ–</title>
    <url>/Redis/Redis%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8(%E5%85%AB)Redis%E6%8C%81%E4%B9%85%E5%8C%96/</url>
    <content><![CDATA[RedisåŸºç¡€å…¥é—¨(å…«)RedisæŒä¹…åŒ–Redis æ˜¯å†…å­˜æ•°æ®åº“ï¼Œå¦‚æœä¸å°†å†…å­˜ä¸­çš„æ•°æ®åº“çŠ¶æ€ä¿å­˜åˆ°ç£ç›˜ï¼Œé‚£ä¹ˆä¸€æ—¦æœåŠ¡å™¨è¿›ç¨‹é€€å‡ºï¼ŒæœåŠ¡å™¨ä¸­çš„æ•°æ®åº“çŠ¶æ€ä¹Ÿä¼šæ¶ˆå¤±ã€‚æ‰€ä»¥ Redis æä¾›äº†æŒä¹…åŒ–åŠŸèƒ½ï¼
1. RDBï¼ˆRedis DataBaseï¼‰
ä»€ä¹ˆæ˜¯RDB

åœ¨ä¸»ä»å¤åˆ¶ä¸­ï¼Œrdbå°±æ˜¯å¤‡ç”¨äº†ï¼ä»æœºä¸Šé¢ï¼

  
  åœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”å†…å°†å†…å­˜ä¸­çš„æ•°æ®é›†å¿«ç…§å†™å…¥ç£ç›˜ï¼Œä¹Ÿå°±æ˜¯è¡Œè¯è®²çš„Snapshotå¿«ç…§ï¼Œå®ƒæ¢å¤æ—¶æ˜¯å°†å¿«ç…§æ–‡ä»¶ç›´æ¥è¯»åˆ°å†…å­˜é‡Œã€‚  Redisä¼šå•ç‹¬åˆ›å»ºï¼ˆforkï¼‰ä¸€ä¸ªå­è¿›ç¨‹æ¥è¿›è¡ŒæŒä¹…åŒ–ï¼Œä¼šå…ˆå°†æ•°æ®å†™å…¥åˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œå¾…æŒä¹…åŒ–è¿‡ç¨‹éƒ½ç»“æŸäº†ï¼Œå†ç”¨è¿™ä¸ªä¸´æ—¶æ–‡ä»¶æ›¿æ¢ä¸Šæ¬¡æŒä¹…åŒ–å¥½çš„æ–‡ä»¶ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸»è¿›ç¨‹æ˜¯ä¸è¿›è¡Œä»»ä½•IOæ“ä½œçš„ã€‚  è¿™å°±ç¡®ä¿äº†æé«˜çš„æ€§èƒ½ã€‚å¦‚æœéœ€è¦è¿›è¡Œå¤§è§„æ¨¡æ•°æ®çš„æ¢å¤ï¼Œä¸”å¯¹äºæ•°æ®æ¢å¤çš„å®Œæ•´æ€§ä¸æ˜¯éå¸¸æ•æ„Ÿï¼Œé‚£RDBæ–¹å¼è¦æ¯”AOFæ–¹å¼æ›´åŠ çš„é«˜æ•ˆã€‚RDBçš„ç¼ºç‚¹æ˜¯æœ€åä¸€æ¬¡æŒä¹…åŒ–åçš„æ•°æ®å¯èƒ½ä¸¢å¤±ã€‚æˆ‘ä»¬é»˜è®¤çš„å°±æ˜¯  RDBï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸éœ€è¦ä¿®æ”¹è¿™ä¸ªé…ç½®ï¼  æœ‰æ—¶å€™åœ¨ç”Ÿäº§ç¯å¢ƒæˆ‘ä»¬ä¼šå°†è¿™ä¸ªæ–‡ä»¶è¿›è¡Œå¤‡ä»½ï¼  rdbä¿å­˜çš„æ–‡ä»¶æ˜¯dump.rdb éƒ½æ˜¯åœ¨æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶ä¸­å¿«ç…§ä¸­è¿›è¡Œé…ç½®çš„ï¼
  
  
  

è§¦å‘æœºåˆ¶

saveçš„è§„åˆ™æ»¡è¶³çš„æƒ…å†µä¸‹ï¼Œä¼šè‡ªåŠ¨è§¦å‘rdbè§„åˆ™
æ‰§è¡Œ flushall å‘½ä»¤ï¼Œä¹Ÿä¼šè§¦å‘æˆ‘ä»¬çš„rdbè§„åˆ™ï¼
é€€å‡ºredisï¼Œä¹Ÿä¼šäº§ç”Ÿ rdb æ–‡ä»¶ï¼å¤‡ä»½å°±è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª dump.rdb

  

å¦‚æœæ¢å¤rdbæ–‡ä»¶

åªéœ€è¦å°†rdbæ–‡ä»¶æ”¾åœ¨æˆ‘ä»¬rediså¯åŠ¨ç›®å½•å°±å¯ä»¥ï¼Œrediså¯åŠ¨çš„æ—¶å€™ä¼šè‡ªåŠ¨æ£€æŸ¥dump.rdb æ¢å¤å…¶ä¸­çš„æ•°æ®ï¼
æŸ¥çœ‹éœ€è¦å­˜åœ¨çš„ä½ç½®

  127.0.0.1:6379&gt; config get dir1) &quot;dir&quot;2) &quot;/usr/local/bin&quot; # å¦‚æœåœ¨è¿™ä¸ªç›®å½•ä¸‹å­˜åœ¨ dump.rdb æ–‡ä»¶ï¼Œå¯åŠ¨å°±ä¼šè‡ªåŠ¨æ¢å¤å…¶ä¸­çš„æ•°æ®

ä¼˜ç‚¹ç¼ºç‚¹ï¼š

ä¼˜ç‚¹ï¼š
é€‚åˆå¤§è§„æ¨¡çš„æ•°æ®æ¢å¤ï¼
å¯¹æ•°æ®çš„å®Œæ•´æ€§è¦ä¸é«˜ï¼


ç¼ºç‚¹ï¼š
éœ€è¦ä¸€å®šçš„æ—¶é—´é—´éš”è¿›ç¨‹æ“ä½œï¼å¦‚æœredisæ„å¤–å®•æœºäº†ï¼Œè¿™ä¸ªæœ€åä¸€æ¬¡ä¿®æ”¹æ•°æ®å°±æ²¡æœ‰çš„äº†ï¼
forkè¿›ç¨‹çš„æ—¶å€™ï¼Œä¼šå ç”¨ä¸€å®šçš„å†…å®¹ç©ºé—´ï¼ï¼





2. AOFï¼ˆAppend Only Fileï¼‰å°†æˆ‘ä»¬çš„æ‰€æœ‰å‘½ä»¤éƒ½è®°å½•ä¸‹æ¥ï¼Œhistoryï¼Œæ¢å¤çš„æ—¶å€™å°±æŠŠè¿™ä¸ªæ–‡ä»¶å…¨éƒ¨åœ¨æ‰§è¡Œä¸€éï¼

ä»€ä¹ˆæ˜¯AOF
  


ä»¥æ—¥å¿—çš„å½¢å¼æ¥è®°å½•æ¯ä¸ªå†™æ“ä½œï¼Œå°†Redisæ‰§è¡Œè¿‡çš„æ‰€æœ‰æŒ‡ä»¤è®°å½•ä¸‹æ¥ï¼ˆè¯»æ“ä½œä¸è®°å½•ï¼‰ï¼Œåªè®¸è¿½åŠ æ–‡ä»¶ä½†ä¸å¯ä»¥æ”¹å†™æ–‡ä»¶ï¼Œrediså¯åŠ¨ä¹‹åˆä¼šè¯»å–è¯¥æ–‡ä»¶é‡æ–°æ„å»ºæ•°æ®ï¼Œæ¢è¨€ä¹‹ï¼Œredisé‡å¯çš„è¯å°±æ ¹æ®æ—¥å¿—æ–‡ä»¶çš„å†…å®¹å°†å†™æŒ‡ä»¤ä»å‰åˆ°åæ‰§è¡Œä¸€æ¬¡ä»¥å®Œæˆæ•°æ®çš„æ¢å¤å·¥ä½œã€‚
Aofä¿å­˜çš„æ˜¯ appendonly.aof æ–‡ä»¶

append
  
  é»˜è®¤æ˜¯ä¸å¼€å¯çš„ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨è¿›è¡Œé…ç½®ï¼æˆ‘ä»¬åªéœ€è¦å°† appendonly æ”¹ä¸ºyeså°±å¼€å¯äº† aofï¼é‡å¯ï¼Œredis å°±å¯ä»¥ç”Ÿæ•ˆäº†ï¼  å¦‚æœè¿™ä¸ª aof æ–‡ä»¶æœ‰é”™ä½ï¼Œè¿™æ—¶å€™ redis æ˜¯å¯åŠ¨ä¸èµ·æ¥çš„å—ï¼Œæˆ‘ä»¬éœ€è¦ä¿®å¤è¿™ä¸ªaofæ–‡ä»¶  redis ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå·¥å…·ï¼šredis-check-aof --fix
  

é‡å†™è§„åˆ™è¯´æ˜

aof é»˜è®¤å°±æ˜¯æ–‡ä»¶çš„æ— é™è¿½åŠ ï¼Œæ–‡ä»¶ä¼šè¶Šæ¥è¶Šå¤§ï¼ï¼Œå¦‚æœ aof æ–‡ä»¶å¤§äº 64mï¼Œå¤ªå¤§äº†ï¼ forkä¸€ä¸ªæ–°çš„è¿›ç¨‹æ¥å°†æˆ‘ä»¬çš„æ–‡ä»¶è¿›è¡Œé‡å†™ï¼
  appendonly no # é»˜è®¤æ˜¯ä¸å¼€å¯aofæ¨¡å¼çš„ï¼Œé»˜è®¤æ˜¯ä½¿ç”¨rdbæ–¹å¼æŒä¹…åŒ–çš„ï¼Œåœ¨å¤§éƒ¨åˆ†æ‰€æœ‰çš„æƒ…å†µä¸‹ï¼Œrdbå®Œå…¨å¤Ÿç”¨ï¼appendfilename &quot;appendonly.aof&quot; # æŒä¹…åŒ–çš„æ–‡ä»¶çš„åå­—# appendfsync always # æ¯æ¬¡ä¿®æ”¹éƒ½ä¼š syncã€‚æ¶ˆè€—æ€§èƒ½appendfsync everysec # æ¯ç§’æ‰§è¡Œä¸€æ¬¡ syncï¼Œå¯èƒ½ä¼šä¸¢å¤±è¿™1sçš„æ•°æ®ï¼# appendfsync no # ä¸æ‰§è¡Œ syncï¼Œè¿™ä¸ªæ—¶å€™æ“ä½œç³»ç»Ÿè‡ªå·±åŒæ­¥æ•°æ®ï¼Œé€Ÿåº¦æœ€å¿«ï¼# rewrite é‡å†™ï¼Œ


ä¼˜ç‚¹å’Œç¼ºç‚¹

ä¼˜ç‚¹ï¼š
æ¯ä¸€æ¬¡ä¿®æ”¹éƒ½åŒæ­¥ï¼Œæ–‡ä»¶çš„å®Œæ•´ä¼šæ›´åŠ å¥½ï¼
æ¯ç§’åŒæ­¥ä¸€æ¬¡ï¼Œå¯èƒ½ä¼šä¸¢å¤±ä¸€ç§’çš„æ•°æ®
ä»ä¸åŒæ­¥ï¼Œæ•ˆç‡æœ€é«˜çš„ï¼


ç¼ºç‚¹ï¼š
ç›¸å¯¹äºæ•°æ®æ–‡ä»¶æ¥è¯´ï¼Œaofè¿œè¿œå¤§äº rdbï¼Œä¿®å¤çš„é€Ÿåº¦ä¹Ÿæ¯” rdbæ…¢ï¼
Aof è¿è¡Œæ•ˆç‡ä¹Ÿè¦æ¯” rdb æ…¢ï¼Œæ‰€ä»¥æˆ‘ä»¬redisé»˜è®¤çš„é…ç½®å°±æ˜¯rdbæŒä¹…åŒ–ï¼





æ‰©å±•
RDB æŒä¹…åŒ–æ–¹å¼èƒ½å¤Ÿåœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”å†…å¯¹ä½ çš„æ•°æ®è¿›è¡Œå¿«ç…§å­˜å‚¨
AOF æŒä¹…åŒ–æ–¹å¼è®°å½•æ¯æ¬¡å¯¹æœåŠ¡å™¨å†™çš„æ“ä½œï¼Œå½“æœåŠ¡å™¨é‡å¯çš„æ—¶å€™ä¼šé‡æ–°æ‰§è¡Œè¿™äº›å‘½ä»¤æ¥æ¢å¤åŸå§‹çš„æ•°æ®ï¼ŒAOFå‘½ä»¤ä»¥Redis åè®®è¿½åŠ ä¿å­˜æ¯æ¬¡å†™çš„æ“ä½œåˆ°æ–‡ä»¶æœ«å°¾ï¼ŒRedisè¿˜èƒ½å¯¹AOFæ–‡ä»¶è¿›è¡Œåå°é‡å†™ï¼Œä½¿å¾—AOFæ–‡ä»¶çš„ä½“ç§¯ä¸è‡³äºè¿‡å¤§ã€‚
åªåšç¼“å­˜ï¼Œå¦‚æœä½ åªå¸Œæœ›ä½ çš„æ•°æ®åœ¨æœåŠ¡å™¨è¿è¡Œçš„æ—¶å€™å­˜åœ¨ï¼Œä½ ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨ä»»ä½•æŒä¹…åŒ–
åŒæ—¶å¼€å¯ä¸¤ç§æŒä¹…åŒ–æ–¹å¼ï¼š
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“redisé‡å¯çš„æ—¶å€™ä¼šä¼˜å…ˆè½½å…¥AOFæ–‡ä»¶æ¥æ¢å¤åŸå§‹çš„æ•°æ®ï¼Œå› ä¸ºåœ¨é€šå¸¸æƒ…å†µä¸‹AOFæ–‡ä»¶ä¿å­˜çš„æ•°æ®é›†è¦æ¯”RDBæ–‡ä»¶ä¿å­˜çš„æ•°æ®é›†è¦å®Œæ•´ã€‚
RDB çš„æ•°æ®ä¸å®æ—¶ï¼ŒåŒæ—¶ä½¿ç”¨ä¸¤è€…æ—¶æœåŠ¡å™¨é‡å¯ä¹Ÿåªä¼šæ‰¾AOFæ–‡ä»¶ï¼Œé‚£è¦ä¸è¦åªä½¿ç”¨AOFå‘¢ï¼Ÿä½œè€…å»ºè®®ä¸è¦ï¼Œå› ä¸ºRDBæ›´é€‚åˆç”¨äºå¤‡ä»½æ•°æ®åº“ï¼ˆAOFåœ¨ä¸æ–­å˜åŒ–ä¸å¥½å¤‡ä»½ï¼‰ï¼Œå¿«é€Ÿé‡å¯ï¼Œè€Œä¸”ä¸ä¼šæœ‰  AOFå¯èƒ½æ½œåœ¨çš„Bugï¼Œç•™ç€ä½œä¸ºä¸€ä¸ªä¸‡ä¸€çš„æ‰‹æ®µã€‚


æ€§èƒ½å»ºè®®
å› ä¸ºRDBæ–‡ä»¶åªç”¨ä½œåå¤‡ç”¨é€”ï¼Œå»ºè®®åªåœ¨Slaveä¸ŠæŒä¹…åŒ–RDBæ–‡ä»¶ï¼Œè€Œä¸”åªè¦15åˆ†é’Ÿå¤‡ä»½ä¸€æ¬¡å°±å¤Ÿäº†ï¼Œåªä¿ç•™ save 900 1 è¿™æ¡è§„åˆ™ã€‚
å¦‚æœEnable AOF ï¼Œå¥½å¤„æ˜¯åœ¨æœ€æ¶åŠ£æƒ…å†µä¸‹ä¹Ÿåªä¼šä¸¢å¤±ä¸è¶…è¿‡ä¸¤ç§’æ•°æ®ï¼Œå¯åŠ¨è„šæœ¬è¾ƒç®€å•åªloadè‡ªå·±çš„AOFæ–‡ä»¶å°±å¯ä»¥äº†ï¼Œä»£ä»·ä¸€æ˜¯å¸¦æ¥äº†æŒç»­çš„IOï¼ŒäºŒæ˜¯AOF rewrite çš„æœ€åå°† rewrite è¿‡ç¨‹ä¸­äº§  ç”Ÿçš„æ–°æ•°æ®å†™åˆ°æ–°æ–‡ä»¶é€ æˆçš„é˜»å¡å‡ ä¹æ˜¯ä¸å¯é¿å…çš„ã€‚åªè¦ç¡¬ç›˜è®¸å¯ï¼Œåº”è¯¥å°½é‡å‡å°‘AOF rewriteçš„é¢‘ç‡ï¼ŒAOFé‡å†™çš„åŸºç¡€å¤§å°é»˜è®¤å€¼64Må¤ªå°äº†ï¼Œå¯ä»¥è®¾åˆ°5Gä»¥ä¸Šï¼Œé»˜è®¤è¶…è¿‡åŸå¤§å°100%å¤§å°é‡  å†™å¯ä»¥æ”¹åˆ°é€‚å½“çš„æ•°å€¼ã€‚
å¦‚æœä¸Enable AOF ï¼Œä»…é  Master-Slave Repllcation å®ç°é«˜å¯ç”¨æ€§ä¹Ÿå¯ä»¥ï¼Œèƒ½çœæ‰ä¸€å¤§ç¬”IOï¼Œä¹Ÿå‡å°‘äº†rewriteæ—¶å¸¦æ¥çš„ç³»ç»Ÿæ³¢åŠ¨ã€‚ä»£ä»·æ˜¯å¦‚æœMaster&#x2F;Slave åŒæ—¶å€’æ‰ï¼Œä¼šä¸¢å¤±åå‡ åˆ†é’Ÿçš„æ•°æ®ï¼Œ  å¯åŠ¨è„šæœ¬ä¹Ÿè¦æ¯”è¾ƒä¸¤ä¸ª Master&#x2F;Slave ä¸­çš„ RDBæ–‡ä»¶ï¼Œè½½å…¥è¾ƒæ–°çš„é‚£ä¸ªï¼Œå¾®åšå°±æ˜¯è¿™ç§æ¶æ„ã€‚



]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>RedisåŸºç¡€å…¥é—¨</tag>
      </tags>
  </entry>
  <entry>
    <title>RedisåŸºç¡€å…¥é—¨(å…­)SpringBootæ•´åˆ</title>
    <url>/Redis/Redis%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8(%E5%85%AD)SpringBoot%E6%95%B4%E5%90%88/</url>
    <content><![CDATA[RedisåŸºç¡€å…¥é—¨(å…­)SpringBootæ•´åˆSpringBoot æ“ä½œæ•°æ®ï¼Œæ·»åŠ Spring Dataä¸‹
Spring Data:Â  Spring çš„ä¸€ä¸ªå­é¡¹ç›®ã€‚ç”¨äºç®€åŒ–æ•°æ®åº“è®¿é—®ï¼Œæ”¯æŒNoSQLå’Œå…³ç³»æ•°æ®åº“å­˜å‚¨ã€‚å…¶ä¸»è¦ç›®æ ‡æ˜¯ä½¿æ•°æ®åº“çš„è®¿é—®å˜å¾—æ–¹ä¾¿å¿«æ·ã€‚
Spring Data é¡¹ç›®æ‰€æ”¯æŒNoSQLå­˜å‚¨ï¼š


MongoDBï¼ˆæ–‡æ¡£æ•°æ®åº“ï¼‰



Neo4j ï¼ˆå›¾å½¢æ•°æ®åº“ï¼‰



Redisï¼ˆé”®&#x2F;å€¼å­˜å‚¨ï¼‰



Hbaseï¼ˆåˆ—æ—æ•°æ®åº“ï¼‰



Spring Data é¡¹ç›®æ‰€æ”¯æŒçš„å…³ç³»æ•°æ®å­˜å‚¨æŠ€æœ¯ï¼š


JDBC


-Â JPA


1. åˆ›å»ºSpringbootæ¨¡å—
é€‰æ‹©åˆ›å»ºModule â‡’ Spring Initializr



é…ç½®å‚æ•°åŠJDKç‰ˆæœ¬



é€‰æ‹©å¼€å‘å·¥å…·



é€‰æ‹©å­˜å‚¨ä½ç½®



è‡ªåŠ¨å¯¼å…¥ä¾èµ–
  &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;    &lt;parent&gt;        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;        &lt;version&gt;2.6.2&lt;/version&gt;        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;    &lt;/parent&gt;    &lt;groupId&gt;com.peppa&lt;/groupId&gt;    &lt;artifactId&gt;peppa-springboot-redis&lt;/artifactId&gt;    &lt;version&gt;0.1-SNAPSHOT&lt;/version&gt;    &lt;dependencies&gt;        &lt;dependency&gt;            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;        &lt;/dependency&gt;        &lt;dependency&gt;            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;        &lt;/dependency&gt;        &lt;dependency&gt;            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;            &lt;scope&gt;runtime&lt;/scope&gt;            &lt;optional&gt;true&lt;/optional&gt;        &lt;/dependency&gt;        &lt;dependency&gt;            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;            &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt;            &lt;optional&gt;true&lt;/optional&gt;        &lt;/dependency&gt;        &lt;dependency&gt;            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;            &lt;artifactId&gt;lombok&lt;/artifactId&gt;            &lt;optional&gt;true&lt;/optional&gt;        &lt;/dependency&gt;        &lt;dependency&gt;            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;        &lt;/dependency&gt;    &lt;/dependencies&gt;    &lt;build&gt;        &lt;plugins&gt;            &lt;plugin&gt;                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;                &lt;configuration&gt;                    &lt;excludes&gt;                        &lt;exclude&gt;                            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;                            &lt;artifactId&gt;lombok&lt;/artifactId&gt;                        &lt;/exclude&gt;                    &lt;/excludes&gt;                &lt;/configuration&gt;            &lt;/plugin&gt;        &lt;/plugins&gt;    &lt;/build&gt;&lt;/project&gt;
  

è¯´æ˜ï¼š åœ¨ SpringBoot2.x ä¹‹åï¼ŒåŸæ¥ä½¿ç”¨çš„jedis è¢«æ›¿æ¢ä¸ºäº† lettuce?
  jedis : é‡‡ç”¨çš„ç›´è¿ï¼Œå¤šä¸ªçº¿ç¨‹æ“ä½œçš„è¯ï¼Œæ˜¯ä¸å®‰å…¨çš„ï¼Œå¦‚æœæƒ³è¦é¿å…ä¸å®‰å…¨çš„ï¼Œä½¿ç”¨ jedis pool è¿æ¥æ± ï¼ æ›´åƒ BIO æ¨¡å¼  lettuce : é‡‡ç”¨nettyï¼Œå®ä¾‹å¯ä»¥å†å¤šä¸ªçº¿ç¨‹ä¸­è¿›è¡Œå…±äº«ï¼Œä¸å­˜åœ¨çº¿ç¨‹ä¸å®‰å…¨çš„æƒ…å†µï¼å¯ä»¥å‡å°‘çº¿ç¨‹æ•°æ®äº†ï¼Œæ›´åƒ NIO æ¨¡å¼

æŸ¥çœ‹è‡ªåŠ¨é…ç½®æ–‡ä»¶ï¼šspring-autoconfigure-metadata.properties
  SpringBootæ‰€æœ‰çš„é…ç½®ç±»ï¼Œéƒ½æœ‰ä¸€ä¸ªè‡ªåŠ¨é…ç½®ç±»ï¼Œè‡ªåŠ¨é…ç½®ç±»éƒ½ä¼šç»‘å®šä¸€ä¸ªpropertiesé…ç½®æ–‡ä»¶
  

æºç åˆ†æï¼š
  @Configuration(proxyBeanMethods = false)@ConditionalOnClass(RedisOperations.class)@EnableConfigurationProperties(RedisProperties.class)@Import(&#123; LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class &#125;)public class RedisAutoConfiguration &#123;	@Bean	@ConditionalOnMissingBean(name = &quot;redisTemplate&quot;)	@ConditionalOnSingleCandidate(RedisConnectionFactory.class)	public RedisTemplate&lt;Object, Object&gt; redisTemplate(RedisConnectionFactory redisConnectionFactory) &#123;    // é»˜è®¤çš„ RedisTemplate æ²¡æœ‰è¿‡å¤šçš„è®¾ç½®ï¼Œredis å¯¹è±¡éƒ½æ˜¯éœ€è¦åºåˆ—åŒ–ï¼    // ä¸¤ä¸ªæ³›å‹éƒ½æ˜¯ Object, Object çš„ç±»å‹ï¼Œæˆ‘ä»¬åä½¿ç”¨éœ€è¦å¼ºåˆ¶è½¬æ¢ &lt;String, Object&gt;		RedisTemplate&lt;Object, Object&gt; template = new RedisTemplate&lt;&gt;();		template.setConnectionFactory(redisConnectionFactory);		return template;	&#125;	@Bean	@ConditionalOnMissingBean  // ç”±äº String æ˜¯redisä¸­æœ€å¸¸ä½¿ç”¨çš„ç±»å‹ï¼Œæ‰€ä»¥è¯´å•ç‹¬æå‡ºæ¥äº†ä¸€ä¸ªbeanï¼	@ConditionalOnSingleCandidate(RedisConnectionFactory.class)	public StringRedisTemplate stringRedisTemplate(RedisConnectionFactory redisConnectionFactory) &#123;		return new StringRedisTemplate(redisConnectionFactory);	&#125;&#125;

é…ç½®è¿æ¥
  # é…ç½®redisspring.redis.host=192.168.3.21spring.redis.port=6379

æµ‹è¯•
  package com.peppa;import org.junit.jupiter.api.Test;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.test.context.SpringBootTest;import org.springframework.data.redis.core.RedisTemplate;@SpringBootTestclass PeppaSpringbootRedisApplicationTests &#123;    private static final Logger logger = LoggerFactory.getLogger(PeppaSpringbootRedisApplicationTests.class);    @Autowired    private RedisTemplate redisTemplate;    @Test    void contextLoads() &#123;        // redisTemplate æ“ä½œä¸åŒçš„æ•°æ®ç±»å‹ï¼Œapiå’Œæˆ‘ä»¬çš„æŒ‡ä»¤æ˜¯ä¸€æ ·çš„        // opsForValue æ“ä½œå­—ç¬¦ä¸² ç±»ä¼¼String        // opsForList æ“ä½œList ç±»ä¼¼List        // opsForSet        // opsForHash        // opsForZSet        // opsForGeo        // opsForHyperLogLog        // é™¤äº†è¿›æœ¬çš„æ“ä½œï¼Œæˆ‘ä»¬å¸¸ç”¨çš„æ–¹æ³•éƒ½å¯ä»¥ç›´æ¥é€šè¿‡redisTemplateæ“ä½œï¼Œæ¯”å¦‚äº‹åŠ¡ï¼Œå’ŒåŸºæœ¬çš„CRUD        // è·å–redisçš„è¿æ¥å¯¹è±¡        // RedisConnection connection =        redisTemplate.getConnectionFactory().getConnection();        // connection.flushDb();        // connection.flushAll();        redisTemplate.opsForValue().set(&quot;mykey&quot;, &quot;å°çŒªä½©å¥‡&quot;);        logger.info(&quot;mykey===&gt;&#123;&#125;&quot;,redisTemplate.opsForValue().get(&quot;mykey&quot;));    &#125;&#125;

2. Redisåºåˆ—åŒ–é…ç½®
é»˜è®¤åºåˆ—åŒ–

Redisæ¨¡æ¿å¯¹è±¡ä¸­ä¼šä½¿ç”¨åˆ°çš„åºåˆ—åŒ–ï¼šorg.springframework.data.redis.core.RedisTemplateï¼Œé»˜è®¤çš„åºåˆ—åŒ–æ˜¯JDK

  

å…³äºä¿å­˜å¯¹è±¡
  æ‰€æœ‰çš„å¯¹è±¡ï¼Œéƒ½éœ€è¦åºåˆ—åŒ–ï¼Œä¸éœ€è¦çš„ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯
  @Testpublic void setObjectToRedisTest() &#123;    User user = new User(1,&quot;å°çŒªä½©å¥‡&quot;);    redisTemplate.opsForValue().set(&quot;user&quot;,user);    logger.info(&quot;user==&gt;&#123;&#125;&quot;,redisTemplate.opsForValue().get(&quot;user&quot;));&#125;
  

è‡ªå®šä¹‰RedisTemplete


package com.peppa.config;import com.fasterxml.jackson.annotation.JsonAutoDetect;import com.fasterxml.jackson.annotation.JsonTypeInfo;import com.fasterxml.jackson.annotation.PropertyAccessor;import com.fasterxml.jackson.databind.ObjectMapper;import com.fasterxml.jackson.databind.jsontype.impl.LaissezFaireSubTypeValidator;import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;import org.springframework.boot.autoconfigure.condition.ConditionalOnSingleCandidate;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.data.redis.connection.RedisConnectionFactory;import org.springframework.data.redis.core.RedisTemplate;import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;import org.springframework.data.redis.serializer.StringRedisSerializer;import org.springframework.stereotype.Component;@Configurationpublic class RedisConfig &#123;    /**     * è‡ªå·±å®šä¹‰äº†ä¸€ä¸ª RedisTemplate     * @param redisConnectionFactory     * @return     */    @Bean    public RedisTemplate&lt;String, Object&gt; redisTemplate(RedisConnectionFactory redisConnectionFactory) &#123;        // æˆ‘ä»¬ä¸ºäº†è‡ªå·±å¼€å‘æ–¹ä¾¿ï¼Œä¸€èˆ¬ç›´æ¥ä½¿ç”¨ &lt;String, Object&gt;        RedisTemplate&lt;String, Object&gt; template = new RedisTemplate&lt;&gt;();        template.setConnectionFactory(redisConnectionFactory);        // Jsonåºåˆ—åŒ–é…ç½®        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class);        ObjectMapper om = new ObjectMapper();        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);        om.activateDefaultTyping(LaissezFaireSubTypeValidator.instance,ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.PROPERTY);        jackson2JsonRedisSerializer.setObjectMapper(om);        // String çš„åºåˆ—åŒ–        StringRedisSerializer stringRedisSerializer = new StringRedisSerializer();        // keyé‡‡ç”¨Stringçš„åºåˆ—åŒ–æ–¹å¼        template.setKeySerializer(stringRedisSerializer);        // hashçš„keyä¹Ÿé‡‡ç”¨Stringçš„åºåˆ—åŒ–æ–¹å¼        template.setHashKeySerializer(stringRedisSerializer);        // valueåºåˆ—åŒ–æ–¹å¼é‡‡ç”¨jackson        template.setValueSerializer(jackson2JsonRedisSerializer);        // hashçš„valueåºåˆ—åŒ–æ–¹å¼é‡‡ç”¨jackson        template.setHashValueSerializer(jackson2JsonRedisSerializer);        template.afterPropertiesSet();        return template;    &#125;&#125;


è‡ªå®šä¹‰RedisUtil

package com.peppa.util;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.data.redis.core.RedisTemplate;import org.springframework.stereotype.Component;import org.springframework.util.CollectionUtils;import java.util.List;import java.util.Map;import java.util.Set;import java.util.concurrent.TimeUnit;@Componentpublic class RedisUtil &#123;    @Autowired    private RedisTemplate redisTemplate;    // =============================common============================    /**     * æŒ‡å®šç¼“å­˜å¤±æ•ˆæ—¶é—´     *     * @param key  é”®     * @param time æ—¶é—´(ç§’)     */    public boolean expire(String key, long time) &#123;        try &#123;            if (time &gt; 0) &#123;                redisTemplate.expire(key, time, TimeUnit.SECONDS);            &#125;            return true;        &#125; catch (Exception e) &#123;            e.printStackTrace();            return false;        &#125;    &#125;    /**     * æ ¹æ®key è·å–è¿‡æœŸæ—¶é—´     *     * @param key é”® ä¸èƒ½ä¸ºnull     * @return æ—¶é—´(ç§’) è¿”å›0ä»£è¡¨ä¸ºæ°¸ä¹…æœ‰æ•ˆ     */    public long getExpire(String key) &#123;        return redisTemplate.getExpire(key, TimeUnit.SECONDS);    &#125;    /**     * åˆ¤æ–­keyæ˜¯å¦å­˜åœ¨     *     * @param key é”®     * @return true å­˜åœ¨ falseä¸å­˜åœ¨     */    public boolean hasKey(String key) &#123;        try &#123;            return redisTemplate.hasKey(key);        &#125; catch (Exception e) &#123;            e.printStackTrace();            return false;        &#125;    &#125;    /**     * åˆ é™¤ç¼“å­˜     *     * @param key å¯ä»¥ä¼ ä¸€ä¸ªå€¼ æˆ–å¤šä¸ª     */    @SuppressWarnings(&quot;unchecked&quot;)    public void del(String... key) &#123;        if (key != null &amp;&amp; key.length &gt; 0) &#123;            if (key.length == 1) &#123;                redisTemplate.delete(key[0]);            &#125; else &#123;                redisTemplate.delete(CollectionUtils.arrayToList(key));            &#125;        &#125;    &#125;    // ============================String=============================    /**     * æ™®é€šç¼“å­˜è·å–     *     * @param key é”®     * @return å€¼     */    public Object get(String key) &#123;        return key == null ? null : redisTemplate.opsForValue().get(key);    &#125;    /**     * æ™®é€šç¼“å­˜æ”¾å…¥     *     * @param key   é”®     * @param value å€¼     * @return trueæˆåŠŸ falseå¤±è´¥     */    public boolean set(String key, Object value) &#123;        try &#123;            redisTemplate.opsForValue().set(key, value);            return true;        &#125; catch (Exception e) &#123;            e.printStackTrace();            return false;        &#125;    &#125;    /**     * æ™®é€šç¼“å­˜æ”¾å…¥å¹¶è®¾ç½®æ—¶é—´     *     * @param key   é”®     * @param value å€¼     * @param time  æ—¶é—´(ç§’) timeè¦å¤§äº0 å¦‚æœtimeå°äºç­‰äº0 å°†è®¾ç½®æ— é™æœŸ     * @return trueæˆåŠŸ false å¤±è´¥     */    public boolean set(String key, Object value, long time) &#123;        try &#123;            if (time &gt; 0) &#123;                redisTemplate.opsForValue().set(key, value, time, TimeUnit.SECONDS);            &#125; else &#123;                set(key, value);            &#125;            return true;        &#125; catch (Exception e) &#123;            e.printStackTrace();            return false;        &#125;    &#125;    /**     * é€’å¢     *     * @param key   é”®     * @param delta è¦å¢åŠ å‡ (å¤§äº0)     */    public long incr(String key, long delta) &#123;        if (delta &lt; 0) &#123;            throw new RuntimeException(&quot;é€’å¢å› å­å¿…é¡»å¤§äº0&quot;);        &#125;        return redisTemplate.opsForValue().increment(key, delta);    &#125;    /**     * é€’å‡     *     * @param key   é”®     * @param delta è¦å‡å°‘å‡ (å°äº0)     */    public long decr(String key, long delta) &#123;        if (delta &lt; 0) &#123;            throw new RuntimeException(&quot;é€’å‡å› å­å¿…é¡»å¤§äº0&quot;);        &#125;        return redisTemplate.opsForValue().increment(key, -delta);    &#125;    // ================================Map=================================    /**     * HashGet     *     * @param key  é”® ä¸èƒ½ä¸ºnull     * @param item é¡¹ ä¸èƒ½ä¸ºnull     */    public Object hget(String key, String item) &#123;        return redisTemplate.opsForHash().get(key, item);    &#125;    /**     * è·å–hashKeyå¯¹åº”çš„æ‰€æœ‰é”®å€¼     *     * @param key é”®     * @return å¯¹åº”çš„å¤šä¸ªé”®å€¼     */    public Map&lt;Object, Object&gt; hmget(String key) &#123;        return redisTemplate.opsForHash().entries(key);    &#125;    /**     * HashSet     *     * @param key é”®     * @param map å¯¹åº”å¤šä¸ªé”®å€¼     */    public boolean hmset(String key, Map&lt;String, Object&gt; map) &#123;        try &#123;            redisTemplate.opsForHash().putAll(key, map);            return true;        &#125; catch (Exception e) &#123;            e.printStackTrace();            return false;        &#125;    &#125;    /**     * HashSet å¹¶è®¾ç½®æ—¶é—´     *     * @param key  é”®     * @param map  å¯¹åº”å¤šä¸ªé”®å€¼     * @param time æ—¶é—´(ç§’)     * @return trueæˆåŠŸ falseå¤±è´¥     */    public boolean hmset(String key, Map&lt;String, Object&gt; map, long time) &#123;        try &#123;            redisTemplate.opsForHash().putAll(key, map);            if (time &gt; 0) &#123;                expire(key, time);            &#125;            return true;        &#125; catch (Exception e) &#123;            e.printStackTrace();            return false;        &#125;    &#125;    /**     * å‘ä¸€å¼ hashè¡¨ä¸­æ”¾å…¥æ•°æ®,å¦‚æœä¸å­˜åœ¨å°†åˆ›å»º     *     * @param key   é”®     * @param item  é¡¹     * @param value å€¼     * @return true æˆåŠŸ falseå¤±è´¥     */    public boolean hset(String key, String item, Object value) &#123;        try &#123;            redisTemplate.opsForHash().put(key, item, value);            return true;        &#125; catch (Exception e) &#123;            e.printStackTrace();            return false;        &#125;    &#125;    /**     * å‘ä¸€å¼ hashè¡¨ä¸­æ”¾å…¥æ•°æ®,å¦‚æœä¸å­˜åœ¨å°†åˆ›å»º     *     * @param key   é”®     * @param item  é¡¹     * @param value å€¼     * @param time  æ—¶é—´(ç§’) æ³¨æ„:å¦‚æœå·²å­˜åœ¨çš„hashè¡¨æœ‰æ—¶é—´,è¿™é‡Œå°†ä¼šæ›¿æ¢åŸæœ‰çš„æ—¶é—´     * @return true æˆåŠŸ falseå¤±è´¥     */    public boolean hset(String key, String item, Object value, long time) &#123;        try &#123;            redisTemplate.opsForHash().put(key, item, value);            if (time &gt; 0) &#123;                expire(key, time);            &#125;            return true;        &#125; catch (Exception e) &#123;            e.printStackTrace();            return false;        &#125;    &#125;    /**     * åˆ é™¤hashè¡¨ä¸­çš„å€¼     *     * @param key  é”® ä¸èƒ½ä¸ºnull     * @param item é¡¹ å¯ä»¥ä½¿å¤šä¸ª ä¸èƒ½ä¸ºnull     */    public void hdel(String key, Object... item) &#123;        redisTemplate.opsForHash().delete(key, item);    &#125;    /**     * åˆ¤æ–­hashè¡¨ä¸­æ˜¯å¦æœ‰è¯¥é¡¹çš„å€¼     *     * @param key  é”® ä¸èƒ½ä¸ºnull     * @param item é¡¹ ä¸èƒ½ä¸ºnull     * @return true å­˜åœ¨ falseä¸å­˜åœ¨     */    public boolean hHasKey(String key, String item) &#123;        return redisTemplate.opsForHash().hasKey(key, item);    &#125;    /**     * hashé€’å¢ å¦‚æœä¸å­˜åœ¨,å°±ä¼šåˆ›å»ºä¸€ä¸ª å¹¶æŠŠæ–°å¢åçš„å€¼è¿”å›     *     * @param key  é”®     * @param item é¡¹     * @param by   è¦å¢åŠ å‡ (å¤§äº0)     */    public double hincr(String key, String item, double by) &#123;        return redisTemplate.opsForHash().increment(key, item, by);    &#125;    /**     * hashé€’å‡     *     * @param key  é”®     * @param item é¡¹     * @param by   è¦å‡å°‘è®°(å°äº0)     */    public double hdecr(String key, String item, double by) &#123;        return redisTemplate.opsForHash().increment(key, item, -by);    &#125;    // ============================set=============================    /**     * æ ¹æ®keyè·å–Setä¸­çš„æ‰€æœ‰å€¼     *     * @param key é”®     */    public Set&lt;Object&gt; sGet(String key) &#123;        try &#123;            return redisTemplate.opsForSet().members(key);        &#125; catch (Exception e) &#123;            e.printStackTrace();            return null;        &#125;    &#125;    /**     * æ ¹æ®valueä»ä¸€ä¸ªsetä¸­æŸ¥è¯¢,æ˜¯å¦å­˜åœ¨     *     * @param key   é”®     * @param value å€¼     * @return true å­˜åœ¨ falseä¸å­˜åœ¨     */    public boolean sHasKey(String key, Object value) &#123;        try &#123;            return redisTemplate.opsForSet().isMember(key, value);        &#125; catch (Exception e) &#123;            e.printStackTrace();            return false;        &#125;    &#125;    /**     * å°†æ•°æ®æ”¾å…¥setç¼“å­˜     *     * @param key    é”®     * @param values å€¼ å¯ä»¥æ˜¯å¤šä¸ª     * @return æˆåŠŸä¸ªæ•°     */    public long sSet(String key, Object... values) &#123;        try &#123;            return redisTemplate.opsForSet().add(key, values);        &#125; catch (Exception e) &#123;            e.printStackTrace();            return 0;        &#125;    &#125;    /**     * å°†setæ•°æ®æ”¾å…¥ç¼“å­˜     *     * @param key    é”®     * @param time   æ—¶é—´(ç§’)     * @param values å€¼ å¯ä»¥æ˜¯å¤šä¸ª     * @return æˆåŠŸä¸ªæ•°     */    public long sSetAndTime(String key, long time, Object... values) &#123;        try &#123;            Long count = redisTemplate.opsForSet().add(key, values);            if (time &gt; 0)                expire(key, time);            return count;        &#125; catch (Exception e) &#123;            e.printStackTrace();            return 0;        &#125;    &#125;    /**     * è·å–setç¼“å­˜çš„é•¿åº¦     *     * @param key é”®     */    public long sGetSetSize(String key) &#123;        try &#123;            return redisTemplate.opsForSet().size(key);        &#125; catch (Exception e) &#123;            e.printStackTrace();            return 0;        &#125;    &#125;    /**     * ç§»é™¤å€¼ä¸ºvalueçš„     *     * @param key    é”®     * @param values å€¼ å¯ä»¥æ˜¯å¤šä¸ª     * @return ç§»é™¤çš„ä¸ªæ•°     */    public long setRemove(String key, Object... values) &#123;        try &#123;            Long count = redisTemplate.opsForSet().remove(key, values);            return count;        &#125; catch (Exception e) &#123;            e.printStackTrace();            return 0;        &#125;    &#125;    // ===============================list=================================    /**     * è·å–listç¼“å­˜çš„å†…å®¹     *     * @param key   é”®     * @param start å¼€å§‹     * @param end   ç»“æŸ 0 åˆ° -1ä»£è¡¨æ‰€æœ‰å€¼     */    public List&lt;Object&gt; lGet(String key, long start, long end) &#123;        try &#123;            return redisTemplate.opsForList().range(key, start, end);        &#125; catch (Exception e) &#123;            e.printStackTrace();            return null;        &#125;    &#125;    /**     * è·å–listç¼“å­˜çš„é•¿åº¦     *     * @param key é”®     */    public long lGetListSize(String key) &#123;        try &#123;            return redisTemplate.opsForList().size(key);        &#125; catch (Exception e) &#123;            e.printStackTrace();            return 0;        &#125;    &#125;    /**     * é€šè¿‡ç´¢å¼• è·å–listä¸­çš„å€¼     *     * @param key   é”®     * @param index ç´¢å¼• index&gt;=0æ—¶ï¼Œ 0 è¡¨å¤´ï¼Œ1 ç¬¬äºŒä¸ªå…ƒç´ ï¼Œä¾æ¬¡ç±»æ¨ï¼›index&lt;0æ—¶ï¼Œ-1ï¼Œè¡¨å°¾ï¼Œ-2å€’æ•°ç¬¬äºŒä¸ªå…ƒç´ ï¼Œä¾æ¬¡ç±»æ¨     */    public Object lGetIndex(String key, long index) &#123;        try &#123;            return redisTemplate.opsForList().index(key, index);        &#125; catch (Exception e) &#123;            e.printStackTrace();            return null;        &#125;    &#125;    /**     * å°†listæ”¾å…¥ç¼“å­˜     *     * @param key   é”®     * @param value å€¼     */    public boolean lSet(String key, Object value) &#123;        try &#123;            redisTemplate.opsForList().rightPush(key, value);            return true;        &#125; catch (Exception e) &#123;            e.printStackTrace();            return false;        &#125;    &#125;    /**     * å°†listæ”¾å…¥ç¼“å­˜     *     * @param key   é”®     * @param value å€¼     * @param time  æ—¶é—´(ç§’)     */    public boolean lSet(String key, Object value, long time) &#123;        try &#123;            redisTemplate.opsForList().rightPush(key, value);            if (time &gt; 0)                expire(key, time);            return true;        &#125; catch (Exception e) &#123;            e.printStackTrace();            return false;        &#125;    &#125;    /**     * å°†listæ”¾å…¥ç¼“å­˜     *     * @param key   é”®     * @param value å€¼     * @return     */    public boolean lSet(String key, List&lt;Object&gt; value) &#123;        try &#123;            redisTemplate.opsForList().rightPushAll(key, value);            return true;        &#125; catch (Exception e) &#123;            e.printStackTrace();            return false;        &#125;    &#125;    /**     * å°†listæ”¾å…¥ç¼“å­˜     *     * @param key   é”®     * @param value å€¼     * @param time  æ—¶é—´(ç§’)     * @return     */    public boolean lSet(String key, List&lt;Object&gt; value, long time) &#123;        try &#123;            redisTemplate.opsForList().rightPushAll(key, value);            if (time &gt; 0)                expire(key, time);            return true;        &#125; catch (Exception e) &#123;            e.printStackTrace();            return false;        &#125;    &#125;    /**     * æ ¹æ®ç´¢å¼•ä¿®æ”¹listä¸­çš„æŸæ¡æ•°æ®     *     * @param key   é”®     * @param index ç´¢å¼•     * @param value å€¼     * @return     */    public boolean lUpdateIndex(String key, long index, Object value) &#123;        try &#123;            redisTemplate.opsForList().set(key, index, value);            return true;        &#125; catch (Exception e) &#123;            e.printStackTrace();            return false;        &#125;    &#125;    /**     * ç§»é™¤Nä¸ªå€¼ä¸ºvalue     *     * @param key   é”®     * @param count ç§»é™¤å¤šå°‘ä¸ª     * @param value å€¼     * @return ç§»é™¤çš„ä¸ªæ•°     */    public long lRemove(String key, long count, Object value) &#123;        try &#123;            Long remove = redisTemplate.opsForList().remove(key, count, value);            return remove;        &#125; catch (Exception e) &#123;            e.printStackTrace();            return 0;        &#125;    &#125;&#125;


æµ‹è¯•RedisUtil

@Autowiredprivate RedisUtil redisUtil;@Testpublic void redisUtilTest()&#123;    redisUtil.set(&quot;userName&quot;,&quot;peppa&quot;);    logger.info(&quot;userName===&gt;&#123;&#125;&quot;,redisUtil.get(&quot;userName&quot;));&#125;



]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>RedisåŸºç¡€å…¥é—¨</tag>
      </tags>
  </entry>
  <entry>
    <title>RedisåŸºç¡€å…¥é—¨(å)Redisä¸»ä»å¤åˆ¶</title>
    <url>/Redis/Redis%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8(%E5%8D%81)Redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/</url>
    <content><![CDATA[RedisåŸºç¡€å…¥é—¨(å)Redisä¸»ä»å¤åˆ¶1. ä¸»ä»å¤åˆ¶ä¸»ä»å¤åˆ¶ï¼Œæ˜¯æŒ‡å°†ä¸€å°RedisæœåŠ¡å™¨çš„æ•°æ®ï¼Œå¤åˆ¶åˆ°å…¶ä»–çš„RedisæœåŠ¡å™¨ã€‚å‰è€…ç§°ä¸ºä¸»èŠ‚ç‚¹(master&#x2F;leader)ï¼Œåè€…ç§°ä¸ºä»èŠ‚ç‚¹(slave&#x2F;follower)ï¼›æ•°æ®çš„å¤åˆ¶æ˜¯å•å‘çš„ï¼Œåªèƒ½ç”±ä¸»èŠ‚ç‚¹åˆ°ä»èŠ‚ç‚¹ã€‚Masterä»¥å†™ä¸ºä¸»ï¼ŒSlave ä»¥è¯»ä¸ºä¸»ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯å°RedisæœåŠ¡å™¨éƒ½æ˜¯ä¸»èŠ‚ç‚¹ï¼›ä¸”ä¸€ä¸ªä¸»èŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªä»èŠ‚ç‚¹(æˆ–æ²¡æœ‰ä»èŠ‚ç‚¹)ï¼Œä½†ä¸€ä¸ªä»èŠ‚ç‚¹åªèƒ½æœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹ã€‚

ä¸»ä»å¤åˆ¶çš„ä½œç”¨ä¸»è¦åŒ…æ‹¬ï¼š
æ•°æ®å†—ä½™ï¼šä¸»ä»å¤åˆ¶å®ç°äº†æ•°æ®çš„çƒ­å¤‡ä»½ï¼Œæ˜¯æŒä¹…åŒ–ä¹‹å¤–çš„ä¸€ç§æ•°æ®å†—ä½™æ–¹å¼ã€‚
æ•…éšœæ¢å¤ï¼šå½“ä¸»èŠ‚ç‚¹å‡ºç°é—®é¢˜æ—¶ï¼Œå¯ä»¥ç”±ä»èŠ‚ç‚¹æä¾›æœåŠ¡ï¼Œå®ç°å¿«é€Ÿçš„æ•…éšœæ¢å¤ï¼›å®é™…ä¸Šæ˜¯ä¸€ç§æœåŠ¡çš„å†—ä½™ã€‚
è´Ÿè½½å‡è¡¡ï¼šåœ¨ä¸»ä»å¤åˆ¶çš„åŸºç¡€ä¸Šï¼Œé…åˆè¯»å†™åˆ†ç¦»ï¼Œå¯ä»¥ç”±ä¸»èŠ‚ç‚¹æä¾›å†™æœåŠ¡ï¼Œç”±ä»èŠ‚ç‚¹æä¾›è¯»æœåŠ¡ï¼ˆå³å†™Redisæ•°æ®æ—¶åº”ç”¨è¿æ¥ä¸»èŠ‚ç‚¹ï¼Œè¯»Redisæ•°æ®æ—¶åº”ç”¨è¿æ¥ä»èŠ‚ç‚¹ï¼‰ï¼Œåˆ†æ‹…æœåŠ¡å™¨è´Ÿè½½ï¼›å°¤å…¶æ˜¯åœ¨å†™å°‘è¯»å¤šçš„åœºæ™¯ä¸‹ï¼Œé€šè¿‡å¤šä¸ªä»èŠ‚ç‚¹åˆ†æ‹…è¯»è´Ÿè½½ï¼Œå¯ä»¥å¤§å¤§æé«˜RedisæœåŠ¡å™¨çš„å¹¶å‘é‡ã€‚
é«˜å¯ç”¨ï¼ˆé›†ç¾¤ï¼‰åŸºçŸ³ï¼šé™¤äº†ä¸Šè¿°ä½œç”¨ä»¥å¤–ï¼Œä¸»ä»å¤åˆ¶è¿˜æ˜¯å“¨å…µå’Œé›†ç¾¤èƒ½å¤Ÿå®æ–½çš„åŸºç¡€ï¼Œå› æ­¤è¯´ä¸»ä»å¤åˆ¶æ˜¯Redisé«˜å¯ç”¨çš„åŸºç¡€ã€‚



ä¸€èˆ¬æ¥è¯´ï¼Œè¦å°†Redisè¿ç”¨äºå·¥ç¨‹é¡¹ç›®ä¸­ï¼Œåªä½¿ç”¨ä¸€å°Redisæ˜¯ä¸‡ä¸‡ä¸èƒ½çš„ï¼ˆå®•æœºï¼‰ï¼ŒåŸå› å¦‚ä¸‹ï¼š

ä»ç»“æ„ä¸Šï¼Œå•ä¸ªRedisæœåŠ¡å™¨ä¼šå‘ç”Ÿå•ç‚¹æ•…éšœï¼Œå¹¶ä¸”ä¸€å°æœåŠ¡å™¨éœ€è¦å¤„ç†æ‰€æœ‰çš„è¯·æ±‚è´Ÿè½½ï¼Œå‹åŠ›è¾ƒå¤§ï¼›
ä»å®¹é‡ä¸Šï¼Œå•ä¸ªRedisæœåŠ¡å™¨å†…å­˜å®¹é‡æœ‰é™ï¼Œå°±ç®—ä¸€å°RedisæœåŠ¡å™¨å†…å­˜å®¹é‡ä¸º256Gï¼Œä¹Ÿä¸èƒ½å°†æ‰€æœ‰å†…å­˜ç”¨ä½œRediså­˜å‚¨å†…å­˜ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå•å°Redisæœ€å¤§ä½¿ç”¨å†…å­˜ä¸åº”è¯¥è¶…è¿‡20Gã€‚
ç”µå•†ç½‘ç«™ä¸Šçš„å•†å“ï¼Œä¸€èˆ¬éƒ½æ˜¯ä¸€æ¬¡ä¸Šä¼ ï¼Œæ— æ•°æ¬¡æµè§ˆçš„ï¼Œè¯´ä¸“ä¸šç‚¹ä¹Ÿå°±æ˜¯â€å¤šè¯»å°‘å†™â€ã€‚å¯¹äºè¿™ç§åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿å¦‚ä¸‹è¿™ç§æ¶æ„ï¼š


ä¸»ä»å¤åˆ¶ï¼Œè¯»å†™åˆ†ç¦»ï¼ 80% çš„æƒ…å†µä¸‹éƒ½æ˜¯åœ¨è¿›è¡Œè¯»æ“ä½œï¼å‡ç¼“æœåŠ¡å™¨çš„å‹åŠ›ï¼æ¶æ„ä¸­ç»å¸¸ä½¿ç”¨ï¼ ä¸€ä¸»äºŒä»ï¼åªè¦åœ¨å…¬å¸ä¸­ï¼Œä¸»ä»å¤åˆ¶å°±æ˜¯å¿…é¡»è¦ä½¿ç”¨çš„ï¼Œå› ä¸ºåœ¨çœŸå®çš„é¡¹ç›®ä¸­ä¸å¯èƒ½å•æœºä½¿ç”¨Redisï¼
2. ç¯å¢ƒé…ç½®
åªé…ç½®ä»åº“ï¼Œä¸ç”¨é…ç½®ä¸»åº“ï¼

127.0.0.1:6379&gt; info replication # æŸ¥çœ‹å½“å‰åº“çš„ä¿¡æ¯# Replicationrole:master # è§’è‰² masterconnected_slaves:0 # æ²¡æœ‰ä»æœºmaster_failover_state:no-failovermaster_replid:b63c90e6c501143759cb0e7f450bd1eb0c70882amaster_replid2:0000000000000000000000000000000000000000master_repl_offset:0second_repl_offset:-1repl_backlog_active:0repl_backlog_size:1048576repl_backlog_first_byte_offset:0repl_backlog_histlen:0


å¤åˆ¶3ä¸ªé…ç½®æ–‡ä»¶ï¼Œç„¶åä¿®æ”¹å¯¹åº”çš„ä¿¡æ¯
ç«¯å£
pid åå­—
logæ–‡ä»¶åå­—
dump.rdb åå­—  ä¿®æ”¹å®Œæ¯•ä¹‹åï¼Œå¯åŠ¨æˆ‘ä»¬çš„3ä¸ªredisæœåŠ¡å™¨ï¼Œå¯ä»¥é€šè¿‡è¿›ç¨‹ä¿¡æ¯æŸ¥çœ‹ï¼



3. ä¸€ä¸»äºŒä»é…ç½®é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯å°RedisæœåŠ¡å™¨éƒ½æ˜¯ä¸»èŠ‚ç‚¹ï¼› æˆ‘ä»¬ä¸€èˆ¬æƒ…å†µä¸‹åªç”¨é…ç½®ä»æœºå°±å¥½äº†ï¼è®¤è€å¤§ï¼ ä¸€ä¸» ï¼ˆ79ï¼‰äºŒä»ï¼ˆ80ï¼Œ81ï¼‰

æœåŠ¡å™¨ï¼š6380ã€6381èŠ‚ç‚¹ï¼Œå‘½ä»¤ï¼šSLAVEOF 127.0.0.1 6379
çœŸå®çš„ä»ä¸»é…ç½®åº”è¯¥åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œè¿™æ ·çš„è¯æ˜¯æ°¸ä¹…çš„ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯å‘½ä»¤ï¼Œæš‚æ—¶çš„ï¼

127.0.0.1:6380&gt; SLAVEOF 127.0.0.1 6379OK127.0.0.1:6380&gt; info replication# Replicationrole:slavemaster_host:127.0.0.1master_port:6379master_link_status:upmaster_last_io_seconds_ago:11master_sync_in_progress:0slave_read_repl_offset:14slave_repl_offset:14slave_priority:100slave_read_only:1replica_announced:1connected_slaves:0master_failover_state:no-failovermaster_replid:b0d63cc54f188f3c8a92cc65e88134759417b18emaster_replid2:0000000000000000000000000000000000000000master_repl_offset:14second_repl_offset:-1repl_backlog_active:1repl_backlog_size:1048576repl_backlog_first_byte_offset:1repl_backlog_histlen:14


åœ¨ä¸»æœºèŠ‚ç‚¹ï¼šã€6379ã€‘ä¸­æŸ¥çœ‹ï¼

127.0.0.1:6379&gt; info replication# Replicationrole:masterconnected_slaves:2   # å¤šäº†ä»æœºçš„é…ç½®slave0:ip=127.0.0.1,port=6380,state=online,offset=14,lag=1  # å¤šäº†ä»æœºçš„é…ç½®slave1:ip=127.0.0.1,port=6381,state=online,offset=14,lag=0  # å¤šäº†ä»æœºçš„é…ç½®master_failover_state:no-failovermaster_replid:b0d63cc54f188f3c8a92cc65e88134759417b18emaster_replid2:0000000000000000000000000000000000000000master_repl_offset:14second_repl_offset:-1repl_backlog_active:1repl_backlog_size:1048576repl_backlog_first_byte_offset:1repl_backlog_histlen:14


ä¸»ä»æµ‹è¯•
  ä¸»æœºå¯ä»¥å†™ï¼Œä»æœºä¸èƒ½å†™åªèƒ½è¯»ï¼ä¸»æœºä¸­çš„æ‰€æœ‰ä¿¡æ¯å’Œæ•°æ®ï¼Œéƒ½ä¼šè‡ªåŠ¨è¢«ä»æœºä¿å­˜ï¼
  ä¸»æœºå†™ï¼š
  

ä»æœºåªèƒ½è¯»å–å†…å®¹ï¼š
  
  æµ‹è¯•ï¼š

ä¸»æœºæ–­å¼€è¿æ¥ï¼Œä»æœºä¾æ—§è¿æ¥åˆ°ä¸»æœºçš„ï¼Œä½†æ˜¯æ²¡æœ‰å†™æ“ä½œï¼Œè¿™ä¸ªæ—¶å€™ï¼Œä¸»æœºå¦‚æœå›æ¥äº†ï¼Œä»æœºä¾æ—§å¯ä»¥ç›´æ¥è·å–åˆ°ä¸»æœºå†™çš„ä¿¡æ¯ï¼
å¦‚æœæ˜¯ä½¿ç”¨å‘½ä»¤è¡Œï¼Œæ¥é…ç½®çš„ä¸»ä»ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœé‡å¯äº†ï¼Œå°±ä¼šå˜å›ä¸»æœºï¼åªè¦å˜ä¸ºä»æœºï¼Œç«‹é©¬å°±ä¼šä»ä¸»æœºä¸­è·å–å€¼ï¼


å¤åˆ¶åŸç†

Slave å¯åŠ¨æˆåŠŸè¿æ¥åˆ° master åä¼šå‘é€ä¸€ä¸ªsyncåŒæ­¥å‘½ä»¤ã€‚
Master æ¥åˆ°å‘½ä»¤ï¼Œå¯åŠ¨åå°çš„å­˜ç›˜è¿›ç¨‹ï¼ŒåŒæ—¶æ”¶é›†æ‰€æœ‰æ¥æ”¶åˆ°çš„ç”¨äºä¿®æ”¹æ•°æ®é›†å‘½ä»¤ï¼Œåœ¨åå°è¿›ç¨‹æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œmasterå°†ä¼ é€æ•´ä¸ªæ•°æ®æ–‡ä»¶åˆ°slaveï¼Œå¹¶å®Œæˆä¸€æ¬¡å®Œå…¨åŒæ­¥ã€‚
å…¨é‡å¤åˆ¶ï¼šè€ŒslaveæœåŠ¡åœ¨æ¥æ”¶åˆ°æ•°æ®åº“æ–‡ä»¶æ•°æ®åï¼Œå°†å…¶å­˜ç›˜å¹¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚
å¢é‡å¤åˆ¶ï¼šMaster ç»§ç»­å°†æ–°çš„æ‰€æœ‰æ”¶é›†åˆ°çš„ä¿®æ”¹å‘½ä»¤ä¾æ¬¡ä¼ ç»™slaveï¼Œå®ŒæˆåŒæ­¥ã€‚ä½†æ˜¯åªè¦æ˜¯é‡æ–°è¿æ¥masterï¼Œä¸€æ¬¡å®Œå…¨åŒæ­¥ï¼ˆå…¨é‡å¤åˆ¶ï¼‰å°†è¢«è‡ªåŠ¨æ‰§è¡Œï¼ æˆ‘ä»¬çš„æ•°æ®ä¸€å®šå¯ä»¥åœ¨ä»æœºä¸­çœ‹åˆ°ï¼


æ‰‹åŠ¨é€‰å¯¹ä¸»èŠ‚ç‚¹
  å¦‚æœä¸»æœºæ–­å¼€äº†è¿æ¥ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ SLAVEOF no one è®©è‡ªå·±å˜æˆä¸»æœºï¼å…¶ä»–çš„èŠ‚ç‚¹å°±å¯ä»¥æ‰‹åŠ¨è¿æ¥åˆ°æœ€æ–°çš„è¿™ä¸ªä¸»èŠ‚ç‚¹ï¼ˆæ‰‹åŠ¨ï¼‰ï¼å¦‚æœè¿™ä¸ªæ—¶å€™è€å¤§ä¿®å¤äº†ï¼Œé‚£å°±é‡æ–°è¿æ¥ï¼ˆé‡æ–°è®¾ç½®**SLAVEOFå‘½ä»¤**ï¼‰ï¼


4. å“¨å…µæ¨¡å¼æ¦‚è¿°ï¼šè‡ªåŠ¨é€‰ä¸¾masterçš„æ¨¡å¼
ä¸»ä»åˆ‡æ¢æŠ€æœ¯çš„æ–¹æ³•æ˜¯ï¼šå½“ä¸»æœåŠ¡å™¨å®•æœºåï¼Œéœ€è¦æ‰‹åŠ¨æŠŠä¸€å°ä»æœåŠ¡å™¨åˆ‡æ¢ä¸ºä¸»æœåŠ¡å™¨ï¼Œè¿™å°±éœ€è¦äººå·¥å¹²é¢„ï¼Œè´¹äº‹è´¹åŠ›ï¼Œè¿˜ä¼šé€ æˆä¸€æ®µæ—¶é—´å†…æœåŠ¡ä¸å¯ç”¨ã€‚è¿™ä¸æ˜¯ä¸€ç§æ¨èçš„æ–¹å¼ï¼Œæ›´å¤šæ—¶å€™ï¼Œæˆ‘ä»¬ä¼˜å…ˆè€ƒè™‘å“¨å…µæ¨¡å¼ã€‚Redisä»2.8å¼€å§‹æ­£å¼æä¾›äº†Sentinelï¼ˆå“¨å…µï¼‰ æ¶æ„æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚
åå°ç›‘æ§ä¸»æœºæ˜¯å¦æ•…éšœï¼Œå¦‚æœæ•…éšœäº†æ ¹æ®æŠ•ç¥¨æ•°è‡ªåŠ¨å°†ä»åº“è½¬æ¢ä¸ºä¸»åº“ã€‚å“¨å…µæ¨¡å¼æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ¨¡å¼ï¼Œé¦–å…ˆRedisæä¾›äº†å“¨å…µçš„å‘½ä»¤ï¼Œå“¨å…µæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œä½œä¸ºè¿›ç¨‹ï¼Œå®ƒä¼šç‹¬ç«‹è¿è¡Œã€‚å…¶åŸç†æ˜¯å“¨å…µé€šè¿‡å‘é€å‘½ä»¤ï¼Œç­‰å¾…RedisæœåŠ¡å™¨å“åº”ï¼Œä»è€Œç›‘æ§è¿è¡Œçš„å¤šä¸ªRediså®ä¾‹ã€‚


è¿™é‡Œçš„å“¨å…µæœ‰ä¸¤ä¸ªä½œç”¨

é€šè¿‡å‘é€å‘½ä»¤ï¼Œè®©RedisæœåŠ¡å™¨è¿”å›ç›‘æ§å…¶è¿è¡ŒçŠ¶æ€ï¼ŒåŒ…æ‹¬ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨ã€‚
å½“å“¨å…µç›‘æµ‹åˆ°masterå®•æœºï¼Œä¼šè‡ªåŠ¨å°†slaveåˆ‡æ¢æˆmasterï¼Œç„¶åé€šè¿‡å‘å¸ƒè®¢é˜…æ¨¡å¼é€šçŸ¥å…¶ä»–çš„ä»æœåŠ¡å™¨ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œè®©å®ƒä»¬åˆ‡æ¢ä¸»æœºã€‚

  ç„¶è€Œä¸€ä¸ªå“¨å…µè¿›ç¨‹å¯¹RedisæœåŠ¡å™¨è¿›è¡Œç›‘æ§ï¼Œå¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šä¸ªå“¨å…µè¿›è¡Œç›‘æ§ã€‚  å„ä¸ªå“¨å…µä¹‹é—´è¿˜ä¼šè¿›è¡Œç›‘æ§ï¼Œè¿™æ ·å°±å½¢æˆäº†å¤šå“¨å…µæ¨¡å¼ã€‚
  
  å‡è®¾ä¸»æœåŠ¡å™¨å®•æœºï¼Œå“¨å…µ1å…ˆæ£€æµ‹åˆ°è¿™ä¸ªç»“æœï¼Œç³»ç»Ÿå¹¶ä¸ä¼šé©¬ä¸Šè¿›è¡Œfailoverè¿‡ç¨‹ï¼Œä»…ä»…æ˜¯å“¨å…µ1ä¸»è§‚çš„è®¤ä¸ºä¸»æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œè¿™ä¸ªç°è±¡æˆä¸ºä¸»è§‚ä¸‹çº¿ã€‚å½“åé¢çš„å“¨å…µä¹Ÿæ£€æµ‹åˆ°ä¸»æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œå¹¶ä¸”æ•°é‡è¾¾åˆ°ä¸€å®šå€¼æ—¶ï¼Œé‚£ä¹ˆå“¨å…µä¹‹é—´å°±ä¼šè¿›è¡Œä¸€æ¬¡æŠ•ç¥¨ï¼ŒæŠ•ç¥¨çš„ç»“æœç”±ä¸€ä¸ªå“¨å…µå‘èµ·ï¼Œè¿›è¡Œfailover[æ•…éšœè½¬ç§»]æ“ä½œã€‚åˆ‡æ¢æˆåŠŸåï¼Œå°±ä¼šé€šè¿‡å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œè®©å„ä¸ªå“¨å…µæŠŠè‡ªå·±ç›‘æ§çš„ä»æœåŠ¡å™¨å®ç°åˆ‡æ¢ä¸»æœºï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºå®¢è§‚ä¸‹çº¿ã€‚
  

æµ‹è¯•
  æˆ‘ä»¬ç›®å‰çš„çŠ¶æ€æ˜¯ ä¸€ä¸»äºŒä»ï¼

é…ç½®å“¨å…µé…ç½®æ–‡ä»¶ sentinel.conf
  # sentinel monitor è¢«ç›‘æ§çš„åç§° host port 1sentinel monitor myredis 127.0.0.1 6379 1
  åé¢çš„è¿™ä¸ªæ•°å­—1ï¼Œä»£è¡¨ä¸»æœºæŒ‚äº†ï¼ŒslaveæŠ•ç¥¨çœ‹è®©è°æ¥æ›¿æˆä¸ºä¸»æœºï¼Œç¥¨æ•°æœ€å¤šçš„ï¼Œå°±ä¼šæˆä¸ºä¸»æœºï¼

å¯åŠ¨å“¨å…µ


  [root@localhost bin]# ./redis-sentinel config/sentinel.conf 23283:X 12 Jan 2022 07:06:19.119 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo23283:X 12 Jan 2022 07:06:19.119 # Redis version=6.2.6, bits=64, commit=00000000, modified=0, pid=23283, just started23283:X 12 Jan 2022 07:06:19.119 # Configuration loaded23283:X 12 Jan 2022 07:06:19.121 * monotonic clock: POSIX clock_gettime                _._                                                             _.-``__ &#x27;&#x27;-._                                                   _.-``    `.  `_.  &#x27;&#x27;-._           Redis 6.2.6 (00000000/0) 64 bit  .-`` .-```.  ```\/    _.,_ &#x27;&#x27;-._                                   (    &#x27;      ,       .-`  | `,    )     Running in sentinel mode |`-._`-...-` __...-.``-._|&#x27;` _.-&#x27;|     Port: 26379 |    `-._   `._    /     _.-&#x27;    |     PID: 23283  `-._    `-._  `-./  _.-&#x27;    _.-&#x27;                                    |`-._`-._    `-.__.-&#x27;    _.-&#x27;_.-&#x27;|                                   |    `-._`-._        _.-&#x27;_.-&#x27;    |           https://redis.io         `-._    `-._`-.__.-&#x27;_.-&#x27;    _.-&#x27;                                    |`-._`-._    `-.__.-&#x27;    _.-&#x27;_.-&#x27;|                                   |    `-._`-._        _.-&#x27;_.-&#x27;    |                                    `-._    `-._`-.__.-&#x27;_.-&#x27;    _.-&#x27;                                         `-._    `-.__.-&#x27;    _.-&#x27;                                                 `-._        _.-&#x27;                                                         `-.__.-&#x27;                                               23283:X 12 Jan 2022 07:06:19.122 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.23283:X 12 Jan 2022 07:06:19.122 # Sentinel ID is 4cc0f01814993b512993fe592448af8fb6590b0123283:X 12 Jan 2022 07:06:19.122 # +monitor master myredis 127.0.0.1 6379 quorum 123283:X 12 Jan 2022 07:06:19.123 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ myredis 127.0.0.1 637923283:X 12 Jan 2022 07:06:19.125 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ myredis 127.0.0.1 6379

å¦‚æœMaster èŠ‚ç‚¹æ–­å¼€äº†ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šä»ä»æœºä¸­éšæœºé€‰æ‹©ä¸€ä¸ªæœåŠ¡å™¨ï¼ ï¼ˆè¿™é‡Œé¢æœ‰ä¸€ä¸ªæŠ•ç¥¨ç®—æ³•ï¼ï¼‰

  
  
  å¦‚æœä¸»æœºæ­¤æ—¶å›æ¥äº†ï¼Œåªèƒ½å½’å¹¶åˆ°æ–°çš„ä¸»æœºä¸‹ï¼Œå½“åšä»æœºï¼Œè¿™å°±æ˜¯å“¨å…µæ¨¡å¼çš„è§„åˆ™ï¼
  

ä¼˜ç‚¹ç¼ºç‚¹

ä¼˜ç‚¹
å“¨å…µé›†ç¾¤ï¼ŒåŸºäºä¸»ä»å¤åˆ¶æ¨¡å¼ï¼Œæ‰€æœ‰çš„ä¸»ä»é…ç½®ä¼˜ç‚¹ï¼Œå®ƒå…¨æœ‰
ä¸»ä»å¯ä»¥åˆ‡æ¢ï¼Œæ•…éšœå¯ä»¥è½¬ç§»ï¼Œç³»ç»Ÿçš„å¯ç”¨æ€§å°±ä¼šæ›´å¥½
å“¨å…µæ¨¡å¼å°±æ˜¯ä¸»ä»æ¨¡å¼çš„å‡çº§ï¼Œæ‰‹åŠ¨åˆ°è‡ªåŠ¨ï¼Œæ›´åŠ å¥å£®ï¼


ç¼ºç‚¹ï¼š
Redis ä¸å¥½å•Šåœ¨çº¿æ‰©å®¹çš„ï¼Œé›†ç¾¤å®¹é‡ä¸€æ—¦åˆ°è¾¾ä¸Šé™ï¼Œåœ¨çº¿æ‰©å®¹å°±ååˆ†éº»çƒ¦ï¼
å®ç°å“¨å…µæ¨¡å¼çš„é…ç½®å…¶å®æ˜¯å¾ˆéº»çƒ¦çš„ï¼Œé‡Œé¢æœ‰å¾ˆå¤šé€‰æ‹©ï¼




å“¨å…µæ¨¡å¼çš„å…¨éƒ¨é…ç½®


# Example sentinel.conf# å“¨å…µsentinelå®ä¾‹è¿è¡Œçš„ç«¯å£ é»˜è®¤26379port 26379# å“¨å…µsentinelçš„å·¥ä½œç›®å½•dir /tmp# å“¨å…µsentinelç›‘æ§çš„redisä¸»èŠ‚ç‚¹çš„ ip port# master-name å¯ä»¥è‡ªå·±å‘½åçš„ä¸»èŠ‚ç‚¹åå­— åªèƒ½ç”±å­—æ¯A-zã€æ•°å­—0-9 ã€è¿™ä¸‰ä¸ªå­—ç¬¦&quot;.-_&quot;ç»„æˆã€‚# quorum é…ç½®å¤šå°‘ä¸ªsentinelå“¨å…µç»Ÿä¸€è®¤ä¸ºmasterä¸»èŠ‚ç‚¹å¤±è” é‚£ä¹ˆè¿™æ—¶å®¢è§‚ä¸Šè®¤ä¸ºä¸»èŠ‚ç‚¹å¤±è”äº†# sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;sentinel monitor mymaster 127.0.0.1 6379 2# å½“åœ¨Rediså®ä¾‹ä¸­å¼€å¯äº†requirepass foobared æˆæƒå¯†ç  è¿™æ ·æ‰€æœ‰è¿æ¥Rediså®ä¾‹çš„å®¢æˆ·ç«¯éƒ½è¦æä¾›å¯†ç # è®¾ç½®å“¨å…µsentinel è¿æ¥ä¸»ä»çš„å¯†ç  æ³¨æ„å¿…é¡»ä¸ºä¸»ä»è®¾ç½®ä¸€æ ·çš„éªŒè¯å¯†ç # sentinel auth-pass &lt;master-name&gt; &lt;password&gt;sentinel auth-pass mymaster MySUPER--secret-0123passw0rd# æŒ‡å®šå¤šå°‘æ¯«ç§’ä¹‹å ä¸»èŠ‚ç‚¹æ²¡æœ‰åº”ç­”å“¨å…µsentinel æ­¤æ—¶ å“¨å…µä¸»è§‚ä¸Šè®¤ä¸ºä¸»èŠ‚ç‚¹ä¸‹çº¿ é»˜è®¤30ç§’# sentinel down-after-milliseconds &lt;master-name&gt; &lt;milliseconds&gt;sentinel down-after-milliseconds mymaster 30000# è¿™ä¸ªé…ç½®é¡¹æŒ‡å®šäº†åœ¨å‘ç”Ÿfailoverä¸»å¤‡åˆ‡æ¢æ—¶æœ€å¤šå¯ä»¥æœ‰å¤šå°‘ä¸ªslaveåŒæ—¶å¯¹æ–°çš„masterè¿›è¡Œ åŒæ­¥ï¼Œè¿™ä¸ªæ•°å­—è¶Šå°ï¼Œå®Œæˆfailoveræ‰€éœ€çš„æ—¶é—´å°±è¶Šé•¿ï¼Œ# ä½†æ˜¯å¦‚æœè¿™ä¸ªæ•°å­—è¶Šå¤§ï¼Œå°±æ„å‘³ç€è¶Š å¤šçš„slaveå› ä¸ºreplicationè€Œä¸å¯ç”¨ã€‚# å¯ä»¥é€šè¿‡å°†è¿™ä¸ªå€¼è®¾ä¸º 1 æ¥ä¿è¯æ¯æ¬¡åªæœ‰ä¸€ä¸ªslave å¤„äºä¸èƒ½å¤„ç†å‘½ä»¤è¯·æ±‚çš„çŠ¶æ€ã€‚# sentinel parallel-syncs &lt;master-name&gt; &lt;numslaves&gt;sentinel parallel-syncs mymaster 1# æ•…éšœè½¬ç§»çš„è¶…æ—¶æ—¶é—´ failover-timeout å¯ä»¥ç”¨åœ¨ä»¥ä¸‹è¿™äº›æ–¹é¢ï¼š#1. åŒä¸€ä¸ªsentinelå¯¹åŒä¸€ä¸ªmasterä¸¤æ¬¡failoverä¹‹é—´çš„é—´éš”æ—¶é—´ã€‚#2. å½“ä¸€ä¸ªslaveä»ä¸€ä¸ªé”™è¯¯çš„masteré‚£é‡ŒåŒæ­¥æ•°æ®å¼€å§‹è®¡ç®—æ—¶é—´ã€‚ç›´åˆ°slaveè¢«çº æ­£ä¸ºå‘æ­£ç¡®çš„masteré‚£é‡ŒåŒæ­¥æ•°æ®æ—¶ã€‚#3.å½“æƒ³è¦å–æ¶ˆä¸€ä¸ªæ­£åœ¨è¿›è¡Œçš„failoveræ‰€éœ€è¦çš„æ—¶é—´ã€‚#4.å½“è¿›è¡Œfailoveræ—¶ï¼Œé…ç½®æ‰€æœ‰slavesæŒ‡å‘æ–°çš„masteræ‰€éœ€çš„æœ€å¤§æ—¶é—´ã€‚ä¸è¿‡ï¼Œå³ä½¿è¿‡äº†è¿™ä¸ªè¶…æ—¶ï¼Œ# slavesä¾ç„¶ä¼šè¢«æ­£ç¡®é…ç½®ä¸ºæŒ‡å‘masterï¼Œä½†æ˜¯å°±ä¸æŒ‰parallel-syncsæ‰€é…ç½®çš„è§„åˆ™æ¥äº†# é»˜è®¤ä¸‰åˆ†é’Ÿ# sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;sentinel failover-timeout mymaster 180000# SCRIPTS EXECUTION#é…ç½®å½“æŸä¸€äº‹ä»¶å‘ç”Ÿæ—¶æ‰€éœ€è¦æ‰§è¡Œçš„è„šæœ¬ï¼Œå¯ä»¥é€šè¿‡è„šæœ¬æ¥é€šçŸ¥ç®¡ç†å‘˜ï¼Œä¾‹å¦‚å½“ç³»ç»Ÿè¿è¡Œä¸æ­£å¸¸æ—¶å‘é‚®ä»¶é€šçŸ¥ç›¸å…³äººå‘˜ã€‚#å¯¹äºè„šæœ¬çš„è¿è¡Œç»“æœæœ‰ä»¥ä¸‹è§„åˆ™ï¼š#è‹¥è„šæœ¬æ‰§è¡Œåè¿”å›1ï¼Œé‚£ä¹ˆè¯¥è„šæœ¬ç¨åå°†ä¼šè¢«å†æ¬¡æ‰§è¡Œï¼Œé‡å¤æ¬¡æ•°ç›®å‰é»˜è®¤ä¸º10#è‹¥è„šæœ¬æ‰§è¡Œåè¿”å›2ï¼Œæˆ–è€…æ¯”2æ›´é«˜çš„ä¸€ä¸ªè¿”å›å€¼ï¼Œè„šæœ¬å°†ä¸ä¼šé‡å¤æ‰§è¡Œã€‚#å¦‚æœè„šæœ¬åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç”±äºæ”¶åˆ°ç³»ç»Ÿä¸­æ–­ä¿¡å·è¢«ç»ˆæ­¢äº†ï¼Œåˆ™åŒè¿”å›å€¼ä¸º1æ—¶çš„è¡Œä¸ºç›¸åŒã€‚#ä¸€ä¸ªè„šæœ¬çš„æœ€å¤§æ‰§è¡Œæ—¶é—´ä¸º60sï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼Œè„šæœ¬å°†ä¼šè¢«ä¸€ä¸ªSIGKILLä¿¡å·ç»ˆæ­¢ï¼Œä¹‹åé‡æ–°æ‰§è¡Œã€‚#é€šçŸ¥å‹è„šæœ¬:å½“sentinelæœ‰ä»»ä½•è­¦å‘Šçº§åˆ«çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼ˆæ¯”å¦‚è¯´rediså®ä¾‹çš„ä¸»è§‚å¤±æ•ˆå’Œå®¢è§‚å¤±æ•ˆç­‰ç­‰ï¼‰ï¼Œ#å°†ä¼šå»è°ƒç”¨è¿™ä¸ªè„šæœ¬ï¼Œè¿™æ—¶è¿™ä¸ªè„šæœ¬åº”è¯¥é€šè¿‡é‚®ä»¶ï¼ŒSMSç­‰æ–¹å¼å»é€šçŸ¥ç³»ç»Ÿç®¡ç†å‘˜å…³äºç³»ç»Ÿä¸æ­£å¸¸è¿è¡Œçš„ä¿¡#æ¯ã€‚è°ƒç”¨è¯¥è„šæœ¬æ—¶ï¼Œå°†ä¼ ç»™è„šæœ¬ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯äº‹ä»¶çš„ç±»å‹ï¼Œä¸€ä¸ªæ˜¯äº‹ä»¶çš„æè¿°ã€‚å¦‚æœsentinel.confé…#ç½®æ–‡ä»¶ä¸­é…ç½®äº†è¿™ä¸ªè„šæœ¬è·¯å¾„ï¼Œé‚£ä¹ˆå¿…é¡»ä¿è¯è¿™ä¸ªè„šæœ¬å­˜åœ¨äºè¿™ä¸ªè·¯å¾„ï¼Œå¹¶ä¸”æ˜¯å¯æ‰§è¡Œçš„ï¼Œå¦åˆ™sentinelæ— æ³•æ­£å¸¸å¯åŠ¨æˆåŠŸã€‚# é€šçŸ¥è„šæœ¬# shellç¼–ç¨‹# sentinel notification-script &lt;master-name&gt; &lt;script-path&gt;sentinel notification-script mymaster /var/redis/notify.sh# å®¢æˆ·ç«¯é‡æ–°é…ç½®ä¸»èŠ‚ç‚¹å‚æ•°è„šæœ¬# å½“ä¸€ä¸ªmasterç”±äºfailoverè€Œå‘ç”Ÿæ”¹å˜æ—¶ï¼Œè¿™ä¸ªè„šæœ¬å°†ä¼šè¢«è°ƒç”¨ï¼Œé€šçŸ¥ç›¸å…³çš„å®¢æˆ·ç«¯å…³äºmasteråœ°å€å·²ç»å‘ç”Ÿæ”¹å˜çš„ä¿¡æ¯ã€‚# ä»¥ä¸‹å‚æ•°å°†ä¼šåœ¨è°ƒç”¨è„šæœ¬æ—¶ä¼ ç»™è„šæœ¬:# &lt;master-name&gt; &lt;role&gt; &lt;state&gt; &lt;from-ip&gt; &lt;from-port&gt; &lt;to-ip&gt; &lt;to-port&gt;# ç›®å‰&lt;state&gt;æ€»æ˜¯â€œfailoverâ€,# &lt;role&gt;æ˜¯â€œleaderâ€æˆ–è€…â€œobserverâ€ä¸­çš„ä¸€ä¸ªã€‚# å‚æ•° from-ip, from-port, to-ip, to-portæ˜¯ç”¨æ¥å’Œæ—§çš„masterå’Œæ–°çš„master(å³æ—§çš„slave)é€šä¿¡çš„# è¿™ä¸ªè„šæœ¬åº”è¯¥æ˜¯é€šç”¨çš„ï¼Œèƒ½è¢«å¤šæ¬¡è°ƒç”¨ï¼Œä¸æ˜¯é’ˆå¯¹æ€§çš„ã€‚# sentinel client-reconfig-script &lt;master-name&gt; &lt;script-path&gt;sentinel client-reconfig-script mymaster /var/redis/reconfig.sh # ä¸€èˆ¬éƒ½æ˜¯ç”±è¿ç»´æ¥é…ç½®ï¼]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>RedisåŸºç¡€å…¥é—¨</tag>
      </tags>
  </entry>
  <entry>
    <title>RedisåŸºç¡€å…¥é—¨(åä¸€)Redisç¼“å­˜ç©¿é€å’Œé›ªå´©</title>
    <url>/Redis/Redis%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8(%E5%8D%81%E4%B8%80)Redis%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E5%92%8C%E9%9B%AA%E5%B4%A9/</url>
    <content><![CDATA[RedisåŸºç¡€å…¥é—¨(åä¸€)Redisç¼“å­˜ç©¿é€å’Œé›ªå´©Redisç¼“å­˜çš„ä½¿ç”¨ï¼Œæå¤§çš„æå‡äº†åº”ç”¨ç¨‹åºçš„æ€§èƒ½å’Œæ•ˆç‡ï¼Œç‰¹åˆ«æ˜¯æ•°æ®æŸ¥è¯¢æ–¹é¢ã€‚ä½†åŒæ—¶ï¼Œå®ƒä¹Ÿå¸¦æ¥äº†ä¸€äº›é—®é¢˜ã€‚å…¶ä¸­ï¼Œæœ€è¦å®³çš„é—®é¢˜ï¼Œå°±æ˜¯æ•°æ®çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œä»ä¸¥æ ¼æ„ä¹‰ä¸Šè®²ï¼Œè¿™ä¸ªé—®é¢˜æ— è§£ã€‚å¦‚æœå¯¹æ•°æ®çš„ä¸€è‡´æ€§è¦æ±‚å¾ˆé«˜ï¼Œé‚£ä¹ˆå°±ä¸èƒ½ä½¿ç”¨ç¼“å­˜ã€‚å¦å¤–çš„ä¸€äº›å…¸å‹é—®é¢˜å°±æ˜¯ï¼Œç¼“å­˜ç©¿é€ã€ç¼“å­˜é›ªå´©å’Œç¼“å­˜å‡»ç©¿ã€‚ç›®å‰ï¼Œä¸šç•Œä¹Ÿéƒ½æœ‰æ¯”è¾ƒæµè¡Œçš„è§£å†³æ–¹æ¡ˆã€‚

2. ç¼“å­˜ç©¿é€ï¼ˆæŸ¥ä¸åˆ°ï¼‰ç¼“å­˜ç©¿é€çš„æ¦‚å¿µå¾ˆç®€å•ï¼Œç”¨æˆ·æƒ³è¦æŸ¥è¯¢ä¸€ä¸ªæ•°æ®ï¼Œå‘ç°rediså†…å­˜æ•°æ®åº“æ²¡æœ‰ï¼Œä¹Ÿå°±æ˜¯ç¼“å­˜æ²¡æœ‰å‘½ä¸­ï¼Œäºæ˜¯å‘æŒä¹…å±‚æ•°æ®åº“æŸ¥è¯¢ã€‚å‘ç°ä¹Ÿæ²¡æœ‰ï¼Œäºæ˜¯æœ¬æ¬¡æŸ¥è¯¢å¤±è´¥ã€‚å½“ç”¨æˆ·å¾ˆå¤šçš„æ—¶å€™ï¼Œç¼“å­˜éƒ½æ²¡æœ‰å‘½ä¸­ï¼ˆç§’æ€ï¼ï¼‰ï¼Œäºæ˜¯éƒ½å»è¯·æ±‚äº†æŒä¹…å±‚æ•°æ®åº“ã€‚è¿™ä¼šç»™æŒä¹…å±‚æ•°æ®åº“é€ æˆå¾ˆå¤§çš„å‹åŠ›ï¼Œè¿™æ—¶å€™å°±ç›¸å½“äºå‡ºç°äº†â€”â€”ç¼“å­˜ç©¿é€ã€‚

è§£å†³æ–¹æ¡ˆ

å¸ƒéš†è¿‡æ»¤å™¨
  å¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå¯¹æ‰€æœ‰å¯èƒ½æŸ¥è¯¢çš„å‚æ•°ä»¥hashå½¢å¼å­˜å‚¨ï¼Œåœ¨æ§åˆ¶å±‚å…ˆè¿›è¡Œæ ¡éªŒï¼Œä¸ç¬¦åˆåˆ™ä¸¢å¼ƒï¼Œä»è€Œé¿å…äº†å¯¹åº•å±‚å­˜å‚¨ç³»ç»Ÿçš„æŸ¥è¯¢å‹åŠ›ï¼›
  

ç¼“å­˜ç©ºå¯¹è±¡
  å½“å­˜å‚¨å±‚ä¸å‘½ä¸­åï¼Œå³ä½¿è¿”å›çš„ç©ºå¯¹è±¡ä¹Ÿå°†å…¶ç¼“å­˜èµ·æ¥ï¼ŒåŒæ—¶ä¼šè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œä¹‹åå†è®¿é—®è¿™ä¸ªæ•°  æ®å°†ä¼šä»ç¼“å­˜ä¸­è·å–ï¼Œä¿æŠ¤äº†åç«¯æ•°æ®æºï¼›
  


  ä½†æ˜¯è¿™ç§æ–¹æ³•ä¼šå­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š  1ã€å¦‚æœç©ºå€¼èƒ½å¤Ÿè¢«ç¼“å­˜èµ·æ¥ï¼Œè¿™å°±æ„å‘³ç€ç¼“å­˜éœ€è¦æ›´å¤šçš„ç©ºé—´å­˜å‚¨æ›´å¤šçš„é”®ï¼Œå› ä¸ºè¿™å½“ä¸­å¯èƒ½ä¼šæœ‰å¾ˆå¤š  çš„ç©ºå€¼çš„é”®ï¼›  2ã€å³ä½¿å¯¹ç©ºå€¼è®¾ç½®äº†è¿‡æœŸæ—¶é—´ï¼Œè¿˜æ˜¯ä¼šå­˜åœ¨ç¼“å­˜å±‚å’Œå­˜å‚¨å±‚çš„æ•°æ®ä¼šæœ‰ä¸€æ®µæ—¶é—´çª—å£çš„ä¸ä¸€è‡´ï¼Œè¿™å¯¹äº  éœ€è¦ä¿æŒä¸€è‡´æ€§çš„ä¸šåŠ¡ä¼šæœ‰å½±å“ã€‚


ç¼“å­˜å‡»ç©¿ï¼ˆé‡å¤ªå¤§ï¼Œç¼“å­˜è¿‡æœŸï¼ï¼‰è¿™é‡Œéœ€è¦æ³¨æ„å’Œç¼“å­˜å‡»ç©¿çš„åŒºåˆ«ï¼Œç¼“å­˜å‡»ç©¿ï¼Œæ˜¯æŒ‡ä¸€ä¸ªkeyéå¸¸çƒ­ç‚¹ï¼Œåœ¨ä¸åœçš„æ‰›ç€å¤§å¹¶å‘ï¼Œå¤§å¹¶å‘é›†ä¸­å¯¹è¿™ä¸€ä¸ªç‚¹è¿›è¡Œè®¿é—®ï¼Œå½“è¿™ä¸ªkeyåœ¨å¤±æ•ˆçš„ç¬é—´ï¼ŒæŒç»­çš„å¤§å¹¶å‘å°±ç©¿ç ´ç¼“å­˜ï¼Œç›´æ¥è¯·æ±‚æ•°æ®åº“ï¼Œå°±åƒåœ¨ä¸€ä¸ªå±éšœä¸Šå‡¿å¼€äº†ä¸€ä¸ªæ´ã€‚
å½“æŸä¸ªkeyåœ¨è¿‡æœŸçš„ç¬é—´ï¼Œæœ‰å¤§é‡çš„è¯·æ±‚å¹¶å‘è®¿é—®ï¼Œè¿™ç±»æ•°æ®ä¸€èˆ¬æ˜¯çƒ­ç‚¹æ•°æ®ï¼Œç”±äºç¼“å­˜è¿‡æœŸï¼Œä¼šåŒæ—¶è®¿é—®æ•°æ®åº“æ¥æŸ¥è¯¢æœ€æ–°æ•°æ®ï¼Œå¹¶ä¸”å›å†™ç¼“å­˜ï¼Œä¼šå¯¼ä½¿æ•°æ®åº“ç¬é—´å‹åŠ›è¿‡å¤§ã€‚

è®¾ç½®çƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸ

ä»ç¼“å­˜å±‚é¢æ¥çœ‹ï¼Œæ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°çƒ­ç‚¹ key è¿‡æœŸåäº§ç”Ÿçš„é—®é¢˜ã€‚


åŠ äº’æ–¥é”

åˆ†å¸ƒå¼é”ï¼šä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œä¿è¯å¯¹äºæ¯ä¸ªkeyåŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹å»æŸ¥è¯¢åç«¯æœåŠ¡ï¼Œå…¶ä»–çº¿ç¨‹æ²¡æœ‰è·å¾—åˆ†å¸ƒå¼é”çš„æƒé™ï¼Œå› æ­¤åªéœ€è¦ç­‰å¾…å³å¯ã€‚è¿™ç§æ–¹å¼å°†é«˜å¹¶å‘çš„å‹åŠ›è½¬ç§»åˆ°äº†åˆ†å¸ƒå¼é”ï¼Œå› æ­¤å¯¹åˆ†å¸ƒå¼é”çš„è€ƒéªŒå¾ˆå¤§ã€‚

  


ç¼“å­˜é›ªå´©ç¼“å­˜é›ªå´©ï¼Œæ˜¯æŒ‡åœ¨æŸä¸€ä¸ªæ—¶é—´æ®µï¼Œç¼“å­˜é›†ä¸­è¿‡æœŸå¤±æ•ˆã€‚Redis å®•æœºï¼äº§ç”Ÿé›ªå´©çš„åŸå› ä¹‹ä¸€ï¼Œæ¯”å¦‚åœ¨å†™æœ¬æ–‡çš„æ—¶å€™ï¼Œé©¬ä¸Šå°±è¦åˆ°åŒåäºŒé›¶ç‚¹ï¼Œå¾ˆå¿«å°±ä¼šè¿æ¥ä¸€æ³¢æŠ¢è´­ï¼Œè¿™æ³¢å•†å“æ—¶é—´æ¯”è¾ƒé›†ä¸­çš„æ”¾å…¥äº†ç¼“å­˜ï¼Œå‡è®¾ç¼“å­˜ä¸€ä¸ªå°æ—¶ã€‚é‚£ä¹ˆåˆ°äº†å‡Œæ™¨ä¸€ç‚¹é’Ÿçš„æ—¶å€™ï¼Œè¿™æ‰¹å•†å“çš„ç¼“å­˜å°±éƒ½è¿‡æœŸäº†ã€‚è€Œå¯¹è¿™æ‰¹å•†å“çš„è®¿é—®æŸ¥è¯¢ï¼Œéƒ½è½åˆ°äº†æ•°æ®åº“ä¸Šï¼Œå¯¹äºæ•°æ®åº“è€Œè¨€ï¼Œå°±ä¼šäº§ç”Ÿå‘¨æœŸæ€§çš„å‹åŠ›æ³¢å³°ã€‚äºæ˜¯æ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šè¾¾åˆ°å­˜å‚¨å±‚ï¼Œå­˜å‚¨å±‚çš„è°ƒç”¨é‡ä¼šæš´å¢ï¼Œé€ æˆå­˜å‚¨å±‚ä¹Ÿä¼šæŒ‚æ‰çš„æƒ…å†µã€‚

å…¶å®é›†ä¸­è¿‡æœŸï¼Œå€’ä¸æ˜¯éå¸¸è‡´å‘½ï¼Œæ¯”è¾ƒè‡´å‘½çš„ç¼“å­˜é›ªå´©ï¼Œæ˜¯ç¼“å­˜æœåŠ¡å™¨æŸä¸ªèŠ‚ç‚¹å®•æœºæˆ–æ–­ç½‘ã€‚å› ä¸ºè‡ªç„¶å½¢æˆçš„ç¼“å­˜é›ªå´©ï¼Œä¸€å®šæ˜¯åœ¨æŸä¸ªæ—¶é—´æ®µé›†ä¸­åˆ›å»ºç¼“å­˜ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæ•°æ®åº“ä¹Ÿæ˜¯å¯ä»¥é¡¶ä½å‹åŠ›çš„ã€‚æ— éå°±æ˜¯å¯¹æ•°æ®åº“äº§ç”Ÿå‘¨æœŸæ€§çš„å‹åŠ›è€Œå·²ã€‚è€Œç¼“å­˜æœåŠ¡èŠ‚ç‚¹çš„å®•æœºï¼Œå¯¹æ•°æ®åº“æœåŠ¡å™¨é€ æˆçš„å‹åŠ›æ˜¯ä¸å¯é¢„çŸ¥çš„ï¼Œå¾ˆæœ‰å¯èƒ½ç¬é—´å°±æŠŠæ•°æ®åº“å‹å®ã€‚

è§£å†³æ–¹æ¡ˆ
redisé«˜å¯ç”¨
  è¿™ä¸ªæ€æƒ³çš„å«ä¹‰æ˜¯ï¼Œæ—¢ç„¶redisæœ‰å¯èƒ½æŒ‚æ‰ï¼Œé‚£æˆ‘å¤šå¢è®¾å‡ å°redisï¼Œè¿™æ ·ä¸€å°æŒ‚æ‰ä¹‹åå…¶ä»–çš„è¿˜å¯ä»¥ç»§ç»­å·¥ä½œï¼Œå…¶å®å°±æ˜¯æ­å»ºçš„é›†ç¾¤ã€‚ï¼ˆå¼‚åœ°å¤šæ´»ï¼ï¼‰

é™æµé™çº§
  è¿™ä¸ªè§£å†³æ–¹æ¡ˆçš„æ€æƒ³æ˜¯ï¼Œåœ¨ç¼“å­˜å¤±æ•ˆåï¼Œé€šè¿‡åŠ é”æˆ–è€…é˜Ÿåˆ—æ¥æ§åˆ¶è¯»æ•°æ®åº“å†™ç¼“å­˜çš„çº¿ç¨‹æ•°é‡ã€‚æ¯”å¦‚å¯¹æŸä¸ªkeyåªå…è®¸ä¸€ä¸ªçº¿ç¨‹æŸ¥è¯¢æ•°æ®å’Œå†™ç¼“å­˜ï¼Œå…¶ä»–çº¿ç¨‹ç­‰å¾…ã€‚

æ•°æ®é¢„çƒ­
  æ•°æ®åŠ çƒ­çš„å«ä¹‰å°±æ˜¯åœ¨æ­£å¼éƒ¨ç½²ä¹‹å‰ï¼Œæˆ‘å…ˆæŠŠå¯èƒ½çš„æ•°æ®å…ˆé¢„å…ˆè®¿é—®ä¸€éï¼Œè¿™æ ·éƒ¨åˆ†å¯èƒ½å¤§é‡è®¿é—®çš„æ•°æ®å°±ä¼šåŠ è½½åˆ°ç¼“å­˜ä¸­ã€‚åœ¨å³å°†å‘ç”Ÿå¤§å¹¶å‘è®¿é—®å‰æ‰‹åŠ¨è§¦å‘åŠ è½½ç¼“å­˜ä¸åŒçš„keyï¼Œè®¾ç½®ä¸åŒçš„è¿‡æœŸæ—¶é—´ï¼Œè®©ç¼“å­˜å¤±æ•ˆçš„æ—¶é—´ç‚¹å°½é‡å‡åŒ€ã€‚




]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>RedisåŸºç¡€å…¥é—¨</tag>
      </tags>
  </entry>
  <entry>
    <title>RedisåŸºç¡€å…¥é—¨(å››)Redis äº‹åŠ¡æ“ä½œ</title>
    <url>/Redis/Redis%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8(%E5%9B%9B)Redis%20%E4%BA%8B%E5%8A%A1%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[RedisåŸºç¡€å…¥é—¨(å››)Redis äº‹åŠ¡æ“ä½œ1. äº‹åŠ¡Redis äº‹åŠ¡æœ¬è´¨ï¼šä¸€ç»„å‘½ä»¤çš„é›†åˆï¼ ä¸€ä¸ªäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½ä¼šè¢«åºåˆ—åŒ–ï¼Œåœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹çš„ä¸­ï¼Œä¼šæŒ‰ç…§é¡ºåºæ‰§è¡Œï¼ä¸€æ¬¡æ€§ã€é¡ºåºæ€§ã€æ’ä»–æ€§ï¼æ‰§è¡Œä¸€äº›åˆ—çš„å‘½ä»¤ï¼
----- é˜Ÿåˆ— set set set æ‰§è¡Œ----â€”

Redisäº‹åŠ¡æ²¡æœ‰æ²¡æœ‰éš”ç¦»çº§åˆ«çš„æ¦‚å¿µï¼æ‰€æœ‰çš„å‘½ä»¤åœ¨äº‹åŠ¡ä¸­ï¼Œå¹¶æ²¡æœ‰ç›´æ¥è¢«æ‰§è¡Œï¼åªæœ‰å‘èµ·æ‰§è¡Œå‘½ä»¤çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œï¼ExecRediså•æ¡å‘½ä»¤å¼ä¿å­˜åŸå­æ€§çš„ï¼Œä½†æ˜¯äº‹åŠ¡ä¸ä¿è¯åŸå­æ€§ï¼

Redisçš„äº‹åŠ¡ï¼š

å¼€å¯äº‹åŠ¡ï¼ˆmultiï¼‰
å‘½ä»¤å…¥é˜Ÿï¼ˆâ€¦â€¦ï¼‰
æ‰§è¡Œäº‹åŠ¡ï¼ˆexecï¼‰


æ­£å¸¸æ‰§è¡Œäº‹åŠ¡


127.0.0.1:6379&gt; multi # å¼€å¯äº‹åŠ¡OK# å‘½ä»¤å…¥é˜Ÿ127.0.0.1:6379&gt; set k1 v1QUEUED127.0.0.1:6379&gt; set k2 v2QUEUED127.0.0.1:6379&gt; get k2QUEUED127.0.0.1:6379&gt; set k3 v3QUEUED127.0.0.1:6379&gt; exec # æ‰§è¡Œäº‹åŠ¡1) OK2) OK3) &quot;v2&quot;4) OK


æ”¾å¼ƒäº‹åŠ¡

127.0.0.1:6379&gt; multi # å¼€å¯äº‹åŠ¡OK127.0.0.1:6379&gt; set k1 v1QUEUED127.0.0.1:6379&gt; set k2 v2QUEUED127.0.0.1:6379&gt; set k4 v4QUEUED127.0.0.1:6379&gt; DISCARD # å–æ¶ˆäº‹åŠ¡OK127.0.0.1:6379&gt; get k4 # äº‹åŠ¡é˜Ÿåˆ—ä¸­å‘½ä»¤éƒ½ä¸ä¼šè¢«æ‰§è¡Œï¼(nil)


ç¼–è¯‘å‹å¼‚å¸¸ï¼ˆä»£ç æœ‰é—®é¢˜ï¼ å‘½ä»¤æœ‰é”™ï¼ï¼‰ ï¼Œäº‹åŠ¡ä¸­æ‰€æœ‰çš„å‘½ä»¤éƒ½ä¸ä¼šè¢«æ‰§è¡Œï¼

127.0.0.1:6379&gt; multiOK127.0.0.1:6379&gt; set k1 v1QUEUED127.0.0.1:6379&gt; set k2 v2QUEUED127.0.0.1:6379&gt; set k3 v3QUEUED127.0.0.1:6379&gt; getset k3 # é”™è¯¯çš„å‘½ä»¤(error) ERR wrong number of arguments for &#x27;getset&#x27; command127.0.0.1:6379&gt; set k4 v4QUEUED127.0.0.1:6379&gt; set k5 v5QUEUED127.0.0.1:6379&gt; exec # æ‰§è¡Œäº‹åŠ¡æŠ¥é”™ï¼(error) EXECABORT Transaction discarded because of previous errors.127.0.0.1:6379&gt; get k5 # æ‰€æœ‰çš„å‘½ä»¤éƒ½ä¸ä¼šè¢«æ‰§è¡Œï¼(nil)


è¿è¡Œæ—¶å¼‚å¸¸ï¼ˆ1&#x2F;0ï¼‰ï¼Œ å¦‚æœäº‹åŠ¡é˜Ÿåˆ—ä¸­å­˜åœ¨è¯­æ³•æ€§ï¼Œé‚£ä¹ˆæ‰§è¡Œå‘½ä»¤çš„æ—¶å€™ï¼Œå…¶ä»–å‘½ä»¤æ˜¯å¯ä»¥æ­£å¸¸æ‰§è¡Œçš„ï¼Œé”™è¯¯å‘½ä»¤æŠ›å‡ºå¼‚å¸¸ï¼

127.0.0.1:6379&gt; set k1 &quot;v1&quot;OK127.0.0.1:6379&gt; multiOK127.0.0.1:6379&gt; incr k1 # ä¼šæ‰§è¡Œçš„æ—¶å€™å¤±è´¥ï¼QUEUED127.0.0.1:6379&gt; set k2 v2QUEUED127.0.0.1:6379&gt; set k3 v3QUEUED127.0.0.1:6379&gt; get k3QUEUED127.0.0.1:6379&gt; exec1) (error) ERR value is not an integer or out of range # è™½ç„¶ç¬¬ä¸€æ¡å‘½ä»¤æŠ¥é”™äº†ï¼Œä½†æ˜¯ä¾æ—§æ­£å¸¸æ‰§è¡ŒæˆåŠŸäº†ï¼2) OK3) OK4) &quot;v3&quot;127.0.0.1:6379&gt; get k2&quot;v2&quot;127.0.0.1:6379&gt; get k3&quot;v3&quot;


ç›‘æ§ï¼ Watch ï¼ˆé¢è¯•å¸¸é—®ï¼ï¼‰

æ‚²è§‚é”ï¼šå¾ˆæ‚²è§‚ï¼Œè®¤ä¸ºä»€ä¹ˆæ—¶å€™éƒ½ä¼šå‡ºé—®é¢˜ï¼Œæ— è®ºåšä»€ä¹ˆéƒ½ä¼šåŠ é”ï¼
ä¹è§‚é”ï¼š


å¾ˆä¹è§‚ï¼Œè®¤ä¸ºä»€ä¹ˆæ—¶å€™éƒ½ä¸ä¼šå‡ºé—®é¢˜ï¼Œæ‰€ä»¥ä¸ä¼šä¸Šé”ï¼ æ›´æ–°æ•°æ®çš„æ—¶å€™å»åˆ¤æ–­ä¸€ä¸‹ï¼Œåœ¨æ­¤æœŸé—´æ˜¯å¦æœ‰äººä¿®æ”¹è¿‡è¿™ä¸ªæ•°æ®ï¼Œ
è·å–version
æ›´æ–°çš„æ—¶å€™æ¯”è¾ƒ version


Redisæµ‹ç›‘è§†æµ‹è¯•


127.0.0.1:6379&gt; set money 100OK127.0.0.1:6379&gt; set out 0OK127.0.0.1:6379&gt; watch money # ç›‘è§† money å¯¹è±¡OK127.0.0.1:6379&gt; multi # äº‹åŠ¡æ­£å¸¸ç»“æŸï¼Œæ•°æ®æœŸé—´æ²¡æœ‰å‘ç”Ÿå˜åŠ¨ï¼Œè¿™ä¸ªæ—¶å€™å°±æ­£å¸¸æ‰§è¡ŒæˆåŠŸï¼OK127.0.0.1:6379&gt; DECRBY money 20QUEUED127.0.0.1:6379&gt; INCRBY out 20QUEUED**127.0.0.1:6379&gt; exec1) (integer) 802) (integer) 20


æµ‹è¯•å¤šçº¿ç¨‹ä¿®æ”¹å€¼ , ä½¿ç”¨watch å¯ä»¥å½“åšredisçš„ä¹è§‚é”æ“ä½œï¼

127.0.0.1:6379&gt; watch money # ç›‘è§† moneyOK127.0.0.1:6379&gt; multiOK127.0.0.1:6379&gt; DECRBY money 10QUEUED127.0.0.1:6379&gt; INCRBY out 10QUEUED127.0.0.1:6379&gt; exec # æ‰§è¡Œä¹‹å‰ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹ï¼Œä¿®æ”¹äº†æˆ‘ä»¬çš„å€¼ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå°±ä¼šå¯¼è‡´äº‹åŠ¡æ‰§è¡Œå¤±è´¥ï¼(nil)


å¦‚æœä¿®æ”¹å¤±è´¥ï¼Œè·å–æœ€æ–°çš„å€¼å°±å¥½

127.0.0.1:6379&gt; UNWATCHOK127.0.0.1:6379&gt; watch moneyOK127.0.0.1:6379&gt; multiOK127.0.0.1:6379(TX)&gt; DECRBY money 10QUEUED127.0.0.1:6379(TX)&gt; INCRBY out 10QUEUED127.0.0.1:6379(TX)&gt; exec1) (integer) 702) (integer) 30


]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>RedisåŸºç¡€å…¥é—¨</tag>
      </tags>
  </entry>
</search>
